"use strict";
!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="370e6290-8fd2-5a54-afa5-e4ffd4dd13d9")}catch(e){}}();
(()=>{/*! Copyright (c) 2025 Tutteo Ltd. */(self.webpackChunk_flat_flat=self.webpackChunk_flat_flat||[]).push([[82201],{86134:(tt,N,p)=>{p.d(N,{A:()=>A});var D=p(890439);class A{constructor(v){this.getId=v,this.removedSet={},this.valuesMap={},this.idsList=[]}static fromList(v,L){const _=new A(L);return v.forEach(_.push,_),_}push(v){this.updateRemoved();const L=this.getId(v);if(typeof this.valuesMap[L]!="undefined"){const _=new Error(`The id ${L} is already present in the indexed list.`);throw _.id=L,_.value=v,_}this.idsList.push(L),this.valuesMap[L]=v}isEmpty(){return this.getSize()===0}getSize(){return this.updateRemoved(),this.idsList.length}pop(){if(this.updateRemoved(),this.isEmpty())throw new Error("Cannot pop on an empty list.");const v=this.idsList.pop(),L=this.valuesMap[v];return delete this.valuesMap[v],L}replace(v){const L=this.getId(v);typeof this.valuesMap[L]!="undefined"&&(this.valuesMap[L]=v)}remove(v){const L=this.getId(v);this.removeAtId(L)}removeAtId(v){this.removedSet[v]=!0,delete this.valuesMap[v]}hasRemovedValues(){return!D.Ay.isEmpty(this.removedSet)}isNotRemoved(v){return typeof this.removedSet[v]=="undefined"}getList(){return this.updateRemoved(),this.idsList.map(this.getValue,this)}updateRemoved(){this.hasRemovedValues()&&(this.idsList=this.idsList.filter(this.isNotRemoved,this),this.removedSet={})}isValueInList(v){this.updateRemoved();const L=this.getId(v);return this.isIdInList(L)}isIdInList(v){return this.updateRemoved(),typeof this.valuesMap[v]!="undefined"}getValue(v){return this.valuesMap[v]}getLast(){if(this.isEmpty())throw new Error("Cannot get last item of an empty list");const v=this.idsList.length-1,L=this.idsList[v];return this.getValue(L)}}},207620:(tt,N,p)=>{p.d(N,{A:()=>D});function D(A){if(A===null)return null;let{actions:x,revertHistory:v,logs:L}=A;const{parentId:_,groupId:B,type:K,hash:rt,userId:H,scoreId:W,revisionId:st}=A;return x=x?x.slice():[],v=v?v.slice():[],L=L?L.slice():[],{parentId:_,hash:rt,type:K,actions:x,groupId:B,userId:H,logs:L,scoreId:W,revisionId:st,revertHistory:v}}},293497:(tt,N,p)=>{p.d(N,{A:()=>D});function D(A){return A.groupId}},297534:(tt,N,p)=>{p.d(N,{A:()=>S});var D=p(645369),A=p.n(D),x=p(98261),v=p(616877),L=p.n(v),_=p(173665),B=p.n(_),K=p(890439),rt=p(309189),H=p(207620),W=p(314787),st=p(896838),Q=p(86134),Z=p(293497),$=(g,t,e)=>new Promise((s,i)=>{var c=a=>{try{I(e.next(a))}catch(l){i(l)}},u=a=>{try{I(e.throw(a))}catch(l){i(l)}},I=a=>a.done?s(a.value):Promise.resolve(a.value).then(c,u);I((e=e.apply(g,t)).next())});class ot{constructor(){this.socket=null,this.storage=null,this.memoryOnlySet={},this.localGroups=null,this.d=null}setDebug(t){this.d=t}isInMemoryOnly(t){return this.memoryOnlySet[t]===!0}addLocalGroup(t){return $(this,null,function*(){this.memoryOnlySet[t.groupId]=!0,(yield this._getLocalGroups()).push(t),this.socket!==null&&(yield this.sendLocalGroups()),this.storage!==null&&(yield this.storage.addLocalGroup(t),(yield this.storage.hasGroupHash(t.hash))&&delete this.memoryOnlySet[t.groupId])})}updateLocalGroups(t){return $(this,null,function*(){const e=yield this._getLocalGroups();t=t.filter(e.isValueInList,e),t.forEach(e.replace,e),t.forEach(({groupId:s})=>{this.memoryOnlySet[s]=!0}),this.socket!==null&&(yield this.sendLocalGroups()),this.storage!==null&&(yield Promise.all(t.map(s=>$(this,null,function*(){yield this.storage.editLocalGroup(s),(yield this.storage.hasGroupHash(s.hash))&&delete this.memoryOnlySet[s.groupId]}))))})}clearAckGroups(t){return $(this,null,function*(){yield this.removeGroups(t)})}removeGroups(t){return $(this,null,function*(){t.forEach(s=>{delete this.memoryOnlySet[s]},this);const e=yield this._getLocalGroups();t.forEach(e.removeAtId,e),this.storage!==null&&(yield this.storage.cleanAckLocalGroups(t))})}sendLocalGroups(){return $(this,null,function*(){if(this.socket===null)return this.d!==null&&this.d("Cannot send data if the socket is not set.."),0;const t=yield this.getLocalGroups();return t.length>0?(this.d!==null&&this.d("push local actions (%d): %o",t.length,t.map(e=>e.groupId)),this.socket.emit("edit",t)):this.d!==null&&this.d("no local actions to push"),t.length})}filterIds(t){return $(this,null,function*(){const e=yield this._getLocalGroups();return t=t.filter(e.isIdInList,e),t})}getLocalGroups(){return $(this,null,function*(){return(yield this._getLocalGroups()).getList()})}_getLocalGroups(){return $(this,null,function*(){return this.localGroups===null&&(yield this._initLocalGroups()),this.localGroups})}_initLocalGroups(){return $(this,null,function*(){if(this.storage!==null){const t=yield this.storage.getLocalGroups();this.localGroups=Q.A.fromList(t,Z.A)}else this.localGroups=new Q.A(Z.A)})}setSocket(t){this.socket=t}setStorage(t){this.storage=t}persistData(){return $(this,null,function*(){this.localGroups!==null&&(yield this.storage.cleanAllLocalGroups(),yield this.storage.bulkAddLocalGroup(this.localGroups.getList()))})}syncWithPersisted(){return $(this,null,function*(){yield this._initLocalGroups()})}}var m=(g,t,e)=>new Promise((s,i)=>{var c=a=>{try{I(e.next(a))}catch(l){i(l)}},u=a=>{try{I(e.throw(a))}catch(l){i(l)}},I=a=>a.done?s(a.value):Promise.resolve(a.value).then(c,u);I((e=e.apply(g,t)).next())});class w{constructor(){this.storage=null,this.ackGroups=null}setStorage(t){this.storage=t}addAckGroups(t){return m(this,null,function*(){const e=yield this._getAckGroups();t.forEach(e.push,e),this.storage!==null&&(yield this.storage.bulkAddAckGroup(t))})}replaceAckGroups(t){return m(this,null,function*(){this.ackGroups=Q.A.fromList(t,Z.A),this.storage!==null&&(yield this.storage.cleanAllAckGroups(),yield this.storage.bulkAddAckGroup(t))})}cleanAll(){return m(this,null,function*(){this.ackGroups=new Q.A(Z.A),this.storage!==null&&(yield this.storage.cleanAllAckGroups())})}getAckGroups(){return m(this,null,function*(){return(yield this._getAckGroups()).getList()})}_getAckGroups(){return m(this,null,function*(){return this.ackGroups===null&&(yield this._initAckGroups()),this.ackGroups})}_initAckGroups(){return m(this,null,function*(){if(this.storage!==null){const t=yield this.storage.getAckGroups();this.ackGroups=Q.A.fromList(t,Z.A)}else this.ackGroups=new Q.A(Z.A)})}persistData(){return m(this,null,function*(){this.ackGroups!==null&&(yield this.storage.cleanAllAckGroups(),yield this.storage.bulkAddAckGroup(this.ackGroups.getList()))})}syncWithPersisted(){return m(this,null,function*(){yield this._initAckGroups()})}}var O=p(894487),M=p(897775),P=p(59377),T=p(429145),et=p(381585);function j(){return new Promise(g=>{requestAnimationFrame(g)})}var q=(g,t,e)=>new Promise((s,i)=>{var c=a=>{try{I(e.next(a))}catch(l){i(l)}},u=a=>{try{I(e.throw(a))}catch(l){i(l)}},I=a=>a.done?s(a.value):Promise.resolve(a.value).then(c,u);I((e=e.apply(g,t)).next())});function b(g,t,e){return{logger:"actions:adagio",tags:{"do:actionOrigin":"save","adagio:name":t.fnc},extra:{"err:original":g,"adagio:name":t.fnc,"do:groupId":e,"adagio:opts":t.args}}}function o(g){return{logger:"actions:adagio",tags:{"do:actionOrigin":"save-loadData"},extra:{"err:original":g}}}function d(g){return{logger:"actions:adagio",tags:{"do:actionOrigin":"save-exportData"},extra:{"err:original":g}}}function F(g,t){return q(this,null,function*(){const e=[],s=[];let i;yield j();try{i=new T.A(g)}catch(a){const l=o(a);return s.push(l),{failures:e,errors:s,savedJson:null}}const c=new P.default;for(const a of t){const{groupId:l,actions:R}=a;for(const G of R){yield j();try{if(!i[G.fnc])throw new Error(`[rt] Cannot find Adagio function ${G.fnc}`);const z=JSON.parse(JSON.stringify(G.args));i[G.fnc](z,c)}catch(z){const Y=b(z,G,l);(0,et.A)(z)?e.push(Y):s.push(Y)}}}yield j();let u;try{u=i.exportData()}catch(a){const l=d(a);return s.push(l),{failures:e,errors:s,savedJson:null}}return{failures:e,errors:s,savedJson:u}})}var J=p(843678);function X(g,t){const e=J.default.fromList(g,Z.A);return t.forEach(({groupId:i})=>{delete e[i]}),J.default.getValues(e)}function V(g,t,e){g.forEach((s,i)=>{if(s.noParentId){let c;i===0?(c=t,e&&e("Restore a parentId of group %s with the last known ack id %s",s.groupId,c)):(c=g[i-1].groupId,e&&e("Restore a parentId of group %s with the previous groupId %s",s.groupId,c)),s.parentId=c,delete s.noParentId}})}function U(g){performance.mark(`${g}.s`)}function C(g){performance.mark(`${g}.e`),performance.measure(g,`${g}.s`,`${g}.e`)}var k=(g,t,e)=>new Promise((s,i)=>{var c=a=>{try{I(e.next(a))}catch(l){i(l)}},u=a=>{try{I(e.throw(a))}catch(l){i(l)}},I=a=>a.done?s(a.value):Promise.resolve(a.value).then(c,u);I((e=e.apply(g,t)).next())});const at=50,h=15*1e3,r=1,n=1/0,f=5e3;let E=1;function y(g,t){return g||(t?"deviceAutoSave":"NoContext")}class S{constructor({endpoint:t,accessToken:e,accountId:s,reqAs:i,scoreId:c,revisionId:u,sharingKey:I,autoSaveEvery:a,exclusiveConnection:l=!1,reconnectAutoDisabled:R=!1,incidentLogger:G,logError:z,noNetwork:Y=!1,noStorage:it=!1,scoreData:nt,queue:ct,storageProvider:dt,groupIdWatcher:ut,deviceId:lt=null,deviceType:ht=null,onDataChanged:pt=null}){this.scoreData=nt,this.emiter=new(B()),this.debugHistory=[],this.debugInstance=A()(`rt:client:${E++}`),this.d("rt initialized with revId=%s",u),this.server={endpoint:t,accessToken:e},this.accountId=s,this.reqAs=i,this.storageProvider=dt,this.scoreId=c,this.localRevisionId=u,this.sharingKey=I,this.onDataChanged=pt,this.noNetwork=Y,this.noStorage=it,this.instanceId=(0,rt.A)(),this.deviceId=lt,this.deviceType=ht,ct?this.queue=ct:(this.d("no queue provided, creating new one"),this.queue=new(L())(r,n)),this.saveQueue=new(L())(r,n),this.incidentLogger=G,this.logError=z,this.collaborators=[],this.isSetup=!1,this.connected=!1,this.connecting=!1,this.joined=!1,this.synced=!1,this.rights="ro",this.autoSaveEvery=a||at,this.actionsFollowUpDelay=h,this.exclusiveConnection=l,this.reconnectAutoDisabled=R,this.actionsFollowup={},this.queuedPushLocalActions=!1,this.synchronizer=new st.A({scoreId:c,revisionId:u,userId:s,groupIdWatcher:ut,deviceId:lt,deviceType:ht,instanceId:this.instanceId}),this.localStorage=new ot,this.localStorage.setDebug(this.d.bind(this)),this.ackStorage=new w,this.errorLogger=new M.A,this.failureLogger=new M.A,this.synchronizer.setErrorLogger(this.errorLogger),this.synchronizer.setFailureLogger(this.failureLogger),this.saving=!1,this.savingHandler=null,this.lastNotRebasedError=null,this.nbConsecutiveRebaseError=0}d(...t){this.debugInstance.apply(this.debugInstance,t),this.debugHistory.push([new Date().toISOString(),...t])}clearLoggers(){this.errorLogger.clear(),this.failureLogger.clear()}dumpState(){return k(this,null,function*(){const t={},e=s=>JSON.parse(JSON.stringify(s)).map(i=>(delete i.cancelStack,i));try{t.synchronizer=this.synchronizer.dumpState()}catch(s){this.d("err while dumping synchronizer: %o",s)}try{t.localGroups=e(yield this.localStorage.getLocalGroups())}catch(s){this.d("err while dumping localStorage: %o",s)}try{t.ackGroups=e(yield this.ackStorage.getAckGroups())}catch(s){this.d("err while dumping localStorage: %o",s)}return t.accountId=this.accountId,t.scoreId=this.scoreId,t.localRevisionId=this.localRevisionId,t.noNetwork=this.noNetwork,t.noStorage=this.noStorage,t.exclusiveConnection=this.exclusiveConnection,t.debugHistory=[].concat(this.debugHistory),t})}setup(){return k(this,null,function*(){if(!this.accountId)throw new Error(`Cannot load RT: Missing parameter accountId (${this.accountId})`);if(!this.scoreId)throw new Error(`Cannot load RT: Missing parameter scoreId (${this.scoreId})`);if(!this.localRevisionId)throw new Error(`Cannot load RT: Missing parameter revisionId (${this.localRevisionId})`);if(this.isSetup)return;this.isSetup=!0,this.log("rt.setup");const t=[];if(!this.noStorage){const e=this.setupIndexedDB().catch(s=>{this.log("rt.indexedb.failure",s)});t.push(e)}if(!this.noNetwork){const e=this.setupSocketIO();t.push(e)}yield Promise.all(t)})}synchronizeScoreWithStoredGroups(){return k(this,null,function*(){U("rt.synchronizeScoreWithStoredGroups"),this.d("[synchronizeScoreWithStoredGroups], initial synchronization"),this.clearLoggers();const t=yield this.getAckGroups();if(this.d("synchronizing %d ack groups",t.length),t.length>0&&t[0].revisionId!==this.localRevisionId){const a=t[0].revisionId;this.d("Ack groups revision id %s is different from revision id provided with editor loading %s. Switching to the former",a,this.localRevisionId),yield this.setRevisionId(a,!1),this.needCleanRevisionData=!0}let e=!1;t.forEach(a=>{a.revisionId!==this.localRevisionId&&(e=!0,this.d("synchronized group %s has a revId=%s is different from the local revId=%s",a.groupId,a.revisionId,this.localRevisionId))});const s=this.needCleanRevisionData,{data:i,cancelStack:c}=yield this.getData();e?(this.d("dropping all ack groups"),yield this.ackStorage.cleanAll()):this.synchronizer.playRemoteGroups(t,{scoreData:i,cancelStack:c}),!this.errorLogger.isEmpty()&&this.logError&&this.errorLogger.list.forEach(l=>{l.extra["rt:ctx"]="synchronizeScoreWithStoredGroups",this.logError(l.extra["err:original"],l)}),!e&&!this.failureLogger.isEmpty()&&this.logError&&this.failureLogger.list.forEach(l=>{l.extra["rt:ctx"]="synchronizeScoreWithStoredGroups",this.logError(l.extra["err:original"],l)}),this.clearLoggers();let u=yield this.localStorage.getLocalGroups();this.d("synchronizing %s local groups",u.length),u.forEach(a=>{a.revisionId!==this.localRevisionId&&(e=!0,this.d("local group %s has a revId=%s is different from the local revId=%s",a.groupId,a.revisionId,this.localRevisionId))}),this.checkDiscontinuedLocalGroups(u),this.synchronizer.playLocalGroups(u,{scoreData:i,cancelStack:c},"initialSynchro"),!this.errorLogger.isEmpty()&&this.logError&&this.errorLogger.list.forEach(l=>{l.extra["rt:ctx"]="synchronizeScoreWithStoredGroups",this.logError(l.extra["err:original"],l)}),!e&&!this.failureLogger.isEmpty()&&this.logError&&this.failureLogger.list.forEach(l=>{l.extra["rt:ctx"]="synchronizeScoreWithStoredGroups",this.logError(l.extra["err:original"],l)}),u=this.synchronizer.getLocalGroups(),this.d("%s local groups synchronized",u.length),u=u.map(H.A),yield this.localStorage.updateLocalGroups(u);const I=this.synchronizer.getRemovedGroupIds();this.d("%d local groups removed",I.length),yield this.localStorage.removeGroups(I),this.emit("displayUpdate"),this.onDataChanged&&(U("rt.onDataChanged"),yield this.onDataChanged({newData:s}),C("rt.onDataChanged")),C("rt.synchronizeScoreWithStoredGroups")})}hotSynchronizeScoreWithPersistedGroups(){return k(this,null,function*(){if(this.d("[hotSynchronizeScoreWithPersistedGroups, returning to this TAB]"),this.storage===null)return;U("rt.hotSynchronizeScoreWithPersistedGroups"),this.clearLoggers(),this.log("rt.hotSynchronizeScoreWithPersistedGroups");const t=yield this.localStorage.getLocalGroups();this.d("There was %d local groups",t.length);let e=yield this.ackStorage.getAckGroups();this.d("There was %d ack groups",e.length),yield this.ackStorage.syncWithPersisted(),e=yield this.ackStorage.getAckGroups(),this.d("There is now %d ack groups",e.length),yield this.localStorage.syncWithPersisted();let s=yield this.localStorage.getLocalGroups();this.d("There is now %d local groups",s.length);const i=X(t,e.concat(s));this.d("%d local groups are missing in new groups",i.length);let c;const u=this.synchronizer.getLastSyncGroupId();this.d("Searching for lastSyncGroupId=%s in new ack groups",u);const{groups:I,isFound:a}=(0,O.A)(e,u);e=I,a?(this.d("lastSyncGroupId found, %d new ack groups to apply",e.length),c=!0):(this.d("lastSyncGroupId not found, starting from clean data"),this.synchronizer.localGroups=[],this.synchronizer.resetParent(),this.needCleanRevisionData=!0,c=!1);const{data:l,cancelStack:R}=yield this.getData();c&&(this.d("reverting data to last sync"),this.synchronizer.rewindDataToLastSync({scoreData:l,cancelStack:R})),this.synchronizer.playRemoteGroups(e,{scoreData:l,cancelStack:R,revertLocalGroups:c}),this.synchronizer.playLocalGroups(s,{scoreData:l,cancelStack:R,failureAsError:!0}),i.forEach(this.synchronizer._stateGroupRemoved,this.synchronizer),s=this.synchronizer.getLocalGroups(),s=s.map(H.A),this.d("%d groups after synchronization complete",s.length),yield this.localStorage.updateLocalGroups(s);const G=this.synchronizer.getRemovedGroupIds();this.d("%d removedGroupsIds",G),yield this.localStorage.removeGroups(G),this.emit("syncedWithStorage"),c?this.emit("displayUpdate"):this.emit("completeRedraw"),!this.errorLogger.isEmpty()&&this.logError&&this.errorLogger.list.forEach(Y=>{Y.extra["rt:ctx"]="onSynced",this.logError(Y.extra["err:original"],Y)}),this.onDataChanged&&(U("rt.onDataChanged"),yield this.onDataChanged({newData:!c}),C("rt.onDataChanged")),C("rt.hotSynchronizeScoreWithPersistedGroups")})}checkDiscontinuedLocalGroups(t){t.forEach((e,s)=>{if(s>0){const i=t[s-1];if(e.parentId!==i.groupId){const c=new Error("[rt] discontinued local groups (auto-fix performed)");c.groupId=e.groupId,c.expectedParentId=i.groupId,c.actualGroupid=e.parentId,this.logError(c),e.parentId=i.groupId}}})}reset(){return k(this,null,function*(){this.log("rt.reset"),this.needCleanRevisionData=!0,this.emit("completeRedraw"),yield this.synchronizeScoreWithStoredGroups()})}addActionsToTransaction(t){return k(this,null,function*(){U("rt.addActionsToTransaction"),this.d("[addActionsToTransaction], %s actions",t.length),this.clearLoggers(),t=t.map(this.getNewAction,this),this.log("rt.addActionsToTransaction",t);const{data:e,cancelStack:s}=yield this.getData(),i=this.synchronizer.getParentId();this.synchronizer.executePartialTransactionalLocalActionsGroup(t,{cancelStack:s,scoreData:e}),!this.errorLogger.isEmpty()&&this.logError&&this.errorLogger.list.forEach(u=>{u.extra["rt:ctx"]="bulkEdit",u.extra["rt:parentId"]=i,this.logError(u.extra["err:original"],u)}),C("rt.addActionsToTransaction")})}hasOngoingTransaction(){return this.synchronizer.hasPartialGroup()}commitTransaction(){return k(this,null,function*(){U("rt.commitTransaction"),this.synchronizer.hasPartialGroup()?this.d("[commitTransaction], %s actions",this.synchronizer.partialActions.length):this.d("[commitTransaction], 0 actions (will fail)");const t=this.synchronizer.consolidatePartialActions();if(t===null)return C("rt.commitTransaction"),null;this.reconnectAutoDisabled||this.queue.add(this.reconnect.bind(this));const e=(0,H.A)(t);yield this.localStorage.addLocalGroup(e),yield this.autoSave();const{groupId:s}=e;return this.d("edit generated groupId=%s",s),this.actionsFollowup[s]=setTimeout(this.actionFollowup.bind(this,s),this.actionsFollowUpDelay),this.emit("displayUpdate"),C("rt.commitTransaction"),e})}bulkEdit(t){return t.length===0?Promise.resolve():(this.reconnectAutoDisabled||this.queue.add(this.reconnect.bind(this)),this.queue.add(this._bulkEdit.bind(this,t)))}_bulkEdit(t){return k(this,null,function*(){this.d("[_bulkEdit], %s actions",t.length),this.clearLoggers(),t=t.map(this.getNewAction,this),this.log("rt.bulkEdit",t);const{data:e,cancelStack:s}=yield this.getData(),i=this.synchronizer.getParentId(),c=this.synchronizer.executeTransactionalLocalActions(t,{cancelStack:s,scoreData:e});if(!this.errorLogger.isEmpty()&&this.logError&&this.errorLogger.list.forEach(l=>{l.extra["rt:ctx"]="bulkEdit",l.extra["rt:parentId"]=i,this.logError(l.extra["err:original"],l)}),c===null)return null;const u=(0,H.A)(c);yield this.localStorage.addLocalGroup(u),yield this.autoSave();const{groupId:I}=u;return this.d("edit generated groupId=%s",I),this.actionsFollowup[I]=setTimeout(this.actionFollowup.bind(this,I),this.actionsFollowUpDelay),this.emit("displayUpdate"),u})}canUndo(){return this.synchronizer.canUndo()}undo({isQueued:t}={}){if(this.d("[undo]"),!this.synchronizer.canUndo())return Promise.resolve();this.reconnectAutoDisabled||this.queue.add(this.reconnect.bind(this));const e=()=>k(this,null,function*(){if(this.clearLoggers(),this.log("rt.undo"),!this.synchronizer.canUndo())return this.d("cannot perform the undo"),Promise.resolve();U("rt.undo");const s=this.synchronizer.getLastUndoGroupId();this.d("undoing %s",s);const{data:i,cancelStack:c}=yield this.getData(),u=this.synchronizer.getParentId(),I=this.synchronizer.undo({scoreData:i,cancelStack:c});if(!this.errorLogger.isEmpty()&&this.logError&&this.errorLogger.list.forEach(G=>{G.extra["rt:ctx"]="undo",G.extra["rt:parentId"]=u,G.extra["rt:groupUndo"]=s,this.logError(G.extra["err:original"],G)}),I===null)return C("rt.undo"),null;const a=(0,H.A)(I);yield this.localStorage.addLocalGroup(a),yield this.autoSave();const{groupId:l}=a;return this.d("undo groupId=%s",l),this.actionsFollowup[l]=setTimeout(this.actionFollowup.bind(this,l),this.actionsFollowUpDelay),this.emit("displayUpdate"),C("rt.undo"),a});return t?e():this.queue.add(e)}canRedo(){return this.synchronizer.canRedo()}redo({isQueued:t}={}){if(this.d("[redo]"),!this.synchronizer.canRedo())return Promise.resolve();this.reconnectAutoDisabled||this.queue.add(this.reconnect.bind(this));const e=()=>k(this,null,function*(){if(this.clearLoggers(),this.log("rt.redo"),!this.synchronizer.canRedo())return this.d("cannot perform the redo"),Promise.resolve();U("rt.redo");const s=this.synchronizer.getLastRedoGroupId();this.d("redoing %s",s);const{data:i,cancelStack:c}=yield this.getData(),u=this.synchronizer.getParentId(),I=this.synchronizer.redo({scoreData:i,cancelStack:c});if(!this.errorLogger.isEmpty()&&this.logError&&this.errorLogger.list.forEach(G=>{G.extra["rt:ctx"]="redo",G.extra["rt:parentId"]=u,G.extra["rt:groupRedo"]=s,this.logError(G.extra["err:original"],G)}),I===null)return C("rt.redo"),null;const a=(0,H.A)(I);yield this.localStorage.addLocalGroup(a),yield this.autoSave();const{groupId:l}=a;return this.d("redo groupId=%s",l),this.actionsFollowup[l]=setTimeout(this.actionFollowup.bind(this,l),this.actionsFollowUpDelay),this.emit("displayUpdate"),C("rt.redo"),a});return t?e():this.queue.add(e)}actionFollowup(t){return k(this,null,function*(){delete this.actionsFollowup[t],this.d("follow up action",t),this.localStorage.isInMemoryOnly(t)?(this.d("action in memory only"),this.emit("inMemoryOnly")):(this.d("action preserved"),this.emit("follow-up",t))})}log(t,e){this.d("%s: %o",t,e),this.incidentLogger&&this.incidentLogger(t,e)}setupSocketIO(){const t=document.createElement("a");t.href=this.server.endpoint;const e=encodeURIComponent(this.server.accessToken);let s=`${t.protocol}//${t.host}/?access_token=${e}`;if(this.sharingKey){const i=encodeURIComponent(this.sharingKey);s+=`&sharingKey=${i}`}if(this.reqAs){const i=encodeURIComponent(this.reqAs);s+=`&requestAs=${i}`}return this.socket=x.Ay.connect(s,{resource:"ws"}),this.localStorage.setSocket(this.socket),this.connecting=!0,this.connected=!1,this.onSocket("connect",this.onConnect),this.onSocket("disconnect",this.onDisconnect),this.onSocket("connect_error",this.onConnectError),this.onSocket("join",this.onJoin),this.onSocket("rights",this.onRights),this.onSocket("synced",this.onSynced),this.onSocket("leave",this.onLeave),this.onSocket("position",this.onPosition),this.onSocket("revision",this.onRevision),this.onSocket("edit",this.onEdit),this.onSocket("error",this.onError),this.onSocket("error.join",this.onErrorJoin),this.onSocket("error.not-joined",this.onErrorNotJoined),this.onSocket("error.no-parent",this.onErrorNotRebased),this.onSocket("error.not-rebased",this.onErrorNotRebased),Promise.resolve()}onSocket(t,e){return this.socket.on(t,(...s)=>{this.queue.add(()=>{const i=e.apply(this,s);return i instanceof Promise?i:Promise.resolve(i)})})}onConnect(){this.d("connected"),this.connected=!0,this.connecting=!1,this.joined=!1,this.synced=!1,this.emit("connect"),this.log("rt.connected"),this.join()}onDisconnect(){this.log("rt.disconnected"),this.emit("disconnect"),this.connected=!1,this.connecting=!1,this.joined=!1,this.synced=!1}onConnectError(t){this.lastConnectError=new Date,this.log("rt.connect-error",t),this.emit("connectError"),this.connected!==!1&&(this.connected=!1,this.connecting=!0),this.joined=!1,this.synced=!1,this.reconnectAutoDisabled||this.queue.add(this.reconnect.bind(this))}onJoin(t){this.log("rt.joined",t),this.addCollaborator(t.userId),this.emit("collaborators",{joined:t.userId,collaborators:this.collaborators})}onLeave(t){this.log("rt.left",t),this.removeCollaborator(t.userId),this.emit("collaborators",{left:t.userId,collaborators:this.collaborators})}onRights(t){this.rights=t,this.emit("rights",t),this.log("rt.rights",t)}onPosition(t){this.emit("position",t)}onRevision(t){return k(this,arguments,function*({revId:e,eventId:s}){U("rt.onRevision"),this.d("[onRevision], revId=%s, eventId=%s, oldRev=%s",e,s,this.localRevisionId),this.clearLoggers(),this.log("rt.revision",{revId:e,eventId:s}),this.synchronizer.setRevisionId(e);const i=!s||!(yield this.hasAckGroup(s));if(i){this.d("the revision is not related to current data (revision change or data to different)"),yield this.setRevisionId(e,!0),yield this.ackStorage.cleanAll(),this.synchronizer.resetParent(),this.needCleanRevisionData=!0;const{data:u,cancelStack:I}=yield this.getData();this.synchronizer.playRemoteGroups([],{scoreData:u,cancelStack:I,revertLocalGroups:!1});const a=this.synchronizer.getRemovedGroupIds();yield this.localStorage.removeGroups(a)}else this.d("the new revision related to current data (auto-save or manual save)"),yield this.setRevisionId(e,!1),yield this.removeAckGroupsUntil(s),yield this.scoreData.updateRevisionId(e);let c=this.synchronizer.getLocalGroups();c=c.map(H.A),yield this.localStorage.updateLocalGroups(c),i&&this.emit("completeRedraw"),!this.errorLogger.isEmpty()&&this.logError&&this.errorLogger.list.forEach(I=>{I.extra["rt:ctx"]="onRevision",this.logError(I.extra["err:original"],I)}),!this.saving&&this.savingHandler&&(clearTimeout(this.savingHandler),this.savingHandler=null),this.onDataChanged&&i&&(U("rt.onDataChanged"),yield this.onDataChanged({newData:!0}),C("rt.onDataChanged")),C("rt.onRevision")})}hasAckGroup(t){return k(this,null,function*(){return(yield this.getAckGroups()).some(s=>s.groupId===t)})}onSynced(t){return k(this,null,function*(){U("rt.onSynced"),this.clearLoggers(),this.log("rt.synced",t);let e=t.events||[];this.d("[onSynced], revId=%s, %s groups. oldRevision=%s",t.revision,e.length,this.localRevisionId),e.forEach(R=>{this.d("[onSynced][%s], parentId=%s, revId=%s",R.groupId,R.parentId,R.revisionId),R.revisionId!==t.revision&&(this.d("setting synced revision id to event %s",R.groupId),R.revisionId=t.revision)}),V(e,this.synchronizer.getLastSyncGroupId(),this.d.bind(this)),yield this.ackStorage.replaceAckGroups(e);const s=e.map(R=>R.groupId);yield this.localStorage.clearAckGroups(s);const i=t.revision;let c;if(this.synchronizer.setRevisionId(i),i!==this.localRevisionId)this.d("different revision on sync (%s vs %s)",i,this.localRevisionId),this.synchronizer.resetParent(),yield this.setRevisionId(t.revision,!0),this.needCleanRevisionData=!0,c=!1;else{const R=this.synchronizer.getLastSyncGroupId(),{groups:G,isFound:z}=(0,O.A)(e,R);e=G,z?(this.d("synced data related to local data"),c=!0):(this.d("synced data not related to local data, starting back from fresh data"),this.synchronizer.resetParent(),this.needCleanRevisionData=!0,c=!1)}const{data:u,cancelStack:I}=yield this.getData();this.synchronizer.playRemoteGroups(e,{scoreData:u,cancelStack:I,revertLocalGroups:c});let a=this.synchronizer.getLocalGroups();a=a.map(H.A),yield this.localStorage.updateLocalGroups(a);const l=this.synchronizer.getRemovedGroupIds();yield this.localStorage.removeGroups(l),this.emit("synced",{revId:t.revision,n:t.events.length}),c?this.emit("displayUpdate"):this.emit("completeRedraw"),!this.errorLogger.isEmpty()&&this.logError&&this.errorLogger.list.forEach(G=>{G.extra["rt:ctx"]="onSynced",this.logError(G.extra["err:original"],G)}),this.onDataChanged&&(U("rt.onDataChanged"),yield this.onDataChanged({newData:!c}),C("rt.onDataChanged")),C("rt.onSynced")})}onEdit(){return k(this,arguments,function*({events:t,scoreId:e}={events:[]}){U("rt.onEdit"),this.d("[ON_EDIT], currentRevId = %s, receiving %d actions",this.localRevisionId,t.length),t.forEach(s=>{this.d("[ON_EDIT][%s] parentId=%s, revId=%s",s.groupId,s.parentId,s.revisionId)}),V(t,this.synchronizer.getLastSyncGroupId(),this.d.bind(this)),this.clearLoggers(),this.log("rt.on-edit",t),t.forEach(s=>{s.scoreId=e}),yield this.processReceivedAction(t),C("rt.onEdit")})}onError(t){this.log("rt.error",t);const e=new Error("[rt] Socket error");e.type="rt",e.action="connect",e.err=t,this.emit("error",e)}onErrorJoin(t){this.log("rt.error.join",t);const e=new Error("[rt] Unable to join");e.type="rt",e.action="join",e.err=t,this.emit("error",e),this.joined=!1,this.join()}onErrorNotJoined(){this.log("rt.error.not-joined"),this.joined=!1,this.join()}onErrorRevisionInvalid(t){return k(this,null,function*(){this.d("/!\\ onErrorRevisionInvalid /!\\ revId=%s, localRevId=%s",t.revId,this.localRevisionId),this.log("rt.error.invalid-revision",t);const e=new Error("[rt] Invalid revision");e.type="rt",e.action="revision-invalid",e.revId=t.revId,e.localRevId=this.localRevisionId,this.setRevisionId(t.revId),this.emit("error",e),yield this.reset()})}onErrorNotRebased(t){return k(this,null,function*(){this.d("/!\\NOT_REBASED/!\\, parentId=%s, groupId=%s",t.parentId,t.groupId);const e=t.parentId+t.groupId;if(this.lastNotRebasedError!==e?(this.lastNotRebasedError=e,this.nbConsecutiveRebaseError=1):this.nbConsecutiveRebaseError++,t.groupId&&(yield this.isActionAck(t.groupId)))this.d("the action is already ack, the error was probably from a double send");else if(t.parentId===t.groupId){if(this.d("parentId === groupId, should be safe"),this.nbConsecutiveRebaseError>=5){const i=new Error("[rt] not rebased, should be safe (parentId === groupId)");i.type="rt",i.action="not-rebased",i.groupId=t.groupId,this.logError(i)}}else if(this.d("groupId->parentId sequence is compromised"),this.nbConsecutiveRebaseError>=5){const i=new Error("[rt] not rebased, groupId->parentId sequence is compromised");i.type="rt",i.action="not-rebased",i.actionId=t.id,i.parentId=t.parentId,i.groupId=t.groupId,this.logError(i)}})}isActionAck(t){return k(this,null,function*(){return(yield this.getAckGroups()).some(({groupId:i})=>i===t)})}join(){return this.log("rt.join"),new Promise(t=>{if(this.joined){t();return}this.socket.emit("join",{scoreId:this.scoreId,exclusiveConnection:this.exclusiveConnection,supportGroups:!0},()=>{this.joined=!0,t()})})}getData(){return k(this,null,function*(){this.d("getData from scoreData, rev = %s (need clean data = %s)",this.localRevisionId,!!this.needCleanRevisionData);const t=this.scoreData.getCancelStack();let e;return this.needCleanRevisionData?(e=yield this.scoreData.loadRevision(this.localRevisionId),this.needCleanRevisionData=!1):e=this.scoreData.getCurrentAdagioData(),{data:e,cancelStack:t}})}disconnect(){return k(this,null,function*(){this.connecting===!1&&this.connected===!1||(this.connecting=!1,this.connected=!1,this.storage&&this.storage.close(),this.disconnectSocket())})}disconnectSocket(){this.socket&&this.socket.disconnect()}disconnectStorage(){this.d("disconnecting storage"),this.storage&&this.storage.close(),this.localStorage.setStorage(null),this.ackStorage.setStorage(null)}reconnectStorage(){return this.queue.add(this._reconnectStorage.bind(this))}_reconnectStorage(){return k(this,null,function*(){this.storage&&(yield this.storage.setup(),this.localStorage.setStorage(this.storage),this.ackStorage.setStorage(this.storage),yield this.hotSynchronizeScoreWithPersistedGroups())})}reconnect(){return k(this,null,function*(){if(!this.connected&&this.connecting){const e=new Date;if(e.setTime(e.getTime()-5*1e3),e>this.lastConnectError)this.connecting=!1;else return}if(this.connected||this.connecting)return;const t=[];this.noStorage||t.push(this.setupIndexedDB()),this.socket&&(this.socket.removeAllListeners(),this.socket.disconnect(),this.socket=null,this.localStorage.setSocket(null)),this.noNetwork||t.push(this.setupSocketIO()),yield Promise.all(t)})}setupIndexedDB(){return k(this,null,function*(){this.storage||(this.storage=this.storageProvider.createStorage({accountId:this.accountId,scoreId:this.scoreId}),this.ackStorage.setStorage(this.storage),this.localStorage.setStorage(this.storage),this.storage.on("error",t=>{this.log("rt.storage.error",t)})),yield this.storage.setup()})}addCollaborator(t){this.collaborators.indexOf(t)===-1&&this.collaborators.push(t)}removeCollaborator(t){const e=this.collaborators.indexOf(t);e>=0&&this.collaborators.splice(e,1)}sendPosition(t){this.socket.emit("position",t)}getNewAction({name:t,actionName:e,fnc:s,opts:i,args:c}){return{fnc:s||e||t,args:c||i}}processReceivedAction(t){return k(this,null,function*(){U("rt.processReceivedAction"),t.forEach(l=>{l.revisionId!==this.localRevisionId&&(this.d("The group %s has an outdated revId %s, should be %s, we are updating it, probably receiving the onEdit after the onRevision",l.groupId,l.revisionId,this.localRevisionId),l.revisionId=this.localRevisionId)}),t=yield this.filterAlreadyAckGroups(t),yield this.ackStorage.addAckGroups(t);let e=t.map(l=>l.groupId);e=yield this.localStorage.filterIds(e),e.length>0&&(yield this.localStorage.clearAckGroups(e));const{data:s,cancelStack:i}=yield this.getData(),c=s.getEditionId();this.synchronizer.playRemoteGroups(t,{scoreData:s,cancelStack:i});const u=s.getEditionId();let I=this.synchronizer.getLocalGroups();I=I.map(H.A),yield this.localStorage.updateLocalGroups(I);const a=this.synchronizer.getRemovedGroupIds();yield this.localStorage.removeGroups(a),this.emit("ack",e),c!==u&&(this.emit("displayUpdate"),this.emit("processReceivedAction")),!this.errorLogger.isEmpty()&&this.logError&&this.errorLogger.list.forEach(R=>{R.extra["rt:ctx"]="onEdit",this.logError(R.extra["err:original"],R)}),this.onDataChanged&&c!==u&&(U("rt.onDataChanged"),yield this.onDataChanged({newData:!1}),C("rt.onDataChanged")),C("rt.processReceivedAction")})}filterAlreadyAckGroups(t){return k(this,null,function*(){const s=(yield this.ackStorage.getAckGroups()).map(c=>c.groupId),i=K.Ay.fromList(s);return t=t.filter(({groupId:c})=>typeof i[c]=="undefined"),t})}autoSave(){return k(this,null,function*(){const t=yield this.getAckGroups();t.length>=this.autoSaveEvery&&(this.d("autosave, %d action groups",t.length),this.queueSave({isAuto:!0,override:!1}))})}save({noActionNeeded:t=!1,override:e,context:s}={}){return this.queueSave({isAuto:!1,noActionNeeded:t,override:e,context:s})}queueSave(t){return this.saveQueue.add(this._save.bind(this,t))}_save(t){return k(this,arguments,function*({isAuto:e,noActionNeeded:s,context:i,override:c}){if(!(this.saving||this.savingHandler)){this.saving=!0;try{yield k(this,null,function*(){const u=yield this.getAckGroups();if(u.length===0&&!s)return;this.d("performing save with %d groups",u.length),this.emit("save");const I=yield this.scoreData.getRevision(this.localRevisionId),{failures:a,errors:l,savedJson:R}=yield F(I,u);if(l.forEach(G=>{G.extra["rt:ctx"]="onSave",this.logError(G.extra["err:original"],G)}),a.forEach(G=>{G.extra["rt:ctx"]="onSave",this.logError(G.extra["err:original"],G)}),R!==null){const G=u.map(H.A);this.d("sending the save data"),i=y(i,e),typeof c=="undefined"&&(c=!0);const z={autosave:e,context:i,override:c,parentRevisionId:this.localRevisionId,deviceId:this.deviceId,deviceType:this.deviceType,instanceId:this.instanceId};yield this.scoreData.saveNewRevision(R,G,z)}else throw new Error("Couldn't perform save");this.emit("saveDone")})}catch(u){throw this.saving=!1,u}this.saving=!1,this.runSavingHandler()}})}runSavingHandler(){const t=this;this.savingHandler=setTimeout(()=>{t.savingHandler=null},f)}pushLocalGroups(){return k(this,null,function*(){return this.queuedPushLocalActions=!1,yield this.localStorage.sendLocalGroups()})}removeAckGroupsUntil(t){return k(this,null,function*(){const e=yield this.getAckGroups(),s=e.findIndex(i=>i.groupId===t);if(s>=0){const i=e.splice(s+1);i.forEach((c,u)=>{u===0&&(c.parentId=null),c.revisionId=this.localRevisionId,c.hash=(0,W.A)(c)}),yield this.ackStorage.replaceAckGroups(i),i.length===0&&this.synchronizer.resetParent()}})}getAckGroups(){return k(this,null,function*(){const t=yield this.ackStorage.getAckGroups();return this.checkAckGroupsContinuity(t),t})}checkAckGroupsContinuity(t){t.forEach((e,s)=>{if(s>0){const i=t[s-1];if(e.parentId!==i.groupId){const c=new Error("[rt] discontinued ack groups (not fixed, should not happen)");c.groupId=e.groupId,c.expectedParentId=i.groupId,c.actualGroupid=e.parentId,this.logError(c),e.parentId=i.groupId}}})}setRevisionId(t,e){return k(this,null,function*(){if(this.localRevisionId===t)return;this.d("changing revision from %s to %s",this.localRevisionId,t);const s=this.localRevisionId;this.localRevisionId=t,this.saving=!1,this.emit("revision",{from:s,revision:t,redraw:!!e})})}on(...t){this.emiter.on(...t)}once(...t){this.emiter.once(...t)}off(...t){this.emiter.off(...t)}emit(...t){this.emiter.emit(...t)}}},309189:(tt,N,p)=>{p.d(N,{A:()=>D});function D(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,A=>{const x=Math.random()*16|0;return(A==="x"?x:x&3|8).toString(16)})}},314787:(tt,N,p)=>{p.d(N,{A:()=>A});var D=p(341715);function A(x){const v={id:x.groupId,parentId:x.parentId,actions:x.actions.map(({fnc:_,args:B})=>({fnc:_,args:B})),scoreId:x.scoreId,userId:x.userId,revisionId:x.revisionId};return D.digest(v)}},381585:(tt,N,p)=>{p.d(N,{A:()=>v});var D=p(607682),A=p(31278),x=p(951066);function v(L){return L instanceof D.default||L instanceof A.default||L instanceof x.A}},777853:(tt,N,p)=>{p.d(N,{A:()=>q});var D=p(234535),A=p(900448),x=p(645369),v=p.n(x),L=p(173665),_=p.n(L),B=p(843678);function K(b){if(b.parentId===b.groupId)throw new Error(`The group ${b.groupId} has equals groupId and parentId`);return{group:b,nbEntries:1,nextGroup:null}}function rt(b,o){return o.group.parentId===null?1:b.group.id===null?-1:o.nbEntries-b.nbEntries}function H(b){if(b.length===0)return[];const o=b.map(K),d=B.default.fromList(o,({group:X})=>X.groupId),F=[];B.default.forEach(d,(X,V)=>{if(typeof d[V.group.parentId]!="undefined"){const U=d[V.group.parentId];U.nbEntries=V.nbEntries+1,U.nextGroup=V}else F.push(V)}),F.sort(rt);const J=[];return F.forEach(X=>{const V=[X.group];for(J.push(V);X.nextGroup!==null;)X=X.nextGroup,V.push(X.group)}),J}function W(b){const o=H(b);return o.length===0?[]:(o.length>1,Array.prototype.concat.apply([],o))}var st=Object.defineProperty,Q=Object.defineProperties,Z=Object.getOwnPropertyDescriptors,$=Object.getOwnPropertySymbols,ot=Object.prototype.hasOwnProperty,m=Object.prototype.propertyIsEnumerable,w=(b,o,d)=>o in b?st(b,o,{enumerable:!0,configurable:!0,writable:!0,value:d}):b[o]=d,O=(b,o)=>{for(var d in o||(o={}))ot.call(o,d)&&w(b,d,o[d]);if($)for(var d of $(o))m.call(o,d)&&w(b,d,o[d]);return b},M=(b,o)=>Q(b,Z(o)),P=(b,o,d)=>new Promise((F,J)=>{var X=C=>{try{U(d.next(C))}catch(k){J(k)}},V=C=>{try{U(d.throw(C))}catch(k){J(k)}},U=C=>C.done?F(C.value):Promise.resolve(C.value).then(X,V);U((d=d.apply(b,o)).next())});const T=v()("rt:indexedb");class et{constructor({accountId:o,scoreId:d}){this.emiter=new(_()),this.accountId=o,this.scoreId=d,this.isReady=!1}setup(o={}){return this.db||(this.db=new A.Ay(this.dbName),this.db.version(2).stores({localGroups:"++_id, *scoreId, &groupId, &hash",ackGroups:"++_id, *scoreId, &groupId, &hash"})),this.isReady&&this.db.isOpen()?this.db:new Promise((d,F)=>{(0,D.A)().then(()=>this.db.open()).then(()=>(this.isReady=!0,T("db is opened"),d(this.db))).catch(J=>(T("open error %o",J),!o.retrying&&J.toString().includes("Internal error")?this.setup(M(O({},o),{retrying:!0})).then(d).catch(F):(typeof J=="string"&&(J=new Error(J),J.name="SQLError"),J.type="rt",J.localGroup="open_indexeddb",F(J))))})}getLocalGroups(){return P(this,null,function*(){try{this.isReady||(yield this.setup());const o=yield this.db.localGroups.where("scoreId").equals(this.scoreId).sortBy("_id"),d=W(o);return d.length!==o.length&&(yield this.cleanAllLocalGroups(),yield this.bulkAddLocalGroup(d)),d}catch(o){return o instanceof A.Ay.InvalidStateError||this.exception("getLocalGroupsForScore",o),[]}})}getAckGroups(){return P(this,null,function*(){try{this.isReady||(yield this.setup());const o=yield this.db.ackGroups.where("scoreId").equals(this.scoreId).sortBy("_id"),d=W(o);return d.length!==o.length&&(yield this.cleanAllAckGroups(),yield this.bulkAddAckGroup(d)),d}catch(o){return o instanceof A.Ay.InvalidStateError||this.exception("getLocalGroupsForScore",o),[]}})}hasGroupHash(o){return P(this,null,function*(){try{this.isReady||(yield this.setup());const d=yield this.db.localGroups.where("hash").equals(o).toArray();return!(!d||d.length===0)}catch(d){return d instanceof A.Ay.InvalidStateError||(d.param=o,this.exception("getLocalGroups",d)),!1}})}addLocalGroup(o){return P(this,null,function*(){try{this.isReady||(yield this.setup()),o=A.Ay.deepClone(o);const d=yield this.db.localGroups.add(o);return o._id=d,o}catch(d){if(d instanceof A.Ay.ConstraintError)return this.editLocalGroup(o);if(d instanceof A.Ay.InvalidStateError)return o;this.exception("addLocalGroup",d)}return o})}bulkAddLocalGroup(o){return P(this,null,function*(){T("bulkAdd(%o)",o);try{return this.isReady||(yield this.setup()),o=A.Ay.deepClone(o),yield this.db.localGroups.bulkAdd(o),o}catch(d){if(d instanceof A.Ay.BulkError)return T("bulk err: %s",d),Promise.all(o.map(F=>this.addLocalGroup(F)));this.exception("bulkAddLocalGroup",d)}return o})}addAckGroup(o){return P(this,null,function*(){try{this.isReady||(yield this.setup()),o=A.Ay.deepClone(o);const d=yield this.db.ackGroups.add(o);return o._id=d,o}catch(d){if(d instanceof A.Ay.ConstraintError)return this.editAckGroup(o);if(d instanceof A.Ay.InvalidStateError)return o;this.exception("addAckGroup",d)}return o})}editAckGroup(o){return P(this,null,function*(){T("addAckGroup(%o)",o);try{return this.isReady||(yield this.setup()),o=A.Ay.deepClone(o),yield this.db.ackGroups.where("groupId").equals(o.groupId).modify(o),o}catch(d){if(d instanceof A.Ay.InvalidStateError)return o;this.exception("editLocalGroup",d)}return o})}bulkAddAckGroup(o){return P(this,null,function*(){T("bulkAdd(%o)",o);try{return this.isReady||(yield this.setup()),o=A.Ay.deepClone(o),yield this.db.ackGroups.bulkAdd(o),o}catch(d){if(d instanceof A.Ay.BulkError)return T("bulk err: %s",d),Promise.all(o.map(F=>this.addAckGroup(F)));this.exception("bulkAddAckGroup",d)}return o})}editLocalGroup(o){return P(this,null,function*(){T("editLocalGroup(%o)",o);try{return this.isReady||(yield this.setup()),o=A.Ay.deepClone(o),yield this.db.localGroups.where("groupId").equals(o.groupId).modify(o),o}catch(d){if(d instanceof A.Ay.InvalidStateError)return o;this.exception("editLocalGroup",d)}return o})}cleanAllAckGroups(){return P(this,null,function*(){try{this.isReady||(yield this.setup());const d=(yield this.db.ackGroups.where("scoreId").equals(this.scoreId).sortBy("_id")).map(F=>F._id);return this.db.ackGroups.bulkDelete(d)}catch(o){if(o instanceof A.Ay.InvalidStateError)return null;this.exception("cleanAllAckGroups",o)}return null})}cleanAllLocalGroups(){return P(this,null,function*(){try{this.isReady||(yield this.setup());const d=(yield this.db.localGroups.where("scoreId").equals(this.scoreId).sortBy("_id")).map(F=>F._id);return this.db.localGroups.bulkDelete(d)}catch(o){if(o instanceof A.Ay.InvalidStateError)return null;this.exception("cleanAllLocalGroups",o)}return null})}cleanAckLocalGroups(o){return P(this,null,function*(){try{this.isReady||(yield this.setup()),yield this.db.localGroups.where("groupId").anyOf(o).delete()}catch(d){if(d instanceof A.Ay.InvalidStateError)return;this.exception("cleanSentLocalGroups",d)}})}retrieveLocalScoreIds(){return P(this,null,function*(){try{const o={};return yield this.db.localGroups.each(F=>{o[F.scoreId]=!0}),Object.keys(o)}catch(o){if(!(o instanceof A.Ay.InvalidStateError))throw o;return[]}})}close(){this.isReady&&this.db&&this.db.isOpen()&&(this.db.close(),this.isReady=!1)}exception(o,d){d.type="rt",d.localGroup="indexeddb",d.function=o,T("err: %s: %o",o,d),this.emit("error",d)}get dbName(){return`scores_groups_${this.accountId}`}on(...o){this.emiter.on(...o)}once(...o){this.emiter.once(...o)}emit(...o){this.emiter.emit(...o)}}const q={createStorage({accountId:b,scoreId:o}){return new et({accountId:b,scoreId:o})}}},824467:(tt,N,p)=>{p.d(N,{A:()=>$});var D=p(645369),A=p.n(D),x=p(616877),v=p.n(x),L=p(173665),_=p.n(L),B=p(309189),K=p(207620),rt=p(896838),H=p(897775),W=(ot,m,w)=>new Promise((O,M)=>{var P=j=>{try{et(w.next(j))}catch(q){M(q)}},T=j=>{try{et(w.throw(j))}catch(q){M(q)}},et=j=>j.done?O(j.value):Promise.resolve(j.value).then(P,T);et((w=w.apply(ot,m)).next())});const st=1,Q=1/0;let Z=1;class ${constructor({accountId:m,scoreId:w,revisionId:O,sharingKey:M,incidentLogger:P,logError:T,scoreData:et,queue:j}){this.scoreData=et,this.emiter=new(_()),this.d=A()(`rt:client:${Z++}`),this.accountId=m,this.scoreId=w,this.localRevisionId=O,this.sharingKey=M,this.instanceId=(0,B.A)(),j?this.queue=j:(this.d("no queue provided, creating new one"),this.queue=new(v())(st,Q)),this.incidentLogger=P,this.logError=T,this.isSetup=!1,this.rights="ro",this.synchronizer=new rt.A({scoreId:w,revisionId:O,userId:m}),this.errorLogger=new H.A,this.failureLogger=new H.A,this.synchronizer.setErrorLogger(this.errorLogger),this.synchronizer.setFailureLogger(this.failureLogger)}clearLoggers(){this.errorLogger.clear(),this.failureLogger.clear()}setup(){return!this.scoreId||!this.localRevisionId||!this.accountId?Promise.reject(new Error("Missing parameters scoreId, revisionId or accountId")):(this.isSetup||(this.isSetup=!0,this.log("rt.setup")),Promise.resolve())}synchronizeScoreWithStoredGroups(){return W(this,null,function*(){this.clearLoggers();const m=[],{data:w,cancelStack:O}=yield this.getData();this.synchronizer.playRemoteGroups(m,{scoreData:w,cancelStack:O,revertLocalGroups:!1})})}reset(){this.log("rt.reset"),this.needCleanRevisionData=!0,this.synchronizeScoreWithStoredGroups()}addActionsToTransaction(m){return W(this,null,function*(){this.d("[addActionsToTransaction], %s actions",m.length),this.clearLoggers(),m=m.map(this.getNewAction,this),this.log("rt.addActionsToTransaction",m);const{data:w,cancelStack:O}=yield this.getData(),M=this.synchronizer.getParentId();this.synchronizer.executePartialTransactionalLocalActionsGroup(m,{cancelStack:O,scoreData:w}),!this.errorLogger.isEmpty()&&this.logError&&this.errorLogger.list.forEach(T=>{T.extra["rt:ctx"]="bulkEdit",T.extra["rt:parentId"]=M,this.logError(T.extra["err:original"],T)})})}hasOngoingTransaction(){return this.synchronizer.hasPartialGroup()}commitTransaction(){return W(this,null,function*(){this.synchronizer.hasPartialGroup()?this.d("[commitTransaction], %s actions",this.synchronizer.partialActions.length):this.d("[commitTransaction], 0 actions (will fail)");const m=this.synchronizer.consolidatePartialActions();if(m===null)return null;const w=(0,K.A)(m);return this.emit("displayUpdate"),w})}bulkEdit(m){return m.length===0?Promise.resolve():this.queue.add(()=>W(this,null,function*(){this.clearLoggers(),m=m.map(this.getNewAction,this),this.log("rt.bulkEdit",m);const{data:w,cancelStack:O}=yield this.getData(),M=this.synchronizer.executeTransactionalLocalActions(m,{cancelStack:O,scoreData:w});if(M===null)return null;const P=(0,K.A)(M);return this.emit("displayUpdate"),P}))}canUndo(){return this.synchronizer.canUndo()}undo({isQueued:m}={}){if(!this.synchronizer.canUndo())return Promise.resolve();const w=()=>W(this,null,function*(){if(this.clearLoggers(),this.log("rt.undo"),!this.synchronizer.canUndo())return this.log("cannot perform the undo"),Promise.resolve();const{data:O,cancelStack:M}=yield this.getData(),P=this.synchronizer.undo({scoreData:O,cancelStack:M});if(P===null)return null;const T=(0,K.A)(P);return this.emit("displayUpdate"),T});return m?w():this.queue.add(w)}canRedo(){return this.synchronizer.canRedo()}redo({isQueued:m}={}){if(!this.synchronizer.canRedo())return Promise.resolve();const w=()=>W(this,null,function*(){if(this.clearLoggers(),this.log("rt.undo"),!this.synchronizer.canRedo())return this.log("cannot perform the undo"),Promise.resolve();const{data:O,cancelStack:M}=yield this.getData(),P=this.synchronizer.redo({scoreData:O,cancelStack:M});if(P===null)return null;const T=(0,K.A)(P);return this.emit("displayUpdate"),T});return m?w():this.queue.add(w)}log(m,w){this.incidentLogger&&this.incidentLogger(m,w)}getData(){return W(this,null,function*(){this.d("fetch data from helper, rev = %s (need clean data = %s)",this.localRevisionId,!!this.needCleanRevisionData);const m=this.scoreData.getCancelStack();let w;return this.needCleanRevisionData?w=yield this.scoreData.loadRevision(this.localRevisionId):w=this.scoreData.getCurrentAdagioData(),{data:w,cancelStack:m}})}getNewAction({name:m,actionName:w,fnc:O,opts:M,args:P}){return{fnc:O||w||m,args:P||M}}setRevisionId(m,w){return W(this,null,function*(){if(this.localRevisionId===m)return;this.d("changing revision from %s to %s",this.localRevisionId,m);const O=this.localRevisionId;this.localRevisionId=m,this.saving=!1,this.emit("revision",{from:O,revision:m,redraw:!!w})})}on(...m){this.emiter.on(...m)}once(...m){this.emiter.once(...m)}off(...m){this.emiter.off(...m)}emit(...m){this.emiter.emit(...m)}}},894487:(tt,N,p)=>{p.d(N,{A:()=>x});function D(v){return v===null?v:v.valueOf()}function A(v){const L=D(this);return v.parentId===L}function x(v,L){if(v.length===0)return L===null?{isFound:!0,groups:[]}:{isFound:!1,groups:[]};const _=v.findIndex(A,L);return _>=0?{isFound:!0,groups:v.slice(_)}:v[v.length-1].groupId===L?{isFound:!0,groups:[]}:{isFound:!1,groups:v}}},896838:(tt,N,p)=>{p.d(N,{A:()=>at});var D=p(309189),A=p(381585);const x="DO",v="UNDO",L="REDO";var _=p(314787);function B(h){const{groupId:r}=this;return{groupId:r,fnc:h.actionName,args:h.opts}}function K(h,r,n){r===n.length-1?h.id=h.groupId:h.id=(0,D.A)()}function rt(h,r,n){return{logger:"actions:adagio",tags:{"do:actionOrigin":"local.do","adagio:name":r.fnc},extra:{"err:original":h,"adagio:name":r.fnc,"adagio:opts":r.args,"do:groupId":n}}}function H({actions:h,cancelStack:r,scoreData:n,parentId:f,scoreId:E,userId:y,revisionId:S,rtSid:g,deviceId:t,deviceType:e}){const s=(0,D.A)();r=r.createSubstack(s);const i=[],c=[],u=[],I=h.length;for(let l=0;l<I;l++){const R=h[l];try{if(!n[R.fnc])throw new Error(`[rt] Cannot find Adagio function ${R.fnc}`);const G=JSON.parse(JSON.stringify(R.args));let z=n[R.fnc](G,r);z=z.map(B,{groupId:s}),Array.prototype.push.apply(i,z)}catch(G){const z=rt(G,R,s);(0,A.A)(G)?c.push(z):u.push(z)}}const a={failures:c,errors:u,group:null};return i.length>0&&(i.forEach(K),a.group={parentId:f,groupId:s,scoreId:E,userId:y,cancelStack:r,actions:i,type:x,revisionId:S,revertHistory:[],logs:[{date:new Date,context:x,user:y,revision:S,dataSid:(0,D.A)(),rtSid:g,deviceId:t,deviceType:e}]},a.group.hash=(0,_.A)(a.group)),a}var W=p(485826);function st(h,r,n,f,E){return{logger:"actions:adagio",tags:{"do:actionOrigin":`local.${E}`,"adagio:name":r.name},extra:{"err:original":h,"adagio:name":r.name,"adagio:opts":r.opts,"do:groupId":n,"do:revertedGroupId":f}}}function Q({previousGroup:h,cancelStack:r,scoreData:n,parentId:f,scoreId:E,userId:y,revisionId:S,rtSid:g,deviceId:t,deviceType:e,actionType:s}){const i=(0,D.A)();r=r.createSubstack(i);const c=h.cancelStack,u=(0,W.A)(c),I=[],a=[],l=[],R=u.length;for(let z=0;z<R;z++){const Y=u[z];try{if(!n[Y.name])throw new Error(`[rt] Cannot find Adagio function ${Y.name}`);let it=n[Y.name](Y.opts,r);it=it.map(B,{groupId:i}),Array.prototype.push.apply(I,it)}catch(it){const nt=st(it,Y,i,h.groupId,s);(0,A.A)(it)?a.push(nt):l.push(nt)}}const G={failures:a,errors:l,group:null};if(I.length>0){I.forEach(K);const z=h.revertHistory.slice();z.unshift(h.groupId),G.group={parentId:f,groupId:i,scoreId:E,userId:y,revisionId:S,cancelStack:r,actions:I,type:s,revertHistory:z,logs:[{date:new Date,context:s,user:y,revision:S,dataSid:(0,D.A)(),rtSid:g,deviceId:t,deviceType:e}]},G.group.hash=(0,_.A)(G.group)}return G}function Z(h,r,n){return n>=h.length||n>=r.length?!1:h[n].hash===r[n].hash}function $(h,r){const n=[];let f=0;for(;Z(h,r,f);)n.push(h[f]),f++;return h=h.slice(f),r=r.slice(f),{syncGroups:n,localGroups:h,remoteGroups:r}}const ot="rewind";function m(h,r,n){return{logger:"actions:adagio",tags:{"do:actionOrigin":"local.rebase-rewind","adagio:name":r.name},extra:{"err:original":h,"adagio:name":r.name,"adagio:opts":r.opts,"do:groupId":n}}}function w({cancelStack:h,scoreData:r,groups:n}){h=h.createSubstack(ot),n=n.slice(),n.reverse();const f=[],E=[];return n.forEach(S=>{(0,W.A)(S.cancelStack).forEach(t=>{try{if(!r[t.name])throw new Error(`[rt] Cannot find Adagio function ${t.name}`);r[t.name](t.opts,h)}catch(e){const s=m(e,t,S.groupId);(0,A.A)(e)?f.push(s):E.push(s)}})}),{failures:f,errors:E}}var O=p(894487);function M(h,r,n){return{logger:"actions:adagio",tags:{"do:actionOrigin":"remote","adagio:name":r.fnc},extra:{"err:original":h,"adagio:name":r.fnc,"adagio:opts":r.args,"do:groupId":n}}}function P(h){return{logger:"actions:adagio",tags:{"do:actionOrigin":"remote"},extra:{"err:original":new Error("Received from server a group with no actions"),"do:groupId":h.groupId,"do:parentId":h.parentId}}}function T({group:h,cancelStack:r,scoreData:n}){if(!h.actions||h.actions.length===0)return h.actions=[],{failures:[],errors:[P(h)]};r=r.createSubstack(h.groupId),h.cancelStack=r;const f=[],E=[];return h.actions.forEach(S=>{try{if(!n[S.fnc])throw new Error(`[rt] Cannot find Adagio function ${S.fnc}`);const g=JSON.parse(JSON.stringify(S.args));n[S.fnc](g,r)}catch(g){const t=M(g,S,h.groupId);(0,A.A)(g)?f.push(t):E.push(t)}}),{failures:f,errors:E}}function et(h,r,n){return{logger:"actions:adagio",tags:{"do:actionOrigin":"local.rebase-playBack","adagio:name":r.fnc},extra:{"err:original":h,"adagio:name":r.fnc,"adagio:opts":r.args,"do:groupId":n}}}function j({formerGroup:h,cancelStack:r,scoreData:n,parentId:f,userId:E,revisionId:y,rtSid:S,deviceId:g,deviceType:t,context:e="restore-group"}){r=r.createSubstack(h.groupId);const s=[],i=[],c=[];h.actions.forEach(I=>{try{if(!n[I.fnc])throw new Error(`[rt] Cannot find Adagio function ${I.fnc}`);const a=JSON.parse(JSON.stringify(I.args));let l=n[I.fnc](a,r);l=l.map(B,{groupId:h.groupId}),Array.prototype.push.apply(c,l)}catch(a){const l=et(a,I,h.groupId);(0,A.A)(a)?s.push(l):i.push(l)}});const u={failures:s,errors:i,group:null};return c.length>0&&(c.forEach(K),u.group={parentId:f,scoreId:h.scoreId,userId:h.userId,groupId:h.groupId,cancelStack:r,revisionId:y,actions:c,type:h.type,logs:h.logs.slice(),revertHistory:h.revertHistory.slice()},u.group.logs.push({date:new Date,context:e,user:E,revision:y,dataSid:(0,D.A)(),rtSid:S,deviceId:g,deviceType:t}),u.group.hash=(0,_.A)(u.group)),u}var q=p(293497);function b(h){h.ack=!0}var o=p(86134);function d(h,r,n){return{logger:"actions:adagio",tags:{"do:actionOrigin":"local.doTransac","adagio:name":r.fnc},extra:{"err:original":h,"adagio:name":r.fnc,"adagio:opts":r.args,"do:groupId":n}}}function F(h,r,n){return{logger:"actions:adagio",tags:{"do:actionOrigin":"local.transactionRollback","adagio:name":r.name},extra:{"err:original":h,"adagio:name":r.name,"adagio:opts":r.opts,"do:groupId":n}}}function J(h,r,n,f){(0,W.A)(r).forEach(y=>{try{if(!h[y.name])throw new Error(`[rt] Cannot find Adagio function ${y.name}`);const S=JSON.parse(JSON.stringify(y.opts));h[y.name](S,r)}catch(S){const g=F(S,y,n);f.push(g)}})}function X({actions:h,cancelStack:r,scoreData:n,parentId:f,scoreId:E,userId:y,revisionId:S,rtSid:g,deviceId:t,deviceType:e}){const s=(0,D.A)();r=r.createSubstack(s);const i=[],c=[],u=[],I=h.some(l=>{try{if(!n[l.fnc])throw new Error(`[rt] Cannot find Adagio function ${l.fnc}`);const R=JSON.parse(JSON.stringify(l.args));let G=n[l.fnc](R,r);G=G.map(B,{groupId:s}),Array.prototype.push.apply(i,G)}catch(R){const G=d(R,l,s);return(0,A.A)(R)?c.push(G):u.push(G),!0}return!1}),a={failures:c,errors:u,group:null};return I?J(n,r,s,u):i.length>0&&(i.forEach(K),a.group={parentId:f,groupId:s,scoreId:E,userId:y,cancelStack:r,actions:i,type:x,revisionId:S,revertHistory:[],logs:[{date:new Date,context:x,user:y,revision:S,dataSid:(0,D.A)(),rtSid:g,deviceId:t,deviceType:e}]},a.group.hash=(0,_.A)(a.group)),a}function V(h,r,n){return{logger:"actions:adagio",tags:{"do:actionOrigin":"local.doTransac","adagio:name":r.fnc},extra:{"err:original":h,"adagio:name":r.fnc,"adagio:opts":r.args,"do:groupId":n}}}function U(h,r,n){return{logger:"actions:adagio",tags:{"do:actionOrigin":"local.transactionRollback","adagio:name":r.name},extra:{"err:original":h,"adagio:name":r.name,"adagio:opts":r.opts,"do:groupId":n}}}function C(h,r,n,f){(0,W.A)(r).forEach(y=>{try{if(!h[y.name])throw new Error(`[rt] Cannot find Adagio function ${y.name}`);const S=JSON.parse(JSON.stringify(y.opts));h[y.name](S,r)}catch(S){const g=U(S,y,n);f.push(g)}})}function k({groupId:h,actions:r,cancelStack:n,scoreData:f}){const E=[],y=[],S=[],g=r.some(e=>{try{if(!f[e.fnc])throw new Error(`[rt] Cannot find Adagio function ${e.fnc}`);const s=JSON.parse(JSON.stringify(e.args));let i=f[e.fnc](s,n);i=i.map(B,{groupId:h}),Array.prototype.push.apply(E,i)}catch(s){const i=V(s,e,h);return(0,A.A)(s)?y.push(i):S.push(i),!0}return!1}),t={failures:y,errors:S,completedActions:null};return g?C(f,n,h,S):t.completedActions=E,t}class at{constructor({scoreId:r,revisionId:n,userId:f,groupIdWatcher:E=null,deviceId:y=null,deviceType:S=null,instanceId:g=null}){this.instanceId=g,this.deviceType=S,this.deviceId=y,this.undoList=new o.A(q.A),this.redoList=new o.A(q.A),this.localGroups=[],this.removedGroupsIds=[],this.errorLogger=null,this.failureLogger=null,this.parentId=null,this.lastSyncGroupId=null,this.pendingLocalGroups=null,this.scoreId=r,this.revisionId=n,this.userId=f,this.groupIdWatcher=E,this.partialActions=null,this.partialGroupId=null,this.partialCancelStack=null}_setParentId(r){this.parentId=r,this.groupIdWatcher&&this.groupIdWatcher(r)}setRevisionId(r){this.revisionId=r,this.localGroups.forEach(n=>{n.revisionId=r,n.hash=(0,_.A)(n)})}setErrorLogger(r){this.errorLogger=r}setFailureLogger(r){this.failureLogger=r}getScoreData(){return this.scoreData}dumpState(){const r={},n=f=>JSON.parse(JSON.stringify(f)).map(E=>(delete E.cancelStack,E));return r.undoList=n(this.undoList.getList()),r.redoList=n(this.redoList.getList()),r.localGroups=n(this.localGroups),r.instanceId=this.instanceId,r.parentId=this.parentId,r.lastSyncGroupId=this.lastSyncGroupId,r.revisionId=this.revisionId,r.deviceId=this.deviceId,r.deviceType=this.deviceType,r}executeLocalActions(r,{cancelStack:n,scoreData:f}){this._checkNoPartialGroup("executeLocalActions");const E={actions:r,cancelStack:n,scoreData:f,parentId:this.parentId,scoreId:this.scoreId,userId:this.userId,revisionId:this.revisionId,rtSid:this.instanceId,deviceId:this.deviceId,deviceType:this.deviceType},{group:y,errors:S,failures:g}=H(E);return this._logErrors(S),this._logFailures(g),y&&(this._pushGroup(y),this.undoList.push(y),this._clearRedoList()),y}executeTransactionalLocalActions(r,{cancelStack:n,scoreData:f}){this._checkNoPartialGroup("executeTransactionalLocalActions");const E={actions:r,cancelStack:n,scoreData:f,parentId:this.parentId,scoreId:this.scoreId,userId:this.userId,revisionId:this.revisionId,rtSid:this.instanceId,deviceId:this.deviceId,deviceType:this.deviceType},{group:y,errors:S,failures:g}=X(E);return this._logErrors(S),this._logFailures(g),y&&(this._pushGroup(y),this.undoList.push(y),this._clearRedoList()),y}_clearRedoList(){this.redoList=new o.A(q.A)}executePartialTransactionalLocalActionsGroup(r,{cancelStack:n,scoreData:f}){this.createPartialGroupIfNeeded(n);const E={actions:r,scoreData:f,parentId:this.parentId,scoreId:this.scoreId,userId:this.userId,revisionId:this.revisionId,rtSid:this.instanceId,deviceId:this.deviceId,deviceType:this.deviceType,cancelStack:this.partialCancelStack,groupId:this.partialGroupId},{completedActions:y,errors:S,failures:g}=k(E);this._logErrors(S),this._logFailures(g),y?this.partialActions.push(...y):this._clearPartialGroup()}createPartialGroupIfNeeded(r){this.hasPartialGroup()||(this.partialActions=[],this.partialGroupId=(0,D.A)(),this.partialCancelStack=r.createSubstack(this.partialGroupId))}consolidatePartialActions(){if(!this.hasPartialGroup())throw new Error("There is no partial actions to consolidate into a new group");if(this.partialActions.length===0)return this._clearPartialGroup(),null;this.partialActions.forEach(K);const{parentId:r,scoreId:n,userId:f,revisionId:E,deviceId:y,deviceType:S,instanceId:g}=this,t={parentId:r,groupId:this.partialGroupId,scoreId:n,userId:f,cancelStack:this.partialCancelStack,actions:this.partialActions,type:x,revisionId:E,revertHistory:[],logs:[{date:new Date,context:x,user:f,revision:E,dataSid:(0,D.A)(),rtSid:g,deviceId:y,deviceType:S}]};return t.hash=(0,_.A)(t),this._clearPartialGroup(),this._pushGroup(t),this.undoList.push(t),this._clearRedoList(),t}_clearPartialGroup(){this.partialActions=null,this.partialGroupId=null,this.partialCancelStack=null}_checkNoPartialGroup(r){if(this.hasPartialGroup())throw new Error(`Cannot perform ${r}, as there is some ongoing partial transaction.`)}hasPartialGroup(){return this.partialGroupId!==null}undo({cancelStack:r,scoreData:n}){this._checkNoPartialGroup("undo");const E={previousGroup:this.undoList.pop(),cancelStack:r,scoreData:n,parentId:this.parentId,actionType:v,userId:this.userId,scoreId:this.scoreId,revisionId:this.revisionId,rtSid:this.instanceId,deviceId:this.deviceId,deviceType:this.deviceType},{group:y,errors:S,failures:g}=Q(E);return this._logErrors(S),g.length>0&&this._logFailureWhileUndo(g),y&&(this._pushGroup(y),this.redoList.push(y)),y}_logFailureWhileUndo(r){const n=new Error("All actions were not undone, due to change in the score by other users."),f={logger:"actions:synchronizer",tags:{"do:ctx":"local.undo"},extra:{"err:original":n,"err:failuresList":r}};this._logFailures([f])}redo({cancelStack:r,scoreData:n}){this._checkNoPartialGroup("redo");const E={previousGroup:this.redoList.pop(),cancelStack:r,scoreData:n,parentId:this.parentId,actionType:L,userId:this.userId,scoreId:this.scoreId,revisionId:this.revisionId,rtSid:this.instanceId,deviceId:this.deviceId,deviceType:this.deviceType},{group:y,errors:S,failures:g}=Q(E);return this._logErrors(S),g.length>0&&this._logFailureWhileRedo(g),y&&(this._pushGroup(y),this.undoList.push(y)),y}_logFailureWhileRedo(r){const n=new Error("All actions were not restored, due to change in the score by other users."),f={logger:"actions:synchronizer",tags:{"do:ctx":"local.redo"},extra:{"err:original":n,"err:failuresList":r}};this._logFailures([f])}_logErrors(r){this.errorLogger!==null&&this.errorLogger.logItems(r)}_logFailures(r){this.failureLogger!==null&&this.failureLogger.logItems(r)}canUndo(){return!this.undoList.isEmpty()}canRedo(){return!this.redoList.isEmpty()}getNbLocalGroups(){return this.localGroups.length}getNbPossibleUndo(){return this.undoList.getSize()}getNbPossibleRedo(){return this.redoList.getSize()}playRemoteGroups(r,{cancelStack:n,scoreData:f,revertLocalGroups:E=!0}){if(this._checkNoPartialGroup("playRemoteGroups"),r.length===0&&E){this.removedGroupsIds=[];return}if(this.ctx={cancelStack:n,scoreData:f},r=this._skipSyncedGroups(r),this._rewindGroupsToLastSync(),r=this._fastForward(r),r.length===0&&E){if(this.removedGroupsIds=[],this.localGroups=this.pendingLocalGroups,this.pendingLocalGroups=null,this.localGroups.length>0){const y=this.localGroups[this.localGroups.length-1];this._setParentId(y.groupId)}return}E&&this._rewindDataToLastSync(),this._convertLocalGroupsToIndexedList(),r.forEach(this._playRemoteGroup,this),this._convertLocalGroupsToArray(),this._playPendingLocals(),this.pendingLocalGroups=null}_skipSyncedGroups(r){const n=(0,O.A)(r,this.lastSyncGroupId);if(!n.isFound){const f=new Error(`The last synced group id ${this.lastSyncGroupId}
        does not appears as parent of any given group.`),E={logger:"actions:synchronizer",tags:{"do:ctx":"local._skipSyncedGroups"},extra:{"err:original":f,"data:lastSyncGroupId":this.lastSyncGroupId,"data:firstRemoteGroupParentId":r[0].parentId}};this._logErrors([E])}return n.groups}_rewindGroupsToLastSync(){this.pendingLocalGroups=this.localGroups,this.localGroups=null,this._setParentId(this.lastSyncGroupId)}_fastForward(r){const n=$(this.pendingLocalGroups,r);if(this.pendingLocalGroups=n.localGroups,n.syncGroups.forEach(this._stateGroupSynced,this),n.syncGroups.length>0){const f=n.syncGroups[n.syncGroups.length-1];this._setParentId(f.groupId),this.lastSyncGroupId=f.groupId,this.lastSyncGroupHash=f.hash}return n.remoteGroups}_stateGroupSynced(r){b(r)}rewindDataToLastSync({cancelStack:r,scoreData:n}){this._checkNoPartialGroup("rewindDataToLastSync"),this.ctx={cancelStack:r,scoreData:n},this._rewindGroupsToLastSync(),this._rewindDataToLastSync(),this.pendingLocalGroups=null,this.localGroups=[]}_rewindDataToLastSync(){const r={cancelStack:this.ctx.cancelStack,scoreData:this.ctx.scoreData,groups:this.pendingLocalGroups},{errors:n,failures:f}=w(r);this._logErrors(n),this._logErrors(f)}_convertLocalGroupsToIndexedList(){const r=new o.A(q.A);this.pendingLocalGroups.forEach(r.push,r),this.pendingLocalGroups=r}_playRemoteGroup(r){const n={cancelStack:this.ctx.cancelStack,scoreData:this.ctx.scoreData,group:r},{errors:f,failures:E}=T(n);this._logErrors(f),this._logErrors(E),this._replaceGroup(r),this.pendingLocalGroups.remove(r),this._setParentId(r.groupId),this.lastSyncGroupId=r.groupId,this.lastSyncGroupHash=r.hash}_convertLocalGroupsToArray(){this.pendingLocalGroups=this.pendingLocalGroups.getList()}_playPendingLocals(){this.localGroups=[],this.playLocalGroups(this.pendingLocalGroups,this.ctx,"restoredAfterRebase")}playLocalGroups(r,{cancelStack:n,scoreData:f},E){this._checkNoPartialGroup("playLocalGroups"),this.ctx={cancelStack:n,scoreData:f},this.removedGroupsIds=[],r.forEach(y=>this._playLocalGroup(y,E))}_playLocalGroup(r,n){const f={formerGroup:r,cancelStack:this.ctx.cancelStack,scoreData:this.ctx.scoreData,parentId:this.parentId,scoreId:this.scoreId,userId:this.userId,revisionId:this.revisionId,rtSid:this.instanceId,deviceId:this.deviceId,deviceType:this.deviceType,context:n},{errors:E,failures:y,group:S}=j(f);this._logErrors(E),y.length>0&&this._logFailureWhileRestoreLocal(y),S!==null?(this._replaceGroup(S),this._pushGroup(S)):this._stateGroupRemoved(r)}_logFailureWhileRestoreLocal(r){const n=new Error("Some actions could not be applied after getting an update from the server."),f={logger:"actions:synchronizer",tags:{"do:ctx":"local._playLocalGroup"},extra:{"err:original":n,"err:failuresList":r}};this._logFailures([f])}_replaceGroup(r){this.redoList.replace(r),this.undoList.replace(r)}_stateGroupRemoved(r){this.undoList.remove(r),this.redoList.remove(r),this.removedGroupsIds.push(r.groupId)}_pushGroup(r){this.localGroups.push(r),this._setParentId(r.groupId)}getLocalGroups(){return this.localGroups}getRemovedGroupIds(){return this.removedGroupsIds}resetParent(){if(this.lastSyncGroupId=null,this.localGroups.length>0){const r=this.localGroups[0];r.parentId=null,r.hash=(0,_.A)(r)}else this._setParentId(null)}getLastSyncGroupId(){return this.lastSyncGroupId}getParentId(){return this.parentId}getLastUndoGroupId(){const{groupId:r}=this.undoList.getLast();return r}getLastRedoGroupId(){const{groupId:r}=this.redoList.getLast();return r}}},897775:(tt,N,p)=>{p.d(N,{A:()=>D});class D{constructor(){this.list=[]}logItem(x){this.list.push(x)}logItems(x){Array.prototype.push.apply(this.list,x)}isEmpty(){return this.list.length===0}clear(){this.list=[]}}}}]);})();


//# debugId=370e6290-8fd2-5a54-afa5-e4ffd4dd13d9

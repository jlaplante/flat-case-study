"use strict";
!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="7a912d1e-c01d-599c-be6e-521e032ab8fb")}catch(e){}}();
(()=>{/*! Copyright (c) 2025 Tutteo Ltd. */(self.webpackChunk_flat_flat=self.webpackChunk_flat_flat||[]).push([[37718],{25606:(k,R,o)=>{o.d(R,{A:()=>N});const g=function(M,P){let f=M.findIndex(v,P.startPosition);f===-1?f=M.length-1:M[f]>P.startPosition&&f--;let m=M.findIndex(v,P.stopPosition);return m===-1&&(m=M.length),{startMeasureIdx:f,stopMeasureIdx:m}},v=function(M){return this.valueOf()<=M},N=g},489615:(k,R,o)=>{o.d(R,{A:()=>g});function g(v){const N=[],M=v.getMeasuresSlice(),P=M.getNbMeasures();for(let f=0;f<P;f++){const S=M.getMeasure(f).getFormatting();N.push(S)}v.dispatchHorizontalFormatting(N)}},835765:(k,R,o)=>{o.d(R,{A:()=>M});var g=o(726042),v=(f,m,S)=>new Promise((p,b)=>{var I=C=>{try{T(S.next(C))}catch(D){b(D)}},W=C=>{try{T(S.throw(C))}catch(D){b(D)}},T=C=>C.done?p(C.value):Promise.resolve(C.value).then(I,W);T((S=S.apply(f,m)).next())});const N=8;function M(f,m,S){return v(this,null,function*(){let p=N;if(f.hasSettedWidth()){const b=f.getSettedWidth()-f.measuresWidth,I=P(m);I!==null&&(p=Math.ceil(b/I))}else f.hasSettedRange()?(p=f.displayRangeRef.measuresRange.stopMeasureIdx-m.getNbMeasures(),p=Math.max(p,0)):p=S.getNbMeasuresInCache();yield S.initNextMeasuresSystems(p)})}function P(f){const m=[],S=f.getNbMeasures();for(let I=0;I<S;I++){const W=f.getMeasureColumn(I);if(W.hasFormatting()){const T=W.getWidth();m.push(T)}}return m.length===0?null:m.reduce(g.default.add)/m.length}},937718:(k,R,o)=>{o.d(R,{A:()=>Je});var g=o(364842),v=o(732799),N=o(790850),M=o(801370),P=o(123868),f=o(454921),m=o(331751),S=o(249394),p=o(891959),b=o(100040),I=o(462317),W=o(25606);const T=function(e,t){const s=C(e);return(0,W.A)(s,t)},C=function(e){const t=[0];let s=0;const r=e.getNbMeasures();for(let a=0;a<r-1;a++){const n=e.getMeasureWidth(a);s+=n,t.push(s)}return t},D=T;function J(e,t){let s=0,r=0;for(;r<t.startMeasureIdx;r++){const c=e.getMeasureColumn(r).getWidth();s+=c}const a=s;for(;r<t.stopMeasureIdx;r++){const c=e.getMeasureColumn(r).getWidth();s+=c}return{startPosition:a,stopPosition:s}}var F=o(726042);const Z=function(e){if(e===null)return;const t=e.startPosition;(!F.default.isInteger(t)||t<0)&&q(t);const s=e.stopPosition;(!F.default.isInteger(s)||s<=t)&&_(s)},q=function(e){const t=`The start display idx [${e}] is invalid. It must be an integer >= 0.`;throw new g.default("BadDisplayRange",t)},_=function(e){const t=`The stop display idx [${e}] is invalid. It must be an integer higher then the start.`;throw new g.default("BadDisplayRange",t)},ee=Z;var te=o(98710),se=o(367279),re=o(658140),A=o(377072);const L=function(){this.init()},u=L.prototype;u.init=function(){this.id=null,this.isFirst=null,this.displayRangeRef=null,this.systemProvider=null,this.measuresWidth=0,this.measures=[],this.systems=null,this.firstDisplayedMeasureIdx=0,this.shards=[]},u.setId=function(e){this.id=e},u.setDisplayRangeRef=function(e){this.displayRangeRef=e},u.setIsFirst=function(e){if(this.isFirst=e,this.isFirst&&this.measures.length>0){const[t]=this.measures,r=this.getInsertedMeasurePosition(!0);t.setMeasurePosition(r),this.shards.forEach(ie)}};function ie(e){e.resetHeadersWidth()}u.setSystemProvider=function(e){this.systemProvider=e},u.addShard=function(e){this.shards.push(e),e.setMeasuresSlice(this)},u.canPushMeasure=function(){return this.measures.length===0?!0:!this.hasWidthOverflow()},u.pushMeasure=function(e){const t=this.measures.length===0,s=this.getInsertedMeasurePosition(t);if(e.setMeasurePosition(s),this.measuresWidth!==null){const a=e.getWidth();this.measuresWidth+=a}const r=this.getNbMeasures();this.measures.push(e),this.insertMeasureToSystems(e,r),e.setMeasuresSlice(this)},u.getInsertedMeasurePosition=function(e){return e?this.isFirst?A.A.FIRST_OF_SCORE:A.A.FIRST_OF_LINE:A.A.OTHER},u.unshiftMeasures=function(e){e=e.slice(),e.reverse(),e.forEach(this.unshiftMeasure,this)},u.unshiftMeasure=function(e){this.measuresWidth=null;const s=this.getInsertedMeasurePosition(!0);e.setMeasurePosition(s),this.measures.unshift(e),e.setMeasuresSlice(this),this.insertMeasureToSystems(e,0),this.getNbMeasures()>1&&this.measures[1].setMeasurePosition(A.A.OTHER)},u.insertMeasure=function(e,t){this.measuresWidth=null;const s=t===0,r=this.getInsertedMeasurePosition(s);e.setMeasurePosition(r),this.measures.splice(t,0,e),e.setMeasuresSlice(this),this.insertMeasureToSystems(e,t),s&&this.measures.length>1&&this.measures[1].setMeasurePosition(A.A.OTHER)},u.insertMeasureToSystems=function(e,t){this.getSystems().forEach(function(r,a){const n=e.getSystemMeasure(a);r.insertMeasure(n,t)})},u.popMeasure=function(){const e=this.getNbMeasures();if(e===0){const r="Cannon pop on an empty MeasuresSlice.";throw new g.default("PopOnEmpty",r)}const t=e-1;this.removeMeasureFromSystems(t);const s=this.measures.pop();if(s.setMeasuresSlice(null),this.measuresWidth!==null){const r=s.getWidth();this.measuresWidth-=r}return s},u.removeMeasure=function(e){if(this.measuresWidth=null,this.removeMeasureFromSystems(e),this.measures.splice(e,1)[0].setMeasuresSlice(null),e===0&&this.measures.length>0){const s=this.measures[0],a=this.getInsertedMeasurePosition(!0);s.setMeasurePosition(a)}},u.removeMeasureFromSystems=function(e){this.getSystems().forEach(function(s){s.removeMeasure(e)})},u.needRecomputeUsedWidth=function(){return this.measuresWidth===null},u.recomputeUsedWidth=function(){const e=this.measures.map(ae);this.measuresWidth=e.reduce(F.default.add,0)};function ae(e){return e.getWidth()}u.reloadAllCrossMeasures=function(){this.getSystems().forEach(function(t){t.reloadAllCrossMeasures()})},u.hasWidthOverflow=function(){if(this.hasSettedWidth()){const e=this.getSettedWidth();return this.measuresWidth>e}return this.hasSettedRange()?this.isEncompassingRange():!1},u.popOverflowMeasures=function(){const e=[];let t;for(;this.measures.length>1&&this.hasWidthOverflowWithoutLastMeasure();)t=this.popMeasure(),e.unshift(t);return e},u.hasWidthOverflowWithoutLastMeasure=function(){if(this.hasSettedWidth()){const e=this.getSettedWidth(),t=this.getLastMeasureWidth();return this.measuresWidth-t>e}else return!1},u.getLastMeasureWidth=function(){const e=this.getNbMeasures();return this.measures[e-1].getWidth()},u.getMeasureStartDisplayIdx=function(){return this.measures[0].getDisplayIdx()},u.replaceMeasure=function(e,t,s){const r=this.measures.indexOf(e),a=this.getSystems(),n=a[s];if(typeof n=="undefined"){const d=new g.default("Unexpected","[bughunt-1] system value is undefined in `_measuresSlice.replaceMeasure`.");throw d.systemIdx=s,d.nbSystems=a.length,d}n.replaceMeasure(t,r),this.measuresWidth=null},u.updateId=function(e){this.id=e,e===0&&(this.isFirst=!0,this.isEmpty()||(this.measures[0].setMeasurePosition(A.A.FIRST_OF_SCORE),this.measuresWidth=null))},u.getSystems=function(){return this.systems===null&&this.createSystems(),this.systems},u.createSystems=function(){this.systems=[];const e=this.getNbSystems();for(let t=0;t<e;t++){const s=this.systemProvider.getSystem(t,this.isFirst);this.systems.push(s)}this.systemProvider.insertGroups(this.systems)},u.getNbSystems=function(){return this.measures[0].getNbSystems()},u.getNbMeasures=function(){return this.measures.length},u.getMeasureWidth=function(e){return this.getMeasure(e).getWidth()},u.getMeasure=function(e){return this.measures[e]},u.getMeasureStartDataIdx=function(){return this.measures[0].getDataIdx()},u.getIdx=function(){return this.id},u.getIdxInSlice=function(e){const t=this.measures.indexOf(e);if(t===-1){const s="The measure is not in this slice";throw new g.default("NotInSlice",s)}return t},u.isEmpty=function(){return this.getNbMeasures()===0},u.getBindedShards=function(){let e=this.getShards();return e=e.filter(ne),e};function ne(e){return e.hasPageContent()}u.getShards=function(){return this.shards},u.getShardsIndexes=function(){return this.shards.map(ue)};function ue(e){return e.getIdx()}u.hasSettedWidth=function(){return this.displayRangeRef.displayRange!==null&&this.displayRangeRef.measuresRange===null},u.hasSettedRange=function(){return this.displayRangeRef.measuresRange!==null},u.isEncompassingRange=function(){return this.measures.length>=this.displayRangeRef.measuresRange.stopMeasureIdx},u.getSettedWidth=function(){return this.displayRangeRef.displayRange.stopPosition},u.getSystem=function(e){const t=this.getSystems(),s=t.length;if(!F.default.isInteger(e)||e<0||e>=s){const r=`The system idx [${e}] is invalid.`;throw new g.default("BadSystemIdx",r)}return t[e]},u.setFirstDisplayedMeasure=function(e){this.firstDisplayedMeasureIdx=e,this.getSystems().forEach(s=>{s.setFirstDisplayedMeasure(e)})},u.bindStaves=function(){this.getSystems().forEach(t=>t.bindStaves())},u.updateChildrenBindings=function(){this.getSystems().forEach(t=>t.updateMeasuresBindings())},u.updateMeasuresLastOfSystem=function(){this.measures.forEach((e,t)=>{const s=t===this.measures.length-1;e.setIsLastOfSystem(s)})};const oe=L;var he=o(835765),de=o(696847),ce=(e,t,s)=>new Promise((r,a)=>{var n=h=>{try{c(s.next(h))}catch(l){a(l)}},d=h=>{try{c(s.throw(h))}catch(l){a(l)}},c=h=>h.done?r(h.value):Promise.resolve(h.value).then(n,d);c((s=s.apply(e,t)).next())});const z=function(e){this.init(e)},E=z.prototype;E.init=function({measureProvider:e,systemProvider:t,displayRangeRef:s,measuresSlicesContainer:r,measureColumnsContainer:a}){this.measureProvider=e,this.systemProvider=t,this.displayRangeRef=s,this.measuresSlicesContainer=r,this.measureColumnsContainer=a,this.sliceIdx=0},E.setMeasureProvider=function(e){this.measureProvider=e},E.hasRemaining=function(){return this.measureProvider.hasRemaining()},E.getSlice=function(){return ce(this,null,function*(){if(this.sliceIdx>0)throw new g.default("There should only be one slice for TrackLayout");const e=this.createSlice();for(yield(0,he.A)(e,this.measureColumnsContainer,this.measureProvider);this.measureProvider.hasRemaining()&&e.canPushMeasure();){const t=this.measureProvider.getMeasure();t.areSystemsInitialized()||(yield t.initSystems()),e.pushMeasure(t),this.measureColumnsContainer.push(t)}return le(this.displayRangeRef.displayRange,e),e.bindStaves(),e.updateChildrenBindings(),e.updateMeasuresLastOfSystem(),e})},E.createSlice=function(){const e=new oe;return e.setId(this.sliceIdx),e.setDisplayRangeRef(this.displayRangeRef),e.setIsFirst(!0),e.setSystemProvider(this.systemProvider),this.sliceIdx++,this.measuresSlicesContainer.setMeasuresSlice(e),e};function le(e,t){const s=(0,de.default)(e,t);t.setFirstDisplayedMeasure(s)}const fe=z;var ge=o(760210),me=o(489615),Se=o(225723),B=o(701933),H=(e,t,s)=>new Promise((r,a)=>{var n=h=>{try{c(s.next(h))}catch(l){a(l)}},d=h=>{try{c(s.throw(h))}catch(l){a(l)}},c=h=>h.done?r(h.value):Promise.resolve(h.value).then(n,d);c((s=s.apply(e,t)).next())});const Y=function(e,t,s){this.init(e,t,s)},x=Y.prototype;x.init=function(e,t,s){this.measuresSliceProvider=e,this.drawingContext=t,this.metrics=s,this.measuresNumbersPanel=null,this.partsNamesPanel=null,this.shardIdx=0},x.setMeasuresNumbersPanel=function(e){this.measuresNumbersPanel=e},x.setPartsNamesPanel=function(e){this.partsNamesPanel=e},x.setShardIdx=function(e){this.shardIdx=e},x.hasRemaining=function(){return this.measuresSliceProvider.hasRemaining()},x.getShard=function(){return H(this,null,function*(){const e=yield this.loadNextSliceShard();return e.linkGroupBracket(),e.updateGroupBracketsOffsets(),(0,me.A)(e),e.reloadAllCrossMeasures(),e.dropVerticalFormatting(),e.updateCrossMeasuresHorizontalDisplayForVerticalComputation(),e.dispatchVerticalFormatting(),e.hasEventsRects()&&(e.autoSetExternalSystemMeasureGaps(),e.updateMeasuresEventsRects()),e})},x.loadNextSliceShard=function(){return H(this,null,function*(){if(this.shardIdx>0)throw new g.default("Cannot load more than one shard on track display");const e=yield this.measuresSliceProvider.getSlice(),t=e.getSystems();(0,Se.A)(t),t.forEach(r=>r.transferHeaderExternalSpace()),t.forEach(Me);const s=this.createShard();return t.forEach(s.pushSystem,s),s.updateChildrenBindings(),e.addShard(s),s})};function Me(e,t){t===0?e.setLocation(B.A.FIRST_OF_SLICE):e.setLocation(B.A.OTHER)}x.createShard=function(){const e=new ge.A;return this.partsNamesPanel!==null&&this.partsNamesPanel.setScoreShard(e),this.measuresNumbersPanel!==null&&this.measuresNumbersPanel.setScoreShard(e),e.setDrawingContext(this.drawingContext),e.setMetrics(this.metrics),e.height=null,e.setIsFirst(!0),e.setIdx(this.shardIdx),this.metrics.hasSingleStaff||e.createVerticalLine(),this.shardIdx++,e},x.handBackShards=function(e){if(e.length>0)throw new g.default("There should be no shards handed back to the ShardProvider")},x.clearCache=function(){};const pe=Y,X=function(){this.init()},U=X.prototype;U.init=function(){},U.build=function({scoreDataCache:e,containers:t,drawingContext:s,displayOpts:r,displayRangeRef:a,measureNumberingPolicy:n,startMeasureIdx:d}){const c=new te.A(r),h=new se.A({scoreDataCache:e,measureRenderer:c,drawingContext:s,startMeasureIdx:d,measureNumberingPolicy:n}),l=new re.A(e,s,r),y=new fe({measureProvider:h,systemProvider:l,displayRangeRef:a,measuresSlicesContainer:t.measuresSlices,measureColumnsContainer:t.measureColumns}),w={hasSingleStaff:l.hasSingleStaff()},Q=new pe(y,s,w);return this.measureProvider=h,this.sliceProvider=y,this.shardProvider=Q,this.measureProvider=h,this.systemProvider=l,Q};const ye=X;var Pe=o(918705),Ie=o(200608),xe=o(21738),ve=o(131220),Ce=o(409200),Ne=o(665280),O=o(737903),Re=o(472744),be=o(342023);function Te(e,t){const s=[];return We(e,s),Fe(t,s),s.reduce(F.default.add)/s.length}function We(e,t){const s=e.getNbMeasures();for(let r=0;r<s;r++){const n=e.getMeasureColumn(r).getWidth();t.push(n)}}function Fe(e,t){const s=e.getNbMeasuresInCache();for(let r=0;r<s;r++){const a=e.getCachedMeasure(r);if(!a.areSystemsInitialized()||!a.hasFormatting())return;const n=a.getWidth();t.push(n)}}class Ae{constructor({measuresContainer:t,measureProvider:s,scoreShard:r}){this.measuresContainer=t,this.measureProvider=s,this.scoreShard=r,this.measuresColumns=[],this.measurePositions=[],this.measureWidths=[],this.fakeMeasureWidth=null}update(){this.adjustNbFakeMeasures(),this.updatePositions()}adjustNbFakeMeasures(){const t=this.measureProvider.getNbMeasuresInCache(),s=this.getNbFakeMeasures();if(s>t){const r=s-t;this.removeMeasures(r)}else if(s<t){const r=t-s;this.addMeasures(r)}}getNbFakeMeasures(){return this.measuresColumns.length}removeMeasures(t){for(let s=0;s<t;s++){const r=this.measuresColumns.pop();r.forEach(a=>{a.group.removeFromParent()}),this.measuresColumns.length===0&&r.forEach(a=>{a.staff.setFakeMeasure(null)})}}addMeasures(t){for(let s=0;s<t;s++)this.addMeasureColumn()}addMeasureColumn(){const t=[],s=this.scoreShard.getNbSystems();for(let r=0;r<s;r++){const n=this.scoreShard.getSystem(r).content,d=n.getNbStaves();for(let c=0;c<d;c++){const h=n.getStaff(c),l=new be.default("g");l.attr("class","fakeMeasure");const y={group:l,staff:h};y.staff.getGroup().append(y.group),t.push(y)}}this.measuresColumns.length===0&&t.forEach(r=>{r.staff.setFakeMeasure(r.group)}),this.measuresColumns.push(t)}updatePositions(){const t=this.measureProvider.getNbMeasuresInCache();this.measurePositions=[],this.fakeMeasureWidth=Te(this.measuresContainer,this.measureProvider);let s=this.scoreShard.getContentWidth();for(let r=0;r<t;r++){this.measurePositions.push(s);let a;const n=this.measureProvider.getCachedMeasure(r);!n.areSystemsInitialized()||!n.hasFormatting()?a=this.fakeMeasureWidth:a=n.getWidth(),this.measureWidths.push(a),this.updateMeasureDisplay(r,s),s+=a}this.fakeStaffWidth=s,this.updateStavesWidths()}updateMeasureDisplay(t,s){this.measuresColumns[t].forEach(a=>{const n=a.staff.getSpaceAbove();a.group.attr("transform",`translate(${s} ${n})`)})}updateStavesWidths(){const t=this.scoreShard.getNbSystems();for(let s=0;s<t;s++){const a=this.scoreShard.getSystem(s).content,n=a.getNbStaves();for(let d=0;d<n;d++)a.getStaff(d).staffLines.setWidth(this.fakeStaffWidth)}}getMeasurePosX(t){return this.measurePositions[t]}getContentWidth(){return this.fakeStaffWidth}}var $=o(269352);class we{constructor(){this.group=new $.A("g"),this.scoreShard=null,this.svg=null,this.scaling=null,this.marginLeft=0}setSvg(t){this.svg=t,this.svg.append(this.group)}setScoreShard(t){this.scoreShard=t,this.scoreShard.setHeadersGroup(this.group)}setMarginLeft(t){this.marginLeft=t}setScaling(t){this.scaling=t}updateSvgSize(){const t=this.getWidth()*this.scaling,s=this.getHeight()*this.scaling;this.svg.attr("width",t),this.svg.attr("height",s),this.svg.style("flexBasis",`${s}px`),this.group.attr("transform",`translate(${this.marginLeft*this.scaling}, ${this.getMarginTop()*this.scaling}) scale(${this.scaling})`)}getHeight(){return this.scoreShard.getHeight()+this.getMarginTop()}getMarginTop(){return this.scoreShard.posY}getScaledWidth(){return this.getWidth()*this.scaling}getWidth(){return this.scoreShard.getHeaderWidth()+this.marginLeft}getGroup(){return this.group}}var De=o(100673);class Ee{constructor({hasPickup:t,drawingContext:s}){this.group=new $.A("g"),this.drawingContext=s,this.scoreShard=null,this.measureNumbers=[],this.svg=null,this.hasPickup=t,this.scaling=null,this.fakeMeasures=null,this.marginTop=0}setSvg(t){this.svg=t,this.svg.append(this.group)}setScoreShard(t){this.scoreShard=t}setFakeMeasures(t){this.fakeMeasures=t}update(){this.clearMeasureNumbers(),this.fillMeasuresNumbers()}clearMeasureNumbers(){this.measureNumbers.forEach(ke),this.measureNumbers=[]}fillMeasuresNumbers(){const t=this.scoreShard.getNbMeasures(),s=this.scoreShard.getMeasuresSlice().measures;for(let a=0;a<t;a++){const n=this.measureIdxToMeasureNumber(s[a].displayIdx);n>0&&!(this.hasPickup&&a===0)&&this.addNumber(a,n)}const r=this.fakeMeasures.getNbFakeMeasures();for(let a=0;a<r;a++){const n=this.measureIdxToMeasureNumber(a+t);n>0&&this.addFakeNumber(a,n)}}addNumber(t,s){const r=this.scoreShard.getMeasurePosX(t);this.addNumberAtPos(s,r)}addFakeNumber(t,s){const r=this.fakeMeasures.getMeasurePosX(t);this.addNumberAtPos(s,r)}addNumberAtPos(t,s){const r=this.getFontSize(),a={};a["font-size"]=r,a["font-family"]=this.drawingContext.getPageNumberFontFamily(),a.text=t.toString();const n=new De.A(a);n.setDrawingContext(this.drawingContext),n.render();const d=this.drawingContext.getSpaceSize(),c=s+d,h=r;n.setPosition(c,h),n.setParent(this.group),n.draw(),this.measureNumbers.push(n)}measureIdxToMeasureNumber(t){return t+1}setScaling(t){this.scaling=t}setMarginTop(t){this.marginTop=t}updateSvgSize(){const t=this.getWidth(),s=this.getHeight();this.svg.attr("width",t*this.scaling),this.svg.attr("height",s*this.scaling),this.group.attr("transform",`translate(0, ${this.marginTop*this.scaling}) scale(${this.scaling})`)}getScaledHeight(){return this.getHeight()*this.scaling}getHeight(){return this.getFontSize()*1.5+this.marginTop}getScaledMarginTop(){return this.marginTop*this.scaling}getWidth(){return this.fakeMeasures.getContentWidth()}getFontSize(){return this.drawingContext.getMeasureNumberFontSize()}}function ke(e){e.hide()}function Ge(e,t){const s=e.getNbMeasures();if(t.startMeasureIdx>=s)return null;const r=Math.min(t.stopMeasureIdx,s-1);let a=e.getMeasureColumn(r);if(!a.isInDisplayedRange())return null;let n=t.startMeasureIdx;for(a=e.getMeasureColumn(n);!a.isInDisplayedRange();)n++,a=e.getMeasureColumn(n);return{startMeasureIdx:n,stopMeasureIdx:r}}function Le(e,t){return t=Ge(e,t),t===null?[]:[(0,O.default)(t)]}var V=o(77913),G=o(878639),j=(e,t,s)=>new Promise((r,a)=>{var n=h=>{try{c(s.next(h))}catch(l){a(l)}},d=h=>{try{c(s.throw(h))}catch(l){a(l)}},c=h=>h.done?r(h.value):Promise.resolve(h.value).then(n,d);c((s=s.apply(e,t)).next())});const ze="page",Be="pageIntraMargin",He="pageContent",Ye=5,Xe=5,Ue=7,Oe=0,$e="px",Ve=["trackLeftMargin","trackRightMargin","trackTopMargin","trackBottomMargin"],K=function(e,t,s,r,a,n){this.init(e,t,s,r,a,n)},i=K.prototype;i.getName=function(){return"TrackLayout"},i.init=function(e,t,s,r,a,n){this.displayLockedState=!1,this.queue=n||(0,Re.A)(),a=a||{},this.scoreData=e,this.editionId=this.scoreData.getEditionId();const d=(0,v.A)(e);(0,f.A)(a,e);const c=this.scoreData.getDefaults();(0,P.A)(c,a),this.drawingContext=new m.A(s,r,d,t,a),Ke(a,this.drawingContext),Qe(a),a.displayLayout=I.A.TRACK,this.displayOpts=a,this.initDisplayRange();const h=je(a);this.measureNumberingPolicy=new Pe.A(a.measureNumberingPolicy,a.hasPickup),this.measuresContainer=new Ie.A(h,this.measureNumberingPolicy);const l=new ye,y={measureColumns:this.measuresContainer,measuresSlices:this},w=(0,N.A)(e,a);this.scoreDataCache=new M.A(w,a),this.shardProvider=l.build({scoreDataCache:this.scoreDataCache,containers:y,drawingContext:this.drawingContext,displayOpts:a,displayRangeRef:this.displayRangeRef,measureNumberingPolicy:this.measureNumberingPolicy,startMeasureIdx:h}),this.measureProvider=l.measureProvider,this.sliceProvider=l.sliceProvider,this.systemProvider=l.systemProvider,this.scaling=S.A.DEFAULT,this.scoreShard=null,this.measuresSlice=null,this.pageSvg=null,this.intraMarginGroup=null,this.measuresNumbersPanel=null,this.partsNamesPanel=null},i.setMeasuresSlice=function(e){this.measuresSlice=e};function je(e){let t=0;return b.A.isValid(e.measureNumberingStart)&&(t=e.measureNumberingStart-1),typeof e.firstMeasureIdx=="number"&&(t+=e.firstMeasureIdx),e.hasPickup&&t--,t}i.initDisplayRange=function(){this.displayRangeRef={displayRange:null,measuresRange:null};const e=this.displayOpts.displayRange||null;this.privateSetDisplayRange(e)},i.getNbMeasures=function(){return this.measuresContainer.getNbMeasures()+this.measureProvider.getNbMeasuresInCache()},i.getNbPages=function(){return this.pageSvg===null?0:1},i.getPageSvg=function(){return this.pageSvg};function Ke(e,t){Ve.forEach(s=>{let r=e[s];if(typeof r!="string"||!r.includes($e)||(r=parseInt(r,10),!F.default.isInteger(r)))return;const a=r/t.getSpaceSize();e[s]=a})}const Qe=function(e){typeof e.trackTopMargin!="number"&&(e.trackTopMargin=Ye),typeof e.trackBottomMargin!="number"&&(e.trackBottomMargin=Xe),typeof e.trackLeftMargin!="number"&&(e.trackLeftMargin=Oe),typeof e.trackRightMargin!="number"&&(e.trackRightMargin=Ue)};i.getPageSize=function(){let e=0;this.measuresNumbersPanel&&(e=this.scoreShard.getExternalSystemMeasureGap());const t=this.getSpaceSize();let s=this.displayOpts.trackTopMargin*t;const r=this.displayOpts.trackBottomMargin*t,a=this.displayOpts.trackRightMargin*t;let n=this.displayOpts.trackLeftMargin*t;this.partsNamesPanel&&(n=0,s=0);const d=this.scoreShard.getBBox(),c=this.fakeMeasures.getContentWidth()-this.scoreShard.getContentWidth();return{height:d.height+s+r+e*2,width:d.width+c+a+n,marginTop:s,marginLeft:n,marginRight:a}},i.getSpaceSize=function(){return this.drawingContext.getSpaceSize()},i.hasRemaining=function(){return this.scoreShard===null},i.fillNextPage=function(e,t={}){return this.queue.add(()=>j(this,null,function*(){G.HAS_PERF_API&&performance.mark("adagio.fillNextPage.s"),this.lockDisplay("_trackLayout.fillNextPage");try{yield this._fillNextPage(e,t),this.unlockDisplay(),G.HAS_PERF_API&&(performance.mark("adagio.fillNextPage.e"),performance.measure("adagio.fillNextPage","adagio.fillNextPage.s","adagio.fillNextPage.e"))}catch(s){throw this.unlockDisplay(),G.HAS_PERF_API&&(performance.mark("adagio.fillNextPage.e"),performance.measure("adagio.fillNextPage","adagio.fillNextPage.s","adagio.fillNextPage.e")),s}}))},i.lockDisplay=function(e){if(this.scoreData.lockDataRead(this),this.displayLockedState)throw this.scoreData.unlockDataRead(this),new g.default(`An operation is already ongoing on the score: "${this.displayLockedState}"`);this.displayLockedState=e||!0},i.unlockDisplay=function(){this.scoreData.unlockDataRead(this),this.displayLockedState=!1},i._fillNextPage=function(e,t){return j(this,arguments,function*(s,{partsNamesSvg:r,measuresNumbersSvg:a}){if(this.scoreShard!==null){const w="There is no more page to draw";throw new g.default("Unexpected",w)}s.attr("class",ze);const d=s.append("g").append("g");d.attr("class",Be),d.attr("transform",`scale(${this.scaling})`),this.intraMarginGroup=d;const c=d.append("g");c.attr("class",He),r&&(this.partsNamesPanel=new we,this.partsNamesPanel.setSvg(r),this.partsNamesPanel.setScaling(this.scaling),this.shardProvider.setPartsNamesPanel(this.partsNamesPanel),this.systemProvider.setPartsNamesPanel(this.partsNamesPanel)),a&&(this.measureNumberingPolicy.policyType=p.A.NONE,this.measuresNumbersPanel=new Ee({hasPickup:this.displayOpts.hasPickup,drawingContext:this.drawingContext}),this.measuresNumbersPanel.setSvg(a),this.measuresNumbersPanel.setScaling(this.scaling),this.shardProvider.setMeasuresNumbersPanel(this.measuresNumbersPanel)),this.scoreShard=yield this.shardProvider.getShard();const h=this.getSpaceSize(),l=this.displayOpts.trackTopMargin*h,y=this.displayOpts.trackLeftMargin*h;r?(this.scoreShard.setPosX(0),this.scoreShard.setPosition(0),this.partsNamesPanel.setMarginLeft(y),this.measuresNumbersPanel.setMarginTop(l)):(this.scoreShard.setPosX(y),this.scoreShard.setPosition(l)),this.scoreShard.setParent(c),this.updateMeasuresRange(),this.scoreShard.drawContentRec(),this.measuresNumbersPanel&&this.setEditionMargin(),this.scoreShard.move(),this.fakeMeasures=new Ae({scoreShard:this.scoreShard,measuresContainer:this.measuresContainer,measureProvider:this.measureProvider}),this.fakeMeasures.update(),this.scoreShard.updateBinding(),this.pageSvg=s,this.measuresNumbersPanel&&(this.measuresNumbersPanel.setFakeMeasures(this.fakeMeasures),this.measuresNumbersPanel.update()),this.updateSvgSize()})},i.setEditionMargin=function(){const e=this.scoreShard.getExternalSystemMeasureGap();this.scoreShard.setPosition(e)},i.getMeasuresRange=function(){return this.measuresRange},i.getDisplayRange=function(){return this.displayRange},i.hasDisplayRange=function(){return this.displayRange!==null},i.privateSetDisplayRange=function(e){ee(e),this.displayRange=e,this.displayRangeRef.displayRange=e},i.privateSetMeasuresRange=function(e){this.measuresRange=e,this.displayRangeRef.measuresRange=e},i.updateMeasuresRange=function(){this.displayRange===null?this.measuresRange=null:this.measuresRange=D(this.measuresSlice,this.displayRange)},i.updateDisplayRangeFromMeasureRange=function(){this.displayRange=J(this.measuresContainer,this.measuresRange),this.displayRangeRef.displayRange=this.displayRange,this.displayRangeRef.measuresRange=null},i.getStartMeasureIdx=function(){return this.displayOpts.hasPickup?-1:0},i.bindPage=function(){},i.unbindPage=function(){},i.setScaling=function(e){S.A.assert(e),this.scaling=e,this.partsNamesPanel&&this.partsNamesPanel.setScaling(this.scaling),this.measuresNumbersPanel&&this.measuresNumbersPanel.setScaling(this.scaling),this.intraMarginGroup!==null&&(this.intraMarginGroup.attr("transform",`scale(${this.scaling})`),this.updateSvgSize())},i.getScaling=function(){return this.scaling},i.resetPagesGeometries=function(){this.scoreShard.resetGeometries()},i.getAllPagesGeometries=function(){return this.getLastPageGeometries()},i.getLastPageGeometries=function(){return this.scoreShard.getAllMeasuresGeometries()},i.getPagesStructures=function(){return this.scoreShard===null?[]:[{pageIdx:0,shards:[this.scoreShard.getStructure()]}]},i.uuidGetStaffLyricsUpY=function(e){return e=this.uuidToIdx(e),this.getStaffLyricsUpY(e.staffIdx,e.partIdx,e.measureIdx,e.level)},i.getStaffLyricsUpY=function(e,t,s,r){return this.scoreShard.getStaffLyricsUpY(e,t,s,r)},i.uuidGetStaffWordsY=function(e){return e=this.uuidToIdx(e),this.getStaffWordsY(e.staffIdx,e.partIdx,e.measureIdx,e.placement)},i.getStaffWordsY=function(e,t,s,r){return this.scoreShard.getStaffWordsY(e,t,s,r)},i.uuidGetSystemChordsY=function(e){return e=this.uuidToIdx(e),this.getSystemChordsY(e.partIdx,e.measureIdx)},i.getSystemChordsY=function(e,t){return this.scoreShard.getSystemChordsY(e,t)},i.getSystemClassicHarmonyY=function(e,t){return this.getSystemTopStaffClassicHarmonyY(e,t)},i.uuidGetSystemTopStaffClassicHarmonyY=function(e){return e=this.uuidToIdx(e),this.getSystemTopStaffClassicHarmonyY(e.partIdx,e.measureIdx)},i.getSystemTopStaffClassicHarmonyY=function(e,t){return this.scoreShard.getSystemTopStaffClassicHarmonyY(e,t)},i.uuidGetSystemBottomStaffClassicHarmonyY=function(e){return e=this.uuidToIdx(e),this.getSystemBottomStaffClassicHarmonyY(e.partIdx,e.measureIdx)},i.getSystemBottomStaffClassicHarmonyY=function(e,t){return this.scoreShard.getSystemBottomStaffClassicHarmonyY(e,t)},i.uuidGetSystemBottomStaffFiguredBassY=function(e){return e=this.uuidToIdx(e),this.getSystemBottomStaffFiguredBassY(e.partIdx,e.measureIdx,e.level)},i.getSystemBottomStaffFiguredBassY=function(e,t,s){return this.scoreShard.getSystemBottomStaffFiguredBassY(e,t,s)},i.uuidGetMeasureEnclosingStaffElem=function(e){return e=this.uuidToIdx(e),this.getMeasureEnclosingStaffElem(e.partIdx,e.staffIdx,e.measureIdx)},i.getMeasureEnclosingStaffElem=function(e,t){return this.scoreShard.getStaffElem(e,t)},i.uuidGetMeasureWidth=function(e){return e=this.uuidToIdx(e),this.getMeasureWidth(e.partIdx,e.measureIdx)},i.getMeasureWidth=function(e,t){return this.scoreShard.getMeasureWidth(e,t)},i.uuidGetMeasurePosXInStaff=function(e){return e=this.uuidToIdx(e),this.getMeasurePosXInStaff(e.partIdx,e.measureIdx)},i.uuidGetMeasurePosXInStaff=function(e){return e=this.uuidToIdx(e),this.getMeasurePosXInStaff(e.partIdx,e.measureIdx)},i.getMeasurePosXInStaff=function(e,t){return this.scoreShard.getMeasurePosX(t)},i.uuidGetTimePosXInMeasure=function(e){return e=this.uuidToIdx(e),this.getTimePosXInMeasure(e.partIdx,e.staffIdx,e.measureIdx,e.timePos,e.dpq)},i.getTimePosXInMeasure=function(e,t,s,r,a){return this.scoreShard.getTimePosXInMeasure(e,t,s,r,a)},i.uuidGetNoteXInMeasure=function(e){return e=this.uuidToIdx(e),this.getNoteXInMeasure(e.partIdx,e.staffIdx,e.measureIdx,e.voiceIdx,e.noteIdx)},i.getNoteXInMeasure=function(e,t,s,r,a){return this.scoreShard.getNoteXInMeasure(e,t,s,r,a)},i.uuidGetMeasureNbNotes=function(e){const t=this.uuidToIdx(e);return this.getMeasureNbNotes(t.partIdx,t.staffIdx,t.measureIdx,t.voiceIdx)},i.getMeasureNbNotes=function(e,t,s,r){return this.scoreShard.getMeasureNbNotes(e,t,s,r)},i.uuidGetMeasureFullAttributesGroup=function(e){const t=this.uuidToIdx(e);return this.getMeasureFullAttributesGroup(t.partIdx,t.staffIdx,t.measureIdx,t.voiceIdx)},i.getMeasureFullAttributesGroup=function(e,t,s){return this.scoreShard.getMeasureFullAttributesGroup(e,t,s)},i.uuidGetSystemHeight=function(e){const t=this.uuidToIdx(e);return this.getSystemHeight(t.partIdx,t.measureIdx)},i.getSystemHeight=function(e){return this.scoreShard.getSystemHeight(e)},i.uuidGetStaffInnerHeight=function(e){const t=this.uuidToIdx(e);return this.getStaffInnerHeight(t.partIdx,t.staffIdx,t.measureIdx)},i.getStaffInnerHeight=function(e,t){return this.scoreShard.getStaffInnerHeight(e,t)},i.uuidGetSpaceAboveStaff=function(e){const t=this.uuidToIdx(e);return this.getSpaceAboveStaff(t.partIdx,t.staffIdx,t.measureIdx)},i.getSpaceAboveStaff=function(e,t){return this.scoreShard.getSpaceAboveStaff(e,t)},i.getDrawingContext=function(){return this.drawingContext},i.getLyricsFontSize=function(){return this.drawingContext.getLyricsFontSize()},i.getHarmonyFontSize=function(){return this.drawingContext.getHarmonyFontSize()},i.getWordFontSize=function(){return this.drawingContext.getWordFontSize()},i.toggleMinimalName=function(e){this.scoreShard.toggleMinimalName(e),this.partsNamesPanel&&this.partsNamesPanel.updateSvgSize()},i.isMinimalName=function(){return this.scoreShard.isMinimalName()},i.updateSvgSize=function(){const e=this.getPageSize();this.pageSvg.attr("width",e.width*this.scaling),this.pageSvg.attr("height",e.height*this.scaling),this.partsNamesPanel&&this.partsNamesPanel.updateSvgSize(),this.measuresNumbersPanel&&this.measuresNumbersPanel.updateSvgSize()},i.getScoreShard=function(){return this.scoreShard},i.getMeasuresContainer=function(){return this.measuresContainer},i.getMeasuresSlice=function(){return this.measuresSlice},i.getMeasureProvider=function(){return this.measureProvider},i.drawBasicCursor=function(e,t){this.scoreShard.drawBasicCursor(e,t)},i.drawGraceCursor=function(e,t){this.scoreShard.drawGraceCursor(e,t)},i.drawTabCursor=function(e,t){this.scoreShard.drawTabCursor(e,t)},i.drawDynamicCursor=function(e,t){this.scoreShard.drawDynamicCursor(e,t)},i.drawPizzicatoCursor=function(e,t){this.scoreShard.drawPizzicatoCursor(e,t)},i.drawMuteCursor=function(e,t){this.scoreShard.drawMuteCursor(e,t)},i.drawHorizontalCursor=function(e,t){this.scoreShard.drawHorizontalCursor(e,t)},i.drawHorizontalCursorTimePos=function(e,t){e=(0,V.A)(this,e),e!==null&&this.scoreShard.drawHorizontalCursorTimePos(e,t)},i.drawHorizontalMeasureWideCursor=function(e,t){this.scoreShard.drawHorizontalMeasureWideCursor(e,t)},i.drawCrossMeasureNoteCursor=function(e,t){e=(0,V.A)(this,e),e!==null&&this.scoreShard.drawCrossMeasureNoteCursor(e,t)},i.setNoteColor=function(e,t){e.staffIdx=this.scoreData.getPartVoiceMainStaffIdx(e.systemIdx,e.voiceIdx),this.scoreShard.setNoteColor(e,t)},i.getScoreData=function(){return this.scoreData},i.getScoreDataCache=function(){return this.scoreDataCache},i.uuidGetMeasurePosXInStaff=function(e){return e=this.uuidToIdx(e),this.getMeasurePosXInStaff(e.partIdx,e.measureIdx)},i.getMeasurePosX=function(e){return this.scoreShard.getMeasurePosX(e)},i.uuidGetMeasureElem=function(e){const t=this.uuidToIdx(e);return this.scoreShard.getMeasureElem(t.partIdx,t.staffIdx,t.measureIdx)},i.uuidGetMeasureEventRect=function(e){const t=this.uuidToIdx(e);return this.scoreShard.getMeasureEventRect(t.partIdx,t.staffIdx,t.measureIdx)},i.getMeasureElemFromDataIdx=function(e,t,s){const r=this.scoreDataCache.dataToDisplayedPartIdx(e);return this.scoreShard.getMeasureElem(r,t,s)},i.uuidGetPartBottomMeasureElem=function(e){const t=this.uuidToIdx(e);return this.scoreShard.getPartBottomMeasureElem(t.partIdx,t.measureIdx)},i.getMeasureElem=function(e,t,s){return this.scoreShard.getMeasureElem(e,t,s)},i.splitMeasuresRangeBySlices=function(e){return Le(this.measuresContainer,e)},i.uuidGetMeasurePageSvgParent=function(e){return this.uuidToIdx(e),this.pageSvg},i.isAnySystemMeasureRendered=function(e){return this.measuresContainer.hasMeasureIdx(e)?this.measuresContainer.getMeasureColumn(e).getTopSystem().every(r=>r.currentParent!==null):!1},i.uuidIsMeasureRendered=function(e){const t=this.uuidToIdx(e);return this.measuresContainer.hasMeasureIdx(t.measureIdx)?this.measuresContainer.getMeasureColumn(t.measureIdx).getSystemMeasure(t.partIdx).every(a=>a.currentParent!==null):!1},i.uuidGetFirstShardForMeasure=function(e){return this.uuidToIdx(e),this.scoreShard},i.uuidToIdx=function(e){e=(0,O.default)(e);const t=this.getScoreData();if((0,xe.default)(t,e),(0,Ne.default)(t,e),(0,Ce.default)(t,e),(0,ve.default)(t,e),typeof e.partIdx!="undefined"){const s=this.getScoreDataCache();e.partIdx=s.dataToDisplayedPartIdx(e.partIdx)}return e},i.isSyncWithData=function(){return this.editionId===this.scoreData.getEditionId()},i.stateSyncWithData=function(){this.editionId=this.scoreData.getEditionId()};const Je=K}}]);})();


//# debugId=7a912d1e-c01d-599c-be6e-521e032ab8fb

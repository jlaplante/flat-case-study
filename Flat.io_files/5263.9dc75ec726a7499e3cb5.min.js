"use strict";
!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="55924b57-f93a-5856-b70b-02e6b74b2275")}catch(e){}}();
(()=>{/*! Copyright (c) 2025 Tutteo Ltd. */(self.webpackChunk_flat_flat=self.webpackChunk_flat_flat||[]).push([[5263],{334931:(R,C,n)=>{n.d(C,{A:()=>Lt});var T=n(842746),I=n(269352),p=n(832560),U=n(898439),y=n(891921),S=n(35802),b=n(414787),c=n(701387),m=n(446921),N=n(351277),M=n(104907),G=n(292681),W=n(210888),B=n(353922),E=n(972375),_=n(230373),tt=n(179397),et=n(73705),Ft=n(595562),it=n(937718),st=n(763939),ot=n(645369),F=n.n(ot),Y=n(257053),P=n(121648),nt=n(883892),O=n(909696);const rt="M0 10c0 3.3 2.7 6 6 6s6-2.7 6-6S6 0,6 0S0 6.7 0 10z",at="tear-drop";class dt{constructor(t){this.svgTools=t,this.polygone=new I.A("path"),this.polygone.attr("d",rt),this.polygone.attr("class",at)}bind(t){const e=this.polygone.node();e!==t.firstChild&&t.insertBefore(e,t.firstChild),this.svgParentNode=t}remove(){this.polygone.node().parentNode&&this.polygone.removeFromParent()}setColor(t){this.polygone.node().style.fill=t}updatePosition(t,e,s){const i=this.svgParentNode.createSVGTransformFromMatrix(t.getCTM());i.matrix.a=this.svgTools.scaling,i.matrix.d=this.svgTools.scaling,i.matrix.f+=this.getYMargin(t,e,s),i.matrix.e-=this.svgTools.spaceLine/3,this.polygone.node().transform.baseVal.initialize(i)}getGroupElem(){return this.polygone.elem}getYMargin(t,e,s){const i=this.svgTools.extractChild(e.staff,"staffLines",0),o=i.getElementsByTagName("line").length,r=this.svgTools.getCoord(i);let u;return s?u=this.svgTools.tabLine:u=this.svgTools.spaceLine,Math.max(this.svgTools.getCoord(t).y+this.polygone.getBBox().height*this.svgTools.scaling,r.y+u*o)-this.svgTools.getCoord(t).y}}var $=n(920939);const Q=.3,lt=1.2*Q;class ht{constructor(t){this.svgTools=t,this.group=new I.A("g"),this.topArrowGlyph=this.svgTools.drawingContext.getGlyph("arrowheadBlackDown"),this.bottomArrowGlyph=this.svgTools.drawingContext.getGlyph("arrowheadBlackUp"),this.line=this.group.append("line"),this.line.attr("x1",0),this.line.attr("x2",0);const e=this.svgTools.drawingContext.getSpaceSize()*Q;this.line.attr("stroke-width",e),this.topPath=this.group.append("path"),this.topPath.attr("d",this.topArrowGlyph.render()),this.bottomPath=this.group.append("path"),this.bottomPath.attr("d",this.bottomArrowGlyph.render())}bind(t){const e=this.group.node();e!==t.firstChild&&t.insertBefore(e,t.firstChild),this.svgParentNode=t}remove(){this.group.node().parentNode&&this.group.removeFromParent()}setColor(t){this.group.node().style.fill=t,this.line.node().style.stroke=t}updatePosition(t,e,s){const i=this.svgTools.extractChild(e.staff,"staffLines",0),o=i.getElementsByTagName("line").length;let r;s?r=this.svgTools.drawingContext.getTabSpaceSize():r=this.svgTools.drawingContext.getSpaceSize();const u=$.A.lineToY(o+1,r,o),h=$.A.lineToY(0,r,o);this.line.attr("y1",u),this.line.attr("y2",h);const v=lt*this.svgTools.drawingContext.getSpaceSize();this.topPath.attr("transform",`translate(${-this.topArrowGlyph.getWidth()/2}, ${u+v})`),this.bottomPath.attr("transform",`translate(${-this.bottomArrowGlyph.getWidth()/2}, ${h+this.bottomArrowGlyph.getHeight()-v})`);const f=this.svgParentNode.createSVGTransformFromMatrix(t.getCTM());f.matrix.e-=this.svgTools.drawingContext.getSpaceSize();const g=this.svgParentNode.createSVGTransformFromMatrix(i.getCTM());f.matrix.f=g.matrix.f,this.group.node().transform.baseVal.initialize(f)}getGroupElem(){return this.group.elem}}var J=n(737903),ut=n(259563),ct=n(942617),ft=n(615542),gt=n(700106),pt=n(727137),mt=n(742735),xt=n(476943);function X(l,t){const e=l.uuidGetMeasure(t.partUuid,t.measureUuid),s=new p.A(e),i=l.uuidGetPartVoiceIdx(t.partUuid,t.voiceUuid);let r=s.getVoice(i).getChord(t.noteIdx);return r=xt.default.makeArray(r),r}function It(l,t,e){const s=l.uuidIsPartUnpitched(t.partUuid),i=X(l,t),o=X(l,e);return mt.A.getMatchingNotes(i,o,s).length>0}var vt=n(684188),Pt=Object.defineProperty,Ut=(l,t,e)=>t in l?Pt(l,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[t]=e,A=(l,t,e)=>Ut(l,typeof t!="symbol"?t+"":t,e);const yt=F()("flat:cursorcontext");class St{constructor(t){A(this,"cursor"),A(this,"scoreData"),A(this,"rangeSelect"),A(this,"context"),A(this,"rightNotePos"),A(this,"rightNoteData"),A(this,"hasCommonPitchesVal"),this.init(t)}init(t){this.cursor=t.cursor,this.scoreData=t.scoreData,this.rangeSelect=t.rangeSelect,this.context=null}reset(){this.context=null}getContext(){return this.context===null&&this.calcContext(),this.context}get adagioData(){return this.scoreData.adagioData}calcContext(){if(this.context={},!this.adagioData||!this.cursor.noteInfo)return this.context;const t=this.cursor.noteInfo,e=this.cursor.getPositionUuid(),{scoreActions:s}=this.scoreData;return t?(this.rightNotePos=null,this.rightNoteData=null,this.hasCommonPitchesVal=null,this.context.isRest=!!t.isRest,this.context.isGrace=!!t.isGrace,this.context.hasGraceSlur=!!t.hasGraceSlur,this.context.hasGrace=t.nbGraces>0,this.context.isUnpitchedPart=this.adagioData.uuidIsPartUnpitched(e.partUuid),this.context.isPitchedPart=!this.context.isUnpitchedPart,this.context.isPitched=!!t.pitches&&this.getIdxInChord(e,t)>=0,this.context.isChord=t.pitches&&t.pitches.length>=2||!1,this.context.isTab=this.cursor.staffMode==="tab",this.context.hasTab=this.adagioData.uuidIsPartTab(e.partUuid),this.context.hasTabFrame=this.adagioData.uuidHasPartTabFrame(e.partUuid),this.context.isEndOfScore=this.isLastNoteOfScore(e),this.context.isSameLineThanNextNote=this.calcIsSameLineThanNextNote(),this.context.hasSlashInConnection=this.hasSlashInConnection(),this.context.canTieWithNextNote=this.calcCanTieWithNextNote(),this.context.hasActionsToUndo=s==null?void 0:s.canUndo(),this.context.hasActionsToRedo=s==null?void 0:s.canRedo(),this.context.canSwitchEnharmonic=this.canSwitchEnharmonic(),this.context.isNextRest=this.isNextRest(e),this.context.hasTie=!!t.isTied,this.context.isHeadTied=this.isSelectedNoteTied(t),this.context.canTremoloWithNextNote=this.canTremoloWithNextNote(e,t),this.context.isMeasureRepeat=this.isSelectedMeasureRepeat(e),this.context.isMultiMeasureRest=this.isSelectedMultiMeasureRest(e),this.context.hasRangeSelection=this.rangeSelect.hasRange()):yt("noteData not set"),(0,pt.x)().update(this.context),this.context}isLastNoteOfScore(t){return(0,ft.A)(this.adagioData,t)&&(0,gt.A)(this.adagioData,t)}getIdxInChord(t,e){if(typeof t.string!="undefined"&&e.tabsData)return(e.tabsData||[]).findIndex(s=>s&&s.string===t.string);if(typeof t.line!="undefined"){const s=e.lines;return s?s.indexOf(t.line):-1}return-1}canSwitchEnharmonic(){if(this.getContext().isRest)return!1;const t=this.cursor.getPositionUuid(),{noteInfo:e}=this.cursor;if(!(e!=null&&e.canTryEnharmonicSwitch)||!e.canTryEnharmonicSwitch.length)return!1;if(typeof t.line=="number"){const s=this.cursor.getNoteIdxInChordFromLine(t.line);return e.canTryEnharmonicSwitch[s]}if(typeof t.string=="number"){const s=this.cursor.getNoteIdxInChordFromString(t.string);return s===null?!1:e.canTryEnharmonicSwitch[s]}return!1}calcIsSameLineThanNextNote(){const t=this.getContext();if(t.isRest)return!1;const e=this.cursor.getPositionUuid();if(t.isEndOfScore)return!1;const s=this.getRightNotePos();if(e.voiceUuid!==s.voiceUuid)return!1;const i=this.getRightNoteData();return i.nbGraces>0||i.isRest?!1:this.hasCommonPitches()}calcCanTieWithNextNote(){const t=this.getContext();if(t.isRest||t.hasSlashInConnection)return!1;const e=this.cursor.getPositionUuid();if(t.isEndOfScore)return!0;const s=this.getRightNotePos();if(e.voiceUuid!==s.voiceUuid)return!0;const i=this.getRightNoteData();return i.nbGraces>0?!1:i.isRest?!0:this.hasCommonPitches()}hasSlashInConnection(){var t;let e=this.cursor.measureInfo.slash;if(e!==null)return!0;if((t=this.context)!=null&&t.isEndOfScore)return!1;const s=this.getRightNotePos();return e=this.adagioData.getStaffMeasure((0,J.default)(s)).slash,e!==null}isSelectedNoteTied(t){const e=this.getContext();if(e.isRest||e.isGrace)return!1;const s=(0,vt.J)(this.cursor);if(s<0)return!1;const i=t.ties;return i?i[s]:!1}isNextRest(t){if(this.getContext().isEndOfScore)return!1;const e=this.getRightNotePos();return t.voiceUuid!==e.voiceUuid?!0:this.getRightNoteData().isRest}canTremoloWithNextNote(t,e){const s=this.getContext();if(s.isRest||s.isEndOfScore||e.durationType===ut.default.FULL)return!1;const i=this.getRightNotePos();if(t.measureUuid!==i.measureUuid)return!1;const o=this.getRightNoteData();return!(o.isRest||e.durationType!==o.durationType||e.nbDots!==o.nbDots||e.tupletType!==o.tupletType)}isSelectedMeasureRepeat(t){const{measureRepeat:e}=this.adagioData.getStaffMeasure(t);return!!e}isSelectedMultiMeasureRest(t){return!!this.adagioData.getCommonContent().hasMultiMeasureRest(t.measureIdx)}hasCommonPitches(){if(this.hasCommonPitchesVal===null){const t=this.cursor.getPositionUuid(),e=this.getRightNotePos();this.hasCommonPitchesVal=It(this.adagioData,t,e)}return this.hasCommonPitchesVal}getRightNoteData(){if(!this.rightNoteData){let t=this.getRightNotePos();t=(0,J.default)(t),this.rightNoteData=this.adagioData.getNoteData(t)}return this.rightNoteData}getRightNotePos(){if(!this.rightNotePos){const t=this.cursor.getPositionUuid();this.rightNotePos=(0,ct.A)(this.adagioData,t)}return this.rightNotePos}}var V=n(349860),z=n(602494),Dt=Object.defineProperty,Tt=Object.defineProperties,Ct=Object.getOwnPropertyDescriptors,Z=Object.getOwnPropertySymbols,bt=Object.prototype.hasOwnProperty,Nt=Object.prototype.propertyIsEnumerable,H=(l,t,e)=>t in l?Dt(l,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):l[t]=e,K=(l,t)=>{for(var e in t||(t={}))bt.call(t,e)&&H(l,e,t[e]);if(Z)for(var e of Z(t))Nt.call(t,e)&&H(l,e,t[e]);return l},j=(l,t)=>Tt(l,Ct(t)),a=(l,t,e)=>H(l,typeof t!="symbol"?t+"":t,e),Et=(l,t,e)=>new Promise((s,i)=>{var o=h=>{try{u(e.next(h))}catch(v){i(v)}},r=h=>{try{u(e.throw(h))}catch(v){i(v)}},u=h=>h.done?s(h.value):Promise.resolve(h.value).then(o,r);u((e=e.apply(l,t)).next())});const x=F()("flat:cursor"),At=F()("flat:deprecated"),w=l=>JSON.parse(JSON.stringify(l)),wt=30*1e3,Mt=60;class Lt{constructor(t){a(this,"adagioCursor"),a(this,"hidden"),a(this,"focus"),a(this,"canScroll"),a(this,"cursorDrawer"),a(this,"interaction"),a(this,"svg"),a(this,"svgTools"),a(this,"collaborators"),a(this,"config"),a(this,"context"),a(this,"pageLayout"),a(this,"scoreDrawer"),a(this,"color"),a(this,"colorsVoices"),a(this,"mapping"),a(this,"selectedElem"),a(this,"selectedEntity",null),a(this,"lastNoteAdded"),a(this,"id"),a(this,"size"),a(this,"scale"),a(this,"counterChangeFocus"),a(this,"note"),a(this,"noteInfo"),a(this,"noteInfoById"),a(this,"measureInfo"),a(this,"upcomingAttributes"),a(this,"staffStyle"),a(this,"staffMode"),a(this,"hasTabStaff"),a(this,"pos"),a(this,"leftPos"),a(this,"leftPosSlash"),a(this,"verticalScrollableElement"),a(this,"horizontalScrollableElement"),a(this,"sendPositionLoopIntervalID"),a(this,"promiseQueue"),this.adagioCursor=new E.A,this.init(t)}init({id:t,svg:e,verticalScrollableElement:s,horizontalScrollableElement:i,interaction:o,collaborators:r,config:u,keepPosition:h=!1}){this.hidden=!1,this.cursorDrawer=null,this.focus=!1,this.canScroll=!1,this.size=0,this.svg=e,this.verticalScrollableElement=s,this.horizontalScrollableElement=i,this.interaction=o,this.svgTools=o.svgTools,this.collaborators=r,this.config=u,h?this.bumpFocus():(this.pos={},this.note={},this.noteInfo=null,this.noteInfoById={}),this.selectedElem=null,(0,P.W)().unselect(),this.counterChangeFocus=0,this.leftPos=null,this.leftPosSlash=null,this.promiseQueue=null,t&&(this.id=t),this.id||(x("id not set"),this.id="unknown"),this.context=new St({cursor:this,rangeSelect:o.rangeSelect,scoreData:o.scoreData}),this.upcomingAttributes={},this.interaction.data&&!h&&this.resetPos(),this.colorsVoices=[o.colorVoice0||"var(--f-score-voice-0)",o.colorVoice1||"var(--f-score-voice-1)"],this.sendPositionLoopIntervalID=null,this.loopSendPosition()}resetPos(){x("reset pos"),this.changeFocus({measureIdx:0,partIdx:0,staffIdx:0,voiceIdxInStaff:0,noteIdx:0}),this.leftPos=null,this.leftPosSlash=null,this.updateMapping()}updateMapping(t){t||(t=this.pos[this.id]),t!=null&&t.partUuid&&(this.mapping=this.interaction.data.uuidGetPartStaffVoices(t.partUuid,t.staffUuid))}getColorVoiceUuid(t){const e=this.interaction.data.uuidGetPartStaffVoices(t.partUuid,t.staffUuid);return this.colorsVoices[e.indexOf(t.voiceUuid)]}setPromiseQueue(t){this.promiseQueue=t}samePos(t){const e=this.pos[this.id];return t.noteIdx===e.noteIdx&&t.partUuid===e.partUuid&&t.staffUuid===e.staffUuid&&t.measureUuid===e.measureUuid&&t.voiceUuid===e.voiceUuid&&t.graceIdx===e.graceIdx}isLeftPosSlash(){return this.leftPosSlash}samePosLeft(t){const e=this.leftPos;return e===null?!1:t.noteIdx===e.noteIdx&&t.partUuid===e.partUuid&&t.staffUuid===e.staffUuid&&t.measureUuid===e.measureUuid&&t.voiceUuid===e.voiceUuid&&t.graceIdx===e.graceIdx}isInit(){return!!this.svg}setSize(){this.size=(0,O.q6)().zoom,this.scale=this.svgTools.scaling}setPageLayout(t){this.pageLayout=t}setScoreDrawer(t){this.scoreDrawer=t}setCollaborators(t){this.collaborators=t}refresh(){const t=Object.keys(this.note);x("refresh"),t.forEach(e=>{this.undraw(e),this.draw(e)})}cleanup(){this.cursorDrawer!==null&&(this.removeCursorDrawer(),this.cursorDrawer=null),x("cleanup")}getPositionIdx(){const t=this.getFullPosition();return{line:t.line,string:t.string,graceIdx:t.graceIdx,noteIdx:t.noteIdx,measureIdx:t.measureIdx,partIdx:t.partIdx,staffIdx:t.staffIdx,voiceIdxInStaff:t.voiceIdxInStaff}}getPosition(){return At(new Error("[Review/Next] Using Cursor.getPosition(). If you still want to use the idx method, please migrate to getPositionIdx")),this.getPositionIdx()}getPositionUuid(){const t=this.getFullPosition();return{line:t.line,string:t.string,graceIdx:t.graceIdx,noteIdx:t.noteIdx,measureUuid:t.measureUuid,partUuid:t.partUuid,staffUuid:t.staffUuid,voiceUuid:t.voiceUuid}}getPositionUuidForUser(t){const e=this.pos[t];return e?{line:e.line,string:e.string,graceIdx:e.graceIdx,noteIdx:e.noteIdx,measureUuid:e.measureUuid,partUuid:e.partUuid,staffUuid:e.staffUuid,voiceUuid:e.voiceUuid}:(this.interaction.logError(new Error("[bugsquad] Position for id not defined"),{logger:"bugsquad",extra:{id:t,cursors:this.pos}}),null)}getContextPositionUuid(){return this.selectedElem?w(this.selectedElem.pos):this.getPositionUuid()}getFullPosition(t){typeof t=="undefined"&&(t=this.id);let e=this.pos[t];return e||(this.resetPos(),e=this.pos[t]),w(e)}fixPartUuidDisplayed(t){let e;const{data:s}=this.interaction;typeof t.partUuid!="undefined"?e=t.partUuid:e=s.getPartUuid(t.partIdx);const i=(0,O.q6)().listPartsDisplayed;for(let o=0;o<i.length;o++)if(i[o].uuid===e)return x("part %s displayed, using partUuid",e),e;return x("part %s not displayed, using part 0",e),t.staffUuid=void 0,t.staffIdx=0,t.voiceUuid=void 0,t.voiceIdxInStaff=0,i[0].uuid}getNote(){return this.note[this.id]||this.findNote(this.id),this.note[this.id]?(this.svgTools.isStillInDom(this.note[this.id].note)||this.refresh(),this.note[this.id]):null}findNote(t){if(!this.pos[t])return;const e=this.getPositionUuidForUser(t);e&&(e.staffMode=e.string!==void 0?"tab":"regular",this.note[t]=this.svgTools.getNote(e,{mayBeNotDrawn:!0}))}isOnTab(){return this.svgTools.isTab(this.note[this.id].staff)}removeCursorDrawer(){this.cursorDrawer&&this.cursorDrawer.remove()}bindCursorDrawer(t){const e=this.svg[t].node();this.cursorDrawer.bind(e)}loadCursor(){this.setSize(),this.cursorDrawer!==null&&this.removeCursorDrawer(),this.createCursorDrawer(),this.pos[this.id]||this.resetPos(),x("loaded")}draw(t){if(!t||t==="undefined"){this.interaction.logError(new Error("[bugsquad] Position for id not defined in draw"),{logger:"bugsquad",extra:{cursors:this.pos}});return}(!this.scale||this.scale<0)&&this.setSize(),this.findNote(t);const e=this.note[t];if(!e||!e.note){this.removeCursorDrawer();return}if(t===this.id&&this.cursorDrawer!==null){let s;this.bindCursorDrawer(e.pageIdx);const i=this.svgTools.getNbOccurs(e.note,"head");i>0?s=this.svgTools.extractChild(e.note,"head",i-1):s=e.note;const o=typeof this.pos[this.id].string!="undefined";this.cursorDrawer.updatePosition(s,e,o),this.color=this.colorsVoices[this.mapping.indexOf(this.svgTools.getVoiceUuidFromHead(s))]||"#000",this.cursorDrawer.setColor(this.color),(0,O.q6)().cursorDrawDone()}this.highlightNote(t)}highlightNote(t){var e;const s=this.pos[t],i=this.note[t];if(!s||!i)return;let o,r,u=!1,h=!1;if(this.id===t?(s.string!==void 0?this.highlightTabHead():s.line!==void 0&&(i.head=this.svgTools.getHeadAtLine(i.note,s.line)),o=this.color,this.needLineStroke(i.note)?(r=i.note,u=!0):i.head?r=i.head:r=i.note,(e=this.noteInfo)!=null&&e.isRest&&this.measureInfo.measureVoicesData.length>1&&(h=!0)):this.id!==t&&(o=this.collaborators.getUserColor(t),r=i.note),(0,V.rK)(r,o),h){const v=this.svgTools.findParent(i.voice,"tickableContent"),f=this.svgTools.findParent(i.voice,"voice");let g=this.svgTools.extractChild(v,"highlightUse",0);g||(g=document.createElementNS("http://www.w3.org/2000/svg","use"),g.setAttribute("class","highlightUse"),v.appendChild(g));const D=`highlighted-${W.default.generate()}`;f.setAttribute("id",D),g.setAttribute("href",`#${D}`)}u&&(0,V.b9)(r,o)}highlightTabHead(){var t;let e=this.svgTools.getHeadAtLine(this.note[this.id].note,this.pos[this.id].string);if(e===null||e.getBBox().width===0){const s=new I.A("rect"),o=(((((t=this.pos[this.id])==null?void 0:t.string)||0)-1)*this.svgTools.tabLine-this.svgTools.tabLine/2)/this.svgTools.scaling;s.attr("width",this.svgTools.tabLine/this.svgTools.scaling).attr("height",this.svgTools.tabLine/this.svgTools.scaling).attr("class","rect-cursor").attr("transform",`translate(0, ${o})`).attr("rx",3).style("mix-blend-mode","darken"),e=this.note[this.id].note.appendChild(s.node()),s.style("fill",this.color)}this.note[this.id].head=e}undraw(t){var e,s;const i=(e=this.note[t])==null?void 0:e.note;if(!i)return;i.style.fill="black",i.style.opacity=1,this.needLineStroke(i)&&(0,V.$2)(i);let o=(s=this.note[t])==null?void 0:s.head;if(o)if(o.classList.contains("rect-cursor"))i.removeChild(o),delete this.note[t].head;else{(0,V.qj)(o);const r=o.getAttribute("data-adagio-note-opacity");r?o.style.opacity=r:o.style.opacity=1,o=null}}needLineStroke(t){return t.classList.length===2&&t.classList[1]==="multiMeasureRest"}addGuys(t){t!==this.id&&(this.pos[t]={measureIdx:0,partIdx:0,staffIdx:0,voiceIdxInStaff:0,noteIdx:0})}delGuys(t){this.pos[t]!==void 0&&this.note[t]!==void 0&&t!==this.id&&(this.undraw(t),delete this.pos[t],delete this.note[t])}bumpFocus(){this.changeFocus(this.getPositionIdx())}changeFocus(t,e){if(this.setSelectedEntity(null),this.showCursor(),t=Object.assign({},t),t.partIdx===null&&t.partUuid===null)return this.getFullPosition();Y.M&&performance.mark("cursor.changeFocus.s"),this.counterChangeFocus++,e=e||{};const s=e.id||this.id;this.pos[s]=this.pos[s]||{};const i=this.pos[s],{data:o}=this.interaction;x("change(id=%s): %o",s,t),s===this.id&&this.config.get().editionMode===z.i&&delete t.graceIdx;let r=t.measureUuid;if(r===void 0&&typeof t.measureIdx!="undefined"){const d=o.getNbMeasures();t.measureIdx>=d?t.measureIdx=d-1:t.measureIdx<0&&(t.measureIdx=0),r=o.getMeasureUuid(t.measureIdx||0)}if(i.measureUuid=r,o.hasMeasureUuid(i.measureUuid)?i.measureIdx=o.getMeasureIdxFromUuid(i.measureUuid):(x("(id=%s) measure uuid %s doesnt exist, fallback to measure 0",s,i.measureUuid),i.measureIdx=0,i.measureUuid=o.getMeasureUuid(0)),i.partUuid=t.partUuid,i.partUuid===void 0){const d=o.getNbParts();t.partIdx!==void 0&&(t.partIdx>=d?t.partIdx=d-1:t.partIdx<0&&(t.partIdx=0)),i.partUuid=o.getPartUuid(t.partIdx||0)}i.partUuid=this.fixPartUuidDisplayed(t),i.partIdx=o.getPartIdxFromUuid(i.partUuid);let u=t.staffUuid;if(u===void 0){const d=o.getPartNbStaves(i.partIdx);t.staffIdx!==void 0&&t.staffIdx>=d&&(t.staffIdx=d-1),u=o.getPartStaffUuid(i.partIdx,t.staffIdx||0)}if(i.staffUuid=u,i.staffIdx=o.getPartStaffIdxFromUuid(i.partIdx,i.staffUuid),this.updateMapping(i),t.voiceUuid!==void 0&&o.hasPartVoiceUuid(i.partIdx,t.voiceUuid))i.voiceUuid=t.voiceUuid;else if(t.voiceIdxInStaff!==void 0&&o.hasPartStaffVoiceAtIdx(i.partIdx,i.staffIdx,t.voiceIdxInStaff)){const d=o.getPartStaffVoiceAtIdx(i.partIdx,i.staffIdx,t.voiceIdxInStaff);i.voiceUuid=o.getPartVoiceUuid(i.partIdx,d)}else{const d=o.getPartStaffMainVoiceIdx(i.partIdx,i.staffIdx);i.voiceUuid=o.getPartVoiceUuid(i.partIdx,d)}const h=o.getPartMeasureStaffVoicesIndexes({partUuid:i.partUuid,measureUuid:i.measureUuid,staffUuid:i.staffUuid});if(!h.includes(i.voiceUuid)){const d=h[0];x("warn: voice %s is not at part %s measure %s => using voice %s instead",i.voiceUuid,i.partUuid,i.measureUuid,d),i.voiceUuid=d}i.voiceIdxInStaff=this.mapping.indexOf(i.voiceUuid);const f=this.interaction.data.uuidGetMeasure(i.partUuid,i.measureUuid),g=new p.A(f),D=o.getPartVoiceIdxFromUuid(i.partIdx,i.voiceUuid),L=g.getVoice(D);if(typeof t.dpq!="undefined"&&typeof t.timePos!="undefined"){const d=g.getDpqValue(),q=t.dpq/d,Rt=c.default.getNbDivisions(g.getMeasure());t.timePos===Rt*q?i.noteIdx=L.getNbNotes()-1:i.noteIdx=(0,y.A)(L,q,t.timePos)}else{const d=(0,tt.A)(o,w(i));i.noteIdx=t.noteIdx,typeof i.noteIdx!="number"||!Number.isInteger(i.noteIdx)||i.noteIdx<0?i.noteIdx=0:i.noteIdx>=d&&(i.noteIdx=d-1),i.graceIdx=t.graceIdx}i.timePos=(0,U.A)(L,i.noteIdx),i.dpq=g.getDpqValue(),typeof t.line!="undefined"?(i.line=t.line,delete i.string):delete i.line,typeof t.string!="undefined"?(i.string=t.string,delete i.line):delete i.string;const k=this.getNoteInfo({noStoreUpdate:!0,id:s});if(typeof i.graceIdx=="number"){const{nbGraces:d}=k;d===0?delete i.graceIdx:i.graceIdx>=d&&(i.graceIdx=d-1)}if(this.validateLine(s),s===this.id){this.getUnpitchedPitch(),this.interaction.data&&(this.staffStyle=this.interaction.data.isPartUnpitched(i.partIdx)?"unpitched":"pitched",this.hasTabStaff=this.interaction.data.isPartTab(i.partIdx)),this.staffMode=i.string!==void 0?"tab":"regular";const d=(0,P.W)();d.setStaffMode(this.staffMode),this.staffStyle&&d.setStaffStyle(this.staffStyle),d.setHasTabStaff(!!this.hasTabStaff),d.setPos(i),d.setNoteInfo(k),d.setMeasureInfo(this.measureInfo),this.context&&this.context.calcContext()}if(e.async||(this.undraw(s),this.draw(s)),s===this.id&&window.requestAnimationFrame(this.sendPosition.bind(this)),Y.M&&(performance.mark("cursor.changeFocus.e"),performance.measure("cursor.changeFocus","cursor.changeFocus.s","cursor.changeFocus.e")),this.interaction.data){this.leftPos=(0,et.A)(this.interaction.data,Object.assign(this.getFullPosition()));const d=this.interaction.data.getStaffMeasure(w(this.leftPos));this.leftPosSlash=d.slash!==null}return this.getFullPosition()}getNoteAtLine(t){return this.getNoteIdxInChordFromLine(t)}getNoteIdxInChordFromLine(t){var e;if((e=this.noteInfo)!=null&&e.lines&&!this.noteInfo.isRest&&typeof t!="undefined"){const s=this.noteInfo.lines.indexOf(t);if(s>=0)return s}return null}getNoteIdxInChordFromString(t){var e;if((e=this.noteInfo)!=null&&e.tabsData&&!this.noteInfo.isRest&&typeof t!="undefined"){const s=this.noteInfo.tabsData.findIndex(i=>i!==null&&i.string===t);if(s>=0)return s}return null}validateLine(t){const e=this.pos[t],s=this.getNoteInfoAtId(t),i=this.interaction.data;if(!s){x("validateLine: noteInfo not set");return}if(typeof e.string!="undefined"&&i){const o=i.getPartContent(e.partIdx),r=m.A.getMeasure(o,0),u=c.default.getAttributes(r),h=S.default.getStaffDetails(u)[0];h["staff-tuning"]?typeof e.string=="number"&&(e.string<1||e.string>h["staff-lines"])&&(x("bad string, reset"),e.string=1):(x("not a tab, put on regular staff"),delete e.string,s.lines&&(e.line=s.lines[0]))}else typeof e.line!="undefined"?s.isRest?delete e.line:s.lines&&(e.line===null||this.getNoteAtLine(e.line)===null)&&(e.line=s.lines[0]):s.lines&&(e.line=s.lines[0])}getNoteInfoAtId(t){return t===this.id?this.noteInfo:this.noteInfoById[t]||null}getStaffLines(t){const{data:e}=this.interaction,i=c.default.getWrappedStaffDetails(e.getMeasure(t.partIdx,t.measureIdx)).getEntry(t.staffIdx);return M.default.getNbStaffLines(i)}get isConcertPitch(){return this.config.get().isConcertPitch}get editionMode(){return this.config.get().editionMode}getNoteInfo({noStoreUpdate:t=!1,id:e}={}){typeof e=="undefined"&&(e=this.id);const s=this.getFullPosition(e),{data:i}=this.interaction;s.isConcertPitch=this.config.get().isConcertPitch;let o=i.getNoteData(s);if(typeof s.graceIdx=="number"&&s.graceIdx>=0&&o.nbGraces>0&&s.graceIdx<o.nbGraces&&(o=i.getGraceData(s)),e===this.id){const r=i.getCommonContent(),u=w(i.getStaffMeasure(s));if(u.ending=w(r.getEnding(s.measureIdx)||[]),u.swing=w(r.getSwing(s.measureIdx)||{}),this.noteInfo=o,this.measureInfo=u,!t){this.getUnpitchedPitch();const h=(0,P.W)();h.setNoteInfo(o),h.setMeasureInfo(u)}!o.isRest&&this.upcomingAttributes.unpitchedHead&&this.config.get().editionMode!==z.i&&this.setUpcomingAttribute("unpitchedHead",null)}else this.noteInfoById[e]=o;return o}getUnpitchedPitch(){if(!this.noteInfo)return;const t=this.getFullPosition(),{data:e}=this.interaction;if(e.isPartUnpitched(t.partIdx)&&(this.measureInfo.unpitchedStaffLines=this.getStaffLines(t),typeof t.line=="number")){const s=b.A.lineToPitch(t.line,this.measureInfo.unpitchedStaffLines);this.noteInfo.unpitchedPitch=G.default.stringify(s)}}setLastNoteAdded(t){this.lastNoteAdded=t,t||delete this.lastNoteAdded,x("set last note: %o / %o",t,this.lastNoteAdded)}getLastNoteAdded(){if(!this.lastNoteAdded)return null;const{data:t}=this.interaction,e=Object.assign({},this.lastNoteAdded),s=t.uuidGetMeasure(e.partUuid,e.measureUuid),i=new p.A(s);if(e.pitch){const o=Object.assign({},e);o.partIdx=t.getPartIdxFromUuid(o.partUuid),o.staffIdx=t.getPartStaffIdxFromUuid(o.partIdx,o.staffUuid),o.voiceIdx=t.getPartVoiceIdxFromUuid(o.partIdx,o.voiceUuid),e.line=(0,_.A)(i,o)}return e}setUpcomingAttribute(t,e){x("upcoming attr %s set to %s",t,e);const s=this.upcomingAttributes[t];this.upcomingAttributes[t]=e,e!==s&&(0,P.W)().setUpcomingAttribute(t,e)}resetUpcomingAttributes(){(0,P.W)().resetUpcomingAttributes(),this.upcomingAttributes={}}get upcomingAccidentalStr(){return typeof this.upcomingAttributes.accidental=="number"?N.default.alterToAccidental(this.upcomingAttributes.accidental):null}get currentDuration(){var t,e,s;return((t=this.upcomingAttributes.duration)==null?void 0:t.durationType)!==void 0?this.upcomingAttributes.duration:{durationType:(e=this.noteInfo)==null?void 0:e.durationType,nbDots:(s=this.noteInfo)==null?void 0:s.nbDots}}setTextMode(t){t&&(0,nt.S)().setMode("text"),(0,P.W)().setTextMode(t)}sendPosition(){var t;this.pos[this.id]&&(t=this.interaction.scoreData)!=null&&t.rt&&typeof this.interaction.scoreData.rt.sendPosition=="function"&&this.interaction.scoreData.rt.sendPosition(this.pos[this.id])}loopSendPosition(){this.sendPositionLoopIntervalID=window.setInterval(()=>this.sendPosition(),wt)}toggleConcertPitch(){this.setConcertPitchDisplay(!(0,P.W)().isConcertPitch)}setConcertPitchDisplay(t){t=!!t,this.config.set("isConcertPitch",t),(0,P.W)().setConcertPitch(t),(0,st.F)().setEditorPreference("concertPitch",t),this.bumpFocus()}setEditionMode(t){this.config.set("editionMode",t),(0,P.W)().setEditionMode(t),this.cursorDrawer!==null&&this.loadCursor();const e=this.getPositionUuid();if(delete e.graceIdx,this.changeFocus(e),!this.noteInfo){F()("[setEditionMode] noteInfo not set");return}const{durationType:s,nbDots:i}=this.noteInfo;this.setUpcomingAttribute("duration",{durationType:s,nbDots:i}),this.setUpcomingAttribute("accidental",null),t?this.setUpcomingAttribute("unpitchedHead",B.A.NORMAL):this.setUpcomingAttribute("unpitchedHead",null)}setKeepExistingRestDuration(t){t=!!t,this.config.set("keepExistingRestDuration",t),(0,P.W)().changeKeepExistingRestDuration(t)}setChangeDurationMode(t){t=!!t,this.config.set("isChangeDurationInsert",t),(0,P.W)().changeDurationMode(t)}scheduleScrollTo(){this.promiseQueue?window.requestAnimationFrame(()=>{var t;(t=this.promiseQueue)==null||t.add(this.scrollTo.bind(this,!0))}):window.requestAnimationFrame(()=>this.scrollTo())}setCanScroll(){this.canScroll=!0}scrollTo(t){return Et(this,null,function*(){var e;if((e=this.scoreDrawer)!=null&&e.scrollIntoView){const{measureIdx:g}=this.getPositionIdx();yield this.scoreDrawer.scrollIntoView(g);return}if(!this.canScroll||!this.cursorDrawer)return;const s=this.verticalScrollableElement;if(!s)return;if(!this.pageLayout.isSyncWithData()){this.scheduleScrollTo();return}const{height:i,top:o}=s.getBoundingClientRect(),{width:r,left:u}=this.horizontalScrollableElement.getBoundingClientRect();if(this.pageLayout instanceof it.A){const g=this.pageLayout.getMeasuresRange();if(g){const{measureIdx:D}=this.pos[this.id];if(typeof D=="undefined"||D>=this.pageLayout.getNbMeasures())return;if(D<g.startMeasureIdx||D>g.stopMeasureIdx){t?yield this.scoreDrawer.queuedForceDisplayMeasure(D):yield this.scoreDrawer.forceDisplayMeasure(D);const L=this.pageLayout.getMeasurePosX(D);this.horizontalScrollableElement.scrollLeft=L-r/3;return}}}const h=this.pos[this.id];this.scoreDrawer.isMeasureDisplayed(h.measureIdx)||(t?yield this.scoreDrawer.queuedForceDisplayMeasure(h.measureIdx):yield this.scoreDrawer.forceDisplayMeasure(h.measureIdx),this.draw(this.id));const v=this.svgTools.getCoord(this.cursorDrawer.getGroupElem());if(!v)return;let f;(v.y-o<0||v.y>o+i)&&(f=this.pageLayout.uuidGetMeasureEventRect(h),f!==null&&(f=f.node()),f&&(s.scrollTop+=this.svgTools.getCoord(f).y-o)),(v.x-u<0||v.x>u+r)&&(f||(f=this.pageLayout.uuidGetMeasureEventRect(h),f!==null&&(f=f.node())),f&&(this.horizontalScrollableElement.scrollLeft+=this.svgTools.getCoord(f).x-u-Mt))})}createCursorDrawer(){this.config.get().editionMode===z.i?this.cursorDrawer=new ht(this.svgTools):this.cursorDrawer=new dt(this.svgTools),this.bindCursorDrawer(0)}hideCursor(){var t,e;this.hidden||(this.undraw(this.id),this.hidden=!0,(e=(t=this.cursorDrawer)==null?void 0:t.polygone)==null||e.style("visibility","hidden"))}showCursor(){var t,e;this.hidden&&(this.hidden=!1,(e=(t=this.cursorDrawer)==null?void 0:t.polygone)==null||e.style("visibility","inherit"))}setSelectedEntity(t){this.selectedEntity=t,(0,P.W)().setSelectedEntity(t)}getSelectedEntity(){return this.interaction.rangeSelect.hasRange()?this.getSelectedEntityRange():this.selectedEntity?this.selectedEntity:this.getSelectedEntityNote()}getSelectedEntityRange(){const t=this.interaction.rangeSelect,e=t.getLeftRightPositions(),s=t.getTimePosBounds(),i=t.getPartsStavesRange();return{entityType:T.A.RANGE_SELECTION,rangePosition:j(K({},s),{partsStaves:i}),leftAnchorPosition:j(K({},e.left),{timePos:s.startTimePos,dpq:s.startDpq}),rightAnchorPosition:j(K({},e.right),{timePos:s.stopTimePos,dpq:s.stopDpq})}}getSelectedEntityNote(){const t=this.getFullPosition(),e=typeof t.graceIdx=="number"?t.graceIdx:null;if(typeof t.string=="number")return{entityType:T.A.NOTE,partUuid:t.partUuid,staffUuid:t.staffUuid,measureUuid:t.measureUuid,voiceUuid:t.voiceUuid,voiceIdxInStaff:t.voiceIdxInStaff,noteIdx:t.noteIdx,graceIdx:e,headPosition:{string:t.string}};const s=typeof t.line=="number"?t.line:null;return{entityType:T.A.NOTE,partUuid:t.partUuid,staffUuid:t.staffUuid,measureUuid:t.measureUuid,voiceUuid:t.voiceUuid,voiceIdxInStaff:t.voiceIdxInStaff,noteIdx:t.noteIdx,graceIdx:e,headPosition:{line:s}}}setSelected(t){this.clearSelected(),this.selectedElem=t,x("selected: %s",t.type);const e=(0,P.W)();e.setSelectedType(t.type),e.setSelectedPos(t.pos),["note","notehead"].includes(t.type)?this.showCursor():this.hideCursor()}clearSelected(t){if((0,O.q6)().closeActionMenuPaste(),this.setSelectedEntity(null),this.hasSelected()&&(!t||t===this.selectedElem)){x("clear selected: %s",this.selectedElem.type);const e=(0,P.W)();e.setSelectedType(null),e.setSelectedPos(null),typeof this.selectedElem.clearElem!="undefined"&&this.selectedElem.clearElem(),this.selectedElem=null,this.showCursor()}}get realSelectedElem(){return!this.svgTools.isStillInDom(this.selectedElem.elem)&&this.selectedElem.refresh&&this.selectedElem.refresh(),this.selectedElem.elem}hasSelected(){return this.selectedElem!==null}destroy(){this.sendPositionLoopIntervalID!==null&&clearInterval(this.sendPositionLoopIntervalID)}static positionUuidToIdx(t,e){const s=t.getPartIdxFromUuid(e.partUuid),i=t.getPartStaffIdxFromUuid(s,e.staffUuid),o=t.getMeasureIdxFromUuid(e.measureUuid),r={partIdx:s,staffIdx:i,measureIdx:o};return e.voiceUuid&&(r.voiceIdx=t.getPartVoiceIdxFromUuid(r.partIdx,e.voiceUuid)),r}static getTabsAtString(t,e){var s;if(t.tabsData&&typeof e!="undefined"){for(let i=0;i<t.tabsData.length;i++)if(((s=t.tabsData[i])==null?void 0:s.string)===e)return t.tabsData[i]}return null}}},349860:(R,C,n)=>{n.d(C,{$2:()=>I,b9:()=>T,hL:()=>U,l0:()=>y,qj:()=>b,rK:()=>S});function T(c,m){let N=c.getElementsByTagName("line");N=Array.from(N),N.forEach(M=>{M.style.stroke=m})}function I(c){let m=c.getElementsByTagName("line");m=Array.from(m),m.forEach(N=>{N.style.stroke=""})}const p=n.j!=9655?["systemBreak","nextSystemBreak","pageBreak","nextPageBreak"]:null;function U(c,m){p.includes(c.classList[0])&&(c.style.stroke=m)}function y(c){p.includes(c.classList[0])&&(c.style.stroke="black")}function S(c,m){c.style.fill=m}function b(c){const m=c.getAttribute("data-adagio-note-color");m?c.style.fill=m:c.style.fill=""}},684188:(R,C,n)=>{n.d(C,{J:()=>I});function T(p){const U=this.valueOf();return p&&p.string===U}function I(p){var U,y;const S=p.getPositionUuid();if(typeof S.string!="undefined")return(U=p.noteInfo)!=null&&U.tabsData?p.noteInfo.tabsData.findIndex(T,S.string):-1;if(typeof S.line!="undefined"){const b=(y=p.noteInfo)==null?void 0:y.lines;return b?b.indexOf(S.line):-1}throw new Error("Neither line or string are available in the cursor.")}},697333:(R,C,n)=>{n.d(C,{A:()=>U});var T=n(676170);let I=!1;function p(y){I=y}function U(){return I||new URLSearchParams(window.location.search).has("newDisplay","true")?!0:(0,T.G7)("editor.new-score-display")}},883892:(R,C,n)=>{n.d(C,{S:()=>U});var T=n(6645),I=n(744056),p=n(121648);const U=(0,T.nY)("scoreEditorToolbar",()=>{const y=(0,I.KR)("note"),S=(0,I.KR)("note"),b=(0,I.KR)(!1),c=(0,I.KR)(!1),m=(0,I.KR)(!1);function N(E){S.value=E,(0,p.W)().unselect()}function M(){S.value=y.value}function G(E){b.value=E}function W(E){c.value=E}function B(E){m.value=E}return{defaultMode:y,mode:S,showMore:b,highlightDurations:c,mainToolbarOnTop:m,setMode:N,setDefaultMode:M,setShowMore:G,setHighlightDurations:W,setMainToolbarOnTop:B}})}}]);})();


//# debugId=55924b57-f93a-5856-b70b-02e6b74b2275

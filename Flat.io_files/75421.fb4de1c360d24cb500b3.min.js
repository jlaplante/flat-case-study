"use strict";
!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="d4b53e08-eab2-5a75-bd4d-bcb9a3985996")}catch(e){}}();
(()=>{var tW=(ae,Et)=>()=>(Et||ae((Et={exports:{}}).exports,Et),Et.exports);var eW=tW(Y=>{/*! Copyright (c) 2025 Tutteo Ltd. */(self.webpackChunk_flat_flat=self.webpackChunk_flat_flat||[]).push([[75421],{17542:(ae,Et,b)=>{b.d(Et,{z:()=>V});var V=(U=>(U.CREATE_ROOT="CREATE_ROOT",U.CREATE_GLYPH="CREATE_GLYPH",U.CREATE_LINE="CREATE_LINE",U.CREATE_GROUP="CREATE_GROUP",U.CREATE_PATH="CREATE_PATH",U.CREATE_TEXT="CREATE_TEXT",U.CREATE_CIRCLE="CREATE_CIRCLE",U.CREATE_RECT="CREATE_RECT",U.ATTACH_NODES="ATTACH_NODES",U.UNLINK_NODES="UNLINK_NODES",U.SET_LABEL="SET_LABEL",U.SET_X="SET_X",U.SET_Y="SET_Y",U.SET_ROTATION="SET_ROTATION",U.SET_X2="SET_X2",U.SET_Y2="SET_Y2",U.SET_SCALING_Y="SET_SCALING_Y",U.SET_SCALING_X="SET_SCALING_X",U.SET_COLOR="SET_COLOR",U.SET_OPACITY="SET_OPACITY",U.SET_BLUR="SET_BLUR",U.SET_STROKE_COLOR="SET_STROKE_COLOR",U.SET_STROKE_WIDTH="SET_STROKE_WIDTH",U.SET_FILL_RULE="SET_FILL_RULE",U.SET_MIX_BLEND_MODE="SET_MIX_BLEND_MODE",U.SET_TEXT="SET_TEXT",U.SET_PATH="SET_PATH",U.SET_RADIUS="SET_RADIUS",U.STROKE_QUAD_QURVE="STROKE_QUAD_QURVE",U.DESTROY_NODE="DESTROY_NODE",U.DESTROY_ROOT="DESTROY_ROOT",U))(V||{})},18033:(ae,Et,b)=>{b.d(Et,{A:()=>vt});var V=b(390253),U=b(208758),X=Object.defineProperty,Tt=(xt,k,ct)=>k in xt?X(xt,k,{enumerable:!0,configurable:!0,writable:!0,value:ct}):xt[k]=ct,tt=(xt,k,ct)=>Tt(xt,typeof k!="symbol"?k+"":k,ct);const j=1;class vt{constructor(k,ct,Lt){tt(this,"font"),tt(this,"fallbackFont"),tt(this,"iconsFont"),tt(this,"iconsIds",[]),this.font=k,this.fallbackFont=ct,this.iconsFont=Lt,this.iconsIds=Array.from(Object.keys(Lt.glyphs))}getPath(k,ct){const Lt=V.A.POINTS_BY_INCH*4*ct;let Ut=this.font;return this.iconsIds.includes(k)&&(Ut=this.iconsFont),new U.A(k,Lt,j,Ut,this.fallbackFont).render()}}},87053:(ae,Et,b)=>{b.d(Et,{A:()=>Tt,L:()=>X});var V=b(210943),U=(tt=>(tt.SPACE="space",tt.POINT="point",tt))(U||{});function X(tt){return V.A.isUnitSpace(tt)?"space":"point"}const Tt=U},92856:(ae,Et,b)=>{b.d(Et,{A:()=>U});var V=(X=>(X.FIRST_OF_SCORE="first-of-score",X.FIRST_OF_SYSTEM="first-of-system",X.MIDDLE="middle",X))(V||{});const U=V},164059:(ae,Et,b)=>{b.d(Et,{$n:()=>J,AK:()=>tt,MR:()=>et,aI:()=>xt,g6:()=>Gt,o5:()=>X,ow:()=>Tt,pS:()=>jt,w8:()=>Lt,zM:()=>Ut});var V=b(920939),U=b(740827);function X(kt){return kt.spaceSize*(kt.nbStaffLines-1)}function Tt(){return tt("test")}function tt(kt){return{nbStaffLines:5,spaceSize:1,type:U.A.STANDARD,uuid:kt}}const j=1.4,vt=4;function xt(kt,fe){return{nbStaffLines:kt,spaceSize:j,type:U.A.GUITAR_TAB,uuid:fe}}function k(kt){return{nbStaffLines:6,spaceSize:j,type:StaffType.GUITAR_TAB,uuid:kt}}function ct(kt){return{nbStaffLines:4,spaceSize:j,type:StaffType.GUITAR_TAB,uuid:kt}}function Lt(kt){return{nbStaffLines:3,spaceSize:vt,type:U.A.RECORDER_TAB,uuid:kt}}function Ut(kt){return{nbStaffLines:7,spaceSize:1,type:U.A.KODALY,uuid:kt}}function J(kt,fe){const ne=fe.nbStaffLines;if(fe.type===U.A.GUITAR_TAB){const Oe=fe.spaceSize;return V.A.lineToTabY(kt,1,Oe,ne)}else return V.A.lineToY(kt,1,ne)}function et(kt){return(kt.nbStaffLines-1)/2+1}function Gt(kt){return kt.type!==U.A.RECORDER_TAB}function jt(kt){return kt.type===U.A.RECORDER_TAB||kt.type===U.A.GUITAR_TAB||kt.type===U.A.KODALY}},172858:(ae,Et,b)=>{b.d(Et,{A:()=>he});var V=b(756710),U=b(398738),X=b(928816),Tt=b(659140),tt=b(996636),j=b(15049),vt=b(891959),xt=b(854381),k=b(250818);function ct(){const Qt={};return Qt[Tt.A.MAJOR]=tt.A.LOWER_CASE_LONG,Qt[Tt.A.MINOR]=tt.A.LOWER_CASE,Qt[Tt.A.DIMINISHED]=tt.A.SYMBOL,{spaceBetweenSystems:4,spaceBetweenStaves:2,maxMeasuresInFirstSystem:4,maxMeasuresInOtherSystems:4,measureNumberingStart:1,pageNumberingStart:1,hasPickup:!1,measureNumberingPolicy:vt.A.DEFAULT,quarterToSpaceRatio:2,minSpaceBetweenNotes:.5,hideEmptyPartsPolicy:j.A.DEFAULT,jazzChordPartConfig:Qt,hideTempoMarkings:!1,pitchColor:V.k.NORMAL,pitchGlyph:k.A.NORMAL,isFixedDo:!0,spaceSizeMm:6.35/4,defaultFontFamily:xt.S,fontsMap:xt.z,showSystemBreakSymbols:!1,isConcertPitch:!1,hideNonTab:!1,hideNonKodaly:!1,showTabRests:!1,renderAll:!1,greyRepeatNotations:!1,displayOutOfPitch:!1,displayFirstKey:!1,partsList:null,displayOtherLinesPartsNames:!0}}function Lt(Qt){const{layoutData:_,isFirstSystem:Nt,idxInSystem:oe,isForcedDisplay:$t,isSoftForcedDisplay:pe}=Qt;let{measureNumberingPolicy:He}=_;pe&&(He=vt.A.EVERY);let{displayMeasureIdx:bt}=Qt;if(bt+=_.measureNumberingStart,_.hasPickup&&(bt-=1),$t)return bt;if(He===vt.A.NONE)return null;const xs=Nt&&oe===0;if(_.hasPickup&&xs||!_.hasPickup&&xs&&bt===1)return null;if(He===vt.A.FIRST_OF_SYSTEM){const it=_.hasPickup&&Nt?1:0;return oe!==it?null:bt}else{if(He===vt.A.EVERY)return bt;throw vt.A.raiseError(He)}}var Ut=Object.defineProperty,J=Object.defineProperties,et=Object.getOwnPropertyDescriptors,Gt=Object.getOwnPropertySymbols,jt=Object.prototype.hasOwnProperty,kt=Object.prototype.propertyIsEnumerable,fe=(Qt,_,Nt)=>_ in Qt?Ut(Qt,_,{enumerable:!0,configurable:!0,writable:!0,value:Nt}):Qt[_]=Nt,ge=(Qt,_)=>{for(var Nt in _||(_={}))jt.call(_,Nt)&&fe(Qt,Nt,_[Nt]);if(Gt)for(var Nt of Gt(_))kt.call(_,Nt)&&fe(Qt,Nt,_[Nt]);return Qt},ne=(Qt,_)=>J(Qt,et(_)),Oe=(Qt,_,Nt)=>fe(Qt,typeof _!="symbol"?_+"":_,Nt);const ze="noteheadBlack",Ct=4;class he{constructor(_,Nt){Oe(this,"nodeContext"),Oe(this,"musicFont"),Oe(this,"noteHeadWidth"),Oe(this,"layoutData",ct()),this.nodeContext=_,this.musicFont=Nt,this.noteHeadWidth=null}overrideLayoutData(_){this.layoutData=ge(ge({},this.layoutData),_)}getGlyphData(_,Nt=1){return this.nodeContext.glyphsCache.getGlyph(_,Nt)}createGlyphNode(_,Nt=1){return this.nodeContext.createGlyphNode(_,Nt)}createLineNode(){return this.nodeContext.createLineNode()}createBeamNode(_){return this.nodeContext.createBeamNode(_)}createRectNode(_,Nt,oe){return this.nodeContext.createRectNode(_,Nt,oe)}createCircleNode(_){return this.nodeContext.createCircleNode(_)}createDashedLineNode(){return this.nodeContext.createLineNode()}createGroupNode(){return this.nodeContext.createGroupNode()}createRootNode(){return this.nodeContext.createRootNode()}createTextNode(_,Nt){return this.nodeContext.createTextNode(_,Nt)}createSlurQuadCurveNode(_,Nt){return this.nodeContext.createSlurQuadCurveNode(_,Nt)}createQuadCurveNode(_){return this.nodeContext.createQuadCurveNode(_)}createCubicCurveNode(_,Nt){return this.nodeContext.createCubicCurveNode(_,Nt)}createPathNode(_){return this.nodeContext.createPathNode(_)}getMMRExternalThickness(){return .32}getMMRInternalThickness(){return .7}getTieVerticalMargin(){return 3/4}getHammerOnVerticalMargin(){return 3/4}getMinimalTieStopHorizontalMargin(){return 2}getRecorderDiagramMargin(){return 3/4}getStaffLineThickness(){const _=this.musicFont.engravingDefaults.staffLineThickness;if(typeof _!="number")throw new Error("Missing staff line thickness in music font");return _}getStemThickness(){const _=this.musicFont.engravingDefaults.stemThickness;if(typeof _!="number")throw new Error("Missing stem thickness in music font");return _}getLegerLineThickness(){const _=this.musicFont.engravingDefaults.legerLineThickness;if(typeof _!="number")throw new Error("Missing leger line thickness in music font");return _}getLegerLineExtension(){const _=this.musicFont.engravingDefaults.legerLineExtension;if(typeof _!="number")throw new Error("Missing leger line extension in music font");return _}getThickBarlineThickness(){const _=this.musicFont.engravingDefaults.thickBarlineThickness;if(typeof _!="number")throw new Error("Missing thick barline thickness in music font");return _}getThinBarlineThickness(){const _=this.musicFont.engravingDefaults.thinBarlineThickness;if(typeof _!="number")throw new Error("Missing thin barline thickness in music font");return _}getBarlineSeparation(){const _=this.musicFont.engravingDefaults.barlineSeparation;if(typeof _!="number")throw new Error("Missing barline separation in music font");return _}getRecorderTabSeparatorThickness(){return .12}getRepeatBarlineDotSeparation(){const _=this.musicFont.engravingDefaults.repeatBarlineDotSeparation;if(typeof _!="number")throw new Error("Missing repeat barline dot separation in music font");return _}getBracketThickness(){const _=this.musicFont.engravingDefaults.bracketThickness;if(typeof _!="number")throw new Error("Missing bracket stroke width in music font");return _}getGroupBracketExtraSpace(){return 1}getTieEndpointThickness(){const _=this.musicFont.engravingDefaults.tieEndpointThickness;if(typeof _!="number")throw new Error("Missing tie endpoint thickness in music font");return _}getTieMidpointThickness(){const _=this.musicFont.engravingDefaults.tieMidpointThickness;if(typeof _!="number")throw new Error("Missing tie midpoint thickness in music font");return _}getSlurEndpointThickness(){const _=this.musicFont.engravingDefaults.slurEndpointThickness;if(typeof _!="number")throw new Error("Missing slur endpoint thickness in music font");return _}getSlurMidpointThickness(){const _=this.musicFont.engravingDefaults.slurMidpointThickness;if(typeof _!="number")throw new Error("Missing slur midpoint thickness in music font");return _}getLyricLineThickness(){const _=this.musicFont.engravingDefaults.lyricLineThickness;if(typeof _!="number")throw new Error("Missing lyric line thickness in music font");return _}getTextEnclosureThickness(){const _=this.musicFont.engravingDefaults.textEnclosureThickness;if(typeof _!="number")throw new Error("Missing text enclosure thickness in music font");return _}getRehearsalPadding(){return this.getRehearsalFontOptions().fontSize/7}getNoteheadWidth(){if(this.noteHeadWidth===null){const _=this.createGlyphNode(ze);this.noteHeadWidth=_.getWidth()}return this.noteHeadWidth}usePitchNameNotehead(){return this.layoutData.pitchGlyph===k.A.NAMES}useSolfegeNotehead(){return this.layoutData.pitchGlyph===k.A.SOLFEGE_SI||this.layoutData.pitchGlyph===k.A.SOLFEGE_TI||this.layoutData.pitchGlyph===k.A.SOLFEGE_JAPANESE}useShapeNotehead(){return this.layoutData.pitchGlyph===k.A.SHAPE}outlineColoredNotes(){return!1}useBoomwhackersColors(){return this.layoutData.pitchColor===V.k.BOOMWHACKER}useCustomColors(){return this.layoutData.pitchColor===V.k.CUSTOM}customColorOptions(){return this.layoutData.pitchColor!==V.k.CUSTOM?null:this.layoutData.pitchColorOptions||null}isFixedDo(){return this.layoutData.isFixedDo}getSolfegeType(){return this.layoutData.pitchGlyph}displayOutOfPitch(){return this.layoutData.displayOutOfPitch}getGraceSizeCoeff(){return .7}getGraceFlagSizeCoeff(){return .5}getMarginSize(){return .5}getMinimalSpaceAboveRightRatio(){return 4}getMinSpaceBetweenNotes(){return this.layoutData.minSpaceBetweenNotes}getQuarterToSpaceRatio(){return this.layoutData.quarterToSpaceRatio}getSpaceBetweenStaves(){return this.layoutData.spaceBetweenStaves}getSpaceBetweenStavesRecorder(){return this.layoutData.spaceBetweenStaves/2}getSpaceBetweenSystems(){return this.layoutData.spaceBetweenSystems}getMaxNbMeasuresInFirstSystem(){return this.layoutData.maxMeasuresInFirstSystem}getMaxNbMeasuresInOtherSystems(){return this.layoutData.maxMeasuresInOtherSystems}getPageNumber(_){return _+this.layoutData.pageNumberingStart}getMeasureNumber(_){return Lt(ne(ge({},_),{layoutData:this.layoutData}))}showSystemBreakSymbols(){return this.layoutData.showSystemBreakSymbols}displayFirstKey(){return this.layoutData.displayFirstKey}displayOtherLinesPartsNames(){return this.layoutData.displayOtherLinesPartsNames}hideTempoMarkings(){return this.layoutData.hideTempoMarkings}showTabRests(){return this.layoutData.showTabRests}hideNonTab(){return this.layoutData.hideNonTab}hideNonKodaly(){return this.layoutData.hideNonKodaly}partsList(){return this.layoutData.partsList}getOctaveShiftTextMargin(){return .25}getPluckedRangeTextMargin(){return 1}getOctaveLineThickness(){const _=this.musicFont.engravingDefaults.octaveLineThickness;if(typeof _!="number")throw new Error("Missing octaveLineThickness in music font");return _}getEndingThickness(){return .16}getPluckedRangeLineThickness(){return this.getOctaveLineThickness()}getPedalGlyphMargin(){return .25}getPedalLineThickness(){const _=this.musicFont.engravingDefaults.pedalLineThickness;if(typeof _!="number")throw new Error("Missing pedalLineThickness in music font");return _}getTempoChangeFontOptions(){return{fontFamily:this.layoutData.defaultFontFamily,fontSize:1.92,bold:!1,italic:!0}}getEndingFontOptions(){return{fontFamily:this.layoutData.defaultFontFamily,fontSize:2,bold:!1,italic:!1}}getGlissandoHorizontalMargin(){return .25}getMinimalSlideLineHorizontalLength(){return 2.5}getMinimalGlissandoHorizontalLength(){return 3.2}getGlissandoExcessWidth(){return .22}getTempoChangeTextMargin(){return .25}getEndingTextVerticalMargin(){return .5}getEndingTextHorizontalMargin(){return 1}getTempoChangeThickness(){return .16}getTempoChangeDashArrayWidth(){return .5}getBendLineThickness(){return .1}getHairpinOpenSpread(){return 1}getHairpinOpenContinueSpread(){return 2/3}getHairpinCloseSpread(){return 0}getHairpinCloseContinueSpread(){return 1/3}getSystemBreakGlyphThickness(){return .16}getDefaultBendMargin(){return 1}getHairpinThickness(){const _=this.musicFont.engravingDefaults.hairpinThickness;if(typeof _!="number")throw new Error("Missing hairpinThickness in music font");return _}getTupletBracketThickness(){const _=this.musicFont.engravingDefaults.tupletBracketThickness;if(typeof _!="number")throw new Error("Missing tupletBracketThickness in music font");return _}getChordGlyphRatio(){return this.getChordsFontOptions().fontSize/Ct}getJazzChordPartConfig(){return this.layoutData.jazzChordPartConfig}getPizzicatoFontOptions(){return(0,X.A)(this.layoutData.fontsMap,this.layoutData.spaceSizeMm,U.default.PIZZICATO)}getTextAnnotationsFontOptions(){return(0,X.A)(this.layoutData.fontsMap,this.layoutData.spaceSizeMm,U.default.WORD)}getChordsFontOptions(){return(0,X.A)(this.layoutData.fontsMap,this.layoutData.spaceSizeMm,U.default.HARMONY)}getFiguredBassFontOptions(){const _=(0,X.A)(this.layoutData.fontsMap,this.layoutData.spaceSizeMm,U.default.HARMONY);return ne(ge({},_),{fontSize:2})}getJumpFontOptions(){return{fontFamily:this.layoutData.defaultFontFamily,fontSize:2.62,bold:!1,italic:!1}}getMeasureNumberFontOptions(){return(0,X.A)(this.layoutData.fontsMap,this.layoutData.spaceSizeMm,U.default.MEASURE_NUMBER)}getRehearsalFontOptions(){return(0,X.A)(this.layoutData.fontsMap,this.layoutData.spaceSizeMm,U.default.REHEARSAL)}getPartNameFontOptions(){return(0,X.A)(this.layoutData.fontsMap,this.layoutData.spaceSizeMm,U.default.PART_NAME)}getPageNumberFontOptions(){return(0,X.A)(this.layoutData.fontsMap,this.layoutData.spaceSizeMm,U.default.PAGE_NUMBER)}getTitleFontOptions(){return(0,X.A)(this.layoutData.fontsMap,this.layoutData.spaceSizeMm,U.default.TITLE)}getSubtitleFontOptions(){return(0,X.A)(this.layoutData.fontsMap,this.layoutData.spaceSizeMm,U.default.SUBTITLE)}getLyricistFontOptions(){return(0,X.A)(this.layoutData.fontsMap,this.layoutData.spaceSizeMm,U.default.LYRICIST)}getArrangerFontOptions(){return(0,X.A)(this.layoutData.fontsMap,this.layoutData.spaceSizeMm,U.default.ARRANGER)}getComposerFontOptions(){return(0,X.A)(this.layoutData.fontsMap,this.layoutData.spaceSizeMm,U.default.COMPOSER)}getRightsFontOptions(){return(0,X.A)(this.layoutData.fontsMap,this.layoutData.spaceSizeMm,U.default.RIGHTS)}getPluckedRangeFontOptions(){return{fontFamily:(0,X.A)(this.layoutData.fontsMap,this.layoutData.spaceSizeMm,U.default.HARMONY).fontFamily,fontSize:2,bold:!1,italic:!1}}getMMRFontOptions(){return{fontFamily:this.layoutData.defaultFontFamily,fontSize:2,bold:!1,italic:!1}}getLyricsFontOptions(){return(0,X.A)(this.layoutData.fontsMap,this.layoutData.spaceSizeMm,U.default.LYRICS)}getKodalyFontOptions(){return{fontFamily:this.layoutData.defaultFontFamily,fontSize:2,bold:!1,italic:!1}}getTupletFontOptions(){return{fontFamily:this.layoutData.defaultFontFamily,fontSize:1,bold:!1,italic:!1}}getTempoFontOptions(){return(0,X.A)(this.layoutData.fontsMap,this.layoutData.spaceSizeMm,U.default.TEMPO)}getRepeatTimesFontOptions(){return{fontFamily:this.layoutData.defaultFontFamily,fontSize:2,bold:!1,italic:!1}}getTabSpaceSize(){return 1.4}getTabSlideYOffset(){return 1/3}hasFretNumberFont(){return!1}getFretTextFontOptions(){return(0,X.A)(this.layoutData.fontsMap,this.layoutData.spaceSizeMm,U.default.FRET_NUMBER)}getBendTextOptions(){return{fontFamily:this.layoutData.defaultFontFamily,fontSize:1,bold:!1,italic:!1}}}},200486:(ae,Et,b)=>{b.d(Et,{F:()=>U,z:()=>V});function V(){return{overrides:[],foregroundAdditions:[],backgroundAdditions:[]}}function U(X){return X.overrides.length===0&&X.foregroundAdditions.length===0&&X.backgroundAdditions.length===0}},226464:(ae,Et,b)=>{b.d(Et,{A:()=>U});var V=(X=>(X.LARGE="large",X.SMALL="small",X))(V||{});const U=V},250818:(ae,Et,b)=>{b.d(Et,{A:()=>U});var V=(X=>(X.NORMAL="normal",X.SHAPE="shape",X.NAMES="names",X.SOLFEGE_SI="solfege-si",X.SOLFEGE_TI="solfege-ti",X.SOLFEGE_JAPANESE="solfege-japanese",X))(V||{});const U=V},264389:(ae,Et,b)=>{b.d(Et,{A:()=>k});var V=b(875105),U=(ct=>(ct.REGULAR="Regular",ct.BOLD="Bold",ct.ITALIC="Italic",ct.BOLD_ITALIC="Bold Italic",ct))(U||{});const X=null;function Tt(ct,Lt){return ct&&Lt?"Bold Italic":ct?"Bold":Lt?"Italic":"Regular"}var tt=Object.defineProperty,j=(ct,Lt,Ut)=>Lt in ct?tt(ct,Lt,{enumerable:!0,configurable:!0,writable:!0,value:Ut}):ct[Lt]=Ut,vt=(ct,Lt,Ut)=>j(ct,typeof Lt!="symbol"?Lt+"":Lt,Ut);const xt=new Map([["Roma","Regular"],["Book","Regular"],["Demi","Bold"],["Book Oblique","Italic"],["Demi Oblique","Bold Italic"]]);class k{constructor(Lt){vt(this,"map",new Map),vt(this,"rawMap",new Map),Lt.forEach(Ut=>{const J=V.Ay.parse(Ut),et=k.getKeyFromFont(J);this.map.set(et,J),this.rawMap.set(et,Ut)})}getFont(Lt,Ut,J){const et=k.getKey(Lt,Ut,J);let Gt=this.map.get(et);if(!Gt){const jt=k.getKey(Lt,!1,!1);Gt=this.map.get(jt)}if(!Gt)throw new Error(`Font not found: ${Lt}`);return Gt}static getKeyFromFont(Lt){const Ut=Lt.names.fontFamily.en;let J=Lt.names.fontSubfamily.en;const et=xt.get(J);return et&&(J=et),`${Ut} ${J}`}static getKey(Lt,Ut,J){const et=Tt(Ut,J);return`${Lt} ${et}`}}},267811:(ae,Et,b)=>{b.d(Et,{d:()=>U,n:()=>V});function V(X){performance.mark(`${X}.s`)}function U(X){performance.mark(`${X}.e`),performance.measure(X,`${X}.s`,`${X}.e`)}},304713:(ae,Et,b)=>{b.d(Et,{A:()=>U});var V=(X=>(X.ADD_PART="ADD_PART",X.REMOVE_PART="REMOVE_PART",X.ADD_VOICE="ADD_VOICE",X.REMOVE_VOICE="REMOVE_VOICE",X.ADD_MEASURE="ADD_MEASURE",X.REMOVE_MEASURE="REMOVE_MEASURE",X.UPDATE_PART_MEASURE="UPDATE_PART_MEASURE",X.UPDATE_GLOBAL_MEASURE="UPDATE_GLOBAL_MEASURE",X))(V||{});const U=V},306563:(ae,Et,b)=>{b.d(Et,{Ft:()=>U,UD:()=>Tt,Zd:()=>V});function V(tt){return`${tt.fontFamily}-${tt.bold?"bold":"normal"}-${tt.italic?"italic":"normal"}`}function U(tt,j){return tt.fontFamily===j.fontFamily&&tt.bold===j.bold&&tt.italic===j.italic}function X(tt){let j=tt.fontFamily.replace(" ","");return tt.bold&&(j+="Bold"),tt.italic&&(j+="Italic"),!tt.bold&&!tt.italic&&(j+="Regular"),j+=".ttf",j}function Tt(tt,j){return tt.fontFamily<j.fontFamily?-1:tt.fontFamily>j.fontFamily?1:tt.bold&&!j.bold?-1:!tt.bold&&j.bold?1:tt.italic&&!j.italic?-1:!tt.italic&&j.italic?1:0}},340497:(ae,Et,b)=>{b.d(Et,{A:()=>U});const V=.5;function U(tt,j,vt){const{systems:xt,positions:k}=X(tt,j,vt);Tt(tt,xt,k)}function X(tt,j,vt){const xt=[],k=[];let ct=null;const Lt=vt.getSpaceBetweenSystems(),Ut=tt.getAvailableHeight();for(;j.hasNext();){let J,et;if(ct!==null){if(Ut===null||!ct.isSingleInSlice()||ct.hasPageBreakAfter())break;if(J=j.getNext(),J.hasPageBreakBefore()){j.handback(J);break}let Gt=ct.getBottomHeight()+J.getTopHeight()+V;if(Gt=Math.max(Gt,Lt),et=k[k.length-1]+ct.getStaffHeight()+Gt,et+J.getStaffHeight()+J.getBottomHeight()>Ut){j.handback(J);break}}else J=j.getNext(),et=J.getTopHeight();xt.push(J),k.push(et),ct=J}return{systems:xt,positions:k}}function Tt(tt,j,vt){tt.systems.filter(k=>!j.includes(k)).forEach(k=>tt.removeSystem(k)),j.forEach((k,ct)=>{const Lt=vt[ct];k.page===null?tt.addSystemAt({system:k,position:Lt,systemIdx:ct}):k.page!==tt?(k.page.removeSystem(k),tt.addSystemAt({system:k,position:Lt,systemIdx:ct})):tt.setSystemPosition({systemIdx:ct,position:Lt})})}},458786:(ae,Et,b)=>{b.d(Et,{A:()=>Io});var V=b(601770),U=b(777345),X=b(110976),Tt=b(607801),tt=b(250769),j=b(555172),vt=b(952818),xt=b(701387),k=b(269032);function ct(v,R,G){const q={measureUuid:G,nextMeasureUuid:null,jumpCall:null,jumpTag:null,formerJumpCall:null,barlineRepeatNbTimes:null,middleTempoChanges:[],leftTempoChange:null,rightTempoChange:null,leftEnding:null,ending:null,rightEnding:null,systemBreakBefore:!1,systemBreakAfter:!1,pageBreakBefore:!1,pageBreakAfter:!1,hasRightSpecificBarline:!1,tempo:null,swing:null,rehearsalMark:null},Q=v.scoreData.getMeasure(0,R),K=xt.default.getDpq(Q),ut=xt.default.getNbDivisions(Q);if(v.hasJumpTag(R)&&(q.jumpTag=v.getJumpTag(R)),v.hasJumpCall(R)&&(q.jumpCall=v.getJumpCall(R),Tt.A.isJumpBackward(q.jumpCall)&&(q.formerJumpCall=Lt(v,R))),xt.default.hasRepeatBackward(Q)){const T=xt.default.getRightBarline(Q),Dt=j.A.getRepeat(T),I=k.A.getNbplay(Dt);I>2&&(q.barlineRepeatNbTimes=I)}if(xt.default.hasRightSpecificBarline(Q)&&(q.hasRightSpecificBarline=!0),v.hasLeftTempoChange(R)){const T=structuredClone(v.getLeftTempoChange(R));vt.A.setDpq(T,K),q.leftTempoChange=T}if(v.hasRightTempoChange(R)){const T=structuredClone(v.getRightTempoChange(R));vt.A.setDpq(T,K),vt.A.setTimePos(T,ut),q.rightTempoChange=T}v.hasTempoChanges(R)&&(q.middleTempoChanges=v.getTempoChanges(R)),v.hasSystemBreak(R)&&v.getSystemBreak(R)===tt.A.YES&&(q.systemBreakBefore=!0),v.hasPageBreak(R)&&v.getPageBreak(R)===tt.A.YES&&(q.pageBreakBefore=!0);const Mt=v.getNbMeasures();R+1<Mt&&(v.hasSystemBreak(R+1)&&v.getSystemBreak(R+1)===tt.A.YES&&(q.systemBreakAfter=!0),v.hasPageBreak(R+1)&&v.getPageBreak(R+1)===tt.A.YES&&(q.pageBreakAfter=!0));let qt=v.getTempo(R);if(R>0){const T=v.getTempo(R-1);X.default.isSame(qt,T)&&(qt=null)}q.tempo=qt;let N=v.getSwing(R);if(R>0){const T=v.getSwing(R-1);U.default.isSame(N,T)&&(N=null)}else U.default.isSwinging(N)||(N=null);if(q.swing=N,v.hasRehearsal(R)){const T=v.getRehearsal(R);q.rehearsalMark=T}if(v.hasEnding(R)){const T=v.getEnding(R);q.ending=T}if(R>0&&v.hasEnding(R-1)){const T=v.getEnding(R-1);q.leftEnding=T}if(R+1<Mt&&v.hasEnding(R+1)){const T=v.getEnding(R+1);q.rightEnding=T}return q}function Lt(v,R){for(let G=R-1;G>=0;G--)if(v.hasJumpCall(G))return v.getJumpCall(G);return null}var Ut=b(615565),J=b(304713);function et(v){return Ut.A.extractActions(v).map(Gt).filter(jt)}function Gt(v){if(v.type==="PartMeasureUpdate"){if(v.opts.partUuid&&v.opts.measureUuid)return{type:J.A.UPDATE_PART_MEASURE,partUuid:v.opts.partUuid,measureUuid:v.opts.measureUuid,data:null}}else if(v.type==="GlobalMeasureUpdate"&&v.opts.measureUuid)return{type:J.A.UPDATE_GLOBAL_MEASURE,measureUuid:v.opts.measureUuid,data:null,measureData:null};return null}function jt(v){return v!==null}function kt(v){const R=new Set;return v.filter(G=>{const q=fe(G);return R.has(q)?!1:(R.add(q),!0)})}function fe(v){const R=ge(v),G=ne(v);return`${R}:${G}`}function ge(v){return v.type===J.A.UPDATE_GLOBAL_MEASURE?null:v.partUuid}function ne(v){return v.measureUuid}var Oe=b(771997);function ze(v,R){let G=et(R);return G=kt(G),G=(0,Oe.A)(G,v),G}function Ct(v){const R=new Map,G=v.getNbMeasures(),q=v.getCommonContent();let Q=0;for(let K=0;K<G;K++){const ut=v.getMeasureUuid(K);let Mt=1;q.hasMultiMeasureRest(K)&&(Mt=q.getMultiMeasureRest(K)),R.set(ut,Q),Q+=Mt}return R}function he(v){const R=v.getTitle();let G=null;v.hasSubtitle()&&(G=v.getSubtitle());let q=null;v.hasArranger()&&(q=v.getArrangerStr());let Q=null;v.hasComposer()&&(Q=v.getComposerStr());let K=null;v.hasLyricist()&&(K=v.getLyricistStr());let ut=[];return v.hasRights()&&(ut=v.getRightsEntries()),{title:R,subtitle:G,arranger:q,composer:Q,lyricist:K,rightsLines:ut}}var Qt=b(615898);function _(v){const R=v.getOddPageMargins(),G=v.getPageWidth(),q=Qt.A.getLeft(R),Q=Qt.A.getRight(R),K=(G-q-Q)/10,ut=v.getPageHeight(),Mt=Qt.A.getTop(R),qt=Qt.A.getBottom(R),N=(ut-Mt-qt)/10,T=v.scaleToMillimeters(10);return{sliceWidth:K,pageHeight:N,topMargin:Mt/10,bottomMargin:qt/10,internalMargin:q/10,externalMargin:Q/10,spaceSizeMm:T}}var Nt=b(399564),oe=b(911066),$t=b(604824),pe=b(250818);const He={minSpaceBetweenNotes:.5,quarterToSpaceRatio:2},bt=new Map([[1,{minSpaceBetweenNotes:.25,quarterToSpaceRatio:1}],[1.25,He],[1.5,{minSpaceBetweenNotes:.5,quarterToSpaceRatio:4}]]);function xs(v){const R=v.getNotesSpacingCoeff();return bt.get(R)||He}var it=b(914390),ur=b(210943),at=b(851653),Ot=b(571349),ye=b(398738),ci=b(854381),ui=b(87053);function Ys(v,R,G){var q,Q,K,ut,Mt;return{fontSize:(q=v.fontSize)!=null?q:R.fontSize,fontFamily:(K=(Q=v.fontFamily)!=null?Q:G)!=null?K:R.fontFamily,bold:(ut=v.bold)!=null?ut:R.bold,italic:(Mt=v.italic)!=null?Mt:R.italic}}function Hi(v,R){const G=new Map;for(const[q,Q]of ci.z){const K=v.get(q)||{},ut=Ys(K,Q,R);G.set(q,ut)}return G}function _i(v){let R;const G=new Map;ye.default.values.forEach(Q=>{const K=v.getFontEntry(Q);if(Q===ye.default.GLOBAL){it.default.hasFontFamily(K)&&(R=it.default.getFontFamily(K));return}const ut={};let Mt=!1;if(it.default.hasFontFamily(K)&&(Mt=!0,ut.fontFamily=it.default.getFontFamily(K)),it.default.hasFontStyle(K)&&(Mt=!0,ut.italic=it.default.getFontStyle(K)===at.A.ITALIC),it.default.hasFontWeight(K)&&(Mt=!0,ut.bold=it.default.getFontWeight(K)===Ot.A.BOLD),it.default.hasFontSize(K)){Mt=!0;const qt=it.default.getFontSize(K),N=ur.A.getFloat(qt),T=(0,ui.L)(qt);ut.fontSize={value:N,unit:T}}Mt&&G.set(Q,ut)});const q=Hi(G,R);return R=R||ci.S,{defaultFontFamily:R,fontsMap:q}}function Co(v){return v.isDisplayModeEnabled(oe.A.NOTE_SHAPES)?pe.A.SHAPE:v.isDisplayModeEnabled(oe.A.PITCHES_NAMES)?pe.A.NAMES:v.isDisplayModeEnabled(oe.A.SOLFEGE_SI)?pe.A.SOLFEGE_SI:v.isDisplayModeEnabled(oe.A.SOLFEGE_TI)?pe.A.SOLFEGE_TI:v.isDisplayModeEnabled(oe.A.SOLFEGE_JAPANESE)?pe.A.SOLFEGE_JAPANESE:pe.A.NORMAL}function To(v){const R=v.getSystemBreakPolicy(),G=v.hasPickupShift(),q=new $t.A(R,G);let Q=1;v.hasMeasureNumberingStart()&&(Q=v.getMeasureNumberingStart());let K=1;v.hasPageNumberingStart()&&(K=v.getPageNumberingStart());const ut=v.getMeasureNumberingPolicy(),Mt=v.getHideEmptyParts(),qt=v.getJazzChordPartConfigOrDefault(),N=!v.isTempoMarkVisible(),T=v.getNotesColorMode(),Dt=Co(v),I=!v.isDisplayModeEnabled(oe.A.MOVABLE_DO),{quarterToSpaceRatio:Ft,minSpaceBetweenNotes:rt}=xs(v),{defaultFontFamily:ue,fontsMap:Fo}=_i(v),Uo=v.scaleToMillimeters(10),yr={spaceBetweenSystems:v.getDistanceBetweenSystems()/10,spaceBetweenStaves:v.getDistanceBetweenStaves()/10,maxMeasuresInFirstSystem:q.getFirstMaxNbMeasuresPerLine(),maxMeasuresInOtherSystems:q.getMaxNbMeasuresPerLine(),hasPickup:G,measureNumberingStart:Q,pageNumberingStart:K,measureNumberingPolicy:ut,quarterToSpaceRatio:Ft,minSpaceBetweenNotes:rt,hideEmptyPartsPolicy:Mt,jazzChordPartConfig:qt,hideTempoMarkings:N,pitchColor:Nt.A.getMode(T),pitchGlyph:Dt,isFixedDo:I,spaceSizeMm:Uo,defaultFontFamily:ue,fontsMap:Fo},Ar=Nt.A.getColorOptions(T);return Ar&&(yr.pitchColorOptions=Ar),yr}function Ro(v,R){return R?we(v,R):Wr(v)}function Wr(v){const R=[],G=v.getNbMeasures(),q=v.getCommonContent();for(let Q=0;Q<G;Q++){const K=dr(Q,v,q);R.push(K)}return R}function we(v,R){const G=v.getCommonContent();return R.map(q=>dr(q,v,G))}function dr(v,R,G){const q=R.getMeasureUuid(v),Q=R.getMeasure(0,v),K=xt.default.getQuarterDuration(Q);let ut=1;return G.hasMultiMeasureRest(v)&&(ut=G.getMultiMeasureRest(v)),{uuid:q,quarterDuration:K,nbMeasures:ut}}var Ve=b(383279),fs=b(104907),is=b(164059);function di(v,R){const G=v.getNbParts(),q=[];for(let Q=0;Q<G;Q++){const K=v.getPartHeader(Q),ut=Ve.default.getUuid(K);if(R.partsList&&!R.partsList.includes(ut))continue;const Mt=Ve.default.getName(K);let qt=Mt;Ve.default.hasAbbreviation(K)&&(qt=Ve.default.getAbbreviation(K));const N=bs(v,Q,R),T=N.map((rt,ue)=>(ue===1&&(0,is.pS)(N[ue])&&(ue=0),v.getPartStaffVoicesIndexes(Q,ue).slice())),Dt=Ve.default.getVoiceIdxToUuidMapping(K),I=new Map(Array.from(Object.entries(Dt)).map(([rt,ue])=>[Number.parseInt(rt,10),ue])),Ft=fi(Q,K,ut,v,R.partsList);q.push({shortName:qt,longName:Mt,staves:N,stavesVoices:T,voiceUuidMapping:I,uuid:ut,isGroupedWithPrevious:Ft})}return q}function fi(v,R,G,q,Q){const K=Ve.default.isGroupedWithPrevious(R);if(!Q||v===0)return K;const ut=Q.findIndex(Ft=>Ft===G);if(ut===0)return K;const Mt=q.getPartHeader(v-1),qt=Ve.default.getUuid(Mt),N=q.getPartIdxFromUuid(Q[ut-1]),T=q.getPartHeader(N),Dt=Ve.default.getUuid(T);return qt===Dt||Ve.default.isGroupedWithPrevious(T)?K:!1}function bs(v,R,G){const q=v.getMeasure(R,0),[Q]=xt.default.getStaffDetails(q);if(v.isPartTab(R)){const K=v.getPartStaffUuid(R,0),ut=fs.default.getNbStaffLines(Q),Mt=[(0,is.aI)(ut,K)];if(!G.hideNonTab){const qt=(0,is.AK)(K);Mt.unshift(qt)}return Mt}else if(fs.default.hasRecorderTabs(Q)){const K=v.getPartStaffUuid(R,0),ut=[(0,is.w8)(K)],Mt=(0,is.AK)(K);return ut.unshift(Mt),ut}else if(fs.default.hasKodaly(Q)){const K=v.getPartStaffUuid(R,0),ut=[(0,is.zM)(K)];if(!G.hideNonKodaly){const Mt=(0,is.AK)(K);ut.unshift(Mt)}return ut}else{const K=v.getPartNbStaves(R),ut=[];for(let Mt=0;Mt<K;Mt++){const qt=v.getPartStaffUuid(R,Mt),N=(0,is.AK)(qt);ut.push(N)}return ut}}var pt=b(306563),Pn=b(928816);function zr(v){return`${v.fontFamily}-${v.bold}-${v.italic}`}function gi(v,R){const G=v.getMusicFont(),q=[{fontFamily:R.defaultFontFamily,bold:!1,italic:!1},{fontFamily:R.defaultFontFamily,bold:!0,italic:!1},{fontFamily:R.defaultFontFamily,bold:!1,italic:!0},{fontFamily:R.defaultFontFamily,bold:!0,italic:!0}],Q=new Map(q.map(ut=>[zr(ut),ut]));ye.default.values.forEach(ut=>{if(ut===ye.default.GLOBAL)return;const{fontFamily:Mt,bold:qt,italic:N}=(0,Pn.A)(R.fontsMap,R.spaceSizeMm,ut),T={fontFamily:Mt,bold:qt,italic:N},Dt=zr(T);Q.set(Dt,T)});const K=Array.from(Q.values());return K.sort(pt.UD),{musicFont:G,textFonts:K}}var Gi=Object.defineProperty,Xi=Object.getOwnPropertySymbols,No=Object.prototype.hasOwnProperty,En=Object.prototype.propertyIsEnumerable,Wi=(v,R,G)=>R in v?Gi(v,R,{enumerable:!0,configurable:!0,writable:!0,value:G}):v[R]=G,te=(v,R)=>{for(var G in R||(R={}))No.call(R,G)&&Wi(v,G,R[G]);if(Xi)for(var G of Xi(R))En.call(R,G)&&Wi(v,G,R[G]);return v};function Lo(v,R){const G=v.getEditionId(),q=di(v,R),Q=te(te({},To(v)),R),K=he(v),ut=_(v),Mt=Ro(v,R.measuresPlayOrder||null),qt=gi(v,Q),N=Ct(v);return{versionId:G,parts:q,measures:Mt,layout:Q,credits:K,displayMetrics:ut,resources:qt,displayMeasureIdxMap:N}}var F=b(61122),pi=b(522117),St=b(177150),Dn=b(546513),Cn=b(453557),fr=b(435648),Tn=b(78750),Mo=b(280958),Rn=b(476943),gr=b(857579);function Yr(v,R){const G=new gr.A(v),q=Oo(G);let Q=xt.default.getAttributes(v);Q=structuredClone(Q);const K={};return xt.default.setAttributes(K,Q),{measureJson:K,voices:q,displayedTime:R}}function Oo(v){const R=v.getVoicesIndexes(),G={};return R.forEach(q=>{const Q=v.getVoice(q),K=Rn.default.makeArray(Q.getChord(0)),ut=Q.getNbNotes(),Mt=Rn.default.makeArray(Q.getChord(ut-1));G[q]={firstChord:K,lastChord:Mt}}),G}var Bo=Object.defineProperty,Ke=(v,R,G)=>R in v?Bo(v,R,{enumerable:!0,configurable:!0,writable:!0,value:G}):v[R]=G,ks=(v,R,G)=>Ke(v,typeof R!="symbol"?R+"":R,G);class pr{constructor(R,{hideNonTab:G,hideNonKodaly:q}){ks(this,"scoreData"),ks(this,"measuresMap",new Map),ks(this,"adjacentMeasureData",new Map),ks(this,"hideNonTab"),ks(this,"hideNonKodaly"),this.scoreData=R,this.hideNonTab=G,this.hideNonKodaly=q}replaceScoreData(R){this.scoreData=R,this.clearCache()}clearCache(){this.adjacentMeasureData.clear(),this.measuresMap.clear()}getMeasureData(R,G){const q=this.scoreData.getMeasureUuid(G),Q=this.getMeasureJson(R,G),K=this.scoreData.getCommonContent();let ut=1;K.hasMultiMeasureRest(G)&&(ut=K.getMultiMeasureRest(G));const Mt=K.getDisplayedTime(G),qt=this.getAdjacentMeasureData(R,G-1),N=this.getAdjacentMeasureData(R,G+1);return{measureUuid:q,measureJson:Q,nbMmr:ut,displayedTime:Mt,previousMeasureData:qt,nextMeasureData:N}}getAdjacentMeasureData(R,G){if(G<0)return null;const q=this.scoreData.getNbMeasures();if(G>=q)return null;const Q=pr.createKey(R,G),K=this.adjacentMeasureData.get(Q);if(K)return K;const Mt=this.scoreData.getCommonContent().getDisplayedTime(G),qt=this.getMeasureJson(R,G),N=Yr(qt,Mt);return this.adjacentMeasureData.set(Q,N),N}getMeasureJson(R,G){const q=pr.createKey(R,G);let Q=this.measuresMap.get(q);if(!Q){Q=this.scoreData.getMeasure(R,G),Q=structuredClone(Q),Mo.A.call({},Q);const K=this.scoreData.getPartHeader(R);if(Ve.default.hasPitchRange(K)){const ut=Ve.default.getPitchRange(K);(0,F.A)(Q,ut)}if(pi.A.canShape(Q)){const ut=this.scoreData.getCommonContent();pi.A.shapeMeasure(Q,G,ut)}if(St.A.shapeMeasure(Q),Cn.A.canShape(Q)&&Cn.A.shapeMeasure(Q),Tn.A.canShape(Q)){const ut={hideNonTab:this.hideNonTab};Tn.A.shapeMeasure(Q,ut)}if(fr.A.canShape(Q)&&fr.A.shapeMeasure(Q),Dn.A.canShape(Q)){const ut={hideNonKodaly:this.hideNonKodaly};Dn.A.shapeMeasure(Q,ut)}this.measuresMap.set(q,Q)}return Q}static createKey(R,G){return`${R}-${G}`}}var mr=Object.defineProperty,zi=(v,R,G)=>R in v?mr(v,R,{enumerable:!0,configurable:!0,writable:!0,value:G}):v[R]=G,Ps=(v,R,G)=>zi(v,typeof R!="symbol"?R+"":R,G),mi=(v,R,G)=>new Promise((q,Q)=>{var K=qt=>{try{Mt(G.next(qt))}catch(N){Q(N)}},ut=qt=>{try{Mt(G.throw(qt))}catch(N){Q(N)}},Mt=qt=>qt.done?q(qt.value):Promise.resolve(qt.value).then(K,ut);Mt((G=G.apply(v,R)).next())});class Io{constructor(R,G,q){Ps(this,"scoreData"),Ps(this,"displayOptions"),Ps(this,"cursorRequest"),Ps(this,"structure",null),Ps(this,"currentVersionId"),Ps(this,"partMeasureDataProvider"),Ps(this,"fullRedrawCallback",null),Ps(this,"displayUpdateCallback",null),Ps(this,"cursorRequestCallback",null),this.scoreData=R,this.displayOptions=G,this.cursorRequest=q,this.partMeasureDataProvider=new pr(this.scoreData,{hideNonTab:!!this.displayOptions.hideNonTab,hideNonKodaly:!!this.displayOptions.hideNonKodaly}),this.currentVersionId=R.getEditionId()}registerOnFullRedraw(R){this.fullRedrawCallback=R}registerOnDisplayUpdate(R){this.displayUpdateCallback=R}getStructure(){return mi(this,null,function*(){return this.getStructureSync()})}getStructureSync(){const R=this.scoreData.getEditionId();return this.currentVersionId!==R&&(this.currentVersionId=R,this.structure=null,this.partMeasureDataProvider.clearCache()),this.structure===null&&(this.structure=Lo(this.scoreData,this.displayOptions)),this.structure}requestData(R){return mi(this,null,function*(){return this.requestDataSync(R)})}requestDataSync(R){if(R.versionId!==this.currentVersionId)return{isMissingData:!0,versionId:this.currentVersionId,layoutData:null,measuresHeaders:[],partsHeaders:[],measures:[]};const G=this.getStructureSync(),q=new Map(G.parts.map(N=>[N.uuid,this.scoreData.getPartIdxFromUuid(N.uuid)])),Q=this.scoreData.getMeasuresHeaders(),K=new Map(Q.map((N,T)=>[V.A.getUuid(N),T])),ut=this.scoreData.getCommonContent(),Mt=R.measuresHeaders.map(N=>{const T=K.get(N);if(T===void 0)throw new Error(`Unknown measure uuid: ${N}`);const Dt=ct(ut,T,N);return{uuid:N,payload:Dt}}),qt=R.measures.map(({partUuid:N,measureUuid:T})=>{const Dt=q.get(N);if(Dt===void 0)throw new Error(`Unknown part uuid: ${N}`);const I=K.get(T);if(I===void 0)throw new Error(`Unknown measure uuid: ${T}`);const Ft=this.partMeasureDataProvider.getMeasureData(Dt,I);return{partUuid:N,measureUuid:T,payload:Ft}});return{isMissingData:!1,versionId:this.currentVersionId,layoutData:null,measuresHeaders:Mt,partsHeaders:[],measures:qt}}replaceDisplayOptions(R){if(this.displayOptions=R,this.structure=null,this.partMeasureDataProvider.replaceScoreData(this.scoreData),this.currentVersionId=this.scoreData.getEditionId(),this.fullRedrawCallback){const G=this.getStructureSync();this.fullRedrawCallback(G)}}replaceScoreData(R){if(this.scoreData=R,this.structure=null,this.partMeasureDataProvider.replaceScoreData(R),this.currentVersionId=R.getEditionId(),this.fullRedrawCallback){const G=this.getStructureSync();this.fullRedrawCallback(G)}}sendDataUpdate(R){if(R.needCompleteRedraw()){if(R.stateCompleteRedrawDone(),this.fullRedrawCallback){const G=this.getStructureSync();this.fullRedrawCallback(G)}return}if(this.displayUpdateCallback){const G=this.getStructureSync(),q=ze(G,R);this.displayUpdateCallback({scoreStructure:G,displayUpdates:q})}}getCursorRequest(){return Promise.resolve(this.cursorRequest)}registerOnCursorRequest(R){this.cursorRequestCallback=R}replaceCursorRequest(R,G){this.cursorRequest=R,this.cursorRequestCallback&&this.cursorRequestCallback(R,G)}}},483088:(ae,Et,b)=>{b.d(Et,{A:()=>Tt});var V=Object.defineProperty,U=(tt,j,vt)=>j in tt?V(tt,j,{enumerable:!0,configurable:!0,writable:!0,value:vt}):tt[j]=vt,X=(tt,j,vt)=>U(tt,typeof j!="symbol"?j+"":j,vt);class Tt{constructor(j){X(this,"pathProvider"),X(this,"cache"),this.pathProvider=j,this.cache=new Map}getPath(j,vt){const xt=Tt.createKey(j,vt);let k=this.cache.get(xt);return k||(k=this.pathProvider.getPath(j,vt),this.cache.set(xt,k)),k}static createKey(j,vt){return`${j}:${vt}`}}},485736:(ae,Et,b)=>{b.d(Et,{AM:()=>U,AW:()=>Tt,LM:()=>tt,Zz:()=>V,bc:()=>X});const V=1,U=.3,X=1,Tt=.5,tt=1},574459:(ae,Et,b)=>{b.d(Et,{Ay:()=>Tt,RC:()=>X,yT:()=>U});var V=(tt=>(tt.WHOLE="whole",tt.HALF="half",tt.QUARTER="quarter",tt))(V||{});function U(tt){switch(tt){case"whole":return 4;case"half":return 2;case"quarter":return 1}}function X(tt){switch(tt){case 4:return"whole";case 2:return"half";default:return"quarter"}}const Tt=V},580109:(ae,Et,b)=>{b.d(Et,{A:()=>Lt});var V=b(304713);function U(Ut,J){const et=new Map(J.measures.map((Gt,jt)=>[Gt.uuid,jt]));Ut.forEach(Gt=>{if(Gt.type!==V.A.UPDATE_GLOBAL_MEASURE)return;const jt=et.get(Gt.measureUuid);if(jt===void 0)throw new Error(`Measure with uuid ${Gt.measureUuid} not found`);Gt.measureData=structuredClone(J.measures[jt])})}var X=b(771997);function Tt(Ut){const{formerScoreStructure:J,newScoreStructure:et}=Ut,Gt=new Set(J.parts.map(Ct=>Ct.uuid)),kt=et.parts.map((Ct,he)=>({partIdx:he,part:Ct})).filter(Ct=>!Gt.has(Ct.part.uuid)).map(Ct=>({type:V.A.ADD_PART,partIdx:Ct.partIdx,data:Ct.part,partsMeasure:J.measures.map(Qt=>Qt.uuid)})),fe=new Set(J.parts.flatMap(Ct=>{const he=Ct.uuid;return Ct.staves.flatMap((Qt,_)=>{const Nt=Qt.uuid;return Ct.stavesVoices[_].map($t=>{const pe=Ct.voiceUuidMapping.get($t);if(pe===void 0)throw new Error(`Voice UUID not found for index ${$t} in part ${he}`);return`${he}-${Nt}-${pe}`})})})),ge=et.parts.flatMap(Ct=>{const he=Ct.uuid;return Ct.staves.flatMap((Qt,_)=>{const Nt=Qt.uuid,oe=Ct.stavesVoices[_],$t=[];return oe.forEach((pe,He)=>{const bt=Ct.voiceUuidMapping.get(pe);if(bt===void 0)throw new Error(`Voice UUID not found for index ${pe} in part ${he}`);const xs=`${he}-${Nt}-${bt}`;if(!fe.has(xs)){const it={type:V.A.ADD_VOICE,partUuid:he,staffUuid:Nt,idxInStaff:He,voiceUuid:bt,voiceIdx:pe};$t.push(it)}}),$t})}),ne=new Set(J.measures.map(Ct=>Ct.uuid)),ze=et.measures.map((Ct,he)=>({measureIdx:he,measure:Ct})).filter(Ct=>!ne.has(Ct.measure.uuid)).map(Ct=>({type:V.A.ADD_MEASURE,measureIdx:Ct.measureIdx,data:Ct.measure,globalMeasureData:null,partsMeasure:et.parts.map(Qt=>Qt.uuid)}));return[...kt,...ze,...ge]}function tt(Ut){const{formerScoreStructure:J,newScoreStructure:et}=Ut,Gt=new Set(et.parts.map(Ct=>Ct.uuid)),kt=J.parts.map(Ct=>Ct.uuid).filter(Ct=>!Gt.has(Ct)).map(Ct=>({type:V.A.REMOVE_PART,partUuid:Ct})),fe=new Set(et.parts.flatMap(Ct=>{const he=Ct.uuid;return Ct.staves.flatMap((Qt,_)=>{const Nt=Qt.uuid;return Ct.stavesVoices[_].map($t=>{const pe=Ct.voiceUuidMapping.get($t);if(pe===void 0)throw new Error(`Voice UUID not found for index ${$t} in part ${he}`);return`${he}-${Nt}-${pe}`})})})),ge=J.parts.flatMap(Ct=>{const he=Ct.uuid;return Ct.staves.flatMap((Qt,_)=>{const Nt=Qt.uuid,oe=Ct.stavesVoices[_],$t=[];return oe.forEach(pe=>{const He=Ct.voiceUuidMapping.get(pe);if(He===void 0)throw new Error(`Voice UUID not found for index ${pe} in part ${he}`);const bt=`${he}-${Nt}-${He}`;if(!fe.has(bt)){const xs={type:V.A.REMOVE_VOICE,partUuid:he,staffUuid:Nt,voiceUuid:He,voiceIdx:pe};$t.push(xs)}}),$t})}),ne=new Set(et.measures.map(Ct=>Ct.uuid)),ze=J.measures.map(Ct=>Ct.uuid).filter(Ct=>!ne.has(Ct)).map(Ct=>({type:V.A.REMOVE_MEASURE,measureUuid:Ct}));return[...kt,...ze,...ge]}var j=b(267811),vt=Object.defineProperty,xt=(Ut,J,et)=>J in Ut?vt(Ut,J,{enumerable:!0,configurable:!0,writable:!0,value:et}):Ut[J]=et,k=(Ut,J,et)=>xt(Ut,typeof J!="symbol"?J+"":J,et),ct=(Ut,J,et)=>new Promise((Gt,jt)=>{var kt=ne=>{try{ge(et.next(ne))}catch(Oe){jt(Oe)}},fe=ne=>{try{ge(et.throw(ne))}catch(Oe){jt(Oe)}},ge=ne=>ne.done?Gt(ne.value):Promise.resolve(ne.value).then(kt,fe);ge((et=et.apply(Ut,J)).next())});class Lt{constructor(J){k(this,"queue"),k(this,"dataProvider"),k(this,"renderers"),k(this,"abstractRenderer"),k(this,"cursorRequest",null),k(this,"structure",null),k(this,"partIdxMapping",null),k(this,"measureIdxMapping",null),k(this,"fullRedrawCallback",null),k(this,"displayUpdateCallback",null),k(this,"cursorRequestCallback",null),this.queue=J.queue,this.dataProvider=J.dataProvider,this.renderers=J.renderers,this.abstractRenderer=J.abstractRenderer,this.connect(),this.queue.add(()=>ct(this,null,function*(){this.structure=yield this.dataProvider.getStructure(),this.cursorRequest=yield this.dataProvider.getCursorRequest();const{structure:et}=this;this.renderers.forEach(Gt=>Gt.setScoreStructure(et)),this.abstractRenderer.setScoreStructure(et)}))}connect(){this.dataProvider.registerOnFullRedraw(this.onFullRedraw.bind(this)),this.dataProvider.registerOnDisplayUpdate(this.onDisplayUpdate.bind(this)),this.dataProvider.registerOnCursorRequest(this.onCursorRequest.bind(this))}registerOnFullRedraw(J){this.fullRedrawCallback=J}registerOnDisplayUpdate(J){this.displayUpdateCallback=J}registerOnCursorRequest(J){this.cursorRequestCallback=J}onFullRedraw(J){this.queue.add(()=>this._onFullRedraw(J))}_onFullRedraw(J){return ct(this,null,function*(){this.setScoreStructure(J),this.abstractRenderer.setScoreStructure(J),this.renderers.forEach(et=>et.setScoreStructure(J)),this.fullRedrawCallback&&this.fullRedrawCallback(J)})}onDisplayUpdate(J){this.queue.add(()=>this._onDisplayUpdate(J))}_onDisplayUpdate(J){return ct(this,null,function*(){if(this.structure===null)return;const{scoreStructure:et}=J;let{displayUpdates:Gt}=J;const jt=this.structure;j.n("processUpdateData"),Gt=(0,X.A)(Gt,jt),U(Gt,et);const kt=tt({formerScoreStructure:jt,newScoreStructure:et}),fe=Tt({formerScoreStructure:jt,newScoreStructure:et}),ge=[...kt,...fe,...Gt];j.d("processUpdateData"),this.abstractRenderer.setScoreUpdate({updates:ge,scoreStructure:et}),this.setScoreStructure(et),this.displayUpdateCallback&&this.displayUpdateCallback({newStructure:et,updates:ge,oldStructure:jt})})}setScoreStructure(J){this.structure=J,this.partIdxMapping=null,this.measureIdxMapping=null}getScoreStructure(){if(!this.structure)throw new Error("Score structure not set");return this.structure}getMeasureIdxFromUuid(J){const Gt=this.getMeasureIdxMapping().get(J);if(Gt===void 0)throw new Error(`Measure with uuid ${J} not found`);return Gt}getPartIdxMapping(){if(this.partIdxMapping===null){if(this.structure===null)throw new Error("Structure is not set");this.partIdxMapping=new Map(this.structure.parts.map((J,et)=>[J.uuid,et]))}return this.partIdxMapping}getMeasureIdxMapping(){if(this.measureIdxMapping===null){if(this.structure===null)throw new Error("Structure is not set");this.measureIdxMapping=new Map(this.structure.measures.map((J,et)=>[J.uuid,et]))}return this.measureIdxMapping}getCursorRequest(){if(!this.cursorRequest)throw new Error("Cursor request not set");return this.cursorRequest}onCursorRequest(J,et){this.cursorRequest=J,et&&this.cursorRequestCallback&&this.queue.add(()=>this._onCursorRequest())}_onCursorRequest(){return ct(this,null,function*(){if(this.cursorRequestCallback){const J=this.getCursorRequest();this.cursorRequestCallback(J)}})}}},603371:(ae,Et,b)=>{b.d(Et,{A:()=>U});var V=b(92856);function U(j,vt,xt){const k=X(j,vt,xt);tt(j,k)}function X(j,vt,xt){const k=[];let ct=null,Lt=j.getAvailableWidth();const Ut=j.getMaxNbMeasures(),J=vt.length;for(;xt<J;xt++){const et=vt[xt];let Gt;if(ct!==null){if(Ut!==null&&k.length>=Ut||Lt!==null&&(et.hasSystemBreakBefore()||et.hasPageBreakBefore())||Lt!==null&&(ct.hasSystemBreakAfter()||ct.hasPageBreakAfter()))break;et.getPosition()===null&&et.setPosition(V.A.MIDDLE),Gt=et.getNominalWidthMidSystem()}else{const jt=Tt(j);et.setPosition(jt),Gt=et.getNominalWidth()}if(ct!==null&&Lt!==null&&Gt>Lt)break;ct!==null&&et.setPosition(V.A.MIDDLE),k.push(et),ct=et,Lt!==null&&(Lt-=Gt)}return k}function Tt(j){return j.isFirst?V.A.FIRST_OF_SCORE:V.A.FIRST_OF_SYSTEM}function tt(j,vt){j.measures.filter(ct=>!vt.includes(ct)).forEach(ct=>j.removeMeasure(ct));let k=0;vt.forEach((ct,Lt)=>{ct.parent===null?j.addMeasureAt(ct,Lt):ct.parent!==j?(ct.parent.removeMeasure(ct),j.addMeasureAt(ct,Lt)):ct.hasUpdatedPartsFlag&&j.updateMeasureAt(ct,Lt),k+=ct.getNominalWidth()}),j.currentWidth=k}},627252:(ae,Et,b)=>{b.d(Et,{Z:()=>V});var V=(U=>(U.MOVE_TO="M",U.LINE_TO="L",U.QUAD_CURVE_TO="Q",U.CUBIC_CURVE_TO="C",U.REFLECT_CUBIC_CURVE_TO="S",U.CLOSE_PATH="Z",U))(V||{})},635258:(ae,Et,b)=>{b.d(Et,{A:()=>U});var V=(X=>(X.CREDITS="credits",X.SYSTEM_HEADER="system-header",X.SYSTEM_CONTENT="system-content",X.PINCH="pinch-zoom",X))(V||{});const U=V},663060:(ae,Et,b)=>{b.d(Et,{A:()=>DX});var V=Object.defineProperty,U=(s,t,e)=>t in s?V(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,X=(s,t,e)=>U(s,typeof t!="symbol"?t+"":t,e);class Tt{constructor(t){X(this,"map"),this.map=new Map,t.forEach(e=>{const r=Tt.getKey(e.id,e.size);this.map.set(r,e)})}static getKey(t,e){return`${t}:${e}`}getGlyph(t,e){const r=Tt.getKey(t,e);let i=this.map.get(r);if(i)return i;if(e===1)throw new Error(`Glyph not found: ${t}`);const a=this.getGlyph(t,1);if(!a)throw new Error(`Glyph not found: ${t}`);return i=a.getScaled(e),this.map.set(r,i),i}}var tt=Object.defineProperty,j=(s,t,e)=>t in s?tt(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,vt=(s,t,e)=>j(s,typeof t!="symbol"?t+"":t,e);class xt{constructor(t,e){vt(this,"context"),vt(this,"id"),vt(this,"parent"),vt(this,"x"),vt(this,"y"),vt(this,"destroyed"),vt(this,"takeSpaceValue"),vt(this,"eventPayload",null),vt(this,"noClone"),this.context=t,this.id=e,this.parent=null,this.x=0,this.y=0,this.destroyed=!1,this.takeSpaceValue=!0}setLabel(t){this.context.editsRecorder.recordSetLabel(this.id,t)}setX(t){this.x=t,this.context.editsRecorder.recordSetX(this.id,t)}setY(t){this.y=t,this.context.editsRecorder.recordSetY(this.id,t)}getX(){return this.x}getY(){return this.y}setTakeSpace(t){this.takeSpaceValue=t}takeSpace(){return this.takeSpaceValue}setParent(t){this.parent=t}getParent(){return this.parent}removeParent(){this.parent=null}destroy(){if(!this.destroyed){if(this.parent!==null)throw new Error("The node is still attached to a parent");this.destroyed=!0,this.context.editsRecorder.recordDestroyNode(this.id),this.context.idProvider.returnId(this.id)}}getId(){return this.id}getContextPtr(){return this.context}getLocalSubBBoxes(){return null}hasEventPayload(){return this.eventPayload!==null}setEventPayload(t){this.eventPayload=t}getEventPayload(){return this.eventPayload}}var k=b(627252),ct=Object.defineProperty,Lt=(s,t,e)=>t in s?ct(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ut=(s,t,e)=>Lt(s,typeof t!="symbol"?t+"":t,e);class J extends xt{constructor(t,e,r){super(t,e),Ut(this,"height"),Ut(this,"x2",0),Ut(this,"y2",0),Ut(this,"color","black"),this.height=r,this.color="black"}setX2(t){this.x2=t}setY2(t){this.y2=t}updatePath(){const t=[[k.Z.LINE_TO,this.x2,this.y2],[k.Z.LINE_TO,this.x2,this.y2+this.height],[k.Z.LINE_TO,0,this.height],[k.Z.LINE_TO,0,0]];this.context.editsRecorder.recordSetPath(this.id,t)}getBBox(){const t=this.getLocalBBox();return{minX:this.x+t.minX,maxX:this.x+t.maxX,minY:this.y+t.minY,maxY:this.y+t.maxY}}getLocalBBox(){return{minX:Math.min(0,this.x2),maxX:Math.max(0,this.x2),minY:Math.min(0,this.y2),maxY:Math.max(0,this.y2+this.height)}}setColor(t){this.color=t,this.context.editsRecorder.recordSetColor(this.id,t)}setMixBlendMode(t){this.context.editsRecorder.recordSetMixBlendMode(this.id,t)}setLabel(t){this.context.editsRecorder.recordSetLabel(this.id,t)}}var et=Object.defineProperty,Gt=(s,t,e)=>t in s?et(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,jt=(s,t,e)=>Gt(s,typeof t!="symbol"?t+"":t,e);class kt extends xt{constructor(t,e,r){super(t,e),jt(this,"radius"),jt(this,"color","black"),jt(this,"width",0),jt(this,"blur",0),jt(this,"strokeColor","black"),jt(this,"fillRule","nonzero"),this.radius=r}setColor(t){this.color=t,this.context.editsRecorder.recordSetColor(this.id,t)}setBlur(t){this.blur=t,this.context.editsRecorder.recordSetBlur(this.id,t)}setStrokeColor(t){this.color=t,this.context.editsRecorder.recordSetStrokeColor(this.id,t)}setWidth(t){this.width=t,this.context.editsRecorder.recordSetStrokeWidth(this.id,t)}getBBox(){const t=this.getLocalBBox();return{minX:this.x+t.minX,maxX:this.x+t.maxX,minY:this.y+t.minY,maxY:this.y+t.maxY}}getLocalBBox(){return{minX:-this.radius,maxX:this.radius,minY:-this.radius,maxY:this.radius}}}function fe(s){const t=[],e=[[],[]];let r,i,a,l,d,f,m,S;for(let L=0;L<2;++L){if(L===0?(i=6*s[0].x-12*s[1].x+6*s[2].x,r=-3*s[0].x+9*s[1].x-9*s[2].x+3*s[3].x,a=3*s[1].x-3*s[0].x):(i=6*s[0].y-12*s[1].y+6*s[2].y,r=-3*s[0].y+9*s[1].y-9*s[2].y+3*s[3].y,a=3*s[1].y-3*s[0].y),Math.abs(r)<1e-12){if(Math.abs(i)<1e-12)continue;l=-a/i,0<l&&l<1&&t.push(l);continue}m=i*i-4*a*r,S=Math.sqrt(m),!(m<0)&&(d=(-i+S)/(2*r),0<d&&d<1&&t.push(d),f=(-i-S)/(2*r),0<f&&f<1&&t.push(f))}let w=t.length,x;const D=w;for(;w--;)l=t[w],x=1-l,e[0][w]=x*x*x*s[0].x+3*x*x*l*s[1].x+3*x*l*l*s[2].x+l*l*l*s[3].x,e[1][w]=x*x*x*s[0].y+3*x*x*l*s[1].y+3*x*l*l*s[2].y+l*l*l*s[3].y;return e[0][D]=s[0].x,e[1][D]=s[0].y,e[0][D+1]=s[3].x,e[1][D+1]=s[3].y,e[0].length=e[1].length=D+2,{minX:Math.min.apply(0,e[0]),minY:Math.min.apply(0,e[1]),maxX:Math.max.apply(0,e[0]),maxY:Math.max.apply(0,e[1])}}function ge(s,t,e,r,i){return Math.pow(1-s,3)*t+3*Math.pow(1-s,2)*s*e+3*(1-s)*Math.pow(s,2)*r+Math.pow(s,3)*i}var ne=Object.defineProperty,Oe=(s,t,e)=>t in s?ne(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,ze=(s,t,e)=>Oe(s,typeof t!="symbol"?t+"":t,e);const Ct=.5;class he extends xt{constructor(t,e,r,i){super(t,e),ze(this,"leftControlPoint",{x:0,y:0}),ze(this,"rightControlPoint",{x:0,y:0}),ze(this,"endPoint",{x:0,y:0}),ze(this,"edgeThickness"),ze(this,"midThickness"),ze(this,"localBbox",null),ze(this,"subBBoxes",null),ze(this,"color","black"),this.edgeThickness=r,this.midThickness=i}setPoints(t,e,r){this.localBbox=null,this.subBBoxes=null,this.leftControlPoint=t,this.rightControlPoint=e,this.endPoint=r;const i=this.getPath();this.context.editsRecorder.recordSetPath(this.id,i)}setColor(t){this.color=t,this.context.editsRecorder.recordSetColor(this.id,t)}getPath(){return[[k.Z.LINE_TO,0,-this.edgeThickness/2],[k.Z.CUBIC_CURVE_TO,this.leftControlPoint.x,this.leftControlPoint.y-this.midThickness/2,this.rightControlPoint.x,this.rightControlPoint.y-this.midThickness/2,this.endPoint.x,this.endPoint.y-this.edgeThickness/2],[k.Z.LINE_TO,this.endPoint.x,this.endPoint.y+this.edgeThickness/2],[k.Z.CUBIC_CURVE_TO,this.rightControlPoint.x,this.rightControlPoint.y+this.midThickness/2,this.leftControlPoint.x,this.leftControlPoint.y+this.midThickness/2,0,this.edgeThickness/2],[k.Z.LINE_TO,0,0]]}getBBox(){const t=this.getLocalBBox();return{minX:this.x+t.minX,maxX:this.x+t.maxX,minY:this.y+t.minY,maxY:this.y+t.maxY}}getLocalBBox(){return this.localBbox===null&&(this.localBbox=this.calcLocalBBbox()),this.localBbox}calcLocalBBbox(){return this.endPoint.x===0?{minX:0,maxX:0,minY:0,maxY:0}:fe([{x:0,y:0},{x:this.leftControlPoint.x,y:this.leftControlPoint.y},{x:this.rightControlPoint.x,y:this.rightControlPoint.y},{x:this.endPoint.x,y:this.endPoint.y}])}getLocalSubBBoxes(){return this.subBBoxes===null&&(this.subBBoxes=this.calcLocalSubBBoxes()),this.subBBoxes}calcLocalSubBBoxes(){if(this.endPoint.x===0)return null;const t=Math.ceil(this.endPoint.x/Ct),e=[],r=1/t;for(let i=0;i<t;i++){const a=i*r,l=(i+1)*r,d=[ge(a,0,this.leftControlPoint.x,this.rightControlPoint.x,this.endPoint.x),ge(l,0,this.leftControlPoint.x,this.rightControlPoint.x,this.endPoint.x)],f=this.edgeThickness/2,m=this.midThickness/2,S=[ge(a,f,this.leftControlPoint.y+m,this.rightControlPoint.y+m,this.endPoint.y+f),ge(l,f,this.leftControlPoint.y+m,this.rightControlPoint.y+m,this.endPoint.y+f),ge(a,-f,this.leftControlPoint.y-m,this.rightControlPoint.y-m,this.endPoint.y-f),ge(l,-f,this.leftControlPoint.y-m,this.rightControlPoint.y-m,this.endPoint.y-f)];e.push({minX:Math.min(...d),maxX:Math.max(...d),minY:Math.min(...S),maxY:Math.max(...S)})}return e}}var Qt=Object.defineProperty,_=(s,t,e)=>t in s?Qt(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Nt=(s,t,e)=>_(s,typeof t!="symbol"?t+"":t,e);class oe extends xt{constructor(t,e,r){super(t,e),Nt(this,"glyph"),Nt(this,"color","black"),Nt(this,"opacity",1),Nt(this,"width",0),Nt(this,"strokeColor","black"),Nt(this,"fillRule","nonzero"),this.glyph=r}setColor(t){this.color=t,this.context.editsRecorder.recordSetColor(this.id,t)}setOpacity(t){this.opacity=t,this.context.editsRecorder.recordSetOpacity(this.id,t)}setStrokeColor(t){this.color=t,this.context.editsRecorder.recordSetStrokeColor(this.id,t)}setWidth(t){this.width=t,this.context.editsRecorder.recordSetStrokeWidth(this.id,t)}setFillRule(t){this.fillRule=t,this.context.editsRecorder.recordSetFillRule(this.id,t)}getWidth(){return this.glyph.width}getHeight(){return this.glyph.height}getMaxX(){return this.glyph.maxX}getMaxY(){return this.glyph.maxY}getMinY(){return this.glyph.minY}getBBox(){return{minX:this.x+this.glyph.minX,maxX:this.x+this.glyph.maxX,minY:this.y+this.glyph.minY,maxY:this.y+this.glyph.maxY}}getLocalBBox(){return{minX:this.glyph.minX,maxX:this.glyph.maxX,minY:this.glyph.minY,maxY:this.glyph.maxY}}}function $t(s,t){return{minX:Math.min(s.minX,t.minX),maxX:Math.max(s.maxX,t.maxX),minY:Math.min(s.minY,t.minY),maxY:Math.max(s.maxY,t.maxY)}}function pe(s,t){const r=He(s).map(i=>bt(i,t));return xs(r)}function He(s){return[{x:s.minX,y:s.minY},{x:s.maxX,y:s.minY},{x:s.maxX,y:s.maxY},{x:s.minX,y:s.maxY}]}function bt(s,t){const e=-t*(Math.PI/180),r=Math.cos(e),i=Math.sin(e);return{x:s.x*r-s.y*i,y:s.x*i+s.y*r}}function xs(s){const[t,...e]=s;let r=t.x,i=t.x,a=t.y,l=t.y;return e.forEach(d=>{r=Math.min(r,d.x),i=Math.max(i,d.x),a=Math.min(a,d.y),l=Math.max(l,d.y)}),{minX:r,maxX:i,minY:a,maxY:l}}function it(s,t){const e=t.getParent();if(!e)throw new Error("The child has no parent");if(s!==e)throw new Error("The child has a different parent");s.recordUnlinkNodes(t.getId()),s.removeChild(t),t.removeParent()}var ur=Object.defineProperty,at=(s,t,e)=>t in s?ur(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ot=(s,t,e)=>at(s,typeof t!="symbol"?t+"":t,e);class ye extends xt{constructor(){super(...arguments),Ot(this,"children",[]),Ot(this,"angle",null),Ot(this,"bboxOverride",null),Ot(this,"scalingY",1),Ot(this,"scalingX",1)}addChild(t){this.children.push(t)}removeChild(t){const e=this.children.indexOf(t);e!==-1&&this.children.splice(e,1)}recordAttachNodes(t){this.context.editsRecorder.recordAttachNodes(this.id,t)}recordUnlinkNodes(t){this.context.editsRecorder.recordUnlinkNodes(this.id,t)}getContextPtr(){return this.context}getBBox(){const t=this.getLocalBBox();return t===null?null:{minX:this.x+t.minX,maxX:this.x+t.maxX,minY:this.y+t.minY,maxY:this.y+t.maxY}}setRotation(t){this.angle=t,this.context.editsRecorder.recordSetRotation(this.id,t)}setScalingY(t){this.scalingY=t,this.context.editsRecorder.recordSetScalingY(this.id,t)}setScalingX(t){this.scalingX=t,this.context.editsRecorder.recordSetScalingX(this.id,t)}setMixBlendMode(t){this.context.editsRecorder.recordSetMixBlendMode(this.id,t)}getWidth(){const t=this.getLocalBBox();return t===null?0:t.maxX-t.minX}setBBoxOverride(t){this.bboxOverride=t}getLocalBBox(){if(this.bboxOverride!==null)return this.bboxOverride;const t=this.children.filter(r=>r.takeSpace()).map(r=>r.getBBox()).filter(r=>r!==null);if(t.length===0)return null;let e=t.reduce($t);return this.angle!==null&&(e=pe(e,this.angle)),e}destroy(){if(this.destroyed)return;this.children.slice().forEach(e=>{it(this,e),e.destroy()}),super.destroy()}}var ci=Object.defineProperty,ui=(s,t,e)=>t in s?ci(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ys=(s,t,e)=>ui(s,typeof t!="symbol"?t+"":t,e);class Hi extends xt{constructor(t,e){super(t,e),Ys(this,"color"),Ys(this,"x2"),Ys(this,"y2"),Ys(this,"width"),this.color="black",this.x2=0,this.y2=0,this.width=0}setStrokeColor(t){this.color=t,this.context.editsRecorder.recordSetStrokeColor(this.id,t)}setWidth(t){this.width=t,this.context.editsRecorder.recordSetStrokeWidth(this.id,t)}setX2(t){this.x2=t,this.context.editsRecorder.recordSetX2(this.id,t)}setY2(t){this.y2=t,this.context.editsRecorder.recordSetY2(this.id,t)}getBBox(){const t=this.getLocalBBox();return{minX:this.x+t.minX,maxX:this.x+t.maxX,minY:this.y+t.minY,maxY:this.y+t.maxY}}getLocalBBox(){return{minX:Math.min(0,this.x2),maxX:Math.max(0,this.x2),minY:Math.min(0,this.y2),maxY:Math.max(0,this.y2)}}}function _i(s){if(s.length===0)return{minX:0,maxX:0,minY:0,maxY:0};let t=Number.POSITIVE_INFINITY,e=Number.NEGATIVE_INFINITY,r=Number.POSITIVE_INFINITY,i=Number.NEGATIVE_INFINITY,a=0,l=0;for(const d of s){const[f,...m]=d;switch(f){case k.Z.MOVE_TO:{const[S,w]=m;t=Math.min(t,S),e=Math.max(e,S),r=Math.min(r,w),i=Math.max(i,w),a=S,l=w;break}case k.Z.LINE_TO:{const[S,w]=m;t=Math.min(t,a,S),e=Math.max(e,a,S),r=Math.min(r,l,w),i=Math.max(i,l,w),a=S,l=w;break}case k.Z.QUAD_CURVE_TO:{const[S,w,x,D]=m;t=Math.min(t,a,S,x),e=Math.max(e,a,S,x),r=Math.min(r,l,w,D),i=Math.max(i,l,w,D),a=x,l=D;break}case k.Z.CUBIC_CURVE_TO:{const[S,w,x,D,L,M]=m;t=Math.min(t,a,S,x,L),e=Math.max(e,a,S,x,L),r=Math.min(r,l,w,D,M),i=Math.max(i,l,w,D,M),a=L,l=M;break}case k.Z.REFLECT_CUBIC_CURVE_TO:{const[S,w,x,D]=m;t=Math.min(t,a,S,x),e=Math.max(e,a,S,x),r=Math.min(r,l,w,D),i=Math.max(i,l,w,D),a=x,l=D;break}case k.Z.CLOSE_PATH:break}}return{minX:t,maxX:e,minY:r,maxY:i}}const Co=_i;var To=Object.defineProperty,Ro=(s,t,e)=>t in s?To(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Wr=(s,t,e)=>Ro(s,typeof t!="symbol"?t+"":t,e);class we extends xt{constructor(t,e,r){super(t,e),Wr(this,"path",[]),Wr(this,"color","black"),this.path=r,this.context.editsRecorder.recordSetPath(this.id,r)}getPath(){return this.path}getBBox(){return null}getLocalBBox(){return Co(this.path)}setColor(t){this.color=t,this.context.editsRecorder.recordSetColor(this.id,t)}setMixBlendMode(t){this.context.editsRecorder.recordSetMixBlendMode(this.id,t)}}var dr=Object.defineProperty,Ve=(s,t,e)=>t in s?dr(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,fs=(s,t,e)=>Ve(s,typeof t!="symbol"?t+"":t,e);class is extends xt{constructor(t,e,r){super(t,e),fs(this,"controlPoint",{x:0,y:0}),fs(this,"endPoint",{x:0,y:0}),fs(this,"thickness"),fs(this,"localBbox",null),this.thickness=r}setPoints(t,e){this.controlPoint=t,this.endPoint=e,this.context.editsRecorder.recordStrokeQuadCurve(this.id,t,e,this.thickness)}getBBox(){const t=this.getLocalBBox();return{minX:this.x+t.minX,maxX:this.x+t.maxX,minY:this.y+t.minY,maxY:this.y+t.maxY}}getLocalBBox(){return this.localBbox===null&&(this.localBbox=this.calcLocalBBbox()),this.localBbox}calcLocalBBbox(){return{minX:0,maxX:this.endPoint.x,minY:Math.min(0,this.endPoint.y,this.controlPoint.y),maxY:Math.max(0,this.controlPoint.y,this.endPoint.y)}}}var di=Object.defineProperty,fi=(s,t,e)=>t in s?di(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,bs=(s,t,e)=>fi(s,typeof t!="symbol"?t+"":t,e);class pt extends xt{constructor(t,e,r,i,a){super(t,e),bs(this,"width"),bs(this,"height"),bs(this,"radius",0),bs(this,"color","black"),bs(this,"lineWidth",null),bs(this,"strokeColor",null),this.height=i,this.width=r,this.radius=a!=null?a:0}getBBox(){const t=this.getLocalBBox();return{minX:this.x+t.minX,maxX:this.x+t.maxX,minY:this.y+t.minY,maxY:this.y+t.maxY}}getLocalBBox(){return{minX:0,maxX:this.width,minY:0,maxY:this.height}}setColor(t){this.color=t,this.context.editsRecorder.recordSetColor(this.id,t)}setStrokeWidth(t){this.lineWidth=t,this.context.editsRecorder.recordSetStrokeWidth(this.id,t)}setStrokeColor(t){this.strokeColor=t,this.context.editsRecorder.recordSetStrokeColor(this.id,t)}setMixBlendMode(t){this.context.editsRecorder.recordSetMixBlendMode(this.id,t)}setLabel(t){this.context.editsRecorder.recordSetLabel(this.id,t)}}var Pn=Object.defineProperty,zr=(s,t,e)=>t in s?Pn(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,gi=(s,t,e)=>zr(s,typeof t!="symbol"?t+"":t,e);class Gi{constructor(t,e){gi(this,"context"),gi(this,"id"),gi(this,"children"),gi(this,"destroyed"),this.context=t,this.id=e,this.children=[],this.destroyed=!1}addChild(t){this.children.push(t)}removeChild(t){const e=this.children.indexOf(t);e!==-1&&this.children.splice(e,1)}destroy(){if(this.destroyed)return;this.destroyed=!0,this.children.slice().forEach(e=>{it(this,e),e.destroy()}),this.context.idProvider.returnId(this.id),this.context.editsRecorder.recordDestroyRoot(this.id)}recordAttachNodes(t){this.context.editsRecorder.recordAttachNodes(this.id,t)}recordUnlinkNodes(t){this.context.editsRecorder.recordUnlinkNodes(this.id,t)}getContextPtr(){return this.context}getBBox(){const t=this.children.map(e=>e.getBBox()).filter(e=>e!==null);return t.length===0?{minX:0,maxX:0,minY:0,maxY:0}:t.reduce($t)}}var Xi=Object.defineProperty,No=(s,t,e)=>t in s?Xi(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,En=(s,t,e)=>No(s,typeof t!="symbol"?t+"":t,e);class Wi{constructor(){En(this,"maxId"),En(this,"list"),this.maxId=0,this.list=[]}getId(){let t=this.list.pop();return typeof t!="undefined"||(t=this.maxId,this.maxId++),t}returnId(t){if(t>=this.maxId)throw new Error(`IdProvider: the node id ${t} has not been created yet`);this.list.push(t)}}var te=b(17542),Lo=Object.defineProperty,F=(s,t,e)=>t in s?Lo(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,pi=(s,t,e)=>F(s,typeof t!="symbol"?t+"":t,e);class St{constructor(){pi(this,"idProvider"),pi(this,"map"),this.idProvider=new Wi,this.map=new Map}startListening(){const t=this.idProvider.getId();return this.map.set(t,[]),t}getUpdate(t){const e=this.map.get(t);if(!e)throw new Error(`The listen id ${t} is invalid`);return this.map.set(t,[]),e}stopListening(t){this.map.delete(t)}recordCreateGlyph(t,e,r){const i={type:te.z.CREATE_GLYPH,id:t,glyphId:e,size:r};this.map.forEach(a=>a.push(i))}recordCreateLine(t){const e={type:te.z.CREATE_LINE,id:t};this.map.forEach(r=>r.push(e))}recordCreateText(t,e,r){const i={type:te.z.CREATE_TEXT,id:t,text:e,options:r};this.map.forEach(a=>a.push(i))}recordCreatePath(t){const e={type:te.z.CREATE_PATH,id:t};this.map.forEach(r=>r.push(e))}recordCreateRect(t,e,r,i){const a={type:te.z.CREATE_RECT,id:t,width:e,height:r,radius:i};this.map.forEach(l=>l.push(a))}recordCreateCircle(t,e){const r={type:te.z.CREATE_CIRCLE,id:t,radius:e};this.map.forEach(i=>i.push(r))}recordCreateRoot(t){const e={type:te.z.CREATE_ROOT,id:t};this.map.forEach(r=>r.push(e))}recordCreateGroup(t){const e={type:te.z.CREATE_GROUP,id:t};this.map.forEach(r=>r.push(e))}recordAttachNodes(t,e){const r={type:te.z.ATTACH_NODES,parentId:t,childId:e};this.map.forEach(i=>i.push(r))}recordUnlinkNodes(t,e){const r={type:te.z.UNLINK_NODES,parentId:t,childId:e};this.map.forEach(i=>i.push(r))}recordSetLabel(t,e){const r={type:te.z.SET_LABEL,id:t,label:e};this.map.forEach(i=>i.push(r))}recordSetX(t,e){const r={type:te.z.SET_X,id:t,x:e};this.map.forEach(i=>i.push(r))}recordSetY(t,e){const r={type:te.z.SET_Y,id:t,y:e};this.map.forEach(i=>i.push(r))}recordSetRotation(t,e){const r={type:te.z.SET_ROTATION,id:t,angle:e};this.map.forEach(i=>i.push(r))}recordSetX2(t,e){const r={type:te.z.SET_X2,id:t,x2:e};this.map.forEach(i=>i.push(r))}recordSetY2(t,e){const r={type:te.z.SET_Y2,id:t,y2:e};this.map.forEach(i=>i.push(r))}recordSetScalingY(t,e){const r={type:te.z.SET_SCALING_Y,id:t,scalingY:e};this.map.forEach(i=>i.push(r))}recordSetScalingX(t,e){const r={type:te.z.SET_SCALING_X,id:t,scalingX:e};this.map.forEach(i=>i.push(r))}recordSetColor(t,e){const r={type:te.z.SET_COLOR,id:t,color:e};this.map.forEach(i=>i.push(r))}recordSetOpacity(t,e){const r={type:te.z.SET_OPACITY,id:t,opacity:e};this.map.forEach(i=>i.push(r))}recordSetBlur(t,e){const r={type:te.z.SET_BLUR,id:t,blur:e};this.map.forEach(i=>i.push(r))}recordSetMixBlendMode(t,e){const r={type:te.z.SET_MIX_BLEND_MODE,id:t,mode:e};this.map.forEach(i=>i.push(r))}recordSetStrokeColor(t,e){const r={type:te.z.SET_STROKE_COLOR,id:t,color:e};this.map.forEach(i=>i.push(r))}recordSetStrokeWidth(t,e){const r={type:te.z.SET_STROKE_WIDTH,id:t,width:e};this.map.forEach(i=>i.push(r))}recordSetText(t,e){const r={type:te.z.SET_TEXT,id:t,text:e};this.map.forEach(i=>i.push(r))}recordSetPath(t,e){const r={type:te.z.SET_PATH,id:t,path:e};this.map.forEach(i=>i.push(r))}recordStrokeQuadCurve(t,e,r,i){const a={type:te.z.STROKE_QUAD_QURVE,id:t,controlPoint:e,endPoint:r,thickness:i};this.map.forEach(l=>l.push(a))}recordSetFillRule(t,e){const r={type:te.z.SET_FILL_RULE,id:t,fillRule:e};this.map.forEach(i=>i.push(r))}recordDestroyNode(t){const e={type:te.z.DESTROY_NODE,id:t};this.map.forEach(r=>r.push(e))}recordDestroyRoot(t){const e={type:te.z.DESTROY_ROOT,id:t};this.map.forEach(r=>r.push(e))}}var Dn=Object.defineProperty,Cn=(s,t,e)=>t in s?Dn(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,fr=(s,t,e)=>Cn(s,typeof t!="symbol"?t+"":t,e);class Tn{constructor(t){fr(this,"idProvider"),fr(this,"editsRecorder"),fr(this,"scoreEditsRecorder"),fr(this,"cursorEditsRecorder"),fr(this,"textMetricProvider"),this.idProvider=new Wi,this.editsRecorder=new St,this.scoreEditsRecorder=this.editsRecorder,this.cursorEditsRecorder=new St,this.textMetricProvider=t}setScoreMode(){this.editsRecorder=this.scoreEditsRecorder}setCursorMode(){this.editsRecorder=this.cursorEditsRecorder}}var Mo=Object.defineProperty,Rn=(s,t,e)=>t in s?Mo(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,gr=(s,t,e)=>Rn(s,typeof t!="symbol"?t+"":t,e);class Yr extends xt{constructor(t,e,r,i){super(t,e),gr(this,"controlPoint",{x:0,y:0}),gr(this,"endPoint",{x:0,y:0}),gr(this,"edgeThickness"),gr(this,"midThickness"),gr(this,"localBbox",null),this.edgeThickness=r,this.midThickness=i}setPoints(t,e){this.controlPoint=t,this.endPoint=e;const r=this.getPath();this.context.editsRecorder.recordSetPath(this.id,r)}getPath(){return[[k.Z.LINE_TO,0,-this.edgeThickness/2],[k.Z.QUAD_CURVE_TO,this.controlPoint.x,this.controlPoint.y-this.midThickness/2,this.endPoint.x,this.endPoint.y-this.edgeThickness/2],[k.Z.LINE_TO,this.endPoint.x,this.endPoint.y+this.edgeThickness/2],[k.Z.QUAD_CURVE_TO,this.controlPoint.x,this.controlPoint.y+this.midThickness/2,0,this.edgeThickness/2],[k.Z.LINE_TO,0,0]]}getBBox(){const t=this.getLocalBBox();return{minX:this.x+t.minX,maxX:this.x+t.maxX,minY:this.y+t.minY,maxY:this.y+t.maxY}}getLocalBBox(){return this.localBbox===null&&(this.localBbox=this.calcLocalBBbox()),this.localBbox}calcLocalBBbox(){return{minX:0,maxX:this.endPoint.x,minY:Math.min(0,this.endPoint.y,this.controlPoint.y),maxY:Math.max(0,this.controlPoint.y,this.endPoint.y)}}}var Oo=Object.defineProperty,Bo=(s,t,e)=>t in s?Oo(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ke=(s,t,e)=>Bo(s,typeof t!="symbol"?t+"":t,e);const ks=2/3,pr=1/3;class mr extends xt{constructor(t,e,r,i){super(t,e),Ke(this,"width",null),Ke(this,"shadowWidth",null),Ke(this,"shadowText",null),Ke(this,"color","black"),Ke(this,"text"),Ke(this,"options"),this.text=r,this.options=i}setText(t){t!==this.text&&(this.text=t,this.width=null,this.context.editsRecorder.recordSetText(this.id,t))}setColor(t){this.color=t,this.context.editsRecorder.recordSetColor(this.id,t)}getWidth(){if(this.width===null&&(this.width=this.context.textMetricProvider.getComputedTextLength(this.text,this.options),this.shadowText!==null)){const t=this.getShadowWidth();t>this.width&&(this.width=t)}return this.width}getShadowWidth(){if(this.shadowWidth===null){if(this.shadowText===null)throw new Error("Shadow text is not set");this.shadowWidth=this.context.textMetricProvider.getComputedTextLength(this.shadowText,this.options)}return this.shadowWidth}setShadowText(t){this.shadowText=t,this.shadowWidth=null,this.width=null}getFontSize(){return this.options.fontSize}getBBox(){const t=this.getWidth();return{minX:this.x,maxX:this.x+t,minY:this.y-this.options.fontSize*ks,maxY:this.y+this.options.fontSize*pr}}getLocalBBox(){return{minX:0,maxX:this.getWidth(),minY:-this.options.fontSize*ks,maxY:this.options.fontSize*pr}}}var zi=Object.defineProperty,Ps=(s,t,e)=>t in s?zi(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,mi=(s,t,e)=>Ps(s,typeof t!="symbol"?t+"":t,e);class Io{constructor(t,e){mi(this,"glyphsCache"),mi(this,"sharedContext"),mi(this,"rootsMap"),this.glyphsCache=t,this.sharedContext=new Tn(e),this.rootsMap=new Map}createGlyphNode(t,e){const r=this.sharedContext.idProvider.getId();this.sharedContext.editsRecorder.recordCreateGlyph(r,t,e);const i=this.glyphsCache.getGlyph(t,e);return new oe(this.sharedContext,r,i)}createLineNode(){const t=this.sharedContext.idProvider.getId();return this.sharedContext.editsRecorder.recordCreateLine(t),new Hi(this.sharedContext,t)}createBeamNode(t){const e=this.sharedContext.idProvider.getId();return this.sharedContext.editsRecorder.recordCreatePath(e),new J(this.sharedContext,e,t)}createRectNode(t,e,r){const i=this.sharedContext.idProvider.getId();return this.sharedContext.editsRecorder.recordCreateRect(i,t,e,r),new pt(this.sharedContext,i,t,e,r)}createCircleNode(t){const e=this.sharedContext.idProvider.getId();return this.sharedContext.editsRecorder.recordCreateCircle(e,t),new kt(this.sharedContext,e,t)}createRootNode(){const t=this.sharedContext.idProvider.getId();this.sharedContext.editsRecorder.recordCreateRoot(t);const e=new Gi(this.sharedContext,t);return this.rootsMap.set(t,e),e}createGroupNode(){const t=this.sharedContext.idProvider.getId();return this.sharedContext.editsRecorder.recordCreateGroup(t),new ye(this.sharedContext,t)}createTextNode(t,e){const r=this.sharedContext.idProvider.getId();return this.sharedContext.editsRecorder.recordCreateText(r,t,e),new mr(this.sharedContext,r,t,e)}createCubicCurveNode(t,e){const r=this.sharedContext.idProvider.getId();return this.sharedContext.editsRecorder.recordCreatePath(r),new he(this.sharedContext,r,t,e)}createSlurQuadCurveNode(t,e){const r=this.sharedContext.idProvider.getId();return this.sharedContext.editsRecorder.recordCreatePath(r),new Yr(this.sharedContext,r,t,e)}createQuadCurveNode(t){const e=this.sharedContext.idProvider.getId();return this.sharedContext.editsRecorder.recordCreatePath(e),new is(this.sharedContext,e,t)}createPathNode(t){const e=this.sharedContext.idProvider.getId();return this.sharedContext.editsRecorder.recordCreatePath(e),new we(this.sharedContext,e,t)}destroyAll(){Array.from(this.rootsMap.keys()).forEach(e=>this.destroyRoot(e))}destroyRoot(t){const e=this.rootsMap.get(t);if(!e)throw new Error(`Root node with id ${t} not found`);this.rootsMap.delete(t),e.destroy()}startListening(){const t=this.sharedContext.scoreEditsRecorder.startListening(),e=this.sharedContext.cursorEditsRecorder.startListening();if(t!==e)throw new Error("Score and cursor edits recorder listen IDs do not match");return t}setScoreMode(){this.sharedContext.setScoreMode()}setCursorMode(){this.sharedContext.setCursorMode()}getUpdate(t){return this.sharedContext.editsRecorder.getUpdate(t)}stopListening(t){this.sharedContext.cursorEditsRecorder.stopListening(t),this.sharedContext.scoreEditsRecorder.stopListening(t)}}function v(s,t){if(s===t)throw new Error("The parent and child nodes are the same entity");if(s.getContextPtr()!==t.getContextPtr())throw new Error("The parent and child nodes are not from the same context");const e=t.getParent();if(e){if(e===s)return;it(e,t)}s.recordAttachNodes(t.getId()),s.addChild(t),t.setParent(s)}var R=b(914906),G=b(624740),q=Object.defineProperty,Q=(s,t,e)=>t in s?q(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,K=(s,t,e)=>Q(s,typeof t!="symbol"?t+"":t,e);class ut{constructor(t,e,r,i,a,l,d){K(this,"id"),K(this,"size"),K(this,"minX"),K(this,"maxX"),K(this,"minY"),K(this,"maxY"),K(this,"width"),K(this,"height"),K(this,"anchors"),this.id=t,this.size=e,this.minX=r,this.maxX=i,this.minY=a,this.maxY=l,this.width=this.maxX-this.minX,this.height=this.maxY-this.minY,this.anchors=d}getScaled(t){const e=t/this.size,r={};return Object.entries(this.anchors).forEach(([i,a])=>{const l={x:a.x*e,y:a.y*e};r[i]=l}),new ut(this.id,t,this.minX*e,this.maxX*e,this.minY*e,this.maxY*e,r)}hasStemUpSE(){return typeof this.anchors.stemUpSE!="undefined"}getStemUpSE(){return this.anchors.stemUpSE}hasStemDownNW(){return typeof this.anchors.stemDownNW!="undefined"}getStemDownNW(){return this.anchors.stemDownNW}getGraceNoteSlashSW(){return this.anchors.graceNoteSlashSW}getGraceNoteSlashNW(){return this.anchors.graceNoteSlashNW}getOpticalCenter(){return this.anchors.opticalCenter}getCenterX(){return(this.anchors.opticalCenter?this.anchors.opticalCenter.x:this.width/2)+this.minX}hasRepeatOffset(){return!!this.anchors.repeatOffset}getRepeatOffset(){return this.anchors.repeatOffset}}function Mt(s,t){return t||(t=s),Object.entries(t.glyphs).map(([r,i])=>{let a=s.glyphs[r];a||(a=i);const l=1,d=a.bBoxSW[0],f=a.bBoxNE[0],m=-a.bBoxNE[1],S=-a.bBoxSW[1],w={};return a.opticalCenter&&(w.opticalCenter={x:a.opticalCenter[0],y:-a.opticalCenter[1]}),a.repeatOffset&&(w.repeatOffset={x:a.repeatOffset[0],y:-a.repeatOffset[1]}),a.stemUpSE&&(w.stemUpSE={x:a.stemUpSE[0],y:-a.stemUpSE[1]}),a.stemDownNW&&(w.stemDownNW={x:a.stemDownNW[0],y:-a.stemDownNW[1]}),a.graceNoteSlashSW&&(w.graceNoteSlashSW={x:a.graceNoteSlashSW[0],y:-a.graceNoteSlashSW[1]}),a.graceNoteSlashNW&&(w.graceNoteSlashNW={x:a.graceNoteSlashNW[0],y:-a.graceNoteSlashNW[1]}),new ut(r,l,d,f,m,S,w)})}function qt(s){const t=Mt(s,G.default),e=Mt(R.A);return[...t,...e]}var N=b(896587),T=b(842746),Dt=b(726042),I=b(141624),Ft=b(164059);function rt(s){let t=0,e=0,r=s;for(;r&&"getParent"in r;)t+=r.getX(),e+=r.getY(),r=r.getParent();return{x:t,y:e}}var ue=b(485736),Fo=Object.defineProperty,Uo=(s,t,e)=>t in s?Fo(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,yr=(s,t,e)=>Uo(s,typeof t!="symbol"?t+"":t,e);function Ar(s,t,e){const r=new Ph(s,t);return r.process(e),r.getEntities()}class Ph{constructor(t,e){yr(this,"pageIdx",0),yr(this,"request"),yr(this,"scoreDrawer"),yr(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const r=t.slice.measures.findIndex(H=>H.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r===-1)return;const i=t.parts.find(H=>H.partData.uuid===this.request.partUuid);if(!i)return;const a=i.staves.find(H=>H.staffData.uuid===this.request.staffUuid);if(!a)return;const l=a.measures[r],{tickableContent:d}=l,f=d.horizontalFormatter;if(f===null)throw new Error("Formatter is null");const m=f.getDpq(),S=Dt.default.lcm(m,this.request.dpq),w=this.request.timePos*S/this.request.dpq,x=f.getNbDivisions()*S/m;if(w<0||w>x)return!0;const D=this.scoreDrawer.drawingContext.createGroupNode(),L=rt(d.getChildRoot());D.setX(L.x),D.setY(L.y);const M=this.createCircle({formatter:f,staff:a,mergedTimePos:w,mergedDpq:S});return v(D,M),M.setStrokeColor(this.request.color),this.request.selected&&M.setColor(this.request.color),this.cursorEntities.push({pageIdx:this.pageIdx,node:D}),!0}createCircle(t){const{formatter:e,staff:r,mergedTimePos:i,mergedDpq:a}=t,l=this.scoreDrawer.drawingContext.createCircleNode(ue.Zz);l.setWidth(ue.AM);let d=e.getPosX(i,a);if(this.request.side==="left")d-=ue.bc;else if(this.request.side==="right")d+=ue.AW;else throw new Error("Unreachable");l.setX(d);const f=(0,Ft.o5)(r.staffData);let m;if(this.request.placement===null)m=f/2;else if(this.request.placement===I.A.ABOVE)m=(ue.LM+ue.Zz)*-1;else if(this.request.placement===I.A.BELOW)m=f+ue.LM+ue.Zz;else throw new Error("Unreachable");return l.setY(m),l}getEntities(){return this.cursorEntities}}function Vt(s,t){if(s instanceof ye)s.children.forEach(e=>Vt(e,t));else if(s instanceof oe)s.setColor(t);else if(s instanceof Hi)s.setStrokeColor(t);else if(s instanceof J)s.setColor(t);else if(s instanceof mr)s.setColor(t);else if(s instanceof we)s.setColor(t);else if(s instanceof he)s.setColor(t);else throw new Error(`Unsupported node type: ${s.constructor.name}`)}function qs(s,t,e,r){s.forEach(a=>Ho(a,t)),r&&Go(s);const i=e.getMarginSize();s.forEach(a=>{_o(a,i)})}function Ye(s,t,e,r,i=!1){i?s.forEach(l=>Ju(l,t)):s.forEach(l=>Ho(l,t)),r&&Go(s);const a=e.getMarginSize();s.forEach(l=>{_o(l,a),Dh(l,t)})}function kr(s,t,e,r,i){s.forEach(l=>Th(l,t)),i&&Nh(s);const a=r.getMarginSize();s.forEach(l=>{Wo(l,e,a)})}function gs(s,t,e,r,i,a=!1){a?s.forEach(d=>$u(d,t)):s.forEach(d=>Th(d,t)),i&&Nh(s);const l=r.getMarginSize();s.forEach(d=>{Wo(d,e,l),zo(d,t,e)})}function Ho(s,t){const e=s.entity.getChildRoot().getLocalBBox();if(e===null)throw new Error("entity childRoot bbox should not be null");const r=s.xPosition+e.minX,i=e.maxX-e.minX,a=t.getMaxHeightInRange(r,i);s.yPosition=-a-e.maxY}function Ju(s,t){const e=s.entity.getChildRoot();s.yPosition=Eh(e,s.xPosition,0,t)}function Eh(s,t,e,r){if(s instanceof ye&&s.bboxOverride===null){const i=s.children.map(a=>{const l=a.getX()+t,d=a.getY()+e;return Eh(a,l,d,r)});return Math.min(...i)}else{const i=s.getLocalBBox();if(i===null)throw new Error("node bbox should not be null");const a=t+i.minX,l=i.maxX-i.minX;return-r.getMaxHeightInRange(a,l)-i.maxY-e}}function _o(s,t){if(s.yPosition===null)throw new Error("entity entry.yPosition should not be null at this point");const e=s.entity.getChildRoot(),r=s.yPosition-t;e.setY(r)}function Dh(s,t){const e=s.entity.getChildRoot(),r=s.xPosition,i=e.getY();Ch(e,r,i,t)}function Ch(s,t,e,r){if(s instanceof ye&&s.bboxOverride===null)s.children.forEach(i=>{const a=i.getX()+t,l=i.getY()+e;Ch(i,a,l,r)});else{let i=s.getLocalSubBBoxes();if(i===null){const a=s.getLocalBBox();if(a===null)throw new Error("node bbox should not be null");i=[a]}i.forEach(a=>{const l=t+a.minX,d=a.maxX-a.minX,f=-(e+a.minY);r.addHeight({position:l,width:d,height:f})})}}function Go(s){const t=s.map(r=>r.yPosition),e=Math.min(...t);s.forEach(r=>{r.yPosition=e})}function Th(s,t){const e=s.entity.getChildRoot().getLocalBBox();if(e===null)throw new Error("entity childRoot bbox should not be null");const r=s.xPosition+e.minX,i=e.maxX-e.minX,a=t.getMaxHeightInRange(r,i);s.yPosition=a-e.minY}function $u(s,t){const e=s.entity.getChildRoot();s.yPosition=Xo(e,s.xPosition,0,t)}function Xo(s,t,e,r){if(s instanceof ye&&s.bboxOverride===null){const i=s.children.map(a=>{const l=a.getX()+t,d=a.getY()+e;return Xo(a,l,d,r)});return Math.max(...i)}else{const i=s.getLocalBBox();if(i===null)throw new Error("node bbox should not be null");const a=t+i.minX,l=i.maxX-i.minX;return r.getMaxHeightInRange(a,l)-i.minY-e}}function Wo(s,t,e){if(s.yPosition===null)throw new Error("entity entry.yPosition should not be null at this point");const r=s.entity.getChildRoot(),i=s.yPosition+e+t;r.setY(i)}function zo(s,t,e){const r=s.entity.getChildRoot(),i=s.xPosition,a=r.getY();Rh(r,i,a,e,t)}function Rh(s,t,e,r,i){if(s instanceof ye&&s.bboxOverride===null)s.children.forEach(a=>{const l=a.getX()+t,d=a.getY()+e;Rh(a,l,d,r,i)});else{let a=s.getLocalSubBBoxes();if(a===null){const l=s.getLocalBBox();if(l===null)throw new Error("node bbox should not be null");a=[l]}a.forEach(l=>{const d=t+l.minX,f=l.maxX-l.minX,m=Math.abs(e+l.maxY-r);i.addHeight({position:d,width:f,height:m})})}}function Nh(s){const t=s.map(r=>r.yPosition),e=Math.max(...t);s.forEach(r=>{r.yPosition=e})}var Yo=b(63254),Zu=Object.defineProperty,ju=(s,t,e)=>t in s?Zu(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Vs=(s,t,e)=>ju(s,typeof t!="symbol"?t+"":t,e);const td="dynamics",Lh={p:"dynamicPiano",f:"dynamicForte",m:"dynamicMezzo",r:"dynamicRinforzando",s:"dynamicSforzando",z:"dynamicZ",pppp:"dynamicPPPP",ppp:"dynamicPPP",pp:"dynamicPP",mp:"dynamicMP",mf:"dynamicMF",pf:"dynamicPF",ff:"dynamicFF",fff:"dynamicFFF",ffff:"dynamicFFFF",fp:"dynamicFortePiano",fz:"dynamicForzando",sf:"dynamicSforzando1",sfp:"dynamicSforzandoPiano",sfpp:"dynamicSforzandoPianissimo",sfz:"dynamicSforzato",sfzp:"dynamicSforzatoPiano",sffz:"dynamicSforzatoFF",rf:"dynamicRinforzando1",rfz:"dynamicRinforzando2"};class ko{constructor(t,{type:e,timePos:r,placement:i,uuid:a,dpq:l}){Vs(this,"glyphNode"),Vs(this,"timePos"),Vs(this,"dpq"),Vs(this,"placement"),Vs(this,"type"),Vs(this,"drawingContext"),Vs(this,"spaceBefore",null),Vs(this,"uuid"),Vs(this,"horizontalOffset",0);const d=Lh[e];if(!d)throw new Error(`Dynamic code ${d} is not available`);this.glyphNode=t.createGlyphNode(d),this.glyphNode.setLabel(td),this.timePos=r,this.dpq=l,this.placement=i,this.type=e,this.drawingContext=t,this.uuid=a}fillEventPayload(){const t={entityType:T.A.DYNAMICS,timePos:this.timePos,dpq:this.dpq,placement:this.placement,uuid:this.uuid,type:this.type};this.glyphNode.setEventPayload(t)}getChildRoot(){return this.glyphNode}getUuid(){return this.uuid}getSpaceBefore(){if(this.spaceBefore!==null)return this.spaceBefore;const r=this.getChildRoot().glyph.getCenterX(),i=this.drawingContext.getNoteheadWidth()/2;return this.spaceBefore=r-i,Math.max(0,this.spaceBefore)}getTimePos(){return this.timePos}setX(t){const e=this.getSpaceBefore();t=t-e+this.horizontalOffset,this.glyphNode.setX(t)}getHorizontalData(){const t=this.timePos,e=this.getSpaceBefore(),r=this.getChildRoot().glyph.width-e;return{timePos:t,duration:0,spaceBefore:e,spaceAfter:r,isRest:!1}}getHorizontalPosition(){return Yo.A.DYNAMIC}setHorizontalOffset(t){this.horizontalOffset=t}getWidth(){return this.glyphNode.getWidth()}}var ed=Object.defineProperty,Mh=(s,t,e)=>t in s?ed(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Nn=(s,t,e)=>Mh(s,typeof t!="symbol"?t+"":t,e);function sd(s,t,e){const r=new Oh(s,t);return r.process(e),r.getEntities()}class Oh{constructor(t,e){Nn(this,"pageIdx",0),Nn(this,"request"),Nn(this,"scoreDrawer"),Nn(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const r=t.slice.measures.findIndex(H=>H.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r===-1)return;const i=t.parts.find(H=>H.partData.uuid===this.request.partUuid);if(!i)return;const a=i.staves.find(H=>H.staffData.uuid===this.request.staffUuid);if(!a)return;const l=a.measures[r],{tickableContent:d}=l,f=d.horizontalFormatter;if(f===null)throw new Error("Formatter is null");const m=f.getDpq(),S=Dt.default.lcm(m,this.request.dpq),w=this.request.timePos*S/this.request.dpq,x=f.getNbDivisions()*S/m;if(w<0||w>=x)return!0;const D=this.scoreDrawer.drawingContext.createGroupNode(),L=rt(d.getChildRoot());D.setX(L.x),D.setY(L.y);const M=this.createDynamic({tickableContent:d,measure:l,formatter:f,staff:a,mergedTimePos:w,mergedDpq:S});return v(D,M.getChildRoot()),Vt(D,this.request.color),this.cursorEntities.push({pageIdx:this.pageIdx,node:D}),!0}createDynamic(t){const{tickableContent:e,measure:r,formatter:i,staff:a,mergedTimePos:l,mergedDpq:d}=t,f=this.scoreDrawer.drawingContext,m=e.getChildRoot(),S=new ko(f,{type:this.request.value,timePos:0,dpq:1,placement:this.request.placement,uuid:""}),w=i.getPosX(l,d);S.setX(w);const x=r.getChildRoot(),D=w+m.getX()+x.getX(),{placement:L}=this.request;if(L===I.A.ABOVE){const M=rd(a);if(M){const H=M.getChildRoot().getY();S.getChildRoot().setY(H)}else qs([{entity:S,xPosition:D,yPosition:null}],a.initialTopHeights,f,!1)}else if(L===I.A.BELOW){const M=id(a);if(M){const H=M.getChildRoot().getY();S.getChildRoot().setY(H)}else{const H=(0,Ft.o5)(a.staffData);kr([{entity:S,xPosition:D,yPosition:null}],a.initialBottomHeights,H,f,!1)}}else throw I.A.raiseError(L);return S}getEntities(){return this.cursorEntities}}function rd(s){for(const t of s.measures){const{tickableContent:e}=t,{dynamicsAbove:r}=e;if(r.length>0)return r[0]}return null}function id(s){for(const t of s.measures){const{tickableContent:e}=t,{dynamicsBelow:r}=e;if(r.length>0)return r[0]}return null}var ot=b(353922),z=b(75861),yi=b(967220),Zt=b(740827),Es=b(648920),Ds=b(316826),zt=b(538783),nd=Object.defineProperty,Bh=(s,t,e)=>t in s?nd(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ai=(s,t,e)=>Bh(s,typeof t!="symbol"?t+"":t,e);class Ih{constructor(t){Ai(this,"staffData"),Ai(this,"notes",[]),Ai(this,"stemValue",null),Ai(this,"avgLines",null),Ai(this,"beamInnerDuration",null),this.staffData=t}addNote(t){this.notes.push(t),t.setBeamData(this)}setStemValue(t){if(t!==z.A.UP&&t!==z.A.DOWN)throw new Error(`Invalid stem value: ${t}`);this.stemValue=t}getStemValue(){return this.stemValue===null&&(this.stemValue=this.calcStemValue()),this.stemValue}calcStemValue(){const{stemValue:t,stemConsistent:e}=this.parseStemDefinition();if(t!==null)return t;if(this.staffData.type===Zt.A.GUITAR_TAB)throw new Error("Stem direction must be defined for beams on tab staff.");return this.inferStemFromLines()}parseStemDefinition(){let t=null,e=!0,r=0;for(;r<this.notes.length&&e;){const i=this.notes[r];i.isStemSpecified()&&(t===null?t=i.getSpecifiedStem():i.getSpecifiedStem()!==t&&(e=!1)),r++}return{stemValue:t,stemConsistent:e}}inferStemFromLines(){const t=this.getGlobalLineAvg();return this.getDisplayedNbStaffLines()===1&&t===3?z.A.UP:t>=3?z.A.DOWN:z.A.UP}getGlobalLineAvg(){return this.getAvgLines().reduce(function(i,a){return i+a})/this.notes.length}getAvgLines(){return this.avgLines===null&&(this.avgLines=this.calcAvgLines()),this.avgLines}calcAvgLines(){return this.notes.map(function(t){return t.getLineAvg()})}getDisplayedNbStaffLines(){return this.staffData.nbStaffLines}computeStemQueueLines(){this.isHorizontal()?this.computeStemQueuesLinesHorizontal():this.computeStemQueuesLinesNonHorizontal()}isHorizontal(){return this.isTabStaff()||this.isKodalyStaff()||this.areFirstAndLastLinesSame()||this.isMajoritySameLine()?!0:!!this.isChaotic()}isTabStaff(){return this.staffData.type===Zt.A.GUITAR_TAB}isKodalyStaff(){return!1}areFirstAndLastLinesSame(){const t=this.getAvgLines(),e=t[0],r=t.length-1,i=t[r];return e===i}isMajoritySameLine(){const t=this.getAvgLines();if(t.length<4)return!1;const e=new Map;return t.forEach(i=>{const a=e.get(i);a===void 0?e.set(i,1):e.set(i,a+1)}),od(e)>=t.length/2}isChaotic(){return!1}computeStemQueuesLinesHorizontal(){const t=this.getFarestStemQueueLine();this.applyMaxQueueLine(t)}getFarestStemQueueLine(){const t=this.getOrphanStemQueueLines(),e=this.getStemValue();return t.reduce(function(i,a){return e===z.A.UP?Math.max(i,a):Math.min(i,a)})}getOrphanStemQueueLines(){return this.notes.map(function(e){return e.getSingleNoteStemQueueLine()})}applyMaxQueueLine(t){this.notes.forEach(function(e){e.stemQueueLine=t})}computeStemQueuesLinesNonHorizontal(){this.initNotesStemQueueLine(),this.isBeamTooOblic()&&this.flattenBeam();const t=this.getRequiredStemOffset();this.applyOffset(t),this.alignQueuesToBeam()}initNotesStemQueueLine(){this.notes.forEach(Fh)}isBeamTooOblic(){const t=this.notes[0].getStemQueueLine(),e=this.notes.length-1,r=this.notes[e].getStemQueueLine();return Math.abs(t-r)>.5}flattenBeam(){const t=this.getBeamExternalEndNote();let r=this.getBeamInternalEndNote().getStemQueueLine();r+=.5*this.getStemCoeff(),t.stemQueueLine=r}getBeamExternalEndNote(){const t=this.notes[0],e=t.getStemQueueLine(),r=this.notes.length-1,i=this.notes[r],a=i.getStemQueueLine();return Uh(e,a,this.getStemValue())?t:i}getBeamInternalEndNote(){const t=this.notes[0],e=t.getStemQueueLine(),r=this.notes.length-1,i=this.notes[r],a=i.getStemQueueLine();return Uh(e,a,this.getStemValue())?i:t}getRequiredStemOffset(){let t=0;const e=this.getStemValue();return this.notes.reduce((i,a)=>{const l=this.calcQueueForTick(t),d=this.calcRequiredQueueLineInBeam(a);e===z.A.UP?i=qo(d,l,i):i=hd(d,l,i);const f=Ln(a);return t+=f,i},0)}calcRequiredQueueLineInBeam(t){const e=t.getTailHeadLine(),r=t.getNbFlagsOrBeams();let i;return r===1?i=2.5:i=1+r,t.hasTremolo()&&(i+=t.getNbOrnaments()),e+i*this.getStemCoeff()}getStemCoeff(){return this.getStemValue()===z.A.UP?1:-1}calcQueueForTick(t){const e=this.getBeamInnerDuration(),i=this.notes[0].getStemQueueLine(),a=this.notes.length-1,d=this.notes[a].getStemQueueLine();return i+t*(d-i)/e}getBeamInnerDuration(){return this.beamInnerDuration===null&&(this.beamInnerDuration=this.calcBeamInnerDuration()),this.beamInnerDuration}calcBeamInnerDuration(){const t=this.getDurations();return t.slice(0,t.length-1).reduce(Dt.default.add,0)}getDurations(){return this.notes.map(Ln)}applyOffset(t){const e=this.notes[0],r=this.notes.length-1,i=this.notes[r];if(e.stemQueueLine===null||i.stemQueueLine===null)throw new Error("Stem queue line must be defined at this point.");e.stemQueueLine+=t,i.stemQueueLine+=t}getDirectionCoeff(){return this.getStemValue()===z.A.UP?1:-1}alignQueuesToBeam(){if(this.notes.length>2){const t=this.notes[0];let e=Ln(t);this.notes.slice(1,this.notes.length-1).forEach(i=>{const a=this.calcQueueForTick(e);i.stemQueueLine=a;const l=Ln(i);e+=l})}}getTicks(){const t=this.getDurations();let e=0;return t.map(function(i){const a=e;return e+=i,a})}}function od(s){return Math.max(...s.values())}function Fh(s){const t=s.getSingleNoteStemQueueLine();s.stemQueueLine=t}function Uh(s,t,e){return e===z.A.UP&&s>t?!0:e===z.A.DOWN&&s<t}function qo(s,t,e){return t+e<s&&(e=s-t,e=ad(e)),e}function ad(s){return s*=2,s=Math.ceil(s),s/=2,s}function hd(s,t,e){return t+e>s&&(e=s-t,e=Hh(e)),e}function Hh(s){return s*=2,s=Math.floor(s),s/=2,s}function Ln(s){if(s.isGrace())return 1;{const t=s.getDuration();if(t===null)throw new Error("Note duration must be defined.");return t}}var Mn=(s=>(s.NORMAL="normal",s.FORWARD_HOOK="forward-hook",s.BACKWARD_HOOK="backward-hook",s))(Mn||{});const ns=Mn;var ld=Object.defineProperty,_h=(s,t,e)=>t in s?ld(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Vo=(s,t,e)=>_h(s,typeof t!="symbol"?t+"":t,e);const Gh="noteheadBlack";class Cs{constructor(t,e){Vo(this,"note"),Vo(this,"type"),Vo(this,"blackHeadWidth",null),this.note=t,this.type=e}getStemXPosition(){if(this.type===ns.NORMAL)return this.getNormalStemXPosition();if(this.type===ns.FORWARD_HOOK)return this.getForwardHookStemXPosition();if(this.type===ns.BACKWARD_HOOK)return this.getBackwardHookStemXPosition();throw new Error(`Unknown beam anchor type: ${this.type}`)}getNormalStemXPosition(){const t=this.note.getChildRoot().getX();if(!this.note.stem){const r=this.note.getMiddleHeadWidth();return t+r/2}const e=this.note.getStemBaseGroup().getX();return t+e}getForwardHookStemXPosition(){const t=this.getNormalStemXPosition(),e=this.getStemValue();let r;if(e===z.A.DOWN)r=this.getNoteHeadWidth();else if(e===z.A.UP)r=this.getBlackHeadWidth();else throw z.A.raiseError(e);return t+r}getBackwardHookStemXPosition(){const t=this.getNormalStemXPosition(),e=this.getStemValue();let r;if(e===z.A.UP)r=this.getNoteHeadWidth();else if(e===z.A.DOWN)r=this.getBlackHeadWidth();else throw z.A.raiseError(e);return t-r}getStemValue(){return this.note.getDisplayData().getStemValue()}getNoteHeadWidth(){return this.note.getMiddleHeadWidth()}getBlackHeadWidth(){if(this.blackHeadWidth===null){let t=1;this.isGrace()&&(t=this.note.drawingContext.getGraceSizeCoeff());const e=this.note.drawingContext.getGlyphData(Gh,t);if(e.hasStemDownNW()&&e.hasStemUpSE()){const r=e.getStemDownNW(),i=e.getStemUpSE();this.blackHeadWidth=i.x-r.x}else this.blackHeadWidth=e.maxX-e.minX}return this.blackHeadWidth}isGrace(){return this.note.isGrace()}}var cd=Object.defineProperty,ud=(s,t,e)=>t in s?cd(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,vr=(s,t,e)=>ud(s,typeof t!="symbol"?t+"":t,e);const Yi=.5,Xh=.75,dd=Yi*Xh,Qo=.5;class Je{constructor(t,e,r,i,a,l){vr(this,"drawingContext"),vr(this,"leftAnchor"),vr(this,"rightAnchor"),vr(this,"beamNumber"),vr(this,"isTremolo"),vr(this,"mainBeam"),vr(this,"slopeCoeff",null),vr(this,"beamNode"),this.drawingContext=t,this.leftAnchor=e,this.rightAnchor=r,this.beamNumber=i,this.isTremolo=a,this.mainBeam=l;const d=this.getBeamHeight();this.beamNode=this.drawingContext.createBeamNode(d)}update(){this.slopeCoeff=null;const t=this.getLeftX(),e=this.getRightX(),r=this.getLeftY(),i=this.getRightY();this.beamNode.setX(t),this.beamNode.setY(r),this.beamNode.setX2(e-t),this.beamNode.setY2(i-r),this.beamNode.updatePath()}getLeftX(){let t=this.getLeftStemX();return this.isTremolo&&this.leftAnchor.note.stem&&(t+=Qo),t}getLeftStemX(){return this.leftAnchor.getStemXPosition()}getRightX(){let t=this.getRightStemX();return this.isTremolo&&this.rightAnchor.note.stem&&(t-=Qo),t}getRightStemX(){return this.rightAnchor.getStemXPosition()}getLeftY(){let t;const e=this.getLeftBeamAnchorY();this.mainBeam?t=this.mainBeam.getLeftStemX():t=this.getLeftStemX();const r=this.getLeftX(),i=this.getSlopeCoeff(),a=this.getNumberOffset();return e+i*(r-t)+a}getRightY(){let t;const e=this.getLeftBeamAnchorY();this.mainBeam?t=this.mainBeam.getLeftStemX():t=this.getLeftStemX();const r=this.getRightX(),i=this.getSlopeCoeff(),a=this.getNumberOffset();return e+i*(r-t)+a}getLeftBeamAnchorY(){return this.mainBeam?this.mainBeam.getLeftBeamAnchorY():this.getBeamAnchorY(this.leftAnchor.note)}getRightBeamAnchorY(){return this.mainBeam?this.mainBeam.getRightBeamAnchorY():this.getBeamAnchorY(this.rightAnchor.note)}getBeamAnchorY(t){const e=t.getDisplayData().getStemValue();if(!t.stem){const i=t.getDisplayData().getStemQueueLine(),a=t.lineToY(i);if(e===z.A.UP)return a;if(e===z.A.DOWN){const l=this.getBeamHeight();return a-l}else throw z.A.raiseError(e)}const r=t.getStemBaseGroup().getBBox();if(r===null)throw new Error("Stem bbox not calculated");if(e===z.A.UP)return r.minY;if(e===z.A.DOWN){const i=this.getBeamHeight();return r.maxY-i}else throw z.A.raiseError(e)}getLeftStemY(){return this.getStemY(this.leftAnchor.note)}getStemY(t){const e=t.getStemBaseGroup().getBBox();if(e===null)throw new Error("Stem bbox not calculated");const r=t.getDisplayData().getStemValue();if(r===z.A.UP)return e.minY;if(r===z.A.DOWN)return e.maxY;throw z.A.raiseError(r)}getNumberOffset(){const t=this.getStemCoeff(),e=this.getWidthCoeff();return Yi*1.5*this.beamNumber*t*e}getStemCoeff(){return this.leftAnchor.note.getDisplayData().getStemDirectionCoeff()}getSlopeCoeff(){return this.mainBeam?this.mainBeam.getSlopeCoeff():(this.slopeCoeff===null&&(this.slopeCoeff=this.calculateSlopeCoeff()),this.slopeCoeff)}calculateSlopeCoeff(){const t=this.getLeftStemX(),e=this.getRightStemX(),r=this.getLeftBeamAnchorY();return(this.getRightBeamAnchorY()-r)/(e-t)}getBeamHeight(){return this.isGrace()?dd:Yi}getWidthCoeff(){return this.isGrace()?Xh:1}isGrace(){return this.leftAnchor.isGrace()}getChildRoot(){return this.beamNode}}var vi=Object.defineProperty,fd=(s,t,e)=>t in s?vi(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Qs=(s,t,e)=>fd(s,typeof t!="symbol"?t+"":t,e);function gd(s,t){const e=Wh(s,t),r=pd(s,t,e);return{mainBeam:e,otherBeams:r}}function Wh(s,t){const e=t[0],r=new Cs(e,ns.NORMAL),i=t[t.length-1],a=new Cs(i,ns.NORMAL),l=0,d=e.getDisplayData().getBeams();if(!d)throw new Error("beams not there");const[f]=d,m=Es.A.isTremolo(f);return new Je(s,r,a,l,m,null)}function pd(s,t,e){return new md(s,e).processNotes(t)}class md{constructor(t,e){Qs(this,"drawingContext"),Qs(this,"mainBeam"),Qs(this,"beams",[]),Qs(this,"beamStarts",new Map),this.drawingContext=t,this.mainBeam=e}processNotes(t){if(t.forEach(this.processNote,this),this.beamStarts.size>0)throw new Error("Beam not ended");return this.beams}processNote(t){const r=t.getDisplayData().getBeams();r&&r.forEach(i=>this.processBeam(t,i))}processBeam(t,e){const r=Es.A.getNumber(e),i=Es.A.isTremolo(e);if(r===0)return;const a=Es.A.getType(e);a===Ds.A.CONTINUE||(a===Ds.A.BEGIN?this.startBeam(r,t):a===Ds.A.END?this.stopBeam(r,t,i):a===Ds.A.FORWARD?this.drawForwardHook(r,t):a===Ds.A.BACKWARD?this.drawBackwardHook(r,t):Ds.A.raiseError(a))}startBeam(t,e){if(this.beamStarts.has(t))throw new Error("Beam already started");const r=new Cs(e,ns.NORMAL);this.beamStarts.set(t,r)}stopBeam(t,e,r){const i=this.beamStarts.get(t);if(!i)throw new Error("Beam not started");const a=new Cs(e,ns.NORMAL),l=new Je(this.drawingContext,i,a,t,r,this.mainBeam);this.beams.push(l),this.beamStarts.delete(t)}drawForwardHook(t,e){if(this.beamStarts.has(t))throw new Error("Beam already started");const r=new Cs(e,ns.FORWARD_HOOK),i=new Cs(e,ns.NORMAL),a=!1,l=new Je(this.drawingContext,r,i,t,a,this.mainBeam);this.beams.push(l)}drawBackwardHook(t,e){if(this.beamStarts.has(t))throw new Error("Beam already started");const r=new Cs(e,ns.NORMAL),i=new Cs(e,ns.BACKWARD_HOOK),a=!1,l=new Je(this.drawingContext,r,i,t,a,this.mainBeam);this.beams.push(l)}}function zh(s,t){if(s.length<3)return;const e=t.getSlopeCoeff();if(e===0)return;const r=s[0].getDisplayData().getStemValue();s=s.slice(1,s.length-1);const i=t.getLeftStemY(),a=t.getLeftX(),l=e>0&&r===z.A.UP||e<0&&r===z.A.DOWN?1:-1,f=t.drawingContext.getStemThickness()*l*10;s.forEach(m=>{if(!m.stem)return;const w=new Cs(m,ns.NORMAL).getStemXPosition()+f,x=i+(w-a)*e,D=m.getStemBaseGroup().getY()+m.stem.getY(),L=x-D;m.stem.setY2(L)})}var Yh=Object.defineProperty,Ko=(s,t,e)=>t in s?Yh(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ks=(s,t,e)=>Ko(s,typeof t!="symbol"?t+"":t,e);class Jo{constructor(t,e,r){Ks(this,"drawingContext"),Ks(this,"staffData"),Ks(this,"groupNode"),Ks(this,"displayData"),Ks(this,"mainBeam"),Ks(this,"otherBeams"),Ks(this,"beams",null),Ks(this,"notes",[]),this.drawingContext=t,this.staffData=r,this.displayData=new Ih(r),this.groupNode=this.drawingContext.createGroupNode(),e.forEach(l=>{this.notes.push(l),this.displayData.addNote(l.getDisplayData())});const{mainBeam:i,otherBeams:a}=gd(this.drawingContext,this.notes);this.mainBeam=i,this.otherBeams=a,v(this.groupNode,this.mainBeam.getChildRoot()),this.otherBeams.forEach(l=>v(this.groupNode,l.getChildRoot()))}update(){this.mainBeam.update(),this.otherBeams.forEach(t=>t.update()),zh(this.notes,this.mainBeam)}forceStemValue(t){this.displayData.setStemValue(t)}getChildRoot(){return this.groupNode}}var kh=Object.defineProperty,yd=(s,t,e)=>t in s?kh(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Si=(s,t,e)=>yd(s,typeof t!="symbol"?t+"":t,e);function Ad(s,t,e){const r=new $o(s,e);t.forEach(r.processNote,r)}class $o{constructor(t,e){Si(this,"mainNote"),Si(this,"beamNumber",0),Si(this,"beamType",null),Si(this,"beamNotes",null),Si(this,"stemStrategy"),Si(this,"stemValue",null),this.mainNote=t,this.stemStrategy=e}processNote(t){const r=t.getDisplayData().getBeams();r&&r.forEach(i=>this.processBeam(t,i))}processBeam(t,e){this.extractBeamData(e),this.beamNumber===0&&(this.beamType===Ds.A.BEGIN?this.beginBeam(t):this.beamType===Ds.A.CONTINUE?this.continueBeam(t):this.endBeam(t))}extractBeamData(t){this.beamNumber=Es.A.getNumber(t),this.beamNumber===0?this.beamType=Es.A.getType(t):this.beamType=null}beginBeam(t){if(this.beamNotes)throw new Error("Beam not ended");this.beamNotes=[t]}continueBeam(t){if(this.beamNotes===null)throw new Error("Beam not started");this.beamNotes.push(t)}endBeam(t){if(this.beamNotes===null)throw new Error("Beam not started");this.beamNotes.push(t);const e=t.staffData,r=t.drawingContext,i=new Jo(r,this.beamNotes,e),a=this.getStemValue();i.forceStemValue(a),this.mainNote.addBeam(i),this.beamNotes=null}getStemValue(){return this.stemValue===null&&(zt.A.isDown(this.stemStrategy)?this.stemValue=z.A.DOWN:this.stemValue=z.A.UP),this.stemValue}}var Ne=b(50060),qh=Object.defineProperty,ki=(s,t,e)=>t in s?qh(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ts=(s,t,e)=>ki(s,typeof t!="symbol"?t+"":t,e);const os=" ",vd="_";class Zo{constructor(t,e,r){Ts(this,"textNode"),Ts(this,"lyricJson"),Ts(this,"text"),Ts(this,"hasRightConnection"),Ts(this,"hasRightMelisma"),Ts(this,"isMelisma"),Ts(this,"level"),this.lyricJson=e;const{text:i,isMelisma:a,hasRightConnection:l,hasRightMelisma:d}=Sd(e),f=t.getLyricsFontOptions();this.text=i,this.hasRightConnection=l,this.hasRightMelisma=d,this.isMelisma=a,this.textNode=t.createTextNode(i,f),a&&this.textNode.setShadowText(vd),this.level=Ne.default.getLevel(e);const m=this.textNode.getLocalBBox(),S=this.level*f.fontSize-m.minY;this.textNode.setY(S);const w=this.textNode.getWidth(),x=(r-w)/2;this.textNode.setX(x)}fillEventPayload(t,e){const r={entityType:T.A.LYRIC,voiceUuid:t,noteIdx:e,level:this.level,text:this.text,hasRightHyphen:this.hasRightConnection,hasRightMelisma:this.hasRightMelisma};this.textNode.setEventPayload(r)}getLevel(){return this.level}getChildRoot(){return this.textNode}}function Sd(s){const t=Ne.default.hasRightConnection(s),e=Ne.default.hasRightMelisma(s);return Ne.default.hasLeftMelisma(s)?{isMelisma:!0,text:os,hasRightConnection:t,hasRightMelisma:e}:{isMelisma:!1,text:Ne.default.getText(s),hasRightConnection:t,hasRightMelisma:e}}var Vh=Object.defineProperty,wd=(s,t,e)=>t in s?Vh(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Js=(s,t,e)=>wd(s,typeof t!="symbol"?t+"":t,e);class Qh{constructor(t){Js(this,"groupNode"),Js(this,"levelsMap",new Map),Js(this,"voiceUuid"),Js(this,"noteIdx"),Js(this,"timePos"),this.groupNode=t.drawingContext.createGroupNode(),t.lyricsJson.forEach(r=>{const i=new Zo(t.drawingContext,r,t.headWidth);v(this.groupNode,i.getChildRoot()),i.fillEventPayload(t.voiceUuid,t.noteIdx);const a=i.getLevel();this.levelsMap.set(a,i)});const e=t.drawingContext.createGroupNode();e.setBBoxOverride({minX:0,maxX:t.headWidth,minY:0,maxY:1}),v(this.groupNode,e),this.voiceUuid=t.voiceUuid,this.noteIdx=t.noteIdx,this.timePos=t.timePos}setX(t){this.groupNode.setX(t)}setY(t){this.groupNode.setY(t)}getChildRoot(){return this.groupNode}getLevels(){return Array.from(this.levelsMap.keys())}getLyricLine(t){const e=this.levelsMap.get(t);return e===void 0?null:e}getTimePos(){return this.timePos}getNoteIdx(){return this.noteIdx}getPosition(){return this.groupNode.getX()}getYPosition(){return this.groupNode.getY()}}function Kh(s){const{drawingContext:t,displayData:e,noteDrawer:r,voiceUuid:i}=s;if(!e.hasLyrics()||e.isRecorderTabStaff())return null;const a=e.getLyrics(),l=r.getMiddleHeadWidth(),d=e.getNoteIdx(),f=r.getTimePos();return new Qh({drawingContext:t,lyricsJson:a,headWidth:l,voiceUuid:i,noteIdx:d,timePos:f})}var $s=b(955154),xd=b(601277),$e=b(555247),Sr=b(724095),Ae=b(359932),qi=b(476943),bd=Object.defineProperty,Jh=(s,t,e)=>t in s?bd(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,wr=(s,t,e)=>Jh(s,typeof t!="symbol"?t+"":t,e);const xr=new Map([[Sr.A.TRILLMARK,"ornamentTrill"],[Ae.default.UPBOW,{above:"stringsUpBow",below:"stringsUpBowTurned"}],[Ae.default.DOWNBOW,{above:"stringsDownBow",below:"stringsDownBowTurned"}],[Ae.default.SNAP_PIZZICATO,{above:"pluckedSnapPizzicatoAbove",below:"pluckedSnapPizzicatoBelow"}],[Ae.default.STOPPED,"pluckedLeftHandPizzicato"],[$s.default.NATURAL_SOUNDING,"stringsHarmonic"],[Ae.default.THUMB_POSITION,{above:"stringsThumbPosition",below:"stringsThumbPositionTurned"}],[xd.default.FERMATA,{above:"fermataAbove",below:"fermataBelow"}],[Sr.A.MORDENT,"ornamentMordent"],[Sr.A.INVERTED_MORDENT,"ornamentShortTrill"],[$e.A.LONG_MORDENT,"ornamentPrecompTrillWithMordent"],[$e.A.LONG_INVERTED_MORDENT,"ornamentTremblement"],[$e.A.ABOVE_APPROACH_MORDENT,"ornamentPrecompInvertedMordentUpperPrefix"],[$e.A.BELOW_APPROACH_MORDENT,"ornamentPrecompSlideTrillBach"],[$e.A.ABOVE_APPROACH_INVERTED_MORDENT,"ornamentPrecompMordentUpperPrefix"],[$e.A.BELOW_APPROACH_INVERTED_MORDENT,"ornamentPrecompSlideTrillDAnglebert"],[$e.A.ABOVE_DEPARTURE_INVERTED_MORDENT,"ornamentPrecompTrillSuffixDandrieu"],[$e.A.BELOW_DEPARTURE_INVERTED_MORDENT,"ornamentPrecompTrillLowerSuffix"],[Sr.A.TURN,"ornamentTurn"],[Sr.A.INVERTED_TURN,"ornamentTurnSlash"]]);function $h(s){if(!s.getDisplayData().isNormalStaff())return;new jo(s).process()}class jo{constructor(t){wr(this,"note"),wr(this,"displayData"),wr(this,"ctx"),wr(this,"placement",null),wr(this,"ornaments"),wr(this,"technical"),wr(this,"articulations"),this.note=t,this.displayData=t.getDisplayData(),this.ctx=t.getDrawingContext(),this.ornaments=this.displayData.getOrnaments(),this.technical=this.displayData.getTechnical(),this.articulations=this.displayData.getArticulations()}process(){this.getGlyphIds().forEach(this.processGlyph,this)}getGlyphIds(){const t=[],e=this.getPlacement();if(typeof this.ornaments!="undefined"){const i=this.ornaments.filter(On).map(ta,e);Array.prototype.push.apply(t,i)}if(typeof this.technical!="undefined"){const i=this.technical.filter(On).map(ta,e);Array.prototype.push.apply(t,i)}if(typeof this.articulations!="undefined"){const i=this.articulations.filter(On).map(ta,e);Array.prototype.push.apply(t,i)}return t}processGlyph(t){const e=this.note.getChildRoot(),r=this.ctx.createGroupNode();v(e,r);const i=this.ctx.createGlyphNode(t);v(r,i);const a=this.getPosX(i),l=this.getPosY(i);r.setX(a),r.setY(l),this.note.setTechnical(r),this.updateLimit(l,i)}getPosX(t){const e=this.note.getMiddleHeadWidth(),r=t.getWidth();return e/2-r/2}getPosY(t){const r=this.getPlacement();let i;if(r===I.A.ABOVE)return i=this.note.getLocalHighestYWithMarge(),i=Math.min(i,-1),i;if(r===I.A.BELOW){const a=this.displayData.getNbStaffLines();return i=this.note.getLocalLowestYWithMarge(),i=Math.max(i,1*a),i-=t.glyph.minY,i}else throw new Error("Unexpected")}lineToY(t){return this.note.lineToY(t)}updateLimit(t,e){const r=e.getLocalBBox(),i=this.getPlacement();if(i===I.A.BELOW)this.note.setLowestY(t+r.maxY);else if(i===I.A.ABOVE)this.note.setHighestY(t+r.minY);else throw new Error("Unexpected")}getPlacement(){return this.placement===null&&(this.placement=this.calcPlacement()),this.placement}calcPlacement(){const t=this.displayData.getStemStrategy();return zt.A.isDown(t)?I.A.BELOW:I.A.ABOVE}}function On(s){return xr.has(s)}function ta(s){const t=this.valueOf(),e=xr.get(s);if(typeof e=="undefined")throw new Error("Unexpected");if(typeof e=="string")return e;if(qi.default.isObject(e)){if(t===I.A.ABOVE)return e.above;if(t===I.A.BELOW)return e.below;throw new Error("Unexpected")}else throw new Error("Unreachable")}var as=b(474976),Pd=Object.defineProperty,Ed=(s,t,e)=>t in s?Pd(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,ea=(s,t,e)=>Ed(s,typeof t!="symbol"?t+"":t,e);function Dd(s){if(!s.getDisplayData().isNormalStaff())return;new _s(s).process()}const sa=new Map([[as.default.BREATHMARK,"breathMarkComma"],[as.default.CAESURA,"caesura"]]);class _s{constructor(t){ea(this,"note"),ea(this,"displayData"),ea(this,"ctx"),this.note=t,this.displayData=t.getDisplayData(),this.ctx=t.getDrawingContext()}process(){let t=this.displayData.getArticulations();t=t.filter(Vi),Zs(t).forEach(this.addGlyph,this)}addGlyph(t){const e=this.note.getChildRoot(),r=this.ctx.createGroupNode();v(e,r);const i=this.ctx.createGlyphNode(t);v(r,i);const a=this.getPosX(),l=this.getPosY(i);r.setX(a),r.setY(l),this.note.setTechnical(r),this.updateLimit(l,i),this.note.setAboveRight(r,a+i.getWidth())}getPosX(){const t=this.ctx.getMinimalSpaceAboveRightRatio(),e=this.note.getChildRoot().getLocalBBox();if(e===null)throw new Error("Bbox should be filled at this point");const r=e.maxX-e.minX+.5;return Math.max(t,r)}getPosY(t){return-(1.2-t.getHeight())}updateLimit(t,e){const r=e.getHeight();this.note.setHighestY(t-r)}}function Zs(s){return s.map(Qi)}function Vi(s){return sa.has(s)}function Qi(s){const t=sa.get(s);if(typeof t=="undefined")throw new Error("Invalid articulation");return t}var js=Object.defineProperty,Ki=(s,t,e)=>t in s?js(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,wi=(s,t,e)=>Ki(s,typeof t!="symbol"?t+"":t,e),tr=(s=>(s.UP="up",s.DOWN="down",s))(tr||{});function Bn(s){if(s==="up")return 90;if(s==="down")return-90;throw new Error(`Unknown direction: ${s}`)}function ra(s){return"wiggleArpeggiatoUp"}function Zh(s){return"wiggleArpeggiatoUpArrow"}class jh{constructor(t,e,r,i){wi(this,"groupNode"),wi(this,"drawingContext"),wi(this,"direction"),wi(this,"showArrow"),wi(this,"advance",null),wi(this,"inputHeight"),this.inputHeight=i,this.groupNode=t.createGroupNode();const a=Bn(e);this.groupNode.setRotation(a),this.drawingContext=t,this.direction=e,this.showArrow=r,this.createGlyphs(i)}createGlyphs(t){const e=ra(this.direction),r=this.drawingContext.createGlyphNode(e,1),i=tl(r);let a=Math.ceil(t/i);a===1&&this.showArrow&&a++;const d=(i*a-t)/2;r.setX(-d),v(this.groupNode,r);for(let f=1;f<a;f++){let m;f===a-1&&this.showArrow?m=Zh(this.direction):m=ra(this.direction);const S=this.drawingContext.createGlyphNode(m,1);S.setX(-d+f*i),v(this.groupNode,S)}}setX(t){this.groupNode.setX(t)}setY(t){this.direction==="up"&&(t+=this.inputHeight,this.groupNode.setY(t))}getChildRoot(){return this.groupNode}}function tl(s){return s.glyph.hasRepeatOffset()?s.glyph.getRepeatOffset().x:s.getMaxX()}var el=Object.defineProperty,sl=(s,t,e)=>t in s?el(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,In=(s,t,e)=>sl(s,typeof t!="symbol"?t+"":t,e);const rl=1,Cd=.5;function Td(s){const t=s.getDisplayData();if(!t.isNormalStaff()||!t.hasArpeggio())return;new Rd(s).process()}class Rd{constructor(t){In(this,"note"),In(this,"ctx"),In(this,"displayData"),In(this,"offset"),this.displayData=t.getDisplayData(),this.note=t,this.ctx=t.getDrawingContext(),this.offset=this.getOffset()}getOffset(){const t=this.note.getChildRoot().getLocalBBox();if(t===null)throw new Error("The note has no bounding box.");return t.maxX}process(){const t=this.displayData.getHighestLine(),e=this.displayData.getLowestLine(),r=Math.abs(t-e)+rl,i=this.lineToY(t)-rl/2,a=!1,l=new jh(this.ctx,tr.UP,a,r),d=Nd(this.note,l);l.setX(d),l.setY(i),this.note.addArpeggio(l)}lineToY(t){return this.note.lineToY(t)}}function Nd(s,t){const e=s.getChildRoot().getLocalBBox(),r=t.getChildRoot().getLocalBBox();if(e===null||r===null)throw new Error("The note or arpeggio has no bounding box.");return-(-e.minX+r.maxX+Cd)}var Ld=b(706650),Md=Object.defineProperty,Od=(s,t,e)=>t in s?Md(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,qr=(s,t,e)=>Od(s,typeof t!="symbol"?t+"":t,e),Bd=(s=>(s.SPACE="space",s.LINE="line",s.STEM="stem",s.CENTER="center",s.EXTERNAL="line-outside",s))(Bd||{});const il=new Map([[as.default.STACCATO,{above:"articStaccatoAbove",below:"articStaccatoBelow",yAnchor:"space",xAnchor:"stem"}],[as.default.STACCATO_TENUTO,{above:"articTenutoStaccatoAbove",below:"articTenutoStaccatoBelow",yAnchor:"line",xAnchor:"center"}],[as.default.TENUTO,{above:"articTenutoAbove",below:"articTenutoBelow",yAnchor:"space",xAnchor:"center"}],[as.default.ACCENT,{above:"articAccentAbove",below:"articAccentBelow",yAnchor:"line-outside",xAnchor:"center"}],[as.default.STRONG,{above:"articMarcatoAbove",below:"articMarcatoBelow",yAnchor:"line-outside",xAnchor:"center"}],[as.default.STACCATISSIMO,{above:"articStaccatissimoAbove",below:"articStaccatissimoBelow",yAnchor:null,xAnchor:"stem"}]]);function Id(s){const t=s.getDisplayData();if(!t.isNormalStaff()||t.getArticulations().length===0)return;new Fd(s).process()}class Fd{constructor(t){qr(this,"note"),qr(this,"displayData"),qr(this,"ctx"),qr(this,"stemValue"),qr(this,"symbols",null),qr(this,"xPos",null),qr(this,"placement",null),this.note=t,this.displayData=t.getDisplayData(),this.ctx=t.getDrawingContext(),this.stemValue=this.displayData.getStemValue()}process(){this.getSymbols().forEach(this.drawSymbol,this)}computeXPos(t){const e=this.getXAnchor(t),r=this.note.getMiddleHeadWidth();if(e==="stem"){if(this.stemValue===z.A.UP)return r;if(this.stemValue===z.A.DOWN)return 0;throw new Error("Unexpected")}else{if(e==="center")return r/2;throw new Error("Unexpected")}}getXPos(){if(this.xPos===null){const t=this.getSymbols();this.xPos=this.computeXPos(t)}return this.xPos}getSymbols(){if(this.symbols===null){const t=this.displayData.getArticulations().slice();Ld.A.sortArticulationsList(t),this.symbols=Hd(t)}return this.symbols}getXAnchor(t){const e=this.getPlacement();return e===I.A.ABOVE&&this.stemValue===z.A.DOWN||e===I.A.BELOW&&this.stemValue===z.A.UP||t.some(r=>r.xAnchor==="center")||!this.displayData.hasStem()?"center":"stem"}drawSymbol(t){let e=this.getLine();e+=this.getLineMargin(),this.hasAnchor(t.yAnchor,e)?e=this.roundLine(t.yAnchor,e):e+=this.getLineMargin();const r=this.note.getChildRoot(),i=this.ctx.createGroupNode();v(r,i);const a=this.getGlyphId(t),l=this.ctx.createGlyphNode(a);v(i,l);const d=this.getArticulationX(l);i.setX(d);const f=this.getArticulationY(e,t,l);i.setY(f),this.note.setArticulation(i),this.updateLimit(f,l)}getLine(){let t;const e=this.getPlacement();if(e===I.A.BELOW)t=this.note.getLowestY();else if(e===I.A.ABOVE)t=this.note.getHighestY();else throw new Error("Unexpected");return this.note.yToLine(t)}getLineMargin(){return .25*this.getLineDirection()}getGlyphId(t){const e=this.getPlacement();if(e===I.A.BELOW)return t.below;if(e===I.A.ABOVE)return t.above;throw new Error("Unexpected")}hasAnchor(t,e){if(t===null)return!1;t==="line"&&(e-=this.getLineMargin()*2);const r=this.getPlacement();if(r===I.A.BELOW){if(e<=.75)return!1}else if(r===I.A.ABOVE){if(e>=5.25)return!1}else throw new Error("Unexpected");return!0}roundLine(t,e){const r=this.getPlacement(),i=this.displayData.getNbStaffLines();if(t==="line-outside"){if(r===I.A.ABOVE)return Math.max(e,i+.25);if(r===I.A.BELOW)return Math.min(e,.75);throw new Error("Unexpected")}else{if(t==="space")return e+=.5,e=this.getLineRoundingFunction()(e),e-=.5,e;if(t==="line")return e=this.getLineRoundingFunction()(e),e;throw new Error("Unexpected")}}getLineRoundingFunction(){const t=this.getPlacement();if(t===I.A.ABOVE)return Math.ceil;if(t===I.A.BELOW)return Math.floor;throw new Error("Unexpected")}getLineDirection(){const t=this.getPlacement();if(t===I.A.BELOW)return-1;if(t===I.A.ABOVE)return 1;throw new Error("Unexpected")}getArticulationX(t){const e=t.glyph.maxX-t.glyph.minX;return this.getXPos()-e/2}getArticulationY(t,e,r){let i=this.note.lineToY(t);if(e.yAnchor==="line"||e.yAnchor==="space"){const a=this.getPlacement(),l=r.getLocalBBox();if(a===I.A.BELOW)i-=l.minY;else if(a===I.A.ABOVE)i-=l.maxY;else throw new Error("Unexpected")}return i}updateLimit(t,e){const r=e.getLocalBBox(),i=this.getPlacement();if(i===I.A.BELOW)this.note.setLowestY(t+r.maxY);else if(i===I.A.ABOVE)this.note.setHighestY(t+r.minY);else throw new Error("Unexpected")}getPlacement(){return this.placement===null&&(this.placement=this.computePlacement()),this.placement}computePlacement(){const t=this.displayData.getStemStrategy();if(t===zt.A.AUTO){if(this.stemValue===z.A.UP)return I.A.BELOW;if(this.stemValue===z.A.DOWN)return I.A.ABOVE;throw new Error("Unexpected")}else{if(zt.A.isUp(t))return I.A.ABOVE;if(zt.A.isDown(t))return I.A.BELOW;throw new Error("Unexpected")}}}function Ud(s){return il.has(s)}function Hd(s){return s=s.filter(Ud),s.map(_d)}function _d(s){const t=il.get(s);if(t===void 0)throw new Error(`Invalid articulation type: ${s}`);return t}var Gd=Object.defineProperty,Xd=(s,t,e)=>t in s?Gd(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Fn=(s,t,e)=>Xd(s,typeof t!="symbol"?t+"":t,e);const Wd="augmentationDot";function ia(s){const t=s.getDisplayData();if(!t.isNormalStaff()||t.getNbDots()===0)return;new zd(s).process()}class zd{constructor(t){Fn(this,"note"),Fn(this,"ctx"),Fn(this,"displayData"),Fn(this,"offset"),this.displayData=t.getDisplayData(),this.note=t,this.ctx=t.getDrawingContext(),this.offset=this.getOffset()}getOffset(){const t=this.note.getChildRoot().getLocalBBox();if(t===null)throw new Error("The note has no bounding box.");let e=t.maxX;return this.displayData.hasTieStart()&&(e+=this.ctx.getMarginSize()),e}process(){this.displayData.getLines().forEach(this.drawDot,this)}drawDot(t){if(t===null)return;let e=this.ctx.getMarginSize();Dt.default.isInteger(t)&&(this.displayData.isSecondLower(t)?t-=.5:t+=.5,!this.displayData.hasBeam()&&this.displayData.getNbFlags()>1&&(e+=this.ctx.getMarginSize()));const r=this.lineToY(t),i=this.displayData.getNbDots();for(let a=0;a<i;a++){const l=this.offset+e,d=this.ctx.createGlyphNode(Wd);d.setX(l),d.setY(r);const f=this.note.getChildRoot();v(f,d);const m=d.glyph.maxX-d.glyph.minX;this.note.addDot(d),this.note.setDotWidth(m),this.note.setDotMargin(e),e+=m+this.ctx.getMarginSize()}}lineToY(t){return this.note.lineToY(t)}}var Yd=Object.defineProperty,kd=(s,t,e)=>t in s?Yd(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Un=(s,t,e)=>kd(s,typeof t!="symbol"?t+"":t,e);const qd="fingering";function Vd(s){const t=s.getDisplayData();if(!t.isNormalStaff()||t.getFingerings().length===0)return;new Qd(s).process()}class Qd{constructor(t){Un(this,"note"),Un(this,"displayData"),Un(this,"ctx"),Un(this,"yPos",0),this.note=t,this.displayData=t.getDisplayData(),this.ctx=t.getDrawingContext()}process(){const t=this.getPlacement();t===I.A.ABOVE?this.drawAbove():t===I.A.BELOW?this.drawBelow():I.A.raiseError(t)}getPlacement(){const t=this.displayData.getStemStrategy(),e=this.displayData.getStaffIdx();if(t===zt.A.AUTO)return e===0?I.A.ABOVE:I.A.BELOW;if(zt.A.isUp(t))return I.A.ABOVE;if(zt.A.isDown(t))return I.A.BELOW;throw zt.A.raiseError(t),new Error("Unreachable")}drawAbove(){const t=this.displayData.getFingerings().slice().reverse(),e=this.note.getHighestY()-.5,r=-.5;this.yPos=Math.min(r,e),t.forEach(this.drawFingeringAbove,this)}drawFingeringAbove(t){const e=this.drawFingering(t);this.yPos-=e,this.yPos-=this.ctx.getMarginSize(),this.note.setHighestY(this.yPos)}drawBelow(){const e=this.displayData.getNbStaffLines()-1,r=this.note.getLowestY();this.yPos=Math.max(r,e),this.displayData.getFingerings().forEach(this.drawFingeringBelow,this)}drawFingeringBelow(t){this.yPos+=this.ctx.getMarginSize();const e=this.drawFingering(t);this.yPos+=e,this.note.setLowestY(this.yPos)}drawFingering(t){const e=this.note.getChildRoot(),r=this.ctx.createGroupNode();v(e,r);let i=0,a=0;const l=this.ctx.getMarginSize();t.toString().split("").forEach(w=>{const x=Kd(w),D=this.ctx.createGlyphNode(x);v(r,D),i>0&&(i+=l),i-=D.glyph.minX;const L=i;i+=D.glyph.maxX,D.setX(L);const M=D.getHeight();a=Math.max(a,M)});const f=this.note.getMiddleHeadWidth()/2-i/2;let m=this.yPos;return this.getPlacement()===I.A.BELOW&&(m+=a),r.setX(f),r.setY(m),a}}function Kd(s){return qd+s}var Ji=b(637475),nl=Object.defineProperty,ol=(s,t,e)=>t in s?nl(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,xi=(s,t,e)=>ol(s,typeof t!="symbol"?t+"":t,e);function al(s){const t=s.getDisplayData();if(!t.isNormalStaff()||t.isRest()||t.hasBeam()||t.getNbFlags()===0)return;new Jd(s).process()}class Jd{constructor(t){xi(this,"note"),xi(this,"displayData"),xi(this,"ctx"),xi(this,"nbFlags"),xi(this,"stemValue"),this.note=t,this.displayData=t.getDisplayData(),this.ctx=t.getDrawingContext(),this.nbFlags=this.displayData.getNbFlags(),this.stemValue=this.displayData.getStemValue()}process(){const t=this.note.getStemBaseGroup();this.checkStemValue();const e=this.getFlagGlyphId(),r=this.getGlyph(e),i=this.ctx.createGroupNode();v(t,i),v(i,r);const a=this.getFlagX(),l=this.getFlagY();i.setX(a),i.setY(l),this.displayData.hasFlagDash()&&this.nbFlags===1&&this.addFlagDash(r,i);const d=r.glyph.maxX-r.glyph.minX;this.note.setFlag(i,d)}getGlyph(t){let e=1;return this.displayData.isGrace()&&(e=this.ctx.getGraceFlagSizeCoeff()),this.ctx.createGlyphNode(t,e)}addFlagDash(t,e){const r=this.ctx.getGraceFlagSizeCoeff();let i=null,a;if(this.stemValue===z.A.UP)i=t.glyph.getGraceNoteSlashSW(),a=this.ctx.createGlyphNode("graceNoteSlashStemUp",r);else if(this.stemValue===z.A.DOWN)i=t.glyph.getGraceNoteSlashNW(),a=this.ctx.createGlyphNode("graceNoteSlashStemDown",r);else throw this.stemValueError();v(e,a),a.setX(i.x),a.setY(i.y)}checkStemValue(){if(this.stemValue!==z.A.UP&&this.stemValue!==z.A.DOWN)throw this.stemValueError()}stemValueError(){const t=`cannot draw flag for stem with ${this.stemValue} value`;return new Error(t)}getFlagGlyphId(){let t="flag";const e=Ji.A.get(2+this.nbFlags);if(t+=e,this.stemValue===z.A.UP)t+="Up",this.displayData.getNbDots()>0&&(t+="Short");else if(this.stemValue===z.A.DOWN)t+="Down";else throw new Error("unreachable");return t}getFlagX(){return-(this.ctx.getStemThickness()/2)}getFlagY(){const t=this.displayData.getStemQueueLine(),e=this.displayData.getStemBaseLine(),i=-(t-e),a=this.getCounterOffset();return i+a}getCounterOffset(){let t=Math.max(0,this.nbFlags-2);this.displayData.isGrace()&&(t/=2);const e=t;if(this.stemValue===z.A.UP)return e;if(this.stemValue===z.A.DOWN)return-e;throw new Error("unreachable")}}var $d=Object.defineProperty,hl=(s,t,e)=>t in s?$d(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,na=(s,t,e)=>hl(s,typeof t!="symbol"?t+"":t,e),Zd=(s=>(s.ABOVE="above",s.BELOW="below",s.LEFT="left",s.RIGHT="rigth",s))(Zd||{});const oa=new Map([[as.default.DOIT,{glyphId:"brassDoitMedium",verticalDirection:"above",horizontalDirection:"rigth"}],[as.default.FALLOFF,{glyphId:"brassFallRoughShort",verticalDirection:"below",horizontalDirection:"rigth"}],[as.default.PLOP,{glyphId:"brassPlop",verticalDirection:"above",horizontalDirection:"left"}],[as.default.SCOOP,{glyphId:"brassScoop",verticalDirection:"below",horizontalDirection:"left"}]]);function jd(s){if(!s.getDisplayData().isNormalStaff())return;new tf(s).process()}class tf{constructor(t){na(this,"note"),na(this,"displayData"),na(this,"ctx"),this.note=t,this.displayData=t.getDisplayData(),this.ctx=t.getDrawingContext()}process(){let t=this.displayData.getArticulations();t=t.filter(sf),ef(t).forEach(this.addGlyph,this)}addGlyph(t){const e=this.note.getChildRoot(),r=this.ctx.createGroupNode();v(e,r);const i=this.ctx.createGlyphNode(t.glyphId);v(r,i);const a=this.getY(t.verticalDirection,i),l=this.getX(t.horizontalDirection,i);r.setX(l),r.setY(a),this.updateLimit(t.verticalDirection,a,i),this.setRenderedNoteWidth(t.horizontalDirection,i)}getY(t,e){if(t==="above"){const i=this.displayData.getHighestLine();return this.lineToY(i)-.2-e.glyph.maxY}else if(t==="below"){const i=this.displayData.getLowestLine();return this.lineToY(i)+.2-e.glyph.minY}else throw new Error("Unexpected")}getX(t,e){if(t==="left"){let i=-e.getWidth()-.2;return i-=this.note.getLeftHeadWidth(),this.note.hasAccidentals()&&(i-=this.note.getAccidentalsWidth()),i}else if(t==="rigth"){let i=this.note.getMiddleHeadWidth()+.2;return i+=this.note.getRightHeadWidth(),i}else throw new Error("Unexpected")}lineToY(t){return this.note.lineToY(t)}updateLimit(t,e,r){const i=r.getLocalBBox();if(t==="above")this.note.setHighestY(e+i.minY);else if(t==="below")this.note.setLowestY(e+i.maxY);else throw new Error("Unexpected")}setRenderedNoteWidth(t,e){const r=e.getWidth();if(t==="left")this.note.setLeftArticulationsWidth(r);else if(t==="rigth")this.note.setRightArticulationsWidth(r);else throw new Error("Unexpected")}}function ef(s){return s.map(rf)}function sf(s){return oa.has(s)}function rf(s){const t=oa.get(s);if(typeof t=="undefined")throw new Error("Invalid articulation");return t}var nf=b(244616),ll=Object.defineProperty,cl=(s,t,e)=>t in s?ll(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,aa=(s,t,e)=>cl(s,typeof t!="symbol"?t+"":t,e);function ul(s){const t=new of(s);t.canProcess()&&t.process()}class of{constructor(t){aa(this,"displayData"),aa(this,"note"),aa(this,"ctx"),this.displayData=t.getDisplayData(),this.note=t,this.ctx=t.getDrawingContext()}canProcess(){return this.displayData.isNormalStaff()&&this.hasLegerLines()&&!this.isSmallRest()&&!this.isTransparentRest()}hasLegerLines(){return this.hasUpLegerLines()||this.hasDownLegerLines()}isSmallRest(){return this.displayData.isRest()?this.displayData.getBaseQuarterDuration()<=1:!1}isTransparentRest(){if(!this.displayData.isRest())return!1;const t=this.displayData.getRestColor();return t===null?!1:nf.default.isTransparent(t)}process(){this.hasUpLegerLines()&&this.drawUpLegerLines(),this.hasDownLegerLines()&&this.drawDownLegerLines()}hasUpLegerLines(){const t=this.getUpLimit();return this.displayData.getHighestLine()>=t}hasDownLegerLines(){const t=this.getDownLimit();return this.displayData.getLowestLine()<=t}drawUpLegerLines(){let t=this.displayData.getHighestLine();const e=this.getUpLimit();for(;t>=e;){if(this.drawLegerLine(Math.floor(t)),this.displayData.isRest())return;t--}}getUpLimit(){return this.displayData.getDisplayedNbStaffLines()===1?4:6}drawDownLegerLines(){let t=this.displayData.getLowestLine();const e=this.getDownLimit();for(;t<=e;){if(this.drawLegerLine(Math.ceil(t)),this.displayData.isRest())return;t++}}getDownLimit(){return this.displayData.getDisplayedNbStaffLines()===1?2:0}drawLegerLine(t){const e=this.displayData.getStemValue(),r=this.ctx.getLegerLineExtension(),i=this.note.getMiddleHeadWidth();let a=-r,l=i+r;if(e===z.A.DOWN&&this.hasAdjacentSecondLower(t)){const w=this.note.getLeftHeadWidth();a-=w,!this.hasAdjacentSecondHigher(t)&&!this.displayData.hasLine(t)&&(l-=w)}if(e===z.A.UP&&this.hasAdjacentSecondHigher(t)){const w=this.note.getRightHeadWidth();l+=w,!this.hasAdjacentSecondLower(t)&&!this.displayData.hasLine(t)&&(a+=w)}const d=this.lineToY(t),f=this.ctx.createLineNode(),m=this.getLegerLineThickness();f.setWidth(m),f.setY(d),f.setX(a),f.setX2(l-a);const S=this.note.getChildRoot();f.setTakeSpace(!1),v(S,f),this.note.addLegerLine(t)}getLegerLineThickness(){return this.ctx.getLegerLineThickness()}hasAdjacentSecondLower(t){return this.displayData.isSecondLower(t+.5)||this.displayData.isSecondLower(t)||this.displayData.isSecondLower(t-.5)}hasAdjacentSecondHigher(t){return this.displayData.isSecondHigher(t+.5)||this.displayData.isSecondHigher(t)||this.displayData.isSecondHigher(t-.5)}lineToY(t){return this.note.lineToY(t)}}var ha=b(212642),af=Object.defineProperty,hf=(s,t,e)=>t in s?af(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,la=(s,t,e)=>hf(s,typeof t!="symbol"?t+"":t,e);const dl=new Map([[$e.A.TREMOLO1,"tremolo1"],[$e.A.TREMOLO2,"tremolo2"],[$e.A.TREMOLO3,"tremolo3"],[$e.A.TREMOLO4,"tremolo4"],[$e.A.TREMOLO5,"tremolo5"],[Sr.A.BUZZ,"buzzRoll"]]);function lf(s){if(!s.getDisplayData().isNormalStaff())return;new cf(s).process()}class cf{constructor(t){la(this,"note"),la(this,"displayData"),la(this,"ctx"),this.note=t,this.displayData=t.getDisplayData(),this.ctx=t.getDrawingContext()}process(){let t=this.displayData.getOrnaments();t=t.filter(df),uf(t).forEach(this.addGlyph,this)}addGlyph(t){const e=this.note.getChildRoot(),r=this.ctx.createGroupNode();v(e,r);const i=this.ctx.createGlyphNode(t.id);v(r,i);const a=this.getPosX(i),l=this.getPosY(t.nbLines);r.setX(a),r.setY(l),this.note.setTechnical(r),this.updateLimit(l,i)}getPosX(t){const e=this.note.getMiddleHeadWidth(),r=t.getWidth(),i=this.ctx.getStemThickness()/2,a=this.getStemValue();return this.hasStem()?a===z.A.UP?e/2+r/2-i:(a===z.A.DOWN,0):e/2}getPosY(t){let e=1+(t-1)/2;const r=this.displayData.getNbFlags();e+=r;const i=this.displayData.getStemQueueLine(),a=this.getLinePLacementCoeff(),l=i-e*a;return this.note.lineToY(l)}updateLimit(t,e){const r=e.getLocalBBox(),i=this.displayData.getStemValue();i===z.A.UP?this.note.setHighestY(t+r.minY):i===z.A.DOWN?this.note.setLowestY(t+r.maxY):z.A.raiseError(i)}getLinePLacementCoeff(){const t=this.displayData.getStemValue();if(t===z.A.UP)return 1;if(t===z.A.DOWN)return-1;throw z.A.raiseError(t),new Error("Unreachable")}hasStem(){return this.displayData.hasStem()}getStemValue(){return this.displayData.getStemValue()}}function uf(s){return s.map(ff)}function df(s){return dl.has(s)}function ff(s){const t=dl.get(s);if(typeof t=="undefined")throw new Error("Invalid articulation");const e=ha.A.ornamentToNbLines(s);return{id:t,nbLines:e}}var gf=Object.defineProperty,pf=(s,t,e)=>t in s?gf(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,bi=(s,t,e)=>pf(s,typeof t!="symbol"?t+"":t,e);function mf(s){const t=s.getDisplayData();if(!t.isNormalStaff()||t.isSlash()||!t.hasStem()||t.isRest())return;new yf(s).process()}class yf{constructor(t){bi(this,"note"),bi(this,"displayData"),bi(this,"ctx"),bi(this,"beamData",null),this.note=t,this.displayData=t.getDisplayData(),this.ctx=t.getDrawingContext(),this.displayData.hasBeam()&&(this.beamData=this.displayData.getBeamData())}process(){const t=this.getStemValue();Af(t);const e=this.getTailY(),r=0,i=this.ctx.createLineNode(),a=this.getStemWidth();i.setWidth(a);const l=this.note.getStemYOffset();i.setX(r),i.setX2(0),i.setY(l),i.setY2(e-l);const d=this.note.getStemBaseGroup();v(d,i),this.note.setStem(i)}getTailY(){const t=this.displayData.getStemQueueLine(),e=this.displayData.getStemBaseLine(),i=-(t-e);return this.note.setHighestLowestYLine(t),i}getStemWidth(){return this.ctx.getStemThickness()}getStemValue(){return this.displayData.getStemValue()}}function Af(s){s!==z.A.UP&&s!==z.A.DOWN&&vf(s)}function vf(s){const t=`cannot draw stem with ${s} value`;throw new Error(t)}var Le=b(920939),Gs=b(614426),Sf=Object.defineProperty,wf=(s,t,e)=>t in s?Sf(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,$i=(s,t,e)=>wf(s,typeof t!="symbol"?t+"":t,e);const xf="accidentalParensLeft",Hn="accidentalParensRight",bf=new Map([[Gs.default.SHARPSHARP,"accidentalDoubleSharp"],[Gs.default.DOUBLESHARP,"accidentalDoubleSharp"],[Gs.default.THREEQUARTERSHARP,"accidentalThreeQuarterTonesSharpArabic"],[Gs.default.SHARP,"accidentalSharp"],[Gs.default.QUARTERSHARP,"accidentalQuarterToneSharpArabic"],[Gs.default.NATURAL,"accidentalNatural"],[Gs.default.QUARTERFLAT,"accidentalQuarterToneFlatArabic"],[Gs.default.FLAT,"accidentalFlat"],[Gs.default.THREEQUARTERFLAT,"accidentalThreeQuarterTonesFlatArabic"],[Gs.default.FLATFLAT,"accidentalDoubleFlat"]]);class ca{constructor(t,e,r,i){$i(this,"groupNode"),$i(this,"list"),$i(this,"middleEntity"),$i(this,"drawingContext"),$i(this,"staffData"),this.groupNode=t.createGroupNode(),this.list=Pf(e,r,t),this.middleEntity=Df(this.list),this.drawingContext=t,this.staffData=i,this.attachGlyphs()}attachGlyphs(){let t=0;this.list.forEach((e,r)=>{r>0&&(t-=e.glyph.minX),v(this.groupNode,e),e.setX(t),t+=e.glyph.maxX})}setColor(t){this.middleEntity.setColor(t)}setPosX(t){this.groupNode.setX(t)}setLine(t){const e=this.lineToY(t);this.groupNode.setY(e)}lineToY(t){return Le.A.lineToY(t,this.staffData.spaceSize,this.staffData.nbStaffLines)}getHighestY(){const t=this.groupNode.getBBox();if(t===null)throw new Error("accidental bbox is null");return t.maxY}getLowestY(){const t=this.groupNode.getBBox();if(t===null)throw new Error("accidental bbox is null");return t.minY}getChildRoot(){return this.groupNode}getWidth(){return this.groupNode.getWidth()}}function Pf(s,t,e){const r=[];if(t){const i=e.createGlyphNode(xf);r.push(i)}{const i=Ef(s),a=e.createGlyphNode(i);r.push(a)}if(t){const i=e.createGlyphNode(Hn);r.push(i)}return r}function Ef(s){const t=bf.get(s);if(typeof t=="undefined"){const e=`the value ${s} for accidentals is not supported`;throw new Error(e)}return t}function Df(s){if(s.length===1)return s[0];if(s.length===3)return s[1];throw new Error(`Unexpected accidental glyphs list size ${s.length}`)}var Cf=Object.defineProperty,Tf=(s,t,e)=>t in s?Cf(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Zi=(s,t,e)=>Tf(s,typeof t!="symbol"?t+"":t,e);class fl{constructor(t){Zi(this,"accidentals"),Zi(this,"secondHighers"),Zi(this,"lowerProcessed"),Zi(this,"higherProcessed"),Zi(this,"scheduledAccidentals"),this.accidentals=t,this.secondHighers=this.accidentals.filter(Rf),this.scheduledAccidentals=[],this.lowerProcessed=!1,this.higherProcessed=!1}getScheduledAccidentals(){return(!this.lowerProcessed||!this.higherProcessed)&&this.calcScheduledAccidentals(),this.scheduledAccidentals}calcScheduledAccidentals(){this.scheduleSeconds(),this.scheduleOthers()}scheduleSeconds(){if(this.isHighestAccidentalSecondHigher()){const t=this.secondHighers[0];this.scheduleSecondHigher(t)}if(this.isLowestAccidentalSecondHigher()){const t=this.secondHighers.length-1,e=this.secondHighers[t];this.scheduleSecondHigher(e)}this.secondHighers.forEach(this.scheduleSecondHigher.bind(this))}isHighestAccidentalSecondHigher(){return this.secondHighers.length===0?!1:this.secondHighers[0]===this.accidentals[0]}isLowestAccidentalSecondHigher(){if(this.secondHighers.length===0)return!1;const t=this.secondHighers.length-1,e=this.accidentals.length-1,r=this.accidentals[e],i=this.secondHighers[t];if(i===r)return!0;if(this.accidentals.length<2)return!1;const a=this.accidentals.length-2;return i!==this.accidentals[a]?!1:this.hasSecondLowerAccidental(i)}scheduleSecondHigher(t){if(this.scheduledAccidentals.push(t),this.hasSecondLowerAccidental(t)){t.hasSecondLowerAccidental=!0;const r=this.getSecondLowerAccidental(t);this.markAccidentalProcessed(r),this.scheduledAccidentals.push(r)}this.markAccidentalProcessed(t);const e=this.secondHighers.indexOf(t);this.secondHighers.splice(e,1)}hasSecondLowerAccidental(t){const e=this.accidentals.indexOf(t);if(e===this.accidentals.length-1)return!1;const r=this.accidentals[e+1];return t.line-r.line===.5}getSecondLowerAccidental(t){const r=this.accidentals.indexOf(t)+1;return this.accidentals[r]}scheduleOthers(){if(this.hasFirst()){const t=this.accidentals[0];this.scheduleAccidental(t)}if(this.hasLast()){const t=this.accidentals.length-1,e=this.accidentals[t];this.scheduleAccidental(e)}this.accidentals.concat().forEach(this.scheduleAccidental.bind(this))}hasFirst(){return!this.higherProcessed&&this.accidentals.length>0}hasLast(){return!this.lowerProcessed&&this.accidentals.length>0}scheduleAccidental(t){this.scheduledAccidentals.push(t),this.markAccidentalProcessed(t)}markAccidentalProcessed(t){const e=this.accidentals.indexOf(t);e===0&&!this.higherProcessed&&(this.higherProcessed=!0),e===this.accidentals.length-1&&!this.lowerProcessed&&(this.lowerProcessed=!0),this.accidentals.splice(e,1)}}function Rf(s){return!!s.secondHigher}var Nf=Object.defineProperty,Lf=(s,t,e)=>t in s?Nf(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,ua=(s,t,e)=>Lf(s,typeof t!="symbol"?t+"":t,e);const _n=3;class Mf{constructor(t,e){ua(this,"minLine"),ua(this,"columns"),ua(this,"columnLength"),this.minLine=t,this.columns=[],this.columnLength=(e-t)*2+1}getAvailableColumn(t,e){typeof e=="undefined"&&(e=0);let r=e;for(;!this.isAvailableColumn(r,t);)r++;return r}isAvailableColumn(t,e){return typeof this.columns[t]=="undefined"?!0:this.isAvailableLine(t,e)}isAvailableLine(t,e){return this.isLowerLinesAvailable(t,e)?this.isThisAndHigherLinesAvailable(t,e):!1}isLowerLinesAvailable(t,e){let r=this.lineToIdx(e);r--;for(let i=r;i>=0&&r-i<_n;i--)if(!this.isLineAvailable(t,i))return!1;return!0}isThisAndHigherLinesAvailable(t,e){const r=this.lineToIdx(e);for(let i=r;i<this.columnLength&&i-r<_n;i++)if(!this.isLineAvailable(t,i))return!1;return!0}isLineAvailable(t,e){return this.columns[t][e]}lineToIdx(t){return(t-this.minLine)*2}makeSpaceTaken(t,e){typeof this.columns[t]=="undefined"&&this.addColumn(),this.takeLowerLinesInColumn(t,e),this.takeThisAndHigherLinesInColumn(t,e)}addColumn(){const t=[];for(let e=0;e<this.columnLength;e++)t.push(!0);this.columns.push(t)}takeLowerLinesInColumn(t,e){let r=this.lineToIdx(e);r--;for(let i=r;i>=0&&r-i<_n;i--)this.makeLineTaken(t,i)}takeThisAndHigherLinesInColumn(t,e){const r=this.lineToIdx(e);for(let i=r;i<this.columnLength&&i-r<_n;i++)this.makeLineTaken(t,i)}makeLineTaken(t,e){this.columns[t][e]=!1}}var br=Object.defineProperty,Pr=Object.defineProperties,Pt=Object.getOwnPropertyDescriptors,Vr=Object.getOwnPropertySymbols,da=Object.prototype.hasOwnProperty,Of=Object.prototype.propertyIsEnumerable,hs=(s,t,e)=>t in s?br(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Gn=(s,t)=>{for(var e in t||(t={}))da.call(t,e)&&hs(s,e,t[e]);if(Vr)for(var e of Vr(t))Of.call(t,e)&&hs(s,e,t[e]);return s},Bf=(s,t)=>Pr(s,Pt(t)),me=(s,t,e)=>hs(s,typeof t!="symbol"?t+"":t,e);function Er(s){const t=s.getDisplayData();if(!t.isNormalStaff()||!t.hasAccidentals())return;new gl(s).process()}class gl{constructor(t){me(this,"note"),me(this,"ctx"),me(this,"displayData"),me(this,"noteRoot"),this.note=t,this.ctx=t.getDrawingContext(),this.displayData=t.getDisplayData(),this.noteRoot=t.getChildRoot()}process(){const t=this.displayData.getAccidentals().map(f=>Bf(Gn({},f),{hasSecondLowerAccidental:!1,drawer:null,column:null}));t.reverse();const r=new fl(t).getScheduledAccidentals();Dr(r),this.fillDrawers(r);const i=ls(r),a=this.getMarginSize()/2+i;let l=this.getMarginSize()/2,d=0;l+=this.note.getLeftHeadWidth(),r.forEach(f=>{const m=f.drawer;if(m===null)throw new Error("Missing accidental drawer");if(f.column===null)throw new Error("Column is not set for accidental ");v(this.noteRoot,m.getChildRoot());const S=i-m.getWidth(),w=(f.column+1)*a-S,x=-w-l;m.setPosX(x);const D=m.getChildRoot();this.note.addAccidental(D),d=Math.max(w,d);const L=m.getHighestY();this.note.setHighestY(L);const M=m.getLowestY();this.note.setLowestY(M)}),this.note.setAccidentalsWidth(d)}getMarginSize(){const t=this.getSizeCoeff();return this.ctx.getMarginSize()*t}getSizeCoeff(){return this.displayData.isGrace()?this.ctx.getGraceSizeCoeff():1}fillDrawers(t){t.forEach(this.fillDrawer,this)}fillDrawer(t){const e=new ca(this.ctx,t.accidental,t.parentheses,this.note.staffData);t.color&&e.setColor(t.color),e.setLine(t.line),t.drawer=e}}function Dr(s){const t=Xn(s),e=new Mf(t.min,t.max);for(let r=0;r<s.length;r++){const i=s[r];if(pl(e,i),i.hasSecondLowerAccidental){r++;const a=s[r];if(i.column===null)throw new Error("Column for accidental should be set at this point");const l=i.column+1;pl(e,a,l)}}}function Xn(s){let t=null;for(const e of s){const r=e.line;t===null?t={min:r,max:r}:r>t.max?t.max=r:r<t.min&&(t.min=r)}if(t===null)throw new Error("No accidentals");return t}function pl(s,t,e){const r=t.line,i=s.getAvailableColumn(r,e);s.makeSpaceTaken(i,r),t.column=i}function ls(s){return s.map(Qr).reduce(Dt.default.max2)}function Qr(s){if(s.drawer===null)throw new Error("Missing drawer in accidental data");return s.drawer.getWidth()}var ji=Object.defineProperty,If=(s,t,e)=>t in s?ji(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,tn=(s,t,e)=>If(s,typeof t!="symbol"?t+"":t,e);class Cr{constructor({drawingContext:t,glyphId:e,isVerticallyCentered:r,isGrace:i}){if(tn(this,"ctx"),tn(this,"glyphId"),tn(this,"isVerticallyCentered"),tn(this,"isGrace",!1),tn(this,"glyph"),this.ctx=t,this.glyphId=e,this.isGrace=i,this.isVerticallyCentered=r,this.isGrace){const a=this.ctx.getGraceSizeCoeff();this.glyph=this.ctx.createGlyphNode(this.glyphId,a)}else this.glyph=this.ctx.createGlyphNode(this.glyphId)}getHeight(){return this.glyph.getHeight()}getWidth(){return this.glyph.getWidth()}getChildRoot(){return this.glyph}setColor(t){this.glyph.setColor(t)}}var Ff=Object.defineProperty,Uf=(s,t,e)=>t in s?Ff(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Wn=(s,t,e)=>Uf(s,typeof t!="symbol"?t+"":t,e);class Tr{constructor(t,e,r){Wn(this,"ctx"),Wn(this,"textStr"),Wn(this,"text"),Wn(this,"isSmall",!1),this.textStr=e,this.ctx=t,this.text=this.getText(),r&&(this.isSmall=r)}setIsSmall(t){this.isSmall=t}getText(){return this.ctx.createTextNode(this.textStr,this.ctx.getFretTextFontOptions())}getHeight(){return this.text.getFontSize()/2}getSizeRatio(){return this.isSmall?this.ctx.getGraceSizeCoeff():1}getWidth(){return this.getText().getWidth()}setPosX(t){var e;(e=this.text)==null||e.setX(t)}getChildRoot(){return this.text}setColor(t){this.text.setColor(t)}destroy(){this.text.destroy()}}var Hf=Object.defineProperty,_f=(s,t,e)=>t in s?Hf(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,fa=(s,t,e)=>_f(s,typeof t!="symbol"?t+"":t,e);class Gf{constructor(){fa(this,"ctx"),fa(this,"cache",[]),fa(this,"result",[])}merge(t,e){this.ctx=t,this.cache=[],this.result=[],e.forEach(this.processEntity,this),this.flushCache();const r=this.result;return this.result=[],r}processEntity(t){if(t instanceof Cr)this.flushCache(),this.result.push(t);else if(t instanceof Tr)this.canAddInCache(t)||this.flushCache(),this.cache.push(t);else throw new Error("An invalid fret entity is provided")}canAddInCache(t){if(this.cache.length===0)return!0;const[e]=this.cache;return t.isSmall===e.isSmall}flushCache(){if(this.cache.length!==0){if(this.cache.length===1)this.result.push(this.cache.pop());else if(this.ctx){const t=this.cache[0].isSmall,e=this.cache.map(i=>i.textStr).join(""),r=new Tr(this.ctx,e);r.setIsSmall(t),this.result.push(r),this.cache.forEach(i=>i.destroy()),this.cache=[]}}}}const Xf=new Gf;function Wf(s,t){return Xf.merge(s,t)}var zf=Object.defineProperty,Yf=(s,t,e)=>t in s?zf(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Rr=(s,t,e)=>Yf(s,typeof t!="symbol"?t+"":t,e);const ml="#c8c8c8",ga="noteheadParenthesisLeft",yl="noteheadParenthesisRight",kf={4:"restWhole",2:"restHalf",1:"restQuarter",.5:"rest8th",.25:"rest16th",.125:"rest32nd",.0625:"rest64th"},Al=["luteItalianFret0","luteItalianFret1","luteItalianFret2","luteItalianFret3","luteItalianFret4","luteItalianFret5","luteItalianFret6","luteItalianFret7","luteItalianFret8","luteItalianFret9"];function vl(s){return s!==null}function qf(s){const t=kf[s];if(typeof t=="undefined"){const e=`There is no rest glyph for the quarter duration [${s}].`;throw new Error(`NoRestGlyph: ${e}`)}return t}function Vf(s,t){if(s===4||s===2){const r=Math.ceil(t/2);return s===4?r+1:r}return Math.floor(t/2)+1}function Qf(s){return s.getHeight()}function Kf(s,t){return s+t}function Sl(s){if(!s.getDisplayData().isTabStaff())return;new Jf(s).process()}class Jf{constructor(t){Rr(this,"note"),Rr(this,"ctx"),Rr(this,"displayData"),Rr(this,"heads"),Rr(this,"head",null),Rr(this,"frets"),Rr(this,"maxWidth",0),Rr(this,"widths",[]),this.note=t,this.ctx=t.getDrawingContext(),this.displayData=t.getDisplayData(),this.frets=this.displayData.getFrets().filter(vl),this.heads=this.frets.map(this.initHead,this)}initHead(t){let e=[];if(t.isDeadNote){const i=new Tr(this.ctx,"X");e.push(i)}else{const i=this.displayData.isGrace(),a=this.ctx.hasFretNumberFont(),l=this.fretNumberToEntities(t.fretNumber,i,a);if(Array.prototype.push.apply(e,l),typeof t.artificialHarmonicTouchingFretNumber!="undefined"){const d=this.getLeftParenthesis();e.push(d);const f=this.fretNumberToEntities(t.artificialHarmonicTouchingFretNumber,!1,a);Array.prototype.push.apply(e,f);const m=this.getRightParenthesis();e.push(m)}}if(t.isNaturalHarmonic){const i=new Tr(this.ctx,"<");e.unshift(i);const a=new Tr(this.ctx,">");e.push(a)}if(t.hasParenthesis){const i=this.getLeftParenthesis();e.unshift(i);const a=this.getRightParenthesis();e.push(a)}return e=Wf(this.ctx,e),{entities:e,string:t.string,isHidden:t.isHidden,posX:null,isGreyed:t.isGreyed}}process(){this.computeWidths(),this.heads.forEach(this.setHeadPosX,this),this.drawFrets(),this.fillRenderedNoteData(),this.note.setLeftStemX(0)}computeWidths(){this.heads.length===0?(this.maxWidth=this.getRestWidth(),this.widths=[this.maxWidth]):(this.widths=this.heads.map(this.computeHeadWidth,this),this.maxWidth=Math.max(...this.widths))}getRestWidth(){const t=Al[0];return this.ctx.createGlyphNode(t).getWidth()}computeHeadWidth(t){return this.head=t,this.getTotalWidth()}getTotalWidth(){if(this.head!==null){const t=this.head.entities;return this.getTotalWidthToIdx(t.length)}else return this.getRestWidth()}getTotalWidthToIdx(t){if(this.head!==null){const r=this.head.entities.slice(0,t);return r.length!==0?r.map(this.getWidth,this).reduce(Kf):0}return 0}getWidth(t){return t.getWidth()+.1}setHeadPosX(t,e){const r=this.widths[e];t.posX=(this.maxWidth-r)/2}drawFrets(){this.heads.forEach(this.drawFret,this),this.heads.length===0&&this.drawRestHead()}getLeftParenthesis(){return this.ctx.hasFretNumberFont()?new Tr(this.ctx,"("):new Cr({drawingContext:this.ctx,glyphId:ga,isVerticallyCentered:!0,isGrace:!1})}getRightParenthesis(){return this.ctx.hasFretNumberFont()?new Tr(this.ctx,")"):new Cr({drawingContext:this.ctx,glyphId:yl,isVerticallyCentered:!0,isGrace:!1})}fretNumberToEntities(t,e,r){const i=t.toString();if(r){const l=new Tr(this.ctx,i);return l.setIsSmall(e),[l]}const a=[];for(let l=0;l<i.length;l++){const d=i[l],f=Number.parseInt(d,10),m=Al[f],S=new Cr({drawingContext:this.ctx,glyphId:m,isVerticallyCentered:!1,isGrace:e});a.push(S)}return a}getYPos(t){const e=this.ctx.getTabSpaceSize();return Le.A.stringToY(t,e)}drawFret(t){this.head=t;const e=this.getYPos(t.string),r=this.renderHeadGroup(e);this.head.isHidden||(this.renderBackground(),t.entities.forEach((i,a)=>{this.drawEntity(i,a,r)}))}renderHeadGroup(t){var e;if(this.head===null)throw Error("head should exist by now");return this.head.group=this.ctx.createGroupNode(),this.head.group.setX((e=this.head.posX)!=null?e:0),this.head.group.setY(t),this.note.setStringHead(this.head.string,this.head.group),this.head.group}renderBackground(){if(this.head===null||typeof this.head.group=="undefined")throw Error("head groupshould exist by now");const t=this.getTotalWidth(),e=this.getHighestHeight(),r=this.ctx.createBeamNode(e);r.noClone=!0,r.setY(-e/2),r.setY2(0),r.setX(0),r.setX2(t),r.setColor("#ffffff"),r.updatePath(),v(this.head.group,r)}getHighestHeight(){var t;return typeof((t=this.head)==null?void 0:t.entities)!="undefined"?this.head.entities.map(Qf).reduce(Dt.default.max2,0):0}drawEntity(t,e,r){if(this.head===null)throw Error("head should exist by now");let i=this.getTotalWidthToIdx(e);t instanceof Cr&&t.glyphId===yl&&(i+=t.getWidth()/2),t instanceof Cr&&t.isVerticallyCentered||t.getChildRoot().setY(t.getHeight()/2),t.getChildRoot().setX(i),this.head.isGreyed&&t.setColor(ml),v(r,t.getChildRoot())}drawRestHead(){if(![3,4].includes(this.displayData.opts.lines[0])||!this.ctx.showTabRests()&&!this.ctx.hideNonTab()){this.attachPlaceholder();return}const e=this.displayData.getBaseQuarterDuration(),r=qf(e),i=this.ctx.createGlyphNode(r),a=this.displayData.getNbStaffLines(),l=Vf(e,a),d=this.ctx.getTabSpaceSize(),f=Le.A.lineToY(l,d,a);i.setY(f);const m=this.note.getChildRoot();v(m,i)}attachPlaceholder(){this.note.getChildRoot().setBBoxOverride({minX:0,maxX:0,minY:0,maxY:0})}fillRenderedNoteData(){this.note.setLeftHeadWidth(0),this.note.setRightHeadWidth(0),this.note.setFretsWidth(this.maxWidth),this.note.setMiddleHeadWidth(this.maxWidth)}}var Rs=Object.defineProperty,pa=(s,t,e)=>t in s?Rs(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Nr=(s,t,e)=>pa(s,typeof t!="symbol"?t+"":t,e);const $f="arrowheadBlackUp",ma="arrowheadBlackDown",ya=.2,wl=.5,Zf=.7;class ce{constructor({drawingContext:t,direction:e,height:r,posX:i,posY:a}){Nr(this,"drawingContext"),Nr(this,"direction"),Nr(this,"height"),Nr(this,"posX"),Nr(this,"posY"),Nr(this,"group"),Nr(this,"line"),Nr(this,"arrow"),this.drawingContext=t,this.height=r,this.direction=e,this.posX=i,this.posY=a,this.group=this.drawingContext.createGroupNode(),this.arrow=this.getArrowGlyph(),this.line=this.drawingContext.createLineNode(),this.drawLine(),this.drawArrow(),this.group.setX(this.posX),this.group.setY(this.posY)}getChildRoot(){return this.group}drawLine(){const t=this.drawingContext.getStemThickness(),e=this.getLineY1(),r=this.getLineY2()-e;this.line.setWidth(t),this.line.setX(0),this.line.setX2(0),this.line.setY(e),this.line.setY2(r),v(this.group,this.line)}drawArrow(){const t=this.getArrowY(),e=-this.getWidth()/2;this.arrow.setX(e),this.arrow.setY(t),v(this.group,this.arrow)}getLineY1(){const t=this.drawingContext.getTabSpaceSize();let r=0-t*wl;if(this.direction===Ae.default.DOWNBOW){const i=t*ya;r+=i}return r}getLineY2(){const t=this.drawingContext.getTabSpaceSize(),e=t*wl;let r=this.height+e;if(this.direction===Ae.default.UPBOW){const i=t*ya;r-=i}return r}getArrowY(){const e=this.drawingContext.getTabSpaceSize()*ya;if(this.direction===Ae.default.DOWNBOW)return 0-e;if(this.direction===Ae.default.UPBOW){const r=this.arrow.getHeight();return this.height+r+e}else Ae.default.raiseError(this.direction)}getTrailingSpace(){return this.getWidth()/2}getWidth(){return this.getArrowGlyph().getWidth()}getArrowGlyph(){const t=this.getArrowGlyphId();return this.drawingContext.createGlyphNode(t,Zf)}getArrowGlyphId(){if(this.direction===Ae.default.DOWNBOW)return $f;if(this.direction===Ae.default.UPBOW)return ma;Ae.default.raiseError(this.direction)}}var xl=Object.defineProperty,jf=(s,t,e)=>t in s?xl(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Pi=(s,t,e)=>jf(s,typeof t!="symbol"?t+"":t,e);function tg(s){const t=s.getDisplayData();if(!t.isTabStaff())return;const e=t.getTechnical();let r=null;e.forEach(a=>{(a===Ae.default.UPBOW||a===Ae.default.DOWNBOW)&&(r=a)}),(r===Ae.default.UPBOW||r===Ae.default.DOWNBOW)&&new eg(s).process()}class eg{constructor(t){Pi(this,"note"),Pi(this,"ctx"),Pi(this,"displayData"),Pi(this,"hasDirection",!1),Pi(this,"direction",null),Pi(this,"topString",null),this.note=t,this.ctx=t.getDrawingContext(),this.displayData=t.getDisplayData()}process(){const t=this.getDirection(),e=this.getHeight(),r=this.getTopString(),i=this.lineToY(r),l=-this.getInitialShift(),d=new ce({drawingContext:this.ctx,direction:t,height:e,posX:l,posY:i});this.note.addArpeggio(d)}getDirection(){return this.hasDirection||(this.displayData.getTechnical().forEach(e=>{(e===Ae.default.UPBOW||e===Ae.default.DOWNBOW)&&(this.direction=e)}),this.hasDirection=!0),this.direction}getTopString(){if(this.topString===null){const r=this.displayData.getFrets().filter(qi.default.isNotNull).map(i=>i.string);this.topString=Math.min(...r)}return this.topString}getHeight(){const t=this.getTopString(),i=this.displayData.getFrets().filter(qi.default.isNotNull).map(f=>f.string),l=Math.max(...i)-t;return this.ctx.getTabSpaceSize()*l}getInitialShift(){let t=0;return t+=this.note.getLeftHeadWidth(),t+=this.ctx.getMarginSize()/2,t}lineToY(t){const e=this.ctx.getTabSpaceSize();return Le.A.stringToY(t,e)}}var sg=Object.defineProperty,rg=(s,t,e)=>t in s?sg(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,zn=(s,t,e)=>rg(s,typeof t!="symbol"?t+"":t,e);function ig(s){const t=s.getDisplayData();if(!t.isTabStaff())return;t.getNbDots()>0&&t.hasFrets()&&!t.isGrace()&&new ng(s).process()}const bl="augmentationDot";class ng{constructor(t){zn(this,"note"),zn(this,"ctx"),zn(this,"displayData"),zn(this,"glyphWidth",null),this.note=t,this.ctx=t.getDrawingContext(),this.displayData=t.getDisplayData()}process(){this.drawDots()}drawDots(){const t=this.getGlyphWidth(),e=this.note.getStemBaseGroup(),r=this.note.getFretsWidth();if(r===null)throw Error("fretsWidth should be defined by now");let i=r/2;this.displayData.getBaseQuarterDuration()>1&&(i*=2);const a=0,l=this.ctx.getMarginSize();let d=l;const f=this.displayData.getNbDots();for(let m=0;m<f;m++){const S=i+d,w=this.ctx.createGlyphNode(bl);w.setX(S),w.setY(a),this.note.addDot(w),this.note.setDotWidth(t),this.note.setDotMargin(d),d+=t+l,v(e,w)}}getGlyphWidth(){if(this.glyphWidth===null){const t=this.ctx.nodeContext.glyphsCache.getGlyph(bl,1);this.glyphWidth=t.maxX-t.minX}return this.glyphWidth}}var og=Object.defineProperty,ag=(s,t,e)=>t in s?og(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Yn=(s,t,e)=>ag(s,typeof t!="symbol"?t+"":t,e);function hg(s){const t=s.getDisplayData();if(!t.isTabStaff())return;const e=t.getFingerings();typeof e!="undefined"&&e.length>0&&new cg(s).process()}const Ns="fingering";function lg(s){return`${Ns}${s}`}class cg{constructor(t){Yn(this,"note"),Yn(this,"ctx"),Yn(this,"displayData"),Yn(this,"yPos",0),this.note=t,this.ctx=t.getDrawingContext(),this.displayData=t.getDisplayData()}process(){const t=this.getPlacement();t===I.A.ABOVE?this.drawAbove():t===I.A.BELOW?this.drawBelow():I.A.raiseError(t)}drawAbove(){const t=this.note.getHighestY()-.5,e=-1;this.yPos=Math.min(e,t);const r=this.displayData.getFingerings().slice();r.reverse(),r.forEach(this.drawFingeringAbove,this)}drawFingeringAbove(t){const e=this.drawFingering(t);this.yPos-=e.getHeight(),this.yPos-=this.ctx.getMarginSize(),this.note.setHighestY(this.yPos)}drawBelow(){const e=this.displayData.getNbStaffLines()-1,r=this.note.getLowestY();this.yPos=Math.max(r,e),this.displayData.getFingerings().forEach(this.drawFingeringBelow,this)}drawFingeringBelow(t){this.yPos+=this.ctx.getMarginSize();const e=this.drawFingering(t);this.yPos+=e.getHeight(),this.note.setLowestY(this.yPos)}drawFingering(t){const e=lg(t),r=this.ctx.createGlyphNode(e),i=this.note.getGroup(),a=r.getWidth(),l=this.note.getFretsWidth();if(l===null)throw Error("fretsWidth should be defined by now");const d=l/2-a/2;let f=this.yPos;return this.getPlacement()===I.A.BELOW&&(f+=r.getHeight()),r.setX(d),r.setY(f),v(i,r),r}getPlacement(){const t=this.displayData.getStemStrategy();if(t===zt.A.AUTO)return I.A.ABOVE;if(zt.A.isUp(t))return I.A.ABOVE;if(zt.A.isDown(t))return I.A.BELOW;zt.A.raiseError(t)}}var ug=Object.defineProperty,dg=(s,t,e)=>t in s?ug(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Kr=(s,t,e)=>dg(s,typeof t!="symbol"?t+"":t,e);function fg(s){const t=s.getDisplayData();if(!t.isTabStaff())return;!t.isRest()&&t.getNbFlagsOrBeams()>0&&!t.hasBeam()&&t.hasFrets()&&!t.isGrace()&&new gg(s).process()}class gg{constructor(t){Kr(this,"note"),Kr(this,"ctx"),Kr(this,"displayData"),Kr(this,"stemValue"),Kr(this,"nbFlags"),Kr(this,"glyphId",null),Kr(this,"glyph",null),this.note=t,this.ctx=t.getDrawingContext(),this.displayData=t.getDisplayData(),this.stemValue=this.displayData.getStemValue(),this.nbFlags=this.displayData.getNbFlags(),this.checkStemValue()}checkStemValue(){this.stemValue!==z.A.UP&&this.stemValue!==z.A.DOWN&&this.stemValueError()}stemValueError(){throw new Error(`InconsistentValues cannot draw tab flag for stem with ${this.stemValue} value`)}process(){this.retrieveFlagGlyphId(),this.glyph=this.getGlyph();const t=this.ctx.createGroupNode(),e=this.getFlagX(),r=this.getFlagY();t.setX(e),t.setY(r);const i=this.glyph.getWidth();this.note.setFlag(t,i),v(t,this.glyph),v(this.note.getStemBaseGroup(),t)}retrieveFlagGlyphId(){this.glyphId=this.getFlagGlyphId()}getFlagGlyphId(){let t="flag";const e=Ji.A.get(2+this.nbFlags);return t+=e,this.stemValue===z.A.UP?t+="Up":this.stemValue===z.A.DOWN&&(t+="Down"),t}getGlyph(){if(this.glyphId===null)throw new Error("glyphId should be defined by now");if(this.displayData.isGrace()){const t=this.ctx.getGraceFlagSizeCoeff();return this.ctx.createGlyphNode(this.glyphId,t)}else return this.ctx.createGlyphNode(this.glyphId)}getFlagX(){const t=this.note.getFretsWidth();if(t===null)throw Error("fretsWidth shouldnt be null by now");const e=this.ctx.getStemThickness();return t/2-e/2}getFlagY(){const t=this.displayData.getStemQueueLine(),e=this.displayData.getStemBaseLine(),i=-(t-e),a=this.getCounterOffset();return i+a}getCounterOffset(){let t=Math.max(0,this.nbFlags-2)/2;this.displayData.isGrace()&&(t/=2);const e=t*this.ctx.getTabSpaceSize();if(this.stemValue===z.A.UP)return e;if(this.stemValue===z.A.DOWN)return-e;throw new Error("unreachable")}}var be=b(259563),pg=Object.defineProperty,mg=(s,t,e)=>t in s?pg(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Aa=(s,t,e)=>mg(s,typeof t!="symbol"?t+"":t,e);function yg(s){s!==z.A.UP&&s!==z.A.DOWN&&Pl(s)}function Pl(s){throw new Error(`FeatureNotSupported: cannot draw stem with ${s} value`)}function Ag(s){const t=s.getDisplayData();if(!t.isTabStaff())return;const e=be.default.toQuarterDuration(be.default.HALF);!t.isRest()&&t.getBaseQuarterDuration()<=e&&t.hasFrets()&&!t.isGrace()&&new Pe(s).process()}class Pe{constructor(t){Aa(this,"note"),Aa(this,"ctx"),Aa(this,"displayData"),this.note=t,this.ctx=t.getDrawingContext(),this.displayData=t.getDisplayData()}process(){this.initStemPosition();const t=this.displayData.getStemValue();yg(t);const e=this.getTailY(),r=this.ctx.getStemThickness(),i=this.ctx.createLineNode();i.setWidth(r),i.setX(this.getStemX()),i.setY(0),i.setY2(e),v(this.note.getStemBaseGroup(),i)}getStemX(){const t=this.note.getFretsWidth(),e=this.ctx.getStemThickness();return t/2-e/2}getTailY(){const t=this.displayData.getStemQueueLine(),e=this.displayData.getStemBaseLine(),i=-(t-e);return this.note.setHighestLowestYLine(t),i}initStemPosition(){}}var Jr=b(364596),vg=b(399564),El=b(595382),Ht=b(351277),st=b(574459),n=b(62340),o=b.n(n);const h=255*3/2;function c(s,t){if(!s)return"white";const e=o()(s);if(!e)return"white";if(e.alpha===0)return"rgba(0, 0, 0, 0)";if(t!==st.Ay.QUARTER)return"white";const{values:r}=e;return r.reduce(Dt.default.add,0)>h?"black":"white"}const u="noteEmptyWhole",g="noteEmptyHalf",p="noteEmptyBlack";function A(s){if(s===st.Ay.WHOLE)return u;if(s===st.Ay.HALF)return g;if(s===st.Ay.QUARTER)return p;throw new Error(`Bad head duration value ${s}`)}const y=new Map([["C","#F72D3F"],["C#","#FA6D1E"],["D","#FF9929"],["D#","#FFC000"],["E","#FFE100"],["F","#77CA34"],["F#","#00AF50"],["G","#009688"],["G#","#005cb2"],["A","#673AB7"],["A#","#AF5DFF"],["B","#D843A1"]]);function P(s){const t=y.get(s);if(typeof t=="undefined"){const e=`The step value '${s}' is invalid.`;throw new Error(e)}return t}const E=[{duration:st.Ay.WHOLE,head:ot.A.NORMAL,glyphId:"noteheadWhole"},{duration:st.Ay.HALF,head:ot.A.NORMAL,glyphId:"noteheadHalf"},{duration:st.Ay.QUARTER,head:ot.A.NORMAL,glyphId:"noteheadBlack"},{duration:st.Ay.WHOLE,head:ot.A.X,glyphId:"noteheadXWhole"},{duration:st.Ay.HALF,head:ot.A.X,glyphId:"noteheadXHalf"},{duration:st.Ay.QUARTER,head:ot.A.X,glyphId:"noteheadXBlack"},{duration:st.Ay.WHOLE,head:ot.A.X_CIRCLE,glyphId:"noteheadCircleXWhole"},{duration:st.Ay.HALF,head:ot.A.X_CIRCLE,glyphId:"noteheadCircleXHalf"},{duration:st.Ay.QUARTER,head:ot.A.X_CIRCLE,glyphId:"noteheadCircleX"},{duration:st.Ay.WHOLE,head:ot.A.DIAMOND,glyphId:"noteheadDiamondWhole"},{duration:st.Ay.HALF,head:ot.A.DIAMOND,glyphId:"noteheadDiamondHalfWide"},{duration:st.Ay.QUARTER,head:ot.A.DIAMOND,glyphId:"noteheadDiamondBlackWide"},{duration:st.Ay.WHOLE,head:ot.A.SLASH,glyphId:"noteheadSlashWhiteWhole"},{duration:st.Ay.HALF,head:ot.A.SLASH,glyphId:"noteheadSlashWhiteHalf"},{duration:st.Ay.QUARTER,head:ot.A.SLASH,glyphId:"noteheadSlashHorizontalEnds"},{duration:st.Ay.WHOLE,head:ot.A.BIG_X,glyphId:"noteheadSlashWhiteWhole"},{duration:st.Ay.HALF,head:ot.A.BIG_X,glyphId:"noteheadSlashWhiteHalf"},{duration:st.Ay.QUARTER,head:ot.A.BIG_X,glyphId:"noteheadSlashX"},{duration:st.Ay.WHOLE,head:ot.A.TRIANGLE,glyphId:"noteheadTriangleUpWhole"},{duration:st.Ay.HALF,head:ot.A.TRIANGLE,glyphId:"noteheadTriangleUpHalf"},{duration:st.Ay.QUARTER,head:ot.A.TRIANGLE,glyphId:"noteheadTriangleUpBlack"},{duration:st.Ay.WHOLE,head:ot.A.BACK_SLASHED,glyphId:"noteheadSlashedWhole2"},{duration:st.Ay.HALF,head:ot.A.BACK_SLASHED,glyphId:"noteheadSlashedHalf2"},{duration:st.Ay.QUARTER,head:ot.A.BACK_SLASHED,glyphId:"noteheadSlashedBlack2"},{duration:st.Ay.WHOLE,head:ot.A.SLASHED,glyphId:"noteheadSlashedWhole1"},{duration:st.Ay.HALF,head:ot.A.SLASHED,glyphId:"noteheadSlashedHalf1"},{duration:st.Ay.QUARTER,head:ot.A.SLASHED,glyphId:"noteheadSlashedBlack1"},{duration:st.Ay.WHOLE,head:ot.A.SQUARE,glyphId:"noteheadSquareWhite"},{duration:st.Ay.HALF,head:ot.A.SQUARE,glyphId:"noteheadSquareWhite"},{duration:st.Ay.QUARTER,head:ot.A.SQUARE,glyphId:"noteheadSquareBlack"},{duration:st.Ay.WHOLE,head:ot.A.CROSS,glyphId:"noteheadPlusWhole"},{duration:st.Ay.HALF,head:ot.A.CROSS,glyphId:"noteheadPlusHalf"},{duration:st.Ay.QUARTER,head:ot.A.CROSS,glyphId:"noteheadPlusBlack"},{duration:st.Ay.WHOLE,head:ot.A.INVERTED_TRIANGLE,glyphId:"noteheadTriangleDownWhole"},{duration:st.Ay.HALF,head:ot.A.INVERTED_TRIANGLE,glyphId:"noteheadTriangleDownHalf"},{duration:st.Ay.QUARTER,head:ot.A.INVERTED_TRIANGLE,glyphId:"noteheadTriangleDownBlack"},{duration:st.Ay.WHOLE,head:ot.A.ARROW_DOWN,glyphId:"noteheadLargeArrowDownWhole"},{duration:st.Ay.HALF,head:ot.A.ARROW_DOWN,glyphId:"noteheadLargeArrowDownHalf"},{duration:st.Ay.QUARTER,head:ot.A.ARROW_DOWN,glyphId:"noteheadLargeArrowDownBlack"},{duration:st.Ay.WHOLE,head:ot.A.ARROW_UP,glyphId:"noteheadLargeArrowUpBlack"},{duration:st.Ay.HALF,head:ot.A.ARROW_UP,glyphId:"noteheadLargeArrowUpHalf"},{duration:st.Ay.QUARTER,head:ot.A.ARROW_UP,glyphId:"noteheadLargeArrowUpBlack"},{duration:st.Ay.WHOLE,head:ot.A.DO,glyphId:"noteShapeTriangleUpWhite"},{duration:st.Ay.HALF,head:ot.A.DO,glyphId:"noteShapeTriangleUpWhite"},{duration:st.Ay.QUARTER,head:ot.A.DO,glyphId:"noteShapeTriangleUpBlack"},{duration:st.Ay.WHOLE,head:ot.A.RE,glyphId:"noteShapeMoonWhite"},{duration:st.Ay.HALF,head:ot.A.RE,glyphId:"noteShapeMoonWhite"},{duration:st.Ay.QUARTER,head:ot.A.RE,glyphId:"noteShapeMoonBlack"},{duration:st.Ay.WHOLE,head:ot.A.MI,glyphId:"noteShapeDiamondWhite"},{duration:st.Ay.HALF,head:ot.A.MI,glyphId:"noteShapeDiamondWhite"},{duration:st.Ay.QUARTER,head:ot.A.MI,glyphId:"noteShapeDiamondBlack"},{duration:st.Ay.WHOLE,head:ot.A.FA,glyphId:"noteShapeTriangleRightWhite"},{duration:st.Ay.HALF,head:ot.A.FA,glyphId:"noteShapeTriangleRightWhite"},{duration:st.Ay.QUARTER,head:ot.A.FA,glyphId:"noteShapeTriangleRightBlack"},{duration:st.Ay.WHOLE,head:ot.A.FA_UP,glyphId:"noteShapeTriangleLeftWhite"},{duration:st.Ay.HALF,head:ot.A.FA_UP,glyphId:"noteShapeTriangleLeftWhite"},{duration:st.Ay.QUARTER,head:ot.A.FA_UP,glyphId:"noteShapeTriangleLeftBlack"},{duration:st.Ay.WHOLE,head:ot.A.SO,glyphId:"noteShapeRoundWhite"},{duration:st.Ay.HALF,head:ot.A.SO,glyphId:"noteShapeRoundWhite"},{duration:st.Ay.QUARTER,head:ot.A.SO,glyphId:"noteShapeRoundBlack"},{duration:st.Ay.WHOLE,head:ot.A.LA,glyphId:"noteShapeSquareWhite"},{duration:st.Ay.HALF,head:ot.A.LA,glyphId:"noteShapeSquareWhite"},{duration:st.Ay.QUARTER,head:ot.A.LA,glyphId:"noteShapeSquareBlack"},{duration:st.Ay.WHOLE,head:ot.A.TI,glyphId:"noteShapeTriangleRoundWhite"},{duration:st.Ay.HALF,head:ot.A.TI,glyphId:"noteShapeTriangleRoundWhite"},{duration:st.Ay.QUARTER,head:ot.A.TI,glyphId:"noteShapeTriangleRoundBlack"}];function O(s,t,e){s===ot.A.NORMAL&&e&&(s=ot.A.DIAMOND,t===st.Ay.QUARTER&&(t=st.Ay.HALF));const r={notehead:s,headDuration:t},i=E.find(C,r);if(typeof i=="undefined"){const a=`there is no glyph id for the note head [${s}] and the duration [${t}]`;throw new Error(a)}else return i.glyphId}function C(s){return s.head===this.notehead&&s.duration===this.headDuration}var B=b(606741);const Z="note",mt="Flat",ht="Sharp",ft="Whole",_t="Half",wt="Black";function ee(s,t,e){let r=Z;return r+=Xt(s),r+=ve(t),r+=Wt(e),r}function Xt(s){if(!B.default.isValid(s))throw new Error(`Bad step value ${s}`);return s}function ve(s){if(s===0)return"";if(s<0)return mt;if(s>0)return ht;throw new Error(`Bad alter value ${s}`)}function Wt(s){if(s===st.Ay.WHOLE)return ft;if(s===st.Ay.HALF)return _t;if(s===st.Ay.QUARTER)return wt;throw new Error(`Bad head duration value ${s}`)}const Rt=new Map([["C",ot.A.DO],["D",ot.A.RE],["E",ot.A.MI],["G",ot.A.SO],["A",ot.A.LA],["B",ot.A.TI]]);function Me(s,t){return s==="F"?Qe(s,t):Ze(s)}function Qe(s,t){if(t===z.A.UP)return ot.A.FA_UP;if(t===z.A.DOWN)return ot.A.FA;throw z.A.raiseError(t),new Error("Unreachable")}function Ze(s){const t=Rt.get(s);if(typeof t!="undefined")return t;throw ps(s),new Error("Unreachable")}function ps(s){const t=`There is no note shape for the step "${s}".`;throw new Error(t)}var ke=b(911066);const Re="Si",Be="So",Ie=new Map([["C",[null,"Do","Di"]],["D",["Ra","Re","Ri"]],["E",["Me","Mi",null]],["F",[null,"Fa","Fi"]],["G",["Se","So","Si"]],["A",["Le","La","Li"]],["B",["Te","Ti",null]]]),_e="Ja",Ge="note",Fe="Whole",qe="Half",Se="Black";function Xe(s,t,e,r){let i=Ge;return r===ke.A.SOLFEGE_JAPANESE&&(i+=_e),i+=va(s,t,r),i+=wg(e),i}function va(s,t,e){if(e===ke.A.SOLFEGE_JAPANESE&&(t=0),(t===2||t===-2)&&(t/=2),s==="B"&&[0,1].includes(t)&&[ke.A.SOLFEGE_SI,ke.A.SOLFEGE_JAPANESE].includes(e))return Re;if(s==="G"&&t===1&&e===ke.A.SOLFEGE_SI)return Be;if(!Ie.has(s))throw new Error(`Bad step value ${s}`);return Sg(s,t)}function Sg(s,t){const e=Ie.get(s);if(e===void 0)throw new Error(`Bad step value ${s}`);const r=t+1;let i=e[r];return i===null&&(i=e[1]),i}function wg(s){if(s===st.Ay.WHOLE)return Fe;if(s===st.Ay.HALF)return qe;if(s===st.Ay.QUARTER)return Se;throw new Error(`Bad head duration value ${s}`)}var Sa=Object.defineProperty,Dl=(s,t,e)=>t in s?Sa(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ue=(s,t,e)=>Dl(s,typeof t!="symbol"?t+"":t,e),tv=(s=>(s.LEFT="left",s.RIGHT="right",s.MIDDLE="middle",s))(tv||{});const ev=new Map([[4,"restWhole"],[2,"restHalf"],[1,"restQuarter"],[.5,"rest8th"],[.25,"rest16th"],[.125,"rest32nd"],[.0625,"rest64th"]]),sv="noteheadParenthesisLeft",rv="noteheadParenthesisRight",Xp="rgb(0, 0, 150)";function Wp(s){if(!s.getDisplayData().isNormalStaff())return;new iv(s).process()}class iv{constructor(t){Ue(this,"note"),Ue(this,"ctx"),Ue(this,"displayData"),Ue(this,"baseLine"),Ue(this,"baseQuarterDuration"),Ue(this,"headDuration"),Ue(this,"leftHeads"),Ue(this,"middleHeads"),Ue(this,"rightHeads"),Ue(this,"middleWidth"),Ue(this,"baseHead"),Ue(this,"leftOffset"),Ue(this,"rightOffset"),Ue(this,"rightStemX"),Ue(this,"leftStemX"),this.note=t,this.ctx=t.getDrawingContext(),this.displayData=t.getDisplayData(),this.baseQuarterDuration=this.displayData.getBaseQuarterDuration(),this.headDuration=this.extractHeadDuration(),this.leftHeads=[],this.middleHeads=[],this.rightHeads=[],this.middleWidth=null,this.baseHead=null,this.baseLine=null,this.leftOffset=0,this.rightOffset=0,this.baseLine=this.displayData.getFrontHeadLine(),this.rightStemX=null,this.leftStemX=null}process(){this.createHeads(),this.initStemPosition(),this.drawHeads(),this.fillRenderedNoteData()}createHeads(){this.displayData.isRest()?this.createRestHead():this.createSoundHeads()}createRestHead(){const t=nv(this.baseQuarterDuration),e=this.displayData.getLines()[0];if(e===null)throw new Error("The line is not set");const r={line:e,step:null,hideStaff:!1,hasParentheses:!1,isOutOfTessiture:!1,color:this.displayData.getRestColor(),strokeColor:null,isTemplateLocked:!1,isHarmonicArtificialTouching:!1};this.addHead(t,"middle",r)}createSoundHeads(){this.displayData.getHeads().forEach(this.createSoundHead,this)}extractHeadDuration(){return this.isWhole()?st.Ay.WHOLE:this.isHalf()?st.Ay.HALF:st.Ay.QUARTER}isWhole(){const t=be.default.toQuarterDuration(be.default.FULL);return this.baseQuarterDuration===t}isHalf(){const t=be.default.toQuarterDuration(be.default.HALF);return this.baseQuarterDuration===t}createSoundHead(t){if(t.line===null)throw new Error("The line is not set");const e={line:t.line,step:t.step||null,hideStaff:!1,hasParentheses:t.hasParentheses,isOutOfTessiture:t.isOutOfTessiture,color:t.color,strokeColor:null,isTemplateLocked:t.isTemplateLocked,isHarmonicArtificialTouching:t.isHarmonicArtificialTouching};let r,i;if(t.step){const d=this.getStep(t);let f=this.getAlter(t);if(f=Ht.default.normaliseAlterToHalfTone(f),t.notehead===ot.A.NORMAL){if(this.ctx.usePitchNameNotehead())r=ee(d,f,this.headDuration),e.hideStaff=!0;else if(this.ctx.useSolfegeNotehead())r=Xe(d,f,this.headDuration,this.ctx.getSolfegeType()),e.hideStaff=!0;else if(this.ctx.useShapeNotehead()){const m=this.displayData.getStemValue();i=Me(d,m)}}if(!t.color){if(this.ctx.useBoomwhackersColors()){const m=ov(d,f);e.color=P(m)}else if(this.ctx.useCustomColors()){const m=this.getOctave(t),S=t.isOutOfTessiture,w=this.displayData.isUnpitched(),x=this.ctx.customColorOptions();if(!w&&x){const D={step:d,alter:f,octave:m,outOfPitch:S},L=vg.A.getCustomColor(D,x);L&&(e.color=L)}}}}if(!r&&!i&&(t.isHarmonicNaturalTouching?i=ot.A.DIAMOND:i=t.notehead),!r){if(!i)throw new Error("Unexpected");r=O(i,this.headDuration,t.isHarmonicArtificialTouching)}e.color&&this.ctx.outlineColoredNotes()&&(e.strokeColor="black"),t.isTemplateLocked&&(e.color?e.strokeColor=Xp:e.color=Xp);const a=t.line,l=this.getSlot(a);this.addHead(r,l,e)}getStep(t){if(this.ctx.isFixedDo()){if(typeof t.step=="undefined")throw new Error("Step is not defined");return t.step}else{if(typeof t.cStep=="undefined")throw new Error("cStep is not defined");return t.cStep}}getAlter(t){if(this.ctx.isFixedDo()){if(typeof t.alter=="undefined")throw new Error("Alter is not defined");return t.alter}else{if(typeof t.cAlter=="undefined")throw new Error("cAlter is not defined");return t.cAlter}}getOctave(t){return t.octave}getSlot(t){const e=this.displayData.getStemValue();return e===z.A.UP&&this.displayData.isSecondHigher(t)?"right":e===z.A.DOWN&&this.displayData.isSecondLower(t)?"left":"middle"}addHead(t,e,r){const i=this.getGlyph(t,r.isHarmonicArtificialTouching),a={glyphId:t,line:r.line,slot:e,step:r.step,glyph:i,path:null,hideStaff:r.hideStaff,backgroundGlyph:null,backgroundPath:null,hasParentheses:r.hasParentheses,isOutOfTessiture:r.isOutOfTessiture,color:r.color,strokeColor:r.strokeColor,isTemplateLocked:r.isTemplateLocked,isHarmonicArtificialTouching:r.isHarmonicArtificialTouching};if(e==="left")this.leftHeads.push(a);else if(e==="middle")this.middleHeads.push(a);else if(e==="right")this.rightHeads.push(a);else throw new Error("unreachable");r.line===this.baseLine&&(this.baseHead=a)}getGlyph(t,e=!1){if(!this.displayData.isGrace()&&!e)return this.ctx.createGlyphNode(t);{const r=this.ctx.getGraceSizeCoeff();return this.ctx.createGlyphNode(t,r)}}initStemPosition(){if(this.baseHead===null)throw new Error("The base head is not set");const t=this.displayData.getStemValue();if(t===z.A.UP)this.note.setStemYOffset(av(this.baseHead));else if(t===z.A.DOWN)this.note.setStemYOffset(hv(this.baseHead));else throw new Error("Unexpected");const e=this.getLeftStemX(),r=this.ctx.getStemThickness();this.note.setLeftStemX(e+r/2)}getRightStemX(){if(this.rightStemX===null){const{rightStemX:t,leftStemX:e}=this.extractLeftRightStemX();this.rightStemX=t,this.leftStemX=e}return this.rightStemX}getLeftStemX(){if(this.leftStemX===null){const{rightStemX:t,leftStemX:e}=this.extractLeftRightStemX();this.rightStemX=t,this.leftStemX=e}return this.leftStemX}extractLeftRightStemX(){if(!this.baseHead)throw new Error("The base head is not set");const t=this.displayData.getStemValue(),e=this.ctx.getStemThickness();if(t===z.A.UP){const r=wa(this.baseHead),i=r-e;return{rightStemX:r,leftStemX:i}}else if(t===z.A.DOWN){const r=xg(this.baseHead),i=r+e;return{leftStemX:r,rightStemX:i}}else throw new Error("Unexpected")}drawHeads(){this.leftHeads.forEach(this.drawHead,this),this.rightHeads.forEach(this.drawHead,this),this.middleHeads.forEach(this.drawHead,this)}drawHead(t){const e=t.line,r=this.note.getHead(e);if(t.hideStaff){const f=A(this.headDuration),m=this.getGlyph(f);v(r,m);const S=c(t.color,this.headDuration);m.setColor(S)}v(r,t.glyph),t.isOutOfTessiture&&this.ctx.displayOutOfPitch()&&!t.color&&(t.glyph.setColor("red"),t.glyph.setOpacity(.6));const i=this.calcShiftValue(t),a=-(i+t.glyph.glyph.minX),l=i+t.glyph.glyph.maxX-this.getMiddleWidth();this.leftOffset=Math.max(this.leftOffset,a),this.rightOffset=Math.max(this.rightOffset,l);const d=this.lineToY(e);if(this.note.setHighestY(d+t.glyph.glyph.minY),this.note.setLowestY(d+t.glyph.glyph.maxY),r.setX(i),r.setY(d),t.color&&t.glyph.setColor(t.color),t.hasParentheses){const f=this.ctx.createGlyphNode(sv),m=-(this.ctx.getStemThickness()+this.ctx.getLegerLineThickness());f.setX(m),v(r,f);const S=this.ctx.createGlyphNode(rv),w=wa(t);v(r,S),S.setX(w),t.color&&(S.setColor(t.color),f.setColor(t.color))}}calcShiftValue(t){const e=t.slot;if(e==="left")return this.getRightStemX()-wa(t);if(e==="middle")return this.displayData.getStemValue()===z.A.UP?this.getRightStemX()-wa(t):this.getLeftStemX()-xg(t);if(e==="right")return this.getLeftStemX()-xg(t);throw new Error("unreachable")}lineToY(t){return this.note.lineToY(t)}fillRenderedNoteData(){this.note.setLeftHeadWidth(this.leftOffset),this.note.setRightHeadWidth(this.rightOffset);const t=this.getMiddleWidth();this.note.setMiddleHeadWidth(t)}getMiddleWidth(){if(this.middleWidth===null){if(this.baseHead===null)throw new Error("The base head is not set");this.middleWidth=wa(this.baseHead)}return this.middleWidth}}function nv(s){const t=ev.get(s);if(typeof t=="undefined"){const e=`There is no rest glyph for the quarter duration [${s}].`;throw new Error(e)}return t}function ov(s,t){if(t===0)return s;const e=Jr.default.createDefault(),r=Ht.default.create(4,s,t);let i=El.A.switchEnharmonic(r,e);if(t===-2){if(Ht.default.getAlter(i)===0)return Ht.default.getStep(i);i=El.A.switchEnharmonic(i,e)}let a=r;if(Ht.default.getAlter(i)>=0&&(a=i),t=Ht.default.getAlter(a),s=Ht.default.getStep(a),t===1)return`${s}#`;if(t===0)return s;throw new Error("Unexpected")}function av(s){return s.glyph.glyph.hasStemUpSE()?s.glyph.glyph.getStemUpSE().y:0}function hv(s){return s.glyph.glyph.hasStemDownNW()?s.glyph.glyph.getStemDownNW().y:0}function wa(s){if(s.glyph.glyph.hasStemUpSE())return s.glyph.glyph.getStemUpSE().x;{const t=0-s.glyph.glyph.minX;return s.glyph.glyph.maxX-t}}function xg(s){return s.glyph.glyph.hasStemDownNW()?s.glyph.glyph.getStemDownNW().x:0}var lv=Object.defineProperty,cv=(s,t,e)=>t in s?lv(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Cl=(s,t,e)=>cv(s,typeof t!="symbol"?t+"":t,e);function uv(s){const t=s.getDisplayData();if(!t.isKodalyStaff())return;t.getNbDots()>0&&new dv(s).process()}const bg="augmentationDot";class dv{constructor(t){Cl(this,"note"),Cl(this,"ctx"),Cl(this,"displayData"),Cl(this,"glyphDimensions",null),this.note=t,this.ctx=t.getDrawingContext(),this.displayData=t.getDisplayData()}process(){this.displayData.isRest()?this.drawRestDots():this.drawPitchedDots()}drawRestDots(){const[t]=this.getGlyphDimensions(),e=this.note.getChildRoot(),r=this.note.getMiddleHeadWidth(),a=this.lineToY(6);let l=this.ctx.getMarginSize();const d=this.ctx.getMarginSize(),f=this.displayData.getNbDots();for(let m=0;m<f;m++){const S=r+l,w=this.ctx.createGlyphNode(bg);w.setX(S),w.setY(a),this.note.addDot(w),this.note.setDotWidth(t),this.note.setDotMargin(l),l+=t+d,v(e,w)}}drawPitchedDots(){const[t,e]=this.getGlyphDimensions(),r=this.note.getChildRoot();let i=this.note.getMiddleHeadWidth()/2;this.displayData.getBaseQuarterDuration()>1&&(i*=2);let l=this.lineToY(6),d=this.ctx.getMarginSize();this.displayData.getBaseQuarterDuration()<=1&&(l-=e/2);const f=this.ctx.getMarginSize(),m=this.displayData.getNbDots();for(let S=0;S<m;S++){const w=i+d,x=this.ctx.createGlyphNode(bg);x.setX(w),x.setY(l),this.note.addDot(x),this.note.setDotWidth(t),this.note.setDotMargin(d),d+=t+f,v(r,x)}}lineToY(t){const r=this.displayData.getNbStaffLines();return Le.A.lineToY(t,1,r)}getGlyphDimensions(){if(this.glyphDimensions===null){const t=this.ctx.nodeContext.glyphsCache.getGlyph(bg,1),e=t.maxX-t.minX,r=t.maxY-t.minY;this.glyphDimensions=[e,r]}return this.glyphDimensions}}var fv=Object.defineProperty,gv=(s,t,e)=>t in s?fv(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,en=(s,t,e)=>gv(s,typeof t!="symbol"?t+"":t,e);function pv(s){const t=s.getDisplayData();if(!t.isKodalyStaff())return;!t.isRest()&&t.getNbFlagsOrBeams()>0&&!t.hasBeam()&&new mv(s).process()}class mv{constructor(t){en(this,"note"),en(this,"ctx"),en(this,"displayData"),en(this,"stemValue"),en(this,"nbFlags"),en(this,"glyphId",null),en(this,"glyph",null),this.note=t,this.ctx=t.getDrawingContext(),this.displayData=t.getDisplayData(),this.stemValue=this.displayData.getStemValue(),this.nbFlags=this.displayData.getNbFlags(),this.checkStemValue()}checkStemValue(){this.stemValue!==z.A.UP&&this.stemValue!==z.A.DOWN&&this.stemValueError()}stemValueError(){throw new Error(`InconsistentValues cannot draw tab flag for stem with ${this.stemValue} value`)}process(){this.retrieveFlagGlyphId(),this.glyph=this.getGlyph();const t=this.ctx.createGroupNode(),e=this.getFlagX(),r=this.getFlagY();t.setX(e),t.setY(r);const i=this.glyph.getWidth();this.note.setFlag(t,i),v(t,this.glyph),v(this.note.getStemBaseGroup(),t)}retrieveFlagGlyphId(){this.glyphId=this.getFlagGlyphId()}getFlagGlyphId(){let t="flag";const e=Ji.A.get(2+this.nbFlags);return t+=e,this.stemValue===z.A.UP?t+="Up":this.stemValue===z.A.DOWN&&(t+="Down"),t}getGlyph(){if(this.glyphId===null)throw new Error("glyphId should be defined by now");if(this.displayData.isGrace()){const t=this.ctx.getGraceFlagSizeCoeff();return this.ctx.createGlyphNode(this.glyphId,t)}else return this.ctx.createGlyphNode(this.glyphId)}getFlagX(){return-(this.ctx.getStemThickness()/2)}getFlagY(){const t=this.displayData.getStemQueueLine(),e=this.displayData.getStemBaseLine(),i=-(t-e),a=this.getCounterOffset();return i+a}getCounterOffset(){let t=Math.max(0,this.nbFlags-2)/2;this.displayData.isGrace()&&(t/=2);const e=t*this.ctx.getTabSpaceSize();if(this.stemValue===z.A.UP)return e;if(this.stemValue===z.A.DOWN)return-e;throw new Error("unreachable")}}var yv=Object.defineProperty,Av=(s,t,e)=>t in s?yv(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Tl=(s,t,e)=>Av(s,typeof t!="symbol"?t+"":t,e);function vv(s){const t=s.getDisplayData();t.isKodalyStaff()&&!t.isRest()&&t.isHandSign()&&new wv(s).process()}const Sv={C:"kodalyHandDo",D:"kodalyHandRe",E:"kodalyHandMi",F:"kodalyHandFa",G:"kodalyHandSo",A:"kodalyHandLa",B:"kodalyHandTi"};class wv{constructor(t){Tl(this,"note"),Tl(this,"ctx"),Tl(this,"displayData"),Tl(this,"handGlyph",null),this.note=t,this.ctx=t.getDrawingContext(),this.displayData=t.getDisplayData()}process(){this.drawHandGlyph(),this.fillRenderedNoteData()}drawHandGlyph(){const[t]=this.displayData.getHeads(),{line:e,step:r}=t;if(e===null)throw new Error("Line should be defined in headData");if(typeof r=="undefined")throw new Error("Step should be defined in headData");const i=this.note.getHead(e),a=this.getGlyphId(r);this.handGlyph=this.ctx.createGlyphNode(a),v(i,this.handGlyph);const l=0;let d=this.lineToY(e);d+=this.handGlyph.getHeight()/2,this.note.setHighestY(d),this.note.setLowestY(d),i.setX(l),i.setY(d)}getGlyphId(t){return Sv[t]}lineToY(t){const r=this.displayData.getNbStaffLines();return Le.A.lineToY(t,1,r)}fillRenderedNoteData(){this.note.setLeftHeadWidth(0),this.note.setRightHeadWidth(0);const t=this.getMiddleWidth();this.note.setMiddleHeadWidth(t),this.note.setLeftStemX(t/2)}getMiddleWidth(){if(this.handGlyph===null)throw new Error("HandGlyph must be filled by now");return this.handGlyph.getWidth()}}var xv=Object.defineProperty,bv=(s,t,e)=>t in s?xv(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,xa=(s,t,e)=>bv(s,typeof t!="symbol"?t+"":t,e);function Pv(s){const t=s.getDisplayData();if(!t.isKodalyStaff())return;const e=t.getBaseQuarterDuration(),r=be.default.toQuarterDuration(be.default.HALF);t.isKodalyStaff()&&!t.isRest()&&e>=r&&new Cv(s,e).process()}const Ev={4:"noteheadWhole",2:"noteHalfUp"};function Dv(s){const t=Ev[s];if(typeof t=="undefined")throw new Error(`There is no rest glyph for the quarter duration [${s}].`);return t}const zp=4;class Cv{constructor(t,e){xa(this,"note"),xa(this,"ctx"),xa(this,"displayData"),xa(this,"headGlyph",null),xa(this,"baseQuarterDuration"),this.note=t,this.ctx=t.getDrawingContext(),this.displayData=t.getDisplayData(),this.baseQuarterDuration=e}process(){const t=Dv(this.baseQuarterDuration);this.headGlyph=this.ctx.createGlyphNode(t);const e=this.note.getHead(zp);v(e,this.headGlyph);const r=this.note.getMiddleHeadWidth(),i=this.headGlyph.getWidth(),a=r/2-i/2,l=this.lineToY(zp);this.note.setHighestY(l+this.headGlyph.glyph.minY),this.note.setLowestY(l+this.headGlyph.glyph.maxY),e.setX(a),e.setY(l)}lineToY(t){const r=this.displayData.getNbStaffLines();return Le.A.lineToY(t,1,r)}}var Tv=b(377180),Rv=Object.defineProperty,Nv=(s,t,e)=>t in s?Rv(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Rl=(s,t,e)=>Nv(s,typeof t!="symbol"?t+"":t,e);function Lv(s){const t=s.getDisplayData();t.isKodalyStaff()&&t.isKodalyStaff()&&!t.isRest()&&!t.isHandSign()&&new _v(s).process()}const Mv={C:"d",D:"r",E:"m",F:"f",G:"s",A:"l",B:"t"},Ov={C:void 0,D:"a",E:"e",F:void 0,G:"e",A:"e",B:"e"},Bv=[{from:Ht.default.create(4,"C",-1),to:Ht.default.create(3,"B",0)},{from:Ht.default.create(4,"F",-1),to:Ht.default.create(4,"E",0)},{from:Ht.default.create(4,"E",1),to:Ht.default.create(4,"F",0)},{from:Ht.default.create(3,"B",1),to:Ht.default.create(4,"C",0)}];function Iv(s){const t=Ht.default.getAlter(s);if(t>1||t<-1){const r=Tv.default.createDefault();s=Ht.default.transpose(s,r,!1)}const e={pitch:s};return Bv.some(Fv,e),e.pitch}function Fv(s){const t=this;if(Ht.default.getAlter(t.pitch)===Ht.default.getAlter(s.from)&&Ht.default.getStep(t.pitch)===Ht.default.getStep(s.from)){const e=Ht.default.getOctave(s.from),i=Ht.default.getOctave(s.to)-e,a=Ht.default.getOctave(t.pitch)+i,l=Ht.default.getStep(s.to),d=Ht.default.getAlter(s.to);return t.pitch=Ht.default.create(a,l,d),!0}}function Uv(s,t){let e;if(t===1)e="i";else if(t===0)e="";else if(t===-1)e=Ov[s];else throw new Error(`Invalid alter ${t}`);if(typeof e=="undefined")throw new Error(`No middle kodaly letter for step ${s} and alter ${t}.`);return e}function Hv(s){let t="";for(;s!==4;)s<4?(s++,t+=","):s>4&&(s--,t+="'");return t}class _v{constructor(t){Rl(this,"note"),Rl(this,"ctx"),Rl(this,"displayData"),Rl(this,"textNode",null),this.note=t,this.ctx=t.getDrawingContext(),this.displayData=t.getDisplayData()}process(){this.drawName(),this.fillRenderedNoteData()}drawName(){const[t]=this.displayData.getHeads(),e=t.line;if(e===null)throw new Error("Line should be defined in headData");const r=this.note.getHead(e);this.textNode=this.ctx.createTextNode(this.getTextStr(t),this.ctx.getKodalyFontOptions()),this.textNode.setY(0),this.textNode.setX(0);const i=this.displayData.getRestColor();i&&this.textNode.setColor(i),v(r,this.textNode);const a=0,l=1,d=this.lineToY(e);this.note.setHighestY(d-l),this.note.setLowestY(d),r.setX(a),r.setY(d)}lineToY(t){const r=this.displayData.getNbStaffLines();return Le.A.lineToY(t,1,r)}getTextStr(t){let e=Ht.default.create(t.octave,t.step,t.alter);e=Iv(e);const r=Ht.default.getStep(e),i=Ht.default.getAlter(e),a=Ht.default.getOctave(e),l=Mv[r],d=Uv(r,i),f=Hv(a);let m=l+d+f;return t.isTieStop&&(m=`(${m})`),m}fillRenderedNoteData(){this.note.setLeftHeadWidth(0),this.note.setRightHeadWidth(0);const t=this.getMiddleWidth();this.note.setMiddleHeadWidth(t),this.note.setLeftStemX(t/2)}getMiddleWidth(){if(this.textNode===null)throw new Error("TextNode should be defined by now");return this.textNode.getWidth()}}var Gv=Object.defineProperty,Xv=(s,t,e)=>t in s?Gv(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,ba=(s,t,e)=>Xv(s,typeof t!="symbol"?t+"":t,e);function Wv(s){const t=s.getDisplayData();t.isKodalyStaff()&&t.isRest()&&new kv(s).process()}const zv={4:"restWhole",2:"restHalf",1:"restQuarter",.5:"rest8th",.25:"rest16th",.125:"rest32nd",.0625:"rest64th"};function Yv(s){const t=zv[s];if(typeof t=="undefined")throw new Error(`NoRestGlyph: There is no rest glyph for the quarter duration [${s}].`);return t}class kv{constructor(t){ba(this,"note"),ba(this,"ctx"),ba(this,"displayData"),ba(this,"baseQuarterDuration"),ba(this,"glyph"),this.note=t,this.ctx=t.getDrawingContext(),this.displayData=t.getDisplayData(),this.baseQuarterDuration=this.displayData.getBaseQuarterDuration();const e=Yv(this.baseQuarterDuration);this.glyph=this.getGlyph(e)}process(){this.attachRestGlyph(),this.fillRenderedNoteData()}attachRestGlyph(){const t=this.displayData.getLines()[0],e=this.note.getHead(t),r=0,i=this.lineToY(t);this.glyph.setX(r),this.glyph.setY(i);const a=this.displayData.getRestColor();a&&this.glyph.setColor(a),v(e,this.glyph)}getGlyph(t){if(this.displayData.isGrace()){const e=this.ctx.getGraceSizeCoeff();return this.ctx.createGlyphNode(t,e)}return this.ctx.createGlyphNode(t)}lineToY(t){const r=this.displayData.getNbStaffLines();return Le.A.lineToY(t,1,r)}getMiddleWidth(){const t=0-this.glyph.glyph.minX;return this.glyph.glyph.maxX-t}fillRenderedNoteData(){this.note.setLeftHeadWidth(0),this.note.setRightHeadWidth(0);const t=this.getMiddleWidth();this.note.setMiddleHeadWidth(t)}}var qv=Object.defineProperty,Vv=(s,t,e)=>t in s?qv(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Pg=(s,t,e)=>Vv(s,typeof t!="symbol"?t+"":t,e);function Qv(s){const t=s.getDisplayData();if(!t.isKodalyStaff())return;const e=be.default.toQuarterDuration(be.default.HALF);!t.isRest()&&t.getBaseQuarterDuration()<e&&new Kv(s).process()}class Kv{constructor(t){Pg(this,"note"),Pg(this,"ctx"),Pg(this,"displayData"),this.note=t,this.ctx=t.getDrawingContext(),this.displayData=t.getDisplayData()}process(){const t=this.note.getStemBaseGroup(),e=this.getTailY(),r=this.ctx.getStemThickness(),i=this.ctx.createLineNode();i.setWidth(r),i.setX(0),i.setY(0),i.setY2(e),v(t,i),this.note.setStem(i)}getTailY(){const t=this.displayData.getStemBaseLine();return-(this.displayData.getStemQueueLine()-t)}}var Yp=b(176244),Jv=Object.defineProperty,$v=(s,t,e)=>t in s?Jv(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,kn=(s,t,e)=>$v(s,typeof t!="symbol"?t+"":t,e);const Zv={0:"windOpenHole","0.5":"windHalfClosedHole1",1:"windClosedHole"},jv={0:"windOpenHole","0.5":"windHalfClosedHole2",1:"windClosedHole"};class tS{constructor({closed:t,altHalfClosed:e,position:r,drawingContext:i}){kn(this,"closed"),kn(this,"altHalfClosed"),kn(this,"position"),kn(this,"drawingContext"),kn(this,"holeGroup"),kn(this,"glyph",null),this.closed=t.toString(),this.position=r,this.drawingContext=i,this.altHalfClosed=e,this.holeGroup=this.drawingContext.createGroupNode(),this.addGlyph(),this.move()}addGlyph(){this.glyph=this.altHalfClosed?this.drawingContext.createGlyphNode(jv[this.closed]):this.drawingContext.createGlyphNode(Zv[this.closed]),v(this.holeGroup,this.glyph)}move(){if(!(!this.position||!this.glyph))if(this.shouldRotate()){this.holeGroup.setRotation(180);const t=this.glyph.getWidth();this.holeGroup.setX(this.position[0]+t),this.holeGroup.setY(this.position[1]-t)}else this.holeGroup.setX(this.position[0]),this.holeGroup.setY(this.position[1])}getChildRoot(){return this.holeGroup}shouldRotate(){return this.altHalfClosed&&this.closed==="0.5"}}var eS=Object.defineProperty,sS=(s,t,e)=>t in s?eS(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Lr=(s,t,e)=>sS(s,typeof t!="symbol"?t+"":t,e);const kp=.85,rS=new Map([[0,[-.7,0]],[1,[.7,0]],[2,[.7,1.6]],[3,[.7,3.1]],[4,[.7,5.2]],[5,[.7,6.8]],[6,[.7,8.4]],[7,[0,9.7]]]),iS=[.24,3.63,2.18,0],nS=new Map([[0,[-1.1,9.8]],[1,[.3,9.8]],[2,[.3,8.2]],[3,[.3,6.6]],[4,[.3,4.5]],[5,[.3,2.9]],[6,[.3,1.3]],[7,[1,0]]]),oS=[.1,5,1.7,0];function aS(s){if(!s.getDisplayData().isRecorderTabStaff())return;new hS(s).process()}class hS{constructor(t){Lr(this,"note"),Lr(this,"ctx"),Lr(this,"displayData"),Lr(this,"formula"),Lr(this,"baseQuarterDuration"),Lr(this,"displayType"),Lr(this,"holePositionMap"),Lr(this,"separatorPosition"),Lr(this,"recorderHoles",[]),Lr(this,"separator",null),this.note=t,this.ctx=t.getDrawingContext(),this.displayData=t.getDisplayData(),this.displayType=this.displayData.getFingeringDisplayType(),this.holePositionMap=rS,this.formula=this.displayData.getFingeringDiagramFormula(),this.baseQuarterDuration=this.displayData.getBaseQuarterDuration(),this.separatorPosition=iS,this.displayType===Yp.A.JAPANESE&&(this.holePositionMap=nS,this.separatorPosition=oS)}process(){if(this.displayData.isRest()||!this.formula){this.attachPlaceholder();return}this.clear(),this.attachDiagram(),this.attachSeparator(),this.scaleGraces()}clear(){this.recorderHoles.length&&(this.recorderHoles.forEach(t=>{it(this.note.getChildRoot(),t.getChildRoot()),t.getChildRoot().destroy()}),this.recorderHoles=[]),this.separator!==null&&(it(this.note.getChildRoot(),this.separator),this.separator.destroy(),this.separator=null)}attachPlaceholder(){this.note.getChildRoot().setBBoxOverride({minX:0,maxX:0,minY:0,maxY:0})}attachDiagram(){var t;(t=this.formula)==null||t.forEach((e,r)=>{const i=new tS({closed:e,altHalfClosed:this.isAltHalfClosed(r),position:this.getHolePosition(r),drawingContext:this.ctx});v(this.note.getChildRoot(),i.getChildRoot()),this.recorderHoles.push(i)})}attachSeparator(){this.separator=this.ctx.createLineNode(),this.separator.setWidth(this.ctx.getRecorderTabSeparatorThickness()),this.separator.setX(this.separatorPosition[0]),this.separator.setY(this.separatorPosition[1]),this.separator.setX2(this.separatorPosition[2]),this.separator.setY2(this.separatorPosition[3]),v(this.note.getChildRoot(),this.separator)}scaleGraces(){if(this.displayData.isGrace()){const t=this.note.getChildRoot();t.setScalingY(kp),t.setScalingX(kp)}}isAltHalfClosed(t){return t===0&&this.displayType===Yp.A.JAPANESE}getHolePosition(t){return this.holePositionMap.get(t)}}const lS=[Wp,Er,ia,ul,al,mf,Id,$h,Dd,lf,Td,jd,Vd,aS,Sl,fg,Ag,hg,ig,tg,Wv,Lv,vv,Pv,Qv,pv,uv];function qp(s){lS.forEach(t=>t(s))}const cS=.1;function Ei(s){if(s instanceof ye){const t=s.getX(),e=s.getY();return s.children.flatMap(r=>{const i=Ei(r);return i.forEach(a=>{a.height+=e,a.position+=t}),i})}else{const t=s.getBBox();if(t===null)throw new Error("Unexpected null bbox");const e=Math.max(t.maxX-t.minX,cS),r=t.minX;return[{position:r,width:e,height:t.maxY},{position:r,width:e,height:t.minY}]}}var uS=Object.defineProperty,dS=(s,t,e)=>t in s?uS(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Kt=(s,t,e)=>dS(s,typeof t!="symbol"?t+"":t,e);const fS="voice";class Bt{constructor(t){Kt(this,"voiceIdx"),Kt(this,"dpq"),Kt(this,"nbDivisons"),Kt(this,"stemStrategy"),Kt(this,"voiceUuid"),Kt(this,"voiceIdxInStaff"),Kt(this,"drawingContext"),Kt(this,"groupNode"),Kt(this,"notes",[]),Kt(this,"gracesMap",new Map),Kt(this,"lyricsMap",new Map),Kt(this,"lyricsGroup",null),Kt(this,"horizontalData",null),Kt(this,"horizontalFormatter",null),Kt(this,"leftSlurAnchor",null),Kt(this,"middleSlurAnchors",[]),Kt(this,"rightSlurAnchor",null),Kt(this,"leftTieAnchor",null),Kt(this,"middleTieAnchors",[]),Kt(this,"rightTieAnchor",null),Kt(this,"leftHammerOnAnchor",null),Kt(this,"middleHammerOnAnchors",[]),Kt(this,"rightHammerOnAnchor",null),Kt(this,"leftSlideAnchor",null),Kt(this,"middleSlideAnchors",[]),Kt(this,"rightSlideAnchor",null),Kt(this,"leftGlissandoAnchor",null),Kt(this,"middleGlissandoAnchors",[]),Kt(this,"rightGlissandoAnchor",null),Kt(this,"leftBendAnchorByString",new Map),Kt(this,"middleBendAnchorsByString",new Map),Kt(this,"rightBendAnchorByString",new Map),Kt(this,"rightHyphenAnchor",null),Kt(this,"middleHyphenAnchors",[]),Kt(this,"leftHyphenAnchor",null),Kt(this,"rightMelismaAnchor",new Map),Kt(this,"middleMelismaAnchors",new Map),Kt(this,"leftMelismaAnchor",new Map),Kt(this,"aboveTuplets",[]),Kt(this,"belowTuplets",[]),Kt(this,"beams",[]),this.voiceIdx=t.voiceIdx,this.dpq=t.dpq,this.nbDivisons=t.nbDivisons,this.voiceIdxInStaff=t.voiceIdxInStaff,this.stemStrategy=t.stemStrategy,this.voiceUuid=t.voiceUuid,this.drawingContext=t.drawingContext,this.groupNode=this.drawingContext.createGroupNode(),this.groupNode.setLabel(fS)}addNote(t){this.notes.push(t);const e=t.getChildRoot();v(this.groupNode,e)}addNoteGraces(t,e){this.gracesMap.set(t,e)}addLyric(t){const e=this.getLyricsGroup(),r=t.getChildRoot();v(e,r),this.lyricsMap.set(t.getNoteIdx(),t)}addBeam(t){this.beams.push(t),v(this.groupNode,t.getChildRoot())}addTuplet(t){const e=t.getPlacement();if(e===I.A.ABOVE)this.aboveTuplets.push(t);else if(e===I.A.BELOW)this.belowTuplets.push(t);else throw I.A.raiseError(e);v(this.groupNode,t.getChildRoot())}getHorizontalData(){return this.horizontalData===null&&(this.horizontalData=this.computeHorizontalData()),this.horizontalData}computeHorizontalData(){return[this.computeNotesHorizontalData(),...this.computeLyricsLevelssHorizontalData()]}computeNotesHorizontalData(){const t=this.notes.map(this.extractNoteHorizontalData,this);return{dpq:this.dpq,entities:t,nbDivisions:this.nbDivisons,type:yi.A.NOTE}}extractNoteHorizontalData(t,e){const r=t.getDuration(),i=t.getTimePos(),a=t.getChildRoot().getBBox();if(a===null)throw new Error("bbox should not be null at this point");const[l,d]=this.getSpaceAfterBefore(t,a);return{timePos:i,duration:r,spaceBefore:l,spaceAfter:d,isRest:t.isRest()}}getSpaceAfterBefore(t,e){let r=-e.minX,i=e.maxX;const a=t.getHorizontalShift();a<0?r+=-a:a>0&&(i+=a),this.noteHasSlideStart(t)&&(i=Math.max(i,this.drawingContext.getMinimalSlideLineHorizontalLength()/2)),this.noteHasSlideStop(t)&&(r=Math.max(r,this.drawingContext.getMinimalSlideLineHorizontalLength()/2)),this.noteHasGlissandoStart(t)&&(i=Math.max(i,this.drawingContext.getMinimalGlissandoHorizontalLength()/2)),this.noteHasGlissandoStop(t)&&(r=Math.max(r,this.drawingContext.getMinimalGlissandoHorizontalLength()/2));const l=t.getDisplayData();if(l.hasTremoloStart()){let d=.5;l.getStemValue()===z.A.UP&&(d+=t.getMiddleHeadWidth()),i=Math.max(i,d)}if(l.hasTremoloStop()){let d=0;l.getStemValue()===z.A.DOWN&&(d+=.5),r=Math.max(r,d)}return t.isRecorderTabStaff()&&(i+=this.drawingContext.getRecorderDiagramMargin()),!l.isRest()&&(l.hasTieStop()||l.hasHammerOnPullOffStop())&&t.getTimePos()===0&&(r=Math.max(r,this.drawingContext.getMinimalTieStopHorizontalMargin())),[r,i]}computeLyricsLevelssHorizontalData(){if(this.lyricsMap.size===0)return[];const t=new Set;return this.lyricsMap.forEach(r=>{r.getLevels().forEach(t.add,t)}),Array.from(t.values()).map(r=>{const i=[];return this.lyricsMap.forEach(l=>{const d=l.getTimePos(),f=l.levelsMap.get(r);if(f===void 0)return;const S=f.getChildRoot().getBBox();if(S===null)throw new Error("bbox should not be null at this point");const w=Math.max(-S.minX,0),x=S.maxX,D={timePos:d,duration:0,spaceBefore:w,spaceAfter:x,isRest:!1};i.push(D)}),{dpq:this.dpq,entities:i,nbDivisions:this.nbDivisons,type:yi.A.LYRIC}})}setHorizontalFormatter(t){this.horizontalFormatter=t}formatHorizontal(){const t=this.horizontalFormatter;if(t===null)throw new Error("horizontalFormatter should not be null at this point");if(this.hasSingleRest()){const e=this.notes[0],r=e.getChildRoot().getLocalBBox();if(r===null)throw new Error("bbox should not be null at this point");const i=t.getMiddlePos()-r.maxX/2;e.setPosition(i);return}this.notes.forEach(e=>{const r=e.getTimePos(),i=t.getPosX(r,this.dpq);e.setPosition(i)}),this.lyricsMap.forEach(e=>{const r=e.getTimePos(),i=t.getPosX(r,this.dpq);e.setX(i)}),this.beams.forEach(e=>e.update()),this.aboveTuplets.forEach(e=>e.updateHorizontal()),this.belowTuplets.forEach(e=>e.updateHorizontal())}noteHasSlideStart(t){return this.middleSlideAnchors.some(e=>e.isStart()&&t.getTimePos()===e.getTimePos())}noteHasSlideStop(t){return this.middleSlideAnchors.some(e=>e.isStop()&&t.getTimePos()===e.getTimePos())}noteHasGlissandoStart(t){return this.middleGlissandoAnchors.some(e=>e.isStart()&&t.getTimePos()===e.getTimePos())}noteHasGlissandoStop(t){return this.middleGlissandoAnchors.some(e=>e.isStop()&&t.getTimePos()===e.getTimePos())}hasSingleRest(){return this.notes.length===1&&this.notes[0].isRest()}getLyricsGroup(){return this.lyricsGroup===null&&(this.lyricsGroup=this.drawingContext.createGroupNode(),v(this.groupNode,this.lyricsGroup)),this.lyricsGroup}getChildRoot(){return this.groupNode}getVoiceIdx(){return this.voiceIdx}getVoiceUuid(){return this.voiceUuid}setLeftSlurAnchor(t){this.leftSlurAnchor=t}getLeftSlurAnchor(){return this.leftSlurAnchor}addMiddleSlurAnchor(t){this.middleSlurAnchors.push(t)}getMiddleSlurAnchors(){return this.middleSlurAnchors}setRightSlurAnchor(t){this.rightSlurAnchor=t}getRightSlurAnchor(){return this.rightSlurAnchor}setLeftTieAnchor(t){this.leftTieAnchor=t}getLeftTieAnchor(){return this.leftTieAnchor}setRightTieAnchor(t){this.rightTieAnchor=t}getRightTieAnchor(){return this.rightTieAnchor}addMiddleTieAnchor(t){this.middleTieAnchors.push(t)}getMiddleTieAnchors(){return this.middleTieAnchors}setLeftHammerOnAnchor(t){this.leftHammerOnAnchor=t}getLeftHammerOnAnchor(){return this.leftHammerOnAnchor}setRightHammerOnAnchor(t){this.rightHammerOnAnchor=t}getRightHammerOnAnchor(){return this.rightHammerOnAnchor}addMiddleHammerOnAnchor(t){this.middleHammerOnAnchors.push(t)}getMiddleHammerOnAnchors(){return this.middleHammerOnAnchors}setLeftSlideAnchor(t){this.leftSlideAnchor=t}getLeftSlideAnchor(){return this.leftSlideAnchor}setRightSlideAnchor(t){this.rightSlideAnchor=t}getRightSlideAnchor(){return this.rightSlideAnchor}addMiddleSlideAnchor(t){this.middleSlideAnchors.push(t)}getMiddleSlideAnchors(){return this.middleSlideAnchors}setLeftGlissandoAnchor(t){this.leftGlissandoAnchor=t}getLeftGlissandoAnchor(){return this.leftGlissandoAnchor}setRightGlissandoAnchor(t){this.rightGlissandoAnchor=t}getRightGlissandoAnchor(){return this.rightGlissandoAnchor}addMiddleGlissandoAnchor(t){this.middleGlissandoAnchors.push(t)}getMiddleGlissandoAnchors(){return this.middleGlissandoAnchors}addMiddleHyphenAnchor(t){this.middleHyphenAnchors.push(t)}getMiddleHyphenAnchors(){return this.middleHyphenAnchors}setLeftHyphenAnchor(t){this.leftHyphenAnchor=t}getLeftHyphenAnchor(){return this.leftHyphenAnchor}setRightHyphenAnchor(t){this.rightHyphenAnchor=t}getRightHyphenAnchor(){return this.rightHyphenAnchor}hasRightBendAnchor(t){return this.rightBendAnchorByString.has(t)}getRightBendAnchor(t){return this.rightBendAnchorByString.get(t)}setRightBendAnchor(t,e){this.rightBendAnchorByString.set(t,e)}hasLeftBendAnchor(t){return this.leftBendAnchorByString.has(t)}getLeftBendAnchor(t){return this.leftBendAnchorByString.get(t)}setLeftBendAnchor(t,e){this.leftBendAnchorByString.set(t,e)}getMiddleBendAnchors(t){return this.middleBendAnchorsByString.get(t)||[]}addMiddleBendAnchor(t,e){const r=this.getMiddleBendAnchors(t);r.push(e),this.middleBendAnchorsByString.set(t,r)}addLeftBendAnchor(t,e){this.leftBendAnchorByString.set(t,e)}addRightBendAnchor(t,e){this.rightBendAnchorByString.set(t,e)}getAllMelismaLevels(){const t=new Set;return this.leftMelismaAnchor.forEach((e,r)=>t.add(r)),this.rightMelismaAnchor.forEach((e,r)=>t.add(r)),this.middleMelismaAnchors.forEach((e,r)=>t.add(r)),Array.from(t.values())}addLeftMelismaAnchor(t,e){this.leftMelismaAnchor.set(e,t)}addRightMelismaAnchor(t,e){this.rightMelismaAnchor.set(e,t)}addMiddleMelismaAnchor(t,e){let r=this.middleMelismaAnchors.get(e);r||(r=[],this.middleMelismaAnchors.set(e,r)),r.push(t)}getLeftMelismaAnchor(t){return this.leftMelismaAnchor.get(t)||null}getMiddleMelismaAnchors(t){return this.middleMelismaAnchors.get(t)||[]}getRightMelismaAnchor(t){return this.rightMelismaAnchor.get(t)||null}getLyricByNoteIdx(t){const e=this.lyricsMap.get(t);return e===void 0?null:e}getLyrics(){return Array.from(this.lyricsMap.values())}extractInitialHeights(){const t=[...this.notes.flatMap(r=>Ei(r.getChildRoot())),...this.beams.flatMap(r=>Ei(r.getChildRoot()))],e=this.getChildRoot().getX();return t.forEach(r=>{r.position+=e}),t}getNbNotes(){return this.notes.length}getNote(t){return this.notes[t]}fillNotes(){this.notes.forEach((t,e)=>{qp(t),this.fillNoteGraces(t,e)})}fillNoteGraces(t,e){const r=this.gracesMap.get(e);if(!r)return;const i=t.getChildRoot(),a=i.getLocalBBox();if(a===null)throw new Error("bbox should not be null at this point");let l=a.minX;const d=this.drawingContext.getMinSpaceBetweenNotes();r.slice().reverse().forEach(f=>{qp(f);const m=f.getChildRoot(),S=m.getLocalBBox();if(S===null)throw new Error("graceBbox should not be null at this point");l-=d,l-=S.maxX,f.setPosition(l),l+=S.minX,v(i,m)}),t.formatBeams()}fillLyrics(){this.notes.forEach(t=>{const e=Kh({drawingContext:this.drawingContext,noteDrawer:t,displayData:t.getDisplayData(),voiceUuid:this.voiceUuid});e&&this.addLyric(e)})}fillGracesBeams(){this.notes.forEach((t,e)=>{const r=this.gracesMap.get(e);r&&Ad(t,r,this.stemStrategy)})}fillEventsPayloads(){this.notes.forEach((t,e)=>{this.fillNoteEventPayload(t,e,null)}),this.gracesMap.forEach((t,e)=>{t.forEach((r,i)=>{this.fillNoteEventPayload(r,e,i)})})}fillNoteEventPayload(t,e,r){if(t.staffData.type!==Zt.A.STANDARD||t.isRest())return;const i=t.getDisplayData(),a=i.getBaseQuarterDuration(),l=(0,st.RC)(a);t.getHeads().forEach((f,m)=>{if(m===null)return;const S=i.getHeads().find(D=>D.line===m);if(!S)throw new Error(`There should be a head for line ${m}`);const w=S.notehead||ot.A.NORMAL,x={entityType:T.A.NOTE,voiceUuid:this.voiceUuid,voiceIdxInStaff:this.voiceIdxInStaff,noteIdx:e,graceIdx:r,line:m,notehead:w,duration:l};f.setEventPayload(x)})}}var gS=Object.defineProperty,pS=(s,t,e)=>t in s?gS(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Nl=(s,t,e)=>pS(s,typeof t!="symbol"?t+"":t,e);const mS="arrowheadBlackDown",yS="arrowheadBlackUp",Eg=.3,Ll=1,AS=.5,Vp=Eg*1.3;function vS(s,t,e){const r=new SS(s,t);return r.process(e),r.getEntities()}class SS{constructor(t,e){Nl(this,"pageIdx",0),Nl(this,"request"),Nl(this,"scoreDrawer"),Nl(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const r=t.slice.measures.findIndex($=>$.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r===-1)return;const i=t.parts.find($=>$.partData.uuid===this.request.partUuid);if(!i)return;const a=i.staves.find($=>$.staffData.uuid===this.request.staffUuid&&$.staffData.type===this.request.staffType);if(!a)return;const l=a.measures[r],d=Array.from(l.tickableContent.voices.values()).find($=>$ instanceof Bt?$.voiceUuid===this.request.voiceUuid:!1);if(!d)return;const f=d.notes[this.request.noteIdx];if(!f)return;const m=f.getChildRoot(),S=rt(m),w=(0,Ft.o5)(f.staffData),x=this.scoreDrawer.drawingContext,D=x.createGroupNode();D.setY(S.y),D.setX(S.x-AS-Eg/2),D.setMixBlendMode("darken");const L=x.createLineNode();L.setX(0),L.setX2(0),L.setY(-Ll),L.setY2(w+Ll*2),L.setWidth(Eg),L.setStrokeColor(this.request.color),v(D,L);const M=x.createGlyphNode(mS);M.setX(-M.getWidth()/2),M.setY(-Ll+Vp),M.setColor(this.request.color),v(D,M);const H=x.createGlyphNode(yS);return H.setX(-H.getWidth()/2),H.setY(w+Ll-Vp+H.getHeight()),H.setColor(this.request.color),v(D,H),this.cursorEntities.push({pageIdx:this.pageIdx,node:D}),!0}getEntities(){return this.cursorEntities}}var wS=Object.defineProperty,xS=(s,t,e)=>t in s?wS(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Pa=(s,t,e)=>xS(s,typeof t!="symbol"?t+"":t,e);const bS=.2,PS=1;function ES(s,t,e){const r=new DS(s,t);r.process(e);const i=r.getEntities();return t.setPlaybackSliderCursorEntity(i[0]),i}class DS{constructor(t,e){Pa(this,"pageIdx",0),Pa(this,"numberOfPartsProcessed",0),Pa(this,"request"),Pa(this,"scoreDrawer"),Pa(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else{const e=this.scoreDrawer.getNbParts();for(let r=0;r<t.length;r++){const i=t[r];if(this.processPageIndex(i)&&this.numberOfPartsProcessed===e)break}}}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const r=t.slice.measures.findIndex(S=>S.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r===-1)return;const i=t.getTopPart().getTopStaff().getMeasure(r),a=i.getChildRoot(),l=i.getWidth(),d=rt(a),m=this.scoreDrawer.drawingContext.createGroupNode();return m.setX(d.x),m.setY(0),t.parts.forEach(S=>{const w=this.createMeasureOutline(S,l);v(m,w),this.numberOfPartsProcessed++}),this.cursorEntities.push({pageIdx:this.pageIdx,node:m}),!0}createMeasureOutline(t,e){const r=this.scoreDrawer.drawingContext,a=t.getTopStaff().getChildRoot(),l=rt(a),d=t.getStaffHeight(),f=t.getTopHeight(),m=t.getBottomHeight(),S=f+d+m,w=r.createRectNode(e,S,PS);return w.setX(0),w.setY(l.y-f),w.setStrokeWidth(bS),w.setStrokeColor(this.request.color),w.setColor("transparent"),w.setLabel("measure-outline"),w}getEntities(){return this.cursorEntities}}var Dg=b(956112),CS=Object.defineProperty,TS=(s,t,e)=>t in s?CS(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,qn=(s,t,e)=>TS(s,typeof t!="symbol"?t+"":t,e);const RS="brassMuteClosed",NS="brassMuteOpen";function LS(s){if(s===Dg.A.ON)return RS;if(s===Dg.A.OFF)return NS;throw Dg.A.raiseError(s)}class Qp{constructor(t,{type:e,timePos:r,uuid:i,dpq:a,placement:l}){qn(this,"glyphNode"),qn(this,"timePos"),qn(this,"uuid"),qn(this,"dpq"),qn(this,"type"),qn(this,"placement");const d=LS(e);this.glyphNode=t.createGlyphNode(d),this.timePos=r,this.dpq=a,this.uuid=i,this.type=e,this.placement=l}fillEventPayload(){const t={entityType:T.A.MUTE,timePos:this.timePos,dpq:this.dpq,uuid:this.uuid,type:this.type,placement:this.placement};this.glyphNode.setEventPayload(t)}getChildRoot(){return this.glyphNode}getUuid(){return this.uuid}getTimePos(){return this.timePos}setX(t){this.glyphNode.setX(t)}getHorizontalData(){const t=this.glyphNode.getLocalBBox();if(t===null)throw new Error("bbox is null");return{timePos:this.timePos,duration:0,spaceBefore:-t.minX,spaceAfter:t.maxX,isRest:!1}}}var MS=Object.defineProperty,OS=(s,t,e)=>t in s?MS(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ml=(s,t,e)=>OS(s,typeof t!="symbol"?t+"":t,e);function BS(s,t,e){const r=new IS(s,t);return r.process(e),r.getEntities()}class IS{constructor(t,e){Ml(this,"pageIdx",0),Ml(this,"request"),Ml(this,"scoreDrawer"),Ml(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const r=t.slice.measures.findIndex(H=>H.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r===-1)return;const i=t.parts.find(H=>H.partData.uuid===this.request.partUuid);if(!i)return;const a=i.staves.find(H=>H.staffData.uuid===this.request.staffUuid);if(!a)return;const l=a.measures[r],{tickableContent:d}=l,f=d.horizontalFormatter;if(f===null)throw new Error("Formatter is null");const m=f.getDpq(),S=Dt.default.lcm(m,this.request.dpq),w=this.request.timePos*S/this.request.dpq,x=f.getNbDivisions()*S/m;if(w<0||w>=x)return!0;const D=this.scoreDrawer.drawingContext.createGroupNode(),L=rt(d.getChildRoot());D.setX(L.x),D.setY(L.y);const M=this.createMute({tickableContent:d,measure:l,formatter:f,staff:a,mergedTimePos:w,mergedDpq:S});return v(D,M.getChildRoot()),Vt(D,this.request.color),this.cursorEntities.push({pageIdx:this.pageIdx,node:D}),!0}createMute(t){const{tickableContent:e,measure:r,formatter:i,staff:a,mergedTimePos:l,mergedDpq:d}=t,f=this.scoreDrawer.drawingContext,m=e.getChildRoot(),S=new Qp(f,{type:this.request.value,timePos:0,dpq:1,placement:this.request.placement,uuid:""}),w=i.getPosX(l,d);S.setX(w);const x=r.getChildRoot(),D=w+m.getX()+x.getX(),{placement:L}=this.request;if(L===I.A.ABOVE)qs([{entity:S,xPosition:D,yPosition:null}],a.initialTopHeights,f,!1);else if(L===I.A.BELOW){const M=(0,Ft.o5)(a.staffData);kr([{entity:S,xPosition:D,yPosition:null}],a.initialBottomHeights,M,f,!1)}else throw I.A.raiseError(L);return S}getEntities(){return this.cursorEntities}}var Vn=b(515819),ms=b(589085),FS=b(209175),Kp=b(870437),US=Object.defineProperty,HS=Object.defineProperties,_S=Object.getOwnPropertyDescriptors,Jp=Object.getOwnPropertySymbols,GS=Object.prototype.hasOwnProperty,XS=Object.prototype.propertyIsEnumerable,Cg=(s,t,e)=>t in s?US(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,WS=(s,t)=>{for(var e in t||(t={}))GS.call(t,e)&&Cg(s,e,t[e]);if(Jp)for(var e of Jp(t))XS.call(t,e)&&Cg(s,e,t[e]);return s},zS=(s,t)=>HS(s,_S(t)),er=(s,t,e)=>Cg(s,typeof t!="symbol"?t+"":t,e);const $p=3.5,YS=2,Zp=2.5,Qn=2,kS=3;class Ol{constructor(t){er(this,"opts"),er(this,"linesSet"),er(this,"definedStem"),er(this,"secondHighers"),er(this,"accidentals"),er(this,"lineAvg"),er(this,"beamDisplayData"),er(this,"nbOrnaments"),er(this,"nbFlags"),er(this,"singleNoteStemQueueLine"),er(this,"stemQueueLine"),this.opts=t,this.definedStem=null,this.linesSet=new Set(t.lines),this.accidentals=null,this.secondHighers=null,this.lineAvg=null,this.stemQueueLine=null,this.singleNoteStemQueueLine=null,this.nbFlags=null,this.nbOrnaments=null,this.beamDisplayData=null}setLine(t){this.opts.lines=[t],this.linesSet=new Set([t])}isRest(){return this.opts.isRest}isUnpitched(){return this.opts.isUnpitched}getSecondHighers(){return this.secondHighers===null&&(this.secondHighers=this.initSecondHighers()),this.secondHighers}initSecondHighers(){return this.getStemValue()===z.A.UP?this.initSecondHighersStemUp():this.initSecondHighersStemDown()}initSecondHighersStemDown(){let t=null;const e=new Set;return this.getLines().forEach(i=>{i!==null&&(t===null||t-i>.5?t=i:(e.add(t),t=null))}),e}initSecondHighersStemUp(){const t=new Set,e=this.getLines().slice(0);e.reverse();let r=null;return e.forEach(i=>{i!==null&&(r===null||i-r>.5?r=i:(t.add(i),r=null))}),t}hasSecond(){return this.getSecondHighers().size>0}isSecondLower(t){return this.hasLine(t)?!!this.getSecondHighers().has(t+.5):!1}hasLine(t){return!!this.linesSet.has(t)}isSecondHigher(t){return this.getSecondHighers().has(t)}hasAccidentals(){return this.getAccidentals().length>0}getAccidentals(){return this.accidentals===null&&(this.accidentals=this.initAccidentals()),this.accidentals}initAccidentals(){return this.opts.accidentals.map(t=>{const e=t.line,r=this.isSecondHigher(e);return zS(WS({},t),{secondHigher:r})})}getBaseQuarterDuration(){return this.opts.quarterBaseDuration}getDuration(){return this.opts.duration}getLines(){return this.opts.lines}getHeads(){return this.opts.heads}getStaffData(){return this.opts.staffData}getStaffIdx(){return this.opts.staffIdx}getDisplayedNbStaffLines(){const t=this.getStaffData();return ms.A.getDisplayedNbStaffLines(t)}getNbStaffLines(){const t=this.getStaffData();return ms.A.getNbStaffLines(t)}isNormalStaff(){return!this.isTabStaff()&&!this.isKodalyStaff()&&!this.isRecorderTabStaff()}isTabStaff(){const t=this.getStaffData();return ms.A.isTabStaff(t)}isRecorderTabStaff(){const t=this.getStaffData();return ms.A.isRecorderTabStaff(t)}isKodalyStaff(){const t=this.getStaffData();return ms.A.isKodalyStaff(t)}isHandSign(){const t=this.getStaffData();return ms.A.isHandSign(t)}getLineAvg(){return this.lineAvg===null&&(this.lineAvg=this.calcLineAvg()),this.lineAvg}calcLineAvg(){const t=this.getLines().filter(r=>r!==null);return t.reduce(function(r,i){return r+i},0)/t.length}getHighestLine(){const e=this.getLines()[0];if(e===null)throw new Error("Highest line is null");return e}getLowestLine(){const t=this.getLines(),e=t[t.length-1];if(e===null)throw new Error("Lowest line is null");return e}getFrontHeadLine(){const t=this.getStemValue();if(t===z.A.UP)return this.getLowestLine();if(t===z.A.DOWN)return this.getHighestLine();{let e=`base head line concept has no meanings for ${t}`;throw e+=" stem value",new Error(e)}}getTailHeadLine(){const t=this.getStemValue();if(t===z.A.UP)return this.getHighestLine();if(t===z.A.DOWN)return this.getLowestLine();{let e=`queue head line concept has no meanings for ${t}`;throw e+=" stem value",new Error(e)}}getStemBaseLine(){return this.isTabStaff()?this.getTabFretLine():this.isKodalyStaff()?4:this.getFrontHeadLine()}getTabFretLine(){const t=this.getStemValue();if(t===z.A.UP)return this.getNbStaffLines()+1;if(t===z.A.DOWN)return 0;{let e=`tab line concept has no meanings for ${t}`;throw e+=" stem value",new Error(e)}}getStemValue(){return this.isStemSpecified()?this.getSpecifiedStem():this.hasBeam()?this.getStemValueFromBeam():this.computeStemValueFromPitch()}hasBeam(){return this.opts.hasBeam}getBeams(){return this.opts.beams}setStemStrategy(t){this.opts.stemStrategy=t}isStemSpecified(){return this.definedStem!==null}getSpecifiedStem(){if(this.definedStem===null)throw new Error("Stem is not defined");return this.definedStem}setSpeficiedStem(t){this.definedStem=t}getStemValueFromBeam(){if(this.beamDisplayData===null)throw new Error("BeamDisplayData is not set");return this.beamDisplayData.getStemValue()}computeStemValueFromPitch(){if(this.isKodalyStaff()||this.isGrace()||this.isUnpitched())return z.A.UP;const t=this.getLineAvg();return this.getDisplayedNbStaffLines()===1&&t===3?z.A.UP:t>=3?z.A.DOWN:z.A.UP}getSingleNoteStemQueueLine(){return this.singleNoteStemQueueLine===null&&(this.isTabStaff()?this.singleNoteStemQueueLine=this.computeTabNoteStemQueueLine():this.isKodalyStaff()?this.singleNoteStemQueueLine=this.computeKodalyNoteStemQueueLine():this.singleNoteStemQueueLine=this.computeSingleNoteStemQueueLine()),this.singleNoteStemQueueLine}getStemQueueLine(){return this.stemQueueLine===null&&(this.stemQueueLine=this.calcStemQueueLine()),this.stemQueueLine}calcStemQueueLine(){if(this.beamDisplayData){if(this.beamDisplayData.computeStemQueueLines(),this.stemQueueLine!==null)return this.stemQueueLine;throw new Error("BeamDisplayData did not set stemQueueLine")}else return this.getSingleNoteStemQueueLine()}computeSingleNoteStemQueueLine(){return this.isGrace()?this.computeSingleNoteStemQueueLineGrace():this.computeSingleNoteStemQueueLineNormal()}computeTabNoteStemQueueLine(){return this.isGrace()?0:this.computeTabNoteStemQueueLineNormal()}computeSingleNoteStemQueueLineGrace(){let t=YS;const e=this.getNbFlagsOrBeams();if(e>Qn){const l=(e-Qn)/2;t+=l}const i=this.getStemDirectionCoeff()*t;return this.getTailHeadLine()+i}computeSingleNoteStemQueueLineNormal(){let t=$p,e=2;const r=this.getDistanceToThirdLine();r>t&&(t=r,e+=Math.max(r-$p,0));let i=0;i+=this.getNbFlagsOrBeams(),this.hasTremolo()&&(i+=this.getNbOrnaments()),i>e&&(t+=i-e);const l=this.getStemDirectionCoeff()*t;return this.getTailHeadLine()+l}computeTabNoteStemQueueLineNormal(){let e=be.default.toQuarterDuration(be.default.HALF)===this.getBaseQuarterDuration()?Zp/2:Zp;const r=this.getNbFlagsOrBeams();if(r>Qn){const l=r-Qn;e+=l}r>0&&!this.hasBeam()&&this.getNbDots()>0&&(e+=1);const i=this.getStemDirectionCoeff();return this.getTabFretLine()+i*e}computeKodalyNoteStemQueueLine(){let t=kS;const e=this.getNbFlagsOrBeams();if(e>Qn){const a=e-Qn;t+=a}const r=this.getStemDirectionCoeff(),i=this.getStemBaseLine();if(i===null)throw new Error("Cannot compute kodaly stem queue line without stem base line");return i+r*t}getDistanceToThirdLine(){const t=this.getStemValue(),e=this.getTailHeadLine();if(e===null)throw new Error("Cannot compute distance to third line without queue line");if(t===z.A.UP)return Math.max(Math.ceil(this.getNbStaffLines()/2),1)-e;if(t===z.A.DOWN)return e-Math.max(Math.ceil(this.getNbStaffLines()/2),1);throw new Error("Unreachable ")}getNbFlagsOrBeams(){return this.opts.beams?this.opts.beams.length:this.getNbFlags()}getNbFlags(){return this.nbFlags===null&&(this.nbFlags=this.calcNbFlags()),this.nbFlags}calcNbFlags(){const t=this.getBaseQuarterDuration();return Vn.default.quarterToNbFlags(t)}getNbOrnaments(){return this.nbOrnaments===null&&(this.nbOrnaments=this.calcNbOrnaments()),this.nbOrnaments}calcNbOrnaments(){let t=0;return this.opts.ornaments.forEach(function(e){t=Math.max(t,ha.A.ornamentToNbLines(e))}),t}hasTremolo(){return this.opts.ornaments.some(function(t){return ha.A.isTremoloType(t)})}getArticulations(){return this.opts.articulations}hasLyrics(){return this.opts.lyrics.length>0}getLyrics(){return this.opts.lyrics}getTechnical(){return this.opts.technical}getOrnaments(){return this.opts.ornaments}getFrets(){return this.opts.frets}hasFrets(){return this.opts.frets.length>0}getStemDirectionCoeff(){return this.getStemValue()===z.A.UP?1:-1}getBeamData(){return this.beamDisplayData}setBeamData(t){this.beamDisplayData=t}hasDots(){return this.opts.nbDots>0}getNbDots(){return this.opts.nbDots}hasStem(){return this.getBaseQuarterDuration()<4}isHighestLine(t){return t===this.getHighestLine()}isLowestLine(t){return t===this.getLowestLine()}getTieStarts(){return this.opts.tieStarts}getTieStartsDirections(){return this.opts.tieStartsDirections}getSlideStartsDirections(){return this.opts.slideStarts}getSlideStopsDirections(){return this.opts.slideStops}getTieStops(){return this.opts.tieStops}hasTieStart(){return this.opts.tieStarts.length>0}hasTieStop(){return this.opts.tieStops.length>0}getHammerOnPullOffStarts(){return this.opts.hammerOnPullOffStarts}getHammerOnPullOffStops(){return this.opts.hammerOnPullOffStops}hasHammerOnPullOffStart(){return this.opts.hammerOnPullOffStarts.length>0}hasHammerOnPullOffStop(){return this.opts.hammerOnPullOffStops.length>0}hasArpeggio(){return this.opts.hasArpeggio}isGrace(){return this.opts.isGrace}getVoiceIdx(){return this.opts.voiceIdx}hasGlissandoStarts(){return this.opts.glissandoStarts.length>0}getGlissandoStarts(){return this.opts.glissandoStarts}hasGlissandoStops(){return this.opts.glissandoStops.length>0}getGlissandoStops(){return this.opts.glissandoStops}hasSlideStarts(){return this.opts.slideStarts.length>0}getSlideStarts(){return this.opts.slideStarts}hasSlideStops(){return this.opts.slideStops.length>0}getSlideStops(){return this.opts.slideStops}getGlobalCssClassesStr(){return this.opts.globalCssClassesStr}hasFlagDash(){return this.opts.hasFlagDash}getStemStrategy(){return this.opts.stemStrategy}getFingerings(){return this.opts.fingerings}getFingeringDiagramFormula(){return this.opts.fingeringDiagramFormula}getFingeringDisplayType(){return this.opts.fingeringDisplayType}getNoteIdx(){return this.opts.noteIdx}getRestColor(){return this.opts.restColor}isSlash(){return this.opts.isSlash}isRhythmic(){return this.opts.isRhythmic}hasTremoloStart(){return this.opts.hasTremoloStart}hasTremoloStop(){return this.opts.hasTremoloStop}hasTupletStart(){return this.opts.tupletStarts.length>0}getTupletStart(){const t=this.opts.tupletStarts.find(e=>Kp.A.getLevel(e)===1);if(t===void 0)throw new Error("No level 1 tuplet start found");return t}hasTupletStop(){return this.opts.tupletStops.length>0}hasNormalTimeModif(){return FS.default.isNormal(this.opts.timeModif)}getTimeModif(){return this.opts.timeModif}hasSlurStart(){return this.opts.slurStart!==null}getSlurStart(){return this.opts.slurStart}hasSlurStop(){return this.opts.hasSlurStop}getPreBends(){return this.opts.preBends}getPreBendForNoteIdx(t){return this.opts.preBends[t]}getBends(){return this.opts.bends}getBendForNoteIdx(t){return this.opts.bends[t]}}var qS=Object.defineProperty,VS=(s,t,e)=>t in s?qS(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Bl=(s,t,e)=>VS(s,typeof t!="symbol"?t+"":t,e);function QS(s,t,e){const r=new KS(s,t);return r.process(e),r.getEntities()}class KS{constructor(t,e){Bl(this,"pageIdx",0),Bl(this,"request"),Bl(this,"scoreDrawer"),Bl(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const r=t.slice.measures.findIndex(H=>H.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r===-1)return;const i=t.parts.find(H=>H.partData.uuid===this.request.partUuid);if(!i)return;const a=i.staves.find(H=>H.staffData.uuid===this.request.staffUuid);if(!a)return;const l=a.measures[r],d=Array.from(l.tickableContent.voices.values()).find(H=>H instanceof Bt?H.voiceUuid===this.request.voiceUuid:!1);if(!d)return;let f;if(this.request.graceIdx!==null){const H=d.gracesMap.get(this.request.noteIdx);if(!H)return;f=H[this.request.graceIdx]}else f=d.notes[this.request.noteIdx];if(!f)return;const m=f.getChildRoot(),S=rt(m),w=this.scoreDrawer.drawingContext,x=w.createGroupNode();x.setX(S.x),x.setY(S.y);const D=w.createGroupNode();v(x,D);const L=w.createGroupNode();v(x,L);const M=this.createFakeNote(D,L);return Wp(M),ul(M),Vt(L,this.request.color),this.cursorEntities.push({pageIdx:this.pageIdx,node:x}),!0}createFakeNote(t,e){const r=this.scoreDrawer.drawingContext,{line:i,notehead:a}=this.request,l={staffData:(0,Ft.ow)(),lines:[i],heads:[{line:i,notehead:a}],isGrace:this.request.graceIdx!==null,quarterBaseDuration:(0,st.yT)(this.request.duration)},d=new Ol(l);let f=0;return{getDisplayData(){return d},getDrawingContext(){return r},setStemYOffset(){},setLeftStemX(){},getHead(){return e},lineToY(S){return Le.A.lineToY(S,1,5)},setHighestY(){},setLowestY(){},setLeftHeadWidth(){},setRightHeadWidth(){},setMiddleHeadWidth(S){f=S},getMiddleHeadWidth(){return f},getChildRoot(){return t},addLegerLine(){}}}getEntities(){return this.cursorEntities}}var sn=b(372585),Ee=b(723631),Kn=b(773948),JS=Object.defineProperty,$S=(s,t,e)=>t in s?JS(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Tg=(s,t,e)=>$S(s,typeof t!="symbol"?t+"":t,e);function rn(s,t){return`${s}-${t}`}const ZS=new Map([[rn(Kn.A.EIGHT,Ee.A.ABOVE),"ottavaAlta"],[rn(Kn.A.EIGHT,Ee.A.BELOW),"ottavaBassaBa"],[rn(Kn.A.FIFTEEN,Ee.A.ABOVE),"quindicesimaAlta"],[rn(Kn.A.FIFTEEN,Ee.A.BELOW),"quindicesimaBassa"],[rn(Kn.A.TWENTY_TWO,Ee.A.ABOVE),"ventiduesimaAlta"],[rn(Kn.A.TWENTY_TWO,Ee.A.BELOW),"ventiduesimaBassa"]]);class jS{constructor(t,{placement:e,size:r}){Tg(this,"placement"),Tg(this,"size"),Tg(this,"glyphNode"),this.placement=e,this.size=r;const i=this.getGlyphKey();this.glyphNode=t.createGlyphNode(i)}getChildRoot(){return this.glyphNode}getGlyphKey(){const t=rn(this.size,this.placement),e=ZS.get(t);if(!e)throw new Error(`There is no glyph for OctaveShift with size: ${this.size} and placement: ${this.placement}`);return e}getWidth(){return this.glyphNode.glyph.width}getHeight(){return this.glyphNode.glyph.height}}var tw=Object.defineProperty,ew=(s,t,e)=>t in s?tw(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,sr=(s,t,e)=>ew(s,typeof t!="symbol"?t+"":t,e);class jp{constructor(t,e){sr(this,"drawingContext"),sr(this,"textChild"),sr(this,"rangeLine",null),sr(this,"closingLine",null),sr(this,"sizeText",null),sr(this,"leftAnchor",null),sr(this,"rightAnchor",null),sr(this,"x1",null),sr(this,"x2",null),sr(this,"placement"),sr(this,"groupNode"),this.drawingContext=t,this.placement=e.placement,this.textChild=new jS(t,e),this.groupNode=this.drawingContext.createGroupNode(),v(this.groupNode,this.textChild.getChildRoot())}fillEventPayload(){const t=this.getUuid();if(t===null)return;const e={entityType:T.A.OCTAVE_SHIFT,uuid:t};this.groupNode.setEventPayload(e)}getChildRoot(){return this.groupNode}getUuid(){var t,e;return(e=(t=this.leftAnchor)==null?void 0:t.getUuid())!=null?e:null}getHeight(){return this.textChild.getHeight()}isAbove(){return this.placement===Ee.A.ABOVE}isBelow(){return this.placement===Ee.A.BELOW}drawLines(){this.rangeLine===null&&(this.rangeLine=this.drawRangeLine(),v(this.groupNode,this.rangeLine)),!this.isContinueStop()&&this.closingLine===null&&(this.closingLine=this.drawClosingLine(),v(this.groupNode,this.closingLine))}isContinueStop(){var t,e,r;return this.hasRightAnchor()&&(((t=this.rightAnchor)==null?void 0:t.isContinue())||((e=this.rightAnchor)==null?void 0:e.isStart())&&((r=this.rightAnchor)==null?void 0:r.isRight()))}isContinueStart(){var t,e,r;return this.hasLeftAnchor()&&(((t=this.leftAnchor)==null?void 0:t.isContinue())||((e=this.leftAnchor)==null?void 0:e.isStart())&&((r=this.leftAnchor)==null?void 0:r.isLeft()))}destroyLines(){this.rangeLine&&(it(this.groupNode,this.rangeLine),this.rangeLine.destroy(),this.rangeLine=null),this.closingLine&&(it(this.groupNode,this.closingLine),this.closingLine.destroy(),this.closingLine=null)}drawRangeLine(){const t=this.drawingContext.createDashedLineNode();return t.setWidth(this.drawingContext.getOctaveLineThickness()),t.setY(this.getRangeLineY()),t.setX(this.getRangeLineXOffset()),t}getRangeLineXOffset(){return this.textChild.getWidth()+this.drawingContext.getOctaveShiftTextMargin()}getRangeLineY(){const t=this.getHeight()/4;return this.isAbove()?-t*3:-t}drawClosingLine(){const t=this.drawingContext.createLineNode();return t.setWidth(this.drawingContext.getOctaveLineThickness()),t.setY(this.getClosingLineY()),t.setY2(this.getClosingLineY2()),t}getClosingLineY(){const t=this.getHeight()/4;return this.isAbove()?0:-t}getClosingLineY2(){return-(this.getHeight()/4)*3}setX1(t){this.x1=t,this.groupNode.setX(t),this.updateAfterDimensionsChange()}setX2(t){this.x2=t,this.updateAfterDimensionsChange()}updateAfterDimensionsChange(){if(this.x1===null||this.x2===null)return;const t=this.isContinueStop()?0:this.drawingContext.getMarginSize(),e=this.x2-this.x1-this.getRangeLineXOffset()-t,r=this.x2-this.x1-this.drawingContext.getMarginSize();r-this.textChild.getWidth()>this.drawingContext.getMarginSize()?(this.drawLines(),this.rangeLine.setX2(e),this.isContinueStop()||this.closingLine.setX(r)):this.destroyLines()}erase(){this.hasLeftAnchor()&&this.removeLeftAnchor(),this.hasRightAnchor()&&this.removeRightAnchor()}setLeftAnchor(t){this.hasLeftAnchor()&&this.leftAnchor!==t&&this.removeLeftAnchor(),this.leftAnchor=t,this.leftAnchor.setOctaveShift(this)}hasLeftAnchor(){return this.leftAnchor!==null}removeLeftAnchor(){this.hasLeftAnchor()&&(this.leftAnchor.octaveShift=null,this.leftAnchor=null)}setRightAnchor(t){this.hasRightAnchor()&&this.rightAnchor!==t&&this.removeRightAnchor(),this.rightAnchor=t,this.rightAnchor.setOctaveShift(this)}hasRightAnchor(){return this.rightAnchor!==null}removeRightAnchor(){this.hasRightAnchor()&&(this.rightAnchor.octaveShift=null,this.rightAnchor=null)}}var Ea=b(258780),sw=Object.defineProperty,rw=(s,t,e)=>t in s?sw(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,nn=(s,t,e)=>rw(s,typeof t!="symbol"?t+"":t,e);class on{constructor({type:t,size:e,placement:r,timePos:i,location:a,octaveShiftUuid:l}){nn(this,"type"),nn(this,"size"),nn(this,"placement"),nn(this,"timePos"),nn(this,"location"),nn(this,"octaveShiftUuid"),nn(this,"octaveShift",null),this.type=t,this.size=e,this.placement=r,this.timePos=i,this.location=a,this.octaveShiftUuid=l}getUuid(){return this.octaveShiftUuid}getTimePos(){return this.timePos}hasOctaveShift(){return this.octaveShift!==null}setOctaveShift(t){this.octaveShift=t}getOctaveShift(){return this.octaveShift}getRangeEntity(){return this.octaveShift}isStart(){return this.type===sn.A.UP||this.type===sn.A.DOWN}isStop(){return this.type===sn.A.STOP}isContinue(){return this.type===sn.A.CONTINUE}isAbove(){return this.placement===Ee.A.ABOVE}isBelow(){return this.placement===Ee.A.BELOW}hasLocation(){return this.location!==null}isLeft(){return this.hasLocation()?Ea.A.isLeft(this.location):this.isStart()}isRight(){return this.hasLocation()?Ea.A.isRight(this.location):this.isStop()}removeOctaveShift(){if(!this.hasOctaveShift())return;const t=this.octaveShift;if(this.location!==null)Ea.A.isLeft(this.location)?t.removeLeftAnchor():Ea.A.isRight(this.location)?t.removeRightAnchor():Ea.A.raiseError(this.location);else if(this.isStart())t.removeLeftAnchor();else if(this.isStop())t.removeRightAnchor();else throw new Error("Unexpected");this.octaveShift=null}}var iw=Object.defineProperty,nw=(s,t,e)=>t in s?iw(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Da=(s,t,e)=>nw(s,typeof t!="symbol"?t+"":t,e);function ow(s,t,e){const r=new aw(s,t);return r.process(e),r.getEntities()}class aw{constructor(t,e){Da(this,"pageIdx",0),Da(this,"isOngoing",!1),Da(this,"request"),Da(this,"scoreDrawer"),Da(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const e=t.parts.find(w=>w.partData.uuid===this.request.partUuid);if(!e)return;const r=e.staves.find(w=>w.staffData.uuid===this.request.staffUuid);if(!r)return;const i=t.slice,a=this.getLeftAnchor(i,r);if(a===null)return this.isOngoing;const l=this.getRightAnchor(i,r);if(l===null)return!this.isOngoing;const f=this.scoreDrawer.drawingContext.createGroupNode(),m=rt(r.getChildRoot());f.setX(m.x),f.setY(m.y);const S=this.createOctaveShift({staff:r,leftAnchor:a,rightAnchor:l});return v(f,S.getChildRoot()),Vt(f,this.request.color),this.cursorEntities.push({pageIdx:this.pageIdx,node:f}),!this.isOngoing}getLeftAnchor(t,e){if(this.isOngoing){const $=e.measures[0],{tickableContent:lt}=$,{horizontalFormatter:gt}=lt;if(gt===null)throw new Error("Formatter is null");const yt=this.request.placement,dt="left",At=this.request.value,Jt=this.request.size,re=0,ds="",ws=new on({type:At,size:Jt,placement:yt,location:dt,timePos:re,octaveShiftUuid:ds});return Il(ws,$,gt,null)}const r=t.measures.findIndex($=>$.rawGlobalMeasure.measureUuid===this.request.startMeasureUuid);if(r===-1)return null;this.isOngoing=!0;const i=e.measures[r],{tickableContent:a}=i,l=a.horizontalFormatter;if(l===null)throw new Error("Formatter is null");const d=l.getDpq(),f=Dt.default.lcm(d,this.request.startDpq),m=this.request.startTimePos*f/this.request.startDpq,S=l.getNbDivisions()*f/d;if(m<0||m>=S)return null;const w=this.request.placement,x="left",D=this.request.value,L=this.request.size,M="",H=new on({type:D,size:L,placement:w,location:x,timePos:m,octaveShiftUuid:M});return Il(H,i,l,f)}getRightAnchor(t,e){const r=t.measures.findIndex($=>$.rawGlobalMeasure.measureUuid===this.request.stopMeasureUuid);if(r===-1){const $=e.measures[e.measures.length-1],{tickableContent:lt}=$,{horizontalFormatter:gt}=lt;if(gt===null)throw new Error("Formatter is null");const yt=gt.getNbDivisions(),dt=this.request.placement,At="right",Jt=sn.A.CONTINUE,re=this.request.size,ds="",ws=new on({type:Jt,size:re,placement:dt,location:At,timePos:yt,octaveShiftUuid:ds});return Il(ws,$,gt,null)}this.isOngoing=!1;const i=e.measures[r],{tickableContent:a}=i,l=a.horizontalFormatter;if(l===null)throw new Error("Formatter is null");const d=l.getDpq(),f=Dt.default.lcm(d,this.request.stopDpq),m=this.request.stopTimePos*f/this.request.stopDpq,S=l.getNbDivisions()*f/d;if(m<0||m>S)return null;const w=this.request.placement,x="right",D=sn.A.STOP,L=this.request.size,M="",H=new on({type:D,size:L,placement:w,location:x,timePos:m,octaveShiftUuid:M});return Il(H,i,l,f)}createOctaveShift(t){const{staff:e,leftAnchor:r,rightAnchor:i}=t,a=this.scoreDrawer.drawingContext,l=new jp(a,{size:this.request.size,placement:this.request.placement});l.setLeftAnchor(r.anchor),l.setRightAnchor(i.anchor),l.setX1(r.xPos),l.setX2(i.xPos);const{placement:d}=this.request;if(d===I.A.ABOVE)qs([{entity:l,xPosition:l.getChildRoot().getX(),yPosition:null}],e.initialTopHeights,a,!1);else if(d===I.A.BELOW){const f=(0,Ft.o5)(e.staffData);kr([{entity:l,xPosition:l.getChildRoot().getX(),yPosition:null}],e.initialBottomHeights,f,a,!1)}else throw I.A.raiseError(d);return l}getEntities(){return this.cursorEntities}}function Il(s,t,e,r){const{tickableContent:i}=t,a=t.getChildRoot().getX(),l=i.getChildRoot().getX(),d=s.getTimePos();r===null&&(r=e.getDpq());const f=a+l+e.getPosX(d,r);return{anchor:s,xPos:f}}var Di=b(868743),hw=Object.defineProperty,lw=(s,t,e)=>t in s?hw(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,$r=(s,t,e)=>lw(s,typeof t!="symbol"?t+"":t,e);const cw="keyboardPedalPed";class tm{constructor(t){$r(this,"drawingContext"),$r(this,"leftAnchor",null),$r(this,"rightAnchor",null),$r(this,"rangeLine",null),$r(this,"closingLine",null),$r(this,"pedalGlyph"),$r(this,"x1",null),$r(this,"x2",null),$r(this,"groupNode"),this.drawingContext=t,this.groupNode=this.drawingContext.createGroupNode(),this.pedalGlyph=this.drawingContext.createGlyphNode(cw),v(this.groupNode,this.pedalGlyph)}fillEventPayload(){const t=this.getUuid();if(t===null)return;const e={entityType:T.A.PIANO_PEDAL,uuid:t};this.groupNode.setEventPayload(e)}getChildRoot(){return this.groupNode}getHeight(){return this.pedalGlyph.getHeight()}isAbove(){return!1}isBelow(){return!0}getUuid(){var t,e;return(e=(t=this.leftAnchor)==null?void 0:t.getUuid())!=null?e:null}isContinueStop(){return this.hasRightAnchor()&&this.rightAnchor.isContinue()}isContinueStart(){return this.hasLeftAnchor()&&this.leftAnchor.isContinue()}drawLines(){this.rangeLine===null&&(this.rangeLine=this.drawRangeLine(),v(this.groupNode,this.rangeLine)),!this.isContinueStop()&&this.closingLine===null&&(this.closingLine=this.drawClosingLine(),v(this.groupNode,this.closingLine))}destroyLines(){this.rangeLine&&(it(this.groupNode,this.rangeLine),this.rangeLine.destroy(),this.rangeLine=null),this.closingLine&&(it(this.groupNode,this.closingLine),this.closingLine.destroy(),this.closingLine=null)}drawRangeLine(){const t=this.drawingContext.createDashedLineNode();return t.setWidth(this.drawingContext.getPedalLineThickness()),t.setY(this.getRangeLineY()),t.setX(this.getRangeLineXOffset()),t}getRangeLineXOffset(){return this.pedalGlyph.getWidth()+this.drawingContext.getPedalGlyphMargin()}getRangeLineY(){return-(this.getHeight()/4)}drawClosingLine(){const t=this.drawingContext.createLineNode();return t.setWidth(this.drawingContext.getPedalLineThickness()),t.setY(this.getClosingLineY()),t.setY2(this.getClosingLineY2()),t}getClosingLineY(){return-(this.getHeight()/4)}getClosingLineY2(){return-(this.getHeight()/4)*3}setX1(t){this.x1=t,this.groupNode.setX(t),this.updateAfterDimensionsChange()}setX2(t){this.x2=t,this.updateAfterDimensionsChange()}updateAfterDimensionsChange(){if(this.x1===null||this.x2===null)return;const t=this.isContinueStop()?0:this.drawingContext.getMarginSize(),e=this.x2-this.x1-this.getRangeLineXOffset()-t,r=this.x2-this.x1-this.drawingContext.getMarginSize();r-this.pedalGlyph.getWidth()>this.drawingContext.getMarginSize()?(this.drawLines(),this.rangeLine.setX2(e),this.isContinueStop()||this.closingLine.setX(r)):this.destroyLines()}erase(){this.hasLeftAnchor()&&this.removeLeftAnchor(),this.hasRightAnchor()&&this.removeRightAnchor()}setLeftAnchor(t){this.hasLeftAnchor()&&this.leftAnchor!==t&&this.removeLeftAnchor(),this.leftAnchor=t,this.leftAnchor.setPedal(this)}hasLeftAnchor(){return this.leftAnchor!==null}removeLeftAnchor(){this.hasLeftAnchor()&&(this.leftAnchor.pedal=null,this.leftAnchor=null)}removeRightAnchor(){this.hasRightAnchor()&&(this.rightAnchor.pedal=null,this.rightAnchor=null)}setRightAnchor(t){this.hasRightAnchor()&&this.rightAnchor!==t&&this.removeRightAnchor(),this.rightAnchor=t,this.rightAnchor.setPedal(this)}hasRightAnchor(){return this.rightAnchor!==null}}var Ca=b(468852),uw=Object.defineProperty,dw=(s,t,e)=>t in s?uw(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ta=(s,t,e)=>dw(s,typeof t!="symbol"?t+"":t,e);class an{constructor({timePos:t,type:e,pedalUuid:r,location:i}){Ta(this,"type"),Ta(this,"location"),Ta(this,"timePos"),Ta(this,"pedalUuid"),Ta(this,"pedal",null),this.type=e,this.location=i,this.timePos=t,this.pedalUuid=r}getUuid(){return this.pedalUuid}getTimePos(){return this.timePos}hasPedal(){return this.pedal!==null}setPedal(t){this.pedal=t}getPedal(){return this.pedal}getRangeEntity(){return this.pedal}isStart(){return Di.A.isStart(this.type)}isStop(){return Di.A.isStop(this.type)}isContinue(){return this.type===Di.A.CONTINUE}hasLocation(){return this.location!==null}isLeft(){return this.hasLocation()?Ca.A.isLeft(this.location):this.isStart()}isRight(){return this.hasLocation()?Ca.A.isRight(this.location):this.isStop()}removePedal(){if(!this.hasPedal())return;const t=this.pedal;if(this.location!==null)Ca.A.isLeft(this.location)?t.removeLeftAnchor():Ca.A.isRight(this.location)?t.removeRightAnchor():Ca.A.raiseError(this.location);else if(this.isStart())t.removeLeftAnchor();else if(this.isStop())t.removeRightAnchor();else throw new Error("Unexpected");this.pedal=null}}var fw=Object.defineProperty,gw=(s,t,e)=>t in s?fw(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ra=(s,t,e)=>gw(s,typeof t!="symbol"?t+"":t,e);function pw(s,t,e){const r=new mw(s,t);return r.process(e),r.getEntities()}class mw{constructor(t,e){Ra(this,"pageIdx",0),Ra(this,"isOngoing",!1),Ra(this,"request"),Ra(this,"scoreDrawer"),Ra(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const e=t.parts.find(w=>w.partData.uuid===this.request.partUuid);if(!e)return;const r=e.staves.find(w=>w.staffData.uuid===this.request.staffUuid);if(!r)return;const i=t.slice,a=this.getLeftAnchor(i,r);if(a===null)return this.isOngoing;const l=this.getRightAnchor(i,r);if(l===null)return!this.isOngoing;const f=this.scoreDrawer.drawingContext.createGroupNode(),m=rt(r.getChildRoot());f.setX(m.x),f.setY(m.y);const S=this.createPianoPedal({staff:r,leftAnchor:a,rightAnchor:l});return v(f,S.getChildRoot()),Vt(f,this.request.color),this.cursorEntities.push({pageIdx:this.pageIdx,node:f}),!this.isOngoing}getLeftAnchor(t,e){if(this.isOngoing){const M=e.measures[0],{tickableContent:H}=M,{horizontalFormatter:$}=H;if($===null)throw new Error("Formatter is null");const lt="left",gt=0,yt="",dt=Di.A.START,At=new an({location:lt,timePos:gt,pedalUuid:yt,type:dt});return Fl(At,M,$,null)}const r=t.measures.findIndex(M=>M.rawGlobalMeasure.measureUuid===this.request.startMeasureUuid);if(r===-1)return null;this.isOngoing=!0;const i=e.measures[r],{tickableContent:a}=i,l=a.horizontalFormatter;if(l===null)throw new Error("Formatter is null");const d=l.getDpq(),f=Dt.default.lcm(d,this.request.startDpq),m=this.request.startTimePos*f/this.request.startDpq,S=l.getNbDivisions()*f/d;if(m<0||m>=S)return null;const w="left",x="",D=Di.A.START,L=new an({location:w,timePos:m,pedalUuid:x,type:D});return Fl(L,i,l,f)}getRightAnchor(t,e){const r=t.measures.findIndex(M=>M.rawGlobalMeasure.measureUuid===this.request.stopMeasureUuid);if(r===-1){const M=e.measures[e.measures.length-1],{tickableContent:H}=M,{horizontalFormatter:$}=H;if($===null)throw new Error("Formatter is null");const lt=$.getNbDivisions(),gt="right",yt=Di.A.CONTINUE,dt="",At=new an({type:yt,location:gt,timePos:lt,pedalUuid:dt});return Fl(At,M,$,null)}this.isOngoing=!1;const i=e.measures[r],{tickableContent:a}=i,l=a.horizontalFormatter;if(l===null)throw new Error("Formatter is null");const d=l.getDpq(),f=Dt.default.lcm(d,this.request.stopDpq),m=this.request.stopTimePos*f/this.request.stopDpq,S=l.getNbDivisions()*f/d;if(m<0||m>S)return null;const w="right",x=Di.A.STOP,D="",L=new an({type:x,location:w,timePos:m,pedalUuid:D});return Fl(L,i,l,f)}createPianoPedal(t){const{staff:e,leftAnchor:r,rightAnchor:i}=t,a=this.scoreDrawer.drawingContext,l=new tm(a);l.setLeftAnchor(r.anchor),l.setRightAnchor(i.anchor),l.setX1(r.xPos),l.setX2(i.xPos);const d=(0,Ft.o5)(e.staffData);return kr([{entity:l,xPosition:l.getChildRoot().getX(),yPosition:null}],e.initialBottomHeights,d,a,!1),l}getEntities(){return this.cursorEntities}}function Fl(s,t,e,r){const{tickableContent:i}=t,a=t.getChildRoot().getX(),l=i.getChildRoot().getX(),d=s.getTimePos();r===null&&(r=e.getDpq());const f=a+l+e.getPosX(d,r);return{anchor:s,xPos:f}}var yw=b(603581),Aw=Object.defineProperty,vw=(s,t,e)=>t in s?Aw(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Jn=(s,t,e)=>vw(s,typeof t!="symbol"?t+"":t,e);class em{constructor(t,e){Jn(this,"textNode"),Jn(this,"timePos"),Jn(this,"dpq"),Jn(this,"placement"),Jn(this,"uuid"),Jn(this,"type");const r=yw.A.getText(e.type),i=t.getPizzicatoFontOptions();this.textNode=t.createTextNode(r,i),this.timePos=e.timePos,this.dpq=e.dpq,this.placement=e.placement,this.uuid=e.uuid,this.type=e.type}fillEventPayload(){const t={entityType:T.A.PIZZICATO,timePos:this.timePos,dpq:this.dpq,placement:this.placement,uuid:this.uuid,type:this.type};this.textNode.setEventPayload(t)}getChildRoot(){return this.textNode}getUuid(){return this.uuid}getTimePos(){return this.timePos}setX(t){this.textNode.setX(t)}getHorizontalData(){const t=this.textNode.getLocalBBox();if(t===null)throw new Error("bbox is null");return{timePos:this.timePos,duration:0,spaceBefore:-t.minX,spaceAfter:t.maxX,isRest:!1}}}var Sw=Object.defineProperty,ww=(s,t,e)=>t in s?Sw(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ul=(s,t,e)=>ww(s,typeof t!="symbol"?t+"":t,e);function xw(s,t,e){const r=new bw(s,t);return r.process(e),r.getEntities()}class bw{constructor(t,e){Ul(this,"pageIdx",0),Ul(this,"request"),Ul(this,"scoreDrawer"),Ul(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const r=t.slice.measures.findIndex(H=>H.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r===-1)return;const i=t.parts.find(H=>H.partData.uuid===this.request.partUuid);if(!i)return;const a=i.staves.find(H=>H.staffData.uuid===this.request.staffUuid);if(!a)return;const l=a.measures[r],{tickableContent:d}=l,f=d.horizontalFormatter;if(f===null)throw new Error("Formatter is null");const m=f.getDpq(),S=Dt.default.lcm(m,this.request.dpq),w=this.request.timePos*S/this.request.dpq,x=f.getNbDivisions()*S/m;if(w<0||w>=x)return!0;const D=this.scoreDrawer.drawingContext.createGroupNode(),L=rt(d.getChildRoot());D.setX(L.x),D.setY(L.y);const M=this.createPizzicato({tickableContent:d,measure:l,formatter:f,staff:a,mergedTimePos:w,mergedDpq:S});return v(D,M.getChildRoot()),Vt(D,this.request.color),this.cursorEntities.push({pageIdx:this.pageIdx,node:D}),!0}createPizzicato(t){const{tickableContent:e,measure:r,formatter:i,staff:a,mergedTimePos:l,mergedDpq:d}=t,f=this.scoreDrawer.drawingContext,m=e.getChildRoot(),S=new em(f,{type:this.request.value,timePos:0,dpq:1,placement:this.request.placement,uuid:""}),w=i.getPosX(l,d);S.setX(w);const x=r.getChildRoot(),D=w+m.getX()+x.getX(),{placement:L}=this.request;if(L===I.A.ABOVE)qs([{entity:S,xPosition:D,yPosition:null}],a.initialTopHeights,f,!1);else if(L===I.A.BELOW){const M=(0,Ft.o5)(a.staffData);kr([{entity:S,xPosition:D,yPosition:null}],a.initialBottomHeights,M,f,!1)}else throw I.A.raiseError(L);return S}getEntities(){return this.cursorEntities}}var Ci=b(97324),Pw=Object.defineProperty,Ew=(s,t,e)=>t in s?Pw(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Rg=(s,t,e)=>Ew(s,typeof t!="symbol"?t+"":t,e);const Dw=new Map([[Ci.A.PALM_MUTE,"P.M."],[Ci.A.LET_RING,"let ring"]]);class Cw{constructor(t,e){Rg(this,"drawingContext"),Rg(this,"type"),Rg(this,"textNode"),this.drawingContext=t,this.type=e;const r=t.getPluckedRangeFontOptions(),i=Dw.get(e);if(!i)throw new Error("Unexpected");this.textNode=t.createTextNode(i,r)}getChildRoot(){return this.textNode}}var Tw=Object.defineProperty,Rw=(s,t,e)=>t in s?Tw(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Mr=(s,t,e)=>Rw(s,typeof t!="symbol"?t+"":t,e);class sm{constructor(t,e){Mr(this,"drawingContext"),Mr(this,"textChild"),Mr(this,"rangeLine",null),Mr(this,"closingLine",null),Mr(this,"leftAnchor",null),Mr(this,"rightAnchor",null),Mr(this,"x1",null),Mr(this,"x2",null),Mr(this,"groupNode"),Mr(this,"type"),this.drawingContext=t,this.type=e,this.textChild=new Cw(t,e),this.groupNode=this.drawingContext.createGroupNode(),v(this.groupNode,this.textChild.getChildRoot())}fillEventPayload(){const t=this.getUuid();if(t===null)return;const e={entityType:T.A.PLUCKED_RANGE,type:this.type,uuid:t};this.groupNode.setEventPayload(e)}getChildRoot(){return this.groupNode}getUuid(){var t,e;return(e=(t=this.leftAnchor)==null?void 0:t.getUuid())!=null?e:null}getHeight(){return this.textChild.getChildRoot().getFontSize()}isAbove(){return this.leftAnchor!==null&&this.leftAnchor.isAbove()}isBelow(){return this.leftAnchor!==null&&this.leftAnchor.isBelow()}isContinueStop(){var t,e,r;return this.hasRightAnchor()&&(((t=this.rightAnchor)==null?void 0:t.isContinue())||((e=this.rightAnchor)==null?void 0:e.isStart())&&((r=this.rightAnchor)==null?void 0:r.isRight()))}isContinueStart(){var t,e,r;return this.hasLeftAnchor()&&(((t=this.leftAnchor)==null?void 0:t.isContinue())||((e=this.leftAnchor)==null?void 0:e.isStart())&&((r=this.leftAnchor)==null?void 0:r.isLeft()))}drawLines(){this.rangeLine===null&&(this.rangeLine=this.drawRangeLine(),v(this.groupNode,this.rangeLine)),!this.isContinueStop()&&this.closingLine===null&&(this.closingLine=this.drawClosingLine(),v(this.groupNode,this.closingLine))}destroyLines(){this.rangeLine&&(it(this.groupNode,this.rangeLine),this.rangeLine.destroy(),this.rangeLine=null),this.closingLine&&(it(this.groupNode,this.closingLine),this.closingLine.destroy(),this.closingLine=null)}drawRangeLine(){const t=this.drawingContext.createDashedLineNode();return t.setWidth(this.drawingContext.getPluckedRangeLineThickness()),t.setY(this.getRangeLineY()),t.setX(this.getRangeLineXOffset()),t}getYPlacementOffset(){return this.getHeight()/4}getRangeLineXOffset(){return this.textChild.getChildRoot().getWidth()+this.drawingContext.getPluckedRangeTextMargin()}getRangeLineY(){return-this.getHeight()/2+this.getYPlacementOffset()}drawClosingLine(){const t=this.drawingContext.createLineNode();return t.setWidth(this.drawingContext.getOctaveLineThickness()),t.setY(this.getClosingLineY()),t.setY2(this.getClosingLineY2()),t}getClosingLineY(){return this.getYPlacementOffset()}getClosingLineY2(){return-this.getHeight()}setX1(t){this.x1=t,this.groupNode.setX(t),this.updateAfterDimensionsChange()}setX2(t){this.x2=t,this.updateAfterDimensionsChange()}updateAfterDimensionsChange(){if(this.x1===null||this.x2===null)return;const t=this.isContinueStop()?0:this.drawingContext.getMarginSize(),e=this.x2-this.x1-this.getRangeLineXOffset()-t,r=this.x2-this.x1-this.drawingContext.getMarginSize();r-this.textChild.getChildRoot().getWidth()>this.drawingContext.getPluckedRangeTextMargin()?(this.drawLines(),this.rangeLine.setX2(e),this.isContinueStop()||this.closingLine.setX(r)):this.destroyLines()}erase(){this.hasLeftAnchor()&&this.removeLeftAnchor(),this.hasRightAnchor()&&this.removeRightAnchor()}setLeftAnchor(t){this.hasLeftAnchor()&&this.leftAnchor!==t&&this.removeLeftAnchor(),this.leftAnchor=t,this.leftAnchor.setPluckedRange(this)}hasLeftAnchor(){return this.leftAnchor!==null}removeLeftAnchor(){this.hasLeftAnchor()&&(this.leftAnchor.pluckedRange=null,this.leftAnchor=null)}setRightAnchor(t){this.hasRightAnchor()&&this.rightAnchor!==t&&this.removeRightAnchor(),this.rightAnchor=t,this.rightAnchor.setPluckedRange(this)}hasRightAnchor(){return this.rightAnchor!==null}removeRightAnchor(){this.hasRightAnchor()&&(this.rightAnchor.pluckedRange=null,this.rightAnchor=null)}}var Na=b(231189),Nw=Object.defineProperty,Lw=(s,t,e)=>t in s?Nw(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,$n=(s,t,e)=>Lw(s,typeof t!="symbol"?t+"":t,e);class hn{constructor({type:t,placement:e,timePos:r,location:i,pluckedRangeUuid:a}){$n(this,"type"),$n(this,"placement"),$n(this,"timePos"),$n(this,"location"),$n(this,"pluckedRangeUuid"),$n(this,"pluckedRange",null),this.type=t,this.placement=e,this.timePos=r,this.location=i,this.pluckedRangeUuid=a}getTimePos(){return this.timePos}getUuid(){return this.pluckedRangeUuid}hasPluckedRange(){return this.pluckedRange!==null}setPluckedRange(t){this.pluckedRange=t}getPluckedRange(){return this.pluckedRange}getRangeEntity(){return this.pluckedRange}isStart(){return Ci.A.isStart(this.type)}isStop(){return Ci.A.isStop(this.type)}isContinue(){return this.type===Ci.A.CONTINUE}isAbove(){return this.placement===Ee.A.ABOVE}isBelow(){return this.placement===Ee.A.BELOW}hasLocation(){return this.location!==null}isLeft(){return this.hasLocation()?Na.A.isLeft(this.location):this.isStart()}isRight(){return this.hasLocation()?Na.A.isRight(this.location):this.isStop()}removePluckedRange(){if(!this.hasPluckedRange())return;const t=this.pluckedRange;if(this.location!==null)Na.A.isLeft(this.location)?t.removeLeftAnchor():Na.A.isRight(this.location)?t.removeRightAnchor():Na.A.raiseError(this.location);else if(this.isStart())t.removeLeftAnchor();else if(this.isStop())t.removeRightAnchor();else throw new Error("Unexpected");this.pluckedRange=null}}var Mw=Object.defineProperty,Ow=(s,t,e)=>t in s?Mw(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,La=(s,t,e)=>Ow(s,typeof t!="symbol"?t+"":t,e);function Bw(s,t,e){const r=new Iw(s,t);return r.process(e),r.getEntities()}class Iw{constructor(t,e){La(this,"pageIdx",0),La(this,"isOngoing",!1),La(this,"request"),La(this,"scoreDrawer"),La(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const e=t.parts.find(w=>w.partData.uuid===this.request.partUuid);if(!e)return;const r=e.staves.find(w=>w.staffData.uuid===this.request.staffUuid);if(!r)return;const i=t.slice,a=this.getLeftAnchor(i,r);if(a===null)return this.isOngoing;const l=this.getRightAnchor(i,r);if(l===null)return!this.isOngoing;const f=this.scoreDrawer.drawingContext.createGroupNode(),m=rt(r.getChildRoot());f.setX(m.x),f.setY(m.y);const S=this.createPluckedRange({staff:r,leftAnchor:a,rightAnchor:l});return v(f,S.getChildRoot()),Vt(f,this.request.color),this.cursorEntities.push({pageIdx:this.pageIdx,node:f}),!this.isOngoing}getLeftAnchor(t,e){if(this.isOngoing){const H=e.measures[0],{tickableContent:$}=H,{horizontalFormatter:lt}=$;if(lt===null)throw new Error("Formatter is null");const gt=this.request.placement,yt="left",dt=this.request.value,At=0,Jt="",re=new hn({type:dt,placement:gt,location:yt,timePos:At,pluckedRangeUuid:Jt});return Hl(re,H,lt,null)}const r=t.measures.findIndex(H=>H.rawGlobalMeasure.measureUuid===this.request.startMeasureUuid);if(r===-1)return null;this.isOngoing=!0;const i=e.measures[r],{tickableContent:a}=i,l=a.horizontalFormatter;if(l===null)throw new Error("Formatter is null");const d=l.getDpq(),f=Dt.default.lcm(d,this.request.startDpq),m=this.request.startTimePos*f/this.request.startDpq,S=l.getNbDivisions()*f/d;if(m<0||m>=S)return null;const w=this.request.placement,x="left",D=this.request.value,L="",M=new hn({type:D,placement:w,location:x,timePos:m,pluckedRangeUuid:L});return Hl(M,i,l,f)}getRightAnchor(t,e){const r=t.measures.findIndex(H=>H.rawGlobalMeasure.measureUuid===this.request.stopMeasureUuid);if(r===-1){const H=e.measures[e.measures.length-1],{tickableContent:$}=H,{horizontalFormatter:lt}=$;if(lt===null)throw new Error("Formatter is null");const gt=lt.getNbDivisions(),yt=this.request.placement,dt="right",At=Ci.A.CONTINUE,Jt="",re=new hn({type:At,placement:yt,location:dt,timePos:gt,pluckedRangeUuid:Jt});return Hl(re,H,lt,null)}this.isOngoing=!1;const i=e.measures[r],{tickableContent:a}=i,l=a.horizontalFormatter;if(l===null)throw new Error("Formatter is null");const d=l.getDpq(),f=Dt.default.lcm(d,this.request.stopDpq),m=this.request.stopTimePos*f/this.request.stopDpq,S=l.getNbDivisions()*f/d;if(m<0||m>S)return null;const w=this.request.placement,x="right",D=Ci.A.STOP,L="",M=new hn({type:D,placement:w,location:x,timePos:m,pluckedRangeUuid:L});return Hl(M,i,l,f)}createPluckedRange(t){const{staff:e,leftAnchor:r,rightAnchor:i}=t,a=this.scoreDrawer.drawingContext,l=new sm(a,this.request.value);l.setLeftAnchor(r.anchor),l.setRightAnchor(i.anchor),l.setX1(r.xPos),l.setX2(i.xPos);const{placement:d}=this.request;if(d===I.A.ABOVE)qs([{entity:l,xPosition:l.getChildRoot().getX(),yPosition:null}],e.initialTopHeights,a,!1);else if(d===I.A.BELOW){const f=(0,Ft.o5)(e.staffData);kr([{entity:l,xPosition:l.getChildRoot().getX(),yPosition:null}],e.initialBottomHeights,f,a,!1)}else throw I.A.raiseError(d);return l}getEntities(){return this.cursorEntities}}function Hl(s,t,e,r){const{tickableContent:i}=t,a=t.getChildRoot().getX(),l=i.getChildRoot().getX(),d=s.getTimePos();r===null&&(r=e.getDpq());const f=a+l+e.getPosX(d,r);return{anchor:s,xPos:f}}var Fw=Object.defineProperty,Uw=(s,t,e)=>t in s?Fw(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ma=(s,t,e)=>Uw(s,typeof t!="symbol"?t+"":t,e);const rm=.7;function Hw(s,t,e){const r=new _w(s,t);return r.process(e),r.getEntities()}class _w{constructor(t,e){Ma(this,"pageIdx",0),Ma(this,"request"),Ma(this,"scoreDrawer"),Ma(this,"cursorEntities",[]),Ma(this,"partStavesMap"),this.request=t,this.scoreDrawer=e,this.partStavesMap=new Map(t.partStaves.map(({partUuid:r,staffUuid:i})=>[im(r,i),!1]))}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.forEach(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.forEach(this.processSystem,this)}processSystem(t){t.parts.forEach(e=>{const r=e.partData.uuid;e.staves.forEach(i=>{const a=i.staffData.uuid,l=im(r,a);this.partStavesMap.has(l)&&this.processStaff(l,t,i)})})}processStaff(t,e,r){const i=e.slice,a=this.getLeftAnchor(t,i,r);if(a===null)return;const l=this.getRightAnchor(t,i,r);if(l===null)return;const d=this.scoreDrawer.drawingContext,f=d.createGroupNode(),m=rt(r.getChildRoot());f.setX(m.x),f.setY(m.y);const S=(0,Ft.o5)(r.staffData),w=d.createBeamNode(S);w.setY(0),w.setY2(0),w.setX(a),w.setX2(l-a),w.updatePath(),w.setLabel("range-selection-rectangle"),v(f,w),Vt(f,this.request.color),w.setMixBlendMode("darken"),this.cursorEntities.push({pageIdx:this.pageIdx,node:f})}getLeftAnchor(t,e,r){if(this.partStavesMap.get(t))return r.measures[0].getChildRoot().getX();const i=e.measures.findIndex(D=>D.rawGlobalMeasure.measureUuid===this.request.startMeasureUuid);if(i===-1)return null;this.partStavesMap.set(t,!0);const a=r.measures[i],{tickableContent:l}=a,d=l.horizontalFormatter;if(d===null)throw new Error("Formatter is null");const f=d.getDpq(),m=Dt.default.lcm(f,this.request.startDpq);let S=this.request.startTimePos*m/this.request.startDpq;const w=d.getNbDivisions()*m/f;S<0&&(S=0),S>w&&(S=w);const x=d.getPosX(S,m);return a.getChildRoot().getX()+l.getChildRoot().getX()+x-rm}getRightAnchor(t,e,r){const i=e.measures.findIndex(D=>D.rawGlobalMeasure.measureUuid===this.request.stopMeasureUuid);if(i===-1){const D=r.measures[r.measures.length-1],L=D.getWidth();return D.getChildRoot().getX()+L}this.partStavesMap.set(t,!1);const a=r.measures[i],{tickableContent:l}=a,d=l.horizontalFormatter;if(d===null)throw new Error("Formatter is null");const f=d.getDpq(),m=Dt.default.lcm(f,this.request.stopDpq);let S=this.request.stopTimePos*m/this.request.stopDpq;const w=d.getNbDivisions()*m/f;S<0&&(S=0),S>w&&(S=w);const x=d.getPosX(S,m);return a.getChildRoot().getX()+l.getChildRoot().getX()+x-rm}getEntities(){return this.cursorEntities}}function im(s,t){return`${s}-${t}`}var Gw=Object.defineProperty,Xw=(s,t,e)=>t in s?Gw(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Oa=(s,t,e)=>Xw(s,typeof t!="symbol"?t+"":t,e);const Ww=.3;function zw(s,t,e){const r=new Yw(s,t);r.process(e);const i=r.getEntities();return t.setPlaybackSliderCursorEntity(i[0]),i}class Yw{constructor(t,e){Oa(this,"pageIdx",0),Oa(this,"numberOfPartsProcessed",0),Oa(this,"request"),Oa(this,"scoreDrawer"),Oa(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else{const e=this.scoreDrawer.getNbParts();for(let r=0;r<t.length;r++){const i=t[r];if(this.processPageIndex(i)&&this.numberOfPartsProcessed===e)break}}}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const r=t.slice.measures.findIndex(L=>L.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r===-1)return;const i=t.getTopPart().getTopStaff().getMeasure(r),a=i.tickableContent,l=i.getTickableFormatter(),d=l.getWidth(),f=rt(a.getChildRoot()),m=l.getQuarterDuration();if(this.request.quarterFromMeasureStart<0||this.request.quarterFromMeasureStart>=m)return!1;const S=this.request.quarterFromMeasureStart/m,w=d*S,D=this.scoreDrawer.drawingContext.createGroupNode();return D.setX(f.x+w),D.setY(0),t.parts.forEach(L=>{const M=this.createLine(L);v(D,M),this.numberOfPartsProcessed++}),this.cursorEntities.push({pageIdx:this.pageIdx,node:D}),!0}createLine(t){const e=this.scoreDrawer.drawingContext,r=t.getChildRoot(),i=rt(r),a=t.getStaffHeight(),l=e.createLineNode();return l.setX(0),l.setX2(0),l.setY(i.y),l.setY2(a),l.setWidth(Ww),l.setStrokeColor(this.request.color),l.setLabel("playback-slider"),l}getEntities(){return this.cursorEntities}}var nm=b(794799),Ng=b(712947),kw=Object.defineProperty,qw=(s,t,e)=>t in s?kw(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,ln=(s,t,e)=>qw(s,typeof t!="symbol"?t+"":t,e);class Ti{constructor(t){ln(this,"slurData"),ln(this,"slurUuid",null),ln(this,"measure"),ln(this,"note"),ln(this,"isExternal"),ln(this,"slur",null),ln(this,"voiceUuid"),this.slurData=t.slurData,this.measure=t.measure,this.note=t.note,this.isExternal=t.isExternal,this.slurData&&Ng.default.hasUuid(this.slurData)&&(this.slurUuid=Ng.default.getUuid(this.slurData)),this.voiceUuid=t.voiceUuid}isStart(){return this.slurData}isStop(){return!this.slurData}getSlurData(){if(!this.slurData)throw new Error("Cannot get slur data without slur data");return this.slurData}getVoiceIdx(){return this.note.getVoiceIdx()}getVoiceUuid(){return this.voiceUuid}getSlurUuid(){return this.slurUuid}getPosition(){if(this.isExternal)return this.getEdgePosition();{const t=this.measure.getX(),e=this.measure.getTickableContentPosition(),r=this.note.getPosition(),i=this.note.getMiddleHeadWidth();return t+e+r+i/2}}getEdgePosition(){if(!this.measure.horizontalFormatter)throw new Error("Cannot get right X without left anchor location formatter");if(!this.measure.horizontalFormatter.tickableFormatter)throw new Error("Cannot get right X without left anchor location tickable formatter");if(this.isStart()){const t=this.measure.getX(),e=this.measure.getTickableContentPosition(),r=this.measure.getSpaceBeforeNotes();return t+e-r}else if(this.isStop()){const t=this.measure.getX(),e=this.measure.getTickableContentPosition(),r=this.measure.horizontalFormatter.tickableFormatter.getWidth();return t+e+r}else throw new Error("Unreachable")}getStemStrategy(){return this.note.getDisplayData().getStemStrategy()}getStemDiraction(){const t=this.note.getDisplayData();return t.isRest()?z.A.UP:t.getStemValue()}}var Vw=Object.defineProperty,Qw=(s,t,e)=>t in s?Vw(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,om=(s,t,e)=>Qw(s,typeof t!="symbol"?t+"":t,e);const Kw="slur";class Jw{constructor(t){om(this,"data",null),om(this,"curveNode");const e=t.getSlurEndpointThickness(),r=t.getSlurMidpointThickness();this.curveNode=t.createCubicCurveNode(e,r),this.curveNode.setLabel(Kw)}setControlPoints(t,e,r,i){this.curveNode.setX(t.x),this.curveNode.setY(t.y);const a={x:e.x-t.x,y:e.y-t.y},l={x:r.x-t.x,y:r.y-t.y},d={x:i.x-t.x,y:i.y-t.y};this.curveNode.setPoints(a,l,d),this.data={leftControlY:a.y,rightControlY:l.y,rightY:d.y,relativeLeftControlX:a.x,relativeRightControlX:r.x-i.x}}formatHorizontal(t,e){if(this.data===null)return;this.curveNode.setX(t);const r={x:0+this.data.relativeLeftControlX,y:this.data.leftControlY},i={x:e-t,y:this.data.rightY},a={x:i.x+this.data.relativeRightControlX,y:this.data.rightControlY};this.curveNode.setPoints(r,a,i)}destroy(){this.curveNode.destroy()}getChildRoot(){return this.curveNode}}var $w=Object.defineProperty,Zw=(s,t,e)=>t in s?$w(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ba=(s,t,e)=>Zw(s,typeof t!="symbol"?t+"":t,e);class am{constructor(t,e){Ba(this,"drawingContext"),Ba(this,"staffData"),Ba(this,"curve"),Ba(this,"leftAnchor",null),Ba(this,"rightAnchor",null),this.drawingContext=t,this.staffData=e,this.curve=new Jw(t)}fillEventPayload(){if(this.leftAnchor===null)return;const t=this.leftAnchor.getSlurUuid();if(!t)return;const e=this.leftAnchor.getVoiceUuid(),r={entityType:T.A.SLUR,voiceUuid:e,uuid:t};this.curve.curveNode.setEventPayload(r)}getSlurData(){if(!this.leftAnchor)throw new Error("Cannot get slur data without left anchor");return this.leftAnchor.getSlurData()}setControlPoints(t,e,r,i){this.curve.setControlPoints(t,e,r,i)}formatHorizontal(){const t=this.getLeftX(),e=this.getRightX();this.curve.formatHorizontal(t,e)}getLeftX(){if(!this.leftAnchor)throw new Error("Cannot get left X without left anchor");return this.leftAnchor.getPosition()}getRightX(){if(!this.rightAnchor)throw new Error("Cannot get right X without right anchor");return this.rightAnchor.getPosition()}getChildRoot(){return this.curve.getChildRoot()}getVoiceUuid(){var t,e;return(e=(t=this.leftAnchor)==null?void 0:t.getVoiceUuid())!=null?e:null}getUuid(){var t,e;return(e=(t=this.leftAnchor)==null?void 0:t.getSlurUuid())!=null?e:null}isOrphan(){return!this.leftAnchor||!this.rightAnchor&&!this.getChildRoot().parent}destroy(){this.curve.destroy()}setLeftAnchor(t){t!==this.leftAnchor&&(this.leftAnchor=t,t!==null&&this.fillEventPayload())}setRightAnchor(t){t!==this.rightAnchor&&(this.rightAnchor=t)}}var xe=b(435808),hm=b(825711),jw=b(276463);function lm(s,t,e){const r=[];let i=0,a=!1,l=!1;s.some(S=>(S.x===t&&(a=!0),S.x===e&&(l=!0),S.x>t&&!a&&r.length===0&&!a&&(r.push({x:t,y:i}),a=!0),S.x>=t&&S.x<=e&&r.push(S),S.x>e?(l||(r.push({x:e,y:S.y}),l=!0),!0):(i=S.y,!1))),a||r.unshift({x:t,y:0}),l||r.push({x:e,y:0}),r[0].y!==0&&r.unshift({x:t,y:0});const f=r.length-1;return r[f].y!==0&&r.push({x:e,y:0}),r}var cm=b(741696),um=b(245814);const dm=1/3,tx=24;function fm(s,t){const e=s.length,r=s[0],i=s[e-1];let a=i.x-r.x;t.increased&&(a=Math.min(a,tx)),(0,um.A)(t.left,a*dm),(0,um.A)(t.right,-a*dm);const l=(0,cm.A)(r,t.left),d=(0,cm.A)(i,t.right);return{left:l,right:d}}var gm=b(458098),pm=b(148029),ex=b(800097);const mm=Dt.default.degreesToGradians(30),sx=Math.PI-mm,rx=Math.cos(sx);function ym(s,t){const e=ix(s);return nx(e)&&ox(e,t),e}function ix(s){const t=s.length,e=s[0],r=s[1],i=s[t-1],a=s[t-2],l=(0,pm.A)(e,r),d=(0,pm.A)(i,a);return{left:l,right:d,increased:!1}}function nx(s){return(0,ex.A)(s.left,s.right)<rx}function ox(s,t){const r=ax(t)*mm/2,i=-r;s.left=(0,gm.A)(s.left,r),s.right=(0,gm.A)(s.right,i),s.increased=!0}function ax(s){if(s===xe.A.ABOVE)return-1;if(s===xe.A.BELOW)return 1;throw xe.A.raiseError(s)}var _l=b(364842);function hx(s,t,e,r,i){const a=lx(s,t,e),l=cx(s,r,i);return{above:a,below:l}}const lx=function(s,t,e){const r=s.indexOf(e);Gl(r);const i=s.indexOf(t);Gl(i);const a=Am(s,r,i+1);return a.reverse(),a},cx=function(s,t,e){const r=s.indexOf(t);Gl(r);const i=s.indexOf(e);return Gl(i),Am(s,r,i+1)};function Gl(s){if(s===-1){const t="an extreme point is outside the hull.";throw new _l.default("PointNotFound",t)}}function Am(s,t,e){if(e>t)return s.slice(t,e);{const r=s.slice(t),i=s.slice(0,e);return r.concat(i)}}function vm(s){ux(s),dx(s)}function ux(s){const t=s.shift();if(!t)throw new Error("Unexpected");const e=t.x;let r=t.y;for(;s.length>0;){const i=s[0];if(i.x===e)r=Math.max(r,i.y),s.shift();else break}s.unshift({x:e,y:r})}function dx(s){const t=s.pop();if(!t)throw new Error("Unexpected");const e=t.x;let r=t.y;for(;s.length>0;){const i=s[s.length-1];if(i.x===e)r=Math.max(r,i.y),s.pop();else break}s.push({x:e,y:r})}var fx=Object.defineProperty,gx=(s,t,e)=>t in s?fx(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ri=(s,t,e)=>gx(s,typeof t!="symbol"?t+"":t,e);const Xl=.5;function Sm(s,t,e,r,i=!0){const a=new px(t,e,r,i);s.forEach(a.formatSlur,a)}class px{constructor(t,e,r,i=!0){Ri(this,"slur",null),Ri(this,"aboveBelowHull",null),Ri(this,"topHeights"),Ri(this,"bottomHeights"),Ri(this,"staffHeight"),Ri(this,"topPoints",null),Ri(this,"bottomPoints",null),Ri(this,"updateHeightsLists",!0),this.topHeights=t,this.bottomHeights=e,this.staffHeight=r,this.updateHeightsLists=i}formatSlur(t){this.setSlur(t);const e=this.getSlurPlacement(t),r=this.getHull();let i;if(e===xe.A.ABOVE)i=r.above;else if(e===xe.A.BELOW)i=r.below;else throw xe.A.raiseError(e);const a=mx(i,e);let l=ym(i,e),d=fm(i,l);for(;i.length>2&&!yx(d,i,a,e);)Ax(i,e),l=ym(i,e),d=fm(i,l);const f=i[0],m=i[i.length-1];t.setControlPoints(f,d.left,d.right,m);const S=t.getChildRoot(),w={entity:t,xPosition:S.getX(),yPosition:null};if(this.updateHeightsLists)if(e===xe.A.ABOVE)Dh(w,this.topHeights);else if(e===xe.A.BELOW)zo(w,this.bottomHeights,this.staffHeight);else throw xe.A.raiseError(e)}setSlur(t){this.slur=t,this.aboveBelowHull=null}getSlurPlacement(t){const e=t.leftAnchor;if(!e)throw new Error("Cannot get slur placement without left anchor");const r=e.getSlurData(),i=Ng.default.getPlacement(r);if(i!==xe.A.AUTO)return i;const a=e.getStemStrategy();if(zt.A.isUp(a))return xe.A.ABOVE;if(zt.A.isDown(a))return xe.A.BELOW;if(a!==zt.A.AUTO)throw zt.A.raiseError(a);const l=e.getStemDiraction();if(l===z.A.DOWN)return xe.A.ABOVE;if(l!==z.A.UP)throw z.A.raiseError(l);const d=this.getHull(),f=(0,hm.A)(d.above),m=(0,hm.A)(d.below);return f>m?xe.A.ABOVE:xe.A.BELOW}getSlur(){if(!this.slur)throw new Error("Slur not set");return this.slur}getHull(){if(this.aboveBelowHull===null){const t=this.getSlur(),e=t.getLeftX(),r=t.getRightX();let i=this.getTopPoints();i=lm(i,e,r),vm(i),i=i.map((w,x)=>{if(x===0||x===i.length-1){let D;if(x===0?D=t.leftAnchor:D=t.rightAnchor,!D)throw new Error("Unexpected");let L=-w.y-Xl;if(!D.isExternal){const M=D.note.getChildRoot().getBBox();if(!M)throw new Error("Unexpected");L=Math.min(L,M.minY-Xl)}return{x:w.x,y:L}}return{x:w.x,y:-w.y}});let a=this.getBottomPoints();a=lm(a,e,r),vm(a),a=a.map((w,x)=>{if(x===0||x===a.length-1){let D;if(x===0?D=t.leftAnchor:D=t.rightAnchor,!D)throw new Error("Unexpected");let L=this.staffHeight+w.y+Xl;if(!D.isExternal){const M=D.note.getChildRoot().getBBox();if(!M)throw new Error("Unexpected");L=Math.max(L,M.maxY+Xl)}return{x:w.x,y:L}}return{x:w.x,y:this.staffHeight+w.y}});const l=i[0],d=i[i.length-1],f=a[0],m=a[a.length-1];let S=[...i,...a];S=(0,jw.A)(S),this.aboveBelowHull=hx(S,l,d,f,m)}return this.aboveBelowHull}getTopPoints(){return this.topPoints===null&&(this.topPoints=this.topHeights.getShapePoints()),this.topPoints}getBottomPoints(){return this.bottomPoints===null&&(this.bottomPoints=this.bottomHeights.getShapePoints()),this.bottomPoints}}function mx(s,t){const e=s.map(r=>r.y);if(t===xe.A.ABOVE)return Math.min(...e);if(t===xe.A.BELOW)return Math.max(...e);throw xe.A.raiseError(t)}function yx(s,t,e,r){const i=t.length,a=t[0],l=t[i-1],d=[a,s.left,s.right,l],f=fe(d);if(r===xe.A.ABOVE)return f.minY<e;if(r===xe.A.BELOW)return f.maxY>e;throw xe.A.raiseError(r)}function Ax(s,t){const r=.5*vx(t);s.forEach(Sx,r)}function vx(s){if(s===xe.A.ABOVE)return-1;if(s===xe.A.BELOW)return 1;throw xe.A.raiseError(s)}function Sx(s,t,e){const r=e.length;if(t>0&&t<r-1){const i=this.valueOf();s.y+=i}}var wx=Object.defineProperty,xx=(s,t,e)=>t in s?wx(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ia=(s,t,e)=>xx(s,typeof t!="symbol"?t+"":t,e);function bx(s,t,e){const r=new Px(s,t);return r.process(e),r.getEntities()}class Px{constructor(t,e){Ia(this,"pageIdx",0),Ia(this,"isOngoing",!1),Ia(this,"request"),Ia(this,"scoreDrawer"),Ia(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){var e;const r=t.parts.find(M=>M.partData.uuid===this.request.partUuid);if(!r)return;const i=r.staves.find(M=>M.staffData.uuid===this.request.staffUuid);if(!i)return;const l=(e=[...r.partData.voiceUuidMapping.entries()].find(([M,H])=>H===this.request.voiceUuid))==null?void 0:e[0];if(!i.voiceSlurs.find(M=>M.voiceIdx===l))return;const f=t.slice,m=this.getLeftAnchor(f,i);if(m===null)return this.isOngoing;const S=this.getRightAnchor(f,i);if(S===null)return!this.isOngoing;if(m.xPos===S.xPos&&m.anchor.measure.measureUuid===S.anchor.measure.measureUuid)return;const x=this.scoreDrawer.drawingContext.createGroupNode(),D=rt(i.getChildRoot());x.setX(D.x),x.setY(D.y);const L=this.createSlur({staff:i,leftAnchor:m,rightAnchor:S});return v(x,L.getChildRoot()),Vt(x,this.request.color),this.cursorEntities.push({pageIdx:this.pageIdx,node:x}),!this.isOngoing}getLeftAnchor(t,e){if(this.isOngoing){const f=e.measures[0],m=this.getNoteDrawer(f,"first");if(!m)return null;const S={$type:nm.A.CONTINUE,$placement:this.request.placement},w=new Ti({slurData:S,measure:f,note:m,isExternal:!0,voiceUuid:this.request.voiceUuid});return Wl(w)}const r=this.getMeasureIdxFromUuid(t,this.request.startMeasureUuid);if(r===-1)return null;this.isOngoing=!0;const i=e.measures[r],a=this.getNoteDrawer(i,this.request.startNoteIdx);if(!a||a.isRest())return null;const l={$type:nm.A.START,$placement:this.request.placement},d=new Ti({slurData:l,measure:i,note:a,isExternal:!1,voiceUuid:this.request.voiceUuid});return Wl(d)}getRightAnchor(t,e){const r=this.getMeasureIdxFromUuid(t,this.request.stopMeasureUuid);if(r===-1){const d=e.measures[e.measures.length-1],f=this.getNoteDrawer(d,"last");if(!f)return null;const m=new Ti({slurData:null,measure:d,note:f,isExternal:!0,voiceUuid:this.request.voiceUuid});return Wl(m)}this.isOngoing=!1;const i=e.measures[r],a=this.getNoteDrawer(i,this.request.stopNoteIdx);if(!a||a.isRest())return null;const l=new Ti({slurData:null,measure:i,note:a,isExternal:!1,voiceUuid:this.request.voiceUuid});return Wl(l)}createSlur(t){const{staff:e,leftAnchor:r,rightAnchor:i}=t,a=this.scoreDrawer.drawingContext,l=new am(a,e.staffData);return l.setLeftAnchor(r.anchor),l.setRightAnchor(i.anchor),Sm([l],e.initialTopHeights,e.initialBottomHeights,e.getStaffHeight(),!1),l}getNoteDrawer(t,e){const r=Array.from(t.tickableContent.voices.values()).find(a=>a instanceof Bt?a.voiceUuid===this.request.voiceUuid:!1);return r?(e==="first"?e=0:e==="last"&&(e=r.notes.length-1),r.getNote(e)):null}getMeasureIdxFromUuid(t,e){return t.measures.findIndex(i=>i.rawGlobalMeasure.measureUuid===e)}getEntities(){return this.cursorEntities}}function Wl(s){const t=s.getPosition();return{anchor:s,xPos:t}}var Ex=Object.defineProperty,Dx=(s,t,e)=>t in s?Ex(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,zl=(s,t,e)=>Dx(s,typeof t!="symbol"?t+"":t,e);const Cx=1.2,wm=1.5,Tx=Cx*wm;function Fa(s){return s*wm}const Rx=[[k.Z.MOVE_TO,...[0,1].map(Fa)],[k.Z.CUBIC_CURVE_TO,0,...[1.33,.27,1.6,.6,1.6].map(Fa)],[k.Z.REFLECT_CUBIC_CURVE_TO,...[1.2,1.33,1.2,1].map(Fa)],[k.Z.REFLECT_CUBIC_CURVE_TO,...[.6,0,.6,0].map(Fa)],[k.Z.REFLECT_CUBIC_CURVE_TO,...[0,.67,0,1].map(Fa)],[k.Z.CLOSE_PATH]],Nx=1;function Lx(s,t,e){const r=new Mx(s,t);r.process(e);const i=r.getEntities();return t.setTearDropCursorEntities(i),i}class Mx{constructor(t,e){zl(this,"pageIdx",0),zl(this,"request"),zl(this,"scoreDrawer"),zl(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const r=t.slice.measures.findIndex(M=>M.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r===-1)return;const i=t.parts.find(M=>M.partData.uuid===this.request.partUuid);if(!i)return;const a=i.staves.find(M=>M.staffData.uuid===this.request.staffUuid&&M.staffData.type===this.request.staffType);if(!a)return;const l=a.measures[r],d=Array.from(l.tickableContent.voices.values()).find(M=>M instanceof Bt?M.voiceUuid===this.request.voiceUuid:!1);if(!d)return;let f;if(this.request.graceIdx!==null){const M=d.gracesMap.get(this.request.noteIdx);if(!M)return;f=M[this.request.graceIdx]}else f=d.notes[this.request.noteIdx];if(!f)return;const m=f.getChildRoot(),S=rt(m),w=Ox(f),x=f.getMiddleHeadWidth()/2-Tx/2,L=this.scoreDrawer.drawingContext.createPathNode(Rx);return L.setX(S.x+x),L.setY(S.y+w+Nx),L.setColor(this.request.color),L.setMixBlendMode("darken"),L.setLabel("cursor-teardrop"),this.cursorEntities.push({pageIdx:this.pageIdx,node:L}),!0}getEntities(){return this.cursorEntities}}function Ox(s){let t=(0,Ft.o5)(s.staffData);return s.staffData.type===Zt.A.GUITAR_TAB||(t=Array.from(s.getHeads().values()).reduce((e,r)=>{const i=r.getBBox();if(i===null)return e;const a=i.maxY;return Math.max(e,a)},t)),t}var Zr=b(909748),Bx=Object.defineProperty,Ix=(s,t,e)=>t in s?Bx(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Lg=(s,t,e)=>Ix(s,typeof t!="symbol"?t+"":t,e);const Fx=new Map([[Zr.A.ACCELERANDO,"accel"],[Zr.A.RITARDANDO,"rit."]]);class Ux{constructor(t,{type:e}){Lg(this,"textNode"),Lg(this,"drawingContext"),Lg(this,"type"),this.drawingContext=t,this.type=e;const r=t.getTempoChangeFontOptions(),i=Fx.get(e);if(!i)throw new Error("Unexpected");this.textNode=t.createTextNode(i,r)}getChildRoot(){return this.textNode}}var Hx=Object.defineProperty,_x=(s,t,e)=>t in s?Hx(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,jr=(s,t,e)=>_x(s,typeof t!="symbol"?t+"":t,e);class xm{constructor(t,{type:e}){jr(this,"drawingContext"),jr(this,"textChild",null),jr(this,"rangeLine",null),jr(this,"leftAnchor",null),jr(this,"rightAnchor",null),jr(this,"x1",null),jr(this,"x2",null),jr(this,"type"),jr(this,"groupNode"),this.drawingContext=t,this.type=e,this.groupNode=this.drawingContext.createGroupNode(),this.type!==Zr.A.CONTINUE&&(this.textChild=new Ux(t,{type:e}),v(this.groupNode,this.textChild.getChildRoot()))}fillEventPayload(){const t=this.getUuid();if(t===null)return;const e={entityType:T.A.TEMPO_CHANGE,type:this.type,uuid:t};this.groupNode.setEventPayload(e)}getChildRoot(){return this.groupNode}getUuid(){var t,e;return(e=(t=this.leftAnchor)==null?void 0:t.getUuid())!=null?e:null}getHeight(){return this.textChild===null?this.drawingContext.getTempoChangeThickness():this.textChild.getChildRoot().getFontSize()}isAbove(){return!0}isBelow(){return!1}isContinueStop(){return this.hasRightAnchor()&&this.rightAnchor.isContinue()}drawLines(){this.destroyLines(),this.rangeLine=this.drawRangeLine(),v(this.groupNode,this.rangeLine)}destroyLines(){this.rangeLine&&(it(this.groupNode,this.rangeLine),this.rangeLine.destroy(),this.rangeLine=null)}drawRangeLine(){const t=this.drawingContext.createDashedLineNode();return t.setWidth(this.drawingContext.getTempoChangeThickness()),t.setY(this.getRangeLineY()),t.setX(this.getRangeLineXOffset()),t}getRangeLineXOffset(){return this.textChild===null?0:this.textChild.getChildRoot().getWidth()+this.drawingContext.getTempoChangeTextMargin()}getRangeLineY(){return 0}setX1(t){this.x1=t,this.groupNode.setX(t),this.updateAfterDimensionsChange()}setX2(t){this.x2=t,this.updateAfterDimensionsChange()}updateAfterDimensionsChange(){if(this.x1===null||this.x2===null)return;const t=this.isContinueStop()?0:this.drawingContext.getMarginSize(),e=this.x2-this.x1-this.getRangeLineXOffset()-t,r=this.x2-this.x1-t;this.textChild===null||r-this.textChild.getChildRoot().getWidth()>t?(this.drawLines(),this.rangeLine.setX2(e)):this.destroyLines()}erase(){this.hasLeftAnchor()&&this.removeLeftAnchor(),this.hasRightAnchor()&&this.removeRightAnchor()}setLeftAnchor(t){this.hasLeftAnchor()&&this.leftAnchor!==t&&this.removeLeftAnchor(),this.leftAnchor=t,this.leftAnchor.setTempoChange(this)}hasLeftAnchor(){return this.leftAnchor!==null}removeLeftAnchor(){this.hasLeftAnchor()&&(this.leftAnchor.tempoChange=null,this.leftAnchor=null)}setRightAnchor(t){this.hasRightAnchor()&&this.rightAnchor!==t&&this.removeRightAnchor(),this.rightAnchor=t,this.rightAnchor.setTempoChange(this)}hasRightAnchor(){return this.rightAnchor!==null}removeRightAnchor(){this.hasRightAnchor()&&(this.rightAnchor.tempoChange=null,this.rightAnchor=null)}}var Ua=b(332573),Gx=Object.defineProperty,Xx=(s,t,e)=>t in s?Gx(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,cn=(s,t,e)=>Xx(s,typeof t!="symbol"?t+"":t,e);class un{constructor({type:t,placement:e,timePos:r,dpq:i,location:a,tempoChangeUuid:l}){cn(this,"type"),cn(this,"placement"),cn(this,"timePos"),cn(this,"dpq"),cn(this,"location"),cn(this,"tempoChangeUuid"),cn(this,"tempoChange",null),this.type=t,this.placement=e,this.timePos=r,this.dpq=i,this.location=a,this.tempoChangeUuid=l}getTimePos(){return this.timePos}getUuid(){return this.tempoChangeUuid}getDpq(){return this.dpq}hasTempoChange(){return this.tempoChange!==null}setTempoChange(t){this.tempoChange=t}getTempoChange(){return this.tempoChange}getRangeEntity(){return this.tempoChange}isStart(){return Zr.A.isStart(this.type)}isStop(){return Zr.A.isStop(this.type)}isContinue(){return this.type===Zr.A.CONTINUE}isAbove(){return!0}isBelow(){return!1}hasLocation(){return this.location!==null}isLeft(){return this.hasLocation()?Ua.A.isLeft(this.location):this.isStart()}isRight(){return this.hasLocation()?Ua.A.isRight(this.location):this.isStop()}removeTempoChange(){if(!this.hasTempoChange())return;const t=this.tempoChange;if(this.location!==null)Ua.A.isLeft(this.location)?t.removeLeftAnchor():Ua.A.isRight(this.location)?t.removeRightAnchor():Ua.A.raiseError(this.location);else if(this.isStart())t.removeLeftAnchor();else if(this.isStop())t.removeRightAnchor();else throw new Error("Unexpected");this.tempoChange=null}}var Wx=Object.defineProperty,zx=(s,t,e)=>t in s?Wx(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ha=(s,t,e)=>zx(s,typeof t!="symbol"?t+"":t,e);function Yx(s,t,e){const r=new kx(s,t);return r.process(e),r.getEntities()}class kx{constructor(t,e){Ha(this,"pageIdx",0),Ha(this,"isOngoing",!1),Ha(this,"request"),Ha(this,"scoreDrawer"),Ha(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.MEASURES_HEADER))return;this.pageIdx=N.A.MEASURES_HEADER;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const e=t.slice,r=e.globalStaff,i=this.getLeftAnchor(e);if(i===null)return this.isOngoing;const a=this.getRightAnchor(e);if(a===null)return!this.isOngoing;const d=this.scoreDrawer.drawingContext.createGroupNode(),f=rt(r.getChildRoot());d.setX(f.x),d.setY(f.y);const m=this.createTempoChange({staff:r,leftAnchor:i,rightAnchor:a});return v(d,m.getChildRoot()),Vt(d,this.request.color),this.cursorEntities.push({pageIdx:this.pageIdx,node:d}),!this.isOngoing}getLeftAnchor(t){const e=t.globalStaff;if(this.isOngoing){const M=e.measures[0],{tickableContent:H}=M,{horizontalFormatter:$}=H;if($===null)throw new Error("Formatter is null");const lt="left",gt=this.request.value,yt=0,dt=this.request.startDpq,At="",Jt=new un({type:gt,placement:Ee.A.ABOVE,location:lt,timePos:yt,dpq:dt,tempoChangeUuid:At});return Yl(Jt,M,$,null)}const r=t.measures.findIndex(M=>M.rawGlobalMeasure.measureUuid===this.request.startMeasureUuid);if(r===-1)return null;this.isOngoing=!0;const i=e.measures[r],{tickableContent:a}=i,l=a.horizontalFormatter;if(l===null)throw new Error("Formatter is null");const d=l.getDpq(),f=Dt.default.lcm(d,this.request.startDpq),m=this.request.startTimePos*f/this.request.startDpq,S=l.getNbDivisions()*f/d;if(m<0||m>=S)return null;const w="left",x=this.request.value,D="",L=new un({type:x,placement:Ee.A.ABOVE,location:w,timePos:m,dpq:f,tempoChangeUuid:D});return Yl(L,i,l,f)}getRightAnchor(t){const e=t.globalStaff,r=t.measures.findIndex(M=>M.rawGlobalMeasure.measureUuid===this.request.stopMeasureUuid);if(r===-1){const M=e.measures[e.measures.length-1],{tickableContent:H}=M,{horizontalFormatter:$}=H;if($===null)throw new Error("Formatter is null");const lt=$.getNbDivisions(),gt="right",yt=Zr.A.CONTINUE,dt="",At=new un({type:yt,placement:Ee.A.ABOVE,location:gt,timePos:lt,dpq:this.request.stopDpq,tempoChangeUuid:dt});return Yl(At,M,$,null)}this.isOngoing=!1;const i=e.measures[r],{tickableContent:a}=i,l=a.horizontalFormatter;if(l===null)throw new Error("Formatter is null");const d=l.getDpq(),f=Dt.default.lcm(d,this.request.stopDpq),m=this.request.stopTimePos*f/this.request.stopDpq,S=l.getNbDivisions()*f/d;if(m<0||m>S)return null;const w="right",x=Zr.A.STOP,D="",L=new un({type:x,placement:Ee.A.ABOVE,location:w,timePos:m,dpq:f,tempoChangeUuid:D});return Yl(L,i,l,f)}createTempoChange(t){const{staff:e,leftAnchor:r,rightAnchor:i}=t,a=this.scoreDrawer.drawingContext,l=new xm(a,{type:this.request.value});return l.setLeftAnchor(r.anchor),l.setRightAnchor(i.anchor),l.setX1(r.xPos),l.setX2(i.xPos),qs([{entity:l,xPosition:l.getChildRoot().getX(),yPosition:null}],e.topHeights,a,!1),l}getEntities(){return this.cursorEntities}}function Yl(s,t,e,r){const{tickableContent:i}=t,a=t.getChildRoot().getX(),l=i.getChildRoot().getX(),d=s.getTimePos();r===null&&(r=e.getDpq());const f=a+l+e.getPosX(d,r);return{anchor:s,xPos:f}}var ti=b(574626),qx=Object.defineProperty,Vx=(s,t,e)=>t in s?qx(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Or=(s,t,e)=>Vx(s,typeof t!="symbol"?t+"":t,e);class bm{constructor(t,{type:e,placement:r}){Or(this,"drawingContext"),Or(this,"leftAnchor",null),Or(this,"rightAnchor",null),Or(this,"topLine",null),Or(this,"bottomLine",null),Or(this,"type"),Or(this,"placement"),Or(this,"x1",null),Or(this,"x2",null),Or(this,"groupNode"),this.drawingContext=t,this.groupNode=this.drawingContext.createGroupNode(),this.type=e,this.placement=r}fillEventPayload(){const t=this.getUuid();if(t===null)return;const e={entityType:T.A.WEDGE,uuid:t};this.groupNode.setEventPayload(e)}getChildRoot(){return this.groupNode}isAbove(){return this.placement===Ee.A.ABOVE}isBelow(){return this.placement===Ee.A.BELOW}isContinueStop(){return this.hasRightAnchor()&&this.rightAnchor.isContinueStop()}isContinueStart(){return this.hasLeftAnchor()&&this.leftAnchor.isContinueStart()}getUuid(){var t,e;return(e=(t=this.leftAnchor)==null?void 0:t.getUuid())!=null?e:null}drawLines(){if(this.leftAnchor===null||this.rightAnchor===null||this.x1===null||this.x2===null)return;const t=this.isContinueStart()?0:this.drawingContext.getMarginSize(),e=this.leftAnchor,r=t,i=this.spreadTypeToY(e.getSpreadType()),a=this.isContinueStop()?0:this.drawingContext.getMarginSize(),l=this.rightAnchor,d=this.x2-this.x1-a*2,f=this.spreadTypeToY(l.getSpreadType()),m=this.drawingContext.getHairpinThickness();this.topLine=this.drawLine(m,r,d,this.getYForLine("top",i),this.getYForLine("top",f)),this.bottomLine=this.drawLine(m,r,d,this.getYForLine("bottom",i),this.getYForLine("bottom",f))}drawLine(t,e,r,i,a){const l=this.drawingContext.createLineNode();return l.setWidth(t),l.setX(e),l.setX2(r),l.setY(i+this.getVerticalOffset()),l.setY2(a-i),v(this.groupNode,l),l}getYForLine(t,e){if(e===0)return 0;if(t==="top")return-e;if(t==="bottom")return e;throw new Error(`Expected linePosition [${t}] to be 'top' | 'bottom'`)}spreadTypeToY(t){if(t===ti.A.OPEN)return this.drawingContext.getHairpinOpenSpread();if(t===ti.A.OPEN_CONTINUE)return this.drawingContext.getHairpinOpenContinueSpread();if(t===ti.A.CLOSED)return this.drawingContext.getHairpinCloseSpread();if(t===ti.A.CLOSED_CONTINUE)return this.drawingContext.getHairpinCloseContinueSpread();throw ti.A.raiseError(t)}getVerticalOffset(){return-this.drawingContext.getMarginSize()}destroyLines(){this.topLine!==null&&(it(this.groupNode,this.topLine),this.topLine.destroy(),this.topLine=null),this.bottomLine!==null&&(it(this.groupNode,this.bottomLine),this.bottomLine.destroy(),this.bottomLine=null)}setX1(t){var e;const r=this.hasLeftAnchor()?(e=this.leftAnchor)==null?void 0:e.horizontalOffset:0;this.x1=t+r,this.groupNode.setX(t),this.updateAfterDimensionsChange()}setX2(t){const e=this.hasRightAnchor()?this.rightAnchor.horizontalOffset:0;this.x2=t+e,this.updateAfterDimensionsChange()}updateAfterDimensionsChange(){this.destroyLines(),!(this.x1===null||this.x2===null)&&this.drawLines()}erase(){this.hasLeftAnchor()&&this.removeLeftAnchor(),this.hasRightAnchor()&&this.removeRightAnchor()}setLeftAnchor(t){this.hasLeftAnchor()&&this.leftAnchor!==t&&this.removeLeftAnchor(),this.leftAnchor=t,this.leftAnchor.setWedge(this)}hasLeftAnchor(){return this.leftAnchor!==null}removeLeftAnchor(){this.hasLeftAnchor()&&(this.leftAnchor.wedge=null,this.leftAnchor=null)}removeRightAnchor(){this.hasRightAnchor()&&(this.rightAnchor.wedge=null,this.rightAnchor=null)}setRightAnchor(t){this.hasRightAnchor()&&this.rightAnchor!==t&&this.removeRightAnchor(),this.rightAnchor=t,this.rightAnchor.setWedge(this)}hasRightAnchor(){return this.rightAnchor!==null}}var je=b(612040),Ni=b(995677),Qx=Object.defineProperty,Kx=(s,t,e)=>t in s?Qx(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,dn=(s,t,e)=>Kx(s,typeof t!="symbol"?t+"":t,e);class fn{constructor({timePos:t,type:e,wedgeUuid:r,location:i,placement:a}){dn(this,"type"),dn(this,"location"),dn(this,"placement"),dn(this,"timePos"),dn(this,"wedgeUuid"),dn(this,"wedge",null),dn(this,"horizontalOffset",0),this.type=e,this.location=i,this.placement=a,this.timePos=t,this.wedgeUuid=r}getUuid(){return this.wedgeUuid}getTimePos(){return this.timePos}hasWedge(){return this.wedge!==null}setWedge(t){this.wedge=t}getWedge(){return this.wedge}getRangeEntity(){return this.wedge}isStart(){return this.isLeft()}isStop(){return this.isRight()}isContinue(){return this.isContinueStart()||this.isContinueStop()}isContinueStart(){return this.location===je.A.LEFT_CONTINUE}isContinueStop(){return this.location===je.A.RIGHT_CONTINUE}isLeft(){return je.A.isLeft(this.location)}isRight(){return je.A.isRight(this.location)}isAbove(){return this.placement===Ee.A.ABOVE}isBelow(){return this.placement===Ee.A.BELOW}getSpreadType(){if(this.isSpreadOpen())return ti.A.OPEN;if(this.isSpreadOpenContinue())return ti.A.OPEN_CONTINUE;if(this.isSpreadClose())return ti.A.CLOSED;if(this.isSpreadCloseContinue())return ti.A.CLOSED_CONTINUE;throw new Error(`The combination of the wedge location [${this.location}] and the type [${this.type}] is unexpected.`)}isSpreadOpen(){return this.location===je.A.LEFT&&this.type===Ni.A.DIMINUENDO||this.location===je.A.RIGHT&&this.type===Ni.A.CRESCENDO}isSpreadOpenContinue(){return this.location===je.A.LEFT_CONTINUE&&this.type===Ni.A.DIMINUENDO||this.location===je.A.RIGHT_CONTINUE&&this.type===Ni.A.CRESCENDO}isSpreadClose(){return this.location===je.A.LEFT&&this.type===Ni.A.CRESCENDO||this.location===je.A.RIGHT&&this.type===Ni.A.DIMINUENDO}isSpreadCloseContinue(){return this.location===je.A.LEFT_CONTINUE&&this.type===Ni.A.CRESCENDO||this.location===je.A.RIGHT_CONTINUE&&this.type===Ni.A.DIMINUENDO}removeWedge(){if(!this.hasWedge())return;const t=this.wedge;if(this.location!==null)je.A.isLeft(this.location)?t.removeLeftAnchor():je.A.isRight(this.location)?t.removeRightAnchor():je.A.raiseError(this.location);else if(this.isStart())t.removeLeftAnchor();else if(this.isStop())t.removeRightAnchor();else throw new Error("Unexpected");this.wedge=null}getHorizontalPosition(){if(this.isLeft())return Yo.A.WEDGE_START;if(this.isRight())return Yo.A.WEDGE_STOP;throw new Error("Unexpected")}getSpaceBefore(){return 0}getWidth(){return 0}setHorizontalOffset(t){this.horizontalOffset=t}}var Jx=Object.defineProperty,$x=(s,t,e)=>t in s?Jx(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,_a=(s,t,e)=>$x(s,typeof t!="symbol"?t+"":t,e);function Zx(s,t,e){const r=new jx(s,t);return r.process(e),r.getEntities()}class jx{constructor(t,e){_a(this,"pageIdx",0),_a(this,"isOngoing",!1),_a(this,"request"),_a(this,"scoreDrawer"),_a(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const e=t.parts.find(w=>w.partData.uuid===this.request.partUuid);if(!e)return;const r=e.staves.find(w=>w.staffData.uuid===this.request.staffUuid);if(!r)return;const i=t.slice,a=this.getLeftAnchor(i,r);if(a===null)return this.isOngoing;const l=this.getRightAnchor(i,r);if(l===null)return!this.isOngoing;const f=this.scoreDrawer.drawingContext.createGroupNode(),m=rt(r.getChildRoot());f.setX(m.x),f.setY(m.y);const S=this.createWedge({staff:r,leftAnchor:a,rightAnchor:l});return v(f,S.getChildRoot()),Vt(f,this.request.color),this.cursorEntities.push({pageIdx:this.pageIdx,node:f}),!this.isOngoing}getLeftAnchor(t,e){if(this.isOngoing){const H=e.measures[0],{tickableContent:$}=H,{horizontalFormatter:lt}=$;if(lt===null)throw new Error("Formatter is null");const gt=this.request.placement,yt="left-continue",dt=this.request.value,At=0,Jt="",re=new fn({type:dt,placement:gt,location:yt,timePos:At,wedgeUuid:Jt});return kl(re,H,lt,null)}const r=t.measures.findIndex(H=>H.rawGlobalMeasure.measureUuid===this.request.startMeasureUuid);if(r===-1)return null;this.isOngoing=!0;const i=e.measures[r],{tickableContent:a}=i,l=a.horizontalFormatter;if(l===null)throw new Error("Formatter is null");const d=l.getDpq(),f=Dt.default.lcm(d,this.request.startDpq),m=this.request.startTimePos*f/this.request.startDpq,S=l.getNbDivisions()*f/d;if(m<0||m>=S)return null;const w=this.request.placement,x="left",D=this.request.value,L="",M=new fn({type:D,placement:w,location:x,timePos:m,wedgeUuid:L});return kl(M,i,l,f)}getRightAnchor(t,e){const r=t.measures.findIndex(H=>H.rawGlobalMeasure.measureUuid===this.request.stopMeasureUuid);if(r===-1){const H=e.measures[e.measures.length-1],{tickableContent:$}=H,{horizontalFormatter:lt}=$;if(lt===null)throw new Error("Formatter is null");const gt=lt.getNbDivisions(),yt=this.request.placement,dt="right-continue",At=this.request.value,Jt="",re=new fn({type:At,placement:yt,location:dt,timePos:gt,wedgeUuid:Jt});return kl(re,H,lt,null)}this.isOngoing=!1;const i=e.measures[r],{tickableContent:a}=i,l=a.horizontalFormatter;if(l===null)throw new Error("Formatter is null");const d=l.getDpq(),f=Dt.default.lcm(d,this.request.stopDpq),m=this.request.stopTimePos*f/this.request.stopDpq,S=l.getNbDivisions()*f/d;if(m<0||m>S)return null;const w=this.request.placement,x="right",D=this.request.value,L="",M=new fn({type:D,placement:w,location:x,timePos:m,wedgeUuid:L});return kl(M,i,l,f)}createWedge(t){const{staff:e,leftAnchor:r,rightAnchor:i}=t,a=this.scoreDrawer.drawingContext,l=new bm(a,{type:this.request.value,placement:this.request.placement});l.setLeftAnchor(r.anchor),l.setRightAnchor(i.anchor),l.setX1(r.xPos),l.setX2(i.xPos);const{placement:d}=this.request;if(d===I.A.ABOVE){let f=e.wedges.rangeChildren.find(m=>m.isAbove());if(f||(f=tb(e)),f){const m=f.getChildRoot().getY();l.getChildRoot().setY(m)}else qs([{entity:l,xPosition:l.getChildRoot().getX(),yPosition:null}],e.initialTopHeights,a,!1)}else if(d===I.A.BELOW){let f=e.wedges.rangeChildren.find(m=>m.isBelow());if(f||(f=eb(e)),f){const m=f.getChildRoot().getY();l.getChildRoot().setY(m)}else{const m=(0,Ft.o5)(e.staffData);kr([{entity:l,xPosition:l.getChildRoot().getX(),yPosition:null}],e.initialBottomHeights,m,a,!1)}}else throw I.A.raiseError(d);return l}getEntities(){return this.cursorEntities}}function kl(s,t,e,r){const{tickableContent:i}=t,a=t.getChildRoot().getX(),l=i.getChildRoot().getX(),d=s.getTimePos();r===null&&(r=e.getDpq());const f=a+l+e.getPosX(d,r);return{anchor:s,xPos:f}}function tb(s){for(const t of s.measures){const{tickableContent:e}=t,{dynamicsAbove:r}=e;if(r.length>0)return r[0]}return null}function eb(s){for(const t of s.measures){const{tickableContent:e}=t,{dynamicsBelow:r}=e;if(r.length>0)return r[0]}return null}function sb(s,t,e){const r=s.type;switch(r){case T.A.NOTE:return QS(s,t,e);case T.A.DYNAMICS:return sd(s,t,e);case T.A.PIZZICATO:return xw(s,t,e);case T.A.MUTE:return BS(s,t,e);case T.A.WEDGE:return Zx(s,t,e);case T.A.OCTAVE_SHIFT:return ow(s,t,e);case T.A.PIANO_PEDAL:return pw(s,t,e);case T.A.PLUCKED_RANGE:return Bw(s,t,e);case T.A.TEMPO_CHANGE:return Yx(s,t,e);case T.A.SLUR:return bx(s,t,e);case T.A.RANGE_SELECTION:return Hw(s,t,e);case T.A.ANCHOR:return Ar(s,t,e);case T.A.TEARDROP_CURSOR:return Lx(s,t,e);case T.A.PLAYBACK_SLIDER:return zw(s,t,e);case T.A.MEASURE_OUTLINE:return ES(s,t,e);case T.A.INSERT_CURSOR:return vS(s,t,e);default:throw new Error(`Unsupported entity type: ${r}`)}}function de(s,t){if(t instanceof ye){if(t.angle!==null)throw new Error("Angle is not supported for cloning nodes");if(t.scalingX!==1||t.scalingY!==1)throw new Error("Scaling is not supported for cloning nodes");const e=s.createGroupNode();return t.children.forEach(r=>{if(r.noClone)return;const i=de(s,r),a=r.getX();i.setX(a);const l=r.getY();i.setY(l),v(e,i)}),e}else if(t instanceof oe){const e=t.glyph.id,r=t.glyph.size,i=s.createGlyphNode(e,r);return t.color!=="black"&&i.setColor(t.color),t.width!==0&&i.setWidth(t.width),t.strokeColor!=="black"&&i.setStrokeColor(t.strokeColor),t.fillRule!=="nonzero"&&i.setFillRule(t.fillRule),i}else if(t instanceof Hi){const e=s.createLineNode();return e.setX2(t.x2),e.setY2(t.y2),e.setWidth(t.width),e.setStrokeColor(t.color),e}else if(t instanceof Yr||t instanceof he||t instanceof we){const e=t.getPath();return s.createPathNode(e)}else if(t instanceof mr){const e=s.createTextNode(t.text,t.options);return e.setShadowText(t.shadowText),e.setColor(t.color),e}else throw new Error(`Unsupported node type: ${t.constructor.name}`)}var rb=Object.defineProperty,ib=(s,t,e)=>t in s?rb(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,ql=(s,t,e)=>ib(s,typeof t!="symbol"?t+"":t,e);function nb(s,t,e){const r=new ob(s,t);return r.process(e),r.getEntities()}class ob{constructor(t,e){ql(this,"pageIdx",0),ql(this,"request"),ql(this,"scoreDrawer"),ql(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.MEASURES_HEADER))return;this.pageIdx=N.A.MEASURES_HEADER;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const e=t.slice,r=e.measures.findIndex(l=>l.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r===-1)return;const a=e.globalStaff.measures[r];a.barlineRepeatNbTimes!==null&&this.createEntity(a.barlineRepeatNbTimes.getChildRoot())}createEntity(t){const e=this.scoreDrawer.drawingContext,r=rt(t),i=de(e,t);Vt(i,this.request.color),i.setX(r.x),i.setY(r.y),this.cursorEntities.push({node:i,pageIdx:this.pageIdx})}getEntities(){return this.cursorEntities}}var rr=b(721247);function Pm(s,t){return(t.nbStaffLines-s)*t.spaceSize}const ab={C:"cClef",F:"fClef",G:"gClef",percussion:"unpitchedPercussionClef1",TAB:"6stringTabClef"},hb="6stringTabClef",lb="4stringTabClef",cb="15ma",ub="8va",db="15mb",fb="8vb";function gb(s,t){if(rr.default.isTab(s))return t.nbStaffLines<=4?lb:hb;const e=rr.default.getSign(s),r=ab[e],i=pb(s);return r+i}function pb(s){if(rr.default.isPercussion(s))return"";const t=rr.default.getOctaveChange(s);if(t===0)return"";const e=rr.default.getSign(s);return t===1&&(e==="G"||e==="F")?ub:t===2&&(e==="G"||e==="F")?cb:t===-1&&(e==="G"||e==="F"||e==="C")?fb:t===-2&&(e==="G"||e==="F")?db:""}var mb=Object.defineProperty,yb=(s,t,e)=>t in s?mb(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,gn=(s,t,e)=>yb(s,typeof t!="symbol"?t+"":t,e);const Ab="clef";class Li{constructor(t,e,r){gn(this,"drawingContext"),gn(this,"glyphNode"),gn(this,"timePos"),gn(this,"uuid",null),gn(this,"clefJson"),gn(this,"staffData"),gn(this,"contentAfter",0),this.drawingContext=t,this.clefJson=e;const i=gb(e,r);this.glyphNode=t.createGlyphNode(i),this.glyphNode.setLabel(Ab),this.staffData=r;const a=vb(e,r);this.glyphNode.setY(a),this.timePos=null}setX(t){this.glyphNode.setX(t-this.contentAfter)}setTimePos(t){this.timePos=t}getHorizontalData(){const t=this.getWidth(),e=this.getTimePos();return{spaceBefore:0,spaceAfter:t,timePos:e,isRest:!1,duration:0}}getTimePos(){if(this.timePos===null)throw new Error("Clef time pos is null");return this.timePos}getDrawingContext(){return this.drawingContext}setUuid(t){this.uuid=t}getUuid(){return this.uuid}setContentAfter(t){this.contentAfter=t}getChildRoot(){return this.glyphNode}getWidth(){return this.glyphNode.getWidth()}getHeight(){return this.glyphNode.getHeight()}getSpaceAboveStaff(){const t=-(this.glyphNode.getMinY()+this.glyphNode.getY());return Math.max(0,t)}getSpaceBelowStaff(){const t=(0,Ft.o5)(this.staffData);this.staffData.spaceSize*(this.staffData.nbStaffLines-1);const e=this.glyphNode.getY()+this.glyphNode.getMaxY()-t;return Math.max(0,e)}fillEventPayload(t=null){const e={entityType:T.A.CLEF,uuid:this.uuid,clefData:this.clefJson,side:t};this.glyphNode.setEventPayload(e)}}function vb(s,t){if(t.type===Zt.A.GUITAR_TAB)return(0,Ft.o5)(t)/2;const e=rr.default.getDisplayLine(s);return Pm(e,t)}var Sb=Object.defineProperty,wb=(s,t,e)=>t in s?Sb(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Vl=(s,t,e)=>wb(s,typeof t!="symbol"?t+"":t,e);const xb=3,bb=.4,Pb="#FFFFFF";function Eb(s,t,e){const r=new Db(s,t);return r.process(e),r.getEntities()}class Db{constructor(t,e){Vl(this,"pageIdx",0),Vl(this,"request"),Vl(this,"scoreDrawer"),Vl(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if("firstOfType"in this.request&&this.request.firstOfType)return this.processFirstOfType();if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){if(!("entityUuid"in this.request&&this.request.entityUuid))return;const{entityUuid:e,measureUuid:r,partUuid:i,staffUuid:a}=this.request;if(e)return this.processMidMeasureClef(t);const l=t.slice,d=l.measures.findIndex(x=>x.rawGlobalMeasure.measureUuid===r||x.rawGlobalMeasure.nextMeasureUuid===r);if(d===-1)return;const f=t.parts.find(x=>x.partData.uuid===i);if(!f)return;const m=f.staves.find(x=>x.staffData.uuid===a);if(!m)return;const S=l.measures[d],w=m.measures[d];if(S.rawGlobalMeasure.measureUuid===r){if(w.leftAttributes===null)return;const x=w.leftAttributes,D=Mg(x);return D?(this.request.drawHalo&&this.createHalo(D.getChildRoot()),this.createEntity(D.getChildRoot()),!0):void 0}if(S.rawGlobalMeasure.nextMeasureUuid===r){if(w.rightInternalAttributes===null)return;const x=w.rightInternalAttributes,D=Mg(x);if(!D)return;this.request.drawHalo&&this.createHalo(D.getChildRoot()),this.createEntity(D.getChildRoot())}}processMidMeasureClef(t){if(!("entityUuid"in this.request&&this.request.entityUuid))return;const{entityUuid:e,measureUuid:r,partUuid:i,staffUuid:a}=this.request,d=t.slice.measures.findIndex(x=>x.rawGlobalMeasure.measureUuid===r);if(d===-1)return;const f=t.parts.find(x=>x.partData.uuid===i);if(!f)return;const m=f.staves.find(x=>x.staffData.uuid===a);if(!m)return;const{tickableContent:S}=m.measures[d],w=S.middleClefs.find(x=>x.getUuid()===e);if(w)return this.request.drawHalo&&this.createHalo(w.getChildRoot()),this.createEntity(w.getChildRoot()),!0}processFirstOfType(){const a=this.scoreDrawer.getFirstSystem().parts[0].staves[0].measures[0].leftAttributes;if(a===null)return;const l=Mg(a);l&&(this.request.drawHalo&&this.createHalo(l.getChildRoot()),this.createEntity(l.getChildRoot()))}createEntity(t){const e=this.scoreDrawer.drawingContext,r=rt(t),i=de(e,t);Vt(i,this.request.color),i.setX(r.x),i.setY(r.y),this.cursorEntities.push({node:i,pageIdx:this.pageIdx})}createHalo(t){const e=this.scoreDrawer.drawingContext,r=rt(t),i=t.getBBox(),a=i?(i.maxX-i.minX)/2:0,l=xb,d=i?-((i.maxY-i.minY)/2)+l:0,f=e.createCircleNode(l);f.setColor(Pb),f.setBlur(bb),f.setX(r.x+a),f.setY(r.y+d),this.cursorEntities.push({node:f,pageIdx:this.pageIdx})}getEntities(){return this.cursorEntities}}function Mg(s){return s.children.find(t=>t instanceof Li)||null}var Xs=b(193272),Cb=Object.defineProperty,Tb=(s,t,e)=>t in s?Cb(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ql=(s,t,e)=>Tb(s,typeof t!="symbol"?t+"":t,e);function Rb(s,t,e){const r=new Nb(s,t);return r.process(e),r.getEntities()}class Nb{constructor(t,e){Ql(this,"pageIdx",0),Ql(this,"request"),Ql(this,"scoreDrawer"),Ql(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel||t.forEach(this.processPageIndex,this)}processPageIndex(t){this.pageIdx=t;const e=this.scoreDrawer.pages[t],r=this.getCreditNode(e);r&&this.createEntity(r)}getCreditNode(t){if("firstOfType"in this.request)return t.header?t.header.title:null;const e="creditType"in this.request&&this.request.creditType;if(!e)return null;if(e===Xs.A.RIGHTS){const{footer:i}=t;return!i||i.rightsLines.length===0?null:i.getChildRoot()}const{header:r}=t;return r?e===Xs.A.TITLE?r.title:e===Xs.A.SUBTITLE?r.subtitle:e===Xs.A.COMPOSER?r.composer:e===Xs.A.LYRICIST?r.lyricist:e===Xs.A.ARRANGER?r.arranger:null:null}createEntity(t){const e=this.scoreDrawer.drawingContext,r=rt(t),i=de(e,t);Vt(i,this.request.color),i.setX(r.x),i.setY(r.y),this.cursorEntities.push({node:i,pageIdx:this.pageIdx})}getEntities(){return this.cursorEntities}}var Lb=Object.defineProperty,Mb=(s,t,e)=>t in s?Lb(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Kl=(s,t,e)=>Mb(s,typeof t!="symbol"?t+"":t,e);function Ob(s,t,e){const r=new Bb(s,t);return r.process(e),r.getEntities()}class Bb{constructor(t,e){Kl(this,"pageIdx",0),Kl(this,"request"),Kl(this,"scoreDrawer"),Kl(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const r=t.slice.measures.findIndex(f=>f.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r===-1)return;const i=t.parts.find(f=>f.partData.uuid===this.request.partUuid);if(!i)return;const a=i.staves.find(f=>f.staffData.uuid===this.request.staffUuid);if(!a)return;const{tickableContent:l}=a.measures[r];let d=l.dynamicsBelow.find(f=>f.getUuid()===this.request.entityUuid);if(d||(d=l.dynamicsAbove.find(f=>f.getUuid()===this.request.entityUuid)),!!d)return this.createEntity(d.getChildRoot()),!0}createEntity(t){const e=this.scoreDrawer.drawingContext,r=rt(t),i=de(e,t);Vt(i,this.request.color),i.setX(r.x),i.setY(r.y),this.cursorEntities.push({node:i,pageIdx:this.pageIdx})}getEntities(){return this.cursorEntities}}var Ib=Object.defineProperty,Fb=(s,t,e)=>t in s?Ib(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Jl=(s,t,e)=>Fb(s,typeof t!="symbol"?t+"":t,e);function Ub(s,t,e){const r=new Hb(s,t);return r.process(e),r.getEntities()}class Hb{constructor(t,e){Jl(this,"pageIdx",0),Jl(this,"request"),Jl(this,"scoreDrawer"),Jl(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const r=t.slice.measures.findIndex(m=>m.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r===-1)return;const i=t.parts.find(m=>m.partData.uuid===this.request.partUuid);if(!i)return;const a=i.getBottomStaff(),{tickableContent:l}=a.measures[r],d=l.figuredBasses.find(m=>m.getUuid()===this.request.entityUuid);if(!d)return;const f=d.getFigureAtLevel(this.request.level||0);if(f)return this.createEntity(f.getChildRoot()),!0}createEntity(t){const e=this.scoreDrawer.drawingContext,r=rt(t),i=de(e,t);Vt(i,this.request.color),i.setX(r.x),i.setY(r.y),this.cursorEntities.push({node:i,pageIdx:this.pageIdx})}getEntities(){return this.cursorEntities}}var _b=Object.defineProperty,Gb=(s,t,e)=>t in s?_b(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,$l=(s,t,e)=>Gb(s,typeof t!="symbol"?t+"":t,e);const Xb=.4;function Wb(s,t,e){const r=new zb(s,t);return r.process(e),r.getEntities()}class zb{constructor(t,e){$l(this,"pageIdx",0),$l(this,"request"),$l(this,"scoreDrawer"),$l(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const r=t.slice.measures.findIndex(x=>x.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r===-1)return;const i=t.parts.find(x=>x.partData.uuid===this.request.partUuid);if(!i)return;const a=i.staves.find(x=>x.staffData.uuid===this.request.staffUuid&&x.staffData.type===Zt.A.GUITAR_TAB);if(!a)return;const l=a.staffData,d=this.request.string;if(d<=0||d>l.nbStaffLines)return;const f=a.measures[r],m=Array.from(f.tickableContent.voices.values()).find(x=>x instanceof Bt?x.voiceUuid===this.request.voiceUuid:!1);if(!m)return;let S;if(this.request.graceIdx!==null){const x=m.gracesMap.get(this.request.noteIdx);if(!x)return;S=x[this.request.graceIdx]}else S=m.notes[this.request.noteIdx];if(!S)return;const w=S.stringHeads.get(this.request.string);return w?this.createEntityFromExisting(w):this.createEntityFromRest(S,this.request.string),!0}createEntityFromExisting(t){const e=this.scoreDrawer.drawingContext,r=rt(t),i=de(e,t);Vt(i,this.request.color),i.setX(r.x),i.setY(r.y),this.cursorEntities.push({node:i,pageIdx:this.pageIdx})}createEntityFromRest(t,e){const r=this.scoreDrawer.drawingContext,i=t.getChildRoot(),a=rt(i),l=r.createGroupNode();l.setX(a.x),l.setY(a.y);const d=t.isGrace()?r.getGraceSizeCoeff():1,f=r.getFretTextFontOptions().fontSize*d,m=r.getTabSpaceSize(),S=Le.A.stringToY(e,m),w=r.createRectNode(f,f,Xb);w.setY(S-f/2),w.setColor(this.request.color),v(l,w),this.cursorEntities.push({node:l,pageIdx:this.pageIdx})}getEntities(){return this.cursorEntities}}var Yb=Object.defineProperty,kb=(s,t,e)=>t in s?Yb(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Zl=(s,t,e)=>kb(s,typeof t!="symbol"?t+"":t,e);function qb(s,t,e){const r=new Vb(s,t);return r.process(e),r.getEntities()}class Vb{constructor(t,e){Zl(this,"pageIdx",0),Zl(this,"request"),Zl(this,"scoreDrawer"),Zl(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const r=t.slice.measures.findIndex(f=>f.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r===-1)return;const i=t.parts.find(f=>f.partData.uuid===this.request.partUuid);if(!i)return;const a=i.getTopStaff(),{tickableContent:l}=a.measures[r],d=l.jazzHarmonies.find(f=>f.getUuid()===this.request.entityUuid);if(d)return this.createEntity(d.getChildRoot()),!0}createEntity(t){const e=this.scoreDrawer.drawingContext,r=rt(t),i=de(e,t);Vt(i,this.request.color),i.setX(r.x),i.setY(r.y),this.cursorEntities.push({node:i,pageIdx:this.pageIdx})}getEntities(){return this.cursorEntities}}var Qb=Object.defineProperty,Kb=(s,t,e)=>t in s?Qb(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Em=(s,t,e)=>Kb(s,typeof t!="symbol"?t+"":t,e);const Jb=.1,$b="key";class jl{constructor(t,e,r,i){Em(this,"groupNode"),Em(this,"glyphs"),this.groupNode=t.createGroupNode(),this.groupNode.setLabel($b);let a=0;this.glyphs=e.map((d,f)=>{const m=t.createGlyphNode(d.glyphId);f>0&&(a+=Jb,a-=m.glyph.minX);const S=Pm(d.line,r);return m.setY(S),m.setX(a),a+=m.glyph.maxX,d.opacity&&m.setOpacity(d.opacity),v(this.groupNode,m),m});const l={entityType:T.A.KEY_SIGNATURE,side:i};this.groupNode.setEventPayload(l)}getChildRoot(){return this.groupNode}}var Zb=Object.defineProperty,jb=(s,t,e)=>t in s?Zb(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,tc=(s,t,e)=>jb(s,typeof t!="symbol"?t+"":t,e);const tP=3,eP=.4,sP="#FFFFFF";function rP(s,t,e){const r=new iP(s,t);return r.process(e),r.getEntities()}class iP{constructor(t,e){tc(this,"pageIdx",0),tc(this,"request"),tc(this,"scoreDrawer"),tc(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if("firstOfType"in this.request&&this.request.firstOfType)return this.processFirstOfType();if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){if(!("measureUuid"in this.request&&this.request.measureUuid))return;const{measureUuid:e,partUuid:r,staffUuid:i}=this.request,a=t.slice,l=a.measures.findIndex(w=>w.rawGlobalMeasure.measureUuid===e||w.rawGlobalMeasure.nextMeasureUuid===e);if(l===-1)return;const d=t.parts.find(w=>w.partData.uuid===r);if(!d)return;const f=d.staves.find(w=>w.staffData.uuid===i);if(!f)return;const m=a.measures[l],S=f.measures[l];if(m.rawGlobalMeasure.measureUuid===e){if(S.leftAttributes===null)return;const w=S.leftAttributes,x=Og(w);return x?(this.request.drawHalo&&this.createHalo(x.getChildRoot()),this.createEntity(x.getChildRoot()),!0):void 0}if(m.rawGlobalMeasure.nextMeasureUuid===e){if(S.rightExternalAttributes===null)return;const w=S.rightExternalAttributes,x=Og(w);if(!x)return;this.request.drawHalo&&this.createHalo(x.getChildRoot()),this.createEntity(x.getChildRoot())}}processFirstOfType(){const a=this.scoreDrawer.getFirstSystem().parts[0].staves[0].measures[0].leftAttributes;if(a===null)return;const l=Og(a);l&&(this.request.drawHalo&&this.createHalo(l.getChildRoot()),this.createEntity(l.getChildRoot()))}createEntity(t){const e=this.scoreDrawer.drawingContext,r=rt(t),i=de(e,t);Vt(i,this.request.color),i.setX(r.x),i.setY(r.y),this.cursorEntities.push({node:i,pageIdx:this.pageIdx})}createHalo(t){const e=this.scoreDrawer.drawingContext,r=rt(t),i=t.getBBox(),a=i?(i.maxX-i.minX)/2:0,l=tP,d=i?-((i.maxY-i.minY)/2)+l:0,f=e.createCircleNode(l);f.setColor(sP),f.setBlur(eP),f.setX(r.x+a),f.setY(r.y+d),this.cursorEntities.push({node:f,pageIdx:this.pageIdx})}getEntities(){return this.cursorEntities}}function Og(s){return s.children.find(t=>t instanceof jl)||null}var nP=Object.defineProperty,oP=(s,t,e)=>t in s?nP(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,ec=(s,t,e)=>oP(s,typeof t!="symbol"?t+"":t,e);function aP(s,t,e){const r=new hP(s,t);return r.process(e),r.getEntities()}class hP{constructor(t,e){ec(this,"pageIdx",0),ec(this,"request"),ec(this,"scoreDrawer"),ec(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const r=t.slice.measures.findIndex(w=>w.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r===-1)return;const i=t.parts.find(w=>w.partData.uuid===this.request.partUuid);if(!i)return;const a=i.staves.find(w=>w.staffData.uuid===this.request.staffUuid);if(!a)return;const l=a.measures[r],d=Array.from(l.tickableContent.voices.values()).find(w=>w instanceof Bt?w.voiceUuid===this.request.voiceUuid:!1);if(!d)return;const f=d.lyricsMap.get(this.request.noteIdx);if(!f)return;const m=f.levelsMap.get(this.request.level);if(!m)return;const S=m.getChildRoot();return this.createEntity(S),!0}createEntity(t){const e=this.scoreDrawer.drawingContext,r=rt(t),i=de(e,t);Vt(i,this.request.color),i.setX(r.x),i.setY(r.y),this.cursorEntities.push({node:i,pageIdx:this.pageIdx})}getEntities(){return this.cursorEntities}}const ir="#808080";var lP=Object.defineProperty,cP=(s,t,e)=>t in s?lP(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ga=(s,t,e)=>cP(s,typeof t!="symbol"?t+"":t,e);const Dm=-1,Cm=2;class uP{constructor(t){Ga(this,"group"),Ga(this,"leftLine"),Ga(this,"middleLine"),Ga(this,"rightLine"),Ga(this,"width",0);const e=t.getMMRInternalThickness(),r=t.getMMRExternalThickness();this.group=t.createGroupNode(),this.leftLine=t.createLineNode(),t.layoutData.greyRepeatNotations&&this.leftLine.setStrokeColor(ir),this.leftLine.setWidth(r),this.leftLine.setY(Dm),this.leftLine.setY2(Cm),this.leftLine.setX2(0),v(this.group,this.leftLine),this.middleLine=t.createLineNode(),t.layoutData.greyRepeatNotations&&this.middleLine.setStrokeColor(ir),this.middleLine.setWidth(e),this.middleLine.setY2(0),v(this.group,this.middleLine),this.rightLine=t.createLineNode(),t.layoutData.greyRepeatNotations&&this.rightLine.setStrokeColor(ir),this.rightLine.setWidth(r),this.rightLine.setY(Dm),this.rightLine.setY2(Cm),v(this.group,this.rightLine)}setWidth(t){t!==this.width&&(this.width=t,this.rightLine.setX(t),this.middleLine.setX2(t))}setY(t){this.group.setY(t)}getChildRoot(){return this.group}}var dP=Object.defineProperty,fP=(s,t,e)=>t in s?dP(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Xa=(s,t,e)=>fP(s,typeof t!="symbol"?t+"":t,e);const Bg=.5,gP=3;class Ig{constructor(t,e,r,i){Xa(this,"group"),Xa(this,"symbol"),Xa(this,"text"),Xa(this,"duration"),Xa(this,"horizontalFormatter",null),this.group=t.createGroupNode();const a=t.getMMRFontOptions();this.text=t.createTextNode(e.toString(),a),v(this.group,this.text);const l=this.text.getLocalBBox();this.text.setY(-l.maxY),t.layoutData.greyRepeatNotations&&this.text.setColor(ir);const d=(r.nbStaffLines-1)/2;this.symbol=new uP(t),this.symbol.setY(d*r.spaceSize),v(this.group,this.symbol.getChildRoot()),this.duration=i;const f={entityType:T.A.MULTI_MEASURE_REST,nbMeasures:e};this.symbol.getChildRoot().setEventPayload(f),this.text.setEventPayload(f)}setHorizontalFormatter(t){this.horizontalFormatter=t}formatHorizontal(){if(this.horizontalFormatter===null)throw new Error("horizontalFormatter is not set");const t=this.horizontalFormatter.getSpaceBeforeNotes(),e=-t+Bg,r=this.horizontalFormatter.getWidth()+t-2*Bg;this.group.setX(e),this.symbol.setWidth(r);const i=this.text.getWidth();this.text.setX((r-i)/2)}getEntityHorizontalData(){let t=gP;const e=this.text.getWidth();return t=Math.max(t,e)+Bg*2,{timePos:0,duration:this.duration,spaceBefore:0,spaceAfter:t,isRest:!0}}getChildRoot(){return this.group}}var pP=Object.defineProperty,mP=(s,t,e)=>t in s?pP(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Zn=(s,t,e)=>mP(s,typeof t!="symbol"?t+"":t,e);const yP="singleEntityVoice";class sc{constructor(t){Zn(this,"dpq"),Zn(this,"nbDivisons"),Zn(this,"voiceIdx"),Zn(this,"groupNode"),Zn(this,"entity",null),Zn(this,"horizontalData",null),this.dpq=t.dpq,this.nbDivisons=t.nbDivisons,this.voiceIdx=t.voiceIdx,this.groupNode=t.drawingContext.createGroupNode(),this.groupNode.setLabel(yP)}setEntity(t){this.entity=t,v(this.groupNode,t.getChildRoot())}getVoiceIdx(){return this.voiceIdx}getHorizontalData(){return this.horizontalData===null&&(this.horizontalData=this.computeHorizontalData()),this.horizontalData}computeHorizontalData(){const e=[this.getEntity().getEntityHorizontalData()],r=[],i={dpq:this.dpq,entities:e,nbDivisions:this.nbDivisons,type:yi.A.NOTE};return r.push(i),r}setHorizontalFormatter(t){this.getEntity().setHorizontalFormatter(t)}formatHorizontal(){this.getEntity().formatHorizontal()}getEntity(){if(this.entity===null)throw new Error("entity should not be null at this point");return this.entity}extractInitialHeights(){return Ei(this.getChildRoot())}getChildRoot(){return this.groupNode}}var AP=Object.defineProperty,vP=(s,t,e)=>t in s?AP(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,rc=(s,t,e)=>vP(s,typeof t!="symbol"?t+"":t,e);function SP(s,t,e){const r=new wP(s,t);return r.process(e),r.getEntities()}class wP{constructor(t,e){rc(this,"pageIdx",0),rc(this,"request"),rc(this,"scoreDrawer"),rc(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const r=t.slice.measures.findIndex(i=>i.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r!==-1)return t.parts.forEach(i=>{i.staves.forEach(a=>{const{tickableContent:l}=a.measures[r];l.voices.forEach(d=>{if(!(d instanceof sc))return;const f=d.getEntity();f instanceof Ig&&this.createEntity(f.getChildRoot())})})}),!0}createEntity(t){const e=this.scoreDrawer.drawingContext,r=rt(t),i=de(e,t);Vt(i,this.request.color),i.setX(r.x),i.setY(r.y),this.cursorEntities.push({node:i,pageIdx:this.pageIdx})}getEntities(){return this.cursorEntities}}var xP=Object.defineProperty,bP=(s,t,e)=>t in s?xP(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,ic=(s,t,e)=>bP(s,typeof t!="symbol"?t+"":t,e);function PP(s,t,e){const r=new EP(s,t);return r.process(e),r.getEntities()}class EP{constructor(t,e){ic(this,"pageIdx",0),ic(this,"request"),ic(this,"scoreDrawer"),ic(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const r=t.slice.measures.findIndex(f=>f.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r===-1)return;const i=t.parts.find(f=>f.partData.uuid===this.request.partUuid);if(!i)return;const a=i.staves.find(f=>f.staffData.uuid===this.request.staffUuid);if(!a)return;const{tickableContent:l}=a.measures[r];let d=l.mutesBelow.find(f=>f.getUuid()===this.request.entityUuid);if(d||(d=l.mutesAbove.find(f=>f.getUuid()===this.request.entityUuid)),!!d)return this.createEntity(d.getChildRoot()),!0}createEntity(t){const e=this.scoreDrawer.drawingContext,r=rt(t),i=de(e,t);Vt(i,this.request.color),i.setX(r.x),i.setY(r.y),this.cursorEntities.push({node:i,pageIdx:this.pageIdx})}getEntities(){return this.cursorEntities}}var DP=Object.defineProperty,CP=(s,t,e)=>t in s?DP(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,nc=(s,t,e)=>CP(s,typeof t!="symbol"?t+"":t,e);function TP(s,t,e){const r=new RP(s,t);return r.process(e),r.getEntities()}class RP{constructor(t,e){nc(this,"pageIdx",0),nc(this,"request"),nc(this,"scoreDrawer"),nc(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const r=t.slice.measures.findIndex(w=>w.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r===-1)return;const i=t.parts.find(w=>w.partData.uuid===this.request.partUuid);if(!i)return;const a=i.staves.find(w=>w.staffData.uuid===this.request.staffUuid);if(!a)return;const l=a.measures[r],d=Array.from(l.tickableContent.voices.values()).find(w=>w instanceof Bt?w.voiceUuid===this.request.voiceUuid:!1);if(!d)return;let f;if(this.request.graceIdx!==null){const w=d.gracesMap.get(this.request.noteIdx);if(!w)return;f=w[this.request.graceIdx]}else f=d.notes[this.request.noteIdx];if(!f)return;const m=f.getHeads();let S;if(this.request.line!==null?S=m.get(this.request.line):S=m.values().next().value,!!S)return this.createEntity(S),!0}createEntity(t){const e=this.scoreDrawer.drawingContext,r=rt(t),i=de(e,t);Vt(i,this.request.color),i.setX(r.x),i.setY(r.y),this.cursorEntities.push({node:i,pageIdx:this.pageIdx})}getEntities(){return this.cursorEntities}}var NP=Object.defineProperty,LP=(s,t,e)=>t in s?NP(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,oc=(s,t,e)=>LP(s,typeof t!="symbol"?t+"":t,e);function MP(s,t,e){const r=new OP(s,t);return r.process(e),r.getEntities()}class OP{constructor(t,e){oc(this,"pageIdx",0),oc(this,"request"),oc(this,"scoreDrawer"),oc(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.forEach(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.forEach(this.processSystem,this)}processSystem(t){const e=t.parts.find(a=>a.partData.uuid===this.request.partUuid);if(!e)return;const r=e.staves.find(a=>a.staffData.uuid===this.request.staffUuid);if(!r)return;const i=r.octaveShifts.rangeChildren.find(a=>a.getUuid()===this.request.entityUuid);if(i)return this.createEntity(i.getChildRoot()),!0}createEntity(t){const e=this.scoreDrawer.drawingContext,r=rt(t),i=de(e,t);Vt(i,this.request.color),i.setX(r.x),i.setY(r.y),this.cursorEntities.push({node:i,pageIdx:this.pageIdx})}getEntities(){return this.cursorEntities}}var BP=Object.defineProperty,IP=(s,t,e)=>t in s?BP(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,ac=(s,t,e)=>IP(s,typeof t!="symbol"?t+"":t,e);function FP(s,t,e){const r=new UP(s,t);return r.process(e),r.getEntities()}class UP{constructor(t,e){ac(this,"pageIdx",0),ac(this,"request"),ac(this,"scoreDrawer"),ac(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.MEASURES_HEADER))return;this.pageIdx=N.A.MEASURES_HEADER;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const e=t.slice,r=e.measures.findIndex(a=>a.rawGlobalMeasure.measureUuid===this.request.measureUuid||a.rawGlobalMeasure.nextMeasureUuid===this.request.measureUuid);if(r===-1)return;const i=e.measures[r];if(i.rawGlobalMeasure.measureUuid===this.request.measureUuid){const l=e.globalStaff.measures[r].pageBreakBeforeDrawer;if(l===null)return;this.createEntity(l.getChildRoot())}if(i.rawGlobalMeasure.nextMeasureUuid===this.request.measureUuid){const l=e.globalStaff.measures[r].pageBreakAfterDrawer;if(l===null)return;this.createEntity(l.getChildRoot())}}createEntity(t){const e=this.scoreDrawer.drawingContext,r=rt(t),i=de(e,t);Vt(i,this.request.color),i.setX(r.x),i.setY(r.y),this.cursorEntities.push({node:i,pageIdx:this.pageIdx})}getEntities(){return this.cursorEntities}}var HP=Object.defineProperty,_P=(s,t,e)=>t in s?HP(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,hc=(s,t,e)=>_P(s,typeof t!="symbol"?t+"":t,e);function GP(s,t,e){const r=new XP(s,t);return r.process(e),r.getEntities()}class XP{constructor(t,e){hc(this,"pageIdx",0),hc(this,"request"),hc(this,"scoreDrawer"),hc(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if("firstOfType"in this.request&&this.request.firstOfType)return this.processFirstOfType(t);if(this.scoreDrawer.displayMetrics.partsPanel){if(!t.includes(N.A.PARTS_HEADER))return;this.pageIdx=N.A.PARTS_HEADER;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.forEach(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.forEach(this.processSystem,this)}processSystem(t){if(!("partUuid"in this.request&&this.request.partUuid))return;const e=this.request.partUuid,i=t.header.parts.find(a=>a.partUuid===e);if(!(!i||!i.textNode))return this.createEntity(i.textNode),!0}processFirstOfType(t){if(!("firstOfType"in this.request&&this.request.firstOfType))return;t.includes(N.A.PARTS_HEADER)&&(this.pageIdx=N.A.PARTS_HEADER);const r=this.scoreDrawer.getFirstSystem().header.parts[0];!r||!r.textNode||this.createEntity(r.textNode)}createEntity(t){const e=this.scoreDrawer.drawingContext,r=rt(t),i=de(e,t);Vt(i,this.request.color),i.setX(r.x),i.setY(r.y),this.cursorEntities.push({node:i,pageIdx:this.pageIdx})}getEntities(){return this.cursorEntities}}var WP=Object.defineProperty,zP=(s,t,e)=>t in s?WP(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,lc=(s,t,e)=>zP(s,typeof t!="symbol"?t+"":t,e);function YP(s,t,e){const r=new kP(s,t);return r.process(e),r.getEntities()}class kP{constructor(t,e){lc(this,"pageIdx",0),lc(this,"request"),lc(this,"scoreDrawer"),lc(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.forEach(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.forEach(this.processSystem,this)}processSystem(t){const e=t.parts.find(a=>a.partData.uuid===this.request.partUuid);if(!e)return;const r=e.staves.find(a=>a.staffData.uuid===this.request.staffUuid);if(!r)return;const i=r.pedals.rangeChildren.find(a=>a.getUuid()===this.request.entityUuid);if(i)return this.createEntity(i.getChildRoot()),!0}createEntity(t){const e=this.scoreDrawer.drawingContext,r=rt(t),i=de(e,t);Vt(i,this.request.color),i.setX(r.x),i.setY(r.y),this.cursorEntities.push({node:i,pageIdx:this.pageIdx})}getEntities(){return this.cursorEntities}}var qP=Object.defineProperty,VP=(s,t,e)=>t in s?qP(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,cc=(s,t,e)=>VP(s,typeof t!="symbol"?t+"":t,e);function QP(s,t,e){const r=new KP(s,t);return r.process(e),r.getEntities()}class KP{constructor(t,e){cc(this,"pageIdx",0),cc(this,"request"),cc(this,"scoreDrawer"),cc(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const r=t.slice.measures.findIndex(f=>f.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r===-1)return;const i=t.parts.find(f=>f.partData.uuid===this.request.partUuid);if(!i)return;const a=i.staves.find(f=>f.staffData.uuid===this.request.staffUuid);if(!a)return;const{tickableContent:l}=a.measures[r];let d=l.pizzicatosBelow.find(f=>f.getUuid()===this.request.entityUuid);if(d||(d=l.pizzicatosAbove.find(f=>f.getUuid()===this.request.entityUuid)),!!d)return this.createEntity(d.getChildRoot()),!0}createEntity(t){const e=this.scoreDrawer.drawingContext,r=rt(t),i=de(e,t);Vt(i,this.request.color),i.setX(r.x),i.setY(r.y),this.cursorEntities.push({node:i,pageIdx:this.pageIdx})}getEntities(){return this.cursorEntities}}var JP=Object.defineProperty,$P=(s,t,e)=>t in s?JP(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,uc=(s,t,e)=>$P(s,typeof t!="symbol"?t+"":t,e);function ZP(s,t,e){const r=new jP(s,t);return r.process(e),r.getEntities()}class jP{constructor(t,e){uc(this,"pageIdx",0),uc(this,"request"),uc(this,"scoreDrawer"),uc(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.forEach(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.forEach(this.processSystem,this)}processSystem(t){const e=t.parts.find(a=>a.partData.uuid===this.request.partUuid);if(!e)return;const r=e.staves.find(a=>a.staffData.uuid===this.request.staffUuid);if(!r)return;const i=r.pluckedRanges.rangeChildren.find(a=>a.getUuid()===this.request.entityUuid);if(i)return this.createEntity(i.getChildRoot()),!0}createEntity(t){const e=this.scoreDrawer.drawingContext,r=rt(t),i=de(e,t);Vt(i,this.request.color),i.setX(r.x),i.setY(r.y),this.cursorEntities.push({node:i,pageIdx:this.pageIdx})}getEntities(){return this.cursorEntities}}var tE=Object.defineProperty,eE=(s,t,e)=>t in s?tE(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,dc=(s,t,e)=>eE(s,typeof t!="symbol"?t+"":t,e);function sE(s,t,e){const r=new rE(s,t);return r.process(e),r.getEntities()}class rE{constructor(t,e){dc(this,"pageIdx",0),dc(this,"request"),dc(this,"scoreDrawer"),dc(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.MEASURES_HEADER))return;this.pageIdx=N.A.MEASURES_HEADER;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const e=t.slice,r=e.measures.findIndex(l=>l.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r===-1)return;const a=e.globalStaff.measures[r];a.rehearsal!==null&&this.createEntity(a.rehearsal.getChildRoot())}createEntity(t){const e=this.scoreDrawer.drawingContext,r=rt(t),i=de(e,t);Vt(i,this.request.color),i.setX(r.x),i.setY(r.y),this.cursorEntities.push({node:i,pageIdx:this.pageIdx})}getEntities(){return this.cursorEntities}}var iE=Object.defineProperty,nE=(s,t,e)=>t in s?iE(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,fc=(s,t,e)=>nE(s,typeof t!="symbol"?t+"":t,e);function oE(s,t,e){const r=new aE(s,t);return r.process(e),r.getEntities()}class aE{constructor(t,e){fc(this,"pageIdx",0),fc(this,"request"),fc(this,"scoreDrawer"),fc(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const r=t.slice.measures.findIndex(f=>f.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r===-1)return;const i=t.parts.find(f=>f.partData.uuid===this.request.partUuid);if(!i)return;const a=i.getBottomStaff(),{tickableContent:l}=a.measures[r],d=l.romanNumerals.find(f=>f.getUuid()===this.request.entityUuid);if(d)return this.createEntity(d.getChildRoot()),!0}createEntity(t){const e=this.scoreDrawer.drawingContext,r=rt(t),i=de(e,t);Vt(i,this.request.color),i.setX(r.x),i.setY(r.y),this.cursorEntities.push({node:i,pageIdx:this.pageIdx})}getEntities(){return this.cursorEntities}}var hE=Object.defineProperty,lE=(s,t,e)=>t in s?hE(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,gc=(s,t,e)=>lE(s,typeof t!="symbol"?t+"":t,e);function cE(s,t,e){const r=new uE(s,t);return r.process(e),r.getEntities()}class uE{constructor(t,e){gc(this,"pageIdx",0),gc(this,"request"),gc(this,"scoreDrawer"),gc(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.forEach(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.forEach(this.processSystem,this)}processSystem(t){var e;const r=t.parts.find(m=>m.partData.uuid===this.request.partUuid);if(!r)return;const i=r.staves.find(m=>m.staffData.uuid===this.request.staffUuid);if(!i)return;const l=(e=[...r.partData.voiceUuidMapping.entries()].find(([m,S])=>S===this.request.voiceUuid))==null?void 0:e[0],d=i.voiceSlurs.find(m=>m.voiceIdx===l);if(!d)return;const f=d.slurs.find(m=>m.getUuid()===this.request.entityUuid);if(f)return this.createEntity(f.getChildRoot()),!0}createEntity(t){const e=this.scoreDrawer.drawingContext,r=rt(t),i=de(e,t);Vt(i,this.request.color),i.setX(r.x),i.setY(r.y),this.cursorEntities.push({node:i,pageIdx:this.pageIdx})}getEntities(){return this.cursorEntities}}var dE=Object.defineProperty,fE=(s,t,e)=>t in s?dE(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,pc=(s,t,e)=>fE(s,typeof t!="symbol"?t+"":t,e);function gE(s,t,e){const r=new pE(s,t);return r.process(e),r.getEntities()}class pE{constructor(t,e){pc(this,"pageIdx",0),pc(this,"request"),pc(this,"scoreDrawer"),pc(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.MEASURES_HEADER))return;this.pageIdx=N.A.MEASURES_HEADER;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const e=t.slice,r=e.measures.findIndex(l=>l.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r===-1)return;const a=e.globalStaff.measures[r];a.metronome!==null&&a.metronome.swing!==null&&this.createEntity(a.metronome.swing.getChildRoot())}createEntity(t){const e=this.scoreDrawer.drawingContext,r=rt(t),i=de(e,t);Vt(i,this.request.color),i.setX(r.x),i.setY(r.y),this.cursorEntities.push({node:i,pageIdx:this.pageIdx})}getEntities(){return this.cursorEntities}}var mE=Object.defineProperty,yE=(s,t,e)=>t in s?mE(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,mc=(s,t,e)=>yE(s,typeof t!="symbol"?t+"":t,e);function AE(s,t,e){const r=new vE(s,t);return r.process(e),r.getEntities()}class vE{constructor(t,e){mc(this,"pageIdx",0),mc(this,"request"),mc(this,"scoreDrawer"),mc(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.MEASURES_HEADER))return;this.pageIdx=N.A.MEASURES_HEADER;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const e=t.slice,r=e.measures.findIndex(a=>a.rawGlobalMeasure.measureUuid===this.request.measureUuid||a.rawGlobalMeasure.nextMeasureUuid===this.request.measureUuid);if(r===-1)return;const i=e.measures[r];if(i.rawGlobalMeasure.measureUuid===this.request.measureUuid){const l=e.globalStaff.measures[r].systemBreakBeforeDrawer;if(l===null)return;this.createEntity(l.getChildRoot())}if(i.rawGlobalMeasure.nextMeasureUuid===this.request.measureUuid){const l=e.globalStaff.measures[r].systemBreakAfterDrawer;if(l===null)return;this.createEntity(l.getChildRoot())}}createEntity(t){const e=this.scoreDrawer.drawingContext,r=rt(t),i=de(e,t);Vt(i,this.request.color),i.setX(r.x),i.setY(r.y),this.cursorEntities.push({node:i,pageIdx:this.pageIdx})}getEntities(){return this.cursorEntities}}var SE=Object.defineProperty,wE=(s,t,e)=>t in s?SE(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,yc=(s,t,e)=>wE(s,typeof t!="symbol"?t+"":t,e);function xE(s,t,e){const r=new bE(s,t);return r.process(e),r.getEntities()}class bE{constructor(t,e){yc(this,"pageIdx",0),yc(this,"request"),yc(this,"scoreDrawer"),yc(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.MEASURES_HEADER))return;this.pageIdx=N.A.MEASURES_HEADER;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.forEach(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.forEach(this.processSystem,this)}processSystem(t){const i=t.slice.globalStaff.tempoChanges.rangeChildren.find(a=>a.getUuid()===this.request.entityUuid);if(i)return this.createEntity(i.getChildRoot()),!0}createEntity(t){const e=this.scoreDrawer.drawingContext,r=rt(t),i=de(e,t);Vt(i,this.request.color),i.setX(r.x),i.setY(r.y),this.cursorEntities.push({node:i,pageIdx:this.pageIdx})}getEntities(){return this.cursorEntities}}var PE=Object.defineProperty,EE=(s,t,e)=>t in s?PE(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ac=(s,t,e)=>EE(s,typeof t!="symbol"?t+"":t,e);function DE(s,t,e){const r=new CE(s,t);return r.process(e),r.getEntities()}class CE{constructor(t,e){Ac(this,"pageIdx",0),Ac(this,"request"),Ac(this,"scoreDrawer"),Ac(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if("firstOfType"in this.request&&this.request.firstOfType)return this.processFirstOfType(t);if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.MEASURES_HEADER))return;this.pageIdx=N.A.MEASURES_HEADER;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){if(!("measureUuid"in this.request&&this.request.measureUuid))return;const e=t.slice,r=this.request.measureUuid,i=e.measures.findIndex(d=>d.rawGlobalMeasure.measureUuid===r);if(i===-1)return;const l=e.globalStaff.measures[i];l.metronome!==null&&l.metronome.tempo!==null&&this.createEntity(l.metronome.tempo.getChildRoot())}processFirstOfType(t){if(!("firstOfType"in this.request&&this.request.firstOfType))return;t.includes(N.A.MEASURES_HEADER)&&(this.pageIdx=N.A.MEASURES_HEADER);const i=this.scoreDrawer.getFirstSystem().slice.globalStaff.measures[0];i.metronome!==null&&i.metronome.tempo!==null&&this.createEntity(i.metronome.tempo.getChildRoot())}createEntity(t){const e=this.scoreDrawer.drawingContext,r=rt(t),i=de(e,t);Vt(i,this.request.color),i.setX(r.x),i.setY(r.y),this.cursorEntities.push({node:i,pageIdx:this.pageIdx})}getEntities(){return this.cursorEntities}}var TE=Object.defineProperty,RE=(s,t,e)=>t in s?TE(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,vc=(s,t,e)=>RE(s,typeof t!="symbol"?t+"":t,e);function NE(s,t,e){const r=new LE(s,t);return r.process(e),r.getEntities()}class LE{constructor(t,e){vc(this,"pageIdx",0),vc(this,"request"),vc(this,"scoreDrawer"),vc(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const r=t.slice.measures.findIndex(f=>f.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r===-1)return;const i=t.parts.find(f=>f.partData.uuid===this.request.partUuid);if(!i)return;const a=i.staves.find(f=>f.staffData.uuid===this.request.staffUuid);if(!a)return;const{tickableContent:l}=a.measures[r];let d=l.textAnnotationsBelow.find(f=>f.getUuid()===this.request.entityUuid);if(d||(d=l.textAnnotationsAbove.find(f=>f.getUuid()===this.request.entityUuid)),!!d)return this.createEntity(d.getChildRoot()),!0}createEntity(t){const e=this.scoreDrawer.drawingContext,r=rt(t),i=de(e,t);Vt(i,this.request.color),i.setX(r.x),i.setY(r.y),this.cursorEntities.push({node:i,pageIdx:this.pageIdx})}getEntities(){return this.cursorEntities}}var ME=Object.defineProperty,OE=(s,t,e)=>t in s?ME(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,BE=(s,t,e)=>OE(s,typeof t!="symbol"?t+"":t,e);class Sc{constructor(t,e,r){BE(this,"rootNode"),this.rootNode=t;const i=IE(e);t.setY(i);const a={entityType:T.A.TIME_SIGNATURE,side:r};this.rootNode.setEventPayload(a)}getChildRoot(){return this.rootNode}}function IE(s){return(0,Ft.o5)(s)/2}var FE=Object.defineProperty,UE=(s,t,e)=>t in s?FE(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,wc=(s,t,e)=>UE(s,typeof t!="symbol"?t+"":t,e);const HE=3,_E=.4,GE="#FFFFFF";function XE(s,t,e){const r=new WE(s,t);return r.process(e),r.getEntities()}class WE{constructor(t,e){wc(this,"pageIdx",0),wc(this,"request"),wc(this,"scoreDrawer"),wc(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if("firstOfType"in this.request&&this.request.firstOfType)return this.processFirstOfType();if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){if(!("measureUuid"in this.request&&this.request.measureUuid))return;const e=t.slice,r=this.request.measureUuid,i=e.measures.findIndex(a=>a.rawGlobalMeasure.measureUuid===r||a.rawGlobalMeasure.nextMeasureUuid===r);i!==-1&&t.parts.forEach(a=>{a.staves.forEach(l=>{const d=e.measures[i],f=l.measures[i];if(d.rawGlobalMeasure.measureUuid===r){if(f.leftAttributes===null)return;const m=f.leftAttributes,S=Fg(m);return S?(this.request.drawHalo&&this.createHalo(S.getChildRoot()),this.createEntity(S.getChildRoot()),!0):void 0}if(d.rawGlobalMeasure.nextMeasureUuid===r){if(f.rightExternalAttributes===null)return;const m=f.rightExternalAttributes,S=Fg(m);if(!S)return;this.request.drawHalo&&this.createHalo(S.getChildRoot()),this.createEntity(S.getChildRoot())}})})}processFirstOfType(){const a=this.scoreDrawer.getFirstSystem().parts[0].staves[0].measures[0].leftAttributes;if(a===null)return;const l=Fg(a);l&&(this.request.drawHalo&&this.createHalo(l.getChildRoot()),this.createEntity(l.getChildRoot()))}createEntity(t){const e=this.scoreDrawer.drawingContext,r=rt(t),i=de(e,t);Vt(i,this.request.color),i.setX(r.x),i.setY(r.y),this.cursorEntities.push({node:i,pageIdx:this.pageIdx})}createHalo(t){const e=this.scoreDrawer.drawingContext,r=rt(t),i=t.getBBox(),a=i?(i.maxX-i.minX)/2:0,l=HE,d=e.createCircleNode(l);d.setColor(GE),d.setBlur(_E),d.setX(r.x+a),d.setY(r.y),this.cursorEntities.push({node:d,pageIdx:this.pageIdx})}getEntities(){return this.cursorEntities}}function Fg(s){return s.children.find(t=>t instanceof Sc)||null}var zE=Object.defineProperty,YE=(s,t,e)=>t in s?zE(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,xc=(s,t,e)=>YE(s,typeof t!="symbol"?t+"":t,e);function kE(s,t,e){const r=new qE(s,t);return r.process(e),r.getEntities()}class qE{constructor(t,e){xc(this,"pageIdx",0),xc(this,"request"),xc(this,"scoreDrawer"),xc(this,"cursorEntities",[]),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.forEach(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.forEach(this.processSystem,this)}processSystem(t){const e=t.parts.find(a=>a.partData.uuid===this.request.partUuid);if(!e)return;const r=e.staves.find(a=>a.staffData.uuid===this.request.staffUuid);if(!r)return;const i=r.wedges.rangeChildren.find(a=>a.getUuid()===this.request.entityUuid);if(i)return this.createEntity(i.getChildRoot()),!0}createEntity(t){const e=this.scoreDrawer.drawingContext,r=rt(t),i=de(e,t);Vt(i,this.request.color),i.setX(r.x),i.setY(r.y),this.cursorEntities.push({node:i,pageIdx:this.pageIdx})}getEntities(){return this.cursorEntities}}function VE(s,t,e){switch(s.type){case T.A.NOTE:return TP(s,t,e);case T.A.FRET:return Wb(s,t,e);case T.A.SLUR:return cE(s,t,e);case T.A.LYRIC:return aP(s,t,e);case T.A.WEDGE:return kE(s,t,e);case T.A.PIANO_PEDAL:return YP(s,t,e);case T.A.OCTAVE_SHIFT:return MP(s,t,e);case T.A.PLUCKED_RANGE:return ZP(s,t,e);case T.A.TEMPO_CHANGE:return xE(s,t,e);case T.A.DYNAMICS:return Ob(s,t,e);case T.A.CLEF:return Eb(s,t,e);case T.A.PIZZICATO:return QP(s,t,e);case T.A.JAZZ_HARMONY:return qb(s,t,e);case T.A.TEXT_ANNOTATION:return NE(s,t,e);case T.A.ROMAN_NUMERAL:return oE(s,t,e);case T.A.FIGURED_BASS:return Ub(s,t,e);case T.A.MUTE:return PP(s,t,e);case T.A.PART_NAME:return GP(s,t,e);case T.A.CREDIT:return Rb(s,t,e);case T.A.KEY_SIGNATURE:return rP(s,t,e);case T.A.TIME_SIGNATURE:return XE(s,t,e);case T.A.TEMPO:return DE(s,t,e);case T.A.BARLINE_REPEAT_TIMES:return nb(s,t,e);case T.A.REHEARSAL:return sE(s,t,e);case T.A.SWING:return gE(s,t,e);case T.A.SYSTEM_BREAK:return AE(s,t,e);case T.A.PAGE_BREAK:return FP(s,t,e);case T.A.MULTI_MEASURE_REST:return SP(s,t,e);default:throw new Error(`Unsupported entity type: ${s.type}`)}}var QE=Object.defineProperty,KE=(s,t,e)=>t in s?QE(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ug=(s,t,e)=>KE(s,typeof t!="symbol"?t+"":t,e);class JE{constructor(t){Ug(this,"scoreDrawer"),Ug(this,"drawingContext"),Ug(this,"pages",new Map),this.scoreDrawer=t,this.drawingContext=t.drawingContext}drawCursor(t,e){this.dropPages();const r=this.getDisplayedPages(e);return[...t.overrides.flatMap(a=>VE(a,this.scoreDrawer,r)),...t.foregroundAdditions.flatMap(a=>sb(a,this.scoreDrawer,r))].forEach(this.attachForegroundEntity,this),this.getCursorPages(e)}getDisplayedPages(t){const e=this.scoreDrawer.pages.length;if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(e===0)return[];const r=this.scoreDrawer.pages[0];if(r.isDirty()||!r.formattedFlag)return[];const i=(0,N.N)();return t.filter(a=>i.includes(a))}return t.filter(r=>{if(r>=e)return!1;const i=this.scoreDrawer.pages[r];return!i.isDirty()&&i.formattedFlag})}attachForegroundEntity(t){let e=this.pages.get(t.pageIdx);e||(e=this.drawingContext.createGroupNode(),this.pages.set(t.pageIdx,e)),v(e,t.node)}dropPages(){this.pages.forEach(t=>{const e=t.parent;e&&it(e,t),t.destroy()}),this.pages.clear()}getCursorPages(t){const e=t[t.length-1],r=[];for(let i=0;i<=e;i++){const a=this.pages.get(i)||null;r.push(a)}return r}}function bc(s){return!s.layout&&s.measuresHeaders.length===0&&s.partsHeaders.length===0&&s.measures.length===0}var Mi=b(736175),$E=b(172858),ZE=Object.defineProperty,jE=(s,t,e)=>t in s?ZE(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,tD=(s,t,e)=>jE(s,typeof t!="symbol"?t+"":t,e);const eD="777";class sD{constructor(t,e){tD(this,"textNode");const r=t.getMeasureNumberFontOptions();this.textNode=t.createTextNode(e.toString(),r),this.textNode.setShadowText(eD)}setMeasureNumber(t){this.textNode.setText(t.toString())}getChildRoot(){return this.textNode}setX(t){this.textNode.setX(t)}destroy(){this.textNode.destroy()}}var rD=Object.defineProperty,iD=(s,t,e)=>t in s?rD(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,nD=(s,t,e)=>iD(s,typeof t!="symbol"?t+"":t,e);const oD=["pageBreakYesArrowHead","pageBreakYesArrowLine","pageBreakYesPage","pageBreakYesDashedLine"],aD=2,hD="pageBreak";class Tm{constructor(t,e){nD(this,"groupNode"),this.groupNode=t.createGroupNode(),this.groupNode.setLabel(hD),this.groupNode.setTakeSpace(!1),oD.forEach(i=>{const a=t.createGlyphNode(i,aD);a.setFillRule("evenodd"),v(this.groupNode,a)});const r={entityType:T.A.PAGE_BREAK,side:e};this.groupNode.setEventPayload(r)}setX(t){this.groupNode.setX(t)}getSpaceBefore(){const t=this.groupNode.getLocalBBox();if(t===null)throw new Error("Unexpected");return-t.minX}getSpaceAfter(){const t=this.groupNode.getLocalBBox();if(t===null)throw new Error("Unexpected");return t.maxX}destroy(){this.groupNode.destroy()}getChildRoot(){return this.groupNode}}var lD=Object.defineProperty,cD=(s,t,e)=>t in s?lD(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,uD=(s,t,e)=>cD(s,typeof t!="symbol"?t+"":t,e);const dD="systemBreakYes",fD=2,gD="systemBreak";class Rm{constructor(t,e){uD(this,"glyphNode"),this.glyphNode=t.createGlyphNode(dD,fD),this.glyphNode.setLabel(gD),this.glyphNode.setTakeSpace(!1),this.glyphNode.setWidth(.1),this.glyphNode.setStrokeColor("black");const r={entityType:T.A.SYSTEM_BREAK,side:e};this.glyphNode.setEventPayload(r)}setX(t){this.glyphNode.setX(t)}getWidth(){return this.glyphNode.getWidth()}destroy(){this.glyphNode.destroy()}getChildRoot(){return this.glyphNode}}var pD=Object.defineProperty,mD=(s,t,e)=>t in s?pD(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,De=(s,t,e)=>mD(s,typeof t!="symbol"?t+"":t,e);const yD="globalMeasure",AD=2,vD=.5,SD=1;class Pc{constructor(t,e,r){De(this,"drawingContext"),De(this,"measureUuid"),De(this,"nextMeasureUuid",null),De(this,"tickableContent"),De(this,"group"),De(this,"jumpCall",null),De(this,"jumpTag",null),De(this,"barlineRepeatNbTimes",null),De(this,"measureNumber",null),De(this,"horizontalFormatter",null),De(this,"formerLeftBarlinePosition",null),De(this,"leftBarlinePosition",null),De(this,"rightBarlinePosition",null),De(this,"systemBreakBefore"),De(this,"systemBreakAfter"),De(this,"systemBreakBeforeDrawer",null),De(this,"systemBreakAfterDrawer",null),De(this,"pageBreakBefore"),De(this,"pageBreakAfter"),De(this,"pageBreakBeforeDrawer",null),De(this,"pageBreakAfterDrawer",null),De(this,"metronome",null),De(this,"rehearsal",null),this.drawingContext=t,this.measureUuid=r.measureUuid,this.nextMeasureUuid=r.nextMeasureUuid,this.tickableContent=e,this.group=t.createGroupNode(),this.group.setLabel(yD),this.systemBreakBefore=r.systemBreakBefore,this.systemBreakAfter=r.systemBreakAfter,this.pageBreakBefore=r.pageBreakBefore,this.pageBreakAfter=r.pageBreakAfter}hasSystemBreakBefore(){return this.systemBreakBefore}hasSystemBreakAfter(){return this.systemBreakAfter}hasPageBreakBefore(){return this.pageBreakBefore}hasPageBreakAfter(){return this.pageBreakAfter}setJumpCall(t){this.jumpCall=t,v(this.group,t.getChildRoot())}setJumpTag(t){this.jumpTag=t,v(this.group,t.getChildRoot())}setBarlineRepeatTimes(t){this.barlineRepeatNbTimes=t,v(this.group,t.getChildRoot())}setMetronome(t){this.metronome=t,v(this.group,t.getChildRoot())}setRehearsal(t){this.rehearsal=t,v(this.group,t.getChildRoot())}setMeasureNumber(t){if(this.rehearsal){if(t===null)throw new Error("measureNumber cannot be null");this.rehearsal.setMeasureNumber(t)}else t===null&&this.measureNumber!==null?(it(this.group,this.measureNumber.getChildRoot()),this.measureNumber.destroy(),this.measureNumber=null):t!==null&&(this.measureNumber===null?(this.measureNumber=new sD(this.drawingContext,t),v(this.group,this.measureNumber.getChildRoot())):this.measureNumber.setMeasureNumber(t))}getChildRoot(){return this.group}setHorizontalFormatter(t){if(t!==this.horizontalFormatter){if(this.rightBarlinePosition=null,this.horizontalFormatter=t,t.tickableFormatter===null)throw new Error("tickableFormatter is null");this.tickableContent.setHorizontalFormatter(t.tickableFormatter),this.updateSystemBreak(),this.updatePageBreak()}}updateSystemBreak(){if(this.drawingContext.showSystemBreakSymbols()){if(this.systemBreakBefore){const t=this.systemBreakBefore&&this.formerLeftBarlinePosition===null;t&&this.systemBreakBeforeDrawer===null?(this.systemBreakBeforeDrawer=new Rm(this.drawingContext,"left"),v(this.group,this.systemBreakBeforeDrawer.getChildRoot())):!t&&this.systemBreakBeforeDrawer!==null&&(it(this.group,this.systemBreakBeforeDrawer.getChildRoot()),this.systemBreakBeforeDrawer.destroy(),this.systemBreakBeforeDrawer=null)}this.systemBreakAfter&&this.systemBreakAfterDrawer===null&&(this.systemBreakAfterDrawer=new Rm(this.drawingContext,"right"),v(this.group,this.systemBreakAfterDrawer.getChildRoot()))}}updatePageBreak(){if(this.drawingContext.showSystemBreakSymbols()){if(this.pageBreakBefore){const t=this.pageBreakBefore&&this.formerLeftBarlinePosition===null;t&&this.pageBreakBeforeDrawer===null?(this.pageBreakBeforeDrawer=new Tm(this.drawingContext,"left"),v(this.group,this.pageBreakBeforeDrawer.getChildRoot())):!t&&this.pageBreakBeforeDrawer!==null&&(it(this.group,this.pageBreakBeforeDrawer.getChildRoot()),this.pageBreakBeforeDrawer.destroy(),this.pageBreakBeforeDrawer=null)}this.pageBreakAfter&&this.pageBreakAfterDrawer===null&&(this.pageBreakAfterDrawer=new Tm(this.drawingContext,"right"),v(this.group,this.pageBreakAfterDrawer.getChildRoot()))}}setX(t){this.group.setX(t)}getWidth(){if(this.horizontalFormatter===null)throw new Error("horizontalFormatter is null");return this.horizontalFormatter.getWidth()}formatHorizontal(){if(this.horizontalFormatter===null)throw new Error("horizontalFormatter is null");this.rightBarlinePosition=null,this.jumpTag!==null&&this.jumpTag.setX(this.getLeftBarlinePosition()),this.jumpCall!==null&&this.jumpCall.setX(this.getRightBarlinePosition()),this.barlineRepeatNbTimes!==null&&this.barlineRepeatNbTimes.setX(this.getRightBarlinePosition()-vD),this.measureNumber!==null&&this.measureNumber.setX(this.getLeftExternalBarlinePosition()),this.rehearsal!==null&&this.rehearsal.setX(this.getLeftExternalBarlinePosition()+SD);let t=0;if(this.horizontalFormatter.leftBlockFormatting!==null&&(t+=this.horizontalFormatter.leftBlockFormatting.width),this.horizontalFormatter.spaceBeforeNotes===null)throw new Error("spaceBeforeNotes is null");t+=this.horizontalFormatter.spaceBeforeNotes,this.tickableContent.setX(t);const e=this.group.getX();if(this.tickableContent.formatHorizontal(e),this.systemBreakBeforeDrawer!==null){const r=this.getLeftExternalBarlinePosition()+this.systemBreakBeforeDrawer.getWidth()/2;this.systemBreakBeforeDrawer.setX(r)}if(this.systemBreakAfterDrawer!==null){const r=this.getRightBarlinePosition()-this.systemBreakAfterDrawer.getWidth()/2;this.systemBreakAfterDrawer.setX(r)}if(this.pageBreakBeforeDrawer!==null){const r=this.getLeftExternalBarlinePosition()+this.pageBreakBeforeDrawer.getSpaceBefore();this.pageBreakBeforeDrawer.setX(r)}if(this.pageBreakAfterDrawer!==null){const r=this.getRightBarlinePosition()-this.pageBreakAfterDrawer.getSpaceAfter();this.pageBreakAfterDrawer.setX(r)}if(this.metronome){let r=t-AD;const i=this.getLeftExternalBarlinePosition();r=Math.max(r,i),this.metronome.setX(r)}}setFormerLeftBarlinePosition(t){this.formerLeftBarlinePosition=t}getLeftExternalBarlinePosition(){return this.formerLeftBarlinePosition!==null?this.formerLeftBarlinePosition:0}getLeftBarlinePosition(){return this.leftBarlinePosition===null&&(this.leftBarlinePosition=this.calcLeftBarlinePosition()),this.leftBarlinePosition}calcLeftBarlinePosition(){if(this.horizontalFormatter===null)throw new Error("horizontalFormatter is null");return this.horizontalFormatter.leftBlockFormatting!==null&&this.horizontalFormatter.leftBlockFormatting.leftBarlinePosition!==null?this.horizontalFormatter.leftBlockFormatting.leftBarlinePosition+this.drawingContext.getThinBarlineThickness()/2:this.formerLeftBarlinePosition!==null?this.formerLeftBarlinePosition:this.drawingContext.getThinBarlineThickness()/2}getRightBarlinePosition(){return this.rightBarlinePosition===null&&(this.rightBarlinePosition=this.calcRightBarlinePosition()),this.rightBarlinePosition}calcRightBarlinePosition(){if(this.horizontalFormatter===null)throw new Error("horizontalFormatter is null");if(this.horizontalFormatter.spaceBeforeNotes===null)throw new Error("spaceBeforeNotes is null");if(this.horizontalFormatter.tickableFormatter===null)throw new Error("tickableFormatter is null");if(this.horizontalFormatter.rightBlockFormatting===null)throw new Error("rightBlockFormatting is null");let t=0;return this.horizontalFormatter.leftBlockFormatting!==null&&(t+=this.horizontalFormatter.leftBlockFormatting.width),t+=this.horizontalFormatter.spaceBeforeNotes,t+=this.horizontalFormatter.tickableFormatter.getWidth(),t+=this.horizontalFormatter.rightBlockFormatting.rightBarlinePosition,this.horizontalFormatter.rightBarlineWidth!==null&&(t+=this.horizontalFormatter.rightBarlineWidth),t-=this.drawingContext.getThinBarlineThickness()/2,t}hasRightTempoChangeAnchor(){return this.tickableContent.hasRightTempoChangeAnchor()}getRightTempoChangeAnchor(){return this.tickableContent.getRightTempoChangeAnchor()}hasLeftTempoChangeAnchor(){return this.tickableContent.hasLeftTempoChangeAnchor()}getLeftTempoChangeAnchor(){return this.tickableContent.getLeftTempoChangeAnchor()}getMiddleTempoChangesAnchors(){return this.tickableContent.getMiddleTempoChangesAnchors()}hasRightEndingAnchor(){return this.tickableContent.hasRightEndingAnchor()}getRightEndingAnchor(){return this.tickableContent.getRightEndingAnchor()}hasLeftEndingAnchor(){return this.tickableContent.hasLeftEndingAnchor()}getLeftEndingAnchor(){return this.tickableContent.getLeftEndingAnchor()}getMiddleEndingAnchors(){return this.tickableContent.getMiddleEndingAnchors()}destroy(){this.group.destroy()}}var Hg=b(719476),jn=b(312395),wD=Object.defineProperty,xD=(s,t,e)=>t in s?wD(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ec=(s,t,e)=>xD(s,typeof t!="symbol"?t+"":t,e);class Dc{constructor({location:t}){Ec(this,"location"),Ec(this,"ending",null),Ec(this,"text",null),Ec(this,"rightClosed",null),this.location=t}getTimePos(){return 0}getDpq(){return 1}hasEnding(){return this.ending!==null}setEnding(t){this.ending=t}getEnding(){return this.ending}getRangeEntity(){return this.ending}hasText(){return this.text!==null}getText(){return this.text}setText(t){this.text=t}isLeftClosed(){return this.hasText()}setRightClosed(t){this.rightClosed=t}isRightClosed(){return!!this.rightClosed}isStart(){return this.isLeft()}isStop(){return this.isRight()}isAbove(){return!0}isBelow(){return!1}isLeft(){return jn.A.isLeft(this.location)}isRight(){return jn.A.isRight(this.location)}removeEnding(){if(!this.hasEnding())return;const t=this.ending;if(this.isStart())t.removeLeftAnchor();else if(this.isStop())t.removeRightAnchor();else throw new Error("Unexpected");this.ending=null}}var bD=Object.defineProperty,PD=(s,t,e)=>t in s?bD(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,to=(s,t,e)=>PD(s,typeof t!="symbol"?t+"":t,e);class ED{constructor(t){to(this,"tickableContent"),to(this,"hasRightSpecificBarline"),to(this,"isLastMeasure"),to(this,"leftEnding"),to(this,"ending"),to(this,"rightEnding"),this.tickableContent=t.tickableContent,this.ending=t.ending,this.leftEnding=t.leftEnding,this.rightEnding=t.rightEnding,this.hasRightSpecificBarline=t.hasRightSpecificBarline,this.isLastMeasure=t.isLastMeasure}build(){this.addLeftAnchor(),this.addRightAnchor()}addLeftAnchor(){this.leftEnding===null||!Hg.A.isSame(this.leftEnding,this.ending)?this.addLeftInitialAnchor():this.addLeftContinueAnchor()}addLeftInitialAnchor(){const t=new Dc({location:jn.A.LEFT}),e=Hg.A.numbersToText(this.ending);t.setText(e),this.tickableContent.addMiddleEndingAnchor(t)}addLeftContinueAnchor(){const t=new Dc({location:jn.A.LEFT});t.setText(null),this.tickableContent.setLeftEndingAnchor(t)}addRightAnchor(){this.rightEnding===null||!Hg.A.isSame(this.ending,this.rightEnding)?this.addRightClosingAnchor():this.addRightContinueAnchor()}addRightClosingAnchor(){const t=new Dc({location:jn.A.RIGHT}),e=this.isRightClosed();t.setRightClosed(e),this.tickableContent.addMiddleEndingAnchor(t)}isRightClosed(){return!!(this.isLastMeasure||this.rightEnding!==null||this.hasRightSpecificBarline)}addRightContinueAnchor(){const t=new Dc({location:jn.A.RIGHT});t.setRightClosed(!1),this.tickableContent.setRightEndingAnchor(t)}}var Ls=b(346797),Oi=b(952818),DD=Object.defineProperty,CD=(s,t,e)=>t in s?DD(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Cc=(s,t,e)=>CD(s,typeof t!="symbol"?t+"":t,e);class TD{constructor(t,e,r,i){Cc(this,"tickableContent"),Cc(this,"tempoChanges"),Cc(this,"leftTempoChange"),Cc(this,"rightTempoChange"),this.tickableContent=t,this.tempoChanges=e,this.leftTempoChange=r,this.rightTempoChange=i}build(){this.addMiddleAnchors(),this.addLeftContinueAnchors(),this.addRightContinueAnchors()}addMiddleAnchors(){this.tempoChanges.sort(Oi.A.compareTimePosInc),this.tempoChanges.forEach(this.addMiddleAnchor,this)}addMiddleAnchor(t){const e=Ls.A.getTimePos(t),r=Ls.A.getType(t),i=Ls.A.getDpq(t);let a=null;Zr.A.isStart(r)&&(a=Ls.A.getTempoChangeUuid(t));const l=null,d=new un({type:r,placement:Ee.A.ABOVE,timePos:e,dpq:i,location:l,tempoChangeUuid:a});this.tickableContent.addMiddleTempoChangeAnchor(d)}addLeftContinueAnchors(){if(this.leftTempoChange!==null){const t=this.leftTempoChange,e=Ls.A.getType(t),r=Ls.A.getDpq(t),i=Ls.A.getLocation(t),a=Ls.A.getTempoChangeUuid(t),l=new un({type:e,placement:Ee.A.ABOVE,timePos:0,dpq:r,location:i,tempoChangeUuid:a});this.tickableContent.setLeftTempoChangeAnchor(l)}}addRightContinueAnchors(){if(this.rightTempoChange!==null){const t=this.rightTempoChange,e=Ls.A.getType(t),r=Ls.A.getDpq(t),i=Ls.A.getLocation(t),a=Ls.A.getTempoChangeUuid(t),l=Ls.A.getTimePos(t),d=new un({type:e,placement:Ee.A.ABOVE,timePos:l,dpq:r,location:i,tempoChangeUuid:a});this.tickableContent.setRightTempoChangeAnchor(d)}}}var RD=Object.defineProperty,ND=(s,t,e)=>t in s?RD(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,LD=(s,t,e)=>ND(s,typeof t!="symbol"?t+"":t,e);class MD{constructor(t,e){LD(this,"textNode");const r=t.getRepeatTimesFontOptions();this.textNode=t.createTextNode(`${e.toString()}x`,r),t.layoutData.greyRepeatNotations&&this.textNode.setColor(ir);const i={entityType:T.A.BARLINE_REPEAT_TIMES,nbTimes:e};this.textNode.setEventPayload(i)}setX(t){const e=this.textNode.getWidth();this.textNode.setX(t-e)}getChildRoot(){return this.textNode}}var OD=Object.defineProperty,BD=(s,t,e)=>t in s?OD(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Br=(s,t,e)=>BD(s,typeof t!="symbol"?t+"":t,e);class ID{constructor(t){Br(this,"drawingContext"),Br(this,"groupNode"),Br(this,"horizontalData",null),Br(this,"horizontalFormatter",null),Br(this,"middleTempoChangesAnchors",[]),Br(this,"leftTempoChangeAnchor",null),Br(this,"rightTempoChangeAnchor",null),Br(this,"middleEndingAnchors",[]),Br(this,"leftEndingAnchor",null),Br(this,"rightEndingAnchor",null),this.drawingContext=t,this.groupNode=this.drawingContext.createGroupNode()}getChildRoot(){return this.groupNode}setHorizontalFormatter(t){this.horizontalFormatter=t}formatHorizontal(t){if(this.horizontalFormatter===null)throw new Error("horizontalFormatter should not be null at this point");this.getAllTempoChangesAnchors().forEach(e=>this.formatEntityFromAnchorHorizontal(e,t)),this.getAllEndingsAnchors().forEach(e=>this.formatEndingFromAnchorHorizontal(e,t))}formatEntityHorizontal(t){const e=t.getTimePos(),r=t.getDpq(),i=this.horizontalFormatter;if(i===null)throw new Error("horizontalFormatter should not be null at this point");const a=i.getPosX(e,r);t.setX(a)}formatEntityFromAnchorHorizontal(t,e){const r=t.getTimePos(),i=t.getDpq(),a=t.getRangeEntity();if(a===null)return;const l=this.horizontalFormatter;if(l===null)throw new Error("horizontalFormatter should not be null at this point");const f=l.getPosX(r,i)+this.getChildRoot().getX()+e;t.isLeft()?a.setX1(f):t.isRight()&&a.setX2(f)}formatEndingFromAnchorHorizontal(t,e){const r=t.getTimePos(),i=t.getDpq(),a=t.getRangeEntity();if(a===null)return;const l=this.horizontalFormatter;if(l===null)throw new Error("horizontalFormatter should not be null at this point");const f=l.getPosX(r,i)+e,m=this.getChildRoot().getX(),S=l.getWidth();t.isLeft()&&!t.hasText()?a.setX1(f):t.isLeft()?a.setX1(f+m):t.isRight()&&a.setX2(f+m+S)}setX(t){this.groupNode.setX(t)}addMiddleTempoChangeAnchor(t){this.middleTempoChangesAnchors.push(t)}setLeftTempoChangeAnchor(t){this.leftTempoChangeAnchor=t}setRightTempoChangeAnchor(t){this.rightTempoChangeAnchor=t}hasRightTempoChangeAnchor(){return this.rightTempoChangeAnchor!==null}getRightTempoChangeAnchor(){return this.rightTempoChangeAnchor}hasLeftTempoChangeAnchor(){return this.leftTempoChangeAnchor!==null}getLeftTempoChangeAnchor(){return this.leftTempoChangeAnchor}getMiddleTempoChangesAnchors(){return this.middleTempoChangesAnchors}getAllTempoChangesAnchors(){const t=[];return this.hasLeftTempoChangeAnchor()&&t.push(this.getLeftTempoChangeAnchor()),t.push(...this.getMiddleTempoChangesAnchors()),this.hasRightTempoChangeAnchor()&&t.push(this.getRightTempoChangeAnchor()),t}hasLeftEndingAnchor(){return this.leftEndingAnchor!==null}getLeftEndingAnchor(){return this.leftEndingAnchor}setLeftEndingAnchor(t){this.leftEndingAnchor=t}hasRightEndingAnchor(){return this.rightEndingAnchor!==null}getRightEndingAnchor(){return this.rightEndingAnchor}setRightEndingAnchor(t){this.rightEndingAnchor=t}getMiddleEndingAnchors(){return this.middleEndingAnchors}addMiddleEndingAnchor(t){this.middleEndingAnchors.push(t)}getAllEndingsAnchors(){const t=[];return this.hasLeftEndingAnchor()&&t.push(this.getLeftEndingAnchor()),t.push(...this.getMiddleEndingAnchors()),this.hasRightEndingAnchor()&&t.push(this.getRightEndingAnchor()),t}}var nr=b(607801),FD=Object.defineProperty,UD=(s,t,e)=>t in s?FD(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,HD=(s,t,e)=>UD(s,typeof t!="symbol"?t+"":t,e);const _D=new Map([[nr.A.SEGNO,"segno"],[nr.A.CODA,"coda"]]);class GD{constructor(t,e){HD(this,"glyphNode");const r=XD(e);this.glyphNode=t.createGlyphNode(r),t.layoutData.greyRepeatNotations&&this.glyphNode.setColor(ir)}setX(t){const e=this.glyphNode.getWidth();this.glyphNode.setX(t-e/2)}getChildRoot(){return this.glyphNode}}function XD(s){const t=_D.get(s);if(!t)throw new Error(`Unsupported jump tag type: ${s}`);return t}var WD=Object.defineProperty,zD=(s,t,e)=>t in s?WD(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,_g=(s,t,e)=>zD(s,typeof t!="symbol"?t+"":t,e);const YD=.5;class kD{constructor(t){_g(this,"groupNode"),_g(this,"width",0),_g(this,"children",[]),this.groupNode=t.createGroupNode()}setX(t){this.groupNode.setX(t-this.width)}addChild(t){const e=t.getChildRoot(),r=e.getLocalBBox();if(r===null)throw new Error("bbox is null");this.width>0&&(this.width+=YD,this.width-=r.minX),e.setX(this.width),e.setY(0),this.width+=r.maxX,v(this.groupNode,e),this.children.push(t)}getChildRoot(){return this.groupNode}}var qD=Object.defineProperty,VD=(s,t,e)=>t in s?qD(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,QD=(s,t,e)=>VD(s,typeof t!="symbol"?t+"":t,e);const KD=new Map([[nr.A.DALSEGNO,"dalSegno"],[nr.A.DACAPO,"daCapo"]]);class JD{constructor(t,e){QD(this,"glyphNode");const r=$D(e);this.glyphNode=t.createGlyphNode(r),t.layoutData.greyRepeatNotations&&this.glyphNode.setColor(ir)}getChildRoot(){return this.glyphNode}}function $D(s){const t=KD.get(s);if(!t)throw new Error(`Unsupported jump call type: ${s}`);return t}var ZD=Object.defineProperty,jD=(s,t,e)=>t in s?ZD(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,tC=(s,t,e)=>jD(s,typeof t!="symbol"?t+"":t,e);class Nm{constructor(t,e){tC(this,"textNode");const r=t.getJumpFontOptions();this.textNode=t.createTextNode(e,r),t.layoutData.greyRepeatNotations&&this.textNode.setColor(ir)}getChildRoot(){return this.textNode}}const eC=new Map([[nr.A.FINE,"Fine"],[nr.A.TOCODA,"To Coda"]]),sC=new Map([[nr.A.FINE," al Fine"],[nr.A.TOCODA," al Coda"]]),rC=new Set([nr.A.DALSEGNO,nr.A.DACAPO]);function iC(s,t,e){const r=new kD(s);if(nC(t)){const i=new JD(s,t);r.addChild(i);const a=e&&sC.get(e);if(a){const l=new Nm(s,a);r.addChild(l)}}else{const i=eC.get(t);if(i!==void 0){const a=new Nm(s,i);r.addChild(a)}else throw nr.A.raiseBadJumpCall(t)}return r}function nC(s){return rC.has(s)}var oC=b(777345);const ts=.8;var aC=Object.defineProperty,hC=(s,t,e)=>t in s?aC(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,lC=(s,t,e)=>hC(s,typeof t!="symbol"?t+"":t,e);const cC="textBlackNoteShortStem",uC="textCont8thBeamShortStem",dC="textBlackNoteFrac8thShortStem";class Lm{constructor(t){lC(this,"groupNode"),this.groupNode=t.createGroupNode();const e=[],r=t.createGlyphNode(cC,ts);v(this.groupNode,r),e.push(r);const i=t.createGlyphNode(uC,ts);v(this.groupNode,i),e.push(i);const a=t.createGlyphNode(dC,ts);v(this.groupNode,a),e.push(a),fC(e)}getChildRoot(){return this.groupNode}}function fC(s){let t=0;s.forEach((e,r)=>{const i=e.getLocalBBox();r>0&&(t-=i.minX),e.setX(t),t+=i.maxX})}var gC=Object.defineProperty,pC=(s,t,e)=>t in s?gC(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,mC=(s,t,e)=>pC(s,typeof t!="symbol"?t+"":t,e);const yC="textBlackNoteShortStem",AC="note8thUp",vC="textTupletBracketStartLongStem",SC="textTupletBracketEndLongStem",wC="textTuplet3LongStem",xC=.3*ts;class bC{constructor(t){mC(this,"groupNode"),this.groupNode=t.createGroupNode();const e=[],r=t.createGlyphNode(vC,ts);v(this.groupNode,r),e.push(r);const i=t.createGlyphNode(wC,ts);v(this.groupNode,i),e.push(i);const a=t.createGlyphNode(SC,ts);v(this.groupNode,a),e.push(a);const l=PC(e),d=t.createGlyphNode(yC,ts),f=d.getLocalBBox().maxX;v(this.groupNode,d);const m=t.createGlyphNode(AC,ts);v(this.groupNode,m),m.setX(l-f)}getChildRoot(){return this.groupNode}}function PC(s){let t=0;return s.forEach((e,r)=>{const i=e.getLocalBBox();r>0&&(t+=-i.minX+xC),e.setX(t),t+=i.maxX}),t}var EC=Object.defineProperty,DC=(s,t,e)=>t in s?EC(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,CC=(s,t,e)=>DC(s,typeof t!="symbol"?t+"":t,e);const TC="swing",RC="=";class NC{constructor(t,e){CC(this,"groupNode");const r=oC.default.isSwinging(e);this.groupNode=t.createGroupNode(),this.groupNode.setLabel(TC);const i=[],l=new Lm(t).getChildRoot();i.push(l),v(this.groupNode,l);const d=t.getTempoFontOptions(),f=t.createTextNode(RC,d);f.setY(0),i.push(f),v(this.groupNode,f);let m;r?m=new bC(t):m=new Lm(t);const S=m.getChildRoot();i.push(S),v(this.groupNode,S),LC(i);const w={entityType:T.A.SWING,swing:r};this.groupNode.setEventPayload(w)}getChildRoot(){return this.groupNode}}function LC(s){const t=ts/2;let e=0;s.forEach(r=>{const i=r.getLocalBBox();if(i===null)throw new Error("bbox is null");e-=i.minX,r.setX(e),e+=i.maxX,e+=t})}var Gg=b(110976),MC=Object.defineProperty,OC=(s,t,e)=>t in s?MC(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,BC=(s,t,e)=>OC(s,typeof t!="symbol"?t+"":t,e);const IC="tempo",FC="metAugmentationDot";class UC{constructor(t,e){BC(this,"groupNode"),this.groupNode=t.createGroupNode(),this.groupNode.setLabel(IC);const r=[],i=Gg.default.getDurationType(e),a=HC(i),l=t.createGlyphNode(a,ts),d=_C(i);l.setY(d),r.push(l),v(this.groupNode,l);const f=Gg.default.getNbDots(e);if(f>0){const M=d+ts/4;for(let H=0;H<f;H++){const $=t.createGlyphNode(FC,ts);$.setY(M),r.push($),v(this.groupNode,$)}}const m=Gg.default.getBpm(e),w=`= ${m.toString()}`,x=t.getTempoFontOptions(),D=t.createTextNode(w,x);D.setY(0),r.push(D),v(this.groupNode,D),GC(r);const L={entityType:T.A.TEMPO,bpm:m,durationType:i,nbDots:f};this.groupNode.setEventPayload(L)}getChildRoot(){return this.groupNode}}function HC(s){const t="metNote",e=Ji.A.fromDurationType(s),i=s===be.default.FULL?"":"Up";return t+e+i}function _C(s){return s===be.default.FULL?-ts/2:-ts/4}function GC(s){const t=ts/2;let e=0;s.forEach(r=>{const i=r.getLocalBBox();if(i===null)throw new Error("bbox is null");e-=i.minX,r.setX(e),e+=i.maxX,e+=t})}var XC=Object.defineProperty,WC=(s,t,e)=>t in s?XC(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Xg=(s,t,e)=>WC(s,typeof t!="symbol"?t+"":t,e);const zC="metronome",YC=", ";class kC{constructor(t,e,r){Xg(this,"groupNode"),Xg(this,"tempo",null),Xg(this,"swing",null),this.groupNode=t.createGroupNode(),this.groupNode.setLabel(zC);const i=[];if(e){const a=new UC(t,e),l=a.getChildRoot();v(this.groupNode,l),i.push(l),this.tempo=a}if(e&&r){const a=t.getTempoFontOptions(),l=t.createTextNode(YC,a);l.setY(0),i.push(l),v(this.groupNode,l)}if(r){const a=new NC(t,r),l=a.getChildRoot();v(this.groupNode,l),i.push(l),this.swing=a}qC(i)}setX(t){this.groupNode.setX(t)}getChildRoot(){return this.groupNode}}function qC(s){let t=0;s.forEach((e,r)=>{const i=e.getLocalBBox();if(i===null)throw new Error("bbox is null");r>0&&(t-=i.minX,e.setX(t)),t+=i.maxX})}var Mm=b(561248),VC=Object.defineProperty,QC=(s,t,e)=>t in s?VC(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,KC=(s,t,e)=>QC(s,typeof t!="symbol"?t+"":t,e);class JC{constructor(t,e,r){KC(this,"groupNode"),this.groupNode=t.createGroupNode();const i=t.getTextEnclosureThickness(),a=t.createLineNode();a.setWidth(i),a.setY(0),a.setX2(e),v(this.groupNode,a);const l=t.createLineNode();l.setWidth(i),l.setY(0-r),l.setX2(e),v(this.groupNode,l);const d=t.createLineNode();d.setWidth(i),d.setY2(0-r),v(this.groupNode,d);const f=t.createLineNode();f.setWidth(i),f.setX(e),f.setY2(0-r),v(this.groupNode,f)}getChildRoot(){return this.groupNode}setX(t){this.groupNode.setX(t)}setY(t){this.groupNode.setY(t)}}var $C=Object.defineProperty,ZC=(s,t,e)=>t in s?$C(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Tc=(s,t,e)=>ZC(s,typeof t!="symbol"?t+"":t,e);class jC{constructor(t,e){Tc(this,"rehearsalData"),Tc(this,"groupNode"),Tc(this,"textNode"),Tc(this,"padding"),this.rehearsalData=e,this.groupNode=t.createGroupNode(),this.padding=t.getRehearsalPadding();const r=t.getRehearsalFontOptions(),i=Mm.A.getText(e);this.textNode=t.createTextNode(i,r),this.textNode.setX(this.padding),this.textNode.setY(-this.padding*.6),v(this.groupNode,this.textNode);const a=this.textNode.getWidth()+this.padding*2,l=r.fontSize,d=new JC(t,a,l);d.setY(0),v(this.groupNode,d.getChildRoot());const f={entityType:T.A.REHEARSAL,rehearsalData:e};this.groupNode.setEventPayload(f)}getChildRoot(){return this.groupNode}setX(t){this.groupNode.setX(t)}setMeasureNumber(t){Mm.A.isMeasureNumber(this.rehearsalData)&&this.textNode.setText(t.toString())}}function tT(s,t){const e=new ID(s);eT(e,t),t.ending&&sT(e,t);const r=new Pc(s,e,{measureUuid:t.measureUuid,nextMeasureUuid:t.nextMeasureUuid,systemBreakBefore:t.systemBreakBefore,systemBreakAfter:t.systemBreakAfter,pageBreakBefore:t.pageBreakBefore,pageBreakAfter:t.pageBreakAfter});if(t.jumpTag){const a=new GD(s,t.jumpTag);r.setJumpTag(a)}if(t.jumpCall){const a=iC(s,t.jumpCall,t.formerJumpCall);r.setJumpCall(a)}if(t.barlineRepeatNbTimes){const a=new MD(s,t.barlineRepeatNbTimes-1);r.setBarlineRepeatTimes(a)}let i=t.tempo;if(s.hideTempoMarkings()&&(i=null),i||t.swing){const a=new kC(s,i,t.swing);r.setMetronome(a)}if(t.rehearsalMark){const a=new jC(s,t.rehearsalMark);r.setRehearsal(a)}return r}function eT(s,t){new TD(s,t.middleTempoChanges,t.leftTempoChange,t.rightTempoChange).build()}function sT(s,t){const e=t.nextMeasureUuid===null;new ED({tickableContent:s,leftEnding:t.leftEnding,ending:t.ending,rightEnding:t.rightEnding,hasRightSpecificBarline:t.hasRightSpecificBarline,isLastMeasure:e}).build()}var rT=Object.defineProperty,iT=Object.defineProperties,nT=Object.getOwnPropertyDescriptors,Om=Object.getOwnPropertySymbols,oT=Object.prototype.hasOwnProperty,aT=Object.prototype.propertyIsEnumerable,Wg=(s,t,e)=>t in s?rT(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,hT=(s,t)=>{for(var e in t||(t={}))oT.call(t,e)&&Wg(s,e,t[e]);if(Om)for(var e of Om(t))aT.call(t,e)&&Wg(s,e,t[e]);return s},lT=(s,t)=>iT(s,nT(t)),zg=(s,t,e)=>Wg(s,typeof t!="symbol"?t+"":t,e);class Yg{constructor(t){zg(this,"measureUuid"),zg(this,"nextMeasureUuid",null),zg(this,"data",null),this.measureUuid=t}setData(t){this.destroy(),this.data=t}setNextMeasureUuid(t){this.nextMeasureUuid=t}getGlobalMeasure(){return this.data instanceof Pc?this.data:null}getOrCreateGlobalMeasure(t){if(this.data instanceof Pc)return this.data;if(this.data===null)throw new Error(`Data missing to render global measure at measure ${this.measureUuid}`);return this.data=tT(t,lT(hT({},this.data),{nextMeasureUuid:this.nextMeasureUuid})),this.data}destroy(){this.data instanceof Pc&&this.data.destroy(),this.data=null}}var Bm=b(398719),cT=b(287719),uT=b(414787),dT=b(197510),Im=b(316197),fT=b(724926),Wa=b(860716),W=b(123491),gT=b(936945),Fm=b(794741),Um=b(511890),Rc=b(104907),Hm=b(762691),Nc=b(129283),_m=b(369790),pT=b(579283);const mT=5,yT="TUpper";function kg(s,t,e){const[r]=s,i=AT(r,e),a=vT({isFullMeasureRest:i,mainNote:r}),l=ST(r),d=W.default.isRest(r),f=W.default.hasBeam(r)||W.default.hasTremoloSide(r),m=W.default.getVoiceIdx(r),S=W.default.hasArpeggiate(r),w=!!r.isSlash,x=W.default.isSlashedGrace(r),D=!!r.isRhythmic,L=W.default.hasUnpitched(r),M=wT({isFullMeasureRest:i,mainNote:r,attrs:t}),H=PT({mainNote:r,hasBeam:f}),$=W.default.getStaffIdx(r),lt=t.getStaffDetails($);if(!lt)throw new Error("Staff details not found");const gt=ms.A.createFromStaffDetails(lt),yt=ms.A.isKodalyStaff(gt),dt=ms.A.isRecorderTabStaff(gt),At=ms.A.getDisplayedNbStaffLines(gt),Jt=t.getClefAtTimePos($,e.timePos),re=RT({isKodalyStaff:yt,isRest:d,quarterBaseDuration:M,isRecorderTabStaff:dt}),ds=ET({notes:s,isRest:d,quarterBaseDuration:M,displayedNbStaffLines:At,isRecorderTabStaff:dt,isKodalyStaff:yt,clef:Jt,hasFakeLine:re},e),ws=ds.lines;s=ds.notes;const xh=OT({notes:s,lines:ws}),_p=BT(r),{tieStops:bh,tieStarts:bn,tieStartsDirections:TX}=IT({lines:ws,notes:s}),$A=t.getKey($);if(!$A)throw new Error("Key not found");const RX=FT({notes:s,lines:ws,hasFakeLine:re,key:$A}),NX=W.default.getFullArticulationsList(r).filter(W.default.isValidArticulation),LX=W.default.getOrnamentsListForDrawer(r),ZA=XT({notes:s,staffDetails:lt},e),MX=W.default.isGraceNote(r),OX=VT(r),{glissandoStarts:BX,glissandoStops:IX}=QT({notes:s,lines:ws}),{slideStarts:FX,slideStops:UX}=$T({notes:s,lines:ws}),HX=Hm.default.getGlobalCssClassesStr(r),{hammerOnPullOffStarts:_X,hammerOnPullOffStops:GX}=t0({notes:s,frets:ZA}),Gp=t.getTranspose($);if(!Gp)throw new Error("Transpose not found");const XX=e0({notes:s,staffDetails:lt,mainNote:r,transpose:Gp}),WX=r0({mainNote:r,isRest:d}),zX=i0({isRecorderTabStaff:dt,mainNote:r,staffDetails:lt,transpose:Gp}),YX=n0({isRecorderTabStaff:dt,mainNote:r,staffDetails:lt}),kX=W.default.hasTremoloStart(r),qX=W.default.hasTremoloStop(r),VX=W.default.getTimeModif(r),QX=W.default.getTupletStarts(r),KX=W.default.getTupletStops(r);let jA=null;W.default.hasSlurStart(r)&&(jA=W.default.getSlur(r));const JX=W.default.hasSlurStop(r),$X=WT(s),ZX=zT(s),jX={lines:ws,nbDots:a,duration:l,isRest:d,hasBeam:f,voiceIdx:m,hasArpeggio:S,isSlash:w,isRhythmic:D,isUnpitched:L,quarterBaseDuration:M,beams:H,hasFlagDash:x,stemStrategy:e.stemStrategy,staffIdx:$,noteIdx:e.noteIdx,accidentals:xh,tieStops:bh,tieStarts:bn,tieStartsDirections:TX,heads:RX,staffData:gt,technical:_p,articulations:NX,ornaments:LX,frets:ZA,isGrace:MX,lyrics:OX,glissandoStarts:BX,glissandoStops:IX,slideStarts:FX,slideStops:UX,globalCssClassesStr:HX,hammerOnPullOffStarts:_X,hammerOnPullOffStops:GX,fingerings:XX,restColor:WX,fingeringDiagramFormula:zX,fingeringDisplayType:YX,hasTremoloStart:kX,hasTremoloStop:qX,timeModif:VX,tupletStarts:QX,tupletStops:KX,slurStart:jA,hasSlurStop:JX,bends:$X,preBends:ZX};return new Ol(jX)}function AT(s,t){return W.default.isRest(s)?!!(W.default.isFullMeasureRest(s)||t.isAlone&&!t.isPickup):!1}function vT(s){return s.isFullMeasureRest?0:W.default.getNbDots(s.mainNote)}function ST(s){return W.default.hasDuration(s)?W.default.getFloatingDuration(s):null}function wT(s){return W.default.isGraceNote(s.mainNote)?xT(s.mainNote):bT(s)}function xT(s){const t=W.default.getDurationType(s);return be.default.toQuarterDuration(t)}function bT(s){if(s.isFullMeasureRest)return be.default.toQuarterDuration(be.default.FULL);{const t=s.attrs.getDpq(),e=W.default.getNormalQuarterDuration(s.mainNote,t);let r=Vn.default.extractBaseDuration(e);return W.default.hasTremoloSide(s.mainNote)&&(r*=2),r}}function PT(s){if(s.hasBeam){let t=W.default.getBeams(s.mainNote);if(t=t.map(Es.A.copy),t.sort(Es.A.compare),W.default.hasTremoloSide(s.mainNote)){let e=0;t.length>0&&(t.splice(0,1),e=t.length);const{nbBeam:r,type:i}=W.default.getOrnamentOpts(s.mainNote,Sr.A.TREMOLO),a=cT.A.createFromTremolo(r,i,e);t.push(...a),t.forEach(Es.A.setNumber)}return t}return null}function ET(s,t){const e=s.notes.map(i=>DT(i,s,t));s.hasFakeLine&&e.push(4);const r=s.notes.slice();return NT(r,e),{lines:e,notes:r}}function DT(s,t,e){return W.default.isRest(s)&&typeof s["display-octave"]=="undefined"?CT(t,e):TT(s,t)}function CT(s,t){const e=s.quarterBaseDuration;let r;if(s.isRecorderTabStaff)return null;if(s.isKodalyStaff)return e===be.default.toQuarterDuration(be.default.FULL)?7:6;const i=s.displayedNbStaffLines;return e===be.default.toQuarterDuration(be.default.FULL)?i===5?r=4:i===3||i===1?r=3:r=4:i===5||i===1?r=3:i===3?r=1:r=3,zt.A.isUp(t.stemStrategy)?r+=2:zt.A.isDown(t.stemStrategy)&&(r-=2),r}function TT(s,t){if(W.default.hasUnpitched(s)){const e=t.displayedNbStaffLines,r=W.default.getUnpitched(s);return uT.A.pitchToLine(r,e)}else{if(t.isRecorderTabStaff)return null;if(t.isKodalyStaff)return 1.5;{let e;return W.default.isRest(s)?e={step:s["display-step"],octave:s["display-octave"]}:e=s.pitch,Ht.default.pitchToLine(e,t.clef)}}}function RT(s){return s.isKodalyStaff&&!s.isRest&&s.quarterBaseDuration>1||s.isRecorderTabStaff}function NT(s,t){const e=[];for(;s.length>0;){const r=s.shift(),i=t.shift();e.push({note:r,line:i})}for(e.sort(LT);e.length>0;){const r=e.shift();s.push(r.note),t.push(r.line)}}function LT(s,t){return MT(s.line,t.line)}function MT(s,t){return s===null||t===null?0:t-s}function OT(s){const t=[];return s.notes.forEach(function(e,r){const i=s.lines[r];if(i===null)return;let a;if(W.default.hasCourtesyAccidental(e)){const l=W.default.getAlter(e);a={accidental:Ht.default.alterToAccidental(l),line:i,parentheses:!0},t.push(a)}else W.default.hasAccidental(e)&&(a={accidental:W.default.getAccidental(e),line:i,parentheses:!1},W.default.hasAccidentalColor(e)&&(a.color=W.default.getAccidentalColor(e)),t.push(a))}),t}function BT(s){const t=W.default.getTechnicalList(s).filter(Ae.default.isValid);if(W.default.hasHarmonic(s)){const e=W.default.getHarmonic(s),r=Wa.default.getType(e);r===$s.default.NATURAL_SOUNDING&&t.push(r)}return t}function IT(s){const t=[],e=[],r=[];return s.notes.forEach(function(i,a){const l=s.lines[a];if(l===null)throw new Error("Line should not be null when extracting ties");if(W.default.hasTieStart(i)){e.push(l);const d=W.default.getTieDirection(i);r.push(d)}W.default.hasTieStop(i)&&t.push(l)}),{tieStops:t,tieStarts:e,tieStartsDirections:r}}function FT(s){const t=[];return s.notes.forEach(function(e,r){const i=Hm.default.getHeadCssClassesStr(e);let a=s.lines[r];s.hasFakeLine&&(a=s.lines[r+1]);const l=W.default.getHead(e),d=W.default.hasHeadParentheses(e),f=W.default.isShapeNote(e),m=W.default.isOutOfTessiture(e),S=_T(e),w=UT(e),x=HT(e),D=W.default.hasTieStop(e),L={line:a,notehead:l,cssClassesStr:i,hasParentheses:d,isTieStop:D,isShapeNote:f,color:S,isHarmonicArtificialTouching:w,isHarmonicNaturalTouching:x,isOutOfTessiture:m,isTemplateLocked:!1};if(W.default.hasPitch(e)){const M=W.default.getPitch(e);L.step=Ht.default.getStep(M),L.alter=Ht.default.getAlter(M),L.octave=Ht.default.getOctave(M)}if(W.default.isTemplateLocked(e)&&(L.isTemplateLocked=!0),W.default.hasPitch(e)){const M=W.default.getPitch(e),H=GT(M,s);L.cStep=Ht.default.getStep(H),L.cAlter=Ht.default.getAlter(H)}t.push(L)}),t}function UT(s){if(!W.default.hasHarmonic(s))return!1;const t=W.default.getHarmonic(s);return Wa.default.getType(t)===$s.default.ARTIFICIAL_TOUCHING}function HT(s){if(!W.default.hasHarmonic(s))return!1;const t=W.default.getHarmonic(s);return Wa.default.getType(t)===$s.default.NATURAL_TOUCHING}function _T(s){return W.default.hasColor(s)?W.default.getColor(s):null}function GT(s,t){s=Ht.default.copy(s),Ht.default.setOctave(s,4);const e=Jr.default.getTonic(t.key);Ht.default.setOctave(e,4);const r=Ht.default.create(4,"C"),i=Ht.default.getTransposeDiff(r,e);return Ht.default.transpose(s,i)}function XT(s,t){return s.notes.map(function(e){if(W.default.hasFretData(e)){const r=W.default.getFretData(e),i={fretNumber:r.fret,string:r.string,notehead:W.default.getHead(e)};if(W.default.hasTieStop(e)&&(i.isGreyed=!0,t.noteIdx===0?i.hasParenthesis=!0:i.isHidden=!0),W.default.getHead(e)===ot.A.X&&(i.isDeadNote=!0),W.default.hasHarmonic(e)){const l=W.default.getHarmonic(e),d=Wa.default.getType(l);if(d===$s.default.NATURAL_TOUCHING)i.isNaturalHarmonic=!0;else if(d===$s.default.ARTIFICIAL_BASE){const f=YT(e,s);f!==null&&(i.artificialHarmonicTouchingFretNumber=f)}}return W.default.hasHeadParentheses(e)&&(i.hasParenthesis=!0),i}else return null})}function WT(s){return s.map(t=>W.default.hasBend(t)?W.default.getBend(t):null)}function zT(s){return s.map(t=>W.default.hasPreBend(t)?W.default.getPreBend(t):null)}function YT(s,t){const e=t.notes.filter(kT,s);if(e.length===0)return null;e.sort(qT);const[r]=e,i=W.default.getFretData(s),a=W.default.getPitch(r);return(0,pT.default)(a,i.string,t.staffDetails)}function kT(s){if(!W.default.hasHarmonic(s))return!1;const t=W.default.getHarmonic(s);if(Wa.default.getType(t)!==$s.default.ARTIFICIAL_TOUCHING)return!1;const r=W.default.getPitch(s),i=this,a=W.default.getPitch(i);return Ht.default.naiveComparePitch(r,a)>0}function qT(s,t){const e=W.default.getPitch(s),r=W.default.getPitch(t);return Ht.default.naiveComparePitch(e,r)}function VT(s){let t=W.default.getLyrics(s);return t=t.map(Ne.default.copy),t.sort(Ne.default.compare),t}function QT(s){const t=[],e=[];return s.notes.forEach(function(r,i){const a=s.lines[i];t.push(...KT(r,a)),e.push(...JT(r,a))}),{glissandoStarts:t,glissandoStops:e}}function KT(s,t){return W.default.hasGlissandoType(s,Nc.default.START)&&t!==null?W.default.getGlissandosType(s,Nc.default.START).map(function(r){return{line:t,number:Im.default.getNumber(r)}}):[]}function JT(s,t){return W.default.hasGlissandoType(s,Nc.default.STOP)&&t!==null?W.default.getGlissandosType(s,Nc.default.STOP).map(function(r){return{line:t,number:Im.default.getNumber(r)}}):[]}function $T(s){const t=[],e=[];return s.notes.forEach(function(r,i){const a=s.lines[i];a!==null&&(t.push(...ZT(r,a)),e.push(...jT(r,a)))}),{slideStarts:t,slideStops:e}}function ZT(s,t){return W.default.hasSlideStart(s)?W.default.getSlideStarts(s).map(function(r){const i={line:t,number:Um.default.getNumber(r)};if(W.default.hasFretData(s)){const a=W.default.getFretData(s);i.string=a.string,i.fret=a.fret}return i}):[]}function jT(s,t){return W.default.hasSlideStop(s)?W.default.getSlideStops(s).map(function(r){const i={line:t,number:Um.default.getNumber(r)};if(W.default.hasFretData(s)){const a=W.default.getFretData(s);i.string=a.string,i.fret=a.fret}return i}):[]}function t0(s){const t=[],e=[];return s.notes.forEach(function(r,i){const a=s.frets[i];if(a!==null){const l=Gm(_m.A.START);(W.default.hasTechnical(r,Ae.default.HAMMER_ON,l)||W.default.hasTechnical(r,Ae.default.PULL_OFF,l))&&t.push(a.string);const d=Gm(_m.A.STOP);(W.default.hasTechnical(r,Ae.default.HAMMER_ON,d)||W.default.hasTechnical(r,Ae.default.PULL_OFF,d))&&e.push(a.string)}}),{hammerOnPullOffStarts:t,hammerOnPullOffStops:e}}function Gm(s){return{hammerOnPullOff:fT.A.create(s)}}function e0(s){const t=s.notes.filter(W.default.hasFingering).flatMap(s0);if(t.length===0&&Rc.default.hasBrassFingering(s.staffDetails)&&W.default.hasPitch(s.mainNote)){let e=W.default.getPitch(s.mainNote);e=Ht.default.transpose(e,s.transpose,!1);const i=Rc.default.getBrassFingering(s.staffDetails),a=(0,gT.A)(e,i);typeof a!="undefined"&&t.push(a)}return t}function s0(s){const t=W.default.getFingerings(s);return t.length===0&&W.default.hasFretData(s)&&t[0]===mT?[yT]:t}function r0(s){return s.isRest&&W.default.hasColor(s.mainNote)?W.default.getColor(s.mainNote):null}function i0(s){if(!s.isRecorderTabStaff||!W.default.hasPitch(s.mainNote))return null;const t=Rc.default.getRecorderTabs(s.staffDetails),e=Fm.A.getType(t);let r=W.default.getPitch(s.mainNote);return r=Ht.default.transpose(r,s.transpose),(0,dT.A)(r,e)}function n0(s){if(!s.isRecorderTabStaff||!W.default.hasPitch(s.mainNote))return null;const t=Rc.default.getRecorderTabs(s.staffDetails);return Fm.A.getDisplayType(t)}var o0=Object.defineProperty,a0=(s,t,e)=>t in s?o0(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,qg=(s,t,e)=>a0(s,typeof t!="symbol"?t+"":t,e);class Xm{constructor(t,e){qg(this,"voices",new Map),qg(this,"attrs"),qg(this,"displayedTime"),this.attrs=new Bm.A(t.measureJson,{isConcertPitch:!!e.isConcertPitch}),this._fillVoices(t.voices),this.displayedTime=t.displayedTime}_fillVoices(t){const e={stemStrategy:zt.A.AUTO,noteIdx:0,isAlone:!1,isPickup:!1,timePos:0};for(const r in t){const i=Number.parseInt(r,10),{firstChord:a,lastChord:l}=t[r];this.voices.set(i,{first:kg(a,this.attrs,e),last:kg(l,this.attrs,e)})}}getFirstNoteDisplayData(t){const e=this.voices.get(t);return e?e.first:null}getLastNoteDisplayData(t){const e=this.voices.get(t);return e?e.last:null}getAttrs(){return this.attrs}getDisplayedTime(){return this.displayedTime}}var h0=b(925368),ei=b(518558),l0=b(857579),Yt=b(701387),si=b(555172),Wm=b(403006),c0=(s=>(s.NATURAL="accidentalNatural",s.SHARP="accidentalSharp",s.FLAT="accidentalFlat",s))(c0||{});function u0(s){const t=Jr.default.getFifths(s.key),e=d0(t);if(t===0&&s.previousKey!==null){const i=Jr.default.getFifths(s.previousKey);if(i===0)return[];let a=Wm.A.getLines(s.clef,i);return a=zm(a,i),Vg(a,e)}else if(t===0&&s.isFirstMeasure&&s.displayFirstKey)return Vg([3],"accidentalNatural",.2);let r=Wm.A.getLines(s.clef,t);return r=zm(r,t),Vg(r,e)}function zm(s,t){const e=Math.abs(t);return s.slice(0,e)}function d0(s){if(s===0)return"accidentalNatural";if(s>0)return"accidentalSharp";if(s<0)return"accidentalFlat";throw new Error(`Invalid fifths value: ${s}`)}function Vg(s,t,e){return s.map(r=>({glyphId:t,line:r,opacity:e}))}function Ym(s){const t=u0({previousKey:s.previousKeyJson,key:s.keyJson,clef:s.clefJson,displayFirstKey:s.drawingContext.displayFirstKey(),isFirstMeasure:s.isFirstMeasure||!1});return t.length===0?null:new jl(s.drawingContext,t,s.staffData,s.side)}const km=.1,f0="time";function g0(s){if(s==="common")return"timeSigCommon";if(s==="cut")return"timeSigCutCommon";throw new Error(`Invalid symbol: ${s}`)}function Qg(s){const t=p0(s.drawingContext,s.timeJson);return new Sc(t,s.staffData,s.side)}function p0(s,t){if(ei.default.hasSymbol(t)){const e=ei.default.getSymbol(t),r=g0(e);return s.createGlyphNode(r)}else{const e=s.createGroupNode();e.setLabel(f0);let r=0;const i=ei.default.getNbBeats(t),a=qm(s,i);a.setY(-1),v(e,a);const l=a.getLocalBBox();if(l===null)throw new Error("nbBeatsBbox is null");r=Math.max(r,-l.minX);const d=ei.default.getBeatType(t),f=qm(s,d);f.setY(1),v(e,f);const m=f.getLocalBBox();if(m===null)throw new Error("beatTypeBbox is null");return r=Math.max(r,-m.minX),a.setX(r),f.setX(r),e}}function qm(s,t){const r=t.toString().split("").map(a=>s.createGlyphNode(`timeSig${a}`));m0(r);const i=s.createGroupNode();return r.forEach(a=>v(i,a)),i}function m0(s){const e=y0(s)/2;let r=0;s.forEach((i,a)=>{a>0&&(r+=km),r-=i.glyph.minX,i.setX(r-e),r+=i.glyph.maxX})}function y0(s){let t=0;return s.forEach((e,r)=>{r>0&&(t+=km),t-=e.glyph.minX,t+=e.glyph.maxX}),t}var A0=Object.defineProperty,v0=(s,t,e)=>t in s?A0(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Kg=(s,t,e)=>v0(s,typeof t!="symbol"?t+"":t,e);const S0=.5,w0="attributes";class za{constructor(t){Kg(this,"group"),Kg(this,"width",0),Kg(this,"children",[]),this.group=t.createGroupNode(),this.group.setLabel(w0)}addItem(t){this.width!==0&&(this.width+=S0);const e=t.getChildRoot(),r=e.getLocalBBox();if(r===null)throw new Error("bbox is null");this.width-=r.minX,e.setX(this.width),this.width+=r.maxX,v(this.group,e),this.children.push(t)}getChildRoot(){return this.group}getWidth(){const t=this.group.getLocalBBox();if(t===null)throw new Error("bbox is null");return t.maxX-t.minX}setX(t){this.group.setX(t)}destroy(){this.group.destroy()}}function x0(s){if(s.staffData.type===Zt.A.RECORDER_TAB)return null;let t=null;if(s.nextAttr===null)return t;const e=s.nextAttr.getClef(s.staffIdx);if(e===null)throw new Error("Clef is missing");if(s.rightBarline!==null&&(si.A.isFinalBarline(s.rightBarline)||si.A.hasRepeatBackward(s.rightBarline))){const d=s.attr.getLastClef(s.staffIdx);if(d===null)throw new Error("Clef is missing");if(!rr.default.isSame(d,e)){t=Jg(t,s.drawingContext);const f=new Li(s.drawingContext,e,s.staffData);t.addItem(f),f.fillEventPayload("right")}}const r=s.attr.getKey(s.staffIdx),i=s.nextAttr.getKey(s.staffIdx);if(r===null||i===null)throw new Error("Key is missing");if(!Jr.default.isSame(r,i)){t=Jg(t,s.drawingContext);const d=Ym({drawingContext:s.drawingContext,staffData:s.staffData,keyJson:i,previousKeyJson:r,clefJson:e,side:"right"});d!==null&&t.addItem(d)}const a=s.displayedTime,l=s.nextDisplayTime;if(a===null||l===null)throw new Error("Time is missing");if(!ei.default.isSame(a,l)){t=Jg(t,s.drawingContext);const d=Qg({drawingContext:s.drawingContext,timeJson:l,staffData:s.staffData,side:"right"});t.addItem(d)}return t}function Jg(s,t){return s||new za(t)}function b0(s){if(s.staffData.type===Zt.A.RECORDER_TAB)return null;let t=null;if(s.nextAttr===null||s.rightBarline!==null&&(si.A.isFinalBarline(s.rightBarline)||si.A.hasRepeatBackward(s.rightBarline)))return t;const e=s.attr.getLastClef(s.staffIdx),r=s.nextAttr.getClef(s.staffIdx);if(e===null||r===null)throw new Error("Clef is missing");if(!rr.default.isSame(e,r)){t=P0(t,s.drawingContext);const i=new Li(s.drawingContext,r,s.staffData);t.addItem(i),i.fillEventPayload("right")}return t}function P0(s,t){return s||new za(t)}function E0(s,t){s.tickableContent.voices.forEach(e=>{if(e instanceof Bt){const r=e.getVoiceUuid();e.notes.forEach(a=>{const l=a.getDisplayData();if(l.hasSlurStop()){const f=new Ti({slurData:null,measure:s,note:a,isExternal:!1,voiceUuid:r});e.addMiddleSlurAnchor(f)}const d=l.getSlurStart();if(d!==null){const f=new Ti({slurData:d,measure:s,note:a,isExternal:!1,voiceUuid:r});e.addMiddleSlurAnchor(f)}});const i=e.getVoiceIdx();if(Yt.default.hasLeftSlur(t,i)){const a=e.notes[0],l=Yt.default.getLeftSlur(t,i),d=new Ti({slurData:l,measure:s,note:a,isExternal:!0,voiceUuid:r});e.setLeftSlurAnchor(d)}if(Yt.default.hasRightSlur(t,i)){const a=e.notes[e.notes.length-1],l=new Ti({slurData:null,measure:s,note:a,isExternal:!0,voiceUuid:r});e.setRightSlurAnchor(l)}}})}var D0=b(999970),Vm=b(681670),Lc=b(496819),Mc=b(447819),Oc=b(536949),Bc=b(788220),$g=b(589501),es=b(614653),Qm=b(529355),C0=b(613903),T0=Object.defineProperty,R0=(s,t,e)=>t in s?T0(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,N0=(s,t,e)=>R0(s,typeof t!="symbol"?t+"":t,e);const L0=new Map([[1,{glyphId:"accidentalSharp",offset:1.5}],[2,{glyphId:"accidentalDoubleSharp",offset:1.5}],[-1,{glyphId:"accidentalFlat",offset:1}],[-2,{glyphId:"accidentalDoubleFlat",offset:1}]]),M0=new Map([[1,{glyphId:"accidentalSharp",offset:2.5}],[-1,{glyphId:"accidentalFlat",offset:2}]]);class Ic{constructor(t,e,r=!1){N0(this,"glyphNode");const i=this.getGlyphInfo(e,r),a=t.getChordGlyphRatio();this.glyphNode=t.createGlyphNode(i.glyphId,a);const l=i.offset*a;this.glyphNode.setY(0-l)}getGlyphInfo(t,e=!1){let r;if(e?r=M0.get(t):r=L0.get(t),r===void 0)throw new Error(`The alter value [${t}] is invalid.`);return r}getChildRoot(){return this.glyphNode}setX(t){this.glyphNode.setX(t)}}var Ms=b(640231),O0=Object.defineProperty,B0=(s,t,e)=>t in s?O0(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,I0=(s,t,e)=>B0(s,typeof t!="symbol"?t+"":t,e);const F0=new Map([[Ms.A.ITALIAN,"It"],[Ms.A.FRENCH,"Fr"],[Ms.A.GERMAN,"Ger"]]);class Fc{constructor(t,e,r){I0(this,"textNode");const i=t.getChordsFontOptions(),a=this.getDisplayFunction(e,r);this.textNode=t.createTextNode(a,i),this.textNode.setY(0)}getDisplayFunction(t,e){if(e===Ms.A.NEAPOLITAN)return"N";const r=F0.get(e);return typeof r=="string"?r:t}getChildRoot(){return this.textNode}setX(t){this.textNode.setX(t)}}var Ce=b(51342),U0=Object.defineProperty,H0=Object.defineProperties,_0=Object.getOwnPropertyDescriptors,Km=Object.getOwnPropertySymbols,G0=Object.prototype.hasOwnProperty,X0=Object.prototype.propertyIsEnumerable,Zg=(s,t,e)=>t in s?U0(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,W0=(s,t)=>{for(var e in t||(t={}))G0.call(t,e)&&Zg(s,e,t[e]);if(Km)for(var e of Km(t))X0.call(t,e)&&Zg(s,e,t[e]);return s},z0=(s,t)=>H0(s,_0(t)),jg=(s,t,e)=>Zg(s,typeof t!="symbol"?t+"":t,e);class ys{constructor(t,e){jg(this,"drawingContext"),jg(this,"fontOptions"),jg(this,"textNode"),this.drawingContext=t,this.fontOptions=t.getChordsFontOptions();const r=z0(W0({},this.fontOptions),{fontSize:this.getSmallFontSize()});this.textNode=this.drawingContext.createTextNode(e,r),this.textNode.setY(0-this.getYShift())}getChildRoot(){return this.textNode}setX(t){this.textNode.setX(t)}getYShift(){return this.fontOptions.fontSize*Ce.A.SUPSCRIPT_BASELINE}getSmallFontSize(){return this.fontOptions.fontSize*Ce.A.SMALL_FONT_SIZE}}var Uc=b(74957),eo=b(381216),tp=b(533343),Y0=Object.defineProperty,k0=(s,t,e)=>t in s?Y0(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,q0=(s,t,e)=>k0(s,typeof t!="symbol"?t+"":t,e);const V0=new Map([[tp.A.SUS_2,"sus2"],[tp.A.SUS_4,"sus4"],[tp.A.SUS_24,"sus24"]]);function Q0(s){const t=V0.get(s);if(t===void 0)throw new _l.default(`Invalid chord suspension: ${s}`);return t}function sW(s,t){return new Jm(s,t)}class Jm{constructor(t,e){q0(this,"superscriptNode");const r=Q0(e);this.superscriptNode=new ys(t,r)}getChildRoot(){return this.superscriptNode.getChildRoot()}setX(t){this.superscriptNode.setX(t)}}var K0=Object.defineProperty,J0=(s,t,e)=>t in s?K0(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,ep=(s,t,e)=>J0(s,typeof t!="symbol"?t+"":t,e);function $0(s,t){return typeof t=="string"||s.some(e=>{const r=Uc.A.getType(e);return r===eo.A.SUBTRACT||r===eo.A.ALTER||r===eo.A.ADD})}function Z0(s,t,e){const r=[];if(e){const i=new Jm(s,e);r.push(i)}return t.forEach(i=>{const a=Uc.A.getAlter(i),l=Uc.A.getType(i),d=Uc.A.getValue(i);if(l===eo.A.SUBTRACT){const f=new ys(s,`no${d}`);r.push(f)}else if(l===eo.A.ALTER||l===eo.A.ADD){if(a!==0){const S=new Ic(s,a,!0);r.push(S)}let f=`${d}`;a===0&&r.length>0&&(f=`,${f}`);const m=new ys(s,f);r.push(m)}}),r}class j0{constructor(t,e,r){ep(this,"groupNode"),ep(this,"chordModifications",[]),ep(this,"width",0),this.groupNode=t.createGroupNode(),this.chordModifications=Z0(t,e,r);const i=new ys(t,"(");this.addElement(i),this.chordModifications.forEach(l=>{this.addElement(l)});const a=new ys(t,")");this.addElement(a)}addElement(t){const e=t.getChildRoot(),r=e.getLocalBBox();if(r===null)throw new Error("bbox is null");this.width-=r.minX,e.setX(this.width),this.width+=r.maxX,v(this.groupNode,e)}getChildRoot(){return this.groupNode}setX(t){this.groupNode.setX(t)}}var nt=b(464173),tR=Object.defineProperty,eR=(s,t,e)=>t in s?tR(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,sR=(s,t,e)=>eR(s,typeof t!="symbol"?t+"":t,e);const rR=new Map([[nt.A.POWER,"5"],[nt.A.MAJOR_2,"2"],[nt.A.MAJOR_6,"6"],[nt.A.SIX_NINE,"6/9"],[nt.A.DOMINANT_7,"7"],[nt.A.DOMINANT_7_6,"7/6"],[nt.A.DOMINANT_9,"9"],[nt.A.DOMINANT_11,"11"],[nt.A.DOMINANT_13,"13"]]);function iR(s){const t=rR.get(s);if(t===void 0)throw new _l.default(`Invalid base chord: ${s}`);return t}function ri(s,t){return new nR(s,t)}class nR{constructor(t,e){sR(this,"superscriptNode");const r=iR(e);this.superscriptNode=new ys(t,r)}getChildRoot(){return this.superscriptNode.getChildRoot()}setX(t){this.superscriptNode.setX(t)}}var oR=Object.defineProperty,aR=(s,t,e)=>t in s?oR(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,$m=(s,t,e)=>aR(s,typeof t!="symbol"?t+"":t,e);const hR="csymAugmented";class Hc{constructor(t){$m(this,"glyphNode"),$m(this,"fontOptions"),this.fontOptions=t.getChordsFontOptions();const e=t.getChordGlyphRatio()*Ce.A.SMALL_FONT_SIZE;this.glyphNode=t.createGlyphNode(hR,e),this.glyphNode.setY(0-this.getYShift())}getYShift(){return this.fontOptions.fontSize*Ce.A.SUPSCRIPT_BASELINE}getChildRoot(){return this.glyphNode}setX(t){this.glyphNode.setX(t)}}var lR=Object.defineProperty,cR=(s,t,e)=>t in s?lR(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Zm=(s,t,e)=>cR(s,typeof t!="symbol"?t+"":t,e);const uR=new Map([[nt.A.AUGMENTED_7,"7"],[nt.A.AUGMENTED_9,"9"],[nt.A.AUGMENTED_11,"11"],[nt.A.AUGMENTED_13,"13"]]);function Ya(s,t){return new dR(s,t)}class dR{constructor(t,e){Zm(this,"groupNode"),Zm(this,"width",0),this.groupNode=t.createGroupNode();const r=new Hc(t);this.addElement(r);const i=uR.get(e);if(i!==void 0){const a=new ys(t,i);this.addElement(a)}}addElement(t){const e=t.getChildRoot(),r=e.getLocalBBox();if(r===null)throw new Error("bbox is null");this.width-=r.minX,e.setX(this.width),this.width+=r.maxX,v(this.groupNode,e)}getChildRoot(){return this.groupNode}}var ka=b(659140),Ir=b(996636),fR=Object.defineProperty,gR=Object.defineProperties,pR=Object.getOwnPropertyDescriptors,jm=Object.getOwnPropertySymbols,mR=Object.prototype.hasOwnProperty,yR=Object.prototype.propertyIsEnumerable,sp=(s,t,e)=>t in s?fR(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,AR=(s,t)=>{for(var e in t||(t={}))mR.call(t,e)&&sp(s,e,t[e]);if(jm)for(var e of jm(t))yR.call(t,e)&&sp(s,e,t[e]);return s},vR=(s,t)=>gR(s,pR(t)),ty=(s,t,e)=>sp(s,typeof t!="symbol"?t+"":t,e);const SR="csymMajorSeventh";class rp{constructor(t){ty(this,"majorNode"),ty(this,"fontOptions"),this.fontOptions=t.getChordsFontOptions();const e=t.getJazzChordPartConfig(),r=e[ka.A.MAJOR];if(e[ka.A.MINOR]===Ir.A.SYMBOL){const i=t.getChordGlyphRatio()*Ce.A.SMALL_FONT_SIZE;this.majorNode=t.createGlyphNode(SR,i)}else{const i=this.getTextStr(r),a=vR(AR({},this.fontOptions),{fontSize:this.getSmallFontSize()});this.majorNode=t.createTextNode(i,a)}this.majorNode.setY(0-this.getYShift())}getChildRoot(){return this.majorNode}getTextStr(t){if(t===Ir.A.UPPER_CASE)return Ce.A.MAJOR_TEXT_UPPER_CASE;if(t===Ir.A.LOWER_CASE_LONG)return Ce.A.MAJOR_TEXT;throw Ir.A.raiseError(ka.A.MAJOR,t)}getYShift(){return this.fontOptions.fontSize*Ce.A.SUPSCRIPT_BASELINE}getSmallFontSize(){return this.fontOptions.fontSize*Ce.A.SMALL_FONT_SIZE}setX(t){this.majorNode.setX(t)}}var wR=Object.defineProperty,xR=(s,t,e)=>t in s?wR(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,ey=(s,t,e)=>xR(s,typeof t!="symbol"?t+"":t,e);const bR=new Map([[nt.A.AUGMENTED_MAJOR_7,"7"],[nt.A.AUGMENTED_MAJOR_9,"9"],[nt.A.AUGMENTED_MAJOR_11,"11"],[nt.A.AUGMENTED_MAJOR_13,"13"]]);function _c(s,t){return new PR(s,t)}class PR{constructor(t,e){ey(this,"groupNode"),ey(this,"width",0),this.groupNode=t.createGroupNode();const r=new Hc(t);this.addElement(r);const i=new rp(t);this.addElement(i);const a=bR.get(e);if(a!==void 0){const l=new ys(t,a);this.addElement(l)}}addElement(t){const e=t.getChildRoot(),r=e.getLocalBBox();if(r===null)throw new Error("bbox is null");this.width-=r.minX,e.setX(this.width),this.width+=r.maxX,v(this.groupNode,e)}getChildRoot(){return this.groupNode}}var ER=Object.defineProperty,DR=(s,t,e)=>t in s?ER(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,sy=(s,t,e)=>DR(s,typeof t!="symbol"?t+"":t,e);const CR="csymDiminished";class ip{constructor(t){sy(this,"glyphNode"),sy(this,"fontOptions"),this.fontOptions=t.getChordsFontOptions();const e=t.getChordGlyphRatio()*Ce.A.SMALL_FONT_SIZE;this.glyphNode=t.createGlyphNode(CR,e),this.glyphNode.setY(0-this.getYShift())}getYShift(){return this.fontOptions.fontSize*Ce.A.SUPSCRIPT_BASELINE}getChildRoot(){return this.glyphNode}setX(t){this.glyphNode.setX(t)}}var TR=Object.defineProperty,RR=(s,t,e)=>t in s?TR(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Gc=(s,t,e)=>RR(s,typeof t!="symbol"?t+"":t,e);const NR=new Map([[nt.A.DIMINISHED_7,"7"],[nt.A.DIMINISHED_9,"9"],[nt.A.DIMINISHED_11,"11"],[nt.A.DIMINISHED_13,"13"]]);function qa(s,t){return new LR(s,t)}class LR{constructor(t,e){Gc(this,"drawingContext"),Gc(this,"fontOptions"),Gc(this,"groupNode"),Gc(this,"width",0),this.drawingContext=t,this.fontOptions=t.getChordsFontOptions(),this.groupNode=t.createGroupNode();const r=new ip(t);this.addElement(r);const i=NR.get(e);if(i!==void 0){const a=new ys(t,i);this.addElement(a)}}addElement(t){const e=t.getChildRoot(),r=e.getLocalBBox();if(r===null)throw new Error("bbox is null");this.width-=r.minX,e.setX(this.width),this.width+=r.maxX,v(this.groupNode,e)}getChildRoot(){return this.groupNode}}var MR=Object.defineProperty,OR=(s,t,e)=>t in s?MR(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,ry=(s,t,e)=>OR(s,typeof t!="symbol"?t+"":t,e);const BR="csymHalfDiminished";class iy{constructor(t){ry(this,"glyphNode"),ry(this,"fontOptions"),this.fontOptions=t.getChordsFontOptions();const e=t.getChordGlyphRatio()*Ce.A.SMALL_FONT_SIZE;this.glyphNode=t.createGlyphNode(BR,e),this.glyphNode.setY(0-this.getYShift())}getYShift(){return this.fontOptions.fontSize*Ce.A.SUPSCRIPT_BASELINE}getChildRoot(){return this.glyphNode}setX(t){this.glyphNode.setX(t)}}var IR=Object.defineProperty,FR=(s,t,e)=>t in s?IR(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Xc=(s,t,e)=>FR(s,typeof t!="symbol"?t+"":t,e);const UR=new Map([[nt.A.HALF_DIMINISHED_7,"7"],[nt.A.HALF_DIMINISHED_9,"9"],[nt.A.HALF_DIMINISHED_11,"11"],[nt.A.HALF_DIMINISHED_13,"13"]]);function Wc(s,t){return new HR(s,t)}class HR{constructor(t,e){Xc(this,"drawingContext"),Xc(this,"fontOptions"),Xc(this,"groupNode"),Xc(this,"width",0),this.drawingContext=t,this.fontOptions=t.getChordsFontOptions(),this.groupNode=t.createGroupNode();const r=new iy(t);this.addElement(r);const i=UR.get(e);if(i!==void 0){const a=new ys(t,i);this.addElement(a)}}addElement(t){const e=t.getChildRoot(),r=e.getLocalBBox();if(r===null)throw new Error("bbox is null");this.width-=r.minX,e.setX(this.width),this.width+=r.maxX,v(this.groupNode,e)}getChildRoot(){return this.groupNode}}var _R=Object.defineProperty,GR=(s,t,e)=>t in s?_R(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,zc=(s,t,e)=>GR(s,typeof t!="symbol"?t+"":t,e);const XR=new Map([[nt.A.MAJOR_7,"7"],[nt.A.MAJOR_9,"9"],[nt.A.MAJOR_11,"11"],[nt.A.MAJOR_13,"13"]]);function Yc(s,t){return new WR(s,t)}class WR{constructor(t,e){zc(this,"drawingContext"),zc(this,"fontOptions"),zc(this,"groupNode"),zc(this,"width",0),this.drawingContext=t,this.fontOptions=t.getChordsFontOptions(),this.groupNode=t.createGroupNode();const r=new rp(t);this.addElement(r);const i=XR.get(e);if(i!==void 0){const a=new ys(t,i);this.addElement(a)}}addElement(t){const e=t.getChildRoot(),r=e.getLocalBBox();if(r===null)throw new Error("bbox is null");this.width-=r.minX,e.setX(this.width),this.width+=r.maxX,v(this.groupNode,e)}getChildRoot(){return this.groupNode}}var zR=Object.defineProperty,YR=Object.defineProperties,kR=Object.getOwnPropertyDescriptors,ny=Object.getOwnPropertySymbols,qR=Object.prototype.hasOwnProperty,VR=Object.prototype.propertyIsEnumerable,np=(s,t,e)=>t in s?zR(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,QR=(s,t)=>{for(var e in t||(t={}))qR.call(t,e)&&np(s,e,t[e]);if(ny)for(var e of ny(t))VR.call(t,e)&&np(s,e,t[e]);return s},KR=(s,t)=>YR(s,kR(t)),oy=(s,t,e)=>np(s,typeof t!="symbol"?t+"":t,e);const JR="csymMinor";class ay{constructor(t){if(oy(this,"minorNode"),oy(this,"fontOptions"),this.fontOptions=t.getChordsFontOptions(),t.getJazzChordPartConfig()[ka.A.MINOR]===Ir.A.SYMBOL){const r=t.getChordGlyphRatio()*Ce.A.SMALL_FONT_SIZE;this.minorNode=t.createGlyphNode(JR,r),this.minorNode.setY(0-this.getYShift())}else{const r=KR(QR({},this.fontOptions),{fontSize:this.getSmallFontSize()});this.minorNode=t.createTextNode(Ce.A.MINOR_TEXT,r),this.minorNode.setY(0)}}getChildRoot(){return this.minorNode}getYShift(){return this.fontOptions.fontSize*Ce.A.SUPSCRIPT_BASELINE}getSmallFontSize(){return this.fontOptions.fontSize*Ce.A.SMALL_FONT_SIZE}setX(t){this.minorNode.setX(t)}}var $R=Object.defineProperty,ZR=(s,t,e)=>t in s?$R(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,kc=(s,t,e)=>ZR(s,typeof t!="symbol"?t+"":t,e);const jR=new Map([[nt.A.MINOR_2,"2"],[nt.A.MINOR_6,"6"],[nt.A.MINOR_69,"6/9"],[nt.A.MINOR_7,"7"],[nt.A.MINOR_9,"9"],[nt.A.MINOR_11,"11"],[nt.A.MINOR_13,"13"]]);function Bi(s,t){return new tN(s,t)}class tN{constructor(t,e){kc(this,"drawingContext"),kc(this,"fontOptions"),kc(this,"groupNode"),kc(this,"width",0),this.drawingContext=t,this.fontOptions=t.getChordsFontOptions(),this.groupNode=t.createGroupNode();const r=new ay(t);this.addElement(r);const i=jR.get(e);if(i!==void 0){const a=new ys(t,i);this.addElement(a)}}addElement(t){const e=t.getChildRoot(),r=e.getLocalBBox();if(r===null)throw new Error("bbox is null");this.width-=r.minX,e.setX(this.width),this.width+=r.maxX,v(this.groupNode,e)}getChildRoot(){return this.groupNode}}var eN=Object.defineProperty,sN=(s,t,e)=>t in s?eN(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,qc=(s,t,e)=>sN(s,typeof t!="symbol"?t+"":t,e);const rN=new Map([[nt.A.MINOR_MAJOR_7,"7"],[nt.A.MINOR_MAJOR_9,"9"],[nt.A.MINOR_MAJOR_11,"11"],[nt.A.MINOR_MAJOR_13,"13"]]);function Vc(s,t){return new iN(s,t)}class iN{constructor(t,e){qc(this,"drawingContext"),qc(this,"fontOptions"),qc(this,"groupNode"),qc(this,"width",0),this.drawingContext=t,this.fontOptions=t.getChordsFontOptions(),this.groupNode=t.createGroupNode();const r=new ay(t);this.addElement(r);const i=new rp(t);this.addElement(i);const a=rN.get(e);if(a!==void 0){const l=new ys(t,a);this.addElement(l)}}addElement(t){const e=t.getChildRoot(),r=e.getLocalBBox();if(r===null)throw new Error("bbox is null");this.width-=r.minX,e.setX(this.width),this.width+=r.maxX,v(this.groupNode,e)}getChildRoot(){return this.groupNode}}const nN=new Map([[nt.A.POWER,ri],[nt.A.MINOR,Bi],[nt.A.DIMINISHED,qa],[nt.A.AUGMENTED,Ya],[nt.A.MAJOR_2,ri],[nt.A.MINOR_2,Bi],[nt.A.MAJOR_6,ri],[nt.A.MINOR_6,Bi],[nt.A.SIX_NINE,ri],[nt.A.MINOR_69,Bi],[nt.A.DOMINANT_7,ri],[nt.A.MAJOR_7,Yc],[nt.A.MINOR_7,Bi],[nt.A.MINOR_MAJOR_7,Vc],[nt.A.AUGMENTED_7,Ya],[nt.A.AUGMENTED_MAJOR_7,_c],[nt.A.HALF_DIMINISHED_7,Wc],[nt.A.DIMINISHED_7,qa],[nt.A.DOMINANT_7_6,ri],[nt.A.DOMINANT_9,ri],[nt.A.MAJOR_9,Yc],[nt.A.MINOR_9,Bi],[nt.A.MINOR_MAJOR_9,Vc],[nt.A.AUGMENTED_9,Ya],[nt.A.AUGMENTED_MAJOR_9,_c],[nt.A.HALF_DIMINISHED_9,Wc],[nt.A.DIMINISHED_9,qa],[nt.A.DOMINANT_11,ri],[nt.A.MAJOR_11,Yc],[nt.A.MINOR_11,Bi],[nt.A.MINOR_MAJOR_11,Vc],[nt.A.AUGMENTED_11,Ya],[nt.A.AUGMENTED_MAJOR_11,_c],[nt.A.HALF_DIMINISHED_11,Wc],[nt.A.DIMINISHED_11,qa],[nt.A.DOMINANT_13,ri],[nt.A.MAJOR_13,Yc],[nt.A.MINOR_13,Bi],[nt.A.MINOR_MAJOR_13,Vc],[nt.A.AUGMENTED_13,Ya],[nt.A.AUGMENTED_MAJOR_13,_c],[nt.A.HALF_DIMINISHED_13,Wc],[nt.A.DIMINISHED_13,qa]]);function oN(s,t){const e=nN.get(t);return e===void 0?null:e(s,t)}var aN=Object.defineProperty,hN=(s,t,e)=>t in s?aN(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Va=(s,t,e)=>hN(s,typeof t!="symbol"?t+"":t,e);const lN="alt.";class cN{constructor(t,e){Va(this,"uuid"),Va(this,"drawingContext"),Va(this,"groupNode"),Va(this,"timePos"),Va(this,"width",0),this.drawingContext=t,this.timePos=e.timePos,this.uuid=e.uuid,this.groupNode=t.createGroupNode(),this.buildSingleChord(e.root,e.kind,e.type,e.degreeModifications,e.suspension,e.bass),this.fillEventPayload(e)}buildSingleChord(t,e,r,i,a,l){this.buildRootNote(t,e);const d=oN(this.drawingContext,e);if(d!==null&&this.addElement(d),$0(i,a)){const f=new j0(this.drawingContext,i,a);this.addElement(f)}if(r===C0.A.ALTERNATE){const f=new ys(this.drawingContext,lN);this.addElement(f)}l&&this.buildBassNote(l,e,!0)}buildRootNote(t,e){const r=t["root-step"],i=new Fc(this.drawingContext,r,e);this.addElement(i);const a=t["root-alter"];if(a!==0){const l=new Ic(this.drawingContext,a);this.addElement(l)}}buildBassNote(t,e,r=!1){let i=t["bass-step"];r&&(i=`/${i}`);const a=new Fc(this.drawingContext,i,e);this.addElement(a);const l=t["bass-alter"];if(l!==0){const d=new Ic(this.drawingContext,l);this.addElement(d)}}addElement(t){const e=t.getChildRoot(),r=e.getLocalBBox();if(r===null)throw new Error("bbox is null");this.width-=r.minX,e.setX(this.width),this.width+=r.maxX,v(this.groupNode,e)}fillEventPayload(t){const e={entityType:T.A.JAZZ_HARMONY,timePos:t.timePos,dpq:t.dpq,uuid:t.uuid,kind:t.kind,type:t.type,root:t.root,bass:t.bass||null,suspension:t.suspension||null,degreeModifications:t.degreeModifications};this.groupNode.setEventPayload(e)}getChildRoot(){return this.groupNode}getUuid(){return this.uuid}getTimePos(){return this.timePos}setX(t){this.groupNode.setX(t)}setY(t){this.groupNode.setY(t)}getHorizontalData(){const t=this.groupNode.getLocalBBox();if(t===null)throw new Error("bbox is null");return{timePos:this.timePos,duration:0,spaceBefore:-t.minX,spaceAfter:t.maxX,isRest:!1}}}var hy=b(96410),uN=Object.defineProperty,dN=Object.defineProperties,fN=Object.getOwnPropertyDescriptors,ly=Object.getOwnPropertySymbols,gN=Object.prototype.hasOwnProperty,pN=Object.prototype.propertyIsEnumerable,op=(s,t,e)=>t in s?uN(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,mN=(s,t)=>{for(var e in t||(t={}))gN.call(t,e)&&op(s,e,t[e]);if(ly)for(var e of ly(t))pN.call(t,e)&&op(s,e,t[e]);return s},yN=(s,t)=>dN(s,fN(t)),Qc=(s,t,e)=>op(s,typeof t!="symbol"?t+"":t,e);class AN{constructor(t,e){Qc(this,"fontOptions"),Qc(this,"groupNode"),Qc(this,"topText"),Qc(this,"bottomText",null),this.fontOptions=t.getChordsFontOptions();const r=yN(mN({},this.fontOptions),{fontSize:this.getSmallFontSize()});this.groupNode=t.createGroupNode(),this.topText=t.createTextNode(e.top,r);const i=this.getTopYShift();this.topText.setY(0-i),v(this.groupNode,this.topText),e.bottom!==null&&(this.bottomText=t.createTextNode(e.bottom,r),this.bottomText.setY(this.getBottomYShift()),v(this.groupNode,this.bottomText))}getTopYShift(){return this.fontOptions.fontSize*Ce.A.SUPSCRIPT_BASELINE}getBottomYShift(){return this.getSmallFontSize()/3}getSmallFontSize(){return this.fontOptions.fontSize*Ce.A.SMALL_FONT_SIZE}getChildRoot(){return this.groupNode}setX(t){this.groupNode.setX(t)}}function vN(s,t){if(Ms.A.isAugmentedSixth(t))return{top:"+6",bottom:null};const e=Ms.A.getNbNotes(t),r=hy.A.getTopDigit(s,e);if(r===null)return null;const i=hy.A.getBottomDigit(s,e);return{top:r,bottom:i}}const rW=null;var SN=Object.defineProperty,wN=Object.defineProperties,xN=Object.getOwnPropertyDescriptors,cy=Object.getOwnPropertySymbols,bN=Object.prototype.hasOwnProperty,PN=Object.prototype.propertyIsEnumerable,ap=(s,t,e)=>t in s?SN(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,EN=(s,t)=>{for(var e in t||(t={}))bN.call(t,e)&&ap(s,e,t[e]);if(cy)for(var e of cy(t))PN.call(t,e)&&ap(s,e,t[e]);return s},DN=(s,t)=>wN(s,xN(t)),hp=(s,t,e)=>ap(s,typeof t!="symbol"?t+"":t,e);class uy{constructor(t,e){hp(this,"textNode"),hp(this,"textStr"),hp(this,"fontOptions"),this.fontOptions=t.getChordsFontOptions();const r=DN(EN({},this.fontOptions),{fontSize:this.getSmallFontSize()});this.textStr=this.getTextStr(e),this.textNode=t.createTextNode(this.textStr,r),this.textNode.setY(0-this.getYShift())}getTextStr(t){if(t===Ir.A.UPPER_CASE)return Ce.A.MAJOR_TEXT_UPPER_CASE;if(t===Ir.A.LOWER_CASE_LONG)return Ce.A.MAJOR_TEXT;throw Ir.A.raiseError(ka.A.MAJOR,t)}getYShift(){return this.fontOptions.fontSize*Ce.A.SUPSCRIPT_BASELINE}getSmallFontSize(){return this.fontOptions.fontSize*Ce.A.SMALL_FONT_SIZE}getChildRoot(){return this.textNode}setX(t){this.textNode.setX(t)}}const CN=new Map([[Ms.A.AUGMENTED,function(s){return new Hc(s)}],[Ms.A.DIMINISHED,function(s){return new ip(s)}],[Ms.A.MAJOR_7,function(s){return new uy(s,Ir.A.LOWER_CASE_LONG)}],[Ms.A.DIMINISHED_7,function(s){return new ip(s)}],[Ms.A.HALF_DIMINISHED,function(s){return new iy(s)}],[Ms.A.AUGMENTED_7,function(s){return new Hc(s)}],[Ms.A.MAJOR_MINOR,function(s){return new uy(s,Ir.A.LOWER_CASE_LONG)}]]);function TN(s,t){const e=CN.get(t);return e===void 0?null:e(s)}var RN=Object.defineProperty,NN=(s,t,e)=>t in s?RN(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Qa=(s,t,e)=>NN(s,typeof t!="symbol"?t+"":t,e);class LN{constructor(t,e){if(Qa(this,"drawingContext"),Qa(this,"rootNode"),Qa(this,"timePos"),Qa(this,"uuid"),Qa(this,"width",0),this.drawingContext=t,this.timePos=e.timePos,this.uuid=e.uuid,this.rootNode=t.createGroupNode(),this.buildSingleChord(e.chordFunction,e.alter,e.kind,e.inversion),e.secondaryChordFunction!==null&&e.secondaryAlter!==null&&e.secondaryKind!==null&&e.secondaryInversion!==null){const i=new Fc(this.drawingContext,"/","");this.addElement(i),this.buildSingleChord(e.secondaryChordFunction,e.secondaryAlter,e.secondaryKind,e.secondaryInversion)}const r={entityType:T.A.ROMAN_NUMERAL,timePos:e.timePos,dpq:e.dpq,uuid:e.uuid,chordFunction:e.chordFunction,kind:e.kind,alter:e.alter,inversion:e.inversion,secondary:MN(e)};this.rootNode.setEventPayload(r)}buildSingleChord(t,e,r,i){if(e!==0){const f=new Ic(this.drawingContext,e);this.addElement(f)}const a=new Fc(this.drawingContext,t,r);this.addElement(a);const l=TN(this.drawingContext,r);l!==null&&this.addElement(l);const d=vN(i,r);if(d!==null){const f=new AN(this.drawingContext,d);this.addElement(f)}}addElement(t){const e=t.getChildRoot(),r=e.getLocalBBox();if(r===null)throw new Error("bbox is null");this.width-=r.minX,e.setX(this.width),this.width+=r.maxX,v(this.rootNode,e)}getChildRoot(){return this.rootNode}getUuid(){return this.uuid}getTimePos(){return this.timePos}setX(t){this.rootNode.setX(t)}setY(t){this.rootNode.setY(t)}getHorizontalData(){const t=this.rootNode.getLocalBBox();if(t===null)throw new Error("bbox is null");return{timePos:this.timePos,duration:0,spaceBefore:-t.minX,spaceAfter:t.maxX,isRest:!1}}}function MN(s){return s.secondaryChordFunction===null||s.secondaryKind===null||s.secondaryAlter===null||s.secondaryInversion===null?null:{chordFunction:s.secondaryChordFunction,kind:s.secondaryKind,alter:s.secondaryAlter,inversion:s.secondaryInversion}}var pn=b(434243),As=b(808988),ON=Object.defineProperty,BN=(s,t,e)=>t in s?ON(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,dy=(s,t,e)=>BN(s,typeof t!="symbol"?t+"":t,e);class lp{constructor(t,e,r=!1){dy(this,"glyphNode"),dy(this,"isDigitValue"),this.glyphNode=t.createGlyphNode(e),this.glyphNode.setY(0),this.isDigitValue=r}getChildRoot(){return this.glyphNode}getWidth(){return this.glyphNode.getWidth()}setX(t){this.glyphNode.setX(t)}isDigit(){return this.isDigitValue}}var IN=Object.defineProperty,FN=(s,t,e)=>t in s?IN(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,fy=(s,t,e)=>FN(s,typeof t!="symbol"?t+"":t,e);class UN{constructor(t,e){fy(this,"groupNode"),fy(this,"isDigitValue"),this.groupNode=t.createGroupNode(),e.forEach(i=>v(this.groupNode,i.getChildRoot()));const r=t.getMarginSize()/4;this.isDigitValue=e.every(i=>i.isDigit()),this.isDigitValue?HN(e,r):_N(e,r)}getChildRoot(){return this.groupNode}getWidth(){return this.groupNode.getWidth()}setX(t){this.groupNode.setX(t)}isDigit(){return this.isDigitValue}}function HN(s,t){let e=0;s.forEach((r,i)=>{const a=r.getChildRoot(),l=a.getLocalBBox();if(l===null)throw new Error("bbox is null");i>0&&(e-=l.minX),a.setX(e),e+=l.maxX+t})}function _N(s,t){let e=0;s.slice().reverse().forEach((r,i)=>{const a=r.getChildRoot(),l=a.getLocalBBox();if(l===null)throw new Error("bbox is null");i>0&&(e-=l.maxX),a.setX(e),e+=l.minX-t})}var GN=Object.defineProperty,XN=(s,t,e)=>t in s?GN(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Kc=(s,t,e)=>XN(s,typeof t!="symbol"?t+"":t,e);class WN{constructor(t,e,r){Kc(this,"groupNode"),Kc(this,"slashGlyph"),Kc(this,"slashedGlyphNode"),Kc(this,"width",0),this.groupNode=t.createGroupNode(),this.slashGlyph=t.createGlyphNode(r),this.slashedGlyphNode=e;const i=this.slashGlyph.getLocalBBox(),a=e.getChildRoot().getLocalBBox();if(a===null)throw new Error("slashedBBox is null");let l=0;l+=a.minX,l+=e.getWidth()/2,l-=this.slashGlyph.getWidth()/2,l-=i.minX,this.slashGlyph.setX(l),v(this.groupNode,this.slashedGlyphNode.getChildRoot()),v(this.groupNode,this.slashGlyph)}getChildRoot(){return this.groupNode}getWidth(){return this.groupNode.getWidth()}setX(t){this.groupNode.setX(t)}isDigit(){return!1}}var zN=Object.defineProperty,YN=(s,t,e)=>t in s?zN(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,cp=(s,t,e)=>YN(s,typeof t!="symbol"?t+"":t,e);const kN=new Map([[pn.A.FLAT,"figbassFlat"],[pn.A.FLATFLAT,"figbassDoubleFlat"],[pn.A.NATURAL,"figbassNatural"],[pn.A.SHARP,"figbassSharp"],[pn.A.SHARPSHARP,"figbassDoubleSharp"],[pn.A.PLUS,"figbassPlus"]]),up=new Map([["0","figbass0"],["1","figbass1"],["2","figbass2"],[`2${As.A.VERTICAL}`,"figbass2Raised"],["3","figbass3"],["4","figbass4"],[`4${As.A.VERTICAL}`,"figbass4Raised"],["5","figbass5"],[`5${As.A.VERTICAL}`,"figbass5Raised1"],[`5${As.A.BACK_SLASH}`,"figbass5Raised2"],[`5${As.A.SLASH}`,"figbass5Raised3"],["6","figbass6"],[`6${As.A.BACK_SLASH}`,"figbass6Raised"],["7","figbass7"],[`7${As.A.VERTICAL}`,"figbass7Raised1"],[`7${As.A.BACK_SLASH}`,"figbass7Raised2"],["8","figbass8"],["9","figbass9"],[`9${As.A.BACK_SLASH}`,"figbass9Raised"]]),qN=new Map([[As.A.BACK_SLASH,"figbassCombiningLowering"],[As.A.SLASH,"figbassCombiningRaising"]]);function VN(s,t){let e=s.toString();return t!==null&&As.A.isValid(t)&&(e+=t),e}class QN{constructor(t,e){if(cp(this,"drawingContext"),cp(this,"groupNode"),cp(this,"elements",[]),this.drawingContext=t,this.groupNode=t.createGroupNode(),e.alter&&pn.A.isValid(e.alter)&&this.buildPrefix(e.alter),this.elements.length===0&&e.number===void 0&&(e.number=3),e.number!==void 0){const i=VN(e.number,e.alter);typeof up.get(i)=="string"?this.buildLigature(i):this.buildComposed(e)}const r=this.unitOrGroup(this.elements);v(this.groupNode,r.getChildRoot()),this.groupNode.setY(0)}buildPrefix(t){const e=kN.get(t);if(!e)return;const r=new lp(this.drawingContext,e);this.elements.push(r)}buildLigature(t){const e=up.get(t);if(!e)return;const r=new lp(this.drawingContext,e);this.elements.push(r)}buildComposed(t){if(!t.number)return;const r=Dt.default.toDigitArray(t.number).map(this.createDigit.bind(this));let i=this.unitOrGroup(r);if(t.alter===As.A.BACK_SLASH||t.alter===As.A.SLASH){const a=qN.get(t.alter);if(a===void 0)throw new Error(`Slash glyph ${t.alter} not found`);i=new WN(this.drawingContext,i,a)}this.elements.push(i)}unitOrGroup(t){if(t.length===0)throw new Error("Empty glyph array unexpected");return t.length===1?t[0]:new UN(this.drawingContext,t)}createDigit(t){const e=t.toString(),r=up.get(e);if(!r)throw new Error(`Glyph not found for figure number ${t}`);const i=!0;return new lp(this.drawingContext,r,i)}getChildRoot(){return this.groupNode}setY(t){this.groupNode.setY(t)}getYPosition(){return this.groupNode.getY()}}var KN=Object.defineProperty,JN=(s,t,e)=>t in s?KN(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,so=(s,t,e)=>JN(s,typeof t!="symbol"?t+"":t,e);const Jc=2;class $N{constructor(t,e){so(this,"drawingContext"),so(this,"groupNode"),so(this,"figuresData"),so(this,"figuresLevelsMap",new Map),so(this,"timePos"),so(this,"uuid"),this.drawingContext=t,this.timePos=e.timePos,this.figuresData=e.figuresData,this.uuid=e.uuid,this.groupNode=t.createGroupNode(),this.figuresData.forEach((r,i)=>{this.buildSingleFigure(r,i),this.fillEventPayload(e,i)})}fillEventPayload(t,e){const r=t.figuresData[e],i=this.figuresLevelsMap.get(e);if(!r||!i)return;const a={entityType:T.A.FIGURED_BASS,timePos:t.timePos,dpq:t.dpq,uuid:t.uuid,level:e,figureData:structuredClone(r)};i.getChildRoot().setEventPayload(a)}buildSingleFigure(t,e){const r=new QN(this.drawingContext,t);this.addVerticalElement(r,e),this.figuresLevelsMap.set(e,r)}addVerticalElement(t,e){const r=t.getChildRoot();if(r.getLocalBBox()===null)throw new Error("bbox is null");r.setY(Jc*e),v(this.groupNode,r)}getFigureAtLevel(t){return this.figuresLevelsMap.get(t)}getChildRoot(){return this.groupNode}getUuid(){return this.uuid}getTimePos(){return this.timePos}setX(t){this.groupNode.setX(t)}setY(t){this.groupNode.setY(t)}getYPosition(){return this.groupNode.getY()}getHorizontalData(){const t=this.groupNode.getLocalBBox();if(t===null)throw new Error("bbox is null");return{timePos:this.timePos,duration:0,spaceBefore:-t.minX,spaceAfter:t.maxX,isRest:!1}}}var ZN=Object.defineProperty,jN=(s,t,e)=>t in s?ZN(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,dp=(s,t,e)=>jN(s,typeof t!="symbol"?t+"":t,e);const gy=.5,tL="repeat1Bar";class eL{constructor(t,e,r){dp(this,"glyphNode"),dp(this,"duration"),dp(this,"horizontalFormatter",null),this.glyphNode=t.createGlyphNode(tL);const i=(e.nbStaffLines-1)/2;this.glyphNode.setY(i*e.spaceSize),this.duration=r}setHorizontalFormatter(t){this.horizontalFormatter=t}formatHorizontal(){if(this.horizontalFormatter===null)throw new Error("horizontalFormatter is not set");const t=this.horizontalFormatter.getSpaceBeforeNotes(),e=-t+gy,r=this.horizontalFormatter.getWidth()+t-2*gy;this.glyphNode.setX(e+r/2)}getEntityHorizontalData(){const t=this.glyphNode.getWidth();return{timePos:0,duration:this.duration,spaceBefore:0,spaceAfter:t,isRest:!0}}getChildRoot(){return this.glyphNode}}var ss=b(345912),sL=Object.defineProperty,rL=(s,t,e)=>t in s?sL(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,fp=(s,t,e)=>rL(s,typeof t!="symbol"?t+"":t,e);class iL{constructor(t,e,r){fp(this,"tickableContent"),fp(this,"measureJson"),fp(this,"staffIdx"),this.tickableContent=t,this.measureJson=e,this.staffIdx=r}build(t){this.addMiddleAnchors(t),this.addLeftContinueAnchors(),this.addRightContinueAnchors()}addMiddleAnchors(t){t.sort(Oi.A.compareTimePosInc),t.forEach(this.addMiddleAnchor,this)}addMiddleAnchor(t){const e=ss.A.getTimePos(t),r=ss.A.getPlacement(t),i=ss.A.getType(t),a=ss.A.getSize(t);let l=null;sn.A.isStart(i)&&(l=ss.A.getOctaveShiftUuid(t));const d=null,f=new on({type:i,size:a,placement:r,timePos:e,location:d,octaveShiftUuid:l});this.tickableContent.addMiddleOctaveShiftAnchor(f)}addLeftContinueAnchors(){if(Yt.default.hasLeftOctaveShift(this.measureJson,this.staffIdx)){const t=Yt.default.getLeftOctaveShift(this.measureJson,this.staffIdx);if(ss.A.getStaffIdx(t)===this.staffIdx){const r=ss.A.getPlacement(t),i=ss.A.getType(t),a=ss.A.getSize(t),l=ss.A.getLocation(t),d=ss.A.getOctaveShiftUuid(t),f=new on({type:i,size:a,placement:r,timePos:0,location:l,octaveShiftUuid:d});this.tickableContent.setLeftOctaveShiftAnchor(f)}}}addRightContinueAnchors(){if(Yt.default.hasRightOctaveShift(this.measureJson,this.staffIdx)){const t=Yt.default.getRightOctaveShift(this.measureJson,this.staffIdx);if(Oi.A.getStaffIdx(t)===this.staffIdx){const r=ss.A.getPlacement(t),i=ss.A.getType(t),a=ss.A.getSize(t),l=ss.A.getLocation(t),d=ss.A.getOctaveShiftUuid(t),f=new on({type:i,size:a,placement:r,timePos:Yt.default.getNbDivisions(this.measureJson),location:l,octaveShiftUuid:d});this.tickableContent.setRightOctaveShiftAnchor(f)}}}}var Fr=b(584416),nL=Object.defineProperty,oL=(s,t,e)=>t in s?nL(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,gp=(s,t,e)=>oL(s,typeof t!="symbol"?t+"":t,e);class aL{constructor(t,e,r){gp(this,"tickableContent"),gp(this,"measureJson"),gp(this,"staffIdx"),this.tickableContent=t,this.measureJson=e,this.staffIdx=r}build(t){this.addMiddleAnchors(t),this.addLeftContinueAnchors(),this.addRightContinueAnchors()}addMiddleAnchors(t){t.sort(Oi.A.compareTimePosInc),t.forEach(this.addMiddleAnchor,this)}addMiddleAnchor(t){const e=Fr.A.getTimePos(t),r=Fr.A.getType(t);let i=null;Di.A.isStart(r)&&(i=Fr.A.getPedalUuid(t));const a=null,l=new an({type:r,timePos:e,location:a,pedalUuid:i});this.tickableContent.addMiddlePedalAnchor(l)}addLeftContinueAnchors(){if(Yt.default.hasLeftPedal(this.measureJson,this.staffIdx)){const t=Yt.default.getLeftPedal(this.measureJson,this.staffIdx);if(Fr.A.getStaffIdx(t)===this.staffIdx){const r=Fr.A.getType(t),i=Fr.A.getLocation(t),a=Fr.A.getPedalUuid(t),l=new an({type:r,timePos:0,location:i,pedalUuid:a});this.tickableContent.setLeftPedalAnchor(l)}}}addRightContinueAnchors(){if(Yt.default.hasRightPedal(this.measureJson,this.staffIdx)){const t=Yt.default.getRightPedal(this.measureJson,this.staffIdx);if(Oi.A.getStaffIdx(t)===this.staffIdx){const r=Fr.A.getType(t),i=Fr.A.getLocation(t),a=Fr.A.getPedalUuid(t),l=new an({type:r,timePos:Yt.default.getNbDivisions(this.measureJson),location:i,pedalUuid:a});this.tickableContent.setRightPedalAnchor(l)}}}}var Os=b(368495),hL=Object.defineProperty,lL=(s,t,e)=>t in s?hL(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,pp=(s,t,e)=>lL(s,typeof t!="symbol"?t+"":t,e);class cL{constructor(t,e,r){pp(this,"tickableContent"),pp(this,"measureJson"),pp(this,"staffIdx"),this.tickableContent=t,this.measureJson=e,this.staffIdx=r}build(t){this.addMiddleAnchors(t),this.addLeftContinueAnchors(),this.addRightContinueAnchors()}addMiddleAnchors(t){t.sort(Oi.A.compareTimePosInc),t.forEach(this.addMiddleAnchor,this)}addMiddleAnchor(t){const e=Os.A.getTimePos(t),r=Os.A.getPlacement(t),i=Os.A.getType(t);let a=null;Ci.A.isStart(i)&&(a=Os.A.getPluckedRangeUuid(t));const l=null,d=new hn({type:i,placement:r,timePos:e,location:l,pluckedRangeUuid:a});this.tickableContent.addMiddlePluckedRangeAnchor(d)}addLeftContinueAnchors(){if(Yt.default.hasLeftPluckedRange(this.measureJson,this.staffIdx)){const t=Yt.default.getLeftPluckedRange(this.measureJson,this.staffIdx);if(Os.A.getStaffIdx(t)===this.staffIdx){const r=Os.A.getPlacement(t),i=Os.A.getType(t),a=Os.A.getLocation(t),l=Os.A.getPluckedRangeUuid(t),d=new hn({type:i,placement:r,timePos:0,location:a,pluckedRangeUuid:l});this.tickableContent.setLeftPluckedRangeAnchor(d)}}}addRightContinueAnchors(){if(Yt.default.hasRightPluckedRange(this.measureJson,this.staffIdx)){const t=Yt.default.getRightPluckedRange(this.measureJson,this.staffIdx);if(Oi.A.getStaffIdx(t)===this.staffIdx){const r=Os.A.getPlacement(t),i=Os.A.getType(t),a=Os.A.getLocation(t),l=Os.A.getPluckedRangeUuid(t),d=new hn({type:i,placement:r,timePos:Yt.default.getNbDivisions(this.measureJson),location:a,pluckedRangeUuid:l});this.tickableContent.setRightPluckedRangeAnchor(d)}}}}var uL=Object.defineProperty,dL=(s,t,e)=>t in s?uL(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,$c=(s,t,e)=>dL(s,typeof t!="symbol"?t+"":t,e);function fL(s){const t=new gL(s);s.notes.forEach(t.processNote,t)}class gL{constructor(t){$c(this,"voice"),$c(this,"beamNumber",0),$c(this,"beamType",null),$c(this,"beamNotes",null),this.voice=t}processNote(t){const r=t.getDisplayData().getBeams();r&&r.forEach(i=>this.processBeam(t,i))}processBeam(t,e){this.extractBeamData(e),this.beamNumber===0&&(this.beamType===Ds.A.BEGIN?this.beginBeam(t):this.beamType===Ds.A.CONTINUE?this.continueBeam(t):this.endBeam(t))}extractBeamData(t){this.beamNumber=Es.A.getNumber(t),this.beamNumber===0?this.beamType=Es.A.getType(t):this.beamType=null}beginBeam(t){if(this.beamNotes)throw new Error("Beam not ended");this.beamNotes=[t]}continueBeam(t){if(this.beamNotes===null)throw new Error("Beam not started");this.beamNotes.push(t)}endBeam(t){if(this.beamNotes===null)throw new Error("Beam not started");this.beamNotes.push(t);const e=t.staffData,r=t.drawingContext,i=new Jo(r,this.beamNotes,e);this.voice.addBeam(i),this.beamNotes=null}}var pL=Object.defineProperty,mL=(s,t,e)=>t in s?pL(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,ie=(s,t,e)=>mL(s,typeof t!="symbol"?t+"":t,e);const yL="note";class AL{constructor(t,e,r){ie(this,"drawingContext"),ie(this,"noteDisplayData"),ie(this,"rootNode"),ie(this,"stemBaseGroup"),ie(this,"staffData"),ie(this,"localVerticalAlignment"),ie(this,"leftStemX"),ie(this,"stemYOffset"),ie(this,"heads"),ie(this,"stringHeads",new Map),ie(this,"middleHeadWidth"),ie(this,"rightHeadWidth"),ie(this,"leftHeadWidth"),ie(this,"accsWidth",0),ie(this,"accidentals"),ie(this,"legerLines",new Set),ie(this,"dots",[]),ie(this,"dotWidth",null),ie(this,"dotMargin",null),ie(this,"flag",null),ie(this,"flagWidth",null),ie(this,"fretsWidth",null),ie(this,"stem",null),ie(this,"articulations",[]),ie(this,"technicals",[]),ie(this,"aboveRight",null),ie(this,"aboveRightWidth",null),ie(this,"rightArticulationsWidth",null),ie(this,"leftArticulationsWidth",null),ie(this,"timePos",null),ie(this,"horizontalShift",0),ie(this,"arpeggio",null),ie(this,"beams",[]),this.drawingContext=t,this.noteDisplayData=e,this.rootNode=t.createGroupNode(),this.rootNode.setLabel(yL),this.stemBaseGroup=null,this.staffData=r,this.leftStemX=null,this.stemYOffset=null,this.heads=null,this.middleHeadWidth=null,this.rightHeadWidth=null,this.leftHeadWidth=null,this.accidentals=[],this.legerLines=new Set,this.localVerticalAlignment=this.initLocalVerticalAlignment()}isGrace(){return this.noteDisplayData.isGrace()}getDrawingContext(){return this.drawingContext}getChildRoot(){return this.rootNode}getStemBaseGroup(){if(this.stemBaseGroup===null){this.stemBaseGroup=this.drawingContext.createGroupNode(),v(this.rootNode,this.stemBaseGroup);const t=this.noteDisplayData.getStemBaseLine(),e=this.lineToY(t);this.stemBaseGroup.setY(e);const r=this.getLeftStemX();this.stemBaseGroup.setX(r)}return this.stemBaseGroup}lineToY(t){const r=this.staffData.nbStaffLines;if(this.staffData.type===Zt.A.GUITAR_TAB){const i=this.staffData.spaceSize;return Le.A.lineToTabY(t,1,i,r)}else return Le.A.lineToY(t,1,r)}yToLine(t){let e=1;const r=this.staffData.nbStaffLines;return this.staffData.type===Zt.A.GUITAR_TAB&&(e=this.staffData.spaceSize),Le.A.yToLine(t,e,r)}getStaffData(){return this.noteDisplayData.getStaffData()}getVoiceIdx(){return this.noteDisplayData.getVoiceIdx()}getNbStaffLines(){const t=this.getStaffData();return ms.A.getNbStaffLines(t)}isTabStaff(){const t=this.getStaffData();return ms.A.isTabStaff(t)}isRecorderTabStaff(){const t=this.getStaffData();return ms.A.isRecorderTabStaff(t)}isKodalyStaff(){const t=this.getStaffData();return ms.A.isKodalyStaff(t)}getDisplayData(){return this.noteDisplayData}getGroup(){return this.rootNode}initLocalVerticalAlignment(){const e=(this.getNbStaffLines()-1)/2+1;return{highestY:this.lineToY(e),lowestY:this.lineToY(e),highestTupletY:this.lineToY(e),lowestTupletY:this.lineToY(e)}}setStem(t){this.stem=t}setStemYOffset(t){this.stemYOffset=t}getStemYOffset(){if(this.stemYOffset===null)throw new Error("Stem Y offset not set");return this.stemYOffset}setLeftStemX(t){this.leftStemX=t}getLeftStemX(){if(this.leftStemX===null)throw new Error("Left stem X not set");return this.leftStemX}setStringHead(t,e){this.stringHeads.set(t,e),v(this.rootNode,e)}getHead(t){const r=this.getHeads().get(t);if(r===void 0)throw new _l.default(`No head for line ${t}`);return r}getHeads(){return this.heads===null&&(this.heads=this.initHeads()),this.heads}initHeads(){const t=new Map;return this.getDisplayData().getLines().forEach(i=>{const a=this.drawingContext.createGroupNode();v(this.rootNode,a),t.set(i,a)}),t}setHighestY(t){const e=this.localVerticalAlignment.highestY,r=Math.min(e,t);this.localVerticalAlignment.highestY=r}setLowestY(t){const e=this.localVerticalAlignment.lowestY,r=Math.max(e,t);this.localVerticalAlignment.lowestY=r}setHighestYLine(t){const e=this.lineToY(t);this.setHighestY(e)}setLowestYLine(t){const e=this.lineToY(t);this.setLowestY(e)}setHighestLowestY(t){this.setHighestY(t),this.setLowestY(t)}setHighestLowestYLine(t){this.setHighestYLine(t),this.setLowestYLine(t)}setLeftHeadWidth(t){this.leftHeadWidth=t}setRightHeadWidth(t){this.rightHeadWidth=t}setMiddleHeadWidth(t){this.middleHeadWidth=t}getHeadSpaceBefore(){return this.leftHeadWidth===null?0:this.leftHeadWidth}getHeadSpaceAfter(){const t=this.getMiddleHeadWidth(),e=this.rightHeadWidth||0;return t+e}getLeftHeadWidth(){if(this.leftHeadWidth===null)throw new Error("Left head width not set");return this.leftHeadWidth}getMiddleHeadWidth(){if(this.middleHeadWidth===null)throw new Error("Middle head width not set");return this.middleHeadWidth}getRightHeadWidth(){if(this.rightHeadWidth===null)throw new Error("Right head width not set");return this.rightHeadWidth}addAccidental(t){this.accidentals.push(t)}hasAccidentals(){return this.accidentals.length!==0}getAccidentalsWidth(){return this.accsWidth}setAccidentalsWidth(t){this.accsWidth=t}setRightArticulationsWidth(t){this.rightArticulationsWidth=t}setLeftArticulationsWidth(t){this.leftArticulationsWidth=t}addLegerLine(t){this.legerLines.add(t)}addDot(t){this.dots.push(t)}setDotWidth(t){this.dotWidth=t}setDotMargin(t){this.dotMargin=t}setFlag(t,e){this.flag=t,this.flagWidth=e}addArpeggio(t){this.arpeggio=t,v(this.rootNode,t.getChildRoot())}setAboveRight(t,e){this.aboveRight=t,this.aboveRightWidth=e}setArticulation(t){this.articulations.push(t)}setTechnical(t){this.technicals.push(t)}getLowestY(){return this.getVerticalAlignment().lowestY}getHighestY(){return this.getVerticalAlignment().highestY}getVerticalAlignment(){return this.localVerticalAlignment}getLocalHighestY(){return this.localVerticalAlignment.highestY}getLocalLowestY(){return this.localVerticalAlignment.lowestY}getLocalLowestYWithMarge(){return this.getLocalLowestY()+.5}getLocalHighestYWithMarge(){return this.getLocalHighestY()-.5}setTimePos(t){this.timePos=t}getTimePos(){if(this.timePos===null)throw new Error("Time pos not set");return this.timePos}getDuration(){const t=this.noteDisplayData.getDuration();if(t===null)throw new Error("Trying to query a note duration that is null (grace note?)");return t}isRest(){return this.noteDisplayData.isRest()}setPosition(t){t+=this.horizontalShift,this.rootNode.setX(t)}getPosition(){return this.rootNode.getX()}removeDots(){this.dots.forEach(t=>{it(this.rootNode,t),t.destroy()}),this.dots=[]}setHorizontalShift(t){this.horizontalShift=t}getHorizontalShift(){return this.horizontalShift}hasLeftShiftedHead(){return this.leftHeadWidth!==null}hasRightShiftedHead(){return this.rightHeadWidth!==null}addBeam(t){this.beams.push(t),v(this.rootNode,t.getChildRoot())}formatBeams(){this.beams.forEach(t=>t.update())}setFretsWidth(t){this.fretsWidth=t}getFretsWidth(){return this.fretsWidth}}var py=(s=>(s.UP="up",s.HORIZONTAL="horizontal",s.DOWN="down",s))(py||{});const ro=py;var vL=Object.defineProperty,SL=(s,t,e)=>t in s?vL(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,mn=(s,t,e)=>SL(s,typeof t!="symbol"?t+"":t,e);const my=.7,wL=.5;class xL{constructor(t,e,r){mn(this,"groupNode"),mn(this,"placementCoeff"),mn(this,"y2"),mn(this,"leftVertical"),mn(this,"leftSlant"),mn(this,"rightSlant"),mn(this,"rightVertical"),this.groupNode=t.createGroupNode(),this.placementCoeff=bL(r),this.y2=PL(e);const i=t.getTupletBracketThickness(),a=wL*-this.placementCoeff;this.leftVertical=t.createLineNode(),this.leftVertical.setWidth(i),this.leftVertical.setX(0),this.leftVertical.setY(0),this.leftVertical.setX2(0),this.leftVertical.setY2(a),v(this.groupNode,this.leftVertical),this.rightVertical=t.createLineNode(),this.rightVertical.setWidth(i),this.rightVertical.setX2(0),this.rightVertical.setY(this.y2),this.rightVertical.setY2(a),v(this.groupNode,this.rightVertical),this.leftSlant=t.createLineNode(),this.leftSlant.setWidth(i),this.leftSlant.setX(0),this.leftSlant.setY(0),v(this.groupNode,this.leftSlant),this.rightSlant=t.createLineNode(),this.rightSlant.setWidth(i),this.rightSlant.setY(this.y2),v(this.groupNode,this.rightSlant)}updateHorizontal(t){this.rightVertical.setX(t.width),this.rightSlant.setX(t.width);const e=(this.y2-0)/(t.width-0),r=(t.width-t.gap)/2,i=e*r;this.leftSlant.setY2(i),this.leftSlant.setX2(r);const a=e*-r;this.rightSlant.setY2(a),this.rightSlant.setX2(-r)}getChildRoot(){return this.groupNode}}function bL(s){if(s===I.A.ABOVE)return-1;if(s===I.A.BELOW)return 1;throw I.A.raiseError(s)}function PL(s){if(s===ro.HORIZONTAL)return 0;if(s===ro.UP)return-my;if(s===ro.DOWN)return my;throw new Error(`Invalid slant: ${s}`)}var EL=Object.defineProperty,DL=(s,t,e)=>t in s?EL(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,yy=(s,t,e)=>DL(s,typeof t!="symbol"?t+"":t,e);function CL(s){return new TL(s).getSlant()}class TL{constructor(t){yy(this,"notes"),yy(this,"avgLines",null),this.notes=t}getSlant(){if(this.isHorizontal())return ro.HORIZONTAL;const t=this.getAvgLines(),e=t[0],r=t[t.length-1];return e>r?ro.DOWN:ro.UP}isHorizontal(){return this.areFirstAndLastLinesSame()||this.isMajoritySameLine()?!0:!!this.isChaotic()}areFirstAndLastLinesSame(){const t=this.getAvgLines(),e=t[0],r=t.length-1,i=t[r];return e===i}isMajoritySameLine(){const t=this.getAvgLines();if(t.length<4)return!1;const e=new Map;return t.forEach(function(i){let a=e.get(i);a===void 0?a=1:a++,e.set(i,a)}),RL(e)>=t.length/2}getAvgLines(){return this.avgLines===null&&(this.avgLines=this.calcAvgLines()),this.avgLines}calcAvgLines(){return this.notes.map(function(t){return t.getDisplayData().getLineAvg()})}isChaotic(){return!1}}function RL(s){return Math.max(0,...s.values())}var NL=Object.defineProperty,LL=(s,t,e)=>t in s?NL(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,yn=(s,t,e)=>LL(s,typeof t!="symbol"?t+"":t,e);const ML=1,Ay=.5,OL="tuplet";class BL{constructor(t,e){yn(this,"groupNode"),yn(this,"textNode"),yn(this,"bracket"),yn(this,"firstNote"),yn(this,"lastNote"),yn(this,"minimalWidth",null),yn(this,"placement"),this.groupNode=t.createGroupNode(),this.groupNode.setLabel(OL),this.firstNote=e.notes[0],this.lastNote=e.notes[e.notes.length-1],this.placement=e.placement;const r=CL(e.notes);this.bracket=new xL(t,r,e.placement),v(this.groupNode,this.bracket.getChildRoot());const i=t.getTupletFontOptions();this.textNode=t.createTextNode(e.number.toString(),i),this.textNode.setY(this.bracket.y2/2),v(this.groupNode,this.textNode)}getPlacement(){return this.placement}updateHorizontal(){const{position:t,width:e}=this.getHorizontalData();this.groupNode.setX(t);const r=this.textNode.getWidth(),i=Ay*2+r;this.bracket.updateHorizontal({width:e,gap:i}),this.textNode.setX(e/2-r/2)}getHorizontalData(){const t=this.getFirstNoteStartX(),r=this.getLastNoteStopX()-t,i=this.getMinimalWidth(),a=Math.max(r,i);let l=t;return i>r&&(l-=(i-r)/2),{position:l,width:a}}getFirstNoteStartX(){let t=this.firstNote.getPosition();return this.firstNote.hasLeftShiftedHead()&&(t-=this.firstNote.getLeftHeadWidth()),t}getLastNoteStopX(){let t=this.lastNote.getPosition()+this.lastNote.getMiddleHeadWidth();return this.lastNote.hasRightShiftedHead()&&(t+=this.lastNote.getRightHeadWidth()),t}getMinimalWidth(){if(this.minimalWidth===null){const t=this.textNode.getWidth();this.minimalWidth=ML*2+Ay*2+t}return this.minimalWidth}getChildRoot(){return this.groupNode}}var IL=Object.defineProperty,FL=(s,t,e)=>t in s?IL(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,mp=(s,t,e)=>FL(s,typeof t!="symbol"?t+"":t,e);function UL(s){const t=new HL(s);s.notes.forEach(t.processNote,t)}class HL{constructor(t){mp(this,"voice"),mp(this,"tupletNotes",null),mp(this,"placement",null),this.voice=t}processNote(t){const e=t.getDisplayData();e.hasTupletStart()?this.startTuplet(t):e.hasTupletStop()?this.stopTuplet(t):this.tupletNotes&&!e.hasNormalTimeModif()&&this.continueTuplet(t)}startTuplet(t){if(this.tupletNotes)throw new Error("Tuplet not ended");this.tupletNotes=[t]}continueTuplet(t){if(this.tupletNotes===null)throw new Error("Tuplet not started");this.tupletNotes.push(t)}stopTuplet(t){if(this.tupletNotes===null)throw new Error("Tuplet not started");this.tupletNotes.push(t);const i=this.tupletNotes[0].getDisplayData().getTupletStart(),a=Kp.A.getNbActual(i),l=this.voice.drawingContext,d=this.getPlacement(),f=new BL(l,{notes:this.tupletNotes,number:a,placement:d});this.voice.addTuplet(f),this.tupletNotes=null}getPlacement(){return this.placement===null&&(this.placement=this.computePlacement()),this.placement}computePlacement(){const t=this.voice.stemStrategy;if(t===zt.A.AUTO||zt.A.isUp(t))return I.A.ABOVE;if(zt.A.isDown(t))return I.A.BELOW;throw zt.A.raiseError(t)}}var _L=Object.defineProperty,GL=(s,t,e)=>t in s?_L(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ws=(s,t,e)=>GL(s,typeof t!="symbol"?t+"":t,e);function XL(s){const t=new WL(s);return t.build(s),t.voice}class WL{constructor(t){Ws(this,"attrs"),Ws(this,"location"),Ws(this,"voice"),Ws(this,"drawingContext"),Ws(this,"stemStrategy"),Ws(this,"isPickup"),Ws(this,"isAlone",!1),Ws(this,"nbVoices"),Ws(this,"renderedNotes",[]),Ws(this,"noteIdx",0),Ws(this,"timePos",0),Ws(this,"staffData"),this.drawingContext=t.drawingContext,this.attrs=t.attrs,this.location=t.location,this.stemStrategy=t.stemStrategy,this.isPickup=t.isPickup,this.nbVoices=t.nbVoices,this.staffData=t.staffData;const e=t.attrs.getDpq(),r=t.attrs.getNbDivisions();this.voice=new Bt({voiceIdx:t.location.voiceIdx,voiceUuid:t.location.voiceUuid,voiceIdxInStaff:t.location.voiceIdxInStaff,dpq:e,nbDivisons:r,stemStrategy:t.stemStrategy,drawingContext:this.drawingContext})}build(t){this.fillNotes(t.voiceNotes),this.fillGraceNotes(t.voiceNotes),!this.isRecorderTabStaff()&&(fL(this.voice),this.isTabStaff()||(UL(this.voice),this.voice.fillGracesBeams()))}fillNotes(t){this.isAlone=t.length===1,t.forEach((e,r)=>{const i=this.createNoteDrawer(e,r);this.voice.addNote(i)})}fillGraceNotes(t){t.forEach((e,r)=>{const i=e.graces.map(a=>{const l={chordJson:a,timePos:e.timePos,graces:[]};return this.createNoteDrawer(l,r)});this.voice.addNoteGraces(r,i)})}createNoteDrawer(t,e){this.noteIdx=e,this.timePos=t.timePos;const r=this.getNoteCtx(t.chordJson,t.timePos),i=kg(t.chordJson,this.attrs,r);zt.A.isUp(this.stemStrategy)?i.setSpeficiedStem(z.A.UP):zt.A.isDown(this.stemStrategy)||this.stemStrategy===zt.A.AUTO&&this.isTabStaff()?i.setSpeficiedStem(z.A.DOWN):this.stemStrategy===zt.A.AUTO&&this.isKodalyStaff()&&i.setSpeficiedStem(z.A.UP),i.setStemStrategy(this.stemStrategy);const a=new AL(this.drawingContext,i,this.staffData);return a.setTimePos(t.timePos),a}isRecorderTabStaff(){return this.staffData.type===Zt.A.RECORDER_TAB}isTabStaff(){return this.staffData.type===Zt.A.GUITAR_TAB}isKodalyStaff(){return!1}getNoteCtx(t,e){const r={stemStrategy:this.stemStrategy,isAlone:this.isAlone,isPickup:this.isPickup,noteIdx:this.noteIdx,timePos:e};return W.default.isRest(t[0])&&this.stemStrategy!==zt.A.AUTO&&this.nbVoices===1&&(r.stemStrategy=zt.A.AUTO),r}}var cs=b(558280),zL=Object.defineProperty,YL=(s,t,e)=>t in s?zL(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,yp=(s,t,e)=>YL(s,typeof t!="symbol"?t+"":t,e);class kL{constructor(t,e,r){yp(this,"tickableContent"),yp(this,"measureJson"),yp(this,"staffIdx"),this.tickableContent=t,this.measureJson=e,this.staffIdx=r}build(t){this.addMiddleAnchors(t),this.addLeftContinueAnchors(),this.addRightContinueAnchors()}addMiddleAnchors(t){t.sort(Oi.A.compareTimePosInc),t.forEach(this.addMiddleAnchor,this)}addMiddleAnchor(t){const e=cs.A.getTimePos(t),r=cs.A.getPlacement(t),i=cs.A.getLocation(t),a=cs.A.getType(t);let l=null;i===je.A.LEFT&&(l=cs.A.getWedgeUuid(t));const d=new fn({type:a,placement:r,location:i,timePos:e,wedgeUuid:l});this.tickableContent.addMiddleWedgeAnchor(d)}addLeftContinueAnchors(){if(!Yt.default.hasLeftWedge(this.measureJson,this.staffIdx))return;const t=Yt.default.getLeftWedge(this.measureJson,this.staffIdx);if(cs.A.getStaffIdx(t)===this.staffIdx){const r=cs.A.getPlacement(t),i=cs.A.getLocation(t),a=cs.A.getType(t),l=0,d=cs.A.getWedgeUuid(t),f=new fn({type:a,placement:r,location:i,timePos:l,wedgeUuid:d});this.tickableContent.setLeftWedgeAnchor(f)}}addRightContinueAnchors(){if(!Yt.default.hasRightWedge(this.measureJson,this.staffIdx))return;const t=Yt.default.getRightWedge(this.measureJson,this.staffIdx);if(cs.A.getStaffIdx(t)===this.staffIdx){const r=cs.A.getPlacement(t),i=cs.A.getLocation(t),a=cs.A.getType(t),l=cs.A.getWedgeUuid(t),d=Yt.default.getNbDivisions(this.measureJson),f=new fn({type:a,placement:r,location:i,timePos:d,wedgeUuid:l});this.tickableContent.setRightWedgeAnchor(f)}}}var qL=Object.defineProperty,VL=(s,t,e)=>t in s?qL(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Zc=(s,t,e)=>VL(s,typeof t!="symbol"?t+"":t,e);class QL{constructor(t,e){Zc(this,"textNode"),Zc(this,"timePos"),Zc(this,"placement"),Zc(this,"uuid");const r=t.getTextAnnotationsFontOptions();this.textNode=t.createTextNode(e.text,r);const i={entityType:T.A.TEXT_ANNOTATION,timePos:e.timePos,dpq:e.dpq,placement:e.placement,uuid:e.uuid,text:e.text};this.textNode.setEventPayload(i),this.timePos=e.timePos,this.placement=e.placement,this.uuid=e.uuid}getChildRoot(){return this.textNode}getUuid(){return this.uuid}getTimePos(){return this.timePos}setX(t){this.textNode.setX(t)}getHorizontalData(){const t=this.textNode.getLocalBBox();if(t===null)throw new Error("bbox is null");return{timePos:this.timePos,duration:0,spaceBefore:-t.minX,spaceAfter:t.maxX,isRest:!1}}}function Ap(s,t,e){for(;t<s.length;t++)if(s[t].timePos>=e)return t;return t}function KL(s,t){let e=0;t.forEach(r=>{const i=r.getTimePos();e=Ap(s,e,i);const a=r.getHorizontalData();s.splice(e,0,a)})}function JL(s,t){let e=0;t.forEach(r=>{const i=r.getTimePos();if(e=Ap(s,e,i),e>=s.length)return;const a=s[e];if(a.timePos===i){const d=r.getDrawingContext().getMinSpaceBetweenNotes(),f=r.getWidth();r.setContentAfter(d+a.spaceBefore+f),a.spaceBefore+=d+f}})}function $L(s,t){let e=0,r=0;for(;e<t.length;){const a=t[e].getTimePos();if(r=Ap(s,r,a),r>=s.length)return;s[r].timePos===a?t.splice(e,1):e++}}function ZL(s,t,e){const r=[...s,...t];return r.sort(jL),tM(r).map(l=>rM(l,e))}function jL(s,t){const e=s.getTimePos()-t.getTimePos();return e!==0?e:s.getHorizontalPosition()-t.getHorizontalPosition()}function tM(s){const t=[];return s.forEach(eM,t),t}function eM(s){const t=this;sM(s,t)&&t.push([]);const e=t.length;t[e-1].push(s)}function sM(s,t){const e=t.length;if(e===0)return!0;const i=t[e-1][0].getTimePos();return s.getTimePos()!==i}function rM(s,t){let e=0,r=0,i=s.findIndex(iM);if(i>=0){const d=s[i];r=d.getSpaceBefore(),d.setHorizontalOffset(0),e=d.getWidth()-r;for(let f=i-1;f>=0;f--){const m=s[f];r+=t,r+=m.getWidth(),m.setHorizontalOffset(-r)}i++}else i=0;for(;i<s.length;i++){const d=s[i];e+=t;const f=d.getSpaceBefore();d.setHorizontalOffset(e+f),e+=d.getWidth()}return{timePos:s[0].getTimePos(),spaceBefore:r,spaceAfter:e,duration:0,isRest:!1}}function iM(s){return s instanceof ko}const vy=ZL;function nM(s){s.length<=1||(oM(s),cM(s))}function oM(s){const e=s.map(aM).reduce(Dt.default.lcm);s.forEach(hM,e)}function aM(s){return s.dpq}function hM(s){const e=this.valueOf()/s.dpq;s.dpq*=e,s.nbDivisions*=e,s.entities.forEach(lM,e)}function lM(s){const t=this.valueOf();s.timePos*=t,s.duration*=t}function cM(s){const t=new Map;s.forEach(uM,t),t.forEach(dM)}function uM(s){let t=0;const e=this;s.entities.forEach(function(r){let i=e.get(t);i===void 0&&(i=[],e.set(t,i)),i.push(r),t+=r.duration})}function dM(s){const e=s.map(fM).reduce(Dt.default.max2);s.forEach(gM,e);const i=s.map(pM).reduce(Dt.default.max2);s.forEach(mM,i)}function fM(s){return s.spaceBefore}function gM(s){const t=this.valueOf();s.spaceBefore=t}function pM(s){return s.spaceAfter}function mM(s){const t=this.valueOf();s.spaceAfter=t}const Sy="mutes",yM="dynamicsAbove",AM="dynamicsBelow",vM="pizzicatosAbove",SM="pizzicatosBelow",wM="textAnnotationsAbove",xM="textAnnotationsBelow",bM="jazzHarmonies",PM="romanNumerals",EM="figuredBass",iW="metronome";var DM=Object.defineProperty,CM=(s,t,e)=>t in s?DM(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,le=(s,t,e)=>CM(s,typeof t!="symbol"?t+"":t,e);const TM="tickableContent";class RM{constructor(t){le(this,"drawingContext"),le(this,"groupNode"),le(this,"horizontalData",null),le(this,"horizontalFormatter",null),le(this,"dpq"),le(this,"nbDivisions"),le(this,"voices",new Map),le(this,"mutesAbove",[]),le(this,"mutesBelow",[]),le(this,"dynamicsAbove",[]),le(this,"pizzicatosAbove",[]),le(this,"textAnnotationsAbove",[]),le(this,"dynamicsBelow",[]),le(this,"pizzicatosBelow",[]),le(this,"textAnnotationsBelow",[]),le(this,"jazzHarmonies",[]),le(this,"romanNumerals",[]),le(this,"figuredBasses",[]),le(this,"middleOctaveShiftsAnchors",[]),le(this,"leftOctaveShiftAnchor",null),le(this,"rightOctaveShiftAnchor",null),le(this,"middlePedalsAnchors",[]),le(this,"leftPedalAnchor",null),le(this,"rightPedalAnchor",null),le(this,"middlePluckedRangesAnchors",[]),le(this,"leftPluckedRangeAnchor",null),le(this,"rightPluckedRangeAnchor",null),le(this,"middleWedgesAnchors",[]),le(this,"leftWedgeAnchor",null),le(this,"rightWedgeAnchor",null),le(this,"middleClefs",[]),this.drawingContext=t.drawingContext,this.dpq=t.dpq,this.nbDivisions=t.nbDivisions,this.groupNode=this.drawingContext.createGroupNode(),this.groupNode.setLabel(TM)}addVoice(t){const e=t.getVoiceIdx();this.voices.set(e,t);const r=t.getChildRoot();v(this.groupNode,r)}getVoice(t){return this.hasVoice(t)?this.voices.get(t):null}hasVoice(t){return typeof this.voices.get(t)!="undefined"}addMute(t){const{placement:e}=t;if(e===I.A.ABOVE)this.mutesAbove.push(t);else if(e===I.A.BELOW)this.mutesBelow.push(t);else throw I.A.raiseError(e);const r=t.getChildRoot();v(this.groupNode,r)}hasAboveMutes(){return this.mutesAbove.length>0}hasBelowMutes(){return this.mutesBelow.length>0}addDynamic(t){const{placement:e}=t;if(e===I.A.ABOVE)this.dynamicsAbove.push(t);else if(e===I.A.BELOW)this.dynamicsBelow.push(t);else throw I.A.raiseError(e);const r=t.getChildRoot();v(this.groupNode,r)}hasDynamics(){return this.hasAboveDynamics()||this.hasBelowDynamics()}hasAboveDynamics(){return this.dynamicsAbove.length>0}hasBelowDynamics(){return this.dynamicsBelow.length>0}hasDynamicsOrWedges(){return this.hasAboveDynamics()||this.hasBelowDynamics()||this.hasMiddleWedgesAnchors()}hasAboveDynamicsOrWedges(){return this.dynamicsAbove.length>0||this.getMiddleWedgesAnchorsAbove().length>0}hasBelowDynamicsOrWedges(){return this.dynamicsBelow.length>0||this.getMiddleWedgesAnchorsBelow().length>0}addPizzicato(t){const e=t.placement;if(e===I.A.ABOVE)this.pizzicatosAbove.push(t);else if(e===I.A.BELOW)this.pizzicatosBelow.push(t);else throw I.A.raiseError(e);v(this.groupNode,t.getChildRoot())}addTextAnnotation(t){const e=t.placement;if(e===I.A.ABOVE)this.textAnnotationsAbove.push(t);else if(e===I.A.BELOW)this.textAnnotationsBelow.push(t);else throw I.A.raiseError(e);v(this.groupNode,t.getChildRoot())}addJazzHarmony(t){this.jazzHarmonies.push(t);const e=t.getChildRoot();v(this.groupNode,e)}addRomanNumeral(t){this.romanNumerals.push(t);const e=t.getChildRoot();v(this.groupNode,e)}addFiguredBass(t){this.figuredBasses.push(t);const e=t.getChildRoot();v(this.groupNode,e)}addMiddleOctaveShiftAnchor(t){this.middleOctaveShiftsAnchors.push(t)}setLeftOctaveShiftAnchor(t){this.leftOctaveShiftAnchor=t}setRightOctaveShiftAnchor(t){this.rightOctaveShiftAnchor=t}hasRightOctaveShiftAnchor(){return this.rightOctaveShiftAnchor!==null}getRightOctaveShiftAnchor(){return this.rightOctaveShiftAnchor}hasLeftOctaveShiftAnchor(){return this.leftOctaveShiftAnchor!==null}getLeftOctaveShiftAnchor(){return this.leftOctaveShiftAnchor}getMiddleOctaveShiftsAnchors(){return this.middleOctaveShiftsAnchors}getAllOctaveShiftsAnchors(){const t=[];return this.hasLeftOctaveShiftAnchor()&&t.push(this.getLeftOctaveShiftAnchor()),t.push(...this.getMiddleOctaveShiftsAnchors()),this.hasRightOctaveShiftAnchor()&&t.push(this.getRightOctaveShiftAnchor()),t}addMiddlePedalAnchor(t){this.middlePedalsAnchors.push(t)}setLeftPedalAnchor(t){this.leftPedalAnchor=t}setRightPedalAnchor(t){this.rightPedalAnchor=t}hasRightPedalAnchor(){return this.rightPedalAnchor!==null}getRightPedalAnchor(){return this.rightPedalAnchor}hasLeftPedalAnchor(){return this.leftPedalAnchor!==null}getLeftPedalAnchor(){return this.leftPedalAnchor}getMiddlePedalsAnchors(){return this.middlePedalsAnchors}getAllPedalsAnchors(){const t=[];return this.hasLeftPedalAnchor()&&t.push(this.getLeftPedalAnchor()),t.push(...this.getMiddlePedalsAnchors()),this.hasRightPedalAnchor()&&t.push(this.getRightPedalAnchor()),t}addMiddlePluckedRangeAnchor(t){this.middlePluckedRangesAnchors.push(t)}setLeftPluckedRangeAnchor(t){this.leftPluckedRangeAnchor=t}setRightPluckedRangeAnchor(t){this.rightPluckedRangeAnchor=t}hasRightPluckedRangeAnchor(){return this.rightPluckedRangeAnchor!==null}getRightPluckedRangeAnchor(){return this.rightPluckedRangeAnchor}hasLeftPluckedRangeAnchor(){return this.leftPluckedRangeAnchor!==null}getLeftPluckedRangeAnchor(){return this.leftPluckedRangeAnchor}getMiddlePluckedRangesAnchors(){return this.middlePluckedRangesAnchors}getAllPluckedRangesAnchors(){const t=[];return this.hasLeftPluckedRangeAnchor()&&t.push(this.getLeftPluckedRangeAnchor()),t.push(...this.getMiddlePluckedRangesAnchors()),this.hasRightPluckedRangeAnchor()&&t.push(this.getRightPluckedRangeAnchor()),t}addMiddleWedgeAnchor(t){this.middleWedgesAnchors.push(t)}setLeftWedgeAnchor(t){this.leftWedgeAnchor=t}setRightWedgeAnchor(t){this.rightWedgeAnchor=t}hasRightWedgeAnchor(){return this.rightWedgeAnchor!==null}getRightWedgeAnchor(){return this.rightWedgeAnchor}hasLeftWedgeAnchor(){return this.leftWedgeAnchor!==null}getLeftWedgeAnchor(){return this.leftWedgeAnchor}hasMiddleWedgesAnchors(){this.middleWedgesAnchors.length>0}getAllWedgesAnchors(){const t=[];return this.hasLeftWedgeAnchor()&&t.push(this.getLeftWedgeAnchor()),t.push(...this.getMiddleWedgesAnchors()),this.hasRightWedgeAnchor()&&t.push(this.getRightWedgeAnchor()),t}getMiddleWedgesAnchors(){return this.middleWedgesAnchors}getMiddleWedgesAnchorsAbove(){return this.middleWedgesAnchors.filter(t=>t.isAbove())}getMiddleWedgesAnchorsBelow(){return this.middleWedgesAnchors.filter(t=>t.isBelow())}hasRightBendAnchor(t,e){const r=this.getVoice(t);return!r||!(r instanceof Bt)?!1:r.hasRightBendAnchor(e)}getRightBendAnchor(t,e){const r=this.getVoice(t);return!r||!(r instanceof Bt)?null:r.getRightBendAnchor(e)}hasLeftBendAnchor(t,e){const r=this.getVoice(t);return!r||!(r instanceof Bt)?!1:r.hasLeftBendAnchor(e)}getLeftBendAnchor(t,e){const r=this.getVoice(t);return!r||!(r instanceof Bt)?null:r.getLeftBendAnchor(e)}getMiddleBendAnchors(t,e){const r=this.getVoice(t);return!r||!(r instanceof Bt)?[]:r.getMiddleBendAnchors(e)}hasPizzicatos(){return this.hasAbovePizzicatos()||this.hasBelowPizzicatos()}hasAbovePizzicatos(){return this.pizzicatosAbove.length>0}hasBelowPizzicatos(){return this.pizzicatosBelow.length>0}hasTextAnnotations(){return this.hasAboveTextAnnotations()||this.hasBelowTextAnnotations()}hasAboveTextAnnotations(){return this.textAnnotationsAbove.length>0}hasBelowTextAnnotations(){return this.textAnnotationsBelow.length>0}hasJazzHarmonies(){return this.jazzHarmonies.length>0}hasRomanNumerals(){return this.romanNumerals.length>0}hasFiguredBasses(){return this.figuredBasses.length>0}getChildRoot(){return this.groupNode}getHorizontalData(){return this.horizontalData===null&&(this.horizontalData=this.computeHorizontalData()),this.horizontalData}computeHorizontalData(){const t=this.extractVoicesHorizontalData();return this.hasAboveMutes()&&t.push(this.extractArrayHorizontalData(this.mutesAbove,Sy)),this.hasBelowMutes()&&t.push(this.extractArrayHorizontalData(this.mutesBelow,Sy)),this.hasAboveDynamicsOrWedges()&&t.push(this.extractDynamicsWedgesHorizontalDataAbove()),this.hasBelowDynamicsOrWedges()&&t.push(this.extractDynamicsWedgesHorizontalDataBelow()),this.pizzicatosAbove.length>0&&t.push(this.extractArrayHorizontalData(this.pizzicatosAbove,vM)),this.pizzicatosBelow.length>0&&t.push(this.extractArrayHorizontalData(this.pizzicatosBelow,SM)),this.textAnnotationsAbove.length>0&&t.push(this.extractArrayHorizontalData(this.textAnnotationsAbove,wM)),this.textAnnotationsBelow.length>0&&t.push(this.extractArrayHorizontalData(this.textAnnotationsBelow,xM)),this.jazzHarmonies.length>0&&t.push(this.extractArrayHorizontalData(this.jazzHarmonies,bM)),this.romanNumerals.length>0&&t.push(this.extractArrayHorizontalData(this.romanNumerals,PM)),this.figuredBasses.length>0&&t.push(this.extractArrayHorizontalData(this.figuredBasses,EM)),t}extractVoicesHorizontalData(){const t=Array.from(this.voices.values()).flatMap(i=>i.getHorizontalData()),e=t.filter(i=>i.type===yi.A.NOTE),r=t.filter(i=>i.type!==yi.A.NOTE);if(nM(e),this.middleClefs.length>0){const i=this.middleClefs.slice();e.forEach(a=>JL(a.entities,i)),e.forEach(a=>$L(a.entities,i)),e.forEach(a=>KL(a.entities,i))}return[...e,...r]}extractArrayHorizontalData(t,e){return{dpq:this.dpq,entities:t.map(r=>r.getHorizontalData()),nbDivisions:this.nbDivisions,type:e}}extractDynamicsWedgesHorizontalDataAbove(){return{dpq:this.dpq,entities:vy(this.dynamicsAbove,this.getMiddleWedgesAnchorsAbove(),this.drawingContext.getMarginSize()),nbDivisions:this.nbDivisions,type:yM}}extractDynamicsWedgesHorizontalDataBelow(){return{dpq:this.dpq,entities:vy(this.dynamicsBelow,this.getMiddleWedgesAnchorsBelow(),this.drawingContext.getMarginSize()),nbDivisions:this.nbDivisions,type:AM}}setHorizontalFormatter(t){this.horizontalFormatter=t,this.voices.forEach(e=>e.setHorizontalFormatter(t))}formatHorizontal(t){if(this.horizontalFormatter===null)throw new Error("horizontalFormatter should not be null at this point");this.voices.forEach(e=>e.formatHorizontal()),this.mutesAbove.forEach(e=>this.formatEntityHorizontal(e)),this.mutesBelow.forEach(e=>this.formatEntityHorizontal(e)),this.dynamicsAbove.forEach(e=>this.formatEntityHorizontal(e)),this.dynamicsBelow.forEach(e=>this.formatEntityHorizontal(e)),this.pizzicatosAbove.forEach(e=>this.formatEntityHorizontal(e)),this.pizzicatosBelow.forEach(e=>this.formatEntityHorizontal(e)),this.middleClefs.forEach(this.formatEntityHorizontal,this),this.textAnnotationsAbove.forEach(e=>this.formatEntityHorizontal(e)),this.textAnnotationsBelow.forEach(e=>this.formatEntityHorizontal(e)),this.jazzHarmonies.forEach(e=>this.formatEntityHorizontal(e)),this.romanNumerals.forEach(e=>this.formatEntityHorizontal(e)),this.figuredBasses.forEach(e=>this.formatEntityHorizontal(e)),this.getAllOctaveShiftsAnchors().forEach(e=>this.formatEntityFromAnchorHorizontal(e,t)),this.getAllPedalsAnchors().forEach(e=>this.formatEntityFromAnchorHorizontal(e,t)),this.getAllPluckedRangesAnchors().forEach(e=>this.formatEntityFromAnchorHorizontal(e,t)),this.getAllWedgesAnchors().forEach(e=>{this.formatEntityFromAnchorHorizontal(e,t)})}formatEntityHorizontal(t){const e=t.getTimePos(),r=this.horizontalFormatter;if(r===null)throw new Error("horizontalFormatter should not be null at this point");const i=r.getPosX(e,this.dpq);t.setX(i)}formatEntityFromAnchorHorizontal(t,e){const r=t.getTimePos(),i=t.getRangeEntity();if(i===null)return;const a=this.horizontalFormatter;if(a===null)throw new Error("horizontalFormatter should not be null at this point");const l=a.getPosX(r,this.dpq);t.isLeft()?i.setX1(l+this.getChildRoot().getX()+e):t.isRight()&&i.setX2(l+this.getChildRoot().getX()+e)}setX(t){this.groupNode.setX(t)}getX(){return this.groupNode.getX()}getVoiceUuidFromVoiceIdx(t){const e=this.voices.get(t);return!e||!(e instanceof Bt)?null:e.getVoiceUuid()}extractInitialHeights(){const t=Array.from(this.voices.values()).flatMap(r=>r.extractInitialHeights());t.push(...this.middleClefs.flatMap(r=>Ei(r.getChildRoot())));const e=this.getChildRoot().getX();return t.forEach(r=>{r.position+=e}),t}getLeftSlurAnchor(t){const e=this.voices.get(t);return e&&e instanceof Bt?e.getLeftSlurAnchor():null}getMiddleSlurAnchors(t){const e=this.voices.get(t);return e?e instanceof Bt?e.getMiddleSlurAnchors():[]:[]}getRightSlurAnchor(t){const e=this.voices.get(t);return e&&e instanceof Bt?e.getRightSlurAnchor():null}getLeftTieAnchor(t){const e=this.voices.get(t);return e&&e instanceof Bt?e.getLeftTieAnchor():null}getRightTieAnchor(t){const e=this.voices.get(t);return e&&e instanceof Bt?e.getRightTieAnchor():null}getMiddleTieAnchors(t){const e=this.voices.get(t);return e?e instanceof Bt?e.getMiddleTieAnchors():[]:[]}getLeftHammerOnAnchor(t){const e=this.voices.get(t);return e&&e instanceof Bt?e.getLeftHammerOnAnchor():null}getRightHammerOnAnchor(t){const e=this.voices.get(t);return e&&e instanceof Bt?e.getRightHammerOnAnchor():null}getMiddleHammerOnAnchors(t){const e=this.voices.get(t);return e?e instanceof Bt?e.getMiddleHammerOnAnchors():[]:[]}getLeftSlideAnchor(t){const e=this.voices.get(t);return e&&e instanceof Bt?e.getLeftSlideAnchor():null}getRightSlideAnchor(t){const e=this.voices.get(t);return e&&e instanceof Bt?e.getRightSlideAnchor():null}getMiddleSlideAnchors(t){const e=this.voices.get(t);return e?e instanceof Bt?e.getMiddleSlideAnchors():[]:[]}getLeftGlissandoAnchor(t){const e=this.voices.get(t);return e&&e instanceof Bt?e.getLeftGlissandoAnchor():null}getRightGlissandoAnchor(t){const e=this.voices.get(t);return e&&e instanceof Bt?e.getRightGlissandoAnchor():null}getMiddleGlissandoAnchors(t){const e=this.voices.get(t);return e?e instanceof Bt?e.getMiddleGlissandoAnchors():[]:[]}getVoicesLyrics(t){const e=this.voices.get(t);return e?e instanceof Bt?e.getLyrics():[]:[]}getLeftHyphenAnchor(t){const e=this.voices.get(t);return e&&e instanceof Bt?e.getLeftHyphenAnchor():null}getMiddleHyphenAnchors(t){const e=this.voices.get(t);return e?e instanceof Bt?e.getMiddleHyphenAnchors():[]:[]}getRightHyphenAnchor(t){const e=this.voices.get(t);return e&&e instanceof Bt?e.getRightHyphenAnchor():null}getVoiceAllMelismaLevels(t){const e=this.voices.get(t);return e?e instanceof Bt?e.getAllMelismaLevels():[]:[]}getLeftMelismaAnchor(t,e){const r=this.voices.get(t);return r&&r instanceof Bt?r.getLeftMelismaAnchor(e):null}getMiddleMelismaAnchors(t,e){const r=this.voices.get(t);return r?r instanceof Bt?r.getMiddleMelismaAnchors(e):[]:[]}getRightMelismaAnchor(t,e){const r=this.voices.get(t);return r&&r instanceof Bt?r.getRightMelismaAnchor(e):null}fillNotes(){this.voices.forEach(t=>{t instanceof Bt&&t.fillNotes()})}fillLyrics(){this.voices.forEach(t=>{t instanceof Bt&&t.fillLyrics()})}getTupletsAbove(){const t=[];return this.voices.forEach(e=>{e instanceof Bt&&t.push(...e.aboveTuplets)}),t}getTupletsBelow(){const t=[];return this.voices.forEach(e=>{e instanceof Bt&&t.push(...e.belowTuplets)}),t}addMiddleClef(t){this.middleClefs.push(t),v(this.groupNode,t.getChildRoot())}fillEventsPayloads(){this.voices.forEach(t=>{t instanceof Bt&&t.fillEventsPayloads()})}getPreviousSpace(){if(!this.horizontalFormatter)throw new Error("horizontalFormatter should not be null at this point");return this.horizontalFormatter.getSpaceBeforeNotes()}}const wy=1;function NM(s,t){const e={rightIdx:0,rightLines:t};return s.some(LM,e)}function LM(s){const t=this,e=MM(t,s);if(e!==null&&e-s<wy)return!0;const r=OM(t,s);return r!==null&&s-r<wy}function MM(s,t){return xy(s,t),s.rightIdx===0?null:s.rightLines[s.rightIdx-1]}function OM(s,t){return xy(s,t),s.rightIdx===s.rightLines.length?null:s.rightLines[s.rightIdx]}function xy(s,t){const e=s.rightLines.length;for(;s.rightIdx<e;){if(s.rightLines[s.rightIdx]<t)return;s.rightIdx++}}const BM=1,by=2,io=.5;function IM(s){const t=s[0],e=t.getNbNotes();let r=0,i=0;const a=s[1],l=a.getNbNotes();let d=0,f=0;for(;r<e&&d<l;){const m=t.getNote(r),S=a.getNote(d);i===f?(FM(m,S),r++,d++,i+=m.getDuration(),f+=S.getDuration()):i<=f?(r++,i+=m.getDuration()):f<=i&&(d++,f+=S.getDuration())}}function FM(s,t){if(!UM(s,t))return;let e,r;if(WM(s,t)){const i=s.getChildRoot().getLocalBBox();if(!i)throw new Error("Upper note BBox is not defined");const a=i.maxX;s.setHorizontalShift(-a+-io/2);const l=t.getChildRoot().getLocalBBox();if(!l)throw new Error("Lower note BBox is not defined");const d=-l.minX;t.setHorizontalShift(d+io/2)}else XM(s,t)?(e=s.getMiddleHeadWidth(),s.setHorizontalShift(-e/2),r=t.getMiddleHeadWidth(),t.setHorizontalShift(r/2)):zM(s,t)?(e=s.getMiddleHeadWidth(),s.setHorizontalShift(io/2+e/2),r=t.getMiddleHeadWidth(),t.setHorizontalShift(-io/2-r/2)):(s.setHorizontalShift(io/2),t.setHorizontalShift(-io/2))}function UM(s,t){if(s.isRest()||t.isRest())return!1;const e=s.getDisplayData().getLowestLine(),r=t.getDisplayData().getHighestLine();if(e-r>=BM)return!1;if(e===r){const i=s.getDisplayData().getNbDots(),a=t.getDisplayData().getNbDots();if(i!==a)return!0;const l=Py(s,e),d=Py(t,r);if(!GM(l,d))return!0;const f=Ey(s,e),m=Ey(t,r);if(f!==m)return!0;const S=s.getDisplayData().getBaseQuarterDuration(),w=t.getDisplayData().getBaseQuarterDuration();return S===w?(HM(s,t),!1):!(S<by&&w<by)}return!0}function HM(s,t){_M(s,t)&&(s.noteDisplayData.hasTieStart()?t.removeDots():s.removeDots())}function _M(s,t){if(!t.noteDisplayData.hasDots()||!s.noteDisplayData.hasDots())return!1;const e=s.getDisplayData().getNbDots(),r=t.getDisplayData().getNbDots();return e===r}function Py(s,t){const r=s.getDisplayData().getHeads().find(i=>i.line===t);if(!r)throw new Error(`There is no head for line ${t}`);return r}function GM(s,t){return!(s.notehead!==t.notehead||s.hasParentheses!==t.hasParentheses||s.isHarmonicArtificialTouching!==t.isHarmonicArtificialTouching||s.isHarmonicNaturalTouching!==t.isHarmonicNaturalTouching||s.color!==t.color)}function Ey(s,t){const r=s.getDisplayData().getHeads().find(i=>i.line===t);return r?r.alter:0}const XM=function(s,t){const e=s.getDisplayData().getLowestLine(),r=t.getDisplayData().getHighestLine();return e-r===.5},WM=function(s,t){return t.noteDisplayData.hasDots()||s.hasAccidentals()},zM=function(s,t){const e=s.getDisplayData().getLines().map(Dy),r=t.getDisplayData().getLines().map(Dy);return NM(e,r)};function Dy(s){if(s===null)throw new Error("Line is not defined");return s}const jc=2.5;function YM(s){const t=s[0],e=t.getNbNotes();let r=0,i=0;const a=s[1],l=a.getNbNotes();let d=0,f=0;for(;r<e&&d<l;){const m=t.getNote(r),S=a.getNote(d);i===f?(kM(m,S),r++,d++,i+=m.getDuration(),f+=S.getDuration()):i<=f?(r++,i+=m.getDuration()):f<=i&&(d++,f+=S.getDuration())}}function kM(s,t){s.isRest()&&!t.isRest()?qM(s,t):!s.isRest()&&t.isRest()?VM(s,t):s.isRest()&&t.isRest()&&QM(s,t)}function qM(s,t){const e=s.getDisplayData(),r=t.getDisplayData();let i=e.getLowestLine();const a=r.getHighestLine(),l=i-a;if(l<jc){let d=jc-l;e.isRest()&&e.getBaseQuarterDuration()>1&&(d=Math.ceil(d)),i+=d,e.setLine(i)}}function VM(s,t){const e=s.getDisplayData(),r=t.getDisplayData(),i=e.getLowestLine();let a=r.getHighestLine();const l=i-a;if(l<jc){let d=jc-l;r.isRest()&&r.getBaseQuarterDuration()>1&&(d=Math.ceil(d)),a-=d,r.setLine(a)}}function QM(s,t){const e=s.getDisplayData(),r=t.getDisplayData(),i=e.getBaseQuarterDuration(),a=r.getBaseQuarterDuration();if(i!==a)return;const l=e.getNbDots(),d=r.getNbDots();if(l!==d)return;const f=e.getRestColor(),m=r.getRestColor();if(f!==m)return;let S=e.getLowestLine();S-=2,e.setLine(S);let w=r.getHighestLine();w+=2,r.setLine(w)}var KM=Object.defineProperty,JM=(s,t,e)=>t in s?KM(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Bs=(s,t,e)=>JM(s,typeof t!="symbol"?t+"":t,e);function $M(s){const t=new ZM(s);return t.build(),t.tickableContent}class ZM{constructor(t){Bs(this,"tickableContent"),Bs(this,"drawingContext"),Bs(this,"voicesNotes"),Bs(this,"nbVoices"),Bs(this,"staffIdx"),Bs(this,"attrs"),Bs(this,"staffData"),Bs(this,"staffVoices"),Bs(this,"isPickup"),Bs(this,"measureJson"),Bs(this,"voiceUuidMapping"),Bs(this,"nbMmr"),Bs(this,"hasMeasureRepeat"),this.drawingContext=t.drawingContext,this.voicesNotes=t.voicesNotes,this.nbVoices=this.voicesNotes.size,this.staffIdx=t.staffIdx,this.attrs=t.attr,this.staffVoices=t.staffVoices,this.isPickup=t.isPickup,this.measureJson=t.measureJson,this.voiceUuidMapping=t.voiceUuidMapping,this.staffData=t.staffData,this.nbMmr=t.nbMmr,this.hasMeasureRepeat=t.hasMeasureRepeat;const e=t.attr.getDpq(),r=t.attr.getNbDivisions();this.tickableContent=new RM({drawingContext:this.drawingContext,dpq:e,nbDivisions:r})}build(){this.fillVoices(),this.fillMutes(),this.fillDynamics(),this.fillPizzicatos(),this.fillTextAnnotations(),this.staffIdx===0&&this.fillJazzHarmonies();const t=this.attrs.getNbStaves();this.staffIdx===t-1&&(this.fillRomanNumerals(),this.fillFiguredBasses()),this.fillOctaveShiftAnchors(),this.fillPedalAnchors(),this.fillPluckedRangeAnchors(),this.fillWedgeAnchors(),this.fillMiddleClefs()}fillVoices(){if(this.nbMmr!==null&&this.nbMmr>1){this.fillVoiceMMR(this.nbMmr);return}if(this.hasMeasureRepeat){this.fillVoiceRepeat();return}this.staffVoices.forEach(t=>{const e=this.voicesNotes.get(t);e&&this.fillVoice(e,t)}),this.nbVoices>1&&this.shiftVoicesRests(),this.tickableContent.fillNotes(),this.tickableContent.fillLyrics(),this.nbVoices>1&&this.shiftVoicesNotes()}fillVoiceMMR(t){const e=this.staffVoices[0],r=this.attrs.getNbDivisions(),i=new sc({drawingContext:this.drawingContext,voiceIdx:e,dpq:this.attrs.getDpq(),nbDivisons:r}),a=new Ig(this.drawingContext,t,this.staffData,r);i.setEntity(a),this.tickableContent.addVoice(i)}fillVoiceRepeat(){const t=this.staffVoices[0],e=this.attrs.getNbDivisions(),r=new sc({drawingContext:this.drawingContext,voiceIdx:t,dpq:this.attrs.getDpq(),nbDivisons:e}),i=new eL(this.drawingContext,this.staffData,e);r.setEntity(i),this.tickableContent.addVoice(r)}fillVoice(t,e){const r=this.getStemStrategy(e),i=this.voiceUuidMapping.get(e);if(i===void 0)throw new Error(`Missing voice uuid for ${e}`);const a=this.staffVoices.indexOf(e);if(a===-1)throw new Error(`Voice not found in staff: ${e}`);const l={staffIdx:this.staffIdx,voiceIdx:e,voiceUuid:i,voiceIdxInStaff:a},d=XL({drawingContext:this.drawingContext,voiceNotes:t,measureJson:this.measureJson,attrs:this.attrs,location:l,stemStrategy:r,isPickup:this.isPickup,nbVoices:this.nbVoices,staffData:this.staffData});this.tickableContent.addVoice(d)}fillMutes(){Yt.default.getMutes(this.measureJson,this.staffIdx).forEach(e=>this.fillMute(e))}fillMute(t){const e=Mc.A.getType(t),r=Mc.A.getTimePos(t),i=Mc.A.getUuid(t),a=Mc.A.getPlacement(t),l=this.tickableContent.dpq,d=new Qp(this.drawingContext,{type:e,timePos:r,uuid:i,dpq:l,placement:a});d.fillEventPayload(),this.tickableContent.addMute(d)}fillDynamics(){Yt.default.getDynamics(this.measureJson,this.staffIdx).forEach(e=>this.fillDynamic(e))}fillDynamic(t){const e=Lc.A.getStyle(t),r=Lc.A.getTimePos(t),i=Lc.A.getPlacement(t),a=Lc.A.getDynamicUuid(t),l=this.tickableContent.dpq,d=new ko(this.drawingContext,{type:e,timePos:r,placement:i,uuid:a,dpq:l});d.fillEventPayload(),this.tickableContent.addDynamic(d)}fillPizzicatos(){Yt.default.getPizzicatos(this.measureJson,this.staffIdx).forEach(e=>this.fillPizzicato(e))}fillPizzicato(t){const e=Oc.A.getType(t),r=Oc.A.getTimePos(t),i=Oc.A.getPlacement(t),a=Oc.A.getPizzicatoUuid(t),l=this.tickableContent.dpq,d=new em(this.drawingContext,{timePos:r,placement:i,type:e,uuid:a,dpq:l});d.fillEventPayload(),this.tickableContent.addPizzicato(d)}fillTextAnnotations(){Yt.default.getWords(this.measureJson,this.staffIdx).forEach(e=>this.fillTextAnnotation(e))}fillTextAnnotation(t){const e=Bc.A.getText(t),r=Bc.A.getTimePos(t),i=Bc.A.getPlacement(t),a=Bc.A.getWordUuid(t),l=this.tickableContent.dpq,d=new QL(this.drawingContext,{text:e,timePos:r,dpq:l,placement:i,uuid:a});this.tickableContent.addTextAnnotation(d)}fillJazzHarmonies(){Yt.default.getJazzHarmonies(this.measureJson).forEach(e=>this.fillJazzHarmony(e))}fillJazzHarmony(t){const e=es.default.getTimePos(t),r=this.tickableContent.dpq,i=es.default.getRoot(t),a={"root-step":Qm.A.getStep(i),"root-alter":Qm.A.getAlter(i)},{chordKind:l,suspension:d,degreeModifications:f}=(0,D0.A)(t),m=es.default.getBass(t);let S;m&&(S={"bass-step":Vm.A.getStep(m),"bass-alter":Vm.A.getAlter(m)});const w=es.default.getType(t),x=es.default.getHarmonyUuid(t),D=new cN(this.drawingContext,{timePos:e,dpq:r,kind:l,type:w,root:a,bass:S,suspension:d,degreeModifications:f,uuid:x});this.tickableContent.addJazzHarmony(D)}fillRomanNumerals(){Yt.default.getClassicHarmonies(this.measureJson).forEach(e=>this.fillRomanNumeral(e))}fillRomanNumeral(t){const e=es.default.getTimePos(t),r=this.tickableContent.dpq,i=es.default.getFunction(t),a=es.default.getKindValue(t),l=es.default.getAlter(t),d=es.default.getInversion(t),f=es.default.getHarmonyUuid(t);let m=null,S=null,w=null,x=null;es.default.hasSecondaryFunction(t)&&(m=es.default.getSecondaryFunction(t),S=es.default.getSecondaryKind(t),w=es.default.getSecondaryAlter(t),x=es.default.getSecondaryInversion(t));const D=new LN(this.drawingContext,{timePos:e,dpq:r,chordFunction:i,kind:a,alter:l,inversion:d,secondaryChordFunction:m,secondaryKind:S,secondaryAlter:w,secondaryInversion:x,uuid:f});this.tickableContent.addRomanNumeral(D)}fillFiguredBasses(){Yt.default.getFiguredBasses(this.measureJson).forEach(e=>this.fillFiguredBass(e))}fillFiguredBass(t){const e=$g.A.getTimePos(t),r=this.tickableContent.dpq,i=$g.A.getFiguresData(t),a=$g.A.getUuid(t),l=new $N(this.drawingContext,{timePos:e,dpq:r,figuresData:i,uuid:a});this.tickableContent.addFiguredBass(l)}fillOctaveShiftAnchors(){const t=Yt.default.getOctaveShifts(this.measureJson,this.staffIdx);new iL(this.tickableContent,this.measureJson,this.staffIdx).build(t)}fillPedalAnchors(){const t=Yt.default.getPedals(this.measureJson,this.staffIdx);new aL(this.tickableContent,this.measureJson,this.staffIdx).build(t)}fillPluckedRangeAnchors(){const t=Yt.default.getPluckedRanges(this.measureJson,this.staffIdx);new cL(this.tickableContent,this.measureJson,this.staffIdx).build(t)}fillWedgeAnchors(){const t=Yt.default.getWedges(this.measureJson,this.staffIdx);new kL(this.tickableContent,this.measureJson,this.staffIdx).build(t)}fillMiddleClefs(){Yt.default.getMiddleClefs(this.measureJson,this.staffIdx).forEach(e=>{const r=new Li(this.drawingContext,e,this.staffData),i=rr.default.getTimePos(e),a=rr.default.getClefUuid(e);r.setTimePos(i),r.setUuid(a),this.tickableContent.addMiddleClef(r),r.fillEventPayload()})}getStemStrategy(t){return this.nbVoices===1?this.isPercu()?t===this.staffVoices[0]?zt.A.UP_UNPITCHED:zt.A.DOWN_UNPITCHED:zt.A.AUTO:t===this.staffVoices[0]?(this.isPercu(),zt.A.UP):(this.isPercu(),zt.A.DOWN)}shiftVoicesRests(){const t=this.getVoicesArray();YM(t)}shiftVoicesNotes(){const t=this.getVoicesArray();IM(t)}getVoicesArray(){return this.staffVoices.filter(t=>this.voicesNotes.has(t)).map(t=>{const e=this.tickableContent.voices.get(t);if(!e)throw new Error(`Missing voice ${t}`);if(!(e instanceof Bt))throw new Error("We are only expecting VoiceDrawer instances");return e})}isPercu(){const t=this.attrs.getClef(this.staffIdx);if(t===null)throw new Error("Missing clef");return rr.default.isPercussion(t)}}var vs=b(92856);function jM(s){const t=s.staffData.type===Zt.A.RECORDER_TAB,e=s.staffData.type===Zt.A.GUITAR_TAB,r=s.staffData.type===Zt.A.KODALY;if(t)return null;if(s.measurePosition===vs.A.FIRST_OF_SCORE||s.measurePosition===vs.A.FIRST_OF_SYSTEM)return e?eO(s):r?sO(s):tO(s);if(s.measurePosition===vs.A.MIDDLE)return null;throw new Error(`Invalid measure position: ${s.measurePosition}`)}function tO(s){const t=new za(s.drawingContext),e=s.attr.getClef(s.staffIdx);if(e===null)throw new Error("Clef is missing");const r=new Li(s.drawingContext,e,s.staffData);t.addItem(r),r.fillEventPayload("left");const i=s.attr.getKey(s.staffIdx);if(i===null)throw new Error("Key is missing");let a=null;if(s.previousAttr&&s.measurePosition!==vs.A.FIRST_OF_SCORE&&(a=s.previousAttr.getKey(s.staffIdx),a===null))throw new Error("Previous key is missing");const l=Ym({drawingContext:s.drawingContext,staffData:s.staffData,previousKeyJson:a,keyJson:i,clefJson:e,side:"left",isFirstMeasure:s.measurePosition===vs.A.FIRST_OF_SCORE});l&&t.addItem(l);const{displayedTime:d,previousDisplayedTime:f}=s;if(f===null||s.measurePosition===vs.A.FIRST_OF_SCORE||!ei.default.isSame(d,f)){const m=Qg({drawingContext:s.drawingContext,timeJson:d,staffData:s.staffData,side:"left"});t.addItem(m)}return t}function eO(s){const t=new za(s.drawingContext),e=s.attr.getClef(s.staffIdx);if(e===null)throw new Error("Clef is missing");const r=new Li(s.drawingContext,e,s.staffData);return t.addItem(r),r.fillEventPayload("left"),t}function sO(s){const t=new za(s.drawingContext),{displayedTime:e,previousDisplayedTime:r}=s;if(r===null||s.measurePosition===vs.A.FIRST_OF_SCORE||!ei.default.isSame(e,r)){const i=Qg({drawingContext:s.drawingContext,timeJson:e,staffData:s.staffData,side:"left"});return t.addItem(i),t}return null}var rO=Object.defineProperty,iO=(s,t,e)=>t in s?rO(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,We=(s,t,e)=>iO(s,typeof t!="symbol"?t+"":t,e);const nO="measure";class oO{constructor(t){We(this,"drawingContext"),We(this,"attrs"),We(this,"staffData"),We(this,"previousAttr"),We(this,"previousDisplayedTime"),We(this,"displayedTime"),We(this,"staffIdx"),We(this,"measureUuid"),We(this,"isEmptyValue"),We(this,"leftAttributes",null),We(this,"leftBarline",null),We(this,"tickableContent"),We(this,"rightInternalAttributes",null),We(this,"rightBarline",null),We(this,"rightExternalAttributes",null),We(this,"group"),We(this,"currentPosition",null),We(this,"horizontalData",null),We(this,"horizontalFormatter",null),this.drawingContext=t.drawingContext,this.attrs=t.attr,this.staffData=t.staffData,this.previousAttr=t.previousAttr,this.staffIdx=t.staffIdx,this.displayedTime=t.displayedTime,this.previousDisplayedTime=t.previousDisplayedTime,this.isEmptyValue=t.isEmpty,this.measureUuid=t.measureUuid,this.group=t.drawingContext.createGroupNode(),this.group.setLabel(nO),this.tickableContent=t.tickableContent,v(this.group,this.tickableContent.getChildRoot()),t.rightBarline&&(this.rightBarline=t.rightBarline,v(this.group,this.rightBarline.getChildRoot())),t.leftBarline&&(this.leftBarline=t.leftBarline,v(this.group,this.leftBarline.getChildRoot())),t.rightInternalAttributes&&(this.rightInternalAttributes=t.rightInternalAttributes,v(this.group,this.rightInternalAttributes.group)),t.rightExternalAttributes&&(this.rightExternalAttributes=t.rightExternalAttributes,v(this.group,this.rightExternalAttributes.group))}setCurrentPosition(t){t!==this.currentPosition&&(this.horizontalData=null,this.leftAttributes!==null&&(it(this.group,this.leftAttributes.getChildRoot()),this.leftAttributes.destroy(),this.leftAttributes=null),this.currentPosition=t,this.leftAttributes=jM({measurePosition:t,drawingContext:this.drawingContext,staffData:this.staffData,displayedTime:this.displayedTime,previousDisplayedTime:this.previousDisplayedTime,previousAttr:this.previousAttr,attr:this.attrs,staffIdx:this.staffIdx}),this.leftAttributes!==null&&v(this.group,this.leftAttributes.getChildRoot()))}getChildRoot(){return this.group}getHorizontalData(){return this.horizontalData===null&&(this.horizontalData=this.computeHorizontalData()),this.horizontalData}computeHorizontalData(){if(this.currentPosition===null)throw new Error("currentPosition is null");const t=this.leftAttributes?this.leftAttributes.getWidth():null,e=this.leftBarline?this.leftBarline.getWidth():null,r=this.rightBarline?this.rightBarline.getWidth():null,i=this.rightInternalAttributes?this.rightInternalAttributes.getWidth():null,a=this.rightExternalAttributes?this.rightExternalAttributes.getWidth():null,l=this.tickableContent.getHorizontalData(),d=aO(l);return{leftAttributesWidth:t,leftBarlineWidth:e,rightBarlineWidth:r,rightInternalAttributesWidth:i,rightExternalAttributesWidth:a,tickablesContents:l,spaceBeforeNotes:d}}setHorizontalFormatter(t){if(t!==this.horizontalFormatter){if(this.horizontalFormatter=t,t.tickableFormatter===null)throw new Error("tickableFormatter is null");this.tickableContent.setHorizontalFormatter(t.tickableFormatter)}}getTickableFormatter(){if(this.horizontalFormatter===null)throw new Error("horizontalFormatter is null");return this.horizontalFormatter.getTickableFormatter()}getTickableContentPosition(){return this.tickableContent.getX()}getSpaceBeforeNotes(){if(this.horizontalFormatter===null)throw new Error("horizontalFormatter is null");if(this.horizontalFormatter.spaceBeforeNotes===null)throw new Error("spaceBeforeNotes is null");return this.horizontalFormatter.spaceBeforeNotes}formatHorizontal(){if(this.horizontalFormatter===null)throw new Error("horizontalFormatter is null");let t=0;if(this.horizontalFormatter.leftBlockFormatting!==null){if(this.leftAttributes!==null&&this.leftAttributes.setX(t+this.horizontalFormatter.leftBlockFormatting.leftAttributesPosition),this.leftBarline!==null){const r=this.horizontalFormatter.leftBlockFormatting.leftBarlinePosition;if(r===null)throw new Error("leftBarlinePosition should not be null there");this.leftBarline.setX(t+r)}t+=this.horizontalFormatter.leftBlockFormatting.width}if(this.horizontalFormatter.spaceBeforeNotes===null)throw new Error("spaceBeforeNotes is null");if(t+=this.horizontalFormatter.spaceBeforeNotes,this.horizontalFormatter.tickableFormatter===null)throw new Error("tickableFormatter is null");if(this.tickableContent.setX(t),t+=this.horizontalFormatter.tickableFormatter.getWidth(),this.horizontalFormatter.rightBlockFormatting===null)throw new Error("rightBlockFormatting is null");this.rightInternalAttributes!==null&&this.rightInternalAttributes.setX(t+this.horizontalFormatter.rightBlockFormatting.rightInternalAttributesPosition),this.rightBarline!==null&&this.rightBarline.setX(t+this.horizontalFormatter.rightBlockFormatting.rightBarlinePosition),this.rightExternalAttributes!==null&&this.rightExternalAttributes.setX(t+this.horizontalFormatter.rightBlockFormatting.rightExternalAttributesPosition);const e=this.group.getX();this.tickableContent.formatHorizontal(e)}setX(t){this.group.setX(t)}getX(){return this.group.getX()}getNominalWidth(){if(this.horizontalFormatter===null)throw new Error("horizontalFormatter is null");return this.horizontalFormatter.getNominalWidth()}getWidth(){if(this.horizontalFormatter===null)throw new Error("horizontalFormatter is null");return this.horizontalFormatter.getWidth()}extendBarlines(t){this.leftBarline!==null&&this.leftBarline.extend(t),this.rightBarline!==null&&this.rightBarline.extend(t)}extractInitialHeights(){const t=this.tickableContent.extractInitialHeights();this.leftAttributes&&t.push(...Ei(this.leftAttributes.getChildRoot())),this.rightExternalAttributes&&t.push(...Ei(this.rightExternalAttributes.getChildRoot())),this.rightInternalAttributes&&t.push(...Ei(this.rightInternalAttributes.getChildRoot()));const e=this.group.getX();return t.forEach(r=>{r.position+=e}),t}hasRightOctaveShiftAnchor(){return this.tickableContent.hasRightOctaveShiftAnchor()}getRightOctaveShiftAnchor(){return this.tickableContent.getRightOctaveShiftAnchor()}hasLeftOctaveShiftAnchor(){return this.tickableContent.hasLeftOctaveShiftAnchor()}getLeftOctaveShiftAnchor(){return this.tickableContent.getLeftOctaveShiftAnchor()}getMiddleOctaveShiftsAnchors(){return this.tickableContent.getMiddleOctaveShiftsAnchors()}hasRightPedalAnchor(){return this.tickableContent.hasRightPedalAnchor()}getRightPedalAnchor(){return this.tickableContent.getRightPedalAnchor()}hasLeftPedalAnchor(){return this.tickableContent.hasLeftPedalAnchor()}getLeftPedalAnchor(){return this.tickableContent.getLeftPedalAnchor()}getMiddlePedalsAnchors(){return this.tickableContent.getMiddlePedalsAnchors()}hasRightPluckedRangeAnchor(){return this.tickableContent.hasRightPluckedRangeAnchor()}getRightPluckedRangeAnchor(){return this.tickableContent.getRightPluckedRangeAnchor()}hasLeftPluckedRangeAnchor(){return this.tickableContent.hasLeftPluckedRangeAnchor()}getLeftPluckedRangeAnchor(){return this.tickableContent.getLeftPluckedRangeAnchor()}getMiddlePluckedRangesAnchors(){return this.tickableContent.getMiddlePluckedRangesAnchors()}hasRightWedgeAnchor(){return this.tickableContent.hasRightWedgeAnchor()}getRightWedgeAnchor(){return this.tickableContent.getRightWedgeAnchor()}hasLeftWedgeAnchor(){return this.tickableContent.hasLeftWedgeAnchor()}getLeftWedgeAnchor(){return this.tickableContent.getLeftWedgeAnchor()}getMiddleWedgesAnchors(){return this.tickableContent.getMiddleWedgesAnchors()}hasRightBendAnchor(t,e){return this.tickableContent.hasRightBendAnchor(t,e)}getRightBendAnchor(t,e){return this.tickableContent.getRightBendAnchor(t,e)}hasLeftBendAnchor(t,e){return this.tickableContent.hasLeftBendAnchor(t,e)}getLeftBendAnchor(t,e){return this.tickableContent.getLeftBendAnchor(t,e)}getMiddleBendAnchors(t,e){return this.tickableContent.getMiddleBendAnchors(t,e)}isEmpty(){return this.isEmptyValue}fillEventsPayloads(){this.tickableContent.fillEventsPayloads()}destroy(){this.group.destroy()}getGeometry(){var t;const e=(t=this.horizontalFormatter)==null?void 0:t.tickableFormatter;if(!e)throw new Error("notesFormatting is not set");const r=this.tickableContent.getX(),i=e.getDpq(),a=e.getNbDivisions(),l=structuredClone(e.getPosXByTimePos()),d=Array.from(l.keys()).filter(f=>f!==a).reduce((f,m)=>Math.max(f,m),0);return{measureUuid:this.measureUuid,x:this.group.getX(),originX:r,dpq:i,nbDivisions:a,posXByTimePos:l,highestTimePos:d}}}function aO(s){return Math.max(...s.map(t=>t.entities[0].spaceBefore),0)}var Cy=(s=>(s.THIN="thin",s.THICK="thick",s))(Cy||{});const tu=Cy;var hO=Object.defineProperty,lO=(s,t,e)=>t in s?hO(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ka=(s,t,e)=>lO(s,typeof t!="symbol"?t+"":t,e);class eu{constructor(t,e,r,i){Ka(this,"drawingContext"),Ka(this,"line"),Ka(this,"lineWidth"),Ka(this,"staffHeight"),Ka(this,"currentHeight"),this.drawingContext=t,this.line=t.createLineNode(),i&&this.line.setStrokeColor(i);const a=cO(e,t);this.line.setWidth(a),this.line.setY(0),this.line.setX2(0);const l=(0,Ft.o5)(r);this.line.setY2(l),this.staffHeight=l,this.currentHeight=l,this.lineWidth=a}setX(t){this.line.setX(t)}getSpaceBefore(){return this.lineWidth/2}getSpaceAfter(){return this.lineWidth/2}getChildRoot(){return this.line}extend(t){const e=this.staffHeight+t;e!==this.currentHeight&&(this.line.setY2(e),this.currentHeight=e)}}function cO(s,t){if(s===tu.THICK)return t.getThickBarlineThickness();if(s===tu.THIN)return t.getThinBarlineThickness();throw new Error(`Unexpected barline size: ${s}`)}var uO=Object.defineProperty,dO=(s,t,e)=>t in s?uO(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,su=(s,t,e)=>dO(s,typeof t!="symbol"?t+"":t,e);const fO="barline";class gO{constructor(t){su(this,"items"),su(this,"drawingContext"),su(this,"group"),su(this,"width",0),this.drawingContext=t,this.items=[],this.group=t.createGroupNode(),this.group.setLabel(fO)}addItem(t){if(this.items.length>0){const e=this.items[this.items.length-1],r=pO(this.drawingContext,e,t);this.width+=r}this.width+=t.getSpaceBefore(),t.setX(this.width),this.items.push(t),this.width+=t.getSpaceAfter(),v(this.group,t.getChildRoot())}getChildRoot(){return this.group}getWidth(){return this.width}setX(t){this.group.setX(t)}extend(t){this.items.forEach(e=>{e instanceof eu&&e.extend(t)})}}function pO(s,t,e){return t instanceof eu&&e instanceof eu?s.getBarlineSeparation():s.getRepeatBarlineDotSeparation()}var mO=Object.defineProperty,yO=(s,t,e)=>t in s?mO(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,ru=(s,t,e)=>yO(s,typeof t!="symbol"?t+"":t,e);const Ty="repeatDot";class Ry{constructor(t,e){ru(this,"drawingContext"),ru(this,"groupNode"),ru(this,"upperDot"),ru(this,"lowerDot"),this.drawingContext=t,this.groupNode=t.createGroupNode();const r=(0,Ft.MR)(e),i=Le.A.lineToY(r,e.spaceSize,e.nbStaffLines),a=AO(e);this.upperDot=t.createGlyphNode(Ty),this.upperDot.setX(0),this.upperDot.setY(i-a),t.layoutData.greyRepeatNotations&&this.upperDot.setColor(ir),v(this.groupNode,this.upperDot),this.lowerDot=t.createGlyphNode(Ty),this.lowerDot.setX(0),this.lowerDot.setY(i+a),t.layoutData.greyRepeatNotations&&this.lowerDot.setColor(ir),v(this.groupNode,this.lowerDot)}getSpaceBefore(){return-this.upperDot.glyph.minX}getSpaceAfter(){return this.upperDot.glyph.maxX}setX(t){this.groupNode.setX(t)}getChildRoot(){return this.groupNode}}function AO(s){return s.nbStaffLines%2===0?1:.5}function Ny(s,t,e){if(!(0,Ft.g6)(e))return null;const r=new gO(t);if(si.A.hasRepeatBackward(s)){const a=new Ry(t,e);r.addItem(a)}if(vO(s).forEach(a=>{const l=si.A.hasRepeat(s)&&t.layoutData.greyRepeatNotations?ir:null,d=new eu(t,a,e,l);r.addItem(d)}),si.A.hasRepeatForward(s)){const a=new Ry(t,e);r.addItem(a)}return r}function vO(s){return si.A.getStyle(s).split("-").filter(wO).map(xO)}const SO=["regular","light","heavy"];function wO(s){return SO.includes(s)}function xO(s){if(s==="light"||s==="regular")return tu.THIN;if(s==="heavy")return tu.THICK;throw new Error(`Unsupported barline style: ${s}`)}function bO(s,t,e){if(!Yt.default.hasRepeatForward(e))return null;const r=Yt.default.getLeftBarline(e);return Ny(r,s,t)}function PO(s,t,e){let r;return Yt.default.hasRightBarline(e)?r=Yt.default.getRightBarline(e):r=si.A.createDefaultBarline(),Ny(r,s,t)}var Ur=b(967104),Is=b(694426),It=b(568357),EO=b(458057);function Ly(s){if(s===1)return"1/2";if(s===2)return"full";EO.A.raiseError(s)}var DO=Object.defineProperty,CO=(s,t,e)=>t in s?DO(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,or=(s,t,e)=>CO(s,typeof t!="symbol"?t+"":t,e);class iu{constructor({type:t,bend:e,location:r,alter:i,string:a,tiedLeft:l,tiedRight:d,bendType:f,preBend:m}){or(this,"type"),or(this,"noteDisplayData",null),or(this,"alter"),or(this,"string"),or(this,"bend",null),or(this,"location"),or(this,"horizontalOffset",0),or(this,"tiedLeft"),or(this,"tiedRight"),or(this,"bendType",null),or(this,"preBend",null),this.type=t,this.alter=i,this.string=a,this.location=r,this.tiedLeft=l,this.tiedRight=d,e&&(this.bend=e),f&&(this.bendType=f),m&&(this.preBend=m)}getNoteDisplayData(){return this.noteDisplayData}getPosition(){var t,e;const r=this.location.measure.getX(),i=this.location.measure.getTickableContentPosition(),a=(e=(t=this.location.note)==null?void 0:t.getPosition())!=null?e:0;return r+i+a}getBendType(){return this.bendType}hasPreBend(){return this.preBend}hasBend(){return this.bend!==null}setBend(t){this.bend=t}getBend(){return this.bend}getRangeEntity(){return this.bend}getAlter(){return this.alter}isStart(){return this.type===It.A.START}isStop(){return this.type===It.A.STOP}isLeft(){return this.isStart()}isRight(){return this.isStop()}isContinue(){return!1}getSpaceBefore(){return 0}getWidth(){return 0}setHorizontalOffset(t){this.horizontalOffset=t}getLeftY(){if(!this.location)throw new Error("Location should be set by now");if(this.alter===0){const t=this.stringToY(),e=this.location.measure.drawingContext.getTabSpaceSize();return t-e*1/4}else return this.alterToY()}getRightY(){if(this.alter===0){const t=this.stringToY(),e=this.location.measure.drawingContext.getTabSpaceSize();return t-e*1/4}else return this.alterToY()}isTiedLeft(){return this.tiedLeft}isTiedRight(){return this.tiedRight}getBendLeftX(){return this.location.note===null?this.getTickableContentX():this.isTiedLeft()?this.getTiedX():this.hasPreBend()?this.getLeftShiftedX():this.getNormalX()}getBendRightX(){return this.location.note===null?this.getMeasureEndX():this.isTiedRight()?this.getRightNormalX():this.getRightShiftedX()}setLocation(t){this.location=t}getMeasureEndX(){const t=this.location.measure,e=t.getX(),r=t.getWidth();let i=e+r;const a=t.drawingContext.getMarginSize(),l=t.rightBarline?t.rightBarline.getWidth():0;return this.isTiedRight()?i-=a/2:i-=a+l,i}getTickableContentX(){const t=this.location.measure.tickableContent,e=this.location.measure.getX(),r=t.getX(),i=t.getPreviousSpace();return e+r-i}getTiedX(){return this.getPosition()}getNormalX(){var t,e;const r=this.getPosition(),i=(e=(t=this.location.note)==null?void 0:t.getFretsWidth())!=null?e:0;return r+i/2}getLeftShiftedX(){var t;if(this.location.note===null)throw new Error("Note must be defined for this cases");const e=this.getPosition(),r=(t=this.location.note.getFretsWidth())!=null?t:0,i=this.location.measure.drawingContext.getMarginSize();return e+r+i}getRightNormalX(){const t=this.getPosition(),e=this.location.measure.drawingContext.getMarginSize();return t-e/2}getRightShiftedX(){const t=this.getPosition(),e=this.location.measure.drawingContext.getMarginSize();return t-e}stringToY(){const t=this.location.measure.drawingContext.getTabSpaceSize();return Le.A.stringToY(this.string,t)}alterToY(){return-this.location.measure.drawingContext.getTabSpaceSize()*this.alter*2/3}getRightText(){return this.alter===0?null:Ly(this.alter)}getLeftText(){return Ly(this.alter)}isTextShifted(){return this.location===null||this.location.note===null}getPreBendBottomY(){const t=this.stringToY(),e=this.location.measure.drawingContext.getTabSpaceSize();return t-e*3/4}getPreBendTopY(){return this.alterToY()}getPreBendX(){return this.getNormalX()}}function TO(s,t){s.tickableContent.voices.forEach(e=>RO(s,e,t))}function RO(s,t,e){if(!(t instanceof Bt))return;const r=(e==null?void 0:e.getLastNoteDisplayData(t.getVoiceIdx()))||null,i=NO(r,t,s);i.forEach((a,l)=>{a.setLocation({measure:s,note:t.notes[0]}),t.addMiddleBendAnchor(l,a),i.delete(l)}),t.notes.forEach((a,l)=>{const d=l===0?r:t.notes[l-1].getDisplayData(),f=a.getDisplayData();f.getHeads().forEach((S,w)=>{var x,D;const L=f.getBendForNoteIdx(w),M=f.getPreBendForNoteIdx(w),H=f.getFrets()[w];if(!H||!L&&!M)return;const $=H.string;let lt;if(M)lt=Ur.A.getAlter(M);else if(L)lt=LO(d,f,w,L);else throw new Error("Neither bend nor prebend");let gt,yt;L?(gt=Ur.A.getAlter(L),yt=Ur.A.getType(L)):(gt=Ur.A.getAlter(M),yt=Is.A.PRE_BEND);const dt=(x=t.notes[l+1])!=null?x:null,At=(D=dt==null?void 0:dt.getDisplayData())!=null?D:null,Jt=new iu({type:It.A.START,alter:lt,string:$,location:{measure:s,note:a},tiedLeft:f.hasTieStop(),tiedRight:f.hasTieStart(),preBend:!!M}),re=new iu({type:It.A.STOP,bendType:yt,alter:gt,string:$,location:{measure:s,note:dt},tiedLeft:f.hasTieStop(),tiedRight:f.hasTieStart()});f.hasTieStart()?(t.addMiddleBendAnchor($,Jt),At===null?i.set($,re):t.addMiddleBendAnchor($,re)):(t.addMiddleBendAnchor($,Jt),t.addMiddleBendAnchor($,re))}),i.forEach((S,w)=>{t.addRightBendAnchor(w,S)})})}function NO(s,t,e){const r=new Map;return s===null||s.getHeads().forEach((a,l)=>{if(!s.hasTieStart())return;const d=s.getBendForNoteIdx(l),f=s.getPreBendForNoteIdx(l),m=s.getFrets()[l];if(!m||!d&&!f)return;const S=m.string,w=f?Is.A.PRE_BEND:Ur.A.getType(d),x=f?Ur.A.getAlter(f):nu(w),D=new iu({type:It.A.START,alter:x,string:Number(S),location:{measure:e,note:null},tiedLeft:!1,tiedRight:!0}),L=new iu({type:It.A.STOP,alter:f?x:Ur.A.getAlter(d),string:Number(S),bendType:w,location:{measure:e,note:null},tiedLeft:!1,tiedRight:!0});t.addLeftBendAnchor(S,D),r.set(S,L)}),r}function LO(s,t,e,r){const i=Ur.A.getType(r);if(!t.hasTieStop()||s===null)return nu(i);if(s.getBendForNoteIdx(e)){const a=s.getBendForNoteIdx(e);return Ur.A.getAlter(a)}if(s.getPreBendForNoteIdx(e)){const a=s.getPreBendForNoteIdx(e);return Ur.A.getAlter(a)}return nu(i)}function nu(s){return s===Is.A.BEND?0:s===Is.A.RELEASE?2:(Is.A.raiseError(s),0)}var MO=Object.defineProperty,OO=(s,t,e)=>t in s?MO(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,ou=(s,t,e)=>OO(s,typeof t!="symbol"?t+"":t,e);class au{constructor(t,e,r){ou(this,"displayData"),ou(this,"type"),ou(this,"location"),ou(this,"glissando",null),this.displayData=t,this.type=e,this.location=r}isStart(){return this.type===It.A.START}isStop(){return this.type===It.A.STOP}hasLocation(){return this.location!==null}getPosition(){if(!this.location)throw new Error("Cannot get position of anchor without location");const t=this.location.measure.getX(),e=this.location.measure.getTickableContentPosition(),r=this.location.note.getPosition();return t+e+r}getTimePos(){if(!this.location)throw new Error("Cannot get timepos of anchor without location");return this.location.note.getTimePos()}getOppositeEdgePosition(){if(!this.location)throw new Error("Cannot get position of anchor without location");if(this.isStart()){if(!this.location.measure.horizontalFormatter)throw new Error("Cannot get right X without left anchor location formatter");if(!this.location.measure.horizontalFormatter.tickableFormatter)throw new Error("Cannot get right X without left anchor location tickable formatter");const t=this.location.measure.getX(),e=this.location.measure.getTickableContentPosition(),r=this.location.measure.horizontalFormatter.tickableFormatter.getWidth();return t+e+r}else if(this.isStop()){const t=this.location.measure.getX(),e=this.location.measure.getTickableContentPosition(),r=this.location.measure.getSpaceBeforeNotes();return t+e-r}else throw It.A.raiseError(this.type)}}function BO(s,t,e){s.tickableContent.voices.forEach(r=>{if(r instanceof Bt){r.notes.forEach(d=>{const f=d.getDisplayData();if(f.hasGlissandoStops()){const m=new au(f,It.A.STOP,{note:d,measure:s});r.addMiddleGlissandoAnchor(m)}if(f.hasGlissandoStarts()){const m=new au(f,It.A.START,{note:d,measure:s});r.addMiddleGlissandoAnchor(m)}});const i=r.getVoiceIdx(),a=(t==null?void 0:t.getLastNoteDisplayData(i))||null;if(a&&a.hasGlissandoStarts()){const d=new au(a,It.A.START,null);r.setLeftGlissandoAnchor(d)}const l=(e==null?void 0:e.getFirstNoteDisplayData(i))||null;if(l&&l.hasGlissandoStops()){const d=new au(l,It.A.STOP,null);r.setRightGlissandoAnchor(d)}}})}var IO=Object.defineProperty,FO=(s,t,e)=>t in s?IO(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,hu=(s,t,e)=>FO(s,typeof t!="symbol"?t+"":t,e);class lu{constructor(t,e,r){hu(this,"displayData"),hu(this,"type"),hu(this,"location"),hu(this,"hammerOn",null),this.displayData=t,this.type=e,this.location=r}isStart(){return this.type===It.A.START}isStop(){return this.type===It.A.STOP}hasLocation(){return this.location!==null}getPosition(){if(!this.location)throw new Error("Cannot get position of anchor without location");const t=this.location.measure.getX(),e=this.location.measure.getTickableContentPosition(),r=this.location.note.getPosition();return t+e+r}getOppositeEdgePosition(){if(!this.location)throw new Error("Cannot get position of anchor without location");if(this.isStart()){if(!this.location.measure.horizontalFormatter)throw new Error("Cannot get right X without left anchor location formatter");if(!this.location.measure.horizontalFormatter.tickableFormatter)throw new Error("Cannot get right X without left anchor location tickable formatter");const t=this.location.measure.getX(),e=this.location.measure.getTickableContentPosition(),r=this.location.measure.horizontalFormatter.tickableFormatter.getWidth();return t+e+r}else if(this.isStop()){const t=this.location.measure.getX(),e=this.location.measure.getTickableContentPosition(),r=this.location.measure.getSpaceBeforeNotes();return t+e-r}else throw It.A.raiseError(this.type)}}function UO(s,t,e){s.tickableContent.voices.forEach(r=>{if(r instanceof Bt){r.notes.forEach(d=>{const f=d.getDisplayData();if(f.hasHammerOnPullOffStop()){const m=new lu(f,It.A.STOP,{note:d,measure:s});r.addMiddleHammerOnAnchor(m)}if(f.hasHammerOnPullOffStart()){const m=new lu(f,It.A.START,{note:d,measure:s});r.addMiddleHammerOnAnchor(m)}});const i=r.getVoiceIdx(),a=(t==null?void 0:t.getLastNoteDisplayData(i))||null;if(a&&a.hasHammerOnPullOffStart()){const d=new lu(a,It.A.START,null);r.setLeftHammerOnAnchor(d)}const l=(e==null?void 0:e.getFirstNoteDisplayData(i))||null;if(l&&l.hasHammerOnPullOffStop()){const d=new lu(l,It.A.STOP,null);r.setRightHammerOnAnchor(d)}}})}var HO=Object.defineProperty,_O=(s,t,e)=>t in s?HO(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,cu=(s,t,e)=>_O(s,typeof t!="symbol"?t+"":t,e);class no{constructor(t,e,r){cu(this,"type"),cu(this,"location"),cu(this,"connections"),cu(this,"hyphen",null),this.type=t,this.location=e,this.connections=r}isStart(){return this.type===It.A.START}isStop(){return this.type===It.A.STOP}hasLocation(){return this.location!==null}getPosition(){if(!this.location)throw new Error("Cannot get position of anchor without location");const t=this.location.measure.getX(),e=this.location.measure.getTickableContentPosition(),r=this.location.lyrics.getPosition();return t+e+r}getOppositeEdgePosition(){if(!this.location)throw new Error("Cannot get position of anchor without location");if(this.isStart()){if(!this.location.measure.horizontalFormatter)throw new Error("Cannot get right X without left anchor location formatter");if(!this.location.measure.horizontalFormatter.tickableFormatter)throw new Error("Cannot get right X without left anchor location tickable formatter");const t=this.location.measure.getX(),e=this.location.measure.getTickableContentPosition(),r=this.location.measure.horizontalFormatter.tickableFormatter.getWidth();return t+e+r}else if(this.isStop()){const t=this.location.measure.getX(),e=this.location.measure.getTickableContentPosition(),r=this.location.measure.getSpaceBeforeNotes();return t+e-r}else throw It.A.raiseError(this.type)}}function GO(s,t){s.tickableContent.voices.forEach(e=>XO(e,s,t))}function XO(s,t,e){if(!(s instanceof Bt))return;const r=s.notes.length,i=[];s.notes.forEach((d,f)=>{const m=f+1;if(m===r)return;const S=s.notes[m],w=d.getDisplayData(),x=S.getDisplayData();if(!My(w,x))return;const D=vp(w,x),L=D.map(At=>({level:At.level,hasData:At.left})),M=s.getLyricByNoteIdx(f),H=M?{lyrics:M,measure:t}:null,$=new no(It.A.START,H,L);i.push($);const lt=D.map(At=>({level:At.level,hasData:At.right})),gt=s.getLyricByNoteIdx(m),yt=gt?{lyrics:gt,measure:t}:null,dt=new no(It.A.STOP,yt,lt);i.push(dt)});const a=WO(s,t,e);a!==null&&i.unshift(a);const l=zO(s,t);l!==null&&i.push(l),i.forEach(s.addMiddleHyphenAnchor,s)}function My(s,t){return Oy(s)||YO(t)}function WO(s,t,e){const r=s.getVoiceIdx(),i=(e==null?void 0:e.getLastNoteDisplayData(r))||null;if(i===null)return null;const a=0,d=s.notes[a].getDisplayData();if(!My(i,d))return null;const f=vp(i,d),m=f.map(M=>({level:M.level,hasData:!1})),S=new no(It.A.START,null,m);s.setLeftHyphenAnchor(S);const w=f.map(M=>({level:M.level,hasData:M.right})),x=s.getLyricByNoteIdx(a),D=x?{lyrics:x,measure:t}:null;return new no(It.A.STOP,D,w)}function Oy(s){return s.getLyrics().some(Ne.default.hasRightConnection)}function zO(s,t){const e=s.notes.length-1,i=s.notes[e].getDisplayData();if(!Oy(i))return null;const l=vp(i,{getLyrics(){return[]}}),d=l.map(D=>({level:D.level,hasData:!1})),f=new no(It.A.STOP,null,d);s.setRightHyphenAnchor(f);const m=l.map(D=>({level:D.level,hasData:D.left})),S=s.getLyricByNoteIdx(e),w=S?{lyrics:S,measure:t}:null;return new no(It.A.START,w,m)}function YO(s){return s.getLyrics().some(Ne.default.hasLeftConnection)}function vp(s,t){const e=s.getLyrics(),r=t.getLyrics(),i=e.map(Ne.default.getLevel),a=r.map(Ne.default.getLevel),l=new Set(i),d=new Set(a),f=new Set([...l,...d]),m=Array.from(f.values());return m.sort(Dt.default.cmp),m.map(w=>{const x=l.has(w),D=d.has(w);return{left:x,right:D,level:w}})}var kO=Object.defineProperty,qO=(s,t,e)=>t in s?kO(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ja=(s,t,e)=>qO(s,typeof t!="symbol"?t+"":t,e);class oo{constructor(t,e,r,i){Ja(this,"type"),Ja(this,"location"),Ja(this,"level"),Ja(this,"melisma",null),Ja(this,"isRealStart"),this.type=t,this.location=e,this.level=r,this.isRealStart=i}isStart(){return this.type===It.A.START}isStop(){return this.type===It.A.STOP}hasLocation(){return this.location!==null}getPosition(){if(!this.location)throw new Error("Cannot get position of anchor without location");const t=this.location.measure.getX(),e=this.location.measure.getTickableContentPosition(),r=this.location.lyrics.getPosition();return t+e+r}getOppositeEdgePosition(){if(!this.location)throw new Error("Cannot get position of anchor without location");if(this.isStart()){if(!this.location.measure.horizontalFormatter)throw new Error("Cannot get right X without left anchor location formatter");if(!this.location.measure.horizontalFormatter.tickableFormatter)throw new Error("Cannot get right X without left anchor location tickable formatter");const t=this.location.measure.getX(),e=this.location.measure.getTickableContentPosition(),r=this.location.measure.horizontalFormatter.tickableFormatter.getWidth();return t+e+r}else if(this.isStop()){const t=this.location.measure.getX(),e=this.location.measure.getTickableContentPosition(),r=this.location.measure.getSpaceBeforeNotes();return t+e-r}else throw It.A.raiseError(this.type)}}function VO(s,t){s.tickableContent.voices.forEach(e=>QO(e,s,t))}function QO(s,t,e){if(!(s instanceof Bt))return;const r=KO(e,s.getVoiceIdx());r.forEach((i,a)=>{s.addLeftMelismaAnchor(i,a)}),s.notes.forEach((i,a)=>{const d=i.getDisplayData().getLyrics().filter(Ne.default.hasMelisma),f=s.getLyricByNoteIdx(a);f!==null&&d.forEach(m=>{const S=Ne.default.getLevel(m);if(Ne.default.isContinuedMelisma(m)){if(r.has(S))return;const w=new oo(It.A.START,{lyrics:f,measure:t},S,!1);s.addMiddleMelismaAnchor(w,S),r.set(S,w)}else if(Ne.default.hasRightMelisma(m)){if(r.has(S))throw new Error(`There is already a start anchor for level ${S}`);const w=new oo(It.A.START,{lyrics:f,measure:t},S,!0);s.addMiddleMelismaAnchor(w,S),r.set(S,w)}else if(Ne.default.hasLeftMelisma(m)){let w=r.get(S);r.delete(S),w||(w=new oo(It.A.START,{lyrics:f,measure:t},S,!1),s.addMiddleMelismaAnchor(w,S));const x=new oo(It.A.STOP,{lyrics:f,measure:t},S,!1);s.addMiddleMelismaAnchor(x,S)}})}),r.forEach((i,a)=>{const l=new oo(It.A.STOP,null,a,!1);s.addRightMelismaAnchor(l,a)})}function KO(s,t){const e=new Map,r=(s==null?void 0:s.getLastNoteDisplayData(t))||null;return r===null||r.getLyrics().filter(Ne.default.hasRightMelisma).forEach(l=>{const d=Ne.default.getLevel(l),f=new oo(It.A.START,null,d,!1);e.set(d,f)}),e}var JO=Object.defineProperty,$O=(s,t,e)=>t in s?JO(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,uu=(s,t,e)=>$O(s,typeof t!="symbol"?t+"":t,e);class du{constructor(t,e,r){uu(this,"displayData"),uu(this,"type"),uu(this,"location"),uu(this,"slide",null),this.displayData=t,this.type=e,this.location=r}isStart(){return this.type===It.A.START}isStop(){return this.type===It.A.STOP}hasLocation(){return this.location!==null}getPosition(){if(!this.location)throw new Error("Cannot get position of anchor without location");const t=this.location.measure.getX(),e=this.location.measure.getTickableContentPosition(),r=this.location.note.getPosition();return t+e+r}getTimePos(){if(!this.location)throw new Error("Cannot get timepos of anchor without location");return this.location.note.getTimePos()}getOppositeEdgePosition(){if(!this.location)throw new Error("Cannot get position of anchor without location");if(this.isStart()){if(!this.location.measure.horizontalFormatter)throw new Error("Cannot get right X without left anchor location formatter");if(!this.location.measure.horizontalFormatter.tickableFormatter)throw new Error("Cannot get right X without left anchor location tickable formatter");const t=this.location.measure.getX(),e=this.location.measure.getTickableContentPosition(),r=this.location.measure.horizontalFormatter.tickableFormatter.getWidth();return t+e+r}else if(this.isStop()){const t=this.location.measure.getX(),e=this.location.measure.getTickableContentPosition(),r=this.location.measure.getSpaceBeforeNotes();return t+e-r}else throw It.A.raiseError(this.type)}}function ZO(s,t,e){s.tickableContent.voices.forEach(r=>{if(r instanceof Bt){r.notes.forEach(d=>{const f=d.getDisplayData();if(f.hasSlideStops()){const m=new du(f,It.A.STOP,{note:d,measure:s});r.addMiddleSlideAnchor(m)}if(f.hasSlideStarts()){const m=new du(f,It.A.START,{note:d,measure:s});r.addMiddleSlideAnchor(m)}});const i=r.getVoiceIdx(),a=(t==null?void 0:t.getLastNoteDisplayData(i))||null;if(a&&a.hasSlideStarts()){const d=new du(a,It.A.START,null);r.setLeftSlideAnchor(d)}const l=(e==null?void 0:e.getFirstNoteDisplayData(i))||null;if(l&&l.hasSlideStops()){const d=new du(l,It.A.STOP,null);r.setRightSlideAnchor(d)}}})}var jO=Object.defineProperty,tB=(s,t,e)=>t in s?jO(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,fu=(s,t,e)=>tB(s,typeof t!="symbol"?t+"":t,e);class gu{constructor(t,e,r){fu(this,"displayData"),fu(this,"type"),fu(this,"location"),fu(this,"tie",null),this.displayData=t,this.type=e,this.location=r}isStart(){return this.type===It.A.START}isStop(){return this.type===It.A.STOP}hasLocation(){return this.location!==null}getPosition(){if(!this.location)throw new Error("Cannot get position of anchor without location");const t=this.location.measure.getX(),e=this.location.measure.getTickableContentPosition(),r=this.location.note.getPosition();return t+e+r}getOppositeEdgePosition(){if(!this.location)throw new Error("Cannot get position of anchor without location");if(this.isStart()){if(!this.location.measure.horizontalFormatter)throw new Error("Cannot get right X without left anchor location formatter");if(!this.location.measure.horizontalFormatter.tickableFormatter)throw new Error("Cannot get right X without left anchor location tickable formatter");const t=this.location.measure.getX(),e=this.location.measure.getTickableContentPosition(),r=this.location.measure.horizontalFormatter.tickableFormatter.getWidth();return t+e+r}else if(this.isStop()){const t=this.location.measure.getX(),e=this.location.measure.getTickableContentPosition(),r=this.location.measure.getSpaceBeforeNotes();return t+e-r}else throw It.A.raiseError(this.type)}}function eB(s,t,e){s.tickableContent.voices.forEach(r=>{if(r instanceof Bt){r.notes.forEach(d=>{const f=d.getDisplayData();if(f.hasTieStop()){const m=new gu(f,It.A.STOP,{note:d,measure:s});r.addMiddleTieAnchor(m)}if(f.hasTieStart()){const m=new gu(f,It.A.START,{note:d,measure:s});r.addMiddleTieAnchor(m)}});const i=r.getVoiceIdx(),a=(t==null?void 0:t.getLastNoteDisplayData(i))||null;if(a&&a.hasTieStart()){const d=new gu(a,It.A.START,null);r.setLeftTieAnchor(d)}const l=(e==null?void 0:e.getFirstNoteDisplayData(i))||null;if(l&&l.hasTieStop()){const d=new gu(l,It.A.STOP,null);r.setRightTieAnchor(d)}}})}var sB=Object.defineProperty,rB=Object.defineProperties,iB=Object.getOwnPropertyDescriptors,By=Object.getOwnPropertySymbols,nB=Object.prototype.hasOwnProperty,oB=Object.prototype.propertyIsEnumerable,Iy=(s,t,e)=>t in s?sB(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Fy=(s,t)=>{for(var e in t||(t={}))nB.call(t,e)&&Iy(s,e,t[e]);if(By)for(var e of By(t))oB.call(t,e)&&Iy(s,e,t[e]);return s},aB=(s,t)=>rB(s,iB(t));function hB(s){var t,e,r,i;const a=bO(s.drawingContext,s.staffData,s.measureJson),l=PO(s.drawingContext,s.staffData,s.measureJson);let d=null;Yt.default.hasRightBarline(s.measureJson)&&(d=Yt.default.getRightBarline(s.measureJson));const f=aB(Fy({},s),{rightBarline:d,nextAttr:((t=s.nextMeasureData)==null?void 0:t.getAttrs())||null,displayedTime:s.displayedTime,nextDisplayTime:((e=s.nextMeasureData)==null?void 0:e.getDisplayedTime())||null}),m=x0(f),S=b0(f),w=lB(s.measureJson,s.staffIdx),x=s.attr.getAnyTime(),D=!ei.default.isSame(x,s.displayedTime),L=Yt.default.hasMeasureRepeat(s.measureJson,s.staffIdx),M=Fy({voicesNotes:w,isPickup:D,hasMeasureRepeat:L},s),H=$M(M),$=((r=s.previousMeasureData)==null?void 0:r.getDisplayedTime())||null,lt=(0,h0.A)(s.measureJson),gt=new oO({measureUuid:s.measureUuid,tickableContent:H,rightBarline:l,leftBarline:a,rightInternalAttributes:S,rightExternalAttributes:m,attr:s.attr,displayedTime:s.displayedTime,previousDisplayedTime:$,staffData:s.staffData,previousAttr:((i=s.previousMeasureData)==null?void 0:i.getAttrs())||null,staffIdx:s.staffIdx,drawingContext:s.drawingContext,isEmpty:lt});return s.staffData.type===Zt.A.STANDARD&&(eB(gt,s.previousMeasureData,s.nextMeasureData),BO(gt,s.previousMeasureData,s.nextMeasureData),GO(gt,s.previousMeasureData),VO(gt,s.previousMeasureData),E0(gt,s.measureJson)),(s.staffData.type===Zt.A.STANDARD||s.staffData.type===Zt.A.GUITAR_TAB)&&(ZO(gt,s.previousMeasureData,s.nextMeasureData),UO(gt,s.previousMeasureData,s.nextMeasureData)),s.staffData.type===Zt.A.GUITAR_TAB&&TO(gt,s.previousMeasureData),gt.fillEventsPayloads(),gt}function lB(s,t){let e=Yt.default.getNotes(s);e=e.filter(d=>W.default.getStaffIdx(d)===t);const r={note:e},i=new l0.A(r),a=i.getVoicesIndexes();return new Map(a.map(d=>{const f=i.getVoice(d),m=f.getNbNotes(),S=[];let w=0;for(let x=0;x<m;x++){let D=f.getChord(x);D=qi.default.makeArray(D).slice();const[L]=D,M=f.getNbGraces(x),H=[];for(let lt=0;lt<M;lt++){let gt=f.getGraceChord(x,lt);gt=qi.default.makeArray(gt).slice(),H.push(gt)}const $={chordJson:D,timePos:w,graces:H};S.push($),w+=W.default.getDuration(L)}return[d,S]}))}function cB(s){let t=null;s.rawData.previousMeasureData&&(t=new Xm(s.rawData.previousMeasureData,s.displayOpts));let e=null;return s.rawData.nextMeasureData&&(e=new Xm(s.rawData.nextMeasureData,s.displayOpts)),s.partData.staves.map((r,i)=>{const a=s.partData.stavesVoices[i],l=new Bm.A(s.rawData.measureJson,{isConcertPitch:!!s.displayOpts.isConcertPitch});return hB({measureUuid:s.rawData.measureUuid,drawingContext:s.drawingContext,staffData:r,staffIdx:i,measureJson:s.rawData.measureJson,previousMeasureData:t,nextMeasureData:e,attr:l,displayedTime:s.rawData.displayedTime,nbMmr:s.rawData.nbMmr,staffVoices:a,voiceUuidMapping:s.partData.voiceUuidMapping})})}var uB=Object.defineProperty,Uy=Object.getOwnPropertySymbols,dB=Object.prototype.hasOwnProperty,fB=Object.prototype.propertyIsEnumerable,Sp=(s,t,e)=>t in s?uB(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,gB=(s,t)=>{for(var e in t||(t={}))dB.call(t,e)&&Sp(s,e,t[e]);if(Uy)for(var e of Uy(t))fB.call(t,e)&&Sp(s,e,t[e]);return s},wp=(s,t,e)=>Sp(s,typeof t!="symbol"?t+"":t,e);class xp{constructor(t){wp(this,"partUuid"),wp(this,"measureUuid"),wp(this,"data",null),this.partUuid=t.partUuid,this.measureUuid=t.measureUuid}setData(t){this.destroy(),this.data=t}getPartMeasures(){return Array.isArray(this.data)?this.data:null}getOrCreatePartMeasures(t){if(Array.isArray(this.data))return this.data;if(this.data===null)throw new Error(`Data missing to render part measures at part ${this.partUuid} and measure ${this.measureUuid}`);return this.data=cB(gB({rawData:this.data},t)),this.data}destroy(){Array.isArray(this.data)&&this.data.forEach(t=>{t.destroy()}),this.data=null}}var pB=Object.defineProperty,mB=(s,t,e)=>t in s?pB(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,bp=(s,t,e)=>mB(s,typeof t!="symbol"?t+"":t,e);function yB(s,t){return new AB(t).process(s)}class AB{constructor(t){bp(this,"maxPosX",0),bp(this,"map",new Map([[0,0]])),bp(this,"margin"),this.margin=t}process(t){return t.forEach(this.processEntry,this),this.map}processEntry(t){const r=this.getX(t.previousTimePos)+t.distanceWithPrevious;this.maxPosX=Math.max(this.maxPosX,r),this.setX(t.timePos,r)}getX(t){const e=this.map.get(t);if(e===void 0)throw new Error(`No x found for timePos ${t}`);return e}setX(t,e){const r=this.map.get(t);if(r===void 0){const i=this.maxPosX+this.margin;e=Math.max(i,e),this.map.set(t,e),this.maxPosX=e}else e=Math.max(r,e),this.maxPosX=e,this.map.set(t,e)}}function vB(s,t){if(s.entities.length===0)return[];const e=t.getMinSpaceBetweenNotes(),r=s.entities.map(SB,e),i=s.entities[s.entities.length-1];if(i.timePos!==s.nbDivisions){const a=wB(i,s.nbDivisions,e);r.push(a)}return r}function SB(s,t,e){const r=s.timePos;if(t===0)return{timePos:r,previousTimePos:0,distanceWithPrevious:0};const i=this.valueOf(),a=e[t-1],l=a.timePos,d=a.spaceAfter+i+s.spaceBefore;return{timePos:r,previousTimePos:l,distanceWithPrevious:d}}function wB(s,t,e){return{timePos:t,previousTimePos:s.timePos,distanceWithPrevious:s.spaceAfter+e}}function xB(s,t){const e=s.flatMap(a=>vB(a,t));bB(e);const r=t.getMinSpaceBetweenNotes();return yB(e,r)}function bB(s){s.sort((t,e)=>t.timePos-e.timePos)}function Hy(s,t){const e=Array.from(s.entries());e.sort(PB);let r=e[e.length-1][0],i=t/r;const a=EB(e),l=a.slice();do{let f=!1;for(let m=l.length-1;m>=0;m--){const S=l[m];S.width/S.duration>i&&(l.splice(m,1),t-=S.width,r-=S.duration,f=!0)}if(f)i=i=t/r;else{l.forEach(m=>{m.width=m.duration*i});break}}while(l.length>0);return DB(a)}function PB(s,t){return s[0]-t[0]}function EB(s){const t=[];return s.forEach(([e,r],i)=>{if(i===0)return;const[a,l]=s[i-1],d=e-a,f=r-l;t.push({width:f,duration:d})}),t}function DB(s){const t=new Map([[0,0]]);let e=0,r=0;return s.forEach(({width:i,duration:a})=>{r+=i,e+=a,t.set(e,r)}),t}var CB=Object.defineProperty,TB=(s,t,e)=>t in s?CB(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Fs=(s,t,e)=>TB(s,typeof t!="symbol"?t+"":t,e);class Pp{constructor(t,e,r,i){Fs(this,"drawingContext"),Fs(this,"allHorizontalData"),Fs(this,"isMinimal"),Fs(this,"spaceBeforeNotes"),Fs(this,"nbDivisions",null),Fs(this,"dpq",null),Fs(this,"minimalPosXBYTimePos",null),Fs(this,"minimalWidth",null),Fs(this,"timePosList",null),Fs(this,"nominalPosXByTimePos",null),Fs(this,"nominalWidth",null),Fs(this,"posXByTimePos",null),Fs(this,"width",null),this.drawingContext=t,this.allHorizontalData=e,this.isMinimal=r,this.spaceBeforeNotes=i}getSpaceBeforeNotes(){return this.spaceBeforeNotes}resetWidthToNominal(){this.width=null,this.posXByTimePos=null}copy(){const t=new Pp(this.drawingContext,this.allHorizontalData,this.isMinimal,this.spaceBeforeNotes);return t.nbDivisions=this.nbDivisions,t.dpq=this.dpq,t.minimalPosXBYTimePos=this.minimalPosXBYTimePos,t.minimalWidth=this.minimalWidth,t.timePosList=this.timePosList,t.nominalPosXByTimePos=this.nominalPosXByTimePos,t.nominalWidth=this.nominalWidth,t.posXByTimePos=null,t.width=null,t}getMiddlePos(){return(this.getWidth()+this.spaceBeforeNotes)/2-this.spaceBeforeNotes}getPosX(t,e){const r=this.getDpq();return t=t*r/e,this.getInternalPosX(t)}getInternalPosX(t){this.checkTimePos(t);const e=this.getPosXByTimePos(),r=e.get(t);return r!==void 0?r:this.getLinearInterpolation(t,e)}getNominalPosX(t,e){const r=this.getDpq();return t=t*r/e,this.getInternalNominalPosX(t)}getDpq(){return this.dpq===null&&(this.dpq=this.getAnyHorizontalData().dpq),this.dpq}getInternalNominalPosX(t){this.checkTimePos(t);const e=this.getNominalPosXByTimePos(),r=e.get(t);return r!==void 0?r:this.getLinearInterpolation(t,e)}checkTimePos(t){const e=this.getNbDivisions();if(typeof t!="number"||t<0||t>e)throw new Error(`The time pos [${t}] is out of range. `)}getLinearInterpolation(t,e){const r=this.getTimePosBeforeIdx(t),i=this.getTimePosAt(r),a=this.getTimePosAt(r+1),l=a-i,d=(t-i)/l,f=e.get(i),m=e.get(a);if(typeof f!="number"||typeof m!="number")throw new Error("Unexpected");const S=m-f;return f+S*d}getTimePosBeforeIdx(t){const e=this.getTimePosList(),r=e.length;for(let i=0;i<r;i++)if(e[i]>t){if(i>0)return i-1;throw new Error("Unexpected")}throw new Error("Unexpected")}getTimePosAt(t){const e=this.getTimePosList();if(t<0||t>=e.length)throw new Error(`Invalid time position index [${t}]. `);return e[t]}getTimePosList(){return this.timePosList===null&&(this.timePosList=this.calcTimePosList()),this.timePosList}calcTimePosList(){const t=this.getPosXByTimePos(),e=Array.from(t.keys());return e.sort(Dt.default.cmp),e}getPosXByTimePos(){return this.posXByTimePos===null&&(this.posXByTimePos=this.calcPosXByTimePos()),this.posXByTimePos}calcPosXByTimePos(){const t=this.getWidth(),e=this.getNominalWidth(),r=t-e,i=this.getNominalPosXByTimePos();return r===0?i:Hy(i,t)}getWidth(){return this.width===null&&(this.width=this.getNominalWidth()),this.width}setWidth(t){const e=this.getNominalWidth();t=Math.max(t,e),t!==this.width&&(this.width=t,this.posXByTimePos=null)}getNominalWidth(){return this.nominalWidth===null&&(this.nominalWidth=this.calcNominalWidth()),this.nominalWidth}calcNominalWidth(){const t=this.getNbDivisions(),r=this.getNominalPosXByTimePos().get(t);if(typeof r!="number")throw new Error("Unexpected");return r}getNominalPosXByTimePos(){return this.nominalPosXByTimePos===null&&(this.nominalPosXByTimePos=this.calcNominalPosXByTimePos()),this.nominalPosXByTimePos}calcNominalPosXByTimePos(){const t=this.getMinimalPosXByTimePos();if(this.isMinimal)return t;{const e=this.getMinimalWidth(),i=this.getQuarterDuration()*this.drawingContext.getQuarterToSpaceRatio();return i-e<=0?t:Hy(t,i)}}getMinimalWidth(){return this.minimalWidth===null&&(this.minimalWidth=this.calcMinimalWidth()),this.minimalWidth}calcMinimalWidth(){const t=this.getNbDivisions(),r=this.getMinimalPosXByTimePos().get(t);if(typeof r!="number")throw new Error("Unexpected");return r}getMinimalPosXByTimePos(){return this.minimalPosXBYTimePos===null&&(this.minimalPosXBYTimePos=this.calcMinimalPosXByTimePos()),this.minimalPosXBYTimePos}calcMinimalPosXByTimePos(){return xB(this.allHorizontalData,this.drawingContext)}getQuarterDuration(){const t=this.getAnyHorizontalData();return t.nbDivisions/t.dpq}getNbDivisions(){if(this.nbDivisions===null){const t=this.getAnyHorizontalData();this.nbDivisions=t.nbDivisions}return this.nbDivisions}getAnyHorizontalData(){if(this.allHorizontalData.length===0)throw new Error("There should be at least one horizontal data.");return this.allHorizontalData[0]}}function RB(s,t){if(t===s.dpq)return;const e=t/s.dpq;s.dpq=t,s.nbDivisions*=e,s.entities.forEach(r=>{r.timePos*=e,r.duration*=e})}var NB=Object.defineProperty,LB=(s,t,e)=>t in s?NB(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,ii=(s,t,e)=>LB(s,typeof t!="symbol"?t+"":t,e);const pu=.5;class Ep{constructor(t,e){ii(this,"drawingContext"),ii(this,"entries"),ii(this,"harmonizedTickableData",null),ii(this,"leftBlockMidSystemWidth",null),ii(this,"leftBlockFormatting",null),ii(this,"spaceBeforeNotes",null),ii(this,"tickableFormatter",null),ii(this,"rightBlockFormatting",null),ii(this,"rightBarlineWidth",null),this.drawingContext=t,this.entries=e}copy(){var t;const e=new Ep(this.drawingContext,this.entries);return e.leftBlockMidSystemWidth=this.leftBlockMidSystemWidth,e.leftBlockFormatting=this.leftBlockFormatting,e.spaceBeforeNotes=this.spaceBeforeNotes,e.tickableFormatter=((t=this.tickableFormatter)==null?void 0:t.copy())||null,e.rightBlockFormatting=this.rightBlockFormatting,e.rightBarlineWidth=this.rightBarlineWidth,e}format(){this.formatLeftBlock(),this.formatLeftBlockMidSystem(),this.formatTickableContent(),this.formatRightBlock()}formatLeftBlock(){let t=0;const e=this.entries.map(l=>l.leftAttributesWidth).reduce(ao,null),r=t;e!==null&&(t+=e);const i=this.entries.map(l=>l.leftBarlineWidth).reduce(ao,null);i!==null&&(t+=pu);let a=null;i!==null&&(a=t,t+=i),t>0?this.leftBlockFormatting={width:t,leftAttributesPosition:r,leftBarlinePosition:a}:this.leftBlockFormatting=null}formatLeftBlockMidSystem(){let t=0;const e=this.entries.map(r=>r.leftBarlineWidth).reduce(ao,null);e!==null&&(t+=e),t>0?this.leftBlockMidSystemWidth=t:this.leftBlockMidSystemWidth=null}formatTickableContent(){this.spaceBeforeNotes=Math.max(0,...this.entries.map(r=>r.spaceBeforeNotes))+pu;const t=this.getHarmonizedTickableData(),e=!1;this.tickableFormatter=new Pp(this.drawingContext,t,e,this.spaceBeforeNotes)}getTickableFormatter(){if(this.tickableFormatter===null)throw new Error("tickableFormatter is null");return this.tickableFormatter}getHarmonizedTickableData(){return this.harmonizedTickableData===null&&(this.harmonizedTickableData=this.createHarmonizedTickableData()),this.harmonizedTickableData}createHarmonizedTickableData(){const t=this.entries.flatMap(i=>i.tickablesContents),r=t.reduce((i,a)=>{const l=a.dpq;return Dt.default.lcm(i,l)},1);return t.forEach(i=>RB(i,r)),t}formatRightBlock(){let t=0;const e=this.entries.map(d=>d.rightInternalAttributesWidth).reduce(ao,null),r=t;e!==null&&(t+=e),this.rightBarlineWidth=this.entries.map(d=>d.rightBarlineWidth).reduce(ao,null),t>0&&this.rightBarlineWidth!==null&&(t+=pu);const i=t;this.rightBarlineWidth!==null&&(t+=this.rightBarlineWidth);const a=this.entries.map(d=>d.rightExternalAttributesWidth).reduce(ao,null);t>0&&a!==null&&(t+=pu);const l=t;a!==null&&(t+=a),t>0?this.rightBlockFormatting={width:t,rightInternalAttributesPosition:r,rightBarlinePosition:i,rightExternalAttributesPosition:l}:this.rightBlockFormatting=null}setWidth(t){if(this.spaceBeforeNotes===null)throw new Error("spaceBeforeNotes is null");if(this.tickableFormatter===null)throw new Error("tickableFormatter is null");if(this.rightBlockFormatting===null)throw new Error("rightBlockFormatting is null");let e=0;this.leftBlockFormatting!==null&&(e=this.leftBlockFormatting.width);const r=t-e-this.spaceBeforeNotes-this.rightBlockFormatting.width;this.tickableFormatter.setWidth(r)}getWidth(){if(this.spaceBeforeNotes===null)throw new Error("spaceBeforeNotes is null");if(this.tickableFormatter===null)throw new Error("tickableFormatter is null");if(this.rightBlockFormatting===null)throw new Error("rightBlockFormatting is null");let t=0;return this.leftBlockFormatting!==null&&(t=this.leftBlockFormatting.width),t+this.spaceBeforeNotes+this.tickableFormatter.getWidth()+this.rightBlockFormatting.width}getNominalWidth(){if(this.spaceBeforeNotes===null)throw new Error("spaceBeforeNotes is null");if(this.tickableFormatter===null)throw new Error("tickableFormatter is null");if(this.rightBlockFormatting===null)throw new Error("rightBlockFormatting is null");let t=0;return this.leftBlockFormatting!==null&&(t=this.leftBlockFormatting.width),t+this.spaceBeforeNotes+this.tickableFormatter.getNominalWidth()+this.rightBlockFormatting.width}getNominalWidthMidSystem(){if(this.spaceBeforeNotes===null)throw new Error("spaceBeforeNotes is null");if(this.tickableFormatter===null)throw new Error("tickableFormatter is null");if(this.rightBlockFormatting===null)throw new Error("rightBlockFormatting is null");let t=0;return this.leftBlockMidSystemWidth!==null&&(t=this.leftBlockMidSystemWidth),t+this.spaceBeforeNotes+this.tickableFormatter.getNominalWidth()+this.rightBlockFormatting.width}}function ao(s,t){return s===null?t===null?null:t:t===null?s:Math.max(s,t)}var MB=Object.defineProperty,OB=(s,t,e)=>t in s?MB(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,ar=(s,t,e)=>OB(s,typeof t!="symbol"?t+"":t,e);class _y{constructor(t,e,r){ar(this,"drawingContext"),ar(this,"partsData"),ar(this,"globalMeasure",null),ar(this,"rawGlobalMeasure"),ar(this,"partMeasures",null),ar(this,"rawPartMeasures",[]),ar(this,"currentPosition",null),ar(this,"formatter",null),ar(this,"parent",null),ar(this,"nbMeasures",1),ar(this,"hasUpdatedPartsFlag",!1),this.drawingContext=t,this.partsData=e,this.rawGlobalMeasure=r}setNextMeasureUuid(t){this.rawGlobalMeasure.setNextMeasureUuid(t)}setNbMeasures(t){this.nbMeasures=t}setMeasureNumber(t){this.getGlobalMeasure().setMeasureNumber(t)}hasRehearsalMark(){return this.getGlobalMeasure().rehearsal!==null}getNbMeasures(){return this.nbMeasures}hasSlice(){return this.parent!==null}setParent(t){this.parent=t}getPosition(){return this.currentPosition}setPosition(t){t!==this.currentPosition&&(this.currentPosition=t,this.partMeasures&&this.partMeasures.forEach(e=>e.forEach(r=>r.setCurrentPosition(t))),this.formatter=null)}getGlobalMeasure(){return this.globalMeasure===null&&(this.globalMeasure=this.rawGlobalMeasure.getOrCreateGlobalMeasure(this.drawingContext)),this.globalMeasure}addPartMeasures(t){this.formatter=null,this.partMeasures=null,this.rawPartMeasures.push(t)}getPartMeasures(){if(this.partMeasures===null){const t=this.drawingContext.layoutData;this.partMeasures=this.rawPartMeasures.map((e,r)=>{const i=this.partsData[r],a=e.getOrCreatePartMeasures({drawingContext:this.drawingContext,partData:i,displayOpts:t}),l=this.currentPosition;return l!==null&&a.forEach(d=>d.setCurrentPosition(l)),a})}return this.partMeasures}resetNominalFormatting(){const t=this.getFormatter();t.tickableFormatter&&t.tickableFormatter.resetWidthToNominal(),this.getPartMeasures().forEach(r=>r.forEach(i=>i.setHorizontalFormatter(t)))}getFormatter(){return this.formatter===null&&(this.formatter=this.createFormatter()),this.formatter}createFormatter(){const t=this.getPartMeasures(),e=[...t.flatMap(a=>a.map(l=>l.getHorizontalData()))],r=new Ep(this.drawingContext,e);return r.format(),t.forEach(a=>a.forEach(l=>l.setHorizontalFormatter(r))),this.getGlobalMeasure().setHorizontalFormatter(r),r}getNominalWidthMidSystem(){return this.getFormatter().getNominalWidthMidSystem()}getNominalWidth(){return this.getFormatter().getNominalWidth()}hasSystemBreakBefore(){return this.getGlobalMeasure().hasSystemBreakBefore()}hasSystemBreakAfter(){return this.getGlobalMeasure().hasSystemBreakAfter()}hasPageBreakBefore(){return this.getGlobalMeasure().hasPageBreakBefore()}hasPageBreakAfter(){return this.getGlobalMeasure().hasPageBreakAfter()}replaceGlobalMeasure(t){this.formatter=null;const e=this.rawGlobalMeasure;return this.rawGlobalMeasure=t,this.parent&&this.globalMeasure&&(this.hasUpdatedPartsFlag=!0,this.parent.removeGlobalMeasure(this.globalMeasure)),this.globalMeasure=null,e}replacePartMeasure(t,e){this.formatter=null,this.partMeasures=null;const r=this.rawPartMeasures[t];this.rawPartMeasures[t]=e;const i=r.getPartMeasures();return i&&this.parent&&(this.hasUpdatedPartsFlag=!0,this.parent.removePartMeasure(t,i)),r}destroy(){this.rawGlobalMeasure.destroy(),this.rawPartMeasures.forEach(t=>t.destroy())}}var BB=Object.defineProperty,IB=(s,t,e)=>t in s?BB(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,mu=(s,t,e)=>IB(s,typeof t!="symbol"?t+"":t,e);const FB="pageFooter";class Dp{constructor(t,e,r){mu(this,"pageWidth"),mu(this,"group"),mu(this,"rightsLines",[]),mu(this,"height"),this.pageWidth=r,this.group=t.createGroupNode(),this.group.setLabel(FB);let i=0;if(e.rightsLines.length>0){const a=t.getRightsFontOptions();e.rightsLines.forEach(l=>{const d=t.createTextNode(l,a);v(this.group,d);const f=d.getLocalBBox();i-=f.minY,d.setY(i),d.setX((this.pageWidth-f.maxX)/2),i+=f.maxY,this.rightsLines.push(d);const m={entityType:T.A.CREDIT,creditType:Xs.A.RIGHTS};d.setEventPayload(m)})}this.height=i}getHeight(){return this.height}setY(t){this.group.setY(t)}getChildRoot(){return this.group}destroy(){this.group.destroy()}}var UB=Object.defineProperty,HB=(s,t,e)=>t in s?UB(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,ni=(s,t,e)=>HB(s,typeof t!="symbol"?t+"":t,e);const _B="pageHeader";class yu{constructor(t,e,r,i){ni(this,"pageWidth"),ni(this,"group"),ni(this,"pageNumber"),ni(this,"title",null),ni(this,"subtitle",null),ni(this,"lyricist",null),ni(this,"composer",null),ni(this,"arranger",null),ni(this,"height"),this.pageWidth=r,this.group=t.createGroupNode(),this.group.setLabel(_B);let a=0;const l=t.getPageNumberFontOptions();this.pageNumber=t.createTextNode("0",l),v(this.group,this.pageNumber);const d=this.pageNumber.getLocalBBox();if(a-=d.minY,this.pageNumber.setY(a),a+=d.maxY,i){const f=t.getTitleFontOptions();this.title=t.createTextNode(e.title,f),v(this.group,this.title);const m=this.title.getLocalBBox();a-=m.minY,this.title.setY(a),this.title.setX((this.pageWidth-m.maxX)/2),a+=m.maxY;const S={entityType:T.A.CREDIT,creditType:Xs.A.TITLE};if(this.title.setEventPayload(S),e.subtitle!==null){const D=t.getSubtitleFontOptions();this.subtitle=t.createTextNode(e.subtitle,D),v(this.group,this.subtitle);const L=this.subtitle.getLocalBBox();a-=L.minY,this.subtitle.setY(a),this.subtitle.setX((this.pageWidth-L.maxX)/2),a+=L.maxY;const M={entityType:T.A.CREDIT,creditType:Xs.A.SUBTITLE};this.subtitle.setEventPayload(M)}let w=a;if(e.lyricist!==null){const D=t.getLyricistFontOptions();this.lyricist=t.createTextNode(e.lyricist,D),v(this.group,this.lyricist);const L=this.lyricist.getLocalBBox();w-=L.minY,this.lyricist.setY(w),w+=L.maxY;const M={entityType:T.A.CREDIT,creditType:Xs.A.LYRICIST};this.lyricist.setEventPayload(M)}let x=a;if(e.composer!==null){const D=t.getComposerFontOptions();this.composer=t.createTextNode(e.composer,D),v(this.group,this.composer);const L=this.composer.getLocalBBox();x-=L.minY,this.composer.setY(x),this.composer.setX(this.pageWidth-L.maxX),x+=L.maxY;const M={entityType:T.A.CREDIT,creditType:Xs.A.COMPOSER};this.composer.setEventPayload(M)}if(e.arranger!==null){const D=t.getArrangerFontOptions();this.arranger=t.createTextNode(e.arranger,D),v(this.group,this.arranger);const L=this.arranger.getLocalBBox();x-=L.minY,this.arranger.setY(x),this.arranger.setX(this.pageWidth-L.maxX),x+=L.maxY;const M={entityType:T.A.CREDIT,creditType:Xs.A.ARRANGER};this.arranger.setEventPayload(M)}a=Math.max(w,x,a)}this.height=a}setPageNumber(t){this.pageNumber.setText(t.toString()),Dt.default.isEven(t)?this.pageNumber.setX(0):this.pageNumber.setX(this.pageWidth-this.pageNumber.getWidth())}getHeight(){return this.height}getChildRoot(){return this.group}destroy(){this.group.destroy()}}var GB=Object.defineProperty,XB=(s,t,e)=>t in s?GB(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Cp=(s,t,e)=>XB(s,typeof t!="symbol"?t+"":t,e);class WB{constructor(t,e,r){Cp(this,"pageWidth"),Cp(this,"drawingContext"),Cp(this,"creditsData"),this.pageWidth=e,this.drawingContext=t,this.creditsData=r}createHeaderFooter(t){const e=new yu(this.drawingContext,this.creditsData,this.pageWidth,t),r=new Dp(this.drawingContext,this.creditsData,this.pageWidth);return{header:e,footer:r}}}var se=b(267811),An=b(635258);function Hr(s){const t=rt(s);return Gy(s,t.x,t.y)}function Gy(s,t,e){const r=s.getEventPayload();if(r){let i=s.getLocalSubBBoxes();if(i===null){const a=s.getLocalBBox();if(a===null)return[];i=[a]}return i.map(a=>({rect:{x1:t+a.minX,y1:e+a.minY,x2:t+a.maxX,y2:e+a.maxY},payload:r}))}return s instanceof ye?s.children.flatMap(i=>{const a=t+i.getX(),l=e+i.getY();return Gy(i,a,l)}):[]}function oi(s,t){return s.x>=t.x1&&s.x<=t.x2&&s.y>=t.y1&&s.y<=t.y2}var zB=Object.defineProperty,YB=(s,t,e)=>t in s?zB(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Tp=(s,t,e)=>YB(s,typeof t!="symbol"?t+"":t,e);class Xy{constructor(t){Tp(this,"target"),Tp(this,"rect",null),Tp(this,"eventsRects",null),this.target=t}resolve(t){const e=this.getRect();if(!oi(t,e))return null;const r=this.getEventRects();for(const i of r)if(oi(t,i.rect))return{surfaceType:An.A.CREDITS,creditType:i.payload.creditType};return{surfaceType:An.A.CREDITS,creditType:null}}getRect(){if(this.rect===null){const t=rt(this.target.getChildRoot());if(this.target instanceof yu)this.rect={x1:t.x,y1:t.y,x2:t.x+this.target.pageWidth,y2:t.y+this.target.getHeight()};else if(this.target instanceof Dp)this.rect={x1:t.x,y1:t.y,x2:this.target.pageWidth,y2:t.y+this.target.getHeight()};else throw new Error("Invalid target for CreditsEventsLayer")}return this.rect}getEventRects(){if(this.eventsRects===null){const t=Hr(this.target.getChildRoot());this.eventsRects=t.filter(e=>e.payload.entityType===T.A.CREDIT)}return this.eventsRects}}var kB=Object.defineProperty,qB=(s,t,e)=>t in s?kB(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Rp=(s,t,e)=>qB(s,typeof t!="symbol"?t+"":t,e);class VB{constructor(t){Rp(this,"target"),Rp(this,"rect",null),Rp(this,"eventsRects",null),this.target=t}resolve(t){const e=this.getRect();return oi(t,e)?this.resolveTrack(t):null}resolveTrack(t){const e=this.getEventRects();for(const r of e)if(oi(t,r.rect))return{surfaceType:An.A.SYSTEM_HEADER,partUuid:r.payload.partUuid};return{surfaceType:An.A.SYSTEM_HEADER,partUuid:null}}getRect(){if(this.rect===null){const t=rt(this.target.getChildRoot()),e=this.target.getWidth(),r=this.target.getChildRoot().getLocalBBox();if(r===null)throw new Error("bbox is null");this.rect={x1:t.x,y1:t.y+r.minY,x2:t.x+e,y2:t.y+r.maxY}}return this.rect}getEventRects(){if(this.eventsRects===null){const t=Hr(this.target.group);this.eventsRects=t.filter(e=>e.payload.entityType===T.A.PART_NAME)}return this.eventsRects}}var QB=Object.defineProperty,KB=(s,t,e)=>t in s?QB(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,$a=(s,t,e)=>KB(s,typeof t!="symbol"?t+"":t,e);class JB{constructor(t,e){$a(this,"target"),$a(this,"staffX"),$a(this,"measureLeftX"),$a(this,"measureRightX"),$a(this,"eventsRects",null),this.target=t,this.staffX=e.staffX,this.measureLeftX=this.target.getChildRoot().getX()+this.staffX,this.measureRightX=this.measureLeftX+this.target.getWidth()}isPointInside(t){return t.x>=this.measureLeftX&&t.x<this.measureRightX}getHoveredEntities(t){return this.getEventsRects().filter(i=>oi(t,i.rect)).map(i=>{if(i.payload.entityType===T.A.TEMPO){const{bpm:a,durationType:l,nbDots:d}=i.payload;return{entityType:T.A.TEMPO,measureUuid:this.target.measureUuid,bpm:a,durationType:l,nbDots:d}}else if(i.payload.entityType===T.A.REHEARSAL){const{rehearsalData:a}=i.payload;return{entityType:T.A.REHEARSAL,measureUuid:this.target.measureUuid,rehearsalData:a}}else if(i.payload.entityType===T.A.SWING){const{swing:a}=i.payload;return{entityType:T.A.SWING,measureUuid:this.target.measureUuid,swing:a}}else if(i.payload.entityType===T.A.SYSTEM_BREAK){let a;const{side:l}=i.payload;if(l==="left")a=this.target.measureUuid;else{if(this.target.nextMeasureUuid===null)throw new Error("Right key at the end of the score should not happen");a=this.target.nextMeasureUuid}return{entityType:T.A.SYSTEM_BREAK,measureUuid:a,side:l}}else if(i.payload.entityType===T.A.PAGE_BREAK){let a;const{side:l}=i.payload;if(l==="left")a=this.target.measureUuid;else{if(this.target.nextMeasureUuid===null)throw new Error("Right key at the end of the score should not happen");a=this.target.nextMeasureUuid}return{entityType:T.A.PAGE_BREAK,measureUuid:a,side:l}}else if(i.payload.entityType===T.A.BARLINE_REPEAT_TIMES){const{nbTimes:a}=i.payload;return{entityType:T.A.BARLINE_REPEAT_TIMES,measureUuid:this.target.measureUuid,nbTimes:a}}throw new Error(`Unsupported entity type: ${i.payload.entityType}`)})}getEventsRects(){return this.eventsRects===null&&(this.eventsRects=Hr(this.target.getChildRoot())),this.eventsRects}}var $B=Object.defineProperty,ZB=(s,t,e)=>t in s?$B(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,vn=(s,t,e)=>ZB(s,typeof t!="symbol"?t+"":t,e);class jB{constructor(t,e){vn(this,"measures"),vn(this,"staffX"),vn(this,"staffTopY"),vn(this,"staffBottomY"),vn(this,"target"),vn(this,"measureEventLayers",null),vn(this,"eventsRects",null),this.target=t,this.measures=e.measures,this.staffX=e.staffX,this.staffTopY=e.staffTopY,this.staffBottomY=e.staffBottomY}isPointInside(t){return t.y>=this.staffTopY&&t.y<=this.staffBottomY}getAdjacentMeasures(t){const e=this.getMeasuresEventLayers(),r=e[0];if(t.x<r.measureLeftX)return[r];const i=e[e.length-1];if(t.x>=i.measureRightX)return[i];const a=e.findIndex(d=>d.isPointInside(t));if(a===-1)throw new Error("Unreachable");const l=[e[a]];return a>0&&l.unshift(e[a-1]),a<e.length-1&&l.push(e[a+1]),l}getMeasuresEventLayers(){return this.measureEventLayers===null&&(this.measureEventLayers=this.target.measures.map(t=>new JB(t,{staffX:this.staffX}))),this.measureEventLayers}getAllHoveredEntities(t){return[...this.getAdjacentMeasures(t).flatMap(r=>r.getHoveredEntities(t)),...this.getHoveredEntities(t)]}getHoveredEntities(t){return this.getEventsRects().filter(i=>oi(t,i.rect)).map(i=>{if(i.payload.entityType===T.A.TEMPO_CHANGE){const{uuid:a}=i.payload;return{entityType:T.A.TEMPO_CHANGE,uuid:a}}throw new Error(`Unsupported entity type: ${i.payload.entityType}`)})}getEventsRects(){return this.eventsRects===null&&(this.eventsRects=[...Hr(this.target.tempoChanges.getChildRoot())]),this.eventsRects}}var t1=Object.defineProperty,e1=(s,t,e)=>t in s?t1(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Us=(s,t,e)=>e1(s,typeof t!="symbol"?t+"":t,e);const Wy=.2;class zy{constructor(t,e){Us(this,"target"),Us(this,"measureUuid"),Us(this,"voiceUuid"),Us(this,"voiceIdxInStaff"),Us(this,"staffY"),Us(this,"noteX"),Us(this,"noteIdx"),Us(this,"graceIdx"),Us(this,"timePos"),Us(this,"dpq"),Us(this,"midX"),Us(this,"leftX"),Us(this,"rightX"),this.target=t,this.measureUuid=e.measureUuid,this.voiceUuid=e.voiceUuid,this.voiceIdxInStaff=e.voiceIdxInStaff,this.staffY=e.staffY,this.noteX=e.noteX,this.noteIdx=e.noteIdx,this.graceIdx=e.graceIdx,this.timePos=e.timePos,this.dpq=e.dpq;const r=this.noteX-this.target.getHeadSpaceBefore(),i=this.noteX+this.target.getHeadSpaceAfter();this.midX=(i-r)/2+r,this.leftX=r-Wy,this.rightX=i+Wy}isInColumn(t){return t.x>=this.leftX&&t.x<this.rightX}resolve(t){const e=this.target.staffData.type;if(e===Zt.A.STANDARD)return this.resolveStandard(t);if(e===Zt.A.GUITAR_TAB)return this.resolveGuitarTab(t);throw new Error(`Unsupported staff type: ${e}`)}resolveStandard(t){const e=t.y-this.staffY,r=Math.round(e*2)/2,i=this.target.staffData,a=Le.A.yToLine(r,i.spaceSize,i.nbStaffLines),l=this.isInColumn(t),d=this.getNoteLineFromLine(a);return{staffType:Zt.A.STANDARD,noteLine:d,line:a,isInColumn:l}}getNoteLineFromLine(t){const e=this.target.getDisplayData();if(e.isRest())return null;const r=e.getLines().filter(l=>l!==null);return r.length===0?null:r.map(l=>({distance:Math.abs(l-t),noteLine:l})).reduce((l,d)=>l.distance<d.distance?l:d).noteLine}resolveGuitarTab(t){const e=this.target.staffData,i=(t.y-this.staffY)*1/e.spaceSize,a=Math.round(i),l=e.nbStaffLines-1,f=Math.min(l,Math.max(0,a))+1,m=this.getNoteLineFromString(f);return{staffType:Zt.A.GUITAR_TAB,string:f,noteLine:m}}getNoteLineFromString(t){const e=this.target.getDisplayData();if(e.isRest())return null;const i=e.getFrets().findIndex(l=>l&&l.string===t);return i<0?null:e.getLines()[i]}}var s1=Object.defineProperty,r1=(s,t,e)=>t in s?s1(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,hr=(s,t,e)=>r1(s,typeof t!="symbol"?t+"":t,e);class i1{constructor(t,e){hr(this,"target"),hr(this,"partUuid"),hr(this,"staffUuid"),hr(this,"nextMeasureUuid"),hr(this,"staffX"),hr(this,"staffY"),hr(this,"measureLeftX"),hr(this,"measureRightX"),hr(this,"voicesNotes",null),hr(this,"timeMarkers",null),hr(this,"eventsRects",null),this.target=t,this.partUuid=e.partUuid,this.staffUuid=e.staffUuid,this.nextMeasureUuid=e.nextMeasureUuid,this.staffX=e.staffX,this.staffY=e.staffY,this.measureLeftX=this.target.getChildRoot().getX()+this.staffX,this.measureRightX=this.measureLeftX+this.target.getWidth()}isPointInside(t){return t.x>=this.measureLeftX&&t.x<this.measureRightX}getNotes(t){const e=this.getVoicesNotes();return e.length===0?null:e.length===1?e[0]:t===null?[...e[0],...e[1]]:e[t]}getVoicesNotes(){if(this.voicesNotes===null){const t=this.target.tickableContent.getChildRoot().getX()+this.measureLeftX,e=Array.from(this.target.tickableContent.voices.values()).filter(i=>i instanceof Bt);if(e.length===0)return[];e.sort((i,a)=>(zt.A.isDown(i.stemStrategy)&&zt.A.isUp(a.stemStrategy),1));const r=this.target.measureUuid;this.voicesNotes=e.map(i=>{const a=i.voiceUuid,l=i.voiceIdxInStaff;return i.notes.flatMap((d,f)=>{const m=t+d.getPosition(),S=i.gracesMap.get(f)||[],w=i.dpq,x=d.getTimePos(),D=[new zy(d,{measureUuid:r,voiceUuid:a,voiceIdxInStaff:l,staffY:this.staffY,noteX:m,noteIdx:f,graceIdx:null,timePos:x,dpq:w})];return D.push(...S.map((L,M)=>{const H=m+L.getPosition();return new zy(L,{measureUuid:r,voiceUuid:a,voiceIdxInStaff:l,staffY:this.staffY,noteX:H,noteIdx:f,graceIdx:M,timePos:x,dpq:w})})),D})})}return this.voicesNotes}getTimeMarkers(){if(this.timeMarkers===null){const t=this.target.tickableContent.horizontalFormatter;if(t===null)throw new Error("Formatter not found");const e=this.target.tickableContent.getChildRoot().getX()+this.measureLeftX,r=this.target.measureUuid,i=this.target.attrs.getAnyTime(),a=Vn.default.timeToQuarter(i),l=ei.default.getBeatType(i);let d=Vn.default.beatTypeToQuarter(l);for(;d>=1;)d/=2;this.timeMarkers=[];const f=Math.max(1/d,1),m=Dt.default.lcm(f,t.getDpq());for(let S=0;S<=a;S+=d){const w=Vn.default.quarterToDivisions(S,m),x=t.getPosX(w,m)+e;this.timeMarkers.push({timePos:w,dpq:m,measureUuid:r,x})}}return this.timeMarkers}getHoveredEntities(t){return this.getEventsRects().filter(i=>oi(t,i.rect)).map(i=>{if(i.payload.entityType===T.A.NOTE){const{voiceUuid:a,voiceIdxInStaff:l,noteIdx:d,graceIdx:f,line:m,notehead:S,duration:w}=i.payload;return{entityType:T.A.NOTE,partUuid:this.partUuid,measureUuid:this.target.measureUuid,staffUuid:this.staffUuid,voiceUuid:a,voiceIdxInStaff:l,noteIdx:d,graceIdx:f,line:m,notehead:S,duration:w}}if(i.payload.entityType===T.A.DYNAMICS){const{timePos:a,dpq:l,placement:d,uuid:f,type:m}=i.payload;return{entityType:T.A.DYNAMICS,partUuid:this.partUuid,measureUuid:this.target.measureUuid,staffUuid:this.staffUuid,timePos:a,dpq:l,placement:d,uuid:f,type:m}}if(i.payload.entityType===T.A.PIZZICATO){const{timePos:a,dpq:l,placement:d,uuid:f,type:m}=i.payload;return{entityType:T.A.PIZZICATO,partUuid:this.partUuid,measureUuid:this.target.measureUuid,staffUuid:this.staffUuid,timePos:a,dpq:l,placement:d,uuid:f,type:m}}if(i.payload.entityType===T.A.MUTE){const{timePos:a,dpq:l,uuid:d,type:f,placement:m}=i.payload;return{entityType:T.A.MUTE,partUuid:this.partUuid,measureUuid:this.target.measureUuid,staffUuid:this.staffUuid,timePos:a,dpq:l,placement:m,uuid:d,type:f}}if(i.payload.entityType===T.A.MULTI_MEASURE_REST){const{nbMeasures:a}=i.payload;return{entityType:T.A.MULTI_MEASURE_REST,partUuid:this.partUuid,staffUuid:this.staffUuid,measureUuid:this.target.measureUuid,nbMeasures:a}}if(i.payload.entityType===T.A.TEXT_ANNOTATION){const{timePos:a,dpq:l,placement:d,uuid:f,text:m}=i.payload;return{entityType:T.A.TEXT_ANNOTATION,partUuid:this.partUuid,measureUuid:this.target.measureUuid,staffUuid:this.staffUuid,timePos:a,dpq:l,placement:d,uuid:f,text:m}}if(i.payload.entityType===T.A.LYRIC){const{voiceUuid:a,noteIdx:l,level:d,text:f,hasRightHyphen:m,hasRightMelisma:S}=i.payload;return{entityType:T.A.LYRIC,partUuid:this.partUuid,measureUuid:this.target.measureUuid,staffUuid:this.staffUuid,voiceUuid:a,noteIdx:l,level:d,text:f,hasRightHyphen:m,hasRightMelisma:S}}if(i.payload.entityType===T.A.JAZZ_HARMONY){const{timePos:a,dpq:l,uuid:d,kind:f,type:m,root:S,bass:w,suspension:x,degreeModifications:D}=i.payload;return{entityType:T.A.JAZZ_HARMONY,partUuid:this.partUuid,measureUuid:this.target.measureUuid,timePos:a,dpq:l,uuid:d,kind:f,type:m,root:S,bass:w,suspension:x,degreeModifications:structuredClone(D)}}if(i.payload.entityType===T.A.ROMAN_NUMERAL){const{timePos:a,dpq:l,uuid:d,chordFunction:f,kind:m,alter:S,inversion:w,secondary:x}=i.payload;return{entityType:T.A.ROMAN_NUMERAL,partUuid:this.partUuid,measureUuid:this.target.measureUuid,timePos:a,dpq:l,uuid:d,chordFunction:f,kind:m,alter:S,inversion:w,secondary:structuredClone(x)}}if(i.payload.entityType===T.A.FIGURED_BASS){const{timePos:a,dpq:l,uuid:d,level:f,figureData:m}=i.payload;return{entityType:T.A.FIGURED_BASS,partUuid:this.partUuid,measureUuid:this.target.measureUuid,timePos:a,dpq:l,uuid:d,level:f,figureData:structuredClone(m)}}if(i.payload.entityType===T.A.KEY_SIGNATURE){const{side:a}=i.payload;let l;if(a==="left")l=this.target.measureUuid;else{if(this.nextMeasureUuid===null)throw new Error("Right key at the end of the score should not happen");l=this.nextMeasureUuid}return{entityType:T.A.KEY_SIGNATURE,partUuid:this.partUuid,measureUuid:l,staffUuid:this.staffUuid,side:a}}if(i.payload.entityType===T.A.CLEF){const{side:a}=i.payload;let l=this.target.measureUuid;if(a==="right"){if(this.nextMeasureUuid===null)throw new Error("Right clef at the end of the score should not happen");l=this.nextMeasureUuid}return{entityType:T.A.CLEF,partUuid:this.partUuid,measureUuid:l,staffUuid:this.staffUuid,uuid:i.payload.uuid,clefData:i.payload.clefData,side:a}}if(i.payload.entityType===T.A.TIME_SIGNATURE){const{side:a}=i.payload;let l;if(a==="left")l=this.target.measureUuid;else{if(this.nextMeasureUuid===null)throw new Error("Right key at the end of the score should not happen");l=this.nextMeasureUuid}return{entityType:T.A.TIME_SIGNATURE,partUuid:this.partUuid,measureUuid:l,staffUuid:this.staffUuid,side:a}}throw new Error(`Unsupported entity type: ${i.payload.entityType}`)})}getEventsRects(){return this.eventsRects===null&&(this.eventsRects=Hr(this.target.getChildRoot())),this.eventsRects}}function n1(s){const t=s[0];return{resolve:()=>({staffType:Zt.A.STANDARD,noteLine:null,line:null,isInColumn:!1}),measureUuid:t.target.measureUuid,voiceUuid:"",voiceIdxInStaff:0,noteIdx:0,graceIdx:null,timePos:0,dpq:0}}var o1=Object.defineProperty,a1=(s,t,e)=>t in s?o1(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ss=(s,t,e)=>a1(s,typeof t!="symbol"?t+"":t,e);class h1{constructor(t,e){Ss(this,"partUuid"),Ss(this,"staffUuid"),Ss(this,"measures"),Ss(this,"nextMeasures"),Ss(this,"staffType"),Ss(this,"staffX"),Ss(this,"staffTopY"),Ss(this,"staffOriginY"),Ss(this,"staffMidY"),Ss(this,"staffBottomY"),Ss(this,"target"),Ss(this,"globalStaffEventsLayer",null),Ss(this,"measureEventLayers",null),Ss(this,"eventsRects",null),this.target=t,this.partUuid=e.partUuid,this.staffUuid=e.staffUuid,this.measures=e.measures,this.nextMeasures=e.nextMeasures,this.staffType=e.staffType,this.staffX=e.staffX,this.staffTopY=e.staffTopY,this.staffMidY=e.staffMidY,this.staffOriginY=e.staffOriginY,this.staffBottomY=e.staffBottomY,e.globalStaff!==null&&(this.globalStaffEventsLayer=new jB(e.globalStaff.target,{measures:this.measures,staffX:e.globalStaff.staffX,staffTopY:e.globalStaff.staffTopY,staffBottomY:e.globalStaff.staffBottomY}))}isFocused(t){return t.staffType===this.staffType&&t.partUuid===this.partUuid&&t.staffUuid===this.staffUuid&&this.measures.includes(t.measureUuid)}isPointInside(t){return t.y>=this.staffTopY&&t.y<=this.staffBottomY}resolve(t,e){const r=this.getAdjacentMeasures(t),i=this.getClosestNote(r,t,e),{measureUuid:a,voiceUuid:l,voiceIdxInStaff:d,noteIdx:f,graceIdx:m,timePos:S,dpq:w}=i,x=i.resolve(t),D=this.getClosestTimeMarker(r,t),{measureUuid:L,timePos:M,dpq:H}=D,$=[...r.flatMap(lt=>lt.getHoveredEntities(t)),...this.getHoveredEntities(t)];return{surfaceType:An.A.SYSTEM_CONTENT,partUuid:this.partUuid,staffUuid:this.staffUuid,voiceUuid:l,voiceIdxInStaff:d,noteMeasureUuid:a,noteIdx:f,graceIdx:m,noteTimePos:S,noteDpq:w,timeMarkerMeasureUuid:L,timeMarkerTimePos:M,timeMarkerDpq:H,headData:x,hoveredEntities:$}}resolveGlobalStaff(t,e){if(this.globalStaffEventsLayer===null)throw new Error("Cannot resolve global staff when there is no global staff...");const r=this.getAdjacentMeasures(t),i=this.getClosestNote(r,t,e),{measureUuid:a,voiceUuid:l,voiceIdxInStaff:d,noteIdx:f,graceIdx:m,timePos:S,dpq:w}=i,x=i.resolve(t);x.staffType===Zt.A.STANDARD?x.line=null:x.staffType===Zt.A.GUITAR_TAB&&(x.string=1);const D=this.getClosestTimeMarker(r,t),{measureUuid:L,timePos:M,dpq:H}=D,$=this.resolveGlobalHoveredEntities(t);return{surfaceType:An.A.SYSTEM_CONTENT,partUuid:this.partUuid,staffUuid:this.staffUuid,voiceUuid:l,voiceIdxInStaff:d,noteMeasureUuid:a,noteIdx:f,graceIdx:m,noteTimePos:S,noteDpq:w,timeMarkerMeasureUuid:L,timeMarkerTimePos:M,timeMarkerDpq:H,headData:x,hoveredEntities:$}}resolveGlobalHoveredEntities(t){if(this.globalStaffEventsLayer===null)throw new Error("Cannot resolve global staff when there is no global staff...");return this.globalStaffEventsLayer.getAllHoveredEntities(t)}getClosestNote(t,e,r){const l=t.flatMap(d=>d.getNotes(r)).map(d=>d===null?{distance:Number.POSITIVE_INFINITY,note:null}:{distance:Math.abs(e.x-d.midX),note:d}).reduce((d,f)=>d.distance<f.distance?d:f);return l.note===null?n1(t):l.note}getClosestTimeMarker(t,e){return t.flatMap(l=>l.getTimeMarkers()).map(l=>({distance:Math.abs(e.x-l.x),timeMarker:l})).reduce((l,d)=>l.distance<d.distance?l:d).timeMarker}getAdjacentMeasures(t){const e=this.getMeasuresEventLayers(),r=e[0];if(t.x<r.measureLeftX)return[r];const i=e[e.length-1];if(t.x>=i.measureRightX)return[i];const a=e.findIndex(d=>d.isPointInside(t));if(a===-1)throw new Error("Unreachable");const l=[e[a]];return a>0&&l.unshift(e[a-1]),a<e.length-1&&l.push(e[a+1]),l}getMeasuresEventLayers(){return this.measureEventLayers===null&&(this.measureEventLayers=this.target.measures.map((t,e)=>{const r=this.nextMeasures[e];return new i1(t,{partUuid:this.partUuid,staffUuid:this.staffUuid,staffX:this.staffX,staffY:this.staffOriginY,nextMeasureUuid:r})})),this.measureEventLayers}getAllHoveredEntities(t){return[...this.getAdjacentMeasures(t).flatMap(r=>r.getHoveredEntities(t)),...this.getHoveredEntities(t)]}getHoveredEntities(t){return this.getEventsRects().filter(i=>oi(t,i.rect)).map(i=>{if(i.payload.entityType===T.A.WEDGE){const{uuid:a}=i.payload;return{entityType:T.A.WEDGE,partUuid:this.partUuid,staffUuid:this.staffUuid,uuid:a}}else if(i.payload.entityType===T.A.OCTAVE_SHIFT){const{uuid:a}=i.payload;return{entityType:T.A.OCTAVE_SHIFT,partUuid:this.partUuid,staffUuid:this.staffUuid,uuid:a}}else if(i.payload.entityType===T.A.PIANO_PEDAL){const{uuid:a}=i.payload;return{entityType:T.A.PIANO_PEDAL,partUuid:this.partUuid,staffUuid:this.staffUuid,uuid:a}}else if(i.payload.entityType===T.A.PLUCKED_RANGE){const{uuid:a,type:l}=i.payload;return{entityType:T.A.PLUCKED_RANGE,partUuid:this.partUuid,staffUuid:this.staffUuid,uuid:a,type:l}}else if(i.payload.entityType===T.A.SLUR){const{voiceUuid:a,uuid:l}=i.payload;return{entityType:T.A.SLUR,partUuid:this.partUuid,staffUuid:this.staffUuid,voiceUuid:a,uuid:l}}throw new Error(`Unsupported entity type: ${i.payload.entityType}`)})}getEventsRects(){return this.eventsRects===null&&(this.eventsRects=[...Hr(this.target.wedges.getChildRoot()),...Hr(this.target.octaveShifts.getChildRoot()),...Hr(this.target.pedals.getChildRoot()),...Hr(this.target.pluckedRanges.getChildRoot()),...this.target.voiceSlurs.flatMap(t=>Hr(t.getChildRoot()))]),this.eventsRects}}var l1=Object.defineProperty,c1=(s,t,e)=>t in s?l1(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Yy=(s,t,e)=>c1(s,typeof t!="symbol"?t+"":t,e);function ky(s,t,e){const r=new u1(s);return e.map(r.process,r).filter(d=>d!==null&&oi(t,d.rect)).map(d=>d.payload)}class u1{constructor(t){Yy(this,"target"),Yy(this,"result",null),this.target=t}process(t){return this.result=null,this.target.systems.some(e=>this.processSystem(e,t)),this.result}processSystem(t,e){return t.parts.some(r=>this.processPart(r,e))}processPart(t,e){return t.partData.uuid!==e.partUuid?!1:t.staves.some(r=>this.processStaff(r,e))}processStaff(t,e){return t.staffData.uuid!==e.staffUuid||t.staffData.type!==e.staffType?!1:t.measures.some(r=>this.processMeasure(r,e))}processMeasure(t,e){if(t.measureUuid!==e.measureUuid)return!1;const r=t.tickableContent,i=rt(r.getChildRoot()),a=r.horizontalFormatter;if(a===null)throw new Error("Formatter is null");const l=a.getDpq(),d=Dt.default.lcm(l,e.dpq),f=e.timePos*d/e.dpq,m=a.getPosX(f,d),S=d1(e),w=f1(e,t.staffData),x=i.x+m+S-ue.Zz,D=i.y+w-ue.Zz;return this.result={rect:{x1:x,y1:D,x2:x+ue.Zz*2,y2:D+ue.Zz*2},payload:{entityType:T.A.ANCHOR,side:e.side}},!0}}function d1(s){if(s.side==="left")return-ue.bc;if(s.side==="right")return ue.AW;throw new Error(`Unsupported side: ${s.side}`)}function f1(s,t){const e=(0,Ft.o5)(t);if(s.placement===null)return e/2;if(s.placement===I.A.ABOVE)return(ue.LM+ue.Zz)*-1;if(s.placement===I.A.BELOW)return e+ue.LM+ue.Zz;throw new Error("Unreachable")}var g1=Object.defineProperty,p1=(s,t,e)=>t in s?g1(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,qy=(s,t,e)=>p1(s,typeof t!="symbol"?t+"":t,e);class m1{constructor(t){qy(this,"staffEventsLayers"),qy(this,"target"),this.target=t,this.staffEventsLayers=y1(t)}resolveTrack(t,e,r){if(r===N.A.PARTS_HEADER)throw new Error("Unexpected");if(r===N.A.CONTENT)return this.resolve(t,e);if(r===N.A.MEASURES_HEADER)return this.resolveMeasureHeader(t,e);throw new Error("Unsupported")}resolveMeasureHeader(t,e){const r=e.voiceIdxInStaff,i=this.staffEventsLayers[0].resolveGlobalStaff(t,r),a=ky(this.target,t,e.anchors);return i.hoveredEntities.unshift(...a),i.isTouch=!!e.isTouch,i.shiftKey=!!e.shiftKey,i}resolve(t,e){const r=this.getStaffEventsLayer(t,e),i=e.voiceIdxInStaff,a=r.resolve(t,i),l=ky(this.target,t,e.anchors);if(a.hoveredEntities.unshift(...l),a.isTouch=!!e.isTouch,a.shiftKey=!!e.shiftKey,r.globalStaffEventsLayer&&this.target.displayMetrics.measuresPanel===null){const f=r.resolveGlobalHoveredEntities(t);a.hoveredEntities.unshift(...f)}const d=this.staffEventsLayers.indexOf(r);if(d>0){const m=this.staffEventsLayers[d-1].getAllHoveredEntities(t);a.hoveredEntities.unshift(...m)}if(d<this.staffEventsLayers.length-1){const f=this.staffEventsLayers[d+1],m=f.getAllHoveredEntities(t);if(a.hoveredEntities.unshift(...m),f.globalStaffEventsLayer&&this.target.displayMetrics.measuresPanel===null){const S=f.resolveGlobalHoveredEntities(t);a.hoveredEntities.unshift(...S)}}return a}getStaffEventsLayer(t,e){if(e.magnetPosition){const a=this.getFocusedStaffEventsLayer(e.magnetPosition);if(a&&a.isPointInside(t))return a}return this.staffEventsLayers.map(a=>({distance:Math.abs(t.y-a.staffMidY),staffEventsLayer:a})).reduce((a,l)=>a.distance<l.distance?a:l).staffEventsLayer}getFocusedStaffEventsLayer(t){return this.staffEventsLayers.find(e=>e.isFocused(t))||null}}function y1(s){const e=s.systems[0].getChildRoot().parent;if(!e)throw new Error("Parent of systems is not set");const r=rt(e);return s.systems.flatMap(l=>{const d=l.getChildRoot(),f=d.getX()+r.x,m=d.getY()+r.y,S=l.slice.measures.map(x=>x.rawGlobalMeasure.measureUuid),w=l.slice.measures.map(x=>x.rawGlobalMeasure.nextMeasureUuid);return l.parts.flatMap((x,D)=>{const L=x.getChildRoot(),M=L.getX()+f,H=L.getY()+m,$=x.partData.uuid;return x.staves.map((lt,gt)=>{const yt=lt.getChildRoot(),dt=yt.getX()+M,At=yt.getY()+H,Jt=lt.getStaffHeight(),re=At,ds=At+Jt/2,ws=At+Jt,xh=lt.staffData.uuid,_p=lt.staffData.type;let bh=null;if(D===0&&gt===0)if(l.globalStaff){const bn=l.globalStaff;bh={target:bn,staffX:dt,staffBottomY:H,staffTopY:H-bn.getTopHeight()}}else{const bn=l.slice.globalStaff;bh={target:bn,staffX:dt,staffTopY:0,staffBottomY:bn.getTopHeight()}}return{measures:S,nextMeasures:w,partUuid:$,staffUuid:xh,staffType:_p,staffX:dt,staffTopY:re,staffMidY:ds,staffBottomY:ws,staff:lt,globalStaff:bh}})})}).map((l,d,f)=>{const m=l.staffTopY;let S=l.staffTopY;d>0&&(S=f[d-1].staffBottomY);let w=l.staffBottomY;return d<f.length-1&&(w=f[d+1].staffTopY),new h1(l.staff,{globalStaff:l.globalStaff,partUuid:l.partUuid,staffUuid:l.staffUuid,measures:l.measures,nextMeasures:l.nextMeasures,staffType:l.staffType,staffX:l.staffX,staffTopY:S,staffOriginY:m,staffMidY:l.staffMidY,staffBottomY:w})})}var A1=Object.defineProperty,v1=(s,t,e)=>t in s?A1(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Au=(s,t,e)=>v1(s,typeof t!="symbol"?t+"":t,e);class S1{constructor(t){Au(this,"page"),Au(this,"creditsEventsLayers",null),Au(this,"systemHeaderEventsLayers",null),Au(this,"systemsContentsEventsLayer",null),this.page=t}resolveTrack(t,e){const r={x:t.xSpace,y:t.ySpace};if(r.x+=e.horizontalShift,t.pageIdx===N.A.PARTS_HEADER){for(const a of this.getSystemHeaderEventsLayers()){const l=a.resolveTrack(r);if(l)return l}throw new Error("Unexpected")}return this.getSystemsContentsEventsLayer().resolveTrack(r,e,t.pageIdx)}resolve(t,e){const r={x:t.xSpace,y:t.ySpace};r.x+=e.horizontalShift;const i=this.getCreditsEventsLayers();for(const l of i){const d=l.resolve(r);if(d)return d}for(const l of this.getSystemHeaderEventsLayers()){const d=l.resolve(r);if(d)return d}return this.getSystemsContentsEventsLayer().resolve(r,e)}getCreditsEventsLayers(){return this.creditsEventsLayers===null&&(this.creditsEventsLayers=[],this.page.header&&this.creditsEventsLayers.push(new Xy(this.page.header)),this.page.footer&&this.creditsEventsLayers.push(new Xy(this.page.footer))),this.creditsEventsLayers}getSystemHeaderEventsLayers(){return this.systemHeaderEventsLayers===null&&(this.systemHeaderEventsLayers=this.page.systems.map(t=>new VB(t.header))),this.systemHeaderEventsLayers}getSystemsContentsEventsLayer(){return this.systemsContentsEventsLayer===null&&(this.systemsContentsEventsLayer=new m1(this.page)),this.systemsContentsEventsLayer}}function w1(s,t){if(s.sliceWidth===null)return null;const e=t?s.firstSliceHeaderWidth:s.otherSlicesHeaderWidth;return s.sliceWidth-e}function Vy(s,t){const e=x1(s,t),r=b1(s,t);return{top:s.topMargin,bottom:s.bottomMargin,left:e,right:r}}function x1(s,t){return s.pageHeight===null||Dt.default.isOdd(t)?s.internalMargin:s.externalMargin}function b1(s,t){return s.pageHeight===null||Dt.default.isOdd(t)?s.externalMargin:s.internalMargin}var P1=Object.defineProperty,E1=(s,t,e)=>t in s?P1(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Hs=(s,t,e)=>E1(s,typeof t!="symbol"?t+"":t,e);class D1{constructor(t,e,r){Hs(this,"systems",[]),Hs(this,"positions",[]),Hs(this,"dirtyFlag",!0),Hs(this,"formattedFlag",!1),Hs(this,"isFirst"),Hs(this,"displayMetrics"),Hs(this,"drawingContext"),Hs(this,"rootGroup"),Hs(this,"intraMarginGroup"),Hs(this,"header",null),Hs(this,"footer",null),Hs(this,"eventsLayer",null),Hs(this,"pageNumber",0),this.isFirst=e,this.displayMetrics=r,this.drawingContext=t,this.rootGroup=t.createGroupNode(),this.intraMarginGroup=t.createGroupNode(),v(this.rootGroup,this.intraMarginGroup)}setHeader(t){this.header=t,v(this.intraMarginGroup,t.getChildRoot()),this.header.setPageNumber(this.pageNumber)}removeHeader(){this.header&&(it(this.intraMarginGroup,this.header.getChildRoot()),this.header.destroy(),this.header=null)}setFooter(t){if(this.footer=t,v(this.intraMarginGroup,t.getChildRoot()),this.displayMetrics.pageHeight===null)throw new Error("Page height must be set before setting footer");this.footer.setY(this.displayMetrics.pageHeight-this.footer.getHeight())}removeFooter(){this.footer&&(it(this.intraMarginGroup,this.footer.getChildRoot()),this.footer.destroy(),this.footer=null)}isDirty(){return this.dirtyFlag}markDirty(){this.dirtyFlag=!0,this.formattedFlag=!1,this.eventsLayer=null}markClean(){this.dirtyFlag=!1}getLastSystem(){return this.systems[this.systems.length-1]}isEmpty(){return this.systems.length===0}getAvailableHeight(){return this.displayMetrics.pageHeight===null?null:this.isFirst?this.displayMetrics.pageHeight-this.displayMetrics.firstHeaderFooterHeight:this.displayMetrics.pageHeight-this.displayMetrics.otherHeaderFooterHeight}getHeaderGroup(){return this.displayMetrics.partsPanel!==null?this.displayMetrics.partsPanel.getGroup():this.intraMarginGroup}addSystemAt(t){this.markDirty();const{system:e,position:r,systemIdx:i}=t;this.systems.splice(i,0,e),this.positions.splice(i,0,r),e.setPage(this),v(this.intraMarginGroup,e.getChildRoot());const a=e.getHeader(),l=this.getHeaderGroup();v(l,a.getChildRoot())}removeSystem(t){this.markDirty();const e=this.systems.indexOf(t);if(e<0)throw new Error("System not found");it(this.intraMarginGroup,t.getChildRoot()),t.setPage(null),this.positions.splice(e,1),this.systems.splice(e,1);const r=t.getHeader();it(this.intraMarginGroup,r.getChildRoot())}setSystemPosition(t){this.markDirty();const{systemIdx:e,position:r}=t;this.positions[e]=r;const i=this.getHeaderGroup(),l=this.systems[e].getHeader();v(i,l.getChildRoot())}format(){this.formattedFlag||(this.formatVertical(),this.formatHorizontal(),this.formatPage(),this.formattedFlag=!0)}formatVertical(){const t=this.header?this.header.getHeight():0;this.systems.forEach((e,r)=>{const i=this.positions[r];e.setY(i+t)})}formatHorizontal(){this.systems.forEach(t=>{t.formatHorizontal()})}formatPage(){const t=Vy(this.displayMetrics,this.pageNumber);this.intraMarginGroup.setX(t.left),this.intraMarginGroup.setY(t.top);const e=this.getIntraWidth(),r=this.getIntraHeight(),i=t.top+r+t.bottom,a={minX:0,minY:0,maxX:t.left+e+t.right,maxY:i};if(this.rootGroup.setBBoxOverride(a),this.displayMetrics.partsPanel!==null){const d=this.getLastSystem().header.getWidth();this.displayMetrics.partsPanel.format({width:d,height:i,marginTop:t.top})}this.displayMetrics.measuresPanel!==null&&this.displayMetrics.measuresPanel.format(e)}getIntraHeight(){if(this.displayMetrics.pageHeight!==null)return this.displayMetrics.pageHeight;{const t=this.getLastSystem();return t.getY()+t.getStaffHeight()+t.getBottomHeight()}}getIntraWidth(){if(this.displayMetrics.sliceWidth!==null)return this.displayMetrics.sliceWidth;{const t=this.getLastSystem(),e=t.getWidth();if(this.displayMetrics.partsPanel===null){const r=t.header.getWidth();return e+r}else return e}}getChildRoot(){return this.rootGroup}setPageNumber(t){this.pageNumber=t,this.header&&this.header.setPageNumber(t)}getFakePageData(t){const e=this.systems[0],i=e.parts[0].partData.uuid,l=e.slice.measures[0].rawGlobalMeasure.measureUuid,d=this.systems[this.systems.length-1],m=d.parts[d.parts.length-1].partData.uuid,w=d.slice.measures[d.slice.measures.length-1].rawGlobalMeasure.measureUuid;let x;this.displayMetrics.pageHeight===null?x=e.getStaffHeight()+e.getTopHeight()+e.getBottomHeight()+this.displayMetrics.topMargin+this.displayMetrics.bottomMargin:x=this.displayMetrics.pageHeight+this.displayMetrics.topMargin+this.displayMetrics.bottomMargin;let D;return this.displayMetrics.sliceWidth===null?D=e.getWidth():D=this.displayMetrics.sliceWidth+this.displayMetrics.externalMargin+this.displayMetrics.internalMargin,{pageIdx:t,height:x,width:D,firstMeasureUuid:l,lastMeasureUuid:w,firstPartUuid:i,lastPartUuid:m}}getTracksMetadata(){const t=this.systems[0],e=t.slice,r=t.getTopPart(),i=r.getTopStaff();let a=0;const l=i.measures.map((m,S)=>{const D={uuid:e.measures[S].rawGlobalMeasure.measureUuid,position:a};return a+=m.getWidth(),D}),d=r.getTopHeight();return{parts:t.parts.map(m=>{const S=m.partData.uuid,w=d+m.getY();return{uuid:S,position:w}}),measures:l}}getEventsLayer(){return this.eventsLayer===null&&(this.eventsLayer=new S1(this)),this.eventsLayer}getGeometry(){const t=Vy(this.displayMetrics,this.pageNumber),e=this.getIntraWidth(),r=this.getIntraHeight(),i=t.top+r+t.bottom,a=t.left+e+t.right,l=this.systems.map(d=>d.getGeometry());return{width:a,height:i,pageIdx:this.pageNumber,systems:l}}}var C1=b(340497),T1=Object.defineProperty,R1=(s,t,e)=>t in s?T1(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,ho=(s,t,e)=>R1(s,typeof t!="symbol"?t+"":t,e);class N1{constructor(t,e,r,i){ho(this,"pages",[]),ho(this,"pageIdx",0),ho(this,"systemsProvider"),ho(this,"drawingContext"),ho(this,"displayMetrics"),ho(this,"pageHeaderFooterFactory"),this.systemsProvider=t,this.drawingContext=e,this.displayMetrics=r,this.pageHeaderFooterFactory=i}setPageHeaderFooterFactory(t){this.pageHeaderFooterFactory=t,this.pages.forEach((e,r)=>{if(this.pageHeaderFooterFactory){const i=r===0,{header:a,footer:l}=this.pageHeaderFooterFactory.createHeaderFooter(i);e.setHeader(a),e.setFooter(l)}else e.removeHeader(),e.removeFooter()})}seekDirtyPage(){if(this.pageIdx=this.pages.findIndex(t=>t.isDirty()||t.isEmpty()),this.pageIdx===-1&&(this.pageIdx=this.pages.length),this.pageIdx===0)this.systemsProvider.setSliceIdx(0);else{const t=this.pages[this.pageIdx-1];this.setCursorAfterPage(t);const r=t.getLastSystem().slice;this.systemsProvider.setSliceIdxAfterSlice(r)}}hasNext(){return this.systemsProvider.hasNext()}getNext(){se.n("pagesProvider.getNext");const t=this.pageIdx===0;let e;if(this.pageIdx===this.pages.length){if(e=new D1(this.drawingContext,t,this.displayMetrics),this.pageHeaderFooterFactory){const{header:i,footer:a}=this.pageHeaderFooterFactory.createHeaderFooter(t);e.setHeader(i),e.setFooter(a)}const r=this.drawingContext.getPageNumber(this.pageIdx);e.setPageNumber(r),this.pages.push(e)}else e=this.pages[this.pageIdx];return e.isDirty()?((0,C1.A)(e,this.systemsProvider,this.drawingContext),e.markClean()):this.setCursorAfterPage(e),this.pageIdx++,se.d("pagesProvider.getNext"),e}setCursorAfterPage(t){const r=t.getLastSystem().slice;this.systemsProvider.setSliceIdxAfterSlice(r)}}function Qy(s,t){let e=Math.max(Jy(s),Jy(t)),r=0,i=0;for(;r<s.length&&i<t.length;){const a=s[r],l=t[i];L1(a,l)&&(e=Math.max(e,a.height+l.height));const d=a.position+a.width,f=l.position+l.width;d<=f&&r++,f<=d&&i++}return e}function L1(s,t){return Ky(s,t)||Ky(t,s)}function Ky(s,t){return s.position<=t.position&&s.position+s.width>t.position}function Jy(s){return Math.max(...s.map(t=>t.height),0)}var M1=Object.defineProperty,O1=(s,t,e)=>t in s?M1(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,lo=(s,t,e)=>O1(s,typeof t!="symbol"?t+"":t,e);const B1="part",I1=.5;class Np{constructor(t,e,r){lo(this,"staves",[]),lo(this,"group"),lo(this,"drawingContext"),lo(this,"parent",null),lo(this,"header"),lo(this,"partData"),this.drawingContext=t,this.group=t.createGroupNode(),this.group.setLabel(B1),this.partData=r,this.header=e}getPartUuid(){return this.partData.uuid}addStaff(t){this.staves.push(t),v(this.group,t.getChildRoot())}addMeasure(t){if(t.length!==this.staves.length)throw new Error("Invalid number of measures");t.forEach((e,r)=>{this.staves[r].addMeasure(e)})}removeMeasureAt(t,e){this.staves.forEach((r,i)=>r.removeMeasureAt(t,e[i]))}addMeasureAt(t,e){if(t.length!==this.staves.length)throw new Error("Invalid number of measures");t.forEach((r,i)=>{this.staves[i].addMeasureAt(r,e)})}getMeasureHorizontalData(t){return this.staves.map(e=>e.getMeasureHorizontalData(t))}setMeasureHorizontalFormatter(t,e){this.staves.forEach(r=>r.setMeasureHorizontalFormatter(t,e))}formatVertical(){this.staves.forEach(a=>a.formatVertical());let t=0;const e=this.drawingContext.getSpaceBetweenStaves(),r=this.drawingContext.getSpaceBetweenStavesRecorder();this.staves.forEach((a,l)=>{if(l===0)return;const f=this.staves[l].staffData.type===Zt.A.RECORDER_TAB?r:e,m=this.staves[l-1];t+=m.getStaffHeight();const S=m.getBottomHeights(),w=a.getTopHeights();let x=Qy(S,w)+I1;x=Math.max(x,f),t+=x,a.setY(t),(0,Ft.g6)(this.staves[l].staffData)&&m.extendBarlines(x)});const i=this.getStaffHeight();this.header.setHeight(i)}getStaffHeight(t=!1){const e=this.getBottomStaff(t);return e.getY()+e.getStaffHeight()}getBottomHeight(){return this.getBottomStaff().getBottomHeight()}getBottomHeights(){return this.getBottomStaff().getBottomHeights()}extendBarlines(t){this.getBottomStaff().extendBarlines(t)}getTopHeight(){return this.getTopStaff().getTopHeight()}getTopHeights(){return this.getTopStaff().getTopHeights()}getTopStaff(){return this.staves[0]}getBottomStaff(t=!1){let e=this.staves.length-1;return t&&e===1&&(0,Ft.pS)(this.staves[e].staffData)&&(e=0),this.staves[e]}setY(t){this.group.setY(t),this.header.setY(t)}getY(){return this.group.getY()}getChildRoot(){return this.group}reloadCrossMeasures(){this.staves.forEach(t=>t.reloadCrossMeasures())}setParent(t){this.parent=t}formatHorizontal(){this.staves.forEach(t=>t.formatHorizontal())}getWidth(){return this.getTopStaff().getWidth()}getHeader(){return this.header}isEmpty(){return this.staves.every(t=>t.isEmpty())}getGeometry(){const t=this.staves.map(e=>e.getGeometry());return{y:this.group.getY(),partUuid:this.partData.uuid,staves:t}}setGroupIdx(t){this.header.setGroupIdx(t)}hasGroup(){return this.header.hasGroup()}getGroupIdx(){return this.header.getGroupIdx()}setIsFirstOfGroup(t){this.header.setIsFirstOfGroup(t)}hasGroupStart(){return this.header.hasGroupStart()}isFirstOfGroupBracket(){return this.header.isFirstOfGroupBracket()}setIsLastOfGroup(t){this.header.setIsLastOfGroup(t)}hasGroupStop(){return this.header.hasGroupStop()}hasGroupBracket(){return this.header.hasGroupBracket()}getGroupBracket(){return this.header.getGroupBracket()}setGroupBracket(t){this.header.setGroupBracket(t)}}var F1=Object.defineProperty,U1=(s,t,e)=>t in s?F1(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,vu=(s,t,e)=>U1(s,typeof t!="symbol"?t+"":t,e);const H1="brace",_1=4;class G1{constructor(t,e){vu(this,"groupNode"),vu(this,"glyphNode"),vu(this,"nominalHeight"),vu(this,"x",0);const r=e/_1;this.groupNode=t.createGroupNode(),this.glyphNode=t.createGlyphNode(H1,r),v(this.groupNode,this.glyphNode),this.nominalHeight=e}setHeight(t){const e=t/this.nominalHeight;this.groupNode.setScalingY(e),this.groupNode.setY(t)}getWidth(){return this.glyphNode.getWidth()}setX(t){this.x=t;const e=this.glyphNode.getLocalBBox();this.groupNode.setX(t-e.minX)}getX(){return this.x}getChildRoot(){return this.groupNode}}var X1=Object.defineProperty,W1=(s,t,e)=>t in s?X1(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,co=(s,t,e)=>W1(s,typeof t!="symbol"?t+"":t,e);const z1="bracketTop",Y1="bracketBottom",uo=1;class k1{constructor(t,e){co(this,"group"),co(this,"topGlyph"),co(this,"bottomGlyph"),co(this,"line"),co(this,"nominalHeight"),co(this,"width"),this.group=t.createGroupNode(),this.topGlyph=t.createGlyphNode(z1),v(this.group,this.topGlyph),this.topGlyph.setY(-uo),this.bottomGlyph=t.createGlyphNode(Y1),v(this.group,this.bottomGlyph),this.bottomGlyph.setY(e+uo),this.line=t.createLineNode(),this.width=t.getBracketThickness(),this.line.setWidth(this.width),this.line.setX(this.width/2),this.line.setX2(0),this.line.setY(-uo),this.line.setY2(e+uo*2),v(this.group,this.line),this.nominalHeight=e}setHeight(t){this.bottomGlyph.setY(t+uo),this.line.setY2(t+uo*2)}getWidth(){return this.width}setX(t){this.group.setX(t)}getX(){return this.group.getX()}getChildRoot(){return this.group}}var $y=b(226464),q1=Object.defineProperty,V1=(s,t,e)=>t in s?q1(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,zs=(s,t,e)=>V1(s,typeof t!="symbol"?t+"":t,e);const Q1="partHeader",fo=.5;class K1{constructor(t,e,r,i,a){if(zs(this,"group"),zs(this,"textNode"),zs(this,"longText"),zs(this,"shortText"),zs(this,"bracket",null),zs(this,"groupBracket",null),zs(this,"groupIdx",null),zs(this,"isFirstOfGroup",null),zs(this,"isLastOfGroup",null),zs(this,"height",0),zs(this,"width",null),zs(this,"partUuid"),this.group=t.createGroupNode(),this.group.setLabel(Q1),this.longText=e,this.shortText=r,this.partUuid=a,!i&&!t.displayOtherLinesPartsNames())return;const l=i?e:r,d=t.getPartNameFontOptions();this.textNode=t.createTextNode(l,d);const f={entityType:T.A.PART_NAME,partUuid:a};this.textNode.setEventPayload(f),v(this.group,this.textNode)}setBracket(t){this.bracket=t,v(this.group,t.getChildRoot())}setHeight(t){if(this.height=t,this.bracket&&this.bracket.setHeight(t),!this.textNode)return;const e=t/2+this.textNode.getFontSize()/3;this.textNode.setY(e)}getBracketPosition(){return this.bracket===null?0:this.bracket.getWidth()+fo}getWidth(){return this.width===null&&(this.width=this.formatHorizontal()),this.width}getHorizontalPositionBeforeGroupBracket(){let t=-fo;return this.bracket&&(t-=this.bracket.getWidth(),t-=fo),t}formatHorizontal(){let t=-fo;if(this.bracket&&(t-=this.bracket.getWidth(),this.bracket.setX(t),t-=fo),this.isFirstOfGroupBracket()&&this.groupBracket.formatHorizontal(),this.hasGroup()&&(this.groupBracket.formatHorizontal(),t=this.groupBracket.getX(),t-=fo),this.textNode){const e=this.textNode.getWidth();t-=e,this.textNode.setX(t)}return this.width=-t,this.width}setPartNameFormat(t){this.textNode&&(t===$y.A.SMALL?this.textNode.setText(this.shortText):t===$y.A.LARGE&&this.textNode.setText(this.longText),this.formatHorizontal())}setX(t){this.group.setX(t)}getChildRoot(){return this.group}setY(t){this.group.setY(t)}setGroupIdx(t){this.groupIdx=t}getGroupIdx(){return this.groupIdx}hasGroup(){return this.groupIdx!==null}setIsFirstOfGroup(t){this.isFirstOfGroup=t}hasGroupStart(){return!!this.isFirstOfGroup}isFirstOfGroupBracket(){var t;return this.groupBracket&&((t=this.groupBracket.getTopPart())==null?void 0:t.getPartUuid())===this.partUuid}setIsLastOfGroup(t){this.isLastOfGroup=t}hasGroupStop(){return!!this.isLastOfGroup}hasGroupBracket(){return this.groupBracket!==null}getGroupBracket(){return this.groupBracket}setGroupBracket(t){this.groupBracket=t,t!==null&&this.isFirstOfGroupBracket()&&v(this.group,t.getChildRoot())}}function Zy(s,t,e){const r=J1(s,t),i=new K1(s,t.longName,t.shortName,e,t.uuid);i.setHeight(r);const a=$1(t);if(a){const l=new a(s,r);i.setBracket(l)}return i}function J1(s,t){let e=t.staves.map(Ft.o5).reduce(Dt.default.add,0);if(t.staves.length>1){const r=s.getSpaceBetweenStaves();e+=(t.staves.length-1)*r}return e}function $1(s){return s.staves.length===1?null:s.staves.length===2&&(s.staves[1].type===Zt.A.GUITAR_TAB||s.staves[1].type===Zt.A.RECORDER_TAB||s.staves[1].type===Zt.A.KODALY)?k1:G1}var Z1=Object.defineProperty,j1=(s,t,e)=>t in s?Z1(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Sn=(s,t,e)=>j1(s,typeof t!="symbol"?t+"":t,e);const tI="bracketTop",eI="bracketBottom",jy="#AAAAAA";class tA{constructor(t){Sn(this,"drawingContext"),Sn(this,"group"),Sn(this,"topGlyph"),Sn(this,"bottomGlyph"),Sn(this,"line"),Sn(this,"parts",[]),Sn(this,"width"),this.drawingContext=t,this.group=t.createGroupNode(),this.topGlyph=t.createGlyphNode(tI),v(this.group,this.topGlyph),this.topGlyph.setY(-this.drawingContext.getGroupBracketExtraSpace()),this.bottomGlyph=t.createGlyphNode(eI),v(this.group,this.bottomGlyph),this.bottomGlyph.setY(0),this.line=t.createLineNode(),this.width=t.getBracketThickness(),this.line.setWidth(this.width),this.line.setX(this.width/2),this.line.setX2(0),this.line.setY(-this.drawingContext.getGroupBracketExtraSpace()),v(this.group,this.line)}addPart(t){this.parts.push(t),t.setGroupBracket(this)}getParts(){return this.parts}getTopPart(){return this.parts.length>=0?this.parts[0]:null}getBottomPart(){return this.parts.length>=0?this.parts[this.parts.length-1]:null}removePart(t){const e=this.parts.indexOf(t);if(e<0)throw new Error("The part is not part of the bracket group.");this.parts.splice(e,1),t.setGroupBracket(null)}removePartsRange(t,e){if(!(this.parts[t]instanceof Np&&this.parts[e]instanceof Np))throw new Error("Tried removing unexisting parts");const i=this.parts.splice(t,e-t+1);return i.forEach(a=>{a.setGroupBracket(null)}),i}formatVertical(){const t=this.getTopPart(),e=this.getBottomPart();if(!e||!t)throw new Error("GroupBracket should have parts filled at this point");this.setHeight(e.getY()-t.getY()+e.getStaffHeight()),this.recolorTopBottomGlyphs()}getChildRoot(){return this.group}setHeight(t){this.bottomGlyph.setY(t+this.drawingContext.getGroupBracketExtraSpace()),this.line.setY2(t+this.drawingContext.getGroupBracketExtraSpace()*2)}getWidth(){return this.width}setX(t){this.group.setX(t)}getFurthestLeftPosition(){return Math.min(...this.getParts().map(t=>t.getHeader().getHorizontalPositionBeforeGroupBracket()))}getAllPartsHeight(t){let e=0;return this.parts.forEach((r,i)=>{e+=r.getStaffHeight()+r.getBottomHeight(),i!==0&&(e+=t)}),e}formatHorizontal(){this.setX(this.getFurthestLeftPosition()-this.getWidth())}recolorTopBottomGlyphs(){var t,e;(t=this.getTopPart())!=null&&t.hasGroupStart()||this.topGlyph.setColor(jy),(e=this.getBottomPart())!=null&&e.hasGroupStop()||this.bottomGlyph.setColor(jy)}getX(){return this.group.getX()}destroy(){this.group.destroy()}}var sI=Object.defineProperty,rI=(s,t,e)=>t in s?sI(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Su=(s,t,e)=>rI(s,typeof t!="symbol"?t+"":t,e);function iI(s,t){new nI(s,t).link()}class nI{constructor(t,e){Su(this,"parts"),Su(this,"drawingContext"),Su(this,"currentBracket",null),Su(this,"bracketsSet",new Set),this.parts=t,this.drawingContext=e}link(){this.parts.forEach(this.processPart,this),this.removeUnusedPartsFromBrackets()}processPart(t,e){if(!t.hasGroup()){this.currentBracket=null;return}const r=this.getPartBracket(t,e);this.currentBracket=r,this.bracketsSet.add(r),this.setPartBracket(t)}getPartBracket(t,e){if(t.hasGroupStart())return t.hasGroupBracket()?t.getGroupBracket():this.createGroupBracket();if(e===0){if(t.hasGroupBracket()){const r=t.getGroupBracket();if(r.getTopPart()===t)return r}return this.createGroupBracket()}if(this.currentBracket===null)throw new Error("No ongoing group bracket to connect to");return this.currentBracket}createGroupBracket(){return new tA(this.drawingContext)}setPartBracket(t){if(t.hasGroupBracket()){const e=t.getGroupBracket();if(e===this.currentBracket)return;t.hasGroupStart()||e.getTopPart()===t&&e.destroy(),e.removePart(t)}this.currentBracket!==null&&this.currentBracket.addPart(t)}removeUnusedPartsFromBrackets(){const t=new Set(this.parts);this.bracketsSet.forEach(e=>{e.getParts().forEach(i=>{t.has(i)||e.removePart(i)})})}}function oI(s){let t=null;s.forEach((e,r)=>{if(!e.partData.isGroupedWithPrevious){r!==0&&s[r-1]&&t!==null&&(t=null,s[r-1].setIsLastOfGroup(!0));return}if(t===null&&r!==0){t=0;const d=s[r-1];d.setGroupIdx(t),d.setIsFirstOfGroup(!0),t+=1}t!==null&&(e.setGroupIdx(t),t+=1),r===s.length-1&&e.setIsLastOfGroup(!0)})}var aI=Object.defineProperty,hI=(s,t,e)=>t in s?aI(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,go=(s,t,e)=>hI(s,typeof t!="symbol"?t+"":t,e);const lI="staffLines";class cI{constructor(t,e){go(this,"drawingContext"),go(this,"root"),go(this,"lines"),go(this,"width"),go(this,"height"),go(this,"staffData"),this.drawingContext=t,this.root=t.createGroupNode(),this.root.setLabel(lI),this.lines=[],this.width=0,this.staffData=e,this.createLines(),this.height=(0,Ft.o5)(e)}getHeight(){return this.height}getChildRoot(){return this.root}setWidth(t){t!==this.width&&(this.width=t,this.lines.forEach(e=>e.setX2(t)))}getWidth(){return this.width}createLines(){if(this.isRecorderTabStaff()||this.isKodalyStaff())return;const t=this.staffData.nbStaffLines,e=this.drawingContext.getStaffLineThickness();for(let r=0;r<t;r++){const i=this.drawingContext.createLineNode();i.setWidth(e),i.setY(r*this.staffData.spaceSize),this.lines.push(i),v(this.root,i)}}isRecorderTabStaff(){return this.staffData.type===Zt.A.RECORDER_TAB}isKodalyStaff(){return this.staffData.type===Zt.A.KODALY}}function Za(s,t){if(t.isStart())s.setLeftAnchor(null);else if(t.isStop())s.setRightAnchor(null);else throw new Error("Unexpected");t.bend=null,s.isOrphan()&&s.erase()}function uI(s){if(s.isOrphan()){s.erase();return}s.leftAnchor&&Za(s,s.leftAnchor),s.rightAnchor&&Za(s,s.rightAnchor)}var dI=Object.defineProperty,fI=(s,t,e)=>t in s?dI(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,_r=(s,t,e)=>fI(s,typeof t!="symbol"?t+"":t,e);const eA=new Map([[Is.A.BEND,"arrowheadBlackUp"],[Is.A.PRE_BEND,"arrowheadBlackRight"],[Is.A.RELEASE,"arrowheadBlackDown"]]),sA=.4;class gI{constructor(t){_r(this,"drawingContext"),_r(this,"groupNode"),_r(this,"leftAnchor",null),_r(this,"rightAnchor",null),_r(this,"preBendLine",null),_r(this,"bendLine",null),_r(this,"rightText",null),_r(this,"leftText",null),_r(this,"rightArrow",null),_r(this,"leftArrow",null),this.drawingContext=t,this.groupNode=this.drawingContext.createGroupNode()}formatHorizontal(){if(!this.leftAnchor||!this.rightAnchor)throw new Error("Anchors should be set by now");this.addBend(),this.positionBend(),this.addPreBend(),this.positionPreBend()}hasBend(){var t,e,r;return!!(!((t=this.leftAnchor)!=null&&t.hasPreBend())||(e=this.rightAnchor)!=null&&e.isTiedRight()||this.leftAnchor.isTiedLeft()||((r=this.rightAnchor)==null?void 0:r.getBendType())!==Is.A.PRE_BEND)}addBend(){if(!this.leftAnchor||!this.rightAnchor)throw new Error("Anchors should be set by now");if(!this.hasBend())return null;this.bendLine===null&&(this.bendLine=this.attachBendLine()),this.rightText===null&&(this.rightText=this.attachRightText()),this.rightArrow===null&&(this.rightArrow=this.attachRightArrow())}hasPreBend(){var t;return((t=this.leftAnchor)==null?void 0:t.hasPreBend())&&!this.leftAnchor.isTiedLeft()}addPreBend(){if(!this.leftAnchor||!this.rightAnchor)throw new Error("Anchors should be set by now");if(!this.hasPreBend())return null;this.preBendLine===null&&(this.preBendLine=this.attachPreBendLine()),this.leftText===null&&(this.leftText=this.attachLeftText()),this.leftArrow===null&&(this.leftArrow=this.attachLeftArrow())}attachBendLine(){const t=this.drawingContext.getBendLineThickness(),e=this.drawingContext.createQuadCurveNode(t);return v(this.groupNode,e),e}attachPreBendLine(){const t=this.drawingContext.createLineNode();return t.setWidth(this.drawingContext.getBendLineThickness()),v(this.groupNode,t),t}attachRightText(){if(!this.leftAnchor||!this.rightAnchor)throw new Error("Anchors should be set by now");const t=this.rightAnchor.getRightText();if(t===null)return null;const e=this.drawingContext.createTextNode(t,this.drawingContext.getBendTextOptions());return v(this.groupNode,e),e}attachRightArrow(){if(!this.leftAnchor||!this.rightAnchor)throw new Error("Anchors should be set by now");const t=this.rightAnchor.getBendType();if(!t)throw new Error("Right anchor must have type");const e=eA.get(t);if(!e)throw new Error("No glyph id for given bend type");const r=this.drawingContext.createGlyphNode(e,sA);return v(this.groupNode,r),r}attachLeftText(){if(!this.leftAnchor||!this.rightAnchor)throw new Error("Anchors should be set by now");const t=this.leftAnchor.getLeftText();if(t===null)return null;const e=this.drawingContext.createTextNode(t,this.drawingContext.getBendTextOptions());return v(this.groupNode,e),e}attachLeftArrow(){if(!this.leftAnchor||!this.rightAnchor)throw new Error("Anchors should be set by now");const t=eA.get(Is.A.BEND);if(!t)throw new Error("No glyph id for given bend type");const e=this.drawingContext.createGlyphNode(t,sA);return v(this.groupNode,e),e}positionBend(){var t,e,r,i,a,l,d,f,m,S;if(!this.leftAnchor||!this.rightAnchor)throw new Error("Anchors and arrow should be set by now");if(!this.bendLine||!this.rightArrow)return;const w=this.rightAnchor.getBendType(),x=this.rightAnchor.isTextShifted(),D=this.leftAnchor.getBendLeftX(),L=this.rightAnchor.getBendRightX(),M=this.leftAnchor.getLeftY();let H=this.rightAnchor.getRightY();w===Is.A.BEND?H-=this.rightArrow.getHeight():w===Is.A.RELEASE&&(H+=this.rightArrow.getHeight());let $=H;w===Is.A.RELEASE?$+=(e=(t=this.rightArrow)==null?void 0:t.getHeight())!=null?e:0:$+=(r=this.rightArrow)!=null&&r.getHeight()?((i=this.rightArrow)==null?void 0:i.getHeight())/2:0;const lt=H-((l=(a=this.rightArrow)==null?void 0:a.getHeight())!=null?l:0),gt=L-(x&&(f=(d=this.rightText)==null?void 0:d.getWidth())!=null?f:0),yt=L-((S=(m=this.rightArrow)==null?void 0:m.getWidth())!=null?S:0)/2;this.rightArrow.setX(yt),this.rightArrow.setY($),this.rightText&&(this.rightText.setX(gt),this.rightText.setY(lt)),this.bendLine.setX(D),this.bendLine.setY(M);const dt={x:L-D,y:H-M},At={x:dt.x,y:0};this.bendLine.setPoints(At,dt)}positionPreBend(){if(!this.leftAnchor)throw new Error("Anchors should be set by now");if(!this.preBendLine||!this.leftArrow)return;const t=this.leftAnchor.getPreBendBottomY(),e=this.leftAnchor.getPreBendTopY(),r=this.leftAnchor.getPreBendX(),i=e+this.leftArrow.getHeight(),a=e-this.leftArrow.getHeight(),l=r,d=r-this.leftArrow.getWidth()/2;this.leftArrow.setX(d),this.leftArrow.setY(i),this.leftText&&(this.leftText.setX(l),this.leftText.setY(a)),this.preBendLine.setX(r),this.preBendLine.setX2(0),this.preBendLine.setY(t),this.preBendLine.setY2(e-t)}getChildRoot(){return this.groupNode}isAbove(){return!0}isBelow(){return!1}erase(){this.groupNode.destroy()}setLeftAnchor(t){var e;this.hasLeftAnchor()&&this.leftAnchor!==t&&this.removeLeftAnchor(),this.leftAnchor=t,(e=this.leftAnchor)==null||e.setBend(this)}hasLeftAnchor(){return this.leftAnchor!==null}removeLeftAnchor(){this.hasLeftAnchor()&&(this.leftAnchor.bend=null,this.leftAnchor=null,this.removeSubComponents())}removeRightAnchor(){this.hasRightAnchor()&&(this.rightAnchor.bend=null,this.rightAnchor=null,this.removeSubComponents())}removeSubComponents(){this.bendLine!==null&&(it(this.groupNode,this.bendLine),this.bendLine.destroy(),this.bendLine=null),this.rightText!==null&&(it(this.groupNode,this.rightText),this.rightText.destroy(),this.rightText=null),this.rightArrow!==null&&(it(this.groupNode,this.rightArrow),this.rightArrow.destroy(),this.rightArrow=null),this.preBendLine!==null&&(it(this.groupNode,this.preBendLine),this.preBendLine.destroy(),this.preBendLine=null),this.leftText!==null&&(it(this.groupNode,this.leftText),this.leftText.destroy(),this.leftText=null),this.leftArrow!==null&&(it(this.groupNode,this.leftArrow),this.leftArrow.destroy(),this.leftArrow=null)}setRightAnchor(t){var e;this.hasRightAnchor()&&this.rightAnchor!==t&&this.removeRightAnchor(),this.rightAnchor=t,(e=this.rightAnchor)==null||e.setBend(this)}hasRightAnchor(){return this.rightAnchor!==null}isOrphan(){return!this.leftAnchor||!this.rightAnchor&&!this.getChildRoot().parent}}function rA(s,t){if(t.isStart()){if(s.leftAnchor===t)return;s.leftAnchor&&Za(s,s.leftAnchor),s.setLeftAnchor(t)}else if(t.isStop()){if(s.rightAnchor===t)return;s.rightAnchor&&Za(s,s.rightAnchor),s.setRightAnchor(t)}else throw new Error("Unexpected");t.bend=null}var pI=Object.defineProperty,mI=(s,t,e)=>t in s?pI(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,wu=(s,t,e)=>mI(s,typeof t!="symbol"?t+"":t,e);function yI(s,t,e,r){if(r.type!==Zt.A.GUITAR_TAB)throw new Error("Must be guitar tab staff");const i=r.nbStaffLines,a=[];for(let l=1;l<=i;l++){const d=s.flatMap((m,S)=>AI(m,S,s,t,l)),f=new vI(e,r);a.push(...f.match(d))}return a}function AI(s,t,e,r,i){const a=[];if(t===0){const m=s.getLeftBendAnchor(r,i);m&&a.push(m)}const d=s.getMiddleBendAnchors(r,i);if(a.push(...d),t===e.length-1){const m=s.getRightBendAnchor(r,i);m&&a.push(m)}return a}class vI{constructor(t,e){wu(this,"bends",[]),wu(this,"tempAnchor",null),wu(this,"drawingContext"),wu(this,"staffData"),this.drawingContext=t,this.staffData=e}match(t){return t.forEach(this.processAnchor,this),this.bends}processAnchor(t){t.isStart()?(this.tempAnchor&&iA(this.tempAnchor),this.tempAnchor=t):t.isStop()&&(this.tempAnchor?(this.createBend(this.tempAnchor,t),this.tempAnchor=null):iA(t))}createBend(t,e){let r;t.bend?r=t.bend:e.bend?r=e.bend:r=new gI(this.drawingContext),rA(r,t),rA(r,e),this.bends.push(r)}}function iA(s){if(s.bend){const t=s.bend;Za(t,s)}}var SI=Object.defineProperty,wI=(s,t,e)=>t in s?SI(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,ja=(s,t,e)=>wI(s,typeof t!="symbol"?t+"":t,e);const xI="staffVoiceBends";class bI{constructor(t,e,r){ja(this,"group"),ja(this,"drawingContext"),ja(this,"staffData"),ja(this,"voiceIdx"),ja(this,"bends",[]),this.group=t.createGroupNode(),this.group.setLabel(xI),this.drawingContext=t,this.staffData=e,this.voiceIdx=r}updateFromMeasures(t){const e=yI(t,this.voiceIdx,this.drawingContext,this.staffData);for(let r=this.bends.length-1;r>=0;r--){const i=this.bends[r];!e.includes(i)&&(this.bends.pop(),it(this.group,i.getChildRoot()),uI(i))}e.forEach(r=>{this.bends.includes(r)||(this.bends.push(r),v(this.group,r.getChildRoot()))})}formatHorizontal(){this.bends.forEach(t=>t.formatHorizontal())}getChildRoot(){return this.group}}function th(s,t){if(t.isStart())s.setLeftAnchor(null);else if(t.isStop())s.setRightAnchor(null);else throw new Error(`Invalid anchor type: ${t.type}`);t.glissando=null,s.isOrphan()&&s.destroy()}function PI(s){if(s.isOrphan()){s.destroy();return}s.leftAnchor&&th(s,s.leftAnchor),s.rightAnchor&&th(s,s.rightAnchor)}var EI=Object.defineProperty,DI=(s,t,e)=>t in s?EI(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,ai=(s,t,e)=>DI(s,typeof t!="symbol"?t+"":t,e);const nA="wiggleGlissando";class CI{constructor(t,e){ai(this,"drawingContext"),ai(this,"groupNode"),ai(this,"leftOffset"),ai(this,"rightOffset"),ai(this,"posX1",0),ai(this,"posX2",0),ai(this,"posY1"),ai(this,"posY2"),ai(this,"wiggles",[]),this.drawingContext=t,this.posY1=e.leftY,this.posY2=e.rightY,this.leftOffset=e.leftOffset,this.rightOffset=e.rightOffset,this.groupNode=this.drawingContext.createGroupNode(),this.groupNode.setY(this.posY1)}getWidth(){const t=Math.pow(this.posX2-this.posX1,2),e=Math.pow(this.posY2-this.posY1,2);return Math.sqrt(t+e)}getAngle(){return-Math.atan2(this.posY2-this.posY1,this.posX2-this.posX1)*(180/Math.PI)}removeWiggles(){this.wiggles.forEach(t=>{it(this.groupNode,t)}),this.wiggles=[]}formatHorizontal(t,e){const r=this.drawingContext.createGlyphNode(nA);t+=this.leftOffset,e+=this.rightOffset,this.posX1=t,this.posX2=e,this.groupNode.setX(this.posX1),this.groupNode.setRotation(this.getAngle());const i=r.getWidth()-this.drawingContext.getGlissandoExcessWidth(),a=this.getWidth(),l=Math.floor(a/i);this.wiggles.length&&this.removeWiggles();for(let d=0;d<l;d++){const f=this.drawingContext.createGlyphNode(nA);f.setX(d*i),v(this.groupNode,f),this.wiggles.push(f)}}getChildRoot(){return this.groupNode}}function TI(s,t){const e=new Map,r=s.getGlissandoStarts().map(a=>a.line),i=t.getGlissandoStops().map(a=>a.line);if(r.length!==i.length)throw new Error("Glissando lines count mismatch");return r.forEach((a,l)=>{const d=i[l];e.set(a,{isExternal:!1,line:a,rightLine:d})}),Array.from(e.values())}var RI=Object.defineProperty,NI=(s,t,e)=>t in s?RI(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,po=(s,t,e)=>NI(s,typeof t!="symbol"?t+"":t,e);const LI="chordGlissandos";class MI{constructor(t,e){po(this,"drawingContext"),po(this,"staffData"),po(this,"group"),po(this,"leftAnchor",null),po(this,"rightAnchor",null),po(this,"lines",null),this.drawingContext=t,this.staffData=e,this.group=t.createGroupNode(),this.group.setLabel(LI)}discardLines(){this.lines!==null&&(this.lines.forEach(t=>{const e=t.getChildRoot();it(this.group,e),e.destroy()}),this.lines=null)}getLines(){return this.lines===null&&(this.lines=this.createGlissandoLines()),this.lines}createGlissandoLines(){if(!this.leftAnchor||!this.rightAnchor)throw new Error("Cannot create glissando lines without anchors");const t=this.leftAnchor.displayData,e=this.rightAnchor.displayData;return TI(t,e).map(this.createGlissandoLine,this)}createGlissandoLine(t){if(!this.leftAnchor||!this.rightAnchor)throw new Error("Cannot create glissando lines without anchors");let e=0;this.leftAnchor.location&&(e=this.leftAnchor.location.note.getMiddleHeadWidth());let r=0;this.rightAnchor.location&&(r=0);const i=(0,Ft.$n)(t.line,this.staffData),a=(0,Ft.$n)(t.rightLine,this.staffData),l=new CI(this.drawingContext,{leftY:i,rightY:a,leftOffset:e,rightOffset:r});return v(this.group,l.getChildRoot()),l}formatHorizontal(){const t=this.getLeftX()+this.drawingContext.getGlissandoHorizontalMargin(),e=this.getRightX()-this.drawingContext.getGlissandoHorizontalMargin();this.getLines().forEach(i=>i.formatHorizontal(t,e))}getLeftX(){if(!this.leftAnchor)throw new Error("Cannot get left X without left anchor");if(this.leftAnchor.hasLocation())return this.leftAnchor.getPosition();if(!this.rightAnchor)throw new Error("Cannot get left X without right anchor");return this.rightAnchor.getOppositeEdgePosition()}getRightX(){if(!this.rightAnchor)throw new Error("Cannot get right X without right anchor");if(this.rightAnchor.hasLocation())return this.rightAnchor.getPosition();if(!this.leftAnchor)throw new Error("Cannot get right X without left anchor");return this.leftAnchor.getOppositeEdgePosition()}getChildRoot(){return this.group}isOrphan(){return!this.leftAnchor||!this.rightAnchor&&!this.group.parent}destroy(){this.group.destroy()}setLeftAnchor(t){t!==this.leftAnchor&&(this.discardLines(),this.leftAnchor=t)}setRightAnchor(t){t!==this.rightAnchor&&(this.discardLines(),this.rightAnchor=t)}}function oA(s,t){if(t.isStart()){if(s.leftAnchor===t)return;s.leftAnchor&&th(s,s.leftAnchor),s.setLeftAnchor(t)}else if(t.isStop()){if(s.rightAnchor===t)return;s.rightAnchor&&th(s,s.rightAnchor),s.setRightAnchor(t)}else throw new Error(`Invalid anchor type: ${t.type}`);t.glissando=null}var OI=Object.defineProperty,BI=(s,t,e)=>t in s?OI(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,xu=(s,t,e)=>BI(s,typeof t!="symbol"?t+"":t,e);function II(s,t,e,r){const i=s.flatMap(FI,t);return new UI(e,r).match(i)}function FI(s,t,e){const r=[],i=this.valueOf();if(t===0){const f=s.tickableContent.getLeftGlissandoAnchor(i);f&&r.push(f)}const l=s.tickableContent.getMiddleGlissandoAnchors(i);if(r.push(...l),t===e.length-1){const f=s.tickableContent.getRightGlissandoAnchor(i);f&&r.push(f)}return r}class UI{constructor(t,e){xu(this,"glissandos",[]),xu(this,"tempAnchor",null),xu(this,"drawingContext"),xu(this,"staffData"),this.drawingContext=t,this.staffData=e}match(t){return t.forEach(this.processAnchor,this),this.glissandos}processAnchor(t){t.isStart()?(this.tempAnchor&&aA(this.tempAnchor),this.tempAnchor=t):t.isStop()&&(this.tempAnchor?(this.createGlissando(this.tempAnchor,t),this.tempAnchor=null):aA(t))}createGlissando(t,e){let r;t.glissando?r=t.glissando:e.glissando?r=e.glissando:r=new MI(this.drawingContext,this.staffData),oA(r,t),oA(r,e),this.glissandos.push(r)}}function aA(s){if(s.glissando){const t=s.glissando;th(t,s)}}var HI=Object.defineProperty,_I=(s,t,e)=>t in s?HI(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,eh=(s,t,e)=>_I(s,typeof t!="symbol"?t+"":t,e);const GI="staffVoiceGlissandos";class XI{constructor(t,e,r){eh(this,"group"),eh(this,"drawingContext"),eh(this,"staffData"),eh(this,"voiceIdx"),eh(this,"glissandos",[]),this.group=t.createGroupNode(),this.group.setLabel(GI),this.drawingContext=t,this.staffData=e,this.voiceIdx=r}updateFromMeasures(t){const e=II(t,this.voiceIdx,this.drawingContext,this.staffData);for(let r=this.glissandos.length-1;r>=0;r--){const i=this.glissandos[r];!e.includes(i)&&(this.glissandos.pop(),it(this.group,i.getChildRoot()),PI(i))}e.forEach(r=>{this.glissandos.includes(r)||(this.glissandos.push(r),v(this.group,r.getChildRoot()))})}formatHorizontal(){this.glissandos.forEach(t=>t.formatHorizontal())}getChildRoot(){return this.group}}function sh(s,t){if(t.isStart())s.setLeftAnchor(null);else if(t.isStop())s.setRightAnchor(null);else throw new Error(`Invalid anchor type: ${t.type}`);t.hammerOn=null,s.isOrphan()&&s.destroy()}function WI(s){if(s.isOrphan()){s.destroy();return}s.leftAnchor&&sh(s,s.leftAnchor),s.rightAnchor&&sh(s,s.rightAnchor)}var zI=Object.defineProperty,YI=(s,t,e)=>t in s?zI(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,rh=(s,t,e)=>YI(s,typeof t!="symbol"?t+"":t,e);const hA=1;class kI{constructor(t,e){rh(this,"curve"),rh(this,"rightY"),rh(this,"midY"),rh(this,"leftOffset"),rh(this,"rightOffset");let{rightY:r}=e;const i=t.getTieEndpointThickness(),a=t.getTieMidpointThickness();this.curve=t.createSlurQuadCurveNode(i,a),this.curve.setY(e.leftY),r-=e.leftY,this.rightY=r,this.midY=qI(r,e.placement),this.leftOffset=e.leftOffset,this.rightOffset=e.rightOffset}formatHorizontal(t,e){t+=this.leftOffset,e+=this.rightOffset,this.curve.setX(t),e-=t;const r=e/2;this.curve.setPoints({x:r,y:this.midY},{x:e,y:this.rightY})}getChildRoot(){return this.curve}}function qI(s,t){if(t===I.A.ABOVE)return Math.min(0,s)-hA;if(t===I.A.BELOW)return Math.max(0,s)+hA;throw I.A.raiseError(t)}var VI=Object.defineProperty,QI=(s,t,e)=>t in s?VI(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,bu=(s,t,e)=>QI(s,typeof t!="symbol"?t+"":t,e);function KI(s,t){return new JI(s,t).process()}class JI{constructor(t,e){bu(this,"leftNote"),bu(this,"rightNote"),bu(this,"lines"),bu(this,"hammerOns",new Map),this.leftNote=t,this.rightNote=e,this.lines=this.leftNote.getHammerOnPullOffStarts()}process(){return this.extractHammerOns(),this.fillPlacement(),Array.from(this.hammerOns.values())}extractHammerOns(){const t=this.rightNote.getHammerOnPullOffStops();if(this.lines.length!==t.length)throw new Error("HammerOn lines count mismatch");this.lines.forEach(e=>{this.hammerOns.set(e,{placement:I.A.ABOVE,line:e})})}isChord(){return this.lines.length>1}fillPlacement(){this.isChord()?this.fillChordPlacement():this.fillSingleNotePlacement()}fillSingleNotePlacement(){const t=this.getHammerOnData(this.lines[0]);t.line<=3?t.placement=I.A.ABOVE:t.placement=I.A.BELOW}fillChordPlacement(){const t=this.getHighestHammerOn(),e=this.getLowestHammerOn();t.placement=I.A.ABOVE,e.placement=I.A.BELOW,this.getInternalLines().forEach(i=>{const a=this.getHammerOnData(i);i>=3?a.placement=I.A.ABOVE:a.placement=I.A.BELOW})}getInternalLines(){return this.lines.slice(1,-1)}getHighestHammerOn(){const t=this.getHighestLine();return this.getHammerOnData(t)}getLowestHammerOn(){const t=this.getLowestLine();return this.getHammerOnData(t)}getHighestLine(){return this.lines[0]}getLowestLine(){return this.lines[this.lines.length-1]}getHammerOnData(t){const e=this.hammerOns.get(t);if(!e)throw new Error("HammerOn data not found");return e}}var $I=Object.defineProperty,ZI=(s,t,e)=>t in s?$I(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,mo=(s,t,e)=>ZI(s,typeof t!="symbol"?t+"":t,e);const jI="chordHammerOns";class tF{constructor(t,e){mo(this,"drawingContext"),mo(this,"staffData"),mo(this,"group"),mo(this,"leftAnchor",null),mo(this,"rightAnchor",null),mo(this,"arcs",null),this.drawingContext=t,this.staffData=e,this.group=t.createGroupNode(),this.group.setLabel(jI)}discardArcs(){this.arcs!==null&&(this.arcs.forEach(t=>{const e=t.getChildRoot();it(this.group,e),e.destroy()}),this.arcs=null)}getArcs(){return this.arcs===null&&(this.arcs=this.createArcs()),this.arcs}createArcs(){if(!this.leftAnchor||!this.rightAnchor)throw new Error("Cannot create hammerOn arcs without anchors");const t=this.leftAnchor.displayData,e=this.rightAnchor.displayData;return KI(t,e).map(this.createArc,this)}createArc(t){if(!this.leftAnchor||!this.rightAnchor)throw new Error("Cannot create hammerOn arcs without anchors");let e=0;this.leftAnchor.location&&(e=this.leftAnchor.location.note.getMiddleHeadWidth()/2);let r=0;this.rightAnchor.location&&(r=this.rightAnchor.location.note.getMiddleHeadWidth()/2);let i=0;const a=this.drawingContext.getTabSpaceSize(),l=this.drawingContext.getHammerOnVerticalMargin(),d=Le.A.stringToY(t.line,a);i=t.placement===I.A.ABOVE?d-l:d+l;const f=new kI(this.drawingContext,{leftY:i,rightY:i,placement:t.placement,leftOffset:e,rightOffset:r});return v(this.group,f.getChildRoot()),f}formatHorizontal(){const t=this.getLeftX(),e=this.getRightX();this.getArcs().forEach(i=>i.formatHorizontal(t,e))}getLeftX(){if(!this.leftAnchor)throw new Error("Cannot get left X without left anchor");if(this.leftAnchor.hasLocation())return this.leftAnchor.getPosition();if(!this.rightAnchor)throw new Error("Cannot get left X without right anchor");return this.rightAnchor.getOppositeEdgePosition()}getRightX(){if(!this.rightAnchor)throw new Error("Cannot get right X without right anchor");if(this.rightAnchor.hasLocation())return this.rightAnchor.getPosition();if(!this.leftAnchor)throw new Error("Cannot get right X without left anchor");return this.leftAnchor.getOppositeEdgePosition()}getChildRoot(){return this.group}isOrphan(){return!this.leftAnchor||!this.rightAnchor&&!this.group.parent}destroy(){this.group.destroy()}setLeftAnchor(t){t!==this.leftAnchor&&(this.discardArcs(),this.leftAnchor=t)}setRightAnchor(t){t!==this.rightAnchor&&(this.discardArcs(),this.rightAnchor=t)}}function lA(s,t){if(t.isStart()){if(s.leftAnchor===t)return;s.leftAnchor&&sh(s,s.leftAnchor),s.setLeftAnchor(t)}else if(t.isStop()){if(s.rightAnchor===t)return;s.rightAnchor&&sh(s,s.rightAnchor),s.setRightAnchor(t)}else throw new Error(`Invalid anchor type: ${t.type}`);t.hammerOn=null}var eF=Object.defineProperty,sF=(s,t,e)=>t in s?eF(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Pu=(s,t,e)=>sF(s,typeof t!="symbol"?t+"":t,e);function rF(s,t,e,r){const i=s.flatMap(iF,t);return new nF(e,r).match(i)}function iF(s,t,e){const r=[],i=this.valueOf();if(t===0){const f=s.tickableContent.getLeftHammerOnAnchor(i);f&&r.push(f)}const l=s.tickableContent.getMiddleHammerOnAnchors(i);if(r.push(...l),t===e.length-1){const f=s.tickableContent.getRightHammerOnAnchor(i);f&&r.push(f)}return r}class nF{constructor(t,e){Pu(this,"hammerOns",[]),Pu(this,"tempAnchor",null),Pu(this,"drawingContext"),Pu(this,"staffData"),this.drawingContext=t,this.staffData=e}match(t){return t.forEach(this.processAnchor,this),this.hammerOns}processAnchor(t){t.isStart()?(this.tempAnchor&&cA(this.tempAnchor),this.tempAnchor=t):t.isStop()&&(this.tempAnchor?(this.createHammerOn(this.tempAnchor,t),this.tempAnchor=null):cA(t))}createHammerOn(t,e){let r;t.hammerOn?r=t.hammerOn:e.hammerOn?r=e.hammerOn:r=new tF(this.drawingContext,this.staffData),lA(r,t),lA(r,e),this.hammerOns.push(r)}}function cA(s){if(s.hammerOn){const t=s.hammerOn;sh(t,s)}}var oF=Object.defineProperty,aF=(s,t,e)=>t in s?oF(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,ih=(s,t,e)=>aF(s,typeof t!="symbol"?t+"":t,e);const hF="staffVoiceHammerOns";class lF{constructor(t,e,r){ih(this,"group"),ih(this,"drawingContext"),ih(this,"staffData"),ih(this,"voiceIdx"),ih(this,"hammerOns",[]),this.group=t.createGroupNode(),this.group.setLabel(hF),this.drawingContext=t,this.staffData=e,this.voiceIdx=r}updateFromMeasures(t){const e=rF(t,this.voiceIdx,this.drawingContext,this.staffData);for(let r=this.hammerOns.length-1;r>=0;r--){const i=this.hammerOns[r];!e.includes(i)&&(this.hammerOns.pop(),it(this.group,i.getChildRoot()),WI(i))}e.forEach(r=>{this.hammerOns.includes(r)||(this.hammerOns.push(r),v(this.group,r.getChildRoot()))})}formatHorizontal(){this.hammerOns.forEach(t=>t.formatHorizontal())}getChildRoot(){return this.group}}function nh(s,t){if(t.isStart())s.setLeftAnchor(null);else if(t.isStop())s.setRightAnchor(null);else throw new Error(`Invalid anchor type: ${t.type}`);t.hyphen=null,s.isOrphan()&&s.destroy()}function cF(s){if(s.isOrphan()){s.destroy();return}s.leftAnchor&&nh(s,s.leftAnchor),s.rightAnchor&&nh(s,s.rightAnchor)}var uA=(s=>(s.LEFT="left",s.MIDDLE="middle",s.RIGHT="right",s))(uA||{});const yo=uA;var uF=Object.defineProperty,dF=(s,t,e)=>t in s?uF(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Lp=(s,t,e)=>dF(s,typeof t!="symbol"?t+"":t,e);const fF="-",dA=.5;class gF{constructor(t,e,r){Lp(this,"textNode"),Lp(this,"level"),Lp(this,"data");const i=t.getLyricsFontOptions();this.textNode=t.createTextNode(fF,i),this.level=e,this.data=r;const a=this.textNode.getLocalBBox(),l=this.level*i.fontSize-a.minY;this.textNode.setY(l)}formatHorizontal(t,e){if(this.data.type===yo.LEFT)e-=this.data.rightSpaceBefore,e-=this.textNode.getWidth(),e-=dA,this.textNode.setX(e);else if(this.data.type===yo.RIGHT)t+=this.data.leftSpaceAfter,t+=dA,this.textNode.setX(t);else if(this.data.type===yo.MIDDLE){t+=this.data.leftSpaceAfter,e-=this.data.rightSpaceBefore;const r=e-t,i=t+r/2-this.textNode.getWidth()/2;this.textNode.setX(i)}else{const r=this.data.type;throw new Error(`Invalid hyphen type: ${r}`)}}getChildRoot(){return this.textNode}}var pF=Object.defineProperty,mF=(s,t,e)=>t in s?pF(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ao=(s,t,e)=>mF(s,typeof t!="symbol"?t+"":t,e);const yF="chordHyphens";class AF{constructor(t,e){Ao(this,"drawingContext"),Ao(this,"staffData"),Ao(this,"group"),Ao(this,"leftAnchor",null),Ao(this,"rightAnchor",null),Ao(this,"lines",null),this.drawingContext=t,this.staffData=e,this.group=t.createGroupNode(),this.group.setLabel(yF)}discardLines(){this.lines!==null&&(this.lines.forEach(t=>{const e=t.getChildRoot();it(this.group,e),e.destroy()}),this.lines=null)}getLines(){return this.lines===null&&(this.lines=this.createLines()),this.lines}createLines(){const t=this.leftAnchor,e=this.rightAnchor;if(!t||!e)throw new Error("Cannot create hyphen lines without anchors");const r=t.connections,i=e.connections;if(r.length!==i.length)throw new Error("Left and right connections are of different lengths");return r.map((a,l)=>{const d=i[l];if(a.level!==d.level)throw new Error("Left and right connection have different levels");return{left:a,right:d}}).filter(({left:a,right:l})=>a.hasData||l.hasData).map(({left:a,right:l})=>{const d=vF(a,l,t.location,e.location),{level:f}=a,m=new gF(this.drawingContext,f,d);return v(this.group,m.getChildRoot()),m})}formatHorizontal(){const t=this.getLeftX(),e=this.getRightX();this.getLines().forEach(i=>i.formatHorizontal(t,e))}getLeftX(){if(!this.leftAnchor)throw new Error("Cannot get left X without left anchor");if(this.leftAnchor.hasLocation())return this.leftAnchor.getPosition();if(!this.rightAnchor)throw new Error("Cannot get left X without right anchor");return this.rightAnchor.getOppositeEdgePosition()}getRightX(){if(!this.rightAnchor)throw new Error("Cannot get right X without right anchor");if(this.rightAnchor.hasLocation())return this.rightAnchor.getPosition();if(!this.leftAnchor)throw new Error("Cannot get right X without left anchor");return this.leftAnchor.getOppositeEdgePosition()}getChildRoot(){return this.group}isOrphan(){return!this.leftAnchor||!this.rightAnchor&&!this.group.parent}destroy(){this.group.destroy()}setLeftAnchor(t){t!==this.leftAnchor&&(this.discardLines(),this.leftAnchor=t)}setRightAnchor(t){t!==this.rightAnchor&&(this.discardLines(),this.rightAnchor=t)}}function vF(s,t,e,r){const i=SF(s,e),a=wF(t,r);if(i!==null&&a!==null)return{type:yo.MIDDLE,leftSpaceAfter:i,rightSpaceBefore:a};if(i!==null&&a===null)return{type:yo.RIGHT,leftSpaceAfter:i};if(i===null&&a!==null)return{type:yo.LEFT,rightSpaceBefore:a};throw new Error("At least left or right should have a value")}function SF(s,t){const{level:e}=s;if(!s.hasData||t===null)return null;const r=t.lyrics.levelsMap.get(e);if(!r)return null;const i=r.getChildRoot().getBBox();if(i===null)throw new Error("Cannot get bbox for lyric line");return Math.max(i.maxX,0)}function wF(s,t){const{level:e}=s;if(!s.hasData||t===null)return null;const r=t.lyrics.levelsMap.get(e);if(!r)return null;const i=r.getChildRoot().getBBox();if(i===null)throw new Error("Cannot get bbox for lyric line");return Math.max(0,-i.minX)}function fA(s,t){if(t.isStart()){if(s.leftAnchor===t)return;s.leftAnchor&&nh(s,s.leftAnchor),s.setLeftAnchor(t)}else if(t.isStop()){if(s.rightAnchor===t)return;s.rightAnchor&&nh(s,s.rightAnchor),s.setRightAnchor(t)}else throw new Error(`Invalid anchor type: ${t.type}`);t.hyphen=null}var xF=Object.defineProperty,bF=(s,t,e)=>t in s?xF(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Eu=(s,t,e)=>bF(s,typeof t!="symbol"?t+"":t,e);function PF(s,t,e,r){const i=s.flatMap(EF,t);return new DF(e,r).match(i)}function EF(s,t,e){const r=[],i=this.valueOf();if(t===0){const f=s.tickableContent.getLeftHyphenAnchor(i);f&&r.push(f)}const l=s.tickableContent.getMiddleHyphenAnchors(i);if(r.push(...l),t===e.length-1){const f=s.tickableContent.getRightHyphenAnchor(i);f&&r.push(f)}return r}class DF{constructor(t,e){Eu(this,"hyphens",[]),Eu(this,"tempAnchor",null),Eu(this,"drawingContext"),Eu(this,"staffData"),this.drawingContext=t,this.staffData=e}match(t){return t.forEach(this.processAnchor,this),this.hyphens}processAnchor(t){t.isStart()?(this.tempAnchor&&Du(this.tempAnchor),this.tempAnchor=t):t.isStop()&&(this.tempAnchor?(this.createHyphen(this.tempAnchor,t),this.tempAnchor=null):Du(t))}createHyphen(t,e){if(!t.location&&!e.location){Du(t),Du(e);return}let r;t.hyphen?r=t.hyphen:e.hyphen?r=e.hyphen:r=new AF(this.drawingContext,this.staffData),fA(r,t),fA(r,e),this.hyphens.push(r)}}function Du(s){if(s.hyphen){const t=s.hyphen;nh(t,s)}}var CF=Object.defineProperty,TF=(s,t,e)=>t in s?CF(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,oh=(s,t,e)=>TF(s,typeof t!="symbol"?t+"":t,e);const RF="staffVoiceHyphens";class NF{constructor(t,e,r){oh(this,"group"),oh(this,"drawingContext"),oh(this,"staffData"),oh(this,"voiceIdx"),oh(this,"hyphens",[]),this.group=t.createGroupNode(),this.group.setLabel(RF),this.drawingContext=t,this.staffData=e,this.voiceIdx=r}getVoiceIdx(){return this.voiceIdx}updateFromMeasures(t){const e=PF(t,this.voiceIdx,this.drawingContext,this.staffData);for(let r=this.hyphens.length-1;r>=0;r--){const i=this.hyphens[r];!e.includes(i)&&(this.hyphens.pop(),it(this.group,i.getChildRoot()),cF(i))}e.forEach(r=>{this.hyphens.includes(r)||(this.hyphens.push(r),v(this.group,r.getChildRoot()))})}formatHorizontal(){this.hyphens.forEach(t=>t.formatHorizontal())}getChildRoot(){return this.group}}function ah(s,t){if(t.isStart())s.setLeftAnchor(null);else if(t.isStop())s.setRightAnchor(null);else throw new Error(`Invalid anchor type: ${t.type}`);t.melisma=null,s.isOrphan()&&s.destroy()}function LF(s){if(s.isOrphan()){s.destroy();return}s.leftAnchor&&ah(s,s.leftAnchor),s.rightAnchor&&ah(s,s.rightAnchor)}var MF=Object.defineProperty,OF=(s,t,e)=>t in s?MF(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,wn=(s,t,e)=>OF(s,typeof t!="symbol"?t+"":t,e);const BF="melismaLine";class IF{constructor(t,e,r){wn(this,"drawingContext"),wn(this,"staffData"),wn(this,"groupNode"),wn(this,"lineNode"),wn(this,"leftAnchor",null),wn(this,"rightAnchor",null),wn(this,"level"),this.drawingContext=t,this.staffData=e,this.groupNode=t.createGroupNode(),this.groupNode.setLabel(BF),this.lineNode=t.createLineNode(),v(this.groupNode,this.lineNode);const i=t.getLyricLineThickness();this.lineNode.setWidth(i),this.lineNode.setY2(0),this.level=r;const a=t.getLyricsFontOptions(),l=this.level*a.fontSize+a.fontSize*2/3;this.lineNode.setY(l)}formatHorizontal(){const t=this.getLeftX(),r=this.getRightX()-t;this.lineNode.setX(t),this.lineNode.setX2(r)}getLeftX(){if(!this.leftAnchor)throw new Error("Cannot get left X without left anchor");if(this.leftAnchor.location){const t=this.leftAnchor.getPosition(),e=this.leftAnchor.location.lyrics.levelsMap.get(this.leftAnchor.level);if(!e)throw new Error("Cannot get lyric line for left anchor");const r=e.getChildRoot().getBBox();if(!r)throw new Error("Cannot get bbox for lyric line");let i;return this.leftAnchor.isRealStart?i=Math.max(r.maxX,0):i=Math.max(-r.minX,0),t+i}if(!this.rightAnchor)throw new Error("Cannot get left X without right anchor");return this.rightAnchor.getOppositeEdgePosition()}getRightX(){if(!this.rightAnchor)throw new Error("Cannot get right X without right anchor");if(this.rightAnchor.location){const t=this.rightAnchor.getPosition(),e=this.rightAnchor.location.lyrics.levelsMap.get(this.rightAnchor.level);if(!e)throw new Error("Cannot get lyric line for right anchor");const r=e.getChildRoot().getBBox();if(!r)throw new Error("Cannot get bbox for lyric line");const i=r.maxX;return t+i}if(this.rightAnchor.hasLocation())return this.rightAnchor.getPosition();if(!this.leftAnchor)throw new Error("Cannot get right X without left anchor");return this.leftAnchor.getOppositeEdgePosition()}getChildRoot(){return this.groupNode}isOrphan(){return!this.leftAnchor||!this.rightAnchor&&!this.lineNode.parent}destroy(){this.groupNode.destroy()}setLeftAnchor(t){t!==this.leftAnchor&&(this.leftAnchor=t)}setRightAnchor(t){t!==this.rightAnchor&&(this.rightAnchor=t)}}function gA(s,t){if(t.isStart()){if(s.leftAnchor===t)return;s.leftAnchor&&ah(s,s.leftAnchor),s.setLeftAnchor(t)}else if(t.isStop()){if(s.rightAnchor===t)return;s.rightAnchor&&ah(s,s.rightAnchor),s.setRightAnchor(t)}else throw new Error(`Invalid anchor type: ${t.type}`);t.melisma=null}var FF=Object.defineProperty,UF=(s,t,e)=>t in s?FF(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Cu=(s,t,e)=>UF(s,typeof t!="symbol"?t+"":t,e);function HF(s,t,e,r){const i=[];return _F(s,t).forEach(l=>{const d={level:l,voiceIdx:t},f=s.flatMap(GF,d),S=new XF(e,r).match(f);i.push(...S)}),i}function _F(s,t){const e=new Set;return s.forEach(r=>{r.tickableContent.getVoiceAllMelismaLevels(t).forEach(a=>e.add(a))}),Array.from(e)}function GF(s,t,e){const r=[],{voiceIdx:i,level:a}=this;if(t===0){const m=s.tickableContent.getLeftMelismaAnchor(i,a);m&&r.push(m)}const d=s.tickableContent.getMiddleMelismaAnchors(i,a);if(r.push(...d),t===e.length-1){const m=s.tickableContent.getRightMelismaAnchor(i,a);m&&r.push(m)}return r}class XF{constructor(t,e){Cu(this,"melismas",[]),Cu(this,"tempAnchor",null),Cu(this,"drawingContext"),Cu(this,"staffData"),this.drawingContext=t,this.staffData=e}match(t){return t.forEach(this.processAnchor,this),this.melismas}processAnchor(t){t.isStart()?(this.tempAnchor&&Tu(this.tempAnchor),this.tempAnchor=t):t.isStop()&&(this.tempAnchor?(this.createMelisma(this.tempAnchor,t),this.tempAnchor=null):Tu(t))}createMelisma(t,e){if(!t.location&&!e.location){Tu(t),Tu(e);return}let r;if(t.melisma)r=t.melisma;else if(e.melisma)r=e.melisma;else{const i=t.level;r=new IF(this.drawingContext,this.staffData,i)}gA(r,t),gA(r,e),this.melismas.push(r)}}function Tu(s){if(s.melisma){const t=s.melisma;ah(t,s)}}var WF=Object.defineProperty,zF=(s,t,e)=>t in s?WF(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,hh=(s,t,e)=>zF(s,typeof t!="symbol"?t+"":t,e);const YF="staffVoiceMelismas";class kF{constructor(t,e,r){hh(this,"group"),hh(this,"drawingContext"),hh(this,"staffData"),hh(this,"voiceIdx"),hh(this,"melismas",[]),this.group=t.createGroupNode(),this.group.setLabel(YF),this.drawingContext=t,this.staffData=e,this.voiceIdx=r}getVoiceIdx(){return this.voiceIdx}updateFromMeasures(t){const e=HF(t,this.voiceIdx,this.drawingContext,this.staffData);for(let r=this.melismas.length-1;r>=0;r--){const i=this.melismas[r];!e.includes(i)&&(this.melismas.pop(),it(this.group,i.getChildRoot()),LF(i))}e.forEach(r=>{this.melismas.includes(r)||(this.melismas.push(r),v(this.group,r.getChildRoot()))})}formatHorizontal(){this.melismas.forEach(t=>t.formatHorizontal())}getChildRoot(){return this.group}}var qF=Object.defineProperty,VF=(s,t,e)=>t in s?qF(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,lh=(s,t,e)=>VF(s,typeof t!="symbol"?t+"":t,e);class QF{constructor(t){lh(this,"drawingContext"),lh(this,"anchors"),lh(this,"octaveShifts"),lh(this,"currentMeasureIdx",null),lh(this,"pendingOctaveShift",null),this.drawingContext=t,this.octaveShifts=[],this.anchors=[]}reset(){this.pendingOctaveShift=null,this.octaveShifts=[],this.anchors=[],this.currentMeasureIdx=null}parseMeasuresRangeNotations(t){return this.reset(),t.forEach(this.parseMeasuresRangeNotationAnchors,this),this.createOctaveShifts(),this.octaveShifts.forEach(e=>e.fillEventPayload()),this.octaveShifts}parseMeasuresRangeNotationAnchors(t,e,r){this.currentMeasureIdx=e;const i=e===0,a=e===r.length-1;t.hasLeftOctaveShiftAnchor()&&this.updateLeftAnchor(t.getLeftOctaveShiftAnchor(),i);const l=t.getMiddleOctaveShiftsAnchors();this.addAnchors(l),t.hasRightOctaveShiftAnchor()&&this.updateRightAnchor(t.getRightOctaveShiftAnchor(),a)}updateLeftAnchor(t,e){e?this.addAnchor(t):t.hasOctaveShift()&&t.getOctaveShift().erase()}updateRightAnchor(t,e){e?this.addAnchor(t):t.hasOctaveShift()&&t.getOctaveShift().erase()}addAnchors(t){t.forEach(this.addAnchor,this)}addAnchor(t){this.anchors.push(t)}createOctaveShifts(){this.anchors.forEach(this.useAnchor,this),this.hasPendingOctaveShift()&&this.discardPendingOctaveShift()}useAnchor(t){if(t.isLeft())this.openPendingOctaveShift(t);else if(t.isRight())this.closePending(t);else throw new Error("Unexpected")}openPendingOctaveShift(t){this.hasPendingOctaveShift()&&this.discardPendingOctaveShift();let e;t.hasOctaveShift()?e=t.getOctaveShift():(e=new jp(this.drawingContext,{placement:t.placement,size:t.size}),e.setLeftAnchor(t)),this.pendingOctaveShift=e}discardPendingOctaveShift(){this.hasPendingOctaveShift()&&(this.pendingOctaveShift.erase(),this.pendingOctaveShift=null)}closePending(t){if(this.hasPendingOctaveShift()){this.removeOctaveShiftIfDifferentFromPending(t);const e=this.getPendingOctaveShift();t.hasOctaveShift()||e.setRightAnchor(t),this.octaveShifts.push(e),this.pendingOctaveShift=null}else t.hasOctaveShift()&&t.removeOctaveShift()}removeOctaveShiftIfDifferentFromPending(t){if(t.hasOctaveShift()){const e=t.getOctaveShift(),r=this.getPendingOctaveShift();e!==r&&t.removeOctaveShift()}}hasPendingOctaveShift(){return this.pendingOctaveShift!==null}getPendingOctaveShift(){return this.pendingOctaveShift}}var KF=Object.defineProperty,JF=(s,t,e)=>t in s?KF(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,ch=(s,t,e)=>JF(s,typeof t!="symbol"?t+"":t,e);class $F{constructor(t){ch(this,"drawingContext"),ch(this,"anchors"),ch(this,"pedals"),ch(this,"currentMeasureIdx",null),ch(this,"pendingPedal",null),this.drawingContext=t,this.pedals=[],this.anchors=[]}reset(){this.pendingPedal=null,this.pedals=[],this.anchors=[],this.currentMeasureIdx=null}parseMeasuresRangeNotations(t){return this.reset(),t.forEach(this.parseMeasuresRangeNotationAnchors,this),this.createPedals(),this.pedals.forEach(e=>e.fillEventPayload()),this.pedals}parseMeasuresRangeNotationAnchors(t,e,r){this.currentMeasureIdx=e;const i=e===0,a=e===r.length-1;t.hasLeftPedalAnchor()&&this.updateLeftAnchor(t.getLeftPedalAnchor(),i);const l=t.getMiddlePedalsAnchors();this.addAnchors(l),t.hasRightPedalAnchor()&&this.updateRightAnchor(t.getRightPedalAnchor(),a)}updateLeftAnchor(t,e){e?this.addAnchor(t):t.hasPedal()&&t.getPedal().erase()}updateRightAnchor(t,e){e?this.addAnchor(t):t.hasPedal()&&t.getPedal().erase()}addAnchors(t){t.forEach(this.addAnchor,this)}addAnchor(t){this.anchors.push(t)}createPedals(){this.anchors.forEach(this.useAnchor,this),this.hasPendingPedal()&&this.discardPendingPedal()}useAnchor(t){if(t.isLeft())this.openPendingPedal(t);else if(t.isRight())this.closePending(t);else throw new Error("Unexpected")}openPendingPedal(t){this.hasPendingPedal()&&this.discardPendingPedal();let e;t.hasPedal()?e=t.getPedal():(e=new tm(this.drawingContext),e.setLeftAnchor(t)),this.pendingPedal=e}discardPendingPedal(){this.hasPendingPedal()&&(this.pendingPedal.erase(),this.pendingPedal=null)}closePending(t){if(this.hasPendingPedal()){this.removePedalIfDifferentFromPending(t);const e=this.getPendingPedal();t.hasPedal()||e.setRightAnchor(t),this.pedals.push(e),this.pendingPedal=null}else t.hasPedal()&&t.removePedal()}removePedalIfDifferentFromPending(t){if(t.hasPedal()){const e=t.getPedal(),r=this.getPendingPedal();e!==r&&t.removePedal()}}hasPendingPedal(){return this.pendingPedal!==null}getPendingPedal(){return this.pendingPedal}}var ZF=Object.defineProperty,jF=(s,t,e)=>t in s?ZF(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,uh=(s,t,e)=>jF(s,typeof t!="symbol"?t+"":t,e);class tU{constructor(t){uh(this,"drawingContext"),uh(this,"anchors"),uh(this,"pluckedRanges"),uh(this,"currentMeasureIdx",null),uh(this,"pendingPluckedRange",null),this.drawingContext=t,this.pluckedRanges=[],this.anchors=[]}reset(){this.pendingPluckedRange=null,this.pluckedRanges=[],this.anchors=[],this.currentMeasureIdx=null}parseMeasuresRangeNotations(t){return this.reset(),t.forEach(this.parseMeasuresRangeNotationAnchors,this),this.createPluckedRanges(),this.pluckedRanges.forEach(e=>e.fillEventPayload()),this.pluckedRanges}parseMeasuresRangeNotationAnchors(t,e,r){this.currentMeasureIdx=e;const i=e===0,a=e===r.length-1;t.hasLeftPluckedRangeAnchor()&&this.updateLeftAnchor(t.getLeftPluckedRangeAnchor(),i);const l=t.getMiddlePluckedRangesAnchors();this.addAnchors(l),t.hasRightPluckedRangeAnchor()&&this.updateRightAnchor(t.getRightPluckedRangeAnchor(),a)}updateLeftAnchor(t,e){e?this.addAnchor(t):t.hasPluckedRange()&&t.getPluckedRange().erase()}updateRightAnchor(t,e){e?this.addAnchor(t):t.hasPluckedRange()&&t.getPluckedRange().erase()}addAnchors(t){t.forEach(this.addAnchor,this)}addAnchor(t){this.anchors.push(t)}createPluckedRanges(){this.anchors.forEach(this.useAnchor,this),this.hasPendingPluckedRange()&&this.discardPendingPluckedRange()}useAnchor(t){if(t.isLeft())this.openPendingPluckedRange(t);else if(t.isRight())this.closePending(t);else throw new Error("Unexpected")}openPendingPluckedRange(t){this.hasPendingPluckedRange()&&this.discardPendingPluckedRange();let e;t.hasPluckedRange()?e=t.getPluckedRange():(e=new sm(this.drawingContext,t.type),e.setLeftAnchor(t)),this.pendingPluckedRange=e}discardPendingPluckedRange(){this.hasPendingPluckedRange()&&(this.pendingPluckedRange.erase(),this.pendingPluckedRange=null)}closePending(t){if(this.hasPendingPluckedRange()){this.removePluckedRangeIfDifferentFromPending(t);const e=this.getPendingPluckedRange();t.hasPluckedRange()||e.setRightAnchor(t),this.pluckedRanges.push(e),this.pendingPluckedRange=null}else t.hasPluckedRange()&&t.removePluckedRange()}removePluckedRangeIfDifferentFromPending(t){if(t.hasPluckedRange()){const e=t.getPluckedRange(),r=this.getPendingPluckedRange();e!==r&&t.removePluckedRange()}}hasPendingPluckedRange(){return this.pendingPluckedRange!==null}getPendingPluckedRange(){return this.pendingPluckedRange}}function dh(s,t){if(t.isStart())s.setLeftAnchor(null);else if(t.isStop())s.setRightAnchor(null);else throw new Error(`Invalid anchor type: ${t.type}`);t.slide=null,s.isOrphan()&&s.destroy()}function eU(s){if(s.isOrphan()){s.destroy();return}s.leftAnchor&&dh(s,s.leftAnchor),s.rightAnchor&&dh(s,s.rightAnchor)}var sU=Object.defineProperty,rU=(s,t,e)=>t in s?sU(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ru=(s,t,e)=>rU(s,typeof t!="symbol"?t+"":t,e);class iU{constructor(t,e){Ru(this,"line"),Ru(this,"rightY"),Ru(this,"leftOffset"),Ru(this,"rightOffset");let{rightY:r}=e;this.line=t.createLineNode(),this.line.setWidth(t.getHairpinThickness()),this.line.setY(e.leftY),r-=e.leftY,this.rightY=r,this.line.setY2(this.rightY),this.leftOffset=e.leftOffset,this.rightOffset=e.rightOffset}formatHorizontal(t,e){t+=this.leftOffset,e+=this.rightOffset,this.line.setX(t),this.line.setX2(e-t)}getChildRoot(){return this.line}}function nU(s,t){const e=new Map,r=s.getSlideStarts().map(a=>({line:a.line,string:a.string})),i=t.getSlideStops().map(a=>({line:a.line,string:a.string}));if(r.length!==i.length)throw new Error("Slide lines count mismatch");return r.forEach((a,l)=>{const d=i[l].line,f=i[l].string;e.set(a.line,{isExternal:!1,line:a.line,rightLine:d,string:a.string,rightString:f})}),Array.from(e.values())}var oU=Object.defineProperty,aU=(s,t,e)=>t in s?oU(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,vo=(s,t,e)=>aU(s,typeof t!="symbol"?t+"":t,e);const hU="chordSlides";class lU{constructor(t,e){vo(this,"drawingContext"),vo(this,"staffData"),vo(this,"group"),vo(this,"leftAnchor",null),vo(this,"rightAnchor",null),vo(this,"lines",null),this.drawingContext=t,this.staffData=e,this.group=t.createGroupNode(),this.group.setLabel(hU)}discardLines(){this.lines!==null&&(this.lines.forEach(t=>{const e=t.getChildRoot();it(this.group,e),e.destroy()}),this.lines=null)}getLines(){return this.lines===null&&(this.lines=this.createLines()),this.lines}createLines(){if(!this.leftAnchor||!this.rightAnchor)throw new Error("Cannot create slide lines without anchors");const t=this.leftAnchor.displayData,e=this.rightAnchor.displayData;let r=nU(t,e);return this.isGuitarTab()&&(r=r.filter(i=>i.string===i.rightString)),r.map(this.createLine,this)}createLine(t){if(!this.leftAnchor||!this.rightAnchor)throw new Error("Cannot create slide lines without anchors");let e=0;this.leftAnchor.location&&(e=this.leftAnchor.location.note.getMiddleHeadWidth());let r=0;this.rightAnchor.location&&(r=0);let i=0,a=0;if(this.isGuitarTab()){const d=this.drawingContext.getTabSpaceSize(),f=this.drawingContext.getTabSlideYOffset(),m=Le.A.stringToY(t.string,d),S=t.line-t.rightLine;i=S>0?m-f:m+f,a=S>0?m+f:m-f}else i=(0,Ft.$n)(t.line,this.staffData),a=(0,Ft.$n)(t.rightLine,this.staffData);const l=new iU(this.drawingContext,{leftY:i,rightY:a,leftOffset:e,rightOffset:r});return v(this.group,l.getChildRoot()),l}formatHorizontal(){const t=this.getLeftX()+this.drawingContext.getGlissandoHorizontalMargin(),e=this.getRightX()-this.drawingContext.getGlissandoHorizontalMargin();this.getLines().forEach(i=>{i.formatHorizontal(t,e)})}getLeftX(){if(!this.leftAnchor)throw new Error("Cannot get left X without left anchor");if(this.leftAnchor.hasLocation())return this.leftAnchor.getPosition();if(!this.rightAnchor)throw new Error("Cannot get left X without right anchor");return this.rightAnchor.getOppositeEdgePosition()}getRightX(){if(!this.rightAnchor)throw new Error("Cannot get right X without right anchor");if(this.rightAnchor.hasLocation())return this.rightAnchor.getPosition();if(!this.leftAnchor)throw new Error("Cannot get right X without left anchor");return this.leftAnchor.getOppositeEdgePosition()}getChildRoot(){return this.group}isOrphan(){return!this.leftAnchor||!this.rightAnchor&&!this.group.parent}destroy(){this.group.destroy()}setLeftAnchor(t){t!==this.leftAnchor&&(this.discardLines(),this.leftAnchor=t)}setRightAnchor(t){t!==this.rightAnchor&&(this.discardLines(),this.rightAnchor=t)}isGuitarTab(){return this.staffData.type===Zt.A.GUITAR_TAB}}function pA(s,t){if(t.isStart()){if(s.leftAnchor===t)return;s.leftAnchor&&dh(s,s.leftAnchor),s.setLeftAnchor(t)}else if(t.isStop()){if(s.rightAnchor===t)return;s.rightAnchor&&dh(s,s.rightAnchor),s.setRightAnchor(t)}else throw new Error(`Invalid anchor type: ${t.type}`);t.slide=null}var cU=Object.defineProperty,uU=(s,t,e)=>t in s?cU(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Nu=(s,t,e)=>uU(s,typeof t!="symbol"?t+"":t,e);function dU(s,t,e,r){const i=s.flatMap(fU,t);return new gU(e,r).match(i)}function fU(s,t,e){const r=[],i=this.valueOf();if(t===0){const f=s.tickableContent.getLeftSlideAnchor(i);f&&r.push(f)}const l=s.tickableContent.getMiddleSlideAnchors(i);if(r.push(...l),t===e.length-1){const f=s.tickableContent.getRightSlideAnchor(i);f&&r.push(f)}return r}class gU{constructor(t,e){Nu(this,"slides",[]),Nu(this,"tempAnchor",null),Nu(this,"drawingContext"),Nu(this,"staffData"),this.drawingContext=t,this.staffData=e}match(t){return t.forEach(this.processAnchor,this),this.slides}processAnchor(t){t.isStart()?(this.tempAnchor&&mA(this.tempAnchor),this.tempAnchor=t):t.isStop()&&(this.tempAnchor?(this.createSlide(this.tempAnchor,t),this.tempAnchor=null):mA(t))}createSlide(t,e){let r;t.slide?r=t.slide:e.slide?r=e.slide:r=new lU(this.drawingContext,this.staffData),pA(r,t),pA(r,e),this.slides.push(r)}}function mA(s){if(s.slide){const t=s.slide;dh(t,s)}}var pU=Object.defineProperty,mU=(s,t,e)=>t in s?pU(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,fh=(s,t,e)=>mU(s,typeof t!="symbol"?t+"":t,e);const yU="staffVoiceSlides";class AU{constructor(t,e,r){fh(this,"group"),fh(this,"drawingContext"),fh(this,"staffData"),fh(this,"voiceIdx"),fh(this,"slides",[]),this.group=t.createGroupNode(),this.group.setLabel(yU),this.drawingContext=t,this.staffData=e,this.voiceIdx=r}updateFromMeasures(t){const e=dU(t,this.voiceIdx,this.drawingContext,this.staffData);for(let r=this.slides.length-1;r>=0;r--){const i=this.slides[r];!e.includes(i)&&(this.slides.pop(),it(this.group,i.getChildRoot()),eU(i))}e.forEach(r=>{this.slides.includes(r)||(this.slides.push(r),v(this.group,r.getChildRoot()))})}formatHorizontal(){this.slides.forEach(t=>t.formatHorizontal())}getChildRoot(){return this.group}}function gh(s,t){if(t.isStart())s.setLeftAnchor(null);else if(t.isStop())s.setRightAnchor(null);else throw new Error("Unexpected");t.slur=null,s.isOrphan()&&s.destroy()}function vU(s){if(s.isOrphan()){s.destroy();return}s.leftAnchor&&gh(s,s.leftAnchor),s.rightAnchor&&gh(s,s.rightAnchor)}function yA(s,t){if(t.isStart()){if(s.leftAnchor===t)return;s.leftAnchor&&gh(s,s.leftAnchor),s.setLeftAnchor(t)}else if(t.isStop()){if(s.rightAnchor===t)return;s.rightAnchor&&gh(s,s.rightAnchor),s.setRightAnchor(t)}else throw new Error("Unexpected");t.slur=null}var SU=Object.defineProperty,wU=(s,t,e)=>t in s?SU(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Lu=(s,t,e)=>wU(s,typeof t!="symbol"?t+"":t,e);function xU(s,t,e,r){const i=s.flatMap(bU,t);return new PU(e,r).match(i)}function bU(s,t,e){const r=[],i=this.valueOf();if(t===0){const f=s.tickableContent.getLeftSlurAnchor(i);f&&r.push(f)}const l=s.tickableContent.getMiddleSlurAnchors(i);if(r.push(...l),t===e.length-1){const f=s.tickableContent.getRightSlurAnchor(i);f&&r.push(f)}return r}class PU{constructor(t,e){Lu(this,"slurs",[]),Lu(this,"tempAnchor",null),Lu(this,"drawingContext"),Lu(this,"staffData"),this.drawingContext=t,this.staffData=e}match(t){return t.forEach(this.processAnchor,this),this.slurs}processAnchor(t){t.isStart()?(this.tempAnchor&&AA(this.tempAnchor),this.tempAnchor=t):t.isStop()&&(this.tempAnchor?(this.createSlur(this.tempAnchor,t),this.tempAnchor=null):AA(t))}createSlur(t,e){let r;t.slur?r=t.slur:e.slur?r=e.slur:r=new am(this.drawingContext,this.staffData),yA(r,t),yA(r,e),this.slurs.push(r)}}function AA(s){if(s.slur){const t=s.slur;gh(t,s)}}var EU=Object.defineProperty,DU=(s,t,e)=>t in s?EU(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,ph=(s,t,e)=>DU(s,typeof t!="symbol"?t+"":t,e);const CU="staffVoiceSlurs";class TU{constructor(t,e,r){ph(this,"group"),ph(this,"drawingContext"),ph(this,"staffData"),ph(this,"voiceIdx"),ph(this,"slurs",[]),this.group=t.createGroupNode(),this.group.setLabel(CU),this.drawingContext=t,this.staffData=e,this.voiceIdx=r}updateFromMeasures(t){const e=xU(t,this.voiceIdx,this.drawingContext,this.staffData);for(let r=this.slurs.length-1;r>=0;r--){const i=this.slurs[r];!e.includes(i)&&(this.slurs.pop(),it(this.group,i.getChildRoot()),vU(i))}e.forEach(r=>{this.slurs.includes(r)||(this.slurs.push(r),v(this.group,r.getChildRoot()))})}formatHorizontal(){this.slurs.forEach(t=>t.formatHorizontal())}getChildRoot(){return this.group}}var RU=Object.defineProperty,NU=(s,t,e)=>t in s?RU(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,vA=(s,t,e)=>NU(s,typeof t!="symbol"?t+"":t,e);class Gr{constructor(){vA(this,"_heights",[{position:0,height:0}]),vA(this,"_maxHeight",0)}clone(){const t=new Gr;return t._heights=structuredClone(this._heights),t._maxHeight=this._maxHeight,t}addHeight({position:t,width:e,height:r}){this._maxHeight=Math.max(this._maxHeight,r);let i=this.getPreviousEntryIdx(t),a=this.getFormerHeightForPosition(t,i);for(;i<this._heights.length;i++){const l=this._heights[i],d=l.height;if(l.position<t)r>l.height&&(i++,this._heights.splice(i,0,{position:t,height:r}));else if(l.position===t)r>l.height&&(r===a?(this._heights.splice(i,1),i--):l.height=r);else if(l.position<t+e)r===l.height?a<=r&&(this._heights.splice(i,1),i--):r>l.height&&(a>r?this._heights[i].height=r:(this._heights.splice(i,1),i--));else if(l.position===t+e){r===l.height&&r>=a&&this._heights.splice(i,1);return}else if(l.position>t+e){a<r&&this._heights.splice(i,0,{position:t+e,height:a});return}else throw new Error("Unexpected case");a=d}a!==r&&this._heights.push({position:t+e,height:a})}getPreviousEntryIdx(t){const e=this._heights.findIndex(r=>t<r.position);return e===-1?this._heights.length-1:e-1}getFormerHeightForPosition(t,e){return e>0&&this._heights[e].position===t&&e--,this._heights[e].height}getMaxHeightInRange(t,e){const r=t+e;let i=this.getPreviousEntryIdx(t),a=0;for(;i<this._heights.length;i++){const l=this._heights[i];if(l.position>=r)return a;a=Math.max(a,l.height)}return a}getHeights(){return this._heights}dumpInserts(){const t=[];for(let e=0;e<this._heights.length-1;e++){const r=this._heights[e],i=this._heights[e+1];t.push({position:r.position,width:i.position-r.position,height:r.height})}return t}getShapePoints(){const t=[];let e=0;for(let i=0;i<this._heights.length;i++){const a=this._heights[i];i>0?t.push({x:a.position,y:e}):a.height!==0&&t.push({x:a.position,y:0}),t.push({x:a.position,y:a.height}),e=a.height}if(t[t.length-1].y!==0){const i=this._heights[this._heights.length-1];t.push({x:i.position,y:0})}return t}getMaxHeight(){return this._maxHeight}}function LU(s,t,e,r,i){const a=[...MU(t),...BU(s)];Ye(a,r,e,!0);const l=[...OU(t),...IU(s)],d=(0,Ft.o5)(t[0].staffData);gs(l,i,d,e,!0)}function MU(s){return s.flatMap(t=>SA(t,t.tickableContent.dynamicsAbove))}function OU(s){return s.flatMap(t=>SA(t,t.tickableContent.dynamicsBelow))}function SA(s,t){return t.map(e=>({entity:e,xPosition:s.group.getX()+s.tickableContent.groupNode.getX()+e.getChildRoot().getX(),yPosition:null}))}function BU(s){return wA(s.filter(t=>t.isAbove()))}function IU(s){return wA(s.filter(t=>t.isBelow()))}function wA(s){return s.map(t=>({entity:t,xPosition:t.getChildRoot().getX(),yPosition:null}))}function FU(s,t,e){const r=UU(s),i=(0,Ft.o5)(s[0].staffData);gs(r,e,i,t,!0)}function UU(s){return s.flatMap(t=>t.tickableContent.figuredBasses.map(e=>({entity:e,xPosition:t.group.getX()+t.tickableContent.groupNode.getX()+e.getChildRoot().getX(),yPosition:null})))}function HU(s,t,e){const r=_U(s);Ye(r,e,t,!0)}function _U(s){return s.flatMap(t=>t.tickableContent.jazzHarmonies.map(e=>({entity:e,xPosition:t.group.getX()+t.tickableContent.groupNode.getX()+e.getChildRoot().getX(),yPosition:null})))}function GU(s,t,e,r,i,a){const l=(0,Ft.o5)(s[0].staffData);e.forEach(d=>{const f=[...XU(s,d),...zU(i,d),...YU(a,d)];gs(f,r,l,t,!0)})}function XU(s,t){return s.flatMap(e=>{const r=e.tickableContent.getVoicesLyrics(t);return WU(e,r)})}function WU(s,t){return t.map(e=>({entity:e,xPosition:s.group.getX()+s.tickableContent.groupNode.getX()+e.getChildRoot().getX(),yPosition:null}))}function zU(s,t){const e=s.find(r=>r.getVoiceIdx()===t);return e?e.hyphens.map(r=>({entity:r,xPosition:r.getChildRoot().getX(),yPosition:null})):[]}function YU(s,t){const e=s.find(r=>r.getVoiceIdx()===t);return e?e.melismas.map(r=>({entity:r,xPosition:r.getChildRoot().getX(),yPosition:null})):[]}function kU(s,t,e,r){const i=qU(s);Ye(i,e,t,!1);const a=VU(s),l=(0,Ft.o5)(s[0].staffData);gs(a,r,l,t,!1)}function qU(s){return s.flatMap(t=>xA(t,t.tickableContent.mutesAbove))}function VU(s){return s.flatMap(t=>xA(t,t.tickableContent.mutesBelow))}function xA(s,t){return t.map(e=>({entity:e,xPosition:s.group.getX()+s.tickableContent.groupNode.getX()+e.getChildRoot().getX(),yPosition:null}))}function QU(s,t,e,r,i){const a=KU(s);Ye(a,e,t,!1);const l=JU(s);gs(l,r,i,t,!1)}function KU(s){const t=s.filter(e=>e.isAbove());return bA(t)}function JU(s){const t=s.filter(e=>e.isBelow());return bA(t)}function bA(s){return s.map(t=>({entity:t,xPosition:t.getChildRoot().getX(),yPosition:null}))}function $U(s,t,e,r){const i=ZU(s);gs(i,e,r,t,!1)}function ZU(s){return s.map(t=>({entity:t,xPosition:t.getChildRoot().getX(),yPosition:null}))}function jU(s,t,e,r){const i=tH(s);Ye(i,e,t,!1);const a=eH(s),l=(0,Ft.o5)(s[0].staffData);gs(a,r,l,t,!1)}function tH(s){return s.flatMap(t=>PA(t,t.tickableContent.pizzicatosAbove))}function eH(s){return s.flatMap(t=>PA(t,t.tickableContent.pizzicatosBelow))}function PA(s,t){return t.map(e=>({entity:e,xPosition:s.group.getX()+s.tickableContent.groupNode.getX()+e.getChildRoot().getX(),yPosition:null}))}function sH(s,t,e,r,i){const a=rH(s);Ye(a,e,t,!0);const l=iH(s);gs(l,r,i,t,!0)}function rH(s){return s.filter(t=>t.isAbove()).map(t=>({entity:t,xPosition:t.getChildRoot().getX(),yPosition:null}))}function iH(s){return s.filter(t=>t.isBelow()).map(t=>({entity:t,xPosition:t.getChildRoot().getX(),yPosition:null}))}function nH(s,t,e){const r=oH(s),i=(0,Ft.o5)(s[0].staffData);gs(r,e,i,t,!0)}function oH(s){return s.flatMap(t=>t.tickableContent.romanNumerals.map(e=>({entity:e,xPosition:t.group.getX()+t.tickableContent.groupNode.getX()+e.getChildRoot().getX(),yPosition:null})))}function aH(s,t,e,r){const i=(0,Ft.o5)(t[0].staffData),a=s.flatMap(l=>l.slurs);Sm(a,e,r,i)}function hH(s,t,e,r){const i=lH(s);Ye(i,e,t,!1);const a=cH(s),l=(0,Ft.o5)(s[0].staffData);gs(a,r,l,t,!1)}function lH(s){return s.flatMap(t=>EA(t,t.tickableContent.textAnnotationsAbove))}function cH(s){return s.flatMap(t=>EA(t,t.tickableContent.textAnnotationsBelow))}function EA(s,t){return t.map(e=>({entity:e,xPosition:s.group.getX()+s.tickableContent.groupNode.getX()+e.getChildRoot().getX(),yPosition:null}))}function uH(s,t,e,r){const i=dH(s);Ye(i,e,t,!1,!0);const a=fH(s),l=(0,Ft.o5)(s[0].staffData);gs(a,r,l,t,!1,!0)}function dH(s){return s.flatMap(t=>DA(t,t.tickableContent.getTupletsAbove()))}function fH(s){return s.flatMap(t=>DA(t,t.tickableContent.getTupletsBelow()))}function DA(s,t){return t.map(e=>({entity:e,xPosition:s.group.getX()+s.tickableContent.groupNode.getX()+e.getChildRoot().getX(),yPosition:null}))}function gH(s,t){const e=[],r=[];return s.forEach(({position:i,width:a,height:l})=>{if(i<0)throw new Error("Unexpected negative position");const d=-l;d>0&&e.push({position:i,width:a,height:d});const f=l-t;f>0&&r.push({position:i,width:a,height:f})}),{topHeights:e,bottomHeights:r}}function mh(s,t){if(t.isStart())s.setLeftAnchor(null);else if(t.isStop())s.setRightAnchor(null);else throw new Error(`Invalid anchor type: ${t.type}`);t.tie=null,s.isOrphan()&&s.destroy()}function pH(s){if(s.isOrphan()){s.destroy();return}s.leftAnchor&&mh(s,s.leftAnchor),s.rightAnchor&&mh(s,s.rightAnchor)}var mH=Object.defineProperty,yH=(s,t,e)=>t in s?mH(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,yh=(s,t,e)=>yH(s,typeof t!="symbol"?t+"":t,e);const CA=1;class AH{constructor(t,e){yh(this,"curve"),yh(this,"rightY"),yh(this,"midY"),yh(this,"leftOffset"),yh(this,"rightOffset");let{rightY:r}=e;const i=t.getTieEndpointThickness(),a=t.getTieMidpointThickness();this.curve=t.createSlurQuadCurveNode(i,a),this.curve.setY(e.leftY),r-=e.leftY,this.rightY=r,this.midY=vH(r,e.placement),this.leftOffset=e.leftOffset,this.rightOffset=e.rightOffset}formatHorizontal(t,e){t+=this.leftOffset,e+=this.rightOffset,this.curve.setX(t),e-=t;const r=e/2;this.curve.setPoints({x:r,y:this.midY},{x:e,y:this.rightY})}getChildRoot(){return this.curve}}function vH(s,t){if(t===I.A.ABOVE)return Math.min(0,s)-CA;if(t===I.A.BELOW)return Math.max(0,s)+CA;throw I.A.raiseError(t)}var SH=b(760367),wH=Object.defineProperty,xH=(s,t,e)=>t in s?wH(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Mu=(s,t,e)=>xH(s,typeof t!="symbol"?t+"":t,e);function bH(s,t){return new PH(s,t).process()}class PH{constructor(t,e){Mu(this,"leftNote"),Mu(this,"rightNote"),Mu(this,"lines"),Mu(this,"ties",new Map),this.leftNote=t,this.rightNote=e,this.lines=this.leftNote.getTieStarts()}process(){return this.extractTies(),this.fillPlacement(),this.fillAllExternals(),this.fillLeftTieColliding(),this.fillRightTieColliding(),this.fillLeftSideShift(),this.fillRightSideShift(),Array.from(this.ties.values())}extractTies(){const t=this.rightNote.getTieStops();if(this.lines.length!==t.length)throw new Error("Tie lines count mismatch");this.lines.forEach((e,r)=>{const i=t[r];this.ties.set(e,{isExternal:!1,placement:I.A.BELOW,line:e,rightLine:i,leftSide:{stemColliding:!1,shiftRight:!1,shiftLeft:!1},rightSide:{stemColliding:!1,shiftRight:!1,shiftLeft:!1}})})}fillPlacement(){this.isChord()?this.fillChordPlacement():this.fillSingleNotePlacement(),this.leftNote.getTieStartsDirections().forEach((e,r)=>{const i=this.lines[r],a=this.getTieData(i);e===SH.A.FLIPPED&&(a.placement=EH(a.placement))})}isChord(){return this.lines.length>1}fillSingleNotePlacement(){const t=this.getTieData(this.lines[0]),e=this.leftNote.getStemStrategy();e===zt.A.UP?t.placement=I.A.ABOVE:e===zt.A.DOWN||e===zt.A.UP_UNPITCHED?t.placement=I.A.BELOW:e===zt.A.DOWN_UNPITCHED?t.placement=I.A.ABOVE:this.hasSameStemDirection()?this.leftNote.getStemValue()===z.A.UP?t.placement=I.A.BELOW:t.placement=I.A.ABOVE:t.line>=3?t.placement=I.A.ABOVE:t.placement=I.A.BELOW}hasSameStemDirection(){return this.leftNote.getStemValue()===this.rightNote.getStemValue()}fillChordPlacement(){const t=this.getHighestTie(),e=this.getLowestTie();t.placement=I.A.ABOVE,e.placement=I.A.BELOW,this.getInternalLines().forEach(i=>{const a=this.getTieData(i);i>=3?a.placement=I.A.ABOVE:a.placement=I.A.BELOW})}fillAllExternals(){const t=this.getHighestLine();if(this.fillExternal(t),this.isChord()){const e=this.getLowestLine();this.fillExternal(e)}}fillExternal(t){const e=this.getTieData(t),r=e.placement,i=TA(this.leftNote,t,r),a=TA(this.rightNote,t,r);e.isExternal=i&&a}fillLeftTieColliding(){const t=this.getHighestTie(),e=this.leftNote.hasStem()&&this.leftNote.getStemValue()===z.A.UP&&t.placement===I.A.ABOVE;t.leftSide.stemColliding=e}fillRightTieColliding(){const t=this.getLowestTie(),e=this.rightNote.hasStem()&&this.rightNote.getStemValue()===z.A.DOWN&&t.placement===I.A.BELOW;t.rightSide.stemColliding=e}fillLeftSideShift(){this.fillShift(this.leftNote,function(t){return t.leftSide})}fillRightSideShift(){this.fillShift(this.rightNote,function(t){return t.rightSide})}fillShift(t,e){this.lines.forEach(r=>{const i=this.getTieData(r),a=e(i),l=t.getStemValue();l===z.A.UP&&t.isSecondHigher(r)?a.shiftRight=!0:l===z.A.DOWN&&t.isSecondLower(r)&&(a.shiftLeft=!0)},this)}getInternalLines(){return this.lines.slice(1,-1)}getHighestTie(){const t=this.getHighestLine();return this.getTieData(t)}getLowestTie(){const t=this.getLowestLine();return this.getTieData(t)}getHighestLine(){return this.lines[0]}getLowestLine(){return this.lines[this.lines.length-1]}getTieData(t){const e=this.ties.get(t);if(!e)throw new Error("Tie data not found");return e}}function TA(s,t,e){if(e===I.A.ABOVE)return s.isHighestLine(t);if(e===I.A.BELOW)return s.isLowestLine(t);throw I.A.raiseError(e)}function EH(s){if(s===I.A.ABOVE)return I.A.BELOW;if(s===I.A.BELOW)return I.A.ABOVE;throw I.A.raiseError(s)}function DH(s,t){return s.isExternal&&!s.leftSide.stemColliding?t/2+1/8:s.leftSide.shiftRight?t*2:s.leftSide.shiftLeft?0:t}function CH(s,t){return s.isExternal&&!s.rightSide.stemColliding?t/2-1/8:s.leftSide.shiftRight?t:s.leftSide.shiftLeft?-t:0}function TH(s,t,e){let r;if(s.isExternal?r=t.getTieVerticalMargin():r=e/4,s.placement===I.A.ABOVE)return-r;if(s.placement===I.A.BELOW)return r;throw I.A.raiseError(s.placement)}var RH=Object.defineProperty,NH=(s,t,e)=>t in s?RH(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,So=(s,t,e)=>NH(s,typeof t!="symbol"?t+"":t,e);const LH="chordTies";class MH{constructor(t,e){So(this,"drawingContext"),So(this,"staffData"),So(this,"group"),So(this,"leftAnchor",null),So(this,"rightAnchor",null),So(this,"arcs",null),this.drawingContext=t,this.staffData=e,this.group=t.createGroupNode(),this.group.setLabel(LH)}discardArcs(){this.arcs!==null&&(this.arcs.forEach(t=>{const e=t.getChildRoot();it(this.group,e),e.destroy()}),this.arcs=null)}getArcs(){return this.arcs===null&&(this.arcs=this.createArcs()),this.arcs}createArcs(){if(!this.leftAnchor||!this.rightAnchor)throw new Error("Cannot create tie arcs without anchors");const t=this.getLeftDisplayData(),e=this.getRightDisplayData();return bH(t,e).map(this.createArc,this)}getLeftDisplayData(){if(!this.leftAnchor||!this.rightAnchor)throw new Error("Need both anchors to get left display data");if(this.leftAnchor.hasLocation())return this.leftAnchor.displayData;const t=structuredClone(this.leftAnchor.displayData.opts),e=new Ol(t),r=this.rightAnchor.displayData,i=r.getBeamData();return i&&e.setBeamData(i),e.opts.hasBeam=r.hasBeam(),e}getRightDisplayData(){if(!this.leftAnchor||!this.rightAnchor)throw new Error("Need both anchors to get right display data");if(this.rightAnchor.hasLocation())return this.rightAnchor.displayData;const t=structuredClone(this.rightAnchor.displayData.opts),e=new Ol(t),r=this.leftAnchor.displayData,i=r.getBeamData();return i&&e.setBeamData(i),e.opts.hasBeam=r.hasBeam(),e}createArc(t){if(!this.leftAnchor||!this.rightAnchor)throw new Error("Cannot create tie arcs without anchors");let e=0;if(this.leftAnchor.location){const f=this.leftAnchor.location.note.getMiddleHeadWidth();e=DH(t,f)}let r=0;if(this.rightAnchor.location){const f=this.rightAnchor.location.note.getMiddleHeadWidth();r=CH(t,f)}const i=TH(t,this.drawingContext,this.staffData.spaceSize),a=(0,Ft.$n)(t.line,this.staffData)+i,l=(0,Ft.$n)(t.rightLine,this.staffData)+i,d=new AH(this.drawingContext,{leftY:a,rightY:l,placement:t.placement,leftOffset:e,rightOffset:r});return v(this.group,d.getChildRoot()),d}formatHorizontal(){const t=this.getLeftX(),e=this.getRightX();this.getArcs().forEach(i=>i.formatHorizontal(t,e))}getLeftX(){if(!this.leftAnchor)throw new Error("Cannot get left X without left anchor");if(this.leftAnchor.hasLocation())return this.leftAnchor.getPosition();if(!this.rightAnchor)throw new Error("Cannot get left X without right anchor");return this.rightAnchor.getOppositeEdgePosition()}getRightX(){if(!this.rightAnchor)throw new Error("Cannot get right X without right anchor");if(this.rightAnchor.hasLocation())return this.rightAnchor.getPosition();if(!this.leftAnchor)throw new Error("Cannot get right X without left anchor");return this.leftAnchor.getOppositeEdgePosition()}getChildRoot(){return this.group}isOrphan(){return!this.leftAnchor||!this.rightAnchor&&!this.group.parent}destroy(){this.group.destroy()}setLeftAnchor(t){t!==this.leftAnchor&&(this.discardArcs(),this.leftAnchor=t)}setRightAnchor(t){t!==this.rightAnchor&&(this.discardArcs(),this.rightAnchor=t)}}function RA(s,t){if(t.isStart()){if(s.leftAnchor===t)return;s.leftAnchor&&mh(s,s.leftAnchor),s.setLeftAnchor(t)}else if(t.isStop()){if(s.rightAnchor===t)return;s.rightAnchor&&mh(s,s.rightAnchor),s.setRightAnchor(t)}else throw new Error(`Invalid anchor type: ${t.type}`);t.tie=null}var OH=Object.defineProperty,BH=(s,t,e)=>t in s?OH(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ou=(s,t,e)=>BH(s,typeof t!="symbol"?t+"":t,e);function IH(s,t,e,r){const i=s.flatMap(FH,t);return new UH(e,r).match(i)}function FH(s,t,e){const r=[],i=this.valueOf();if(t===0){const f=s.tickableContent.getLeftTieAnchor(i);f&&r.push(f)}const l=s.tickableContent.getMiddleTieAnchors(i);if(r.push(...l),t===e.length-1){const f=s.tickableContent.getRightTieAnchor(i);f&&r.push(f)}return r}class UH{constructor(t,e){Ou(this,"ties",[]),Ou(this,"tempAnchor",null),Ou(this,"drawingContext"),Ou(this,"staffData"),this.drawingContext=t,this.staffData=e}match(t){return t.forEach(this.processAnchor,this),this.ties}processAnchor(t){t.isStart()?(this.tempAnchor&&NA(this.tempAnchor),this.tempAnchor=t):t.isStop()&&(this.tempAnchor?(this.createTie(this.tempAnchor,t),this.tempAnchor=null):NA(t))}createTie(t,e){let r;t.tie?r=t.tie:e.tie?r=e.tie:r=new MH(this.drawingContext,this.staffData),RA(r,t),RA(r,e),this.ties.push(r)}}function NA(s){if(s.tie){const t=s.tie;mh(t,s)}}var HH=Object.defineProperty,_H=(s,t,e)=>t in s?HH(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ah=(s,t,e)=>_H(s,typeof t!="symbol"?t+"":t,e);const GH="staffVoiceTies";class XH{constructor(t,e,r){Ah(this,"group"),Ah(this,"drawingContext"),Ah(this,"staffData"),Ah(this,"voiceIdx"),Ah(this,"ties",[]),this.group=t.createGroupNode(),this.group.setLabel(GH),this.drawingContext=t,this.staffData=e,this.voiceIdx=r}updateFromMeasures(t){const e=IH(t,this.voiceIdx,this.drawingContext,this.staffData);for(let r=this.ties.length-1;r>=0;r--){const i=this.ties[r];!e.includes(i)&&(this.ties.pop(),it(this.group,i.getChildRoot()),pH(i))}e.forEach(r=>{this.ties.includes(r)||(this.ties.push(r),v(this.group,r.getChildRoot()))})}formatHorizontal(){this.ties.forEach(t=>t.formatHorizontal())}getChildRoot(){return this.group}}var WH=Object.defineProperty,zH=(s,t,e)=>t in s?WH(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,vh=(s,t,e)=>zH(s,typeof t!="symbol"?t+"":t,e);class YH{constructor(t){vh(this,"drawingContext"),vh(this,"anchors"),vh(this,"wedges"),vh(this,"currentMeasureIdx",null),vh(this,"pendingWedge",null),this.drawingContext=t,this.wedges=[],this.anchors=[]}reset(){this.pendingWedge=null,this.wedges=[],this.anchors=[],this.currentMeasureIdx=null}parseMeasuresRangeNotations(t){return this.reset(),t.forEach(this.parseMeasuresRangeNotationAnchors,this),this.createWedges(),this.wedges.forEach(e=>e.fillEventPayload()),this.wedges}parseMeasuresRangeNotationAnchors(t,e,r){this.currentMeasureIdx=e;const i=e===0,a=e===r.length-1;t.hasLeftWedgeAnchor()&&this.updateLeftAnchor(t.getLeftWedgeAnchor(),i);const l=t.getMiddleWedgesAnchors();this.addAnchors(l),t.hasRightWedgeAnchor()&&this.updateRightAnchor(t.getRightWedgeAnchor(),a)}updateLeftAnchor(t,e){e?this.addAnchor(t):t.hasWedge()&&t.getWedge().erase()}updateRightAnchor(t,e){e?this.addAnchor(t):t.hasWedge()&&t.getWedge().erase()}addAnchors(t){t.forEach(this.addAnchor,this)}addAnchor(t){this.anchors.push(t)}createWedges(){this.anchors.forEach(this.useAnchor,this),this.hasPendingWedge()&&this.discardPendingWedge()}useAnchor(t){if(t.isLeft())this.openPendingWedge(t);else if(t.isRight())this.closePending(t);else throw new Error("Unexpected")}openPendingWedge(t){this.hasPendingWedge()&&this.discardPendingWedge();let e;t.hasWedge()?e=t.getWedge():(e=new bm(this.drawingContext,{placement:t.placement,type:t.type}),e.setLeftAnchor(t)),this.pendingWedge=e}discardPendingWedge(){this.hasPendingWedge()&&(this.pendingWedge.erase(),this.pendingWedge=null)}closePending(t){if(this.hasPendingWedge()){this.removeWedgeIfDifferentFromPending(t);const e=this.getPendingWedge();t.hasWedge()||e.setRightAnchor(t),this.wedges.push(e),this.pendingWedge=null}else t.hasWedge()&&t.removeWedge()}removeWedgeIfDifferentFromPending(t){if(t.hasWedge()){const e=t.getWedge(),r=this.getPendingWedge();e!==r&&t.removeWedge()}}hasPendingWedge(){return this.pendingWedge!==null}getPendingWedge(){return this.pendingWedge}}var kH=Object.defineProperty,qH=(s,t,e)=>t in s?kH(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Bu=(s,t,e)=>qH(s,typeof t!="symbol"?t+"":t,e);class wo{constructor(t,{linker:e}){Bu(this,"group"),Bu(this,"drawingContext"),Bu(this,"rangeChildren"),Bu(this,"linker"),this.drawingContext=t,this.rangeChildren=[],this.linker=e,this.group=this.drawingContext.createGroupNode()}updateFromMeasures(t){const e=this.linker.parseMeasuresRangeNotations(t);if(e.length===0){this.rangeChildren.forEach((r,i)=>{this.removeRangeChild(i)});return}if(this.rangeChildren.length===0){e.forEach(r=>{this.addRangeChild(r)});return}e.forEach(r=>{const i=r.getChildRoot().getId();this.rangeChildren.find(l=>l.getChildRoot().getId()===i)||this.addRangeChild(r)}),this.rangeChildren.forEach((r,i)=>{const a=r.getChildRoot().getId();!e.find(d=>d.getChildRoot().getId()===a)&&this.removeRangeChild(i)})}removeRangeChild(t){const e=this.rangeChildren[t];this.group===e.getChildRoot().getParent()&&(it(this.group,e.getChildRoot()),!e.hasLeftAnchor()&&!e.hasRightAnchor()&&e.getChildRoot().destroy()),this.rangeChildren.splice(t,1)}addRangeChild(t){v(this.group,t.getChildRoot()),this.rangeChildren.push(t)}getChildRoot(){return this.group}}var VH=Object.defineProperty,QH=(s,t,e)=>t in s?VH(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Te=(s,t,e)=>QH(s,typeof t!="symbol"?t+"":t,e);const KH="staff";class JH{constructor(t,e,r){Te(this,"group"),Te(this,"measures",[]),Te(this,"staffLines"),Te(this,"staffData"),Te(this,"topHeights",new Gr),Te(this,"bottomHeights",new Gr),Te(this,"initialTopHeights",new Gr),Te(this,"initialBottomHeights",new Gr),Te(this,"drawingContext"),Te(this,"octaveShifts"),Te(this,"pedals"),Te(this,"pluckedRanges"),Te(this,"voicesTies",[]),Te(this,"voicesHammerOns",[]),Te(this,"voicesSlides",[]),Te(this,"voicesGlissandos",[]),Te(this,"voiceHyphens",[]),Te(this,"voiceMelismas",[]),Te(this,"voiceSlurs",[]),Te(this,"voiceBends",[]),Te(this,"wedges"),Te(this,"crossMeasuresContainers",[]),Te(this,"voicesIndexes",[]),this.group=t.createGroupNode(),this.group.setLabel(KH),this.staffLines=new cI(t,e),this.staffData=e,this.drawingContext=t;const i=new QF(this.drawingContext);this.octaveShifts=new wo(t,{linker:i}),this.crossMeasuresContainers.push(this.octaveShifts);const a=new $F(this.drawingContext);this.pedals=new wo(t,{linker:a}),this.crossMeasuresContainers.push(this.pedals);const l=new tU(this.drawingContext);this.pluckedRanges=new wo(t,{linker:l}),this.crossMeasuresContainers.push(this.pluckedRanges);const d=new YH(this.drawingContext);this.wedges=new wo(t,{linker:d}),this.crossMeasuresContainers.push(this.wedges),this.attachCrossMeasures(),this.voicesIndexes=r.slice(),this.isRecorderTabStaff()||r.forEach(f=>{this.addVoiceCommon(f)}),this.isGuitarTabStaff()&&r.forEach(f=>{this.addVoiceGuitarTab(f)}),this.isRecorderTabStaff()||v(this.group,this.staffLines.getChildRoot())}addVoice(t,e){this.voicesIndexes.splice(e,0,t),this.isRecorderTabStaff()||this.addVoiceCommon(t),this.isGuitarTabStaff()&&this.addVoiceGuitarTab(t)}addVoiceCommon(t){const e=new XH(this.drawingContext,this.staffData,t);this.crossMeasuresContainers.push(e),this.voicesTies.push(e),v(this.group,e.getChildRoot());const r=new AU(this.drawingContext,this.staffData,t);this.crossMeasuresContainers.push(r),this.voicesSlides.push(r),v(this.group,r.getChildRoot());const i=new XI(this.drawingContext,this.staffData,t);this.crossMeasuresContainers.push(i),this.voicesGlissandos.push(i),v(this.group,i.getChildRoot());const a=new NF(this.drawingContext,this.staffData,t);this.crossMeasuresContainers.push(a),this.voiceHyphens.push(a),v(this.group,a.getChildRoot());const l=new kF(this.drawingContext,this.staffData,t);this.crossMeasuresContainers.push(l),this.voiceMelismas.push(l),v(this.group,l.getChildRoot());const d=new TU(this.drawingContext,this.staffData,t);this.crossMeasuresContainers.push(d),this.voiceSlurs.push(d),v(this.group,d.getChildRoot())}addVoiceGuitarTab(t){const e=new bI(this.drawingContext,this.staffData,t);this.crossMeasuresContainers.push(e),this.voiceBends.push(e),v(this.group,e.getChildRoot());const r=new lF(this.drawingContext,this.staffData,t);this.crossMeasuresContainers.push(r),this.voicesHammerOns.push(r),v(this.group,r.getChildRoot())}removeVoice(t){const e=this.voicesTies.findIndex(w=>w.voiceIdx===t);if(e!==-1){const[w]=this.voicesTies.splice(e,1);it(this.group,w.getChildRoot()),w.getChildRoot().destroy()}const r=this.voicesSlides.findIndex(w=>w.voiceIdx===t);if(r!==-1){const[w]=this.voicesSlides.splice(r,1);it(this.group,w.getChildRoot()),w.getChildRoot().destroy()}const i=this.voicesGlissandos.findIndex(w=>w.voiceIdx===t);if(i!==-1){const[w]=this.voicesGlissandos.splice(i,1);it(this.group,w.getChildRoot()),w.getChildRoot().destroy()}const a=this.voiceHyphens.findIndex(w=>w.voiceIdx===t);if(a!==-1){const[w]=this.voiceHyphens.splice(a,1);it(this.group,w.getChildRoot()),w.getChildRoot().destroy()}const l=this.voiceMelismas.findIndex(w=>w.voiceIdx===t);if(l!==-1){const[w]=this.voiceMelismas.splice(l,1);it(this.group,w.getChildRoot()),w.getChildRoot().destroy()}const d=this.voiceSlurs.findIndex(w=>w.voiceIdx===t);if(d!==-1){const[w]=this.voiceSlurs.splice(d,1);it(this.group,w.getChildRoot()),w.getChildRoot().destroy()}const f=this.voiceBends.findIndex(w=>w.voiceIdx===t);if(f!==-1){const[w]=this.voiceBends.splice(f,1);it(this.group,w.getChildRoot()),w.getChildRoot().destroy()}const m=this.voicesHammerOns.findIndex(w=>w.voiceIdx===t);if(m!==-1){const[w]=this.voicesHammerOns.splice(m,1);it(this.group,w.getChildRoot()),w.getChildRoot().destroy()}const S=this.voicesIndexes.indexOf(t);if(S!==-1)this.voicesIndexes.splice(S,1);else throw new Error(`Voice index ${t} not found in staff ${this.staffData.uuid}`);this.crossMeasuresContainers=this.crossMeasuresContainers.filter(w=>!("voiceIdx"in w&&typeof w.voiceIdx=="number"&&w.voiceIdx===t))}addMeasure(t){this.measures.push(t),v(this.group,t.getChildRoot())}addMeasureAt(t,e){this.measures.splice(e,0,t),v(this.group,t.getChildRoot())}removeMeasureAt(t,e){if(e!==this.measures[t]&&(t=this.measures.indexOf(e)),t<0){if(e.getChildRoot().getParent()!==null)throw new Error("Trying to remove a Measure attached to a different Staff");return}const[r]=this.measures.splice(t,1);it(this.group,r.getChildRoot())}getMeasureHorizontalData(t){return this.getMeasure(t).getHorizontalData()}setMeasureHorizontalFormatter(t,e){this.getMeasure(t).setHorizontalFormatter(e)}getMeasure(t){if(t<0||t>=this.measures.length)throw new Error(`Invalid measure index ${t}`);return this.measures[t]}formatVertical(){this.resetHeightsMaps(),aH(this.voiceSlurs,this.measures,this.topHeights,this.bottomHeights),uH(this.measures,this.drawingContext,this.topHeights,this.bottomHeights),kU(this.measures,this.drawingContext,this.topHeights,this.bottomHeights),LU(this.wedges.rangeChildren,this.measures,this.drawingContext,this.topHeights,this.bottomHeights),jU(this.measures,this.drawingContext,this.topHeights,this.bottomHeights),hH(this.measures,this.drawingContext,this.topHeights,this.bottomHeights),HU(this.measures,this.drawingContext,this.topHeights),nH(this.measures,this.drawingContext,this.bottomHeights),FU(this.measures,this.drawingContext,this.bottomHeights);const t=(0,Ft.o5)(this.staffData);$U(this.pedals.rangeChildren,this.drawingContext,this.bottomHeights,t),sH(this.pluckedRanges.rangeChildren,this.drawingContext,this.topHeights,this.bottomHeights,t),QU(this.octaveShifts.rangeChildren,this.drawingContext,this.topHeights,this.bottomHeights,t),GU(this.measures,this.drawingContext,this.voicesIndexes,this.bottomHeights,this.voiceHyphens,this.voiceMelismas)}resetHeightsMaps(){const t=this.measures.flatMap(a=>a.extractInitialHeights()),e=(0,Ft.o5)(this.staffData),{topHeights:r,bottomHeights:i}=gH(t,e);this.topHeights=new Gr,r.forEach(a=>this.topHeights.addHeight(a)),this.bottomHeights=new Gr,i.forEach(a=>this.bottomHeights.addHeight(a)),this.initialTopHeights=this.topHeights.clone(),this.initialBottomHeights=this.bottomHeights.clone()}displayHeightsMap(){this.topHeights.dumpInserts().forEach(({position:i,width:a,height:l})=>{l=-l;const d=this.drawingContext.createLineNode();d.setWidth(.1),d.setStrokeColor("red"),d.setX(i),d.setY(l),d.setX2(a),d.setY2(0),v(this.group,d)});const e=(0,Ft.o5)(this.staffData);this.bottomHeights.dumpInserts().forEach(({position:i,width:a,height:l})=>{l+=e;const d=this.drawingContext.createLineNode();d.setWidth(.1),d.setStrokeColor("red"),d.setX(i),d.setY(l),d.setX2(a),d.setY2(0),v(this.group,d)})}getChildRoot(){return this.group}getStaffHeight(){return this.staffLines.getHeight()}getBottomHeights(){return this.bottomHeights.dumpInserts()}getBottomHeight(){return this.bottomHeights.getMaxHeight()}getTopHeight(){return this.topHeights.getMaxHeight()}getTopHeights(){return this.topHeights.dumpInserts()}setY(t){this.group.setY(t)}getY(){return this.group.getY()}extendBarlines(t){this.measures.forEach(e=>e.extendBarlines(t))}attachCrossMeasures(){this.crossMeasuresContainers.forEach(t=>{v(this.group,t.getChildRoot())})}reloadCrossMeasures(){this.crossMeasuresContainers.forEach(t=>{t.updateFromMeasures(this.measures)})}formatHorizontal(){let t=0;this.measures.forEach(e=>{e.setX(t),e.formatHorizontal(),t+=e.getWidth()}),this.voicesTies.forEach(e=>e.formatHorizontal()),this.voicesHammerOns.forEach(e=>e.formatHorizontal()),this.voicesSlides.forEach(e=>e.formatHorizontal()),this.voicesGlissandos.forEach(e=>e.formatHorizontal()),this.voiceHyphens.forEach(e=>e.formatHorizontal()),this.voiceMelismas.forEach(e=>e.formatHorizontal()),this.voiceBends.forEach(e=>e.formatHorizontal()),this.voiceSlurs.forEach(e=>e.formatHorizontal()),this.staffLines.setWidth(t)}getWidth(){return this.staffLines.getWidth()}hasMeasure(t){return this.measures.includes(t)}isEmpty(){return this.measures.every(t=>t.isEmpty())}isRecorderTabStaff(){return this.staffData.type===Zt.A.RECORDER_TAB}isGuitarTabStaff(){return this.staffData.type===Zt.A.GUITAR_TAB}getGeometry(){return{staffUuid:this.staffData.uuid,y:this.getY(),staffHeight:this.getStaffHeight(),type:this.staffData.type,spaceBelow:this.getBottomHeight(),spaceAbove:this.getTopHeight()}}}var $H=Object.defineProperty,ZH=(s,t,e)=>t in s?$H(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,LA=(s,t,e)=>ZH(s,typeof t!="symbol"?t+"":t,e);class jH{constructor(t,e){LA(this,"drawingContext"),LA(this,"partsData"),this.drawingContext=t,this.partsData=e}createParts(t){const e=this.partsData.map(r=>this.createPart(r,t));return oI(e),iI(e,this.drawingContext),e}createPart(t,e){const r=Zy(this.drawingContext,t,e),i=new Np(this.drawingContext,r,t);return t.staves.forEach((a,l)=>{const d=t.stavesVoices[l],f=new JH(this.drawingContext,a,d);i.addStaff(f)}),i}}var t2=Object.defineProperty,e2=(s,t,e)=>t in s?t2(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,lr=(s,t,e)=>e2(s,typeof t!="symbol"?t+"":t,e);class s2{constructor(t,{x1:e,x2:r,y2:i,leftClosed:a,rightClosed:l}){lr(this,"groupNode"),lr(this,"drawingContext"),lr(this,"x1"),lr(this,"x2"),lr(this,"y2"),lr(this,"leftClosed"),lr(this,"rightClosed"),lr(this,"middleLine",null),lr(this,"rightLine",null),lr(this,"leftLine",null),lr(this,"lineThickness"),this.drawingContext=t,this.groupNode=t.createGroupNode(),this.x1=e,this.x2=r,this.y2=i,this.leftClosed=a,this.rightClosed=l,this.lineThickness=this.drawingContext.getEndingThickness(),this.drawLines()}getChildRoot(){return this.groupNode}isLeftClosed(){return this.leftClosed}isRightClosed(){return this.rightClosed}drawLines(){this.isLeftClosed()&&this.drawLeftLine(),this.drawMiddleLine(),this.isRightClosed()&&this.drawRightLine()}drawLeftLine(){this.leftLine=this.drawingContext.createLineNode(),this.leftLine.setWidth(this.lineThickness),this.leftLine.setX(this.x1+this.lineThickness/2),this.leftLine.setY2(this.y2),v(this.groupNode,this.leftLine)}drawMiddleLine(){this.middleLine=this.drawingContext.createLineNode(),this.middleLine.setWidth(this.lineThickness),this.middleLine.setX(this.x1),this.middleLine.setX2(this.x2),v(this.groupNode,this.middleLine)}drawRightLine(){this.rightLine=this.drawingContext.createLineNode(),this.rightLine.setWidth(this.lineThickness),this.rightLine.setX(this.x2-this.lineThickness/2),this.rightLine.setY2(this.y2),v(this.groupNode,this.rightLine)}destroy(){const t=this.getChildRoot().getParent();t!==null&&it(t,this.getChildRoot()),this.getChildRoot().destroy()}}var r2=Object.defineProperty,i2=(s,t,e)=>t in s?r2(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,MA=(s,t,e)=>i2(s,typeof t!="symbol"?t+"":t,e);class n2{constructor(t,{text:e,x:r,y:i}){MA(this,"textNode"),MA(this,"drawingContext"),this.drawingContext=t;const a=t.getEndingFontOptions();this.textNode=t.createTextNode(e,a),this.textNode.setX(r),this.textNode.setY(i)}getChildRoot(){return this.textNode}destroy(){const t=this.getChildRoot().getParent();t!==null&&it(t,this.getChildRoot()),this.getChildRoot().destroy()}}var o2=Object.defineProperty,a2=(s,t,e)=>t in s?o2(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ii=(s,t,e)=>a2(s,typeof t!="symbol"?t+"":t,e);class h2{constructor(t){Ii(this,"drawingContext"),Ii(this,"textChild",null),Ii(this,"bracket",null),Ii(this,"leftAnchor",null),Ii(this,"rightAnchor",null),Ii(this,"x1",null),Ii(this,"x2",null),Ii(this,"groupNode"),this.drawingContext=t,this.groupNode=this.drawingContext.createGroupNode()}getChildRoot(){return this.groupNode}getUuid(){return null}isAbove(){return!0}isBelow(){return!1}isLeftClosed(){return this.hasLeftAnchor()&&this.leftAnchor.isLeftClosed()}isRightClosed(){return this.hasRightAnchor()&&this.rightAnchor.isRightClosed()}isContinueStop(){return this.hasRightAnchor()&&this.rightAnchor.isStop()}erase(){this.hasLeftAnchor()&&this.removeLeftAnchor(),this.hasRightAnchor()&&this.removeRightAnchor()}setLeftAnchor(t){this.hasLeftAnchor()&&this.leftAnchor!==t&&this.removeLeftAnchor(),this.leftAnchor=t,this.leftAnchor.setEnding(this),!(this.leftAnchor===null||!this.leftAnchor.hasText())&&this.drawText()}hasLeftAnchor(){return this.leftAnchor!==null}removeLeftAnchor(){this.hasLeftAnchor()&&(this.leftAnchor.ending=null,this.leftAnchor=null)}setRightAnchor(t){this.hasRightAnchor()&&this.rightAnchor!==t&&this.removeRightAnchor(),this.rightAnchor=t,this.rightAnchor.setEnding(this)}hasRightAnchor(){return this.rightAnchor!==null}removeRightAnchor(){this.hasRightAnchor()&&(this.rightAnchor.ending=null,this.rightAnchor=null)}getHeight(){return this.drawingContext.getEndingFontOptions().fontSize+this.drawingContext.getEndingTextVerticalMargin()}setX1(t){this.x1=t,this.groupNode.setX(t),this.updateAfterDimensionsChange()}setX2(t){this.x2=t,this.updateAfterDimensionsChange()}updateAfterDimensionsChange(){this.x1===null||this.x2===null||this.drawBracket()}drawText(){if(this.leftAnchor===null||!this.leftAnchor.hasText())throw new Error("Must have left anchor with text by now");this.textChild&&(this.textChild.destroy(),this.textChild=null),this.textChild=new n2(this.drawingContext,{text:this.leftAnchor.getText(),x:this.drawingContext.getEndingTextHorizontalMargin(),y:this.getHeight()}),v(this.groupNode,this.textChild.getChildRoot())}drawBracket(){if(this.x1===null||this.x2===null)throw new Error("Must have x1 and x2 by now");if(this.leftAnchor===null||this.rightAnchor===null)throw new Error("Must have left anchor with text by now");this.bracket&&(this.bracket.destroy(),this.bracket=null);const t=this.isLeftClosed(),e=this.isRightClosed();this.bracket=new s2(this.drawingContext,{x1:0,x2:this.x2-this.x1,y2:this.getHeight(),leftClosed:t,rightClosed:e}),v(this.groupNode,this.bracket.getChildRoot())}}var l2=Object.defineProperty,c2=(s,t,e)=>t in s?l2(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Sh=(s,t,e)=>c2(s,typeof t!="symbol"?t+"":t,e);class u2{constructor(t){Sh(this,"drawingContext"),Sh(this,"anchors"),Sh(this,"endings"),Sh(this,"currentMeasureIdx",null),Sh(this,"pendingEnding",null),this.drawingContext=t,this.endings=[],this.anchors=[]}reset(){this.pendingEnding=null,this.endings=[],this.anchors=[],this.currentMeasureIdx=null}parseMeasuresRangeNotations(t){return this.reset(),t.forEach(this.parseMeasuresRangeNotationAnchors,this),this.createEndings(),this.endings}parseMeasuresRangeNotationAnchors(t,e,r){this.currentMeasureIdx=e;const i=e===0,a=e===r.length-1;t.hasLeftEndingAnchor()&&this.updateLeftAnchor(t.getLeftEndingAnchor(),i);const l=t.getMiddleEndingAnchors();this.addAnchors(l),t.hasRightEndingAnchor()&&this.updateRightAnchor(t.getRightEndingAnchor(),a)}updateLeftAnchor(t,e){e?this.addAnchor(t):t.hasEnding()&&t.getEnding().erase()}updateRightAnchor(t,e){e?this.addAnchor(t):t.hasEnding()&&t.getEnding().erase()}addAnchors(t){t.forEach(this.addAnchor,this)}addAnchor(t){this.anchors.push(t)}createEndings(){this.anchors.forEach(this.useAnchor,this),this.hasPendingEnding()&&this.discardPendingEnding()}useAnchor(t){if(t.isLeft())this.openPendingEnding(t);else if(t.isRight())this.closePending(t);else throw new Error("Unexpected")}openPendingEnding(t){this.hasPendingEnding()&&this.discardPendingEnding();let e;t.hasEnding()?e=t.getEnding():(e=new h2(this.drawingContext),e.setLeftAnchor(t)),this.pendingEnding=e}discardPendingEnding(){this.hasPendingEnding()&&(this.pendingEnding.erase(),this.pendingEnding=null)}closePending(t){if(this.hasPendingEnding()){this.removeEndingIfDifferentFromPending(t);const e=this.getPendingEnding();t.hasEnding()||e.setRightAnchor(t),this.endings.push(e),this.pendingEnding=null}else t.hasEnding()&&t.removeEnding()}removeEndingIfDifferentFromPending(t){if(t.hasEnding()){const e=t.getEnding(),r=this.getPendingEnding();e!==r&&t.removeEnding()}}hasPendingEnding(){return this.pendingEnding!==null}getPendingEnding(){return this.pendingEnding}}function d2(s,t,e){const r=f2(s);Ye(r,e,t,!1)}function f2(s){return s.flatMap(g2)}function g2(s){const t=[];if(s.measureNumber){const e=s.measureNumber,r=p2(e,s);t.push(r)}return t}function p2(s,t){return{entity:s,xPosition:t.group.getX()+s.getChildRoot().getX(),yPosition:null}}function m2(s,t,e){const r=y2(s);Ye(r,e,t,!1)}function y2(s){return s.flatMap(A2)}function A2(s){const t=[];if(s.barlineRepeatNbTimes){const e=s.barlineRepeatNbTimes,r=v2(e,s);t.push(r)}return t}function v2(s,t){return{entity:s,xPosition:t.group.getX()+s.getChildRoot().getX(),yPosition:null}}function S2(s,t,e){const r=w2(s);Ye(r,e,t,!1)}function w2(s){return s.map(t=>({entity:t,xPosition:t.getChildRoot().getX(),yPosition:null}))}function x2(s,t,e){const r=b2(s);Ye(r,e,t,!1)}function b2(s){return s.flatMap(P2)}function P2(s){const t=[];if(s.jumpCall){const e=s.jumpCall,r=OA(e,s);t.push(r)}if(s.jumpTag){const e=s.jumpTag,r=OA(e,s);t.push(r)}return t}function OA(s,t){return{entity:s,xPosition:t.group.getX()+s.getChildRoot().getX(),yPosition:null}}function E2(s,t,e){const r=D2(s);Ye(r,e,t,!1)}function D2(s){return s.flatMap(C2)}function C2(s){const t=[];if(s.metronome){const e=T2(s.metronome,s);t.push(e)}return t}function T2(s,t){return{entity:s,xPosition:t.group.getX()+s.getChildRoot().getX(),yPosition:null}}function R2(s,t,e){const r=N2(s);Ye(r,e,t,!1)}function N2(s){return s.flatMap(L2)}function L2(s){const t=[];if(s.rehearsal){const e=s.rehearsal,r=M2(e,s);t.push(r)}return t}function M2(s,t){return{entity:s,xPosition:t.group.getX()+s.getChildRoot().getX(),yPosition:null}}function O2(s,t,e){const r=B2(s);qs(r,e,t,!1)}function B2(s){return s.flatMap(I2)}function I2(s){const t=[];if(s.systemBreakBeforeDrawer){const e=s.systemBreakBeforeDrawer,r=Iu(e,s);t.push(r)}else if(s.pageBreakBeforeDrawer){const e=s.pageBreakBeforeDrawer,r=Iu(e,s);t.push(r)}if(s.systemBreakAfterDrawer){const e=s.systemBreakAfterDrawer,r=Iu(e,s);t.push(r)}else if(s.pageBreakAfterDrawer){const e=s.pageBreakAfterDrawer,r=Iu(e,s);t.push(r)}return t}function Iu(s,t){return{entity:s,xPosition:t.group.getX()+s.getChildRoot().getX(),yPosition:null}}function F2(s,t,e){const r=U2(s);Ye(r,e,t,!1)}function U2(s){return s.map(t=>({entity:t,xPosition:t.getChildRoot().getX(),yPosition:null}))}var H2=Object.defineProperty,_2=(s,t,e)=>t in s?H2(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,wh=(s,t,e)=>_2(s,typeof t!="symbol"?t+"":t,e);class G2{constructor(t){wh(this,"drawingContext"),wh(this,"anchors"),wh(this,"tempoChanges"),wh(this,"currentMeasureIdx",null),wh(this,"pendingTempoChange",null),this.drawingContext=t,this.tempoChanges=[],this.anchors=[]}reset(){this.pendingTempoChange=null,this.tempoChanges=[],this.anchors=[],this.currentMeasureIdx=null}parseMeasuresRangeNotations(t){return this.reset(),t.forEach(this.parseMeasuresRangeNotationAnchors,this),this.createTempoChanges(),this.tempoChanges.forEach(e=>e.fillEventPayload()),this.tempoChanges}parseMeasuresRangeNotationAnchors(t,e,r){this.currentMeasureIdx=e;const i=e===0,a=e===r.length-1;t.hasLeftTempoChangeAnchor()&&this.updateLeftAnchor(t.getLeftTempoChangeAnchor(),i);const l=t.getMiddleTempoChangesAnchors();this.addAnchors(l),t.hasRightTempoChangeAnchor()&&this.updateRightAnchor(t.getRightTempoChangeAnchor(),a)}updateLeftAnchor(t,e){e?this.addAnchor(t):t.hasTempoChange()&&t.getTempoChange().erase()}updateRightAnchor(t,e){e?this.addAnchor(t):t.hasTempoChange()&&t.getTempoChange().erase()}addAnchors(t){t.forEach(this.addAnchor,this)}addAnchor(t){this.anchors.push(t)}createTempoChanges(){this.anchors.forEach(this.useAnchor,this),this.hasPendingTempoChange()&&this.discardPendingTempoChange()}useAnchor(t){if(t.isLeft())this.openPendingTempoChange(t);else if(t.isRight())this.closePending(t);else throw new Error("Unexpected")}openPendingTempoChange(t){this.hasPendingTempoChange()&&this.discardPendingTempoChange();let e;t.hasTempoChange()?e=t.getTempoChange():(e=new xm(this.drawingContext,{type:t.type}),e.setLeftAnchor(t)),this.pendingTempoChange=e}discardPendingTempoChange(){this.hasPendingTempoChange()&&(this.pendingTempoChange.erase(),this.pendingTempoChange=null)}closePending(t){if(this.hasPendingTempoChange()){this.removeTempoChangeIfDifferentFromPending(t);const e=this.getPendingTempoChange();t.hasTempoChange()||e.setRightAnchor(t),this.tempoChanges.push(e),this.pendingTempoChange=null}else t.hasTempoChange()&&t.removeTempoChange()}removeTempoChangeIfDifferentFromPending(t){if(t.hasTempoChange()){const e=t.getTempoChange(),r=this.getPendingTempoChange();e!==r&&t.removeTempoChange()}}hasPendingTempoChange(){return this.pendingTempoChange!==null}getPendingTempoChange(){return this.pendingTempoChange}}var X2=Object.defineProperty,W2=(s,t,e)=>t in s?X2(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,xn=(s,t,e)=>W2(s,typeof t!="symbol"?t+"":t,e);const z2="globalStaff";class Y2{constructor(t){xn(this,"group"),xn(this,"drawingContext"),xn(this,"measures",[]),xn(this,"topHeights",new Gr),xn(this,"crossMeasuresContainers",[]),xn(this,"tempoChanges"),xn(this,"endings"),this.drawingContext=t,this.group=t.createGroupNode(),this.group.setLabel(z2);const e=new G2(t);this.tempoChanges=new wo(t,{linker:e}),this.crossMeasuresContainers.push(this.tempoChanges);const r=new u2(t);this.endings=new wo(t,{linker:r}),this.crossMeasuresContainers.push(this.endings),this.attachCrossMeasures()}addMeasure(t){this.measures.push(t),v(this.group,t.getChildRoot())}addMeasureAt(t,e){this.measures.splice(e,0,t),v(this.group,t.getChildRoot())}removeMeasureAt(t,e){if(e!==this.measures[t]&&(t=this.measures.indexOf(e)),t<0){if(e.getChildRoot().getParent()!==null)throw new Error("Trying to remove a Measure attached to a different GlobalStaff");return}const[r]=this.measures.splice(t,1);it(this.group,r.getChildRoot())}setMeasureHorizontalFormatter(t,e){this.getMeasure(t).setHorizontalFormatter(e)}getMeasure(t){if(t<0||t>=this.measures.length)throw new Error(`Invalid measure index ${t}`);return this.measures[t]}formatVertical(t){this.resetHeightsMaps(t),F2(this.tempoChanges.rangeChildren,this.drawingContext,this.topHeights),S2(this.endings.rangeChildren,this.drawingContext,this.topHeights),m2(this.measures,this.drawingContext,this.topHeights),E2(this.measures,this.drawingContext,this.topHeights),x2(this.measures,this.drawingContext,this.topHeights),d2(this.measures,this.drawingContext,this.topHeights),R2(this.measures,this.drawingContext,this.topHeights),O2(this.measures,this.drawingContext,this.topHeights)}resetHeightsMaps(t){t!==null?this.topHeights=t:this.topHeights=new Gr}displayHeightsMap(){this.topHeights.dumpInserts().forEach(({position:r,width:i,height:a})=>{a+=0;const l=this.drawingContext.createLineNode();l.setWidth(.1),l.setStrokeColor("red"),l.setX(r),l.setY(a),l.setX2(i),l.setY2(0),v(this.group,l)})}getChildRoot(){return this.group}getTopHeight(){return this.topHeights.getMaxHeight()}attachCrossMeasures(){this.crossMeasuresContainers.forEach(t=>{v(this.group,t.getChildRoot())})}reloadCrossMeasures(){this.crossMeasuresContainers.forEach(t=>{t.updateFromMeasures(this.measures)})}formatHorizontal(){let t=0;this.measures.forEach((e,r)=>{let i=null;if(r>0){const a=this.getMeasure(r-1);i=a.getRightBarlinePosition()-a.getWidth()}e.setFormerLeftBarlinePosition(i),e.setX(t),e.formatHorizontal(),t+=e.getWidth()})}setY(t){this.group.setY(t)}getY(){return this.group.getY()}hasMeasure(t){return this.measures.includes(t)}}function BA(s,t){s=s.slice();const e=s.map(q2),r=s.map(k2);let i=e.reduce(Dt.default.add),a=r.reduce(Dt.default.add)+t,l=a/i;do{let d=!1;for(let f=s.length-1;f>=0;f--)if(r[f]/e[f]>l){s.splice(f,1);const[S]=e.splice(f,1);i-=S;const[w]=r.splice(f,1);a-=w,d=!0}if(d)l=a/i;else{s.forEach((f,m)=>{const S=e[m]*l;if(f.tickableFormatter===null)throw new Error("No notes formatter");f.tickableFormatter.setWidth(S)});return}}while(s.length>0)}function k2(s){const t=s.tickableFormatter;if(!t)throw new Error("No notes formatter");return t.getNominalWidth()}function q2(s){const t=s.tickableFormatter;if(!t)throw new Error("No notes formatter");const e=t.getDpq(),r=t.getNbDivisions();return Vn.default.divisionsToQuarter(r,e)}var Fu=b(15049);function V2(s){const{parts:t,formerDisplayedParts:e}=s;if(!Q2(s))return t;let r=t.filter(i=>!i.isEmpty());return r.length===0?t:(r=t.filter(i=>e.includes(i)||!i.isEmpty()),r)}function Q2(s){if(s.displayMetrics.forceDisplayAllParts)return!1;const{hideEmptyPartsPolicy:t}=s.layoutData;if(t===Fu.A.NEVER)return!1;if(t===Fu.A.ALL_SYSTEMS)return!0;if(t===Fu.A.AFTER_FIRST_SYSTEM)return!s.isFirstSlice;throw Fu.A.raiseError(t)}function K2(s,t){const e=s.getGroupBracket();if(e===null)return;const r=e.parts.indexOf(s),i=e.parts.length-1,a=e.removePartsRange(r,i),l=new tA(t);a.forEach(d=>{l.addPart(d)})}var J2=Object.defineProperty,$2=(s,t,e)=>t in s?J2(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Mp=(s,t,e)=>$2(s,typeof t!="symbol"?t+"":t,e);const Z2="systemHeader";class IA{constructor(t){Mp(this,"width",null),Mp(this,"group"),Mp(this,"parts",[]),this.group=t.createGroupNode(),this.group.setLabel(Z2)}unshiftPart(t){this.width=null,this.parts.unshift(t),v(this.group,t.getChildRoot())}addPart(t){this.width=null,this.parts.push(t),v(this.group,t.getChildRoot())}removePart(t){this.width=null;const e=this.parts.indexOf(t);if(e<0)throw new Error("Part not found");this.parts.splice(e,1),it(this.group,t.getChildRoot())}getWidth(){return this.width===null&&(this.width=this.formatHorizontal()),this.width}formatHorizontal(){const t=Math.max(...this.parts.map(e=>e.getWidth()));return this.parts.forEach(e=>e.setX(t)),this.width=t,t}getChildRoot(){return this.group}setY(t){this.group.setY(t)}setPartHeaderFormat(t){this.parts.forEach(e=>e.setPartNameFormat(t))}}var j2=Object.defineProperty,t_=(s,t,e)=>t in s?j2(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,cr=(s,t,e)=>t_(s,typeof t!="symbol"?t+"":t,e);const e_="system";class s_{constructor(t,e){cr(this,"globalStaff",null),cr(this,"parts",[]),cr(this,"distancesWithPrevious",[]),cr(this,"group"),cr(this,"drawingContext"),cr(this,"slice"),cr(this,"page",null),cr(this,"measuresFormatters",null),cr(this,"header"),cr(this,"verticalLine",null),cr(this,"dirtyFlag",!0),this.drawingContext=t,this.slice=e,this.group=t.createGroupNode(),this.group.setLabel(e_),this.header=new IA(t)}markClean(){this.dirtyFlag=!1}isDirty(){return this.dirtyFlag}markDirty(){this.dirtyFlag||(this.dirtyFlag=!0,this.page&&this.page.markDirty(),this.measuresFormatters=null)}setGlobalStaff(t){this.globalStaff=t,v(this.group,t.getChildRoot())}setPage(t){this.page=t}isSingleInSlice(){return this.slice.hasSingleSystem()}isFirstInSlice(){return this.slice.systems[0]===this}isEmpty(){return this.parts.length===0}hasPart(t){return this.parts.includes(t)}unshiftPart(t){this.parts.unshift(t),this.distancesWithPrevious.unshift(0),v(this.group,t.getChildRoot()),t.setParent(this);const e=t.getHeader();this.header.unshiftPart(e)}addPart(t,e){this.parts.push(t),v(this.group,t.getChildRoot()),t.setParent(this),this.distancesWithPrevious.push(e),this.measuresFormatters=null;const r=t.getHeader();this.header.addPart(r)}removePart(t){const e=this.parts.indexOf(t);if(e<0)throw new Error("Part not found");this.parts.splice(e,1),this.distancesWithPrevious.splice(e,1),it(this.group,t.getChildRoot()),this.measuresFormatters=null;const r=t.getHeader();this.header.removePart(r)}setDistance(t,e){this.distancesWithPrevious[t]=e}getBottomHeight(){return this.getBottomPart().getBottomHeight()}getBottomHeights(){return this.getBottomPart().getBottomHeights()}getBottomPart(){return this.parts[this.parts.length-1]}formatVertical(){let t=0;this.parts.forEach((e,r)=>{if(r>0){const i=this.parts[r-1];t+=i.getStaffHeight();const a=this.distancesWithPrevious[r];t+=a}e.setY(t)}),this.updateGroupBrackets(),this.updateVerticalLine()}updateVerticalLine(){const t=this.shouldDrawVerticalLine();if(t&&this.verticalLine===null){const e=this.drawingContext.getThinBarlineThickness();this.verticalLine=this.drawingContext.createLineNode(),this.verticalLine.setWidth(e),this.verticalLine.setX2(0),v(this.group,this.verticalLine)}else!t&&this.verticalLine!==null&&(it(this.group,this.verticalLine),this.verticalLine=null);if(this.verticalLine!==null){const e=this.getBottomPart(),r=e.getY()+e.getStaffHeight(!0);this.verticalLine.setY2(r)}}updateGroupBrackets(){this.parts.forEach(t=>{t.hasGroupBracket()&&t.isFirstOfGroupBracket()&&t.getGroupBracket().formatVertical()})}shouldDrawVerticalLine(){if(this.parts.length>1)return!0;if(this.parts.length===0)return!1;const[t]=this.parts;return t.staves.length>1}formatHeader(){this.header.formatHorizontal()}getChildRoot(){return this.group}hasPageBreakAfter(){return this.slice.hasPageBreakAfter()}hasPageBreakBefore(){return this.slice.hasPageBreakBefore()}getTopHeight(){return this.getTopPart().getTopHeight()}getTopPart(){return this.parts[0]}getStaffHeight(){const t=this.getBottomPart();return t.getY()+t.getStaffHeight()}getWidth(){return this.getTopPart().getWidth()}formatHorizontal(){const t=this.header.getWidth(),e=this.slice.displayMetrics;if(e.partsPanel?this.group.setX(0):this.group.setX(t),e.sliceWidth===null||(this.slice.isFirst?e.firstSliceHeaderWidth:e.otherSlicesHeaderWidth)===t)return;const i=e.sliceWidth-t,d=this.getTopPart().getTopStaff().measures.map(S=>S.getNominalWidth()).reduce(Dt.default.add,0);if(d>=i)return;const f=i-d,m=this.getMeasuresFormatters();BA(m,f),this.parts.forEach(S=>S.formatHorizontal()),this.globalStaff!==null&&this.globalStaff.formatHorizontal()}getMeasuresFormatters(){return this.measuresFormatters===null&&(this.isFirstInSlice()?this.measuresFormatters=this.slice.measures.map(t=>t.getFormatter()):this.measuresFormatters=this.slice.measures.map(t=>t.getFormatter().copy()),this.measuresFormatters.forEach((t,e)=>{this.parts.forEach(r=>r.setMeasureHorizontalFormatter(e,t)),this.globalStaff!==null&&this.globalStaff.setMeasureHorizontalFormatter(e,t)})),this.measuresFormatters}setY(t){this.group.setY(t),this.header.setY(t)}getY(){return this.group.getY()}getHeader(){return this.header}getGeometry(){const{x:t,y:e}=rt(this.group),r=this.parts.map(a=>a.getGeometry()),i=this.parts[0].staves[0].measures.map(a=>a.getGeometry());return{idxInSlice:this.slice.systems.indexOf(this),x:t,y:e,measures:i,parts:r}}}var r_=Object.defineProperty,i_=(s,t,e)=>t in s?r_(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,hi=(s,t,e)=>i_(s,typeof t!="symbol"?t+"":t,e);const n_=.5;function o_(s){new a_(s).process()}class a_{constructor(t){hi(this,"slice"),hi(this,"parts"),hi(this,"displayedParts"),hi(this,"systems"),hi(this,"availableHeight"),hi(this,"drawingContext"),hi(this,"globalStaff"),hi(this,"currentSystemIdx",0),hi(this,"currentSystemSize",0),this.slice=t.slice,this.parts=t.slice.parts,this.displayedParts=t.slice.displayedParts,this.systems=t.slice.systems,this.availableHeight=t.availableHeight,this.drawingContext=t.drawingContext,this.globalStaff=t.globalStaff}process(){this.removeHiddenParts(),this.displayedParts.forEach(this.processPart,this),this.removeEmptySystems()}removeHiddenParts(){if(this.displayedParts.length===this.parts.length)return;this.parts.filter(e=>!this.displayedParts.includes(e)).forEach(e=>{const r=e.parent;r&&r.removePart(e)})}processPart(t){const e=this.getSystem(),r=this.drawingContext.getSpaceBetweenStaves();if(this.currentSystemSize===0){this.currentSystemSize+=t.getTopHeight();const d=e.parts.indexOf(t);if(d>=0)e.setDistance(d,0);else{const f=t.parent;f&&f.removePart(t),e.unshiftPart(t)}this.currentSystemSize+=t.getStaffHeight();return}const i=e.getBottomHeights(),a=t.getTopHeights();let l=Qy(i,a)+n_;if(l=Math.max(l,r),this.canFitPart(t,l)){const d=e.parts.indexOf(t);if(d>=0)e.setDistance(d,l);else{const f=t.parent;f&&f.removePart(t),e.addPart(t,l)}this.currentSystemSize+=l+t.getStaffHeight()}else this.currentSystemSize=0,this.currentSystemIdx++,this.processPart(t),t.hasGroup()&&!t.hasGroupStart()&&K2(t,this.drawingContext)}canFitPart(t,e){const r=this.getAvailableHeight();if(r===null)return!0;const i=this.currentSystemSize+e+t.getStaffHeight()+t.getBottomHeight();return this.shouldBreakPageBecauseOfGroup(t,r,e)?!1:i<=r}shouldBreakPageBecauseOfGroup(t,e,r){if(t.hasGroupStart()){const i=t.getGroupBracket();if(i===null)throw new Error("Part should have group if it hasGroupStart");const a=i.getAllPartsHeight(r),l=a>e,d=a+this.currentSystemSize>e;if(l)return!1;if(d)return!0}return!1}getAvailableHeight(){return this.availableHeight===null?null:this.currentSystemIdx===0?this.availableHeight.firstSystem:this.availableHeight.otherSystems}getSystem(){if(this.currentSystemIdx===this.systems.length){const t=new s_(this.drawingContext,this.slice);this.systems.push(t),this.currentSystemSize=0,this.currentSystemIdx===0&&this.globalStaff&&t.setGlobalStaff(this.globalStaff)}return this.systems[this.currentSystemIdx]}removeEmptySystems(){for(let t=this.systems.length-1;t>=0;t--){const e=this.systems[t];e.isEmpty()&&(this.systems.splice(t,1),e.page&&e.page.removeSystem(e),e.getChildRoot().destroy())}}}var h_=Object.defineProperty,l_=(s,t,e)=>t in s?h_(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Xr=(s,t,e)=>l_(s,typeof t!="symbol"?t+"":t,e);class c_{constructor(t){Xr(this,"drawingContext"),Xr(this,"isFirst"),Xr(this,"displayMetrics"),Xr(this,"measures",[]),Xr(this,"globalStaff"),Xr(this,"parts"),Xr(this,"displayedParts",[]),Xr(this,"systems",[]),Xr(this,"currentWidth",0),Xr(this,"dirtyFlag",!0),this.drawingContext=t.drawingContext,this.isFirst=t.isFirst,this.displayMetrics=t.displayMetrics,this.parts=t.parts,this.globalStaff=new Y2(this.drawingContext)}markClean(){this.dirtyFlag=!1}isDirty(){return this.dirtyFlag}markDirty(){this.dirtyFlag||(this.dirtyFlag=!0,this.systems.forEach(t=>t.markDirty()))}setIsFirst(t){this.isFirst!==t&&this.markDirty(),this.isFirst=t}canAdd(t){if(this.measures.length===0)return!0;if(t.hasSystemBreakBefore()||t.hasPageBreakBefore()||this.getLastMeasure().hasSystemBreakAfter()||t.hasPageBreakAfter())return!1;const r=this.getAvailableWidth();return r===null?!0:!!this.canFitMeasure(t,r)}canFitMeasure(t,e){return t.getNominalWidthMidSystem()+this.currentWidth<=e}getMeasurePosition(){return this.measures.length===0?this.isFirst?vs.A.FIRST_OF_SCORE:vs.A.FIRST_OF_SYSTEM:vs.A.MIDDLE}getMaxNbMeasures(){return this.displayMetrics.sliceWidth===null?null:this.isFirst?this.drawingContext.getMaxNbMeasuresInFirstSystem():this.drawingContext.getMaxNbMeasuresInOtherSystems()}getAvailableWidth(){return w1(this.displayMetrics,this.isFirst)}getFirstMeasure(){return this.measures[0]}getLastMeasure(){return this.measures[this.measures.length-1]}removeMeasure(t){const e=this.measures.indexOf(t);if(e===-1)throw new Error("Measure not found");this.markDirty(),this.measures.splice(e,1),t.setParent(null),t.rawPartMeasures.forEach((r,i)=>{const a=r.getPartMeasures();a&&this.parts[i].removeMeasureAt(e,a)}),t.globalMeasure&&this.globalStaff.removeMeasureAt(e,t.globalMeasure)}removeGlobalMeasure(t){this.markDirty();const e=this.globalStaff.measures.indexOf(t);this.globalStaff.removeMeasureAt(e,t)}removePartMeasure(t,e){this.markDirty();const r=this.parts[t].staves[0].measures.indexOf(e[0]);this.parts[t].removeMeasureAt(r,e)}addMeasureAt(t,e){if(this.parts.length!==t.rawPartMeasures.length)throw new Error("Invalid number of parts");this.markDirty(),this.measures.splice(e,0,t),t.setParent(this),t.getPartMeasures().forEach((a,l)=>{const d=this.parts[l];t.hasUpdatedPartsFlag&&d.staves[0].hasMeasure(a[0])||d.addMeasureAt(a,e)});const i=t.getGlobalMeasure();(!t.hasUpdatedPartsFlag||!this.globalStaff.hasMeasure(i))&&this.globalStaff.addMeasureAt(i,e),t.hasUpdatedPartsFlag=!1}updateMeasureAt(t,e){if(this.parts.length!==t.rawPartMeasures.length)throw new Error("Invalid number of parts");if(this.measures[e]!==t)throw new Error("Measure not found");this.markDirty(),t.getPartMeasures().forEach((a,l)=>{const d=this.parts[l];d.staves[0].hasMeasure(a[0])||d.addMeasureAt(a,e)});const i=t.getGlobalMeasure();this.globalStaff.hasMeasure(i)||this.globalStaff.addMeasureAt(i,e),t.hasUpdatedPartsFlag=!1}addMeasure(t){if(this.parts.length!==t.rawPartMeasures.length)throw new Error("Invalid number of parts");t.hasUpdatedPartsFlag=!1,this.markDirty();const e=this.getMeasurePosition();t.setPosition(e),this.measures.push(t),t.setParent(this),t.getPartMeasures().forEach((a,l)=>{this.parts[l].addMeasure(a)}),this.currentWidth+=t.getNominalWidth();const i=t.getGlobalMeasure();this.globalStaff.addMeasure(i)}updateDisplayedParts(){this.displayedParts=V2({isFirstSlice:this.isFirst,layoutData:this.drawingContext.layoutData,displayMetrics:this.displayMetrics,parts:this.parts,formerDisplayedParts:this.displayedParts})}reloadCrossMeasures(){this.displayedParts.forEach(t=>t.reloadCrossMeasures()),this.globalStaff.reloadCrossMeasures()}formatHorizontal(){const t=this.getAvailableWidth();if(t===null)this.formatHorizontalNominal();else{const e=this.measures.map(a=>a.getNominalWidth()).reduce(Dt.default.add,0),r=t-e;if(r<=0){this.formatHorizontalNominal();return}const i=this.measures.map(a=>a.getFormatter());BA(i,r),this.displayedParts.forEach(a=>a.formatHorizontal()),this.globalStaff.formatHorizontal()}}formatHorizontalNominal(){this.measures.forEach(t=>t.resetNominalFormatting()),this.displayedParts.forEach(t=>t.formatHorizontal()),this.globalStaff.formatHorizontal()}formatPartsVertical(){this.displayedParts.forEach(e=>e.formatVertical());const t=this.displayMetrics.measuresPanel?null:this.displayedParts[0].getTopStaff().topHeights;this.globalStaff.formatVertical(t)}reflowPartsInSystems(){const t=this.getAvailableHeight();let e=null;this.displayMetrics.measuresPanel?this.displayMetrics.measuresPanel.setStaff(this.globalStaff):e=this.globalStaff,o_({drawingContext:this.drawingContext,slice:this,availableHeight:t,globalStaff:e})}getAvailableHeight(){if(this.displayMetrics.pageHeight===null)return null;if(this.isFirst){const t=this.displayMetrics.pageHeight-this.displayMetrics.firstHeaderFooterHeight,e=this.displayMetrics.pageHeight-this.displayMetrics.otherHeaderFooterHeight;return{firstSystem:t,otherSystems:e}}else{const t=this.displayMetrics.pageHeight-this.displayMetrics.otherHeaderFooterHeight;return{firstSystem:t,otherSystems:t}}}formatSystemsVertical(){this.systems.forEach(t=>t.formatVertical())}formatSystemsHeaders(){this.systems.forEach(t=>t.formatHeader())}hasSingleSystem(){return this.systems.length===1}hasPageBreakAfter(){return this.getLastMeasure().hasPageBreakAfter()}hasPageBreakBefore(){return this.getFirstMeasure().hasPageBreakBefore()}updateMeasuresNumbers(){this.measures.forEach((t,e)=>{const r=t.hasRehearsalMark(),i=this.displayMetrics.forceDisplayMeasureNumber,a=t.rawGlobalMeasure.measureUuid,l=this.displayMetrics.displayMeasureIdxMap.get(a);if(l===void 0)throw new Error(`Unknown measure uuid: ${a}`);const d=this.drawingContext.getMeasureNumber({displayMeasureIdx:l,isFirstSystem:this.isFirst,idxInSystem:e,isForcedDisplay:r,isSoftForcedDisplay:i});t.setMeasureNumber(d)})}}function u_(s,t){const e=d_(s,t.originMeasureIdx,t.spaceRight);return[...f_(s,t.originMeasureIdx,t.spaceLeft),...e]}function d_(s,t,e){const r=[];let i=e;for(let a=t;a<s.length&&i>0;a++){const l=s[a];let d;a===0?(l.setPosition(vs.A.FIRST_OF_SCORE),d=l.getNominalWidthMidSystem()):(l.setPosition(vs.A.MIDDLE),d=l.getNominalWidth()),i-=d,r.push(l)}return r}function f_(s,t,e){const r=[];let i=e;for(let a=t-1;a>=0&&i>0;a--){const l=s[a];let d;a===0?(l.setPosition(vs.A.FIRST_OF_SCORE),d=l.getNominalWidthMidSystem()):(l.setPosition(vs.A.MIDDLE),d=l.getNominalWidth()),i-=d,r.unshift(l)}return r}var g_=b(603371),p_=Object.defineProperty,m_=(s,t,e)=>t in s?p_(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Fi=(s,t,e)=>m_(s,typeof t!="symbol"?t+"":t,e);class y_{constructor(t){Fi(this,"sliceIdx",0),Fi(this,"measureIdx",0),Fi(this,"slices",[]),Fi(this,"measures"),Fi(this,"measuresSlice"),Fi(this,"drawingContext"),Fi(this,"displayMetrics"),Fi(this,"partsFactory"),this.measures=t.measures,this.measuresSlice=t.measures,this.drawingContext=t.drawingContext,this.displayMetrics=t.displayMetrics,this.partsFactory=t.partsFactory,this.updateMeasuresUuids()}setSliceIdxAfterSlice(t){const e=this.slices.indexOf(t);if(e===-1)throw new Error("Cannot set slice index after slice that is not in the list");this.setSliceIdx(e+1)}setSliceIdx(t){if(this.sliceIdx=t,this.sliceIdx>0){const r=this.slices[t-1].getLastMeasure();this.measureIdx=this.measuresSlice.indexOf(r)+1}else this.measureIdx=0}hasNext(){return this.measureIdx<this.measuresSlice.length}getNext(){const t=this.sliceIdx===0;let e;if(this.sliceIdx===this.slices.length){const r=this.partsFactory.createParts(t);e=new c_({drawingContext:this.drawingContext,isFirst:t,parts:r,displayMetrics:this.displayMetrics}),this.slices.push(e)}else e=this.slices[this.sliceIdx],e.setIsFirst(t);return this.sliceIdx++,e.isDirty()?((0,g_.A)(e,this.measuresSlice,this.measureIdx),e.updateDisplayedParts(),e.reloadCrossMeasures(),e.updateMeasuresNumbers(),e.formatHorizontal(),e.formatPartsVertical(),e.reflowPartsInSystems(),e.formatSystemsVertical(),e.formatSystemsHeaders(),e.markClean()):e.updateMeasuresNumbers(),this.measureIdx+=e.measures.length,this.markNextSliceDirtyIfNeeded(),e}markNextSliceDirtyIfNeeded(){if(this.sliceIdx>=this.slices.length||this.measureIdx>=this.measuresSlice.length)return;this.measuresSlice[this.measureIdx].parent===null&&this.slices[this.sliceIdx].markDirty()}getMeasure(t){return this.measures[t]}getNbMeasures(){return this.measures.length}insertMeasure(t,e){this.measures.splice(t,0,e),this.measuresSlice=this.measures}deleteMeasure(t){const[e]=this.measures.splice(t,1);e.destroy(),this.measuresSlice=this.measures}getMeasureIdxFromUuid(t){return this.measures.findIndex(e=>e.rawGlobalMeasure.measureUuid===t)}setMeasuresRange(t,e){this.measuresSlice=this.measures.slice(t,e),this.markAllDirty()}setSurfaceData(t){this.measuresSlice=u_(this.measures,t),this.markAllDirty()}removeMeasuresRange(){this.measuresSlice=this.measures}markAllDirty(){this.slices.forEach(t=>t.markDirty())}updateMeasuresUuids(){const t=this.measures.length;this.measures.forEach((e,r)=>{const i=r<t-1?this.measures[r+1].rawGlobalMeasure.measureUuid:null;e.setNextMeasureUuid(i)})}}var A_=Object.defineProperty,v_=(s,t,e)=>t in s?A_(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,FA=(s,t,e)=>v_(s,typeof t!="symbol"?t+"":t,e);class S_{constructor(t){FA(this,"slicesProvider"),FA(this,"cachedSystems",[]),this.slicesProvider=t}setSliceIdx(t){this.cachedSystems=[],this.slicesProvider.setSliceIdx(t)}setSliceIdxAfterSlice(t){this.cachedSystems=[],this.slicesProvider.setSliceIdxAfterSlice(t)}hasNext(){return this.cachedSystems.length>0||this.slicesProvider.hasNext()}getNext(){const t=this.cachedSystems.pop();if(t)return t;const e=this.slicesProvider.getNext();e.systems.forEach(a=>a.markClean());const[r,...i]=e.systems;return i.reverse(),this.cachedSystems=i,r}handback(t){this.cachedSystems.push(t)}}var w_=Object.defineProperty,x_=(s,t,e)=>t in s?w_(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Ui=(s,t,e)=>x_(s,typeof t!="symbol"?t+"":t,e);class b_{constructor(t,e,r,i,a){Ui(this,"drawingContext"),Ui(this,"partsData"),Ui(this,"displayMetrics"),Ui(this,"pages",[]),Ui(this,"pagesProvider"),Ui(this,"slicesProvider"),Ui(this,"tearDropCursorEntities",[]),Ui(this,"playbackSliderCursorEntity",null),this.drawingContext=t;const l=this.drawingContext.partsList();this.partsData=l===null?i:i.filter(m=>l.includes(m.uuid)),this.displayMetrics=e;const d=new jH(t,i);this.slicesProvider=new y_({measures:r,drawingContext:t,displayMetrics:e,partsFactory:d});const f=new S_(this.slicesProvider);this.pagesProvider=new N1(f,t,e,a)}setTearDropCursorEntities(t){this.tearDropCursorEntities=t}setPlaybackSliderCursorEntity(t){this.playbackSliderCursorEntity=t}setPageHeaderFooterFactory(t){this.pagesProvider.setPageHeaderFooterFactory(t)}dropDirtyPages(){this.pagesProvider.seekDirtyPage(),this.pages=this.pages.slice(0,this.pagesProvider.pageIdx)}getPage(t){for(;t>=this.pages.length&&this.pagesProvider.hasNext();){const r=this.pagesProvider.getNext();this.pages.push(r)}return t=Math.min(t,this.pages.length-1),{page:this.pages[t],pageIdx:t}}getMeasure(t){return this.slicesProvider.getMeasure(t)}getNbMeasures(){return this.slicesProvider.getNbMeasures()}getNbParts(){return this.partsData.length}insertMeasure(t,e){this.slicesProvider.insertMeasure(t,e)}deleteMeasure(t){this.slicesProvider.deleteMeasure(t)}getMeasureIdxFromUuid(t){return this.slicesProvider.getMeasureIdxFromUuid(t)}getPartIdxFromUuid(t){return this.partsData.findIndex(e=>e.uuid===t)}dropTrackPanels(){this.displayMetrics.measuresPanel&&(this.displayMetrics.measuresPanel.destroy(),this.displayMetrics.measuresPanel=null),this.displayMetrics.partsPanel&&(this.displayMetrics.partsPanel.destroy(),this.displayMetrics.partsPanel=null)}setMeasuresRange(t,e){this.slicesProvider.setMeasuresRange(t,e),this.dropDirtyPages()}setSurfaceData(t){this.slicesProvider.setSurfaceData(t),this.dropDirtyPages()}setPartPanelFormat(t){this.displayMetrics.partsPanel&&this.getFirstSystem().getHeader().setPartHeaderFormat(t)}removeMeasuresRange(){this.slicesProvider.removeMeasuresRange()}markAllDirty(){this.slicesProvider.markAllDirty(),this.dropDirtyPages()}updateMeasuresUuids(){this.slicesProvider.updateMeasuresUuids()}getFirstSystem(){const t=this.pages[0];if(!t)throw new Error("No First Page");if(t.isDirty()||!t.formattedFlag)throw new Error("First page is not rendered nor formatted");const e=t.systems[0];if(!e)throw new Error("No First System");return e}}var P_=Object.defineProperty,E_=(s,t,e)=>t in s?P_(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,UA=(s,t,e)=>E_(s,typeof t!="symbol"?t+"":t,e);class Op{constructor(t){UA(this,"textMetricProvider"),UA(this,"map",new Map),this.textMetricProvider=t}getComputedTextLength(t,e){const r=Op.getKey(t,e);let i=this.map.get(r);return typeof i=="undefined"&&(i=this.textMetricProvider.getComputedTextLength(t,e),this.map.set(r,i)),i}static getKey(t,e){return`${t}_${e.fontSize}_${e.fontFamily}_${e.bold}_${e.italic}`}}var D_=b(264389),C_=Object.defineProperty,T_=(s,t,e)=>t in s?C_(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,R_=(s,t,e)=>T_(s,typeof t!="symbol"?t+"":t,e);class N_{constructor(t){R_(this,"fontProvider"),this.fontProvider=t}getComputedTextLength(t,e){return this.getFont(e).getAdvanceWidth(t,e.fontSize)}getFont(t){return this.fontProvider.getFont(t.fontFamily,t.bold,t.italic)}}var L_=Object.defineProperty,M_=(s,t,e)=>t in s?L_(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,HA=(s,t,e)=>M_(s,typeof t!="symbol"?t+"":t,e);const O_=2;class B_{constructor(t){HA(this,"group"),HA(this,"staff",null),this.group=t.createGroupNode()}removeStaff(){this.staff!==null&&(it(this.group,this.staff.getChildRoot()),this.staff=null)}unlinkParentIfNeeded(){const t=this.group.getParent();t&&it(t,this.group)}destroy(){this.removeStaff(),this.unlinkParentIfNeeded(),this.group.destroy()}setStaff(t){t!==this.staff&&(this.staff=t,v(this.group,t.getChildRoot()))}getChildRoot(){return this.group}format(t){if(this.staff===null)throw new Error("Staff must be set before formatting");const e=this.staff.getTopHeight()+O_;this.staff.setY(e);const r={minX:0,minY:0,maxX:t,maxY:e};this.group.setBBoxOverride(r)}}var I_=Object.defineProperty,F_=(s,t,e)=>t in s?I_(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,_A=(s,t,e)=>F_(s,typeof t!="symbol"?t+"":t,e);class U_{constructor(t){_A(this,"rootGroup"),_A(this,"intraMarginGroup"),this.rootGroup=t.createGroupNode(),this.intraMarginGroup=t.createGroupNode(),v(this.rootGroup,this.intraMarginGroup)}getGroup(){return this.intraMarginGroup}getChildRoot(){return this.rootGroup}format(t){this.intraMarginGroup.setY(t.marginTop);const e={minX:0,minY:0,maxX:t.width,maxY:t.height};this.rootGroup.setBBoxOverride(e)}removeContent(){this.intraMarginGroup.children.slice().forEach(e=>{it(this.intraMarginGroup,e)})}unlinkParentIfNeeded(){const t=this.rootGroup.getParent();t&&it(t,this.rootGroup)}destroy(){this.removeContent(),this.unlinkParentIfNeeded(),this.rootGroup.destroy()}}function H_(s){return typeof s=="object"&&"positionA"in s&&"positionB"in s}var __=Object.defineProperty,G_=(s,t,e)=>t in s?__(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Uu=(s,t,e)=>G_(s,typeof t!="symbol"?t+"":t,e);function X_(s,t,e){const r=new W_(s,t);return r.process(e),r.getResult()}class W_{constructor(t,e){Uu(this,"pageIdx",0),Uu(this,"request"),Uu(this,"scoreDrawer"),Uu(this,"result",null),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.MEASURES_HEADER))return;this.pageIdx=N.A.MEASURES_HEADER;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const e=t.slice,r=e.measures.findIndex(w=>w.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r===-1)return;const l=e.globalStaff.measures[r].barlineRepeatNbTimes;if(l===null)return!0;const d=l.getChildRoot(),f=d.getLocalBBox();if(f===null)throw new Error("Unexpected");const m=rt(d),S={minX:m.x+f.minX,minY:m.y+f.minY,maxX:m.x+f.maxX,maxY:m.y+f.maxY};return this.result={entityType:T.A.BARLINE_REPEAT_TIMES,pageIdx:this.pageIdx,bbox:S},!0}getResult(){return this.result}}var z_=Object.defineProperty,Y_=(s,t,e)=>t in s?z_(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Hu=(s,t,e)=>Y_(s,typeof t!="symbol"?t+"":t,e);function k_(s,t,e){const r=new q_(s,t);return r.process(e),r.getResult()}class q_{constructor(t,e){Hu(this,"pageIdx",0),Hu(this,"request"),Hu(this,"scoreDrawer"),Hu(this,"result",null),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const r=t.slice.measures.findIndex(d=>d.rawGlobalMeasure.measureUuid===this.request.measureUuid),i=t.parts.find(d=>d.partData.uuid===this.request.partUuid);if(!i)return;const a=i.staves.find(d=>d.staffData.uuid===this.request.staffUuid);if(!a||r===-1)return;const l=a.measures[r];if(this.request.entityUuid!==null){const{tickableContent:d}=l,{middleClefs:f}=d,m=f.find(S=>S.getUuid()===this.request.entityUuid);if(m)return this.createResultFromCandidate({pageIdx:this.pageIdx,clef:m}),!0}if(this.request.side==="left"&&l.leftAttributes!==null){const d=l.leftAttributes.children.find(f=>f instanceof Li);if(d)return this.createResultFromCandidate({pageIdx:this.pageIdx,clef:d}),!0}if(this.request.side==="right"&&r>0){const d=a.measures[r-1];if(d.rightInternalAttributes===null)return;const f=d.rightInternalAttributes.children.find(m=>m instanceof Li);if(f)return this.createResultFromCandidate({pageIdx:this.pageIdx,clef:f}),!0}}createResultFromCandidate(t){const{clef:e}=t,r=e.getChildRoot(),i=r.getLocalBBox();if(i===null)throw new Error("Unexpected");const a=rt(r),l={minX:a.x+i.minX,minY:a.y+i.minY,maxX:a.x+i.maxX,maxY:a.y+i.maxY};this.result={entityType:T.A.CLEF,pageIdx:t.pageIdx,bbox:l}}getResult(){return this.result}}var V_=Object.defineProperty,Q_=(s,t,e)=>t in s?V_(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,_u=(s,t,e)=>Q_(s,typeof t!="symbol"?t+"":t,e);const GA=2,K_=.5;function J_(s,t,e){const r=new $_(s,t);return r.process(e),r.getResult()}class $_{constructor(t,e){_u(this,"pageIdx",0),_u(this,"request"),_u(this,"scoreDrawer"),_u(this,"result",null),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const r=t.slice.measures.findIndex(At=>At.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r===-1)return;const i=t.parts.find(At=>At.partData.uuid===this.request.partUuid);if(!i)return;const a=i.getBottomStaff(),l=a.measures[r],{tickableContent:d}=l,f=d.dpq,m=Dt.default.lcm(f,this.request.dpq),S=this.request.timePos*(m/this.request.dpq),w=m/f,x=d.figuredBasses.find(At=>At.getTimePos()*w===S)||null;if(x){const At=x.getFigureAtLevel(this.request.level);if(At){const Jt=At.getChildRoot(),re=Jt.getLocalBBox();if(re===null)throw new Error("Unexpected");const ds=rt(Jt),ws={minX:ds.x+re.minX,minY:ds.y+re.minY-Jc/2,maxX:ds.x+re.maxX,maxY:ds.y+re.maxY-Jc/2},xh=d.drawingContext.getFiguredBassFontOptions();return this.result={entityType:T.A.FIGURED_BASS,pageIdx:this.pageIdx,bbox:ws,fontOptions:xh},!0}}const D=rt(d.getChildRoot()),L=d.horizontalFormatter;if(L===null)throw new Error("Formatter is null");const M=d.drawingContext.getFiguredBassFontOptions(),H=L.getPosX(S,m),$=H+d.getX()+l.getX(),lt=j_(a,$),gt=Jc*this.request.level,yt=lt+gt,dt={minX:H+D.x,minY:yt+D.y,maxX:H+D.x+GA,maxY:yt+D.y};return this.result={entityType:T.A.FIGURED_BASS,pageIdx:this.pageIdx,bbox:dt,fontOptions:M},!0}getResult(){return this.result}}function Z_(s,t){const e=s.bottomHeights.getMaxHeightInRange(t,GA);return s.getStaffHeight()+e+K_}function j_(s,t){const e=s.measures.find(i=>i.tickableContent.hasFiguredBasses());return e?e.tickableContent.figuredBasses[0].getYPosition():Z_(s,t)}var tG=Object.defineProperty,eG=(s,t,e)=>t in s?tG(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Gu=(s,t,e)=>eG(s,typeof t!="symbol"?t+"":t,e);const XA=2,sG=.5;function rG(s,t,e){const r=new iG(s,t);return r.process(e),r.getResult()}class iG{constructor(t,e){Gu(this,"pageIdx",0),Gu(this,"request"),Gu(this,"scoreDrawer"),Gu(this,"result",null),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const r=t.slice.measures.findIndex(dt=>dt.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r===-1)return;const i=t.parts.find(dt=>dt.partData.uuid===this.request.partUuid);if(!i)return;const a=i.getTopStaff(),l=a.measures[r],{tickableContent:d}=l,f=d.dpq,m=Dt.default.lcm(f,this.request.dpq),S=this.request.timePos*(m/this.request.dpq),w=m/f,x=d.jazzHarmonies.find(dt=>dt.getTimePos()*w===S)||null;if(x){const dt=x.getChildRoot(),At=dt.getLocalBBox();if(At===null)throw new Error("Unexpected");const Jt=rt(dt),re={minX:Jt.x+At.minX,minY:Jt.y+At.minY,maxX:Jt.x+At.maxX,maxY:Jt.y+At.maxY};return this.result={entityType:T.A.JAZZ_HARMONY,pageIdx:this.pageIdx,bbox:re},!0}const D=rt(d.getChildRoot()),L=d.horizontalFormatter;if(L===null)throw new Error("Formatter is null");const M=L.getPosX(S,m),H=M+d.getX()+l.getX();let $,lt=null;a.measures.some(dt=>{dt.tickableContent.jazzHarmonies.some(At=>(lt=At,!0))});const gt=d.drawingContext.getChordsFontOptions();if(lt)$=lt.getChildRoot().getY();else{const dt=a.initialBottomHeights.getMaxHeightInRange(H,XA);$=a.getStaffHeight()+dt+sG+gt.fontSize*2/3}const yt={minX:M+D.x,minY:$+D.y-gt.fontSize*2/3,maxX:M+D.x+XA,maxY:$+D.y+gt.fontSize*1/3};return this.result={entityType:T.A.JAZZ_HARMONY,pageIdx:this.pageIdx,bbox:yt},!0}getResult(){return this.result}}var nG=Object.defineProperty,oG=(s,t,e)=>t in s?nG(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,xo=(s,t,e)=>oG(s,typeof t!="symbol"?t+"":t,e);function aG(s,t,e){const r=new hG(s,t);return r.process(e),r.getResult()}class hG{constructor(t,e){xo(this,"pageIdx",0),xo(this,"request"),xo(this,"scoreDrawer"),xo(this,"result",null),xo(this,"rightCandidate",null),xo(this,"leftCandidate",null),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this);this.createResult()}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const e=t.slice,r=e.measures.findIndex(d=>d.rawGlobalMeasure.measureUuid===this.request.measureUuid),i=e.measures.findIndex(d=>d.rawGlobalMeasure.nextMeasureUuid===this.request.measureUuid);if(r===-1&&i===-1)return;const a=t.parts.find(d=>d.partData.uuid===this.request.partUuid);if(!a)return;const l=a.staves.find(d=>d.staffData.uuid===this.request.staffUuid);if(l){if(i!==-1){const d=l.measures[i];if(d.rightExternalAttributes!==null){const f=d.rightExternalAttributes.children.find(m=>m instanceof jl);f&&(this.rightCandidate={pageIdx:this.pageIdx,key:f})}}if(r!==-1){const d=l.measures[r];if(d.leftAttributes!==null){const f=d.leftAttributes.children.find(m=>m instanceof jl);f&&(this.leftCandidate={pageIdx:this.pageIdx,key:f})}return!0}}}createResult(){const t=this.getCandidate();t&&this.createResultFromCandidate(t)}getCandidate(){if(this.request.side==="left")return this.leftCandidate||this.rightCandidate;if(this.request.side==="right")return this.rightCandidate||this.leftCandidate;throw new Error("Unexpected")}createResultFromCandidate(t){const{key:e}=t,r=e.getChildRoot(),i=r.getLocalBBox();if(i===null)throw new Error("Unexpected");const a=rt(r),l={minX:a.x+i.minX,minY:a.y+i.minY,maxX:a.x+i.maxX,maxY:a.y+i.maxY};this.result={entityType:T.A.KEY_SIGNATURE,pageIdx:t.pageIdx,bbox:l}}getResult(){return this.result}}var lG=Object.defineProperty,cG=(s,t,e)=>t in s?lG(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Xu=(s,t,e)=>cG(s,typeof t!="symbol"?t+"":t,e);const WA=.1,uG=.5,dG=.3;function fG(s,t,e){const r=new gG(s,t);return r.process(e),r.getResult()}class gG{constructor(t,e){Xu(this,"pageIdx",0),Xu(this,"request"),Xu(this,"scoreDrawer"),Xu(this,"result",null),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const r=t.slice.measures.findIndex(yt=>yt.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r===-1)return;const i=t.parts.find(yt=>yt.partData.uuid===this.request.partUuid);if(!i)return;const a=i.staves.find(yt=>yt.staffData.uuid===this.request.staffUuid);if(!a)return;const l=a.measures[r],d=Array.from(l.tickableContent.voices.values()).find(yt=>yt instanceof Bt?yt.getVoiceUuid()===this.request.voiceUuid:!1);if(!d)return;const f=d.getLyricByNoteIdx(this.request.noteIdx);if(f){const yt=f.getLyricLine(this.request.level);if(yt){const dt=yt.getChildRoot(),At=dt.getLocalBBox();if(At===null)throw new Error("Unexpected");const Jt=rt(dt),re={minX:Jt.x+At.minX,minY:Jt.y+At.minY,maxX:Jt.x+At.maxX,maxY:Jt.y+At.maxY},ds=structuredClone(yt.textNode.options);return this.result={entityType:T.A.LYRIC,pageIdx:this.pageIdx,bbox:re,fontOptions:ds},!0}}const m=rt(d.getChildRoot());if(d.horizontalFormatter===null)throw new Error("Formatter is null");const w=d.drawingContext.getTextAnnotationsFontOptions(),x=w.fontSize,L=d.getNote(this.request.noteIdx).getPosition(),M=L+l.getX(),H=mG(a,d.getVoiceIdx(),M),$=x*(this.request.level+1)+dG*this.request.level,lt=H+$,gt={minX:L+m.x,minY:lt+m.y-x,maxX:L+m.x+WA,maxY:lt+m.y+x};return this.result={entityType:T.A.LYRIC,pageIdx:this.pageIdx,bbox:gt,fontOptions:w},!0}getResult(){return this.result}}function pG(s,t){const e=s.bottomHeights.getMaxHeightInRange(t,WA);return s.getStaffHeight()+e+uG}function mG(s,t,e){const r=s.measures.find(a=>{const l=a.tickableContent.getVoicesLyrics(t);return l&&l.length>0});return r?r.tickableContent.getVoicesLyrics(t)[0].getYPosition():pG(s,e)}var yG=Object.defineProperty,AG=(s,t,e)=>t in s?yG(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Wu=(s,t,e)=>AG(s,typeof t!="symbol"?t+"":t,e);function vG(s,t,e){const r=new SG(s,t);return r.process(e),r.getResult()}class SG{constructor(t,e){Wu(this,"pageIdx",0),Wu(this,"request"),Wu(this,"scoreDrawer"),Wu(this,"result",null),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const r=t.slice.measures.findIndex(D=>D.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r===-1)return;const i=t.parts.find(D=>D.partData.uuid===this.request.partUuid);if(!i)return;const a=i.staves.find(D=>D.staffData.uuid===this.request.staffUuid);if(!a)return;const d=a.measures[r].tickableContent.getVoice(0);if(!(d instanceof sc))return;const f=d.entity;if(f===null||!(f instanceof Ig))return;const m=f.getChildRoot(),S=m.getLocalBBox();if(S===null)throw new Error("Unexpected");const w=rt(m),x={minX:w.x+S.minX,minY:w.y+S.minY,maxX:w.x+S.maxX,maxY:w.y+S.maxY};return this.result={entityType:T.A.MULTI_MEASURE_REST,pageIdx:this.pageIdx,bbox:x},!0}getResult(){return this.result}}function wG(s){const t=s.playbackSliderCursorEntity;if(!t)return null;const e=t.node,r=e.getLocalBBox();if(r===null)throw new Error("Unexpected null bounding box for playback slider");const i=rt(e),a={minX:i.x+r.minX,minY:i.y+r.minY,maxX:i.x+r.maxX,maxY:i.y+r.maxY};return{entityType:T.A.PLAYBACK_SLIDER,pageIdx:t.pageIdx,bbox:a}}var xG=Object.defineProperty,bG=(s,t,e)=>t in s?xG(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,zu=(s,t,e)=>bG(s,typeof t!="symbol"?t+"":t,e);function PG(s,t,e){const r=new EG(s,t);return r.process(e),r.getResult()}class EG{constructor(t,e){zu(this,"pageIdx",0),zu(this,"request"),zu(this,"scoreDrawer"),zu(this,"result",null),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.MEASURES_HEADER))return;this.pageIdx=N.A.MEASURES_HEADER;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const e=t.slice,r=e.measures.findIndex(w=>w.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r===-1)return;const l=e.globalStaff.measures[r].rehearsal;if(l===null)return!0;const d=l.getChildRoot(),f=d.getLocalBBox();if(f===null)throw new Error("Unexpected");const m=rt(d),S={minX:m.x+f.minX,minY:m.y+f.minY,maxX:m.x+f.maxX,maxY:m.y+f.maxY};return this.result={entityType:T.A.REHEARSAL,pageIdx:this.pageIdx,bbox:S},!0}getResult(){return this.result}}var DG=Object.defineProperty,CG=(s,t,e)=>t in s?DG(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Yu=(s,t,e)=>CG(s,typeof t!="symbol"?t+"":t,e);const zA=2,TG=.5;function RG(s,t,e){const r=new NG(s,t);return r.process(e),r.getResult()}class NG{constructor(t,e){Yu(this,"pageIdx",0),Yu(this,"request"),Yu(this,"scoreDrawer"),Yu(this,"result",null),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const r=t.slice.measures.findIndex(dt=>dt.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r===-1)return;const i=t.parts.find(dt=>dt.partData.uuid===this.request.partUuid);if(!i)return;const a=i.getBottomStaff(),l=a.measures[r],{tickableContent:d}=l,f=d.dpq,m=Dt.default.lcm(f,this.request.dpq),S=this.request.timePos*(m/this.request.dpq),w=m/f,x=d.romanNumerals.find(dt=>dt.getTimePos()*w===S)||null;if(x){const dt=x.getChildRoot(),At=dt.getLocalBBox();if(At===null)throw new Error("Unexpected");const Jt=rt(dt),re={minX:Jt.x+At.minX,minY:Jt.y+At.minY,maxX:Jt.x+At.maxX,maxY:Jt.y+At.maxY};return this.result={entityType:T.A.ROMAN_NUMERAL,pageIdx:this.pageIdx,bbox:re},!0}const D=rt(d.getChildRoot()),L=d.horizontalFormatter;if(L===null)throw new Error("Formatter is null");const M=L.getPosX(S,m),H=M+d.getX()+l.getX();let $,lt=null;a.measures.some(dt=>{dt.tickableContent.romanNumerals.some(At=>(lt=At,!0))});const gt=d.drawingContext.getChordsFontOptions();if(lt)$=lt.getChildRoot().getY();else{const dt=a.initialBottomHeights.getMaxHeightInRange(H,zA);$=a.getStaffHeight()+dt+TG+gt.fontSize*2/3}const yt={minX:M+D.x,minY:$+D.y-gt.fontSize*2/3,maxX:M+D.x+zA,maxY:$+D.y+gt.fontSize*1/3};return this.result={entityType:T.A.ROMAN_NUMERAL,pageIdx:this.pageIdx,bbox:yt},!0}getResult(){return this.result}}var LG=Object.defineProperty,MG=(s,t,e)=>t in s?LG(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,ku=(s,t,e)=>MG(s,typeof t!="symbol"?t+"":t,e);function OG(s,t,e){const r=new BG(s,t);return r.process(e),r.getResult()}class BG{constructor(t,e){ku(this,"pageIdx",0),ku(this,"request"),ku(this,"scoreDrawer"),ku(this,"result",null),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const r=t.slice.measures.findIndex(w=>w.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r===-1)return;const i=t.parts.find(w=>w.partData.uuid===this.request.partUuid);if(!i)return;const a=i.staves.find(w=>w.staffData.uuid===this.request.staffUuid);if(!a)return;const l=a.measures[r];if(!l)return;const d=l.getChildRoot(),f=d.getLocalBBox();if(f===null)throw new Error("Unexpected null bounding box");const m=rt(d),S={minX:m.x+f.minX,minY:m.y+f.minY,maxX:m.x+f.maxX,maxY:m.y+f.maxY};return this.result={entityType:T.A.STAFF_MEASURE,pageIdx:this.pageIdx,bbox:S},!0}getResult(){return this.result}}function IG(s){const t=s.tearDropCursorEntities[0];if(!t)return null;const e=t.node,r=e.getLocalBBox();if(r===null)throw new Error("Unexpected null bounding box");const i=rt(e),a={minX:i.x+r.minX,minY:i.y+r.minY,maxX:i.x+r.maxX,maxY:i.y+r.maxY};return{entityType:T.A.TEARDROP_CURSOR,pageIdx:t.pageIdx,bbox:a}}var FG=Object.defineProperty,UG=(s,t,e)=>t in s?FG(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,qu=(s,t,e)=>UG(s,typeof t!="symbol"?t+"":t,e);function HG(s,t,e){const r=new _G(s,t);return r.process(e),r.getResult()}class _G{constructor(t,e){qu(this,"pageIdx",0),qu(this,"request"),qu(this,"scoreDrawer"),qu(this,"result",null),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.MEASURES_HEADER))return;this.pageIdx=N.A.MEASURES_HEADER;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const e=t.slice,r=e.measures.findIndex(w=>w.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r===-1)return;const a=e.globalStaff.measures[r];if(a.metronome===null)return!0;const l=a.metronome.tempo;if(l===null)return!0;const d=l.getChildRoot(),f=d.getLocalBBox();if(f===null)throw new Error("Unexpected");const m=rt(d),S={minX:m.x+f.minX,minY:m.y+f.minY,maxX:m.x+f.maxX,maxY:m.y+f.maxY};return this.result={entityType:T.A.TEMPO,pageIdx:this.pageIdx,bbox:S},!0}getResult(){return this.result}}var GG=Object.defineProperty,XG=(s,t,e)=>t in s?GG(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Vu=(s,t,e)=>XG(s,typeof t!="symbol"?t+"":t,e);const Bp=.1,YA=.5;function WG(s,t,e){const r=new zG(s,t);return r.process(e),r.getResult()}class zG{constructor(t,e){Vu(this,"pageIdx",0),Vu(this,"request"),Vu(this,"scoreDrawer"),Vu(this,"result",null),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const r=t.slice.measures.findIndex(yt=>yt.rawGlobalMeasure.measureUuid===this.request.measureUuid);if(r===-1)return;const i=t.parts.find(yt=>yt.partData.uuid===this.request.partUuid);if(!i)return;const a=i.staves.find(yt=>yt.staffData.uuid===this.request.staffUuid);if(!a)return;const l=a.measures[r],{tickableContent:d}=l,f=d.dpq,m=Dt.default.lcm(f,this.request.dpq),S=this.request.timePos*(m/this.request.dpq),w=m/f;let x=null;if(this.request.placement===I.A.ABOVE)x=d.textAnnotationsAbove.find(yt=>yt.getTimePos()*w===S)||null;else if(this.request.placement===I.A.BELOW)x=d.textAnnotationsBelow.find(yt=>yt.getTimePos()*w===S)||null;else throw I.A.raiseError(this.request.placement);if(x){const yt=x.getChildRoot(),dt=yt.getLocalBBox();if(dt===null)throw new Error("Unexpected");const At=rt(yt),Jt={minX:At.x+dt.minX,minY:At.y+dt.minY,maxX:At.x+dt.maxX,maxY:At.y+dt.maxY},re=structuredClone(x.textNode.options);return this.result={entityType:T.A.TEXT_ANNOTATION,pageIdx:this.pageIdx,bbox:Jt,fontOptions:re},!0}const D=rt(d.getChildRoot()),L=d.horizontalFormatter;if(L===null)throw new Error("Formatter is null");const M=d.drawingContext.getTextAnnotationsFontOptions(),H=L.getPosX(S,m),$=H+d.getX()+l.getX();let lt;if(this.request.placement===I.A.ABOVE)lt=-a.initialTopHeights.getMaxHeightInRange($,Bp)-YA-M.fontSize*1/3;else if(this.request.placement===I.A.BELOW){const yt=a.initialBottomHeights.getMaxHeightInRange($,Bp);lt=a.getStaffHeight()+yt+YA+M.fontSize*2/3}else throw I.A.raiseError(this.request.placement);const gt={minX:H+D.x,minY:lt+D.y-M.fontSize*2/3,maxX:H+D.x+Bp,maxY:lt+D.y+M.fontSize*1/3};return this.result={entityType:T.A.TEXT_ANNOTATION,pageIdx:this.pageIdx,bbox:gt,fontOptions:M},!0}getResult(){return this.result}}var YG=Object.defineProperty,kG=(s,t,e)=>t in s?YG(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,bo=(s,t,e)=>kG(s,typeof t!="symbol"?t+"":t,e);function qG(s,t,e){const r=new VG(s,t);return r.process(e),r.getResult()}class VG{constructor(t,e){bo(this,"pageIdx",0),bo(this,"request"),bo(this,"scoreDrawer"),bo(this,"result",null),bo(this,"rightCandidate",null),bo(this,"leftCandidate",null),this.request=t,this.scoreDrawer=e}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this);this.createResult()}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}processSystem(t){const e=t.slice,r=e.measures.findIndex(d=>d.rawGlobalMeasure.measureUuid===this.request.measureUuid),i=e.measures.findIndex(d=>d.rawGlobalMeasure.nextMeasureUuid===this.request.measureUuid);if(r===-1&&i===-1)return;const a=t.parts.find(d=>d.partData.uuid===this.request.partUuid);if(!a)return;const l=a.staves.find(d=>d.staffData.uuid===this.request.staffUuid);if(l){if(i!==-1){const d=l.measures[i];if(d.rightExternalAttributes!==null){const f=d.rightExternalAttributes.children.find(m=>m instanceof Sc);f&&(this.rightCandidate={pageIdx:this.pageIdx,time:f})}}if(r!==-1){const d=l.measures[r];if(d.leftAttributes!==null){const f=d.leftAttributes.children.find(m=>m instanceof Sc);f&&(this.leftCandidate={pageIdx:this.pageIdx,time:f})}return!0}}}createResult(){const t=this.getCandidate();t&&this.createResultFromCandidate(t)}getCandidate(){if(this.request.side==="left")return this.leftCandidate||this.rightCandidate;if(this.request.side==="right")return this.rightCandidate||this.leftCandidate;throw new Error("Unexpected")}createResultFromCandidate(t){const{time:e}=t,r=e.getChildRoot(),i=r.getLocalBBox();if(i===null)throw new Error("Unexpected");const a=rt(r),l={minX:a.x+i.minX,minY:a.y+i.minY,maxX:a.x+i.maxX,maxY:a.y+i.maxY};this.result={entityType:T.A.TIME_SIGNATURE,pageIdx:t.pageIdx,bbox:l}}getResult(){return this.result}}function kA(s,t,e){const r=s.entityType;switch(r){case T.A.TEXT_ANNOTATION:return WG(s,t,e);case T.A.LYRIC:return fG(s,t,e);case T.A.JAZZ_HARMONY:return rG(s,t,e);case T.A.ROMAN_NUMERAL:return RG(s,t,e);case T.A.FIGURED_BASS:return J_(s,t,e);case T.A.KEY_SIGNATURE:return aG(s,t,e);case T.A.CLEF:return k_(s,t,e);case T.A.TIME_SIGNATURE:return qG(s,t,e);case T.A.TEMPO:return HG(s,t,e);case T.A.MULTI_MEASURE_REST:return vG(s,t,e);case T.A.REHEARSAL:return PG(s,t,e);case T.A.STAFF_MEASURE:return OG(s,t,e);case T.A.TEARDROP_CURSOR:return IG(t);case T.A.PLAYBACK_SLIDER:return wG(t);case T.A.BARLINE_REPEAT_TIMES:return X_(s,t,e);default:throw new Error(`Unsupported entity type: ${r}`)}}function QG(s,t,e){const r=[];for(const i of e){const a=i.rawGlobalMeasure.measureUuid;if((r.length>0||a===s)&&r.push(i.rawGlobalMeasure.measureUuid),a===t)return r}throw new Error(`Measures with UUIDs ${s} and ${t} not found in the slices provider.`)}var KG=Object.defineProperty,JG=(s,t,e)=>t in s?KG(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,li=(s,t,e)=>JG(s,typeof t!="symbol"?t+"":t,e);const qA=.7;function $G(s,t,e){const r=new ZG(s,t);return r.process(e),r.getResult()}function VA(s,t){return`${s}-${t}`}class ZG{constructor(t,e){li(this,"pageIdx",0),li(this,"request"),li(this,"scoreDrawer"),li(this,"resultSlices",new Map),li(this,"measureUuids",[]),li(this,"partStavesSet"),li(this,"firstSlice",null),li(this,"lastSlice",null),li(this,"isOngoing",!1),this.request=t,this.scoreDrawer=e,this.measureUuids=QG(t.startMeasureUuid,t.stopMeasureUuid,e.slicesProvider.measures),this.partStavesSet=new Set(t.partStaves.map(({partUuid:r,staffUuid:i})=>VA(r,i)))}process(t){if(this.scoreDrawer.displayMetrics.partsPanel||this.scoreDrawer.displayMetrics.measuresPanel){if(!t.includes(N.A.CONTENT))return;this.pageIdx=N.A.CONTENT;const e=this.scoreDrawer.getFirstSystem();this.processSystem(e)}else t.some(this.processPageIndex,this)}processPageIndex(t){return this.pageIdx=t,this.scoreDrawer.pages[t].systems.some(this.processSystem,this)}checkFirstSlice(t){t.measures.findIndex(r=>r.rawGlobalMeasure.measureUuid===this.request.startMeasureUuid)!==-1&&(this.firstSlice=t)}checkLastSlice(t){t.measures.findIndex(r=>r.rawGlobalMeasure.measureUuid===this.request.stopMeasureUuid)!==-1&&(this.lastSlice=t)}isSliceInRange(t){return t.measures.some(e=>this.measureUuids.includes(e.rawGlobalMeasure.measureUuid))}processSystem(t){var e;const r=t.slice;if(this.firstSlice||this.checkFirstSlice(r),this.lastSlice||this.checkLastSlice(r),this.lastSlice&&r!==this.lastSlice&&!this.isSliceInRange(r))return!0;if(!this.firstSlice&&!this.isOngoing&&!this.isSliceInRange(r))return!1;this.isOngoing=!0;let i,a=this.request.startTimePos,l=this.request.startDpq;this.firstSlice&&r===this.firstSlice?i=r.measures.findIndex(S=>S.rawGlobalMeasure.measureUuid===this.request.startMeasureUuid):(i=0,a=0,l=1);let d,f=this.request.stopTimePos,m=this.request.stopDpq;if(this.lastSlice&&r===this.lastSlice)d=r.measures.findIndex(S=>S.rawGlobalMeasure.measureUuid===this.request.stopMeasureUuid);else{d=r.measures.length-1;const S=r.measures[d],w=(e=S==null?void 0:S.formatter)==null?void 0:e.tickableFormatter;if(!w)throw new Error("Tickable formatter is not defined for the last measure");f=w.getNbDivisions(),m=w.getDpq()}t.parts.forEach(S=>{S.staves.forEach(w=>{const x=VA(S.partData.uuid,w.staffData.uuid);this.partStavesSet.has(x)&&this.processStaff({slice:r,staff:w,partUuid:S.partData.uuid,staffUuid:w.staffData.uuid,startMeasureIdx:i,startTimePos:a,startDpq:l,stopMeasureIdx:d,stopTimePos:f,stopDpq:m})})})}processStaff(t){const e=rt(t.staff.getChildRoot()),r=e.y,i=r+t.staff.getStaffHeight(),a=t.staff.getMeasure(t.startMeasureIdx),l=a.tickableContent,d=l.horizontalFormatter;if(d===null)throw new Error("Formatter is null");const f=d.getDpq(),m=Dt.default.lcm(f,t.startDpq),S=t.startTimePos*m/t.startDpq,w=e.x+d.getPosX(S,m)+a.getChildRoot().getX()+l.getChildRoot().getX()-qA,x=t.staff.getMeasure(t.stopMeasureIdx),D=x.tickableContent,L=D.horizontalFormatter;if(L===null)throw new Error("Formatter is null");const M=L.getDpq(),H=Dt.default.lcm(M,t.stopDpq),$=t.stopTimePos*H/t.stopDpq,lt=e.x+L.getPosX($,H)+x.getChildRoot().getX()+D.getChildRoot().getX()-qA;let gt=this.resultSlices.get(t.slice);gt||(gt={isStart:t.slice===this.firstSlice,isStop:t.slice===this.lastSlice,partStaves:[]},this.resultSlices.set(t.slice,gt)),gt.partStaves.push({partUuid:t.partUuid,staffUuid:t.staffUuid,pageIdx:this.pageIdx,bbox:{minX:w,minY:r,maxX:lt,maxY:i}})}getResult(){if(this.resultSlices.size===0)return null;const t=Array.from(this.resultSlices.values());return{entityType:T.A.RANGE_SELECTION,slices:t}}}function jG(s,t,e){const r=s.entityType;switch(r){case T.A.RANGE_SELECTION:return $G(s,t,e);default:throw new Error(`Unsupported entity type: ${r}`)}}function QA(s,t,e){const r=new Map;return s.forEach((i,a)=>{const l=jG(i,t,e);l&&r.set(a,l)}),r}var tX=b(306563),Po=b(304713);function eX(s,t){const e=sX(s,t.measureIdx);e&&e.parent&&e.parent.markDirty();const r=rX(s,t.measureIdx);r&&r.parent&&r.parent.markDirty();const i=iX(s,t);s.insertMeasure(t.measureIdx,i)}function sX(s,t){return t===0?null:s.getMeasure(t-1)}function rX(s,t){const e=s.getNbMeasures();return t===e?null:s.getMeasure(t)}function iX(s,t){const e=t.data.uuid,r=new Yg(e);t.globalMeasureData&&r.setData(t.globalMeasureData);const i=new _y(s.drawingContext,s.partsData,r);return t.partsMeasure.forEach((a,l)=>{const d=new xp({partUuid:s.partsData[l].uuid,measureUuid:e});typeof a!="string"&&d.setData(a),i.rawPartMeasures.push(d)}),i.setNbMeasures(t.data.nbMeasures),i}function nX(s,t){const e=s.getPartIdxFromUuid(t.partUuid),r=s.partsData[e],i=r.staves.findIndex(l=>l.uuid===t.staffUuid);if(i===-1)throw new Error(`Staff ${t.staffUuid} not found in part ${r.uuid}`);const a={partIdx:e,staffIdx:i};oX(s,t,a),aX(s,t,a)}function oX(s,t,e){const r=s.partsData[e.partIdx];if(r.voiceUuidMapping.has(t.voiceIdx))throw new Error(`Voice index ${t.voiceIdx} already exists in part ${r.uuid}`);const i=r.stavesVoices[e.partIdx];if(t.idxInStaff<0||t.idxInStaff>i.length)throw new Error(`Invalid index ${t.idxInStaff} for staff ${t.staffUuid} in part ${r.uuid}`);i.splice(t.idxInStaff,0,t.voiceIdx),r.voiceUuidMapping.set(t.voiceIdx,t.voiceUuid)}function aX(s,t,e){s.slicesProvider.slices.forEach(r=>{r.parts[e.partIdx].staves[e.staffIdx].addVoice(t.voiceIdx,t.idxInStaff)})}function hX(s,t){const e=s.getMeasureIdxFromUuid(t.measureUuid),r=s.getMeasure(e);r.parent&&r.parent.removeMeasure(r),s.deleteMeasure(e)}function lX(s,t){const e=s.getPartIdxFromUuid(t.partUuid),r=s.partsData[e],i=r.staves.findIndex(l=>l.uuid===t.staffUuid);if(i===-1)throw new Error(`Staff ${t.staffUuid} not found in part ${r.uuid}`);const a={partIdx:e,staffIdx:i};cX(s,t,a),uX(s,t,a)}function cX(s,t,e){const r=s.partsData[e.partIdx];if(!r.voiceUuidMapping.has(t.voiceIdx))throw new Error(`Voice index ${t.voiceIdx} does not exist in part ${r.uuid}`);const i=r.stavesVoices[e.staffIdx],a=i.indexOf(t.voiceIdx);if(a===-1)throw new Error(`Voice index ${t.voiceIdx} not found in staff ${t.staffUuid} of part ${r.uuid}`);i.splice(a,1),r.voiceUuidMapping.delete(t.voiceIdx)}function uX(s,t,e){s.slicesProvider.slices.forEach(r=>{r.parts[e.partIdx].staves[e.staffIdx].removeVoice(t.voiceIdx)})}function dX(s,t){const e=new Yg(t.measureUuid);t.data&&e.setData(t.data);const r=s.getMeasureIdxFromUuid(t.measureUuid),i=s.getMeasure(r),a=i.replaceGlobalMeasure(e);t.measureData&&i.setNbMeasures(t.measureData.nbMeasures),a.destroy()}function fX(s,t){const e=new xp({partUuid:t.partUuid,measureUuid:t.measureUuid});t.data&&e.setData(t.data);const r=s.getMeasureIdxFromUuid(t.measureUuid),i=s.getPartIdxFromUuid(t.partUuid);s.getMeasure(r).replacePartMeasure(i,e).destroy()}function gX(s,t){if(t.type===Po.A.UPDATE_PART_MEASURE)fX(s,t);else if(t.type===Po.A.ADD_MEASURE)eX(s,t);else if(t.type===Po.A.REMOVE_MEASURE)hX(s,t);else if(t.type===Po.A.UPDATE_GLOBAL_MEASURE)dX(s,t);else if(t.type===Po.A.ADD_VOICE)nX(s,t);else if(t.type===Po.A.REMOVE_VOICE)lX(s,t);else throw new Error(`Unsupported update type: ${t.type}`)}function pX(s,t){t.forEach(e=>{gX(s,e)}),s.dropDirtyPages(),s.updateMeasuresUuids()}function mX(s,t){const r=new yu(s,t,0,!0),i=r.getHeight();r.getChildRoot().destroy();const a=new yu(s,t,0,!1),l=a.getHeight();a.getChildRoot().destroy();const d=new Dp(s,t,0),f=d.getHeight();return d.getChildRoot().destroy(),{firstHeaderFooterHeight:i+f,otherHeaderFooterHeight:l+f}}function Ip(s,t){const e=KA(s,t,!0),r=KA(s,t,!1);return{firstSliceHeaderWidth:e,otherSlicesHeaderWidth:r}}function KA(s,t,e){const r=new IA(s);t.forEach(a=>{const l=Zy(s,a,e);r.addPart(l)});const i=r.getWidth();return r.getChildRoot().destroy(),i}function Qu(s,t,e,r){const i={versionId:t,layout:!1,measuresHeaders:[],partsHeaders:[],measures:[]},a=new Set,l=new Set,d=s.getNbMeasures();for(let f=e;f<r&&f<d;f++){const m=s.getMeasure(f),S=m.rawGlobalMeasure.measureUuid;!m.rawGlobalMeasure.data&&!a.has(S)&&(i.measuresHeaders.push(S),a.add(S)),m.rawPartMeasures.forEach(w=>{const x=w.partUuid,D=`${x}-${S}`;!w.data&&!l.has(D)&&(l.add(D),i.measures.push({partUuid:x,measureUuid:S}))})}return i}var yX=Object.defineProperty,AX=(s,t,e)=>t in s?yX(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Fp=(s,t,e)=>AX(s,typeof t!="symbol"?t+"":t,e);function Ku(s,t){new vX(s).process(t)}class vX{constructor(t){Fp(this,"scoreDrawer"),Fp(this,"partsMap"),Fp(this,"measuresMap"),this.scoreDrawer=t,this.partsMap=new Map(t.partsData.map((e,r)=>[e.uuid,r])),this.measuresMap=SX(t.slicesProvider.measures)}process(t){t.measures.forEach(({partUuid:e,measureUuid:r,payload:i})=>{const a=this.getPartIdxFromUuid(e);this.getMeasuresIndexesFromUuid(r).forEach(d=>{const f=this.scoreDrawer.getMeasure(d);f.rawPartMeasures[a].data===null&&(f.rawPartMeasures[a].data=i)})}),t.measuresHeaders.forEach(({uuid:e,payload:r})=>{this.getMeasuresIndexesFromUuid(e).forEach(a=>{const l=this.scoreDrawer.getMeasure(a);l.rawGlobalMeasure.data===null&&(l.rawGlobalMeasure.data=r)})})}getMeasuresIndexesFromUuid(t){const e=this.measuresMap.get(t);if(e===void 0)throw new Error(`Measure not found with uuid ${t}`);return e}getPartIdxFromUuid(t){const e=this.partsMap.get(t);if(e===void 0)throw new Error(`Part not found with uuid ${t}`);return e}}function SX(s){const t=new Map;return s.forEach((e,r)=>{const i=e.rawGlobalMeasure.measureUuid,a=t.get(i);a?a.push(r):t.set(i,[r])}),t}var wX=Object.defineProperty,xX=Object.defineProperties,bX=Object.getOwnPropertyDescriptors,JA=Object.getOwnPropertySymbols,PX=Object.prototype.hasOwnProperty,EX=Object.prototype.propertyIsEnumerable,Up=(s,t,e)=>t in s?wX(s,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):s[t]=e,Eo=(s,t)=>{for(var e in t||(t={}))PX.call(t,e)&&Up(s,e,t[e]);if(JA)for(var e of JA(t))EX.call(t,e)&&Up(s,e,t[e]);return s},Hp=(s,t)=>xX(s,bX(t)),rs=(s,t,e)=>Up(s,typeof t!="symbol"?t+"":t,e),us=(s,t,e)=>new Promise((r,i)=>{var a=f=>{try{d(e.next(f))}catch(m){i(m)}},l=f=>{try{d(e.throw(f))}catch(m){i(m)}},d=f=>f.done?r(f.value):Promise.resolve(f.value).then(a,l);d((e=e.apply(s,t)).next())});class DX{constructor(t,e){rs(this,"scoreStructure",null),rs(this,"layoutInfo",null),rs(this,"drawingContext",null),rs(this,"scoreDrawer",null),rs(this,"cursorDrawer",null),rs(this,"musicFont",null),rs(this,"musicFontName",null),rs(this,"glyphsCache",null),rs(this,"textMetricProvider",null),rs(this,"fonts",null),rs(this,"displayWidth",null),rs(this,"watchId",null),rs(this,"resourcesProvider"),rs(this,"dataProvider"),rs(this,"containers",[]),rs(this,"cursorContainers",[]),this.resourcesProvider=t,this.dataProvider=e}getScoreDrawer(){return us(this,null,function*(){if(this.scoreDrawer===null){if(!this.scoreStructure)throw new Error("Score structure is not set");const t=yield this.getDrawingContext(),e=this.getDisplayMetrics(t),r=this.createPageHeaderFooterFactory(t),i=this.createMeasures(t);this.scoreDrawer=new b_(t,e,i,this.scoreStructure.parts,r),this.cursorDrawer||(this.cursorDrawer=new JE(this.scoreDrawer))}return this.scoreDrawer})}getDisplayMetrics(t){if(this.layoutInfo===null)throw new Error("Layout is not set");if(this.scoreStructure===null)throw new Error("Score structure is not set");if(this.layoutInfo.type===Mi.A.TRACK){const e=new U_(t),r=new B_(t);return Hp(Eo({pageHeight:null,firstHeaderFooterHeight:0,otherHeaderFooterHeight:0,sliceWidth:null,measuresPanel:r,partsPanel:e},Ip(t,this.scoreStructure.parts)),{topMargin:this.layoutInfo.marginTop,bottomMargin:this.layoutInfo.marginBottom,internalMargin:0,externalMargin:this.layoutInfo.marginRight,forceDisplayMeasureNumber:!0,forceDisplayAllParts:!0,displayMeasureIdxMap:this.scoreStructure.displayMeasureIdxMap})}else{if(this.layoutInfo.type===Mi.A.PAGE)return Hp(Eo(Eo(Eo({},this.scoreStructure.displayMetrics),Ip(t,this.scoreStructure.parts)),mX(t,this.scoreStructure.credits)),{measuresPanel:null,partsPanel:null,forceDisplayMeasureNumber:!1,forceDisplayAllParts:!1,displayMeasureIdxMap:this.scoreStructure.displayMeasureIdxMap});if(this.layoutInfo.type===Mi.A.RESPONSIVE){const e=Hp(Eo(Eo({},this.scoreStructure.displayMetrics),Ip(t,this.scoreStructure.parts)),{measuresPanel:null,partsPanel:null,firstHeaderFooterHeight:0,otherHeaderFooterHeight:0,forceDisplayMeasureNumber:!1,forceDisplayAllParts:!1,displayMeasureIdxMap:this.scoreStructure.displayMeasureIdxMap});return e.sliceWidth=this.layoutInfo.widthSpace,e.pageHeight=null,e.bottomMargin=this.layoutInfo.marginBottom,e.topMargin=this.layoutInfo.marginTop,e.internalMargin=0,e.externalMargin=0,e}else throw new Error(`Unknown layout type: ${this.layoutInfo.type}`)}}createPageHeaderFooterFactory(t){if(this.layoutInfo===null||this.layoutInfo.type!==Mi.A.PAGE)return null;if(!this.scoreStructure)throw new Error("Score structure is not set");return new WB(t,this.scoreStructure.displayMetrics.sliceWidth,this.scoreStructure.credits)}createMeasures(t){if(!this.scoreStructure)throw new Error("Score structure is not set");const e=this.scoreStructure.parts;return this.scoreStructure.measures.map(r=>this.createMeasure(r,t,e))}createMeasure(t,e,r){const i=t.uuid,a=new Yg(i),l=new _y(e,r,a);return t.nbMeasures>1&&l.setNbMeasures(t.nbMeasures),r.forEach(d=>{const f=new xp({partUuid:d.uuid,measureUuid:i});l.addPartMeasures(f)}),l}getDrawingContext(){return us(this,null,function*(){if(!this.drawingContext){const t=yield this.getMusicFont(),e=yield this.getGlyphsCache(),r=yield this.getTextMetricProvider(),i=new Io(e,r);if(this.watchId=i.startListening(),this.drawingContext=new $E.A(i,t),this.scoreStructure===null)throw new Error("Score structure is not set");this.drawingContext.overrideLayoutData(this.scoreStructure.layout)}return this.drawingContext})}getGlyphsCache(){return us(this,null,function*(){if(this.glyphsCache===null){const t=yield this.getMusicFont(),e=qt(t);this.glyphsCache=new Tt(e)}return this.glyphsCache})}getMusicFont(){return us(this,null,function*(){if(!this.musicFont){if(this.musicFontName===null)throw new Error("Music font name is not set");this.musicFont=yield this.resourcesProvider.getMusicFont(this.musicFontName)}return this.musicFont})}getTextMetricProvider(){return us(this,null,function*(){if(this.textMetricProvider===null){if(this.fonts===null)throw new Error("Fonts are not set");const t=yield Promise.all(this.fonts.map(this.resourcesProvider.getTextFont,this.resourcesProvider)),e=new D_.A(t),r=new N_(e);this.textMetricProvider=new Op(r)}return this.textMetricProvider})}setScoreStructure(t){t.resources.musicFont!==this.musicFontName&&(this.musicFont=null,this.glyphsCache=null),this.fonts!==null&&(this.fonts.length!==t.resources.textFonts.length||this.fonts.some((e,r)=>{const i=t.resources.textFonts[r];return!(0,tX.Ft)(e,i)}))&&(this.textMetricProvider=null),this.fonts=t.resources.textFonts,this.musicFontName=t.resources.musicFont,this.scoreStructure=t,this.drawingContext=null,this.scoreDrawer=null,this.cursorDrawer=null,this.containers=[],this.cursorContainers=[]}setLayout(t){if(this.layoutInfo===null){this.layoutInfo=t;return}const e=this.layoutInfo.type;if(this.layoutInfo=t,this.scoreDrawer!==null){this.scoreDrawer.drawingContext.nodeContext.setScoreMode(),this.scoreDrawer.markAllDirty(),this.scoreDrawer.dropTrackPanels();const r=this.getDisplayMetrics(this.scoreDrawer.drawingContext);if(Object.assign(this.scoreDrawer.displayMetrics,r),this.layoutInfo.type!==e){const i=this.createPageHeaderFooterFactory(this.scoreDrawer.drawingContext);this.scoreDrawer.setPageHeaderFooterFactory(i),this.scoreDrawer.removeMeasuresRange()}}}setPartPanelFormat(t){return us(this,null,function*(){const e=yield this.getScoreDrawer();e.drawingContext.nodeContext.setScoreMode(),e.setPartPanelFormat(t)})}setScoreUpdate(t){this.scoreStructure=t.scoreStructure,this.scoreDrawer!==null&&(this.scoreDrawer.drawingContext.nodeContext.setScoreMode(),se.n("abstractRenderer.applyUpdates"),pX(this.scoreDrawer,t.updates),this.scoreDrawer.displayMetrics.displayMeasureIdxMap=this.scoreStructure.displayMeasureIdxMap,se.d("abstractRenderer.applyUpdates"))}renderPages(t){return us(this,null,function*(){if(this.scoreStructure===null)throw new Error("Score structure is not set");const e=yield this.getScoreDrawer();if(e.drawingContext.nodeContext.setScoreMode(),this.watchId===null)throw new Error("Watch id is not set");se.n("abstractRenderer.computeDataRequest");const r=Qu(e,this.scoreStructure.versionId,0,t.requestMeasuresDataUntil);if(se.d("abstractRenderer.computeDataRequest"),!bc(r)){const S=yield this.dataProvider.requestData(r);if(S.isMissingData)return null;se.n("abstractRenderer.injectData"),Ku(e,S),se.d("abstractRenderer.injectData")}let i=0;const a=[],l=[],d=t.pagesIndexes[t.pagesIndexes.length-1];se.n("abstractRenderer.renderPages");for(let S=0;S<=d;S++){const{pageIdx:w,page:x}=e.getPage(S);if(w<S)break;const D=t.pagesIndexes[i];if(w===D){x.format();const M=this.getContainer(e.drawingContext,w);Do(M,x.getChildRoot()),l.push(M.id),i++}const L=x.getFakePageData(w);a.push(L)}se.d("abstractRenderer.renderPages"),se.n("abstractRenderer.gatherEdits");const f=e.drawingContext.nodeContext.getUpdate(this.watchId);return se.d("abstractRenderer.gatherEdits"),{pages:a,edits:f,renderedRootIds:l}})}renderPageContainingMeasure(t){return us(this,null,function*(){if(this.scoreStructure===null)throw new Error("Score structure is not set");const e=yield this.getScoreDrawer();if(e.drawingContext.nodeContext.setScoreMode(),this.watchId===null)throw new Error("Watch id is not set");se.n("abstractRenderer.computeDataRequest");const r=Qu(e,this.scoreStructure.versionId,0,t.requestMeasuresDataUntil);if(se.d("abstractRenderer.computeDataRequest"),!bc(r)){const f=yield this.dataProvider.requestData(r);if(f.isMissingData)return null;se.n("abstractRenderer.injectData"),Ku(e,f),se.d("abstractRenderer.injectData")}const{staffMeasureRequest:i}=t;let a=0,l=-1;const d=[];for(;l<t.requestMeasuresDataUntil;){const f=e.getPage(a),m=f.page.getFakePageData(a);if(l=e.getMeasureIdxFromUuid(m.lastMeasureUuid),d.push(m),f.page.systems.some(CX,i)){const S=this.getContainer(e.drawingContext,a);f.page.format(),Do(S,f.page.getChildRoot()),se.n("abstractRenderer.gatherEdits");const w=e.drawingContext.nodeContext.getUpdate(this.watchId);return se.d("abstractRenderer.gatherEdits"),{pages:d,edits:w,renderedRootId:S.id}}a++}return null})}renderMeasuresRange(t){return us(this,null,function*(){if(this.scoreStructure===null)throw new Error("Score structure is not set");const e=yield this.getScoreDrawer();if(e.drawingContext.nodeContext.setScoreMode(),this.watchId===null)throw new Error("Watch id is not set");se.n("abstractRenderer.computeDataRequest");const r=Qu(e,this.scoreStructure.versionId,t.fromMeasureIdx,t.toMeasureIdx);if(se.d("abstractRenderer.computeDataRequest"),!bc(r)){const yt=yield this.dataProvider.requestData(r);if(yt.isMissingData)return null;se.n("abstractRenderer.injectData"),Ku(e,yt),se.d("abstractRenderer.injectData")}t.surfaceData?e.setSurfaceData(t.surfaceData):e.setMeasuresRange(t.fromMeasureIdx,t.toMeasureIdx);const{page:i}=e.getPage(0);i.format();const a=this.getContainer(e.drawingContext,N.A.CONTENT);Do(a,i.getChildRoot());const l=a.getBBox(),d={width:l.maxX,height:l.maxY,rootId:a.id},f=e.displayMetrics.measuresPanel;if(f===null)throw new Error("Measures panel is not set");const m=this.getContainer(e.drawingContext,N.A.MEASURES_HEADER);Do(m,f.getChildRoot());const S=m.getBBox(),w={width:S.maxX,height:S.maxY,rootId:m.id},x=e.displayMetrics.partsPanel;if(x===null)throw new Error("Parts panel is not set");const D=this.getContainer(e.drawingContext,N.A.PARTS_HEADER);Do(D,x.getChildRoot());const L=D.getBBox(),M={width:L.maxX,height:L.maxY,rootId:D.id},{parts:H,measures:$}=i.getTracksMetadata();se.n("abstractRenderer.gatherEdits");const lt=e.drawingContext.nodeContext.getUpdate(this.watchId);return se.d("abstractRenderer.gatherEdits"),{metadata:{parts:H,measures:$,partHeader:M,measureHeader:w,content:d},edits:lt}})}renderPartHeaderBlock(){return us(this,null,function*(){if(this.watchId===null)throw new Error("Watch id is not set");const t=yield this.getScoreDrawer();t.drawingContext.nodeContext.setScoreMode(),t.getFirstSystem().formatHeader();const{page:r}=t.getPage(0);r.formattedFlag=!1,r.format();const i=t.displayMetrics.partsPanel;if(i===null)throw new Error("Parts panel is not set");const a=this.getContainer(t.drawingContext,N.A.PARTS_HEADER);Do(a,i.getChildRoot());const l=a.getBBox(),d={width:l.maxX,height:l.maxY,rootId:a.id};se.n("abstractRenderer.gatherEdits");const f=t.drawingContext.nodeContext.getUpdate(this.watchId);return se.d("abstractRenderer.gatherEdits"),{metadata:d,edits:f}})}getContainer(t,e){for(;this.containers.length<=e;)this.containers.push(t.createRootNode());return this.containers[e]}resolveEvent(t){return us(this,null,function*(){if(this.scoreDrawer===null||this.layoutInfo===null)return null;const{position:e,eventsContext:r}=t;if(H_(e))return{surfaceType:An.A.PINCH,position:e,isTouch:!0};if(this.layoutInfo.type!==Mi.A.TRACK){if(e.pageIdx>=this.scoreDrawer.pages.length)return null;const l=this.scoreDrawer.pages[e.pageIdx];return l.isDirty()||!l.formattedFlag?null:l.getEventsLayer().resolve(e,r)}if(this.scoreDrawer.pages.length===0)return null;const i=this.scoreDrawer.pages[0];return i.isDirty()||!i.formattedFlag?null:i.getEventsLayer().resolveTrack(e,r)})}requestPosition(t){return us(this,null,function*(){if(this.scoreDrawer===null||this.layoutInfo===null)return null;const e=this.scoreDrawer,r=e.pages.length;if(this.layoutInfo.type===Mi.A.TRACK){if(r===0)return null;const a=e.pages[0];if(a.isDirty()||!a.formattedFlag)return null;const l=(0,N.N)(),d=t.pagesIndexes.filter(f=>l.includes(f));return kA(t.request,e,d)}const i=t.pagesIndexes.filter(a=>{if(a>=r)return!1;const l=e.pages[a];return!l.isDirty()&&l.formattedFlag});return kA(t.request,e,i)})}requestRangePositions(t){return us(this,null,function*(){if(this.scoreDrawer===null||this.layoutInfo===null)return null;const e=this.scoreDrawer,r=e.pages.length;if(this.layoutInfo.type===Mi.A.TRACK){if(r===0)return null;const a=e.pages[0];if(a.isDirty()||!a.formattedFlag)return null;const l=(0,N.N)(),d=t.pagesIndexes.filter(f=>l.includes(f));return QA(t.request,e,d)}const i=t.pagesIndexes.filter(a=>{if(a>=r)return!1;const l=e.pages[a];return!l.isDirty()&&l.formattedFlag});return QA(t.request,e,i)})}renderCursorPages(t){return us(this,null,function*(){if(this.cursorDrawer===null||this.scoreDrawer===null)return null;const e=this.scoreDrawer;if(e.drawingContext.nodeContext.setCursorMode(),this.watchId===null)throw new Error("Watch id is not set");se.n("abstractRenderer.renderCursor");const r=this.cursorDrawer.drawCursor(t.cursorRequest,t.pagesIndexes);se.d("abstractRenderer.renderCursor");const i=[];let a=0;r.forEach((d,f)=>{if(d===null)return;const m=this.getCursorContainer(e.drawingContext,a);a++,v(m,d);const{width:S,height:w}=this.getCursorPageWidthHeight(f);i.push({pageIdx:f,height:w,width:S,rootId:m.id})}),se.n("abstractRenderer.gatherCursorEdits");const l=this.scoreDrawer.drawingContext.nodeContext.getUpdate(this.watchId);return se.d("abstractRenderer.gatherCursorEdits"),{pages:i,edits:l}})}getCursorPageWidthHeight(t){if(this.scoreDrawer===null||this.layoutInfo===null)throw new Error("Score drawer or layout is not set");if(this.layoutInfo.type===Mi.A.TRACK){const l=this.getContainer(this.scoreDrawer.drawingContext,t).getBBox();return{width:l.maxX,height:l.maxY}}const e=this.scoreDrawer.pages[t],{width:r,height:i}=e.getFakePageData(t);return{width:r,height:i}}getCursorContainer(t,e){for(;this.cursorContainers.length<=e;)this.cursorContainers.push(t.createRootNode());return this.cursorContainers[e]}getAllPagesGeometries(){return us(this,null,function*(){if(this.scoreStructure===null)throw new Error("Score structure is not set");const t=yield this.getScoreDrawer();if(this.watchId===null)throw new Error("Watch id is not set");se.n("abstractRenderer.computeDataRequest");const e=t.getNbMeasures(),r=Qu(t,this.scoreStructure.versionId,0,e);if(se.d("abstractRenderer.computeDataRequest"),!bc(r)){const l=yield this.dataProvider.requestData(r);if(l.isMissingData)return null;se.n("abstractRenderer.injectData"),Ku(t,l),se.d("abstractRenderer.injectData")}let i=0;const a=[];for(;;){const{pageIdx:l,page:d}=t.getPage(i);if(l<i)break;d.format();const f=d.getGeometry();a.push(f),i++}return a})}}function Do(s,t){s.children.slice().forEach(r=>{r!==t&&it(s,r)}),v(s,t)}function CX(s){const t=s.parts.find(i=>i.partData.uuid===this.partUuid);if(!t)return!1;const e=t.staves[0];return e?!!e.measures.find(i=>i.measureUuid===this.measureUuid):!1}},736175:(ae,Et,b)=>{b.d(Et,{A:()=>X});var V=(Tt=>(Tt.TRACK="track",Tt.RESPONSIVE="responsive",Tt.PAGE="page",Tt))(V||{});const U=null,X=V},740827:(ae,Et,b)=>{b.d(Et,{A:()=>U});var V=(X=>(X.STANDARD="standard",X.GUITAR_TAB="guitar-tab",X.RECORDER_TAB="recorder-tab",X.KODALY="kodaly",X))(V||{});const U=V},771997:(ae,Et,b)=>{b.d(Et,{A:()=>V});function V(U,X){const Tt=new Set(X.parts.map(j=>j.uuid)),tt=new Set(X.measures.map(j=>j.uuid));return U.filter(j=>{const vt=j.partUuid;if(typeof vt=="string"&&!Tt.has(vt))return!1;const xt=j.measureUuid;return!(typeof xt=="string"&&!tt.has(xt))})}},854381:(ae,Et,b)=>{b.d(Et,{S:()=>X,z:()=>Tt});var V=b(398738),U=b(87053);const X="Century Schoolbook L",Tt=new Map([[V.default.LYRICS,{fontSize:{value:2.22,unit:U.A.SPACE},fontFamily:X,bold:!1,italic:!1}],[V.default.TITLE,{fontSize:{value:24,unit:U.A.POINT},fontFamily:X,bold:!1,italic:!1}],[V.default.SUBTITLE,{fontSize:{value:14,unit:U.A.POINT},fontFamily:X,bold:!1,italic:!1}],[V.default.RIGHTS,{fontSize:{value:9,unit:U.A.POINT},fontFamily:X,bold:!1,italic:!1}],[V.default.LYRICIST,{fontSize:{value:10,unit:U.A.POINT},fontFamily:X,bold:!1,italic:!1}],[V.default.COMPOSER,{fontSize:{value:10,unit:U.A.POINT},fontFamily:X,bold:!1,italic:!1}],[V.default.ARRANGER,{fontSize:{value:10,unit:U.A.POINT},fontFamily:X,bold:!1,italic:!1}],[V.default.HARMONY,{fontSize:{value:2.8,unit:U.A.SPACE},fontFamily:X,bold:!1,italic:!1}],[V.default.REHEARSAL,{fontSize:{value:2.6,unit:U.A.SPACE},fontFamily:X,bold:!1,italic:!1}],[V.default.WORD,{fontSize:{value:1.92,unit:U.A.SPACE},fontFamily:X,bold:!1,italic:!0}],[V.default.PART_NAME,{fontSize:{value:3,unit:U.A.SPACE},fontFamily:X,bold:!1,italic:!1}],[V.default.PAGE_NUMBER,{fontSize:{value:12,unit:U.A.POINT},fontFamily:X,bold:!1,italic:!1}],[V.default.MEASURE_NUMBER,{fontSize:{value:2,unit:U.A.SPACE},fontFamily:X,bold:!1,italic:!1}],[V.default.PIZZICATO,{fontSize:{value:1.92,unit:U.A.SPACE},fontFamily:X,bold:!1,italic:!0}],[V.default.TEMPO,{fontSize:{value:2.75,unit:U.A.SPACE},fontFamily:X,bold:!1,italic:!1}],[V.default.FRET_NUMBER,{fontSize:{value:2,unit:U.A.SPACE},fontFamily:X,bold:!1,italic:!1}]])},875105:(ae,Et,b)=>{b.d(Et,{Ay:()=>st});var V=b(712081).Buffer;/*! https://mths.be/codepointat v0.2.0 by @mathias */String.prototype.codePointAt||function(){var n=function(){try{var h={},c=Object.defineProperty,u=c(h,h,h)&&c}catch(g){}return u}(),o=function(h){if(this==null)throw TypeError();var c=String(this),u=c.length,g=h?Number(h):0;if(g!=g&&(g=0),!(g<0||g>=u)){var p=c.charCodeAt(g),A;return p>=55296&&p<=56319&&u>g+1&&(A=c.charCodeAt(g+1),A>=56320&&A<=57343)?(p-55296)*1024+A-56320+65536:p}};n?n(String.prototype,"codePointAt",{value:o,configurable:!0,writable:!0}):String.prototype.codePointAt=o}();var U=0,X=-3;function Tt(){this.table=new Uint16Array(16),this.trans=new Uint16Array(288)}function tt(n,o){this.source=n,this.sourceIndex=0,this.tag=0,this.bitcount=0,this.dest=o,this.destLen=0,this.ltree=new Tt,this.dtree=new Tt}var j=new Tt,vt=new Tt,xt=new Uint8Array(30),k=new Uint16Array(30),ct=new Uint8Array(30),Lt=new Uint16Array(30),Ut=new Uint8Array([16,17,18,0,8,7,9,6,10,5,11,4,12,3,13,2,14,1,15]),J=new Tt,et=new Uint8Array(320);function Gt(n,o,h,c){var u,g;for(u=0;u<h;++u)n[u]=0;for(u=0;u<30-h;++u)n[u+h]=u/h|0;for(g=c,u=0;u<30;++u)o[u]=g,g+=1<<n[u]}function jt(n,o){var h;for(h=0;h<7;++h)n.table[h]=0;for(n.table[7]=24,n.table[8]=152,n.table[9]=112,h=0;h<24;++h)n.trans[h]=256+h;for(h=0;h<144;++h)n.trans[24+h]=h;for(h=0;h<8;++h)n.trans[168+h]=280+h;for(h=0;h<112;++h)n.trans[176+h]=144+h;for(h=0;h<5;++h)o.table[h]=0;for(o.table[5]=32,h=0;h<32;++h)o.trans[h]=h}var kt=new Uint16Array(16);function fe(n,o,h,c){var u,g;for(u=0;u<16;++u)n.table[u]=0;for(u=0;u<c;++u)n.table[o[h+u]]++;for(n.table[0]=0,g=0,u=0;u<16;++u)kt[u]=g,g+=n.table[u];for(u=0;u<c;++u)o[h+u]&&(n.trans[kt[o[h+u]]++]=u)}function ge(n){n.bitcount--||(n.tag=n.source[n.sourceIndex++],n.bitcount=7);var o=n.tag&1;return n.tag>>>=1,o}function ne(n,o,h){if(!o)return h;for(;n.bitcount<24;)n.tag|=n.source[n.sourceIndex++]<<n.bitcount,n.bitcount+=8;var c=n.tag&65535>>>16-o;return n.tag>>>=o,n.bitcount-=o,c+h}function Oe(n,o){for(;n.bitcount<24;)n.tag|=n.source[n.sourceIndex++]<<n.bitcount,n.bitcount+=8;var h=0,c=0,u=0,g=n.tag;do c=2*c+(g&1),g>>>=1,++u,h+=o.table[u],c-=o.table[u];while(c>=0);return n.tag=g,n.bitcount-=u,o.trans[h+c]}function ze(n,o,h){var c,u,g,p,A,y;for(c=ne(n,5,257),u=ne(n,5,1),g=ne(n,4,4),p=0;p<19;++p)et[p]=0;for(p=0;p<g;++p){var P=ne(n,3,0);et[Ut[p]]=P}for(fe(J,et,0,19),A=0;A<c+u;){var E=Oe(n,J);switch(E){case 16:var O=et[A-1];for(y=ne(n,2,3);y;--y)et[A++]=O;break;case 17:for(y=ne(n,3,3);y;--y)et[A++]=0;break;case 18:for(y=ne(n,7,11);y;--y)et[A++]=0;break;default:et[A++]=E;break}}fe(o,et,0,c),fe(h,et,c,u)}function Ct(n,o,h){for(;;){var c=Oe(n,o);if(c===256)return U;if(c<256)n.dest[n.destLen++]=c;else{var u,g,p,A;for(c-=257,u=ne(n,xt[c],k[c]),g=Oe(n,h),p=n.destLen-ne(n,ct[g],Lt[g]),A=p;A<p+u;++A)n.dest[n.destLen++]=n.dest[A]}}}function he(n){for(var o,h,c;n.bitcount>8;)n.sourceIndex--,n.bitcount-=8;if(o=n.source[n.sourceIndex+1],o=256*o+n.source[n.sourceIndex],h=n.source[n.sourceIndex+3],h=256*h+n.source[n.sourceIndex+2],o!==(~h&65535))return X;for(n.sourceIndex+=4,c=o;c;--c)n.dest[n.destLen++]=n.source[n.sourceIndex++];return n.bitcount=0,U}function Qt(n,o){var h=new tt(n,o),c,u,g;do{switch(c=ge(h),u=ne(h,2,0),u){case 0:g=he(h);break;case 1:g=Ct(h,j,vt);break;case 2:ze(h,h.ltree,h.dtree),g=Ct(h,h.ltree,h.dtree);break;default:g=X}if(g!==U)throw new Error("Data error")}while(!c);return h.destLen<h.dest.length?typeof h.dest.slice=="function"?h.dest.slice(0,h.destLen):h.dest.subarray(0,h.destLen):h.dest}jt(j,vt),Gt(xt,k,4,3),Gt(ct,Lt,2,1),xt[28]=0,k[28]=258;var _=Qt;function Nt(n,o,h,c,u){return Math.pow(1-u,3)*n+3*Math.pow(1-u,2)*u*o+3*(1-u)*Math.pow(u,2)*h+Math.pow(u,3)*c}function oe(){this.x1=Number.NaN,this.y1=Number.NaN,this.x2=Number.NaN,this.y2=Number.NaN}oe.prototype.isEmpty=function(){return isNaN(this.x1)||isNaN(this.y1)||isNaN(this.x2)||isNaN(this.y2)},oe.prototype.addPoint=function(n,o){typeof n=="number"&&((isNaN(this.x1)||isNaN(this.x2))&&(this.x1=n,this.x2=n),n<this.x1&&(this.x1=n),n>this.x2&&(this.x2=n)),typeof o=="number"&&((isNaN(this.y1)||isNaN(this.y2))&&(this.y1=o,this.y2=o),o<this.y1&&(this.y1=o),o>this.y2&&(this.y2=o))},oe.prototype.addX=function(n){this.addPoint(n,null)},oe.prototype.addY=function(n){this.addPoint(null,n)},oe.prototype.addBezier=function(n,o,h,c,u,g,p,A){var y=[n,o],P=[h,c],E=[u,g],O=[p,A];this.addPoint(n,o),this.addPoint(p,A);for(var C=0;C<=1;C++){var B=6*y[C]-12*P[C]+6*E[C],Z=-3*y[C]+9*P[C]-9*E[C]+3*O[C],mt=3*P[C]-3*y[C];if(Z===0){if(B===0)continue;var ht=-mt/B;0<ht&&ht<1&&(C===0&&this.addX(Nt(y[C],P[C],E[C],O[C],ht)),C===1&&this.addY(Nt(y[C],P[C],E[C],O[C],ht)));continue}var ft=Math.pow(B,2)-4*mt*Z;if(!(ft<0)){var _t=(-B+Math.sqrt(ft))/(2*Z);0<_t&&_t<1&&(C===0&&this.addX(Nt(y[C],P[C],E[C],O[C],_t)),C===1&&this.addY(Nt(y[C],P[C],E[C],O[C],_t)));var wt=(-B-Math.sqrt(ft))/(2*Z);0<wt&&wt<1&&(C===0&&this.addX(Nt(y[C],P[C],E[C],O[C],wt)),C===1&&this.addY(Nt(y[C],P[C],E[C],O[C],wt)))}}},oe.prototype.addQuad=function(n,o,h,c,u,g){var p=n+.6666666666666666*(h-n),A=o+2/3*(c-o),y=p+1/3*(u-n),P=A+1/3*(g-o);this.addBezier(n,o,p,A,y,P,u,g)};function $t(){this.commands=[],this.fill="black",this.stroke=null,this.strokeWidth=1}$t.prototype.moveTo=function(n,o){this.commands.push({type:"M",x:n,y:o})},$t.prototype.lineTo=function(n,o){this.commands.push({type:"L",x:n,y:o})},$t.prototype.curveTo=$t.prototype.bezierCurveTo=function(n,o,h,c,u,g){this.commands.push({type:"C",x1:n,y1:o,x2:h,y2:c,x:u,y:g})},$t.prototype.quadTo=$t.prototype.quadraticCurveTo=function(n,o,h,c){this.commands.push({type:"Q",x1:n,y1:o,x:h,y:c})},$t.prototype.close=$t.prototype.closePath=function(){this.commands.push({type:"Z"})},$t.prototype.extend=function(n){if(n.commands)n=n.commands;else if(n instanceof oe){var o=n;this.moveTo(o.x1,o.y1),this.lineTo(o.x2,o.y1),this.lineTo(o.x2,o.y2),this.lineTo(o.x1,o.y2),this.close();return}Array.prototype.push.apply(this.commands,n)},$t.prototype.getBoundingBox=function(){for(var n=new oe,o=0,h=0,c=0,u=0,g=0;g<this.commands.length;g++){var p=this.commands[g];switch(p.type){case"M":n.addPoint(p.x,p.y),o=c=p.x,h=u=p.y;break;case"L":n.addPoint(p.x,p.y),c=p.x,u=p.y;break;case"Q":n.addQuad(c,u,p.x1,p.y1,p.x,p.y),c=p.x,u=p.y;break;case"C":n.addBezier(c,u,p.x1,p.y1,p.x2,p.y2,p.x,p.y),c=p.x,u=p.y;break;case"Z":c=o,u=h;break;default:throw new Error("Unexpected path command "+p.type)}}return n.isEmpty()&&n.addPoint(0,0),n},$t.prototype.draw=function(n){n.beginPath();for(var o=0;o<this.commands.length;o+=1){var h=this.commands[o];h.type==="M"?n.moveTo(h.x,h.y):h.type==="L"?n.lineTo(h.x,h.y):h.type==="C"?n.bezierCurveTo(h.x1,h.y1,h.x2,h.y2,h.x,h.y):h.type==="Q"?n.quadraticCurveTo(h.x1,h.y1,h.x,h.y):h.type==="Z"&&n.closePath()}this.fill&&(n.fillStyle=this.fill,n.fill()),this.stroke&&(n.strokeStyle=this.stroke,n.lineWidth=this.strokeWidth,n.stroke())},$t.prototype.toPathData=function(n){n=n!==void 0?n:2;function o(p){return Math.round(p)===p?""+Math.round(p):p.toFixed(n)}function h(){for(var p=arguments,A="",y=0;y<arguments.length;y+=1){var P=p[y];P>=0&&y>0&&(A+=" "),A+=o(P)}return A}for(var c="",u=0;u<this.commands.length;u+=1){var g=this.commands[u];g.type==="M"?c+="M"+h(g.x,g.y):g.type==="L"?c+="L"+h(g.x,g.y):g.type==="C"?c+="C"+h(g.x1,g.y1,g.x2,g.y2,g.x,g.y):g.type==="Q"?c+="Q"+h(g.x1,g.y1,g.x,g.y):g.type==="Z"&&(c+="Z")}return c},$t.prototype.toSVG=function(n){var o='<path d="';return o+=this.toPathData(n),o+='"',this.fill&&this.fill!=="black"&&(this.fill===null?o+=' fill="none"':o+=' fill="'+this.fill+'"'),this.stroke&&(o+=' stroke="'+this.stroke+'" stroke-width="'+this.strokeWidth+'"'),o+="/>",o},$t.prototype.toDOMElement=function(n){var o=this.toPathData(n),h=document.createElementNS("http://www.w3.org/2000/svg","path");return h.setAttribute("d",o),h};function pe(n){throw new Error(n)}function He(n,o){n||pe(o)}var bt={fail:pe,argument:He,assert:He},xs=32768,it=2147483648,ur={},at={},Ot={};function ye(n){return function(){return n}}at.BYTE=function(n){return bt.argument(n>=0&&n<=255,"Byte value should be between 0 and 255."),[n]},Ot.BYTE=ye(1),at.CHAR=function(n){return[n.charCodeAt(0)]},Ot.CHAR=ye(1),at.CHARARRAY=function(n){typeof n=="undefined"&&(n="",console.warn("Undefined CHARARRAY encountered and treated as an empty string. This is probably caused by a missing glyph name."));for(var o=[],h=0;h<n.length;h+=1)o[h]=n.charCodeAt(h);return o},Ot.CHARARRAY=function(n){return typeof n=="undefined"?0:n.length},at.USHORT=function(n){return[n>>8&255,n&255]},Ot.USHORT=ye(2),at.SHORT=function(n){return n>=xs&&(n=-(2*xs-n)),[n>>8&255,n&255]},Ot.SHORT=ye(2),at.UINT24=function(n){return[n>>16&255,n>>8&255,n&255]},Ot.UINT24=ye(3),at.ULONG=function(n){return[n>>24&255,n>>16&255,n>>8&255,n&255]},Ot.ULONG=ye(4),at.LONG=function(n){return n>=it&&(n=-(2*it-n)),[n>>24&255,n>>16&255,n>>8&255,n&255]},Ot.LONG=ye(4),at.FIXED=at.ULONG,Ot.FIXED=Ot.ULONG,at.FWORD=at.SHORT,Ot.FWORD=Ot.SHORT,at.UFWORD=at.USHORT,Ot.UFWORD=Ot.USHORT,at.LONGDATETIME=function(n){return[0,0,0,0,n>>24&255,n>>16&255,n>>8&255,n&255]},Ot.LONGDATETIME=ye(8),at.TAG=function(n){return bt.argument(n.length===4,"Tag should be exactly 4 ASCII characters."),[n.charCodeAt(0),n.charCodeAt(1),n.charCodeAt(2),n.charCodeAt(3)]},Ot.TAG=ye(4),at.Card8=at.BYTE,Ot.Card8=Ot.BYTE,at.Card16=at.USHORT,Ot.Card16=Ot.USHORT,at.OffSize=at.BYTE,Ot.OffSize=Ot.BYTE,at.SID=at.USHORT,Ot.SID=Ot.USHORT,at.NUMBER=function(n){return n>=-107&&n<=107?[n+139]:n>=108&&n<=1131?(n=n-108,[(n>>8)+247,n&255]):n>=-1131&&n<=-108?(n=-n-108,[(n>>8)+251,n&255]):n>=-32768&&n<=32767?at.NUMBER16(n):at.NUMBER32(n)},Ot.NUMBER=function(n){return at.NUMBER(n).length},at.NUMBER16=function(n){return[28,n>>8&255,n&255]},Ot.NUMBER16=ye(3),at.NUMBER32=function(n){return[29,n>>24&255,n>>16&255,n>>8&255,n&255]},Ot.NUMBER32=ye(5),at.REAL=function(n){var o=n.toString(),h=/\.(\d*?)(?:9{5,20}|0{5,20})\d{0,2}(?:e(.+)|$)/.exec(o);if(h){var c=parseFloat("1e"+((h[2]?+h[2]:0)+h[1].length));o=(Math.round(n*c)/c).toString()}for(var u="",g=0,p=o.length;g<p;g+=1){var A=o[g];A==="e"?u+=o[++g]==="-"?"c":"b":A==="."?u+="a":A==="-"?u+="e":u+=A}u+=u.length&1?"f":"ff";for(var y=[30],P=0,E=u.length;P<E;P+=2)y.push(parseInt(u.substr(P,2),16));return y},Ot.REAL=function(n){return at.REAL(n).length},at.NAME=at.CHARARRAY,Ot.NAME=Ot.CHARARRAY,at.STRING=at.CHARARRAY,Ot.STRING=Ot.CHARARRAY,ur.UTF8=function(n,o,h){for(var c=[],u=h,g=0;g<u;g++,o+=1)c[g]=n.getUint8(o);return String.fromCharCode.apply(null,c)},ur.UTF16=function(n,o,h){for(var c=[],u=h/2,g=0;g<u;g++,o+=2)c[g]=n.getUint16(o);return String.fromCharCode.apply(null,c)},at.UTF16=function(n){for(var o=[],h=0;h<n.length;h+=1){var c=n.charCodeAt(h);o[o.length]=c>>8&255,o[o.length]=c&255}return o},Ot.UTF16=function(n){return n.length*2};var ci={"x-mac-croatian":"\xC4\xC5\xC7\xC9\xD1\xD6\xDC\xE1\xE0\xE2\xE4\xE3\xE5\xE7\xE9\xE8\xEA\xEB\xED\xEC\xEE\xEF\xF1\xF3\xF2\xF4\xF6\xF5\xFA\xF9\xFB\xFC\u2020\xB0\xA2\xA3\xA7\u2022\xB6\xDF\xAE\u0160\u2122\xB4\xA8\u2260\u017D\xD8\u221E\xB1\u2264\u2265\u2206\xB5\u2202\u2211\u220F\u0161\u222B\xAA\xBA\u03A9\u017E\xF8\xBF\xA1\xAC\u221A\u0192\u2248\u0106\xAB\u010C\u2026\xA0\xC0\xC3\xD5\u0152\u0153\u0110\u2014\u201C\u201D\u2018\u2019\xF7\u25CA\uF8FF\xA9\u2044\u20AC\u2039\u203A\xC6\xBB\u2013\xB7\u201A\u201E\u2030\xC2\u0107\xC1\u010D\xC8\xCD\xCE\xCF\xCC\xD3\xD4\u0111\xD2\xDA\xDB\xD9\u0131\u02C6\u02DC\xAF\u03C0\xCB\u02DA\xB8\xCA\xE6\u02C7","x-mac-cyrillic":"\u0410\u0411\u0412\u0413\u0414\u0415\u0416\u0417\u0418\u0419\u041A\u041B\u041C\u041D\u041E\u041F\u0420\u0421\u0422\u0423\u0424\u0425\u0426\u0427\u0428\u0429\u042A\u042B\u042C\u042D\u042E\u042F\u2020\xB0\u0490\xA3\xA7\u2022\xB6\u0406\xAE\xA9\u2122\u0402\u0452\u2260\u0403\u0453\u221E\xB1\u2264\u2265\u0456\xB5\u0491\u0408\u0404\u0454\u0407\u0457\u0409\u0459\u040A\u045A\u0458\u0405\xAC\u221A\u0192\u2248\u2206\xAB\xBB\u2026\xA0\u040B\u045B\u040C\u045C\u0455\u2013\u2014\u201C\u201D\u2018\u2019\xF7\u201E\u040E\u045E\u040F\u045F\u2116\u0401\u0451\u044F\u0430\u0431\u0432\u0433\u0434\u0435\u0436\u0437\u0438\u0439\u043A\u043B\u043C\u043D\u043E\u043F\u0440\u0441\u0442\u0443\u0444\u0445\u0446\u0447\u0448\u0449\u044A\u044B\u044C\u044D\u044E","x-mac-gaelic":"\xC4\xC5\xC7\xC9\xD1\xD6\xDC\xE1\xE0\xE2\xE4\xE3\xE5\xE7\xE9\xE8\xEA\xEB\xED\xEC\xEE\xEF\xF1\xF3\xF2\xF4\xF6\xF5\xFA\xF9\xFB\xFC\u2020\xB0\xA2\xA3\xA7\u2022\xB6\xDF\xAE\xA9\u2122\xB4\xA8\u2260\xC6\xD8\u1E02\xB1\u2264\u2265\u1E03\u010A\u010B\u1E0A\u1E0B\u1E1E\u1E1F\u0120\u0121\u1E40\xE6\xF8\u1E41\u1E56\u1E57\u027C\u0192\u017F\u1E60\xAB\xBB\u2026\xA0\xC0\xC3\xD5\u0152\u0153\u2013\u2014\u201C\u201D\u2018\u2019\u1E61\u1E9B\xFF\u0178\u1E6A\u20AC\u2039\u203A\u0176\u0177\u1E6B\xB7\u1EF2\u1EF3\u204A\xC2\xCA\xC1\xCB\xC8\xCD\xCE\xCF\xCC\xD3\xD4\u2663\xD2\xDA\xDB\xD9\u0131\xDD\xFD\u0174\u0175\u1E84\u1E85\u1E80\u1E81\u1E82\u1E83","x-mac-greek":"\xC4\xB9\xB2\xC9\xB3\xD6\xDC\u0385\xE0\xE2\xE4\u0384\xA8\xE7\xE9\xE8\xEA\xEB\xA3\u2122\xEE\xEF\u2022\xBD\u2030\xF4\xF6\xA6\u20AC\xF9\xFB\xFC\u2020\u0393\u0394\u0398\u039B\u039E\u03A0\xDF\xAE\xA9\u03A3\u03AA\xA7\u2260\xB0\xB7\u0391\xB1\u2264\u2265\xA5\u0392\u0395\u0396\u0397\u0399\u039A\u039C\u03A6\u03AB\u03A8\u03A9\u03AC\u039D\xAC\u039F\u03A1\u2248\u03A4\xAB\xBB\u2026\xA0\u03A5\u03A7\u0386\u0388\u0153\u2013\u2015\u201C\u201D\u2018\u2019\xF7\u0389\u038A\u038C\u038E\u03AD\u03AE\u03AF\u03CC\u038F\u03CD\u03B1\u03B2\u03C8\u03B4\u03B5\u03C6\u03B3\u03B7\u03B9\u03BE\u03BA\u03BB\u03BC\u03BD\u03BF\u03C0\u03CE\u03C1\u03C3\u03C4\u03B8\u03C9\u03C2\u03C7\u03C5\u03B6\u03CA\u03CB\u0390\u03B0\xAD","x-mac-icelandic":"\xC4\xC5\xC7\xC9\xD1\xD6\xDC\xE1\xE0\xE2\xE4\xE3\xE5\xE7\xE9\xE8\xEA\xEB\xED\xEC\xEE\xEF\xF1\xF3\xF2\xF4\xF6\xF5\xFA\xF9\xFB\xFC\xDD\xB0\xA2\xA3\xA7\u2022\xB6\xDF\xAE\xA9\u2122\xB4\xA8\u2260\xC6\xD8\u221E\xB1\u2264\u2265\xA5\xB5\u2202\u2211\u220F\u03C0\u222B\xAA\xBA\u03A9\xE6\xF8\xBF\xA1\xAC\u221A\u0192\u2248\u2206\xAB\xBB\u2026\xA0\xC0\xC3\xD5\u0152\u0153\u2013\u2014\u201C\u201D\u2018\u2019\xF7\u25CA\xFF\u0178\u2044\u20AC\xD0\xF0\xDE\xFE\xFD\xB7\u201A\u201E\u2030\xC2\xCA\xC1\xCB\xC8\xCD\xCE\xCF\xCC\xD3\xD4\uF8FF\xD2\xDA\xDB\xD9\u0131\u02C6\u02DC\xAF\u02D8\u02D9\u02DA\xB8\u02DD\u02DB\u02C7","x-mac-inuit":"\u1403\u1404\u1405\u1406\u140A\u140B\u1431\u1432\u1433\u1434\u1438\u1439\u1449\u144E\u144F\u1450\u1451\u1455\u1456\u1466\u146D\u146E\u146F\u1470\u1472\u1473\u1483\u148B\u148C\u148D\u148E\u1490\u1491\xB0\u14A1\u14A5\u14A6\u2022\xB6\u14A7\xAE\xA9\u2122\u14A8\u14AA\u14AB\u14BB\u14C2\u14C3\u14C4\u14C5\u14C7\u14C8\u14D0\u14EF\u14F0\u14F1\u14F2\u14F4\u14F5\u1505\u14D5\u14D6\u14D7\u14D8\u14DA\u14DB\u14EA\u1528\u1529\u152A\u152B\u152D\u2026\xA0\u152E\u153E\u1555\u1556\u1557\u2013\u2014\u201C\u201D\u2018\u2019\u1558\u1559\u155A\u155D\u1546\u1547\u1548\u1549\u154B\u154C\u1550\u157F\u1580\u1581\u1582\u1583\u1584\u1585\u158F\u1590\u1591\u1592\u1593\u1594\u1595\u1671\u1672\u1673\u1674\u1675\u1676\u1596\u15A0\u15A1\u15A2\u15A3\u15A4\u15A5\u15A6\u157C\u0141\u0142","x-mac-ce":"\xC4\u0100\u0101\xC9\u0104\xD6\xDC\xE1\u0105\u010C\xE4\u010D\u0106\u0107\xE9\u0179\u017A\u010E\xED\u010F\u0112\u0113\u0116\xF3\u0117\xF4\xF6\xF5\xFA\u011A\u011B\xFC\u2020\xB0\u0118\xA3\xA7\u2022\xB6\xDF\xAE\xA9\u2122\u0119\xA8\u2260\u0123\u012E\u012F\u012A\u2264\u2265\u012B\u0136\u2202\u2211\u0142\u013B\u013C\u013D\u013E\u0139\u013A\u0145\u0146\u0143\xAC\u221A\u0144\u0147\u2206\xAB\xBB\u2026\xA0\u0148\u0150\xD5\u0151\u014C\u2013\u2014\u201C\u201D\u2018\u2019\xF7\u25CA\u014D\u0154\u0155\u0158\u2039\u203A\u0159\u0156\u0157\u0160\u201A\u201E\u0161\u015A\u015B\xC1\u0164\u0165\xCD\u017D\u017E\u016A\xD3\xD4\u016B\u016E\xDA\u016F\u0170\u0171\u0172\u0173\xDD\xFD\u0137\u017B\u0141\u017C\u0122\u02C7",macintosh:"\xC4\xC5\xC7\xC9\xD1\xD6\xDC\xE1\xE0\xE2\xE4\xE3\xE5\xE7\xE9\xE8\xEA\xEB\xED\xEC\xEE\xEF\xF1\xF3\xF2\xF4\xF6\xF5\xFA\xF9\xFB\xFC\u2020\xB0\xA2\xA3\xA7\u2022\xB6\xDF\xAE\xA9\u2122\xB4\xA8\u2260\xC6\xD8\u221E\xB1\u2264\u2265\xA5\xB5\u2202\u2211\u220F\u03C0\u222B\xAA\xBA\u03A9\xE6\xF8\xBF\xA1\xAC\u221A\u0192\u2248\u2206\xAB\xBB\u2026\xA0\xC0\xC3\xD5\u0152\u0153\u2013\u2014\u201C\u201D\u2018\u2019\xF7\u25CA\xFF\u0178\u2044\u20AC\u2039\u203A\uFB01\uFB02\u2021\xB7\u201A\u201E\u2030\xC2\xCA\xC1\xCB\xC8\xCD\xCE\xCF\xCC\xD3\xD4\uF8FF\xD2\xDA\xDB\xD9\u0131\u02C6\u02DC\xAF\u02D8\u02D9\u02DA\xB8\u02DD\u02DB\u02C7","x-mac-romanian":"\xC4\xC5\xC7\xC9\xD1\xD6\xDC\xE1\xE0\xE2\xE4\xE3\xE5\xE7\xE9\xE8\xEA\xEB\xED\xEC\xEE\xEF\xF1\xF3\xF2\xF4\xF6\xF5\xFA\xF9\xFB\xFC\u2020\xB0\xA2\xA3\xA7\u2022\xB6\xDF\xAE\xA9\u2122\xB4\xA8\u2260\u0102\u0218\u221E\xB1\u2264\u2265\xA5\xB5\u2202\u2211\u220F\u03C0\u222B\xAA\xBA\u03A9\u0103\u0219\xBF\xA1\xAC\u221A\u0192\u2248\u2206\xAB\xBB\u2026\xA0\xC0\xC3\xD5\u0152\u0153\u2013\u2014\u201C\u201D\u2018\u2019\xF7\u25CA\xFF\u0178\u2044\u20AC\u2039\u203A\u021A\u021B\u2021\xB7\u201A\u201E\u2030\xC2\xCA\xC1\xCB\xC8\xCD\xCE\xCF\xCC\xD3\xD4\uF8FF\xD2\xDA\xDB\xD9\u0131\u02C6\u02DC\xAF\u02D8\u02D9\u02DA\xB8\u02DD\u02DB\u02C7","x-mac-turkish":"\xC4\xC5\xC7\xC9\xD1\xD6\xDC\xE1\xE0\xE2\xE4\xE3\xE5\xE7\xE9\xE8\xEA\xEB\xED\xEC\xEE\xEF\xF1\xF3\xF2\xF4\xF6\xF5\xFA\xF9\xFB\xFC\u2020\xB0\xA2\xA3\xA7\u2022\xB6\xDF\xAE\xA9\u2122\xB4\xA8\u2260\xC6\xD8\u221E\xB1\u2264\u2265\xA5\xB5\u2202\u2211\u220F\u03C0\u222B\xAA\xBA\u03A9\xE6\xF8\xBF\xA1\xAC\u221A\u0192\u2248\u2206\xAB\xBB\u2026\xA0\xC0\xC3\xD5\u0152\u0153\u2013\u2014\u201C\u201D\u2018\u2019\xF7\u25CA\xFF\u0178\u011E\u011F\u0130\u0131\u015E\u015F\u2021\xB7\u201A\u201E\u2030\xC2\xCA\xC1\xCB\xC8\xCD\xCE\xCF\xCC\xD3\xD4\uF8FF\xD2\xDA\xDB\xD9\uF8A0\u02C6\u02DC\xAF\u02D8\u02D9\u02DA\xB8\u02DD\u02DB\u02C7"};ur.MACSTRING=function(n,o,h,c){var u=ci[c];if(u!==void 0){for(var g="",p=0;p<h;p++){var A=n.getUint8(o+p);A<=127?g+=String.fromCharCode(A):g+=u[A&127]}return g}};var ui=typeof WeakMap=="function"&&new WeakMap,Ys,Hi=function(n){if(!Ys){Ys={};for(var o in ci)Ys[o]=new String(o)}var h=Ys[n];if(h!==void 0){if(ui){var c=ui.get(h);if(c!==void 0)return c}var u=ci[n];if(u!==void 0){for(var g={},p=0;p<u.length;p++)g[u.charCodeAt(p)]=p+128;return ui&&ui.set(h,g),g}}};at.MACSTRING=function(n,o){var h=Hi(o);if(h!==void 0){for(var c=[],u=0;u<n.length;u++){var g=n.charCodeAt(u);if(g>=128&&(g=h[g],g===void 0))return;c[u]=g}return c}},Ot.MACSTRING=function(n,o){var h=at.MACSTRING(n,o);return h!==void 0?h.length:0};function _i(n){return n>=-128&&n<=127}function Co(n,o,h){for(var c=0,u=n.length;o<u&&c<64&&n[o]===0;)++o,++c;return h.push(128|c-1),o}function To(n,o,h){for(var c=0,u=n.length,g=o;g<u&&c<64;){var p=n[g];if(!_i(p)||p===0&&g+1<u&&n[g+1]===0)break;++g,++c}h.push(c-1);for(var A=o;A<g;++A)h.push(n[A]+256&255);return g}function Ro(n,o,h){for(var c=0,u=n.length,g=o;g<u&&c<64;){var p=n[g];if(p===0||_i(p)&&g+1<u&&_i(n[g+1]))break;++g,++c}h.push(64|c-1);for(var A=o;A<g;++A){var y=n[A];h.push(y+65536>>8&255,y+256&255)}return g}at.VARDELTAS=function(n){for(var o=0,h=[];o<n.length;){var c=n[o];c===0?o=Co(n,o,h):c>=-128&&c<=127?o=To(n,o,h):o=Ro(n,o,h)}return h},at.INDEX=function(n){for(var o=1,h=[o],c=[],u=0;u<n.length;u+=1){var g=at.OBJECT(n[u]);Array.prototype.push.apply(c,g),o+=g.length,h.push(o)}if(c.length===0)return[0,0];for(var p=[],A=1+Math.floor(Math.log(o)/Math.log(2))/8|0,y=[void 0,at.BYTE,at.USHORT,at.UINT24,at.ULONG][A],P=0;P<h.length;P+=1){var E=y(h[P]);Array.prototype.push.apply(p,E)}return Array.prototype.concat(at.Card16(n.length),at.OffSize(A),p,c)},Ot.INDEX=function(n){return at.INDEX(n).length},at.DICT=function(n){for(var o=[],h=Object.keys(n),c=h.length,u=0;u<c;u+=1){var g=parseInt(h[u],0),p=n[g];o=o.concat(at.OPERAND(p.value,p.type)),o=o.concat(at.OPERATOR(g))}return o},Ot.DICT=function(n){return at.DICT(n).length},at.OPERATOR=function(n){return n<1200?[n]:[12,n-1200]},at.OPERAND=function(n,o){var h=[];if(Array.isArray(o))for(var c=0;c<o.length;c+=1)bt.argument(n.length===o.length,"Not enough arguments given for type"+o),h=h.concat(at.OPERAND(n[c],o[c]));else if(o==="SID")h=h.concat(at.NUMBER(n));else if(o==="offset")h=h.concat(at.NUMBER32(n));else if(o==="number")h=h.concat(at.NUMBER(n));else if(o==="real")h=h.concat(at.REAL(n));else throw new Error("Unknown operand type "+o);return h},at.OP=at.BYTE,Ot.OP=Ot.BYTE;var Wr=typeof WeakMap=="function"&&new WeakMap;at.CHARSTRING=function(n){if(Wr){var o=Wr.get(n);if(o!==void 0)return o}for(var h=[],c=n.length,u=0;u<c;u+=1){var g=n[u];h=h.concat(at[g.type](g.value))}return Wr&&Wr.set(n,h),h},Ot.CHARSTRING=function(n){return at.CHARSTRING(n).length},at.OBJECT=function(n){var o=at[n.type];return bt.argument(o!==void 0,"No encoding function for type "+n.type),o(n.value)},Ot.OBJECT=function(n){var o=Ot[n.type];return bt.argument(o!==void 0,"No sizeOf function for type "+n.type),o(n.value)},at.TABLE=function(n){for(var o=[],h=n.fields.length,c=[],u=[],g=0;g<h;g+=1){var p=n.fields[g],A=at[p.type];bt.argument(A!==void 0,"No encoding function for field type "+p.type+" ("+p.name+")");var y=n[p.name];y===void 0&&(y=p.value);var P=A(y);p.type==="TABLE"?(u.push(o.length),o=o.concat([0,0]),c.push(P)):o=o.concat(P)}for(var E=0;E<c.length;E+=1){var O=u[E],C=o.length;bt.argument(C<65536,"Table "+n.tableName+" too big."),o[O]=C>>8,o[O+1]=C&255,o=o.concat(c[E])}return o},Ot.TABLE=function(n){for(var o=0,h=n.fields.length,c=0;c<h;c+=1){var u=n.fields[c],g=Ot[u.type];bt.argument(g!==void 0,"No sizeOf function for field type "+u.type+" ("+u.name+")");var p=n[u.name];p===void 0&&(p=u.value),o+=g(p),u.type==="TABLE"&&(o+=2)}return o},at.RECORD=at.TABLE,Ot.RECORD=Ot.TABLE,at.LITERAL=function(n){return n},Ot.LITERAL=function(n){return n.length};function we(n,o,h){if(o.length&&(o[0].name!=="coverageFormat"||o[0].value===1))for(var c=0;c<o.length;c+=1){var u=o[c];this[u.name]=u.value}if(this.tableName=n,this.fields=o,h)for(var g=Object.keys(h),p=0;p<g.length;p+=1){var A=g[p],y=h[A];this[A]!==void 0&&(this[A]=y)}}we.prototype.encode=function(){return at.TABLE(this)},we.prototype.sizeOf=function(){return Ot.TABLE(this)};function dr(n,o,h){h===void 0&&(h=o.length);var c=new Array(o.length+1);c[0]={name:n+"Count",type:"USHORT",value:h};for(var u=0;u<o.length;u++)c[u+1]={name:n+u,type:"USHORT",value:o[u]};return c}function Ve(n,o,h){var c=o.length,u=new Array(c+1);u[0]={name:n+"Count",type:"USHORT",value:c};for(var g=0;g<c;g++)u[g+1]={name:n+g,type:"TABLE",value:h(o[g],g)};return u}function fs(n,o,h){var c=o.length,u=[];u[0]={name:n+"Count",type:"USHORT",value:c};for(var g=0;g<c;g++)u=u.concat(h(o[g],g));return u}function is(n){n.format===1?we.call(this,"coverageTable",[{name:"coverageFormat",type:"USHORT",value:1}].concat(dr("glyph",n.glyphs))):n.format===2?we.call(this,"coverageTable",[{name:"coverageFormat",type:"USHORT",value:2}].concat(fs("rangeRecord",n.ranges,function(o){return[{name:"startGlyphID",type:"USHORT",value:o.start},{name:"endGlyphID",type:"USHORT",value:o.end},{name:"startCoverageIndex",type:"USHORT",value:o.index}]}))):bt.assert(!1,"Coverage format must be 1 or 2.")}is.prototype=Object.create(we.prototype),is.prototype.constructor=is;function di(n){we.call(this,"scriptListTable",fs("scriptRecord",n,function(o,h){var c=o.script,u=c.defaultLangSys;return bt.assert(!!u,"Unable to write GSUB: script "+o.tag+" has no default language system."),[{name:"scriptTag"+h,type:"TAG",value:o.tag},{name:"script"+h,type:"TABLE",value:new we("scriptTable",[{name:"defaultLangSys",type:"TABLE",value:new we("defaultLangSys",[{name:"lookupOrder",type:"USHORT",value:0},{name:"reqFeatureIndex",type:"USHORT",value:u.reqFeatureIndex}].concat(dr("featureIndex",u.featureIndexes)))}].concat(fs("langSys",c.langSysRecords,function(g,p){var A=g.langSys;return[{name:"langSysTag"+p,type:"TAG",value:g.tag},{name:"langSys"+p,type:"TABLE",value:new we("langSys",[{name:"lookupOrder",type:"USHORT",value:0},{name:"reqFeatureIndex",type:"USHORT",value:A.reqFeatureIndex}].concat(dr("featureIndex",A.featureIndexes)))}]})))}]}))}di.prototype=Object.create(we.prototype),di.prototype.constructor=di;function fi(n){we.call(this,"featureListTable",fs("featureRecord",n,function(o,h){var c=o.feature;return[{name:"featureTag"+h,type:"TAG",value:o.tag},{name:"feature"+h,type:"TABLE",value:new we("featureTable",[{name:"featureParams",type:"USHORT",value:c.featureParams}].concat(dr("lookupListIndex",c.lookupListIndexes)))}]}))}fi.prototype=Object.create(we.prototype),fi.prototype.constructor=fi;function bs(n,o){we.call(this,"lookupListTable",Ve("lookup",n,function(h){var c=o[h.lookupType];return bt.assert(!!c,"Unable to write GSUB lookup type "+h.lookupType+" tables."),new we("lookupTable",[{name:"lookupType",type:"USHORT",value:h.lookupType},{name:"lookupFlag",type:"USHORT",value:h.lookupFlag}].concat(Ve("subtable",h.subtables,c)))}))}bs.prototype=Object.create(we.prototype),bs.prototype.constructor=bs;var pt={Table:we,Record:we,Coverage:is,ScriptList:di,FeatureList:fi,LookupList:bs,ushortList:dr,tableList:Ve,recordList:fs};function Pn(n,o){return n.getUint8(o)}function zr(n,o){return n.getUint16(o,!1)}function gi(n,o){return n.getInt16(o,!1)}function Gi(n,o){return n.getUint32(o,!1)}function Xi(n,o){var h=n.getInt16(o,!1),c=n.getUint16(o+2,!1);return h+c/65535}function No(n,o){for(var h="",c=o;c<o+4;c+=1)h+=String.fromCharCode(n.getInt8(c));return h}function En(n,o,h){for(var c=0,u=0;u<h;u+=1)c<<=8,c+=n.getUint8(o+u);return c}function Wi(n,o,h){for(var c=[],u=o;u<h;u+=1)c.push(n.getUint8(u));return c}function te(n){for(var o="",h=0;h<n.length;h+=1)o+=String.fromCharCode(n[h]);return o}var Lo={byte:1,uShort:2,short:2,uLong:4,fixed:4,longDateTime:8,tag:4};function F(n,o){this.data=n,this.offset=o,this.relativeOffset=0}F.prototype.parseByte=function(){var n=this.data.getUint8(this.offset+this.relativeOffset);return this.relativeOffset+=1,n},F.prototype.parseChar=function(){var n=this.data.getInt8(this.offset+this.relativeOffset);return this.relativeOffset+=1,n},F.prototype.parseCard8=F.prototype.parseByte,F.prototype.parseUShort=function(){var n=this.data.getUint16(this.offset+this.relativeOffset);return this.relativeOffset+=2,n},F.prototype.parseCard16=F.prototype.parseUShort,F.prototype.parseSID=F.prototype.parseUShort,F.prototype.parseOffset16=F.prototype.parseUShort,F.prototype.parseShort=function(){var n=this.data.getInt16(this.offset+this.relativeOffset);return this.relativeOffset+=2,n},F.prototype.parseF2Dot14=function(){var n=this.data.getInt16(this.offset+this.relativeOffset)/16384;return this.relativeOffset+=2,n},F.prototype.parseULong=function(){var n=Gi(this.data,this.offset+this.relativeOffset);return this.relativeOffset+=4,n},F.prototype.parseOffset32=F.prototype.parseULong,F.prototype.parseFixed=function(){var n=Xi(this.data,this.offset+this.relativeOffset);return this.relativeOffset+=4,n},F.prototype.parseString=function(n){var o=this.data,h=this.offset+this.relativeOffset,c="";this.relativeOffset+=n;for(var u=0;u<n;u++)c+=String.fromCharCode(o.getUint8(h+u));return c},F.prototype.parseTag=function(){return this.parseString(4)},F.prototype.parseLongDateTime=function(){var n=Gi(this.data,this.offset+this.relativeOffset+4);return n-=2082844800,this.relativeOffset+=8,n},F.prototype.parseVersion=function(n){var o=zr(this.data,this.offset+this.relativeOffset),h=zr(this.data,this.offset+this.relativeOffset+2);return this.relativeOffset+=4,n===void 0&&(n=4096),o+h/n/10},F.prototype.skip=function(n,o){o===void 0&&(o=1),this.relativeOffset+=Lo[n]*o},F.prototype.parseULongList=function(n){n===void 0&&(n=this.parseULong());for(var o=new Array(n),h=this.data,c=this.offset+this.relativeOffset,u=0;u<n;u++)o[u]=h.getUint32(c),c+=4;return this.relativeOffset+=n*4,o},F.prototype.parseOffset16List=F.prototype.parseUShortList=function(n){n===void 0&&(n=this.parseUShort());for(var o=new Array(n),h=this.data,c=this.offset+this.relativeOffset,u=0;u<n;u++)o[u]=h.getUint16(c),c+=2;return this.relativeOffset+=n*2,o},F.prototype.parseShortList=function(n){for(var o=new Array(n),h=this.data,c=this.offset+this.relativeOffset,u=0;u<n;u++)o[u]=h.getInt16(c),c+=2;return this.relativeOffset+=n*2,o},F.prototype.parseByteList=function(n){for(var o=new Array(n),h=this.data,c=this.offset+this.relativeOffset,u=0;u<n;u++)o[u]=h.getUint8(c++);return this.relativeOffset+=n,o},F.prototype.parseList=function(n,o){o||(o=n,n=this.parseUShort());for(var h=new Array(n),c=0;c<n;c++)h[c]=o.call(this);return h},F.prototype.parseList32=function(n,o){o||(o=n,n=this.parseULong());for(var h=new Array(n),c=0;c<n;c++)h[c]=o.call(this);return h},F.prototype.parseRecordList=function(n,o){o||(o=n,n=this.parseUShort());for(var h=new Array(n),c=Object.keys(o),u=0;u<n;u++){for(var g={},p=0;p<c.length;p++){var A=c[p],y=o[A];g[A]=y.call(this)}h[u]=g}return h},F.prototype.parseRecordList32=function(n,o){o||(o=n,n=this.parseULong());for(var h=new Array(n),c=Object.keys(o),u=0;u<n;u++){for(var g={},p=0;p<c.length;p++){var A=c[p],y=o[A];g[A]=y.call(this)}h[u]=g}return h},F.prototype.parseStruct=function(n){if(typeof n=="function")return n.call(this);for(var o=Object.keys(n),h={},c=0;c<o.length;c++){var u=o[c],g=n[u];h[u]=g.call(this)}return h},F.prototype.parseValueRecord=function(n){if(n===void 0&&(n=this.parseUShort()),n!==0){var o={};return n&1&&(o.xPlacement=this.parseShort()),n&2&&(o.yPlacement=this.parseShort()),n&4&&(o.xAdvance=this.parseShort()),n&8&&(o.yAdvance=this.parseShort()),n&16&&(o.xPlaDevice=void 0,this.parseShort()),n&32&&(o.yPlaDevice=void 0,this.parseShort()),n&64&&(o.xAdvDevice=void 0,this.parseShort()),n&128&&(o.yAdvDevice=void 0,this.parseShort()),o}},F.prototype.parseValueRecordList=function(){for(var n=this.parseUShort(),o=this.parseUShort(),h=new Array(o),c=0;c<o;c++)h[c]=this.parseValueRecord(n);return h},F.prototype.parsePointer=function(n){var o=this.parseOffset16();if(o>0)return new F(this.data,this.offset+o).parseStruct(n)},F.prototype.parsePointer32=function(n){var o=this.parseOffset32();if(o>0)return new F(this.data,this.offset+o).parseStruct(n)},F.prototype.parseListOfLists=function(n){for(var o=this.parseOffset16List(),h=o.length,c=this.relativeOffset,u=new Array(h),g=0;g<h;g++){var p=o[g];if(p===0){u[g]=void 0;continue}if(this.relativeOffset=p,n){for(var A=this.parseOffset16List(),y=new Array(A.length),P=0;P<A.length;P++)this.relativeOffset=p+A[P],y[P]=n.call(this);u[g]=y}else u[g]=this.parseUShortList()}return this.relativeOffset=c,u},F.prototype.parseCoverage=function(){var n=this.offset+this.relativeOffset,o=this.parseUShort(),h=this.parseUShort();if(o===1)return{format:1,glyphs:this.parseUShortList(h)};if(o===2){for(var c=new Array(h),u=0;u<h;u++)c[u]={start:this.parseUShort(),end:this.parseUShort(),index:this.parseUShort()};return{format:2,ranges:c}}throw new Error("0x"+n.toString(16)+": Coverage format must be 1 or 2.")},F.prototype.parseClassDef=function(){var n=this.offset+this.relativeOffset,o=this.parseUShort();if(o===1)return{format:1,startGlyph:this.parseUShort(),classes:this.parseUShortList()};if(o===2)return{format:2,ranges:this.parseRecordList({start:F.uShort,end:F.uShort,classId:F.uShort})};throw new Error("0x"+n.toString(16)+": ClassDef format must be 1 or 2.")},F.list=function(n,o){return function(){return this.parseList(n,o)}},F.list32=function(n,o){return function(){return this.parseList32(n,o)}},F.recordList=function(n,o){return function(){return this.parseRecordList(n,o)}},F.recordList32=function(n,o){return function(){return this.parseRecordList32(n,o)}},F.pointer=function(n){return function(){return this.parsePointer(n)}},F.pointer32=function(n){return function(){return this.parsePointer32(n)}},F.tag=F.prototype.parseTag,F.byte=F.prototype.parseByte,F.uShort=F.offset16=F.prototype.parseUShort,F.uShortList=F.prototype.parseUShortList,F.uLong=F.offset32=F.prototype.parseULong,F.uLongList=F.prototype.parseULongList,F.struct=F.prototype.parseStruct,F.coverage=F.prototype.parseCoverage,F.classDef=F.prototype.parseClassDef;var pi={reserved:F.uShort,reqFeatureIndex:F.uShort,featureIndexes:F.uShortList};F.prototype.parseScriptList=function(){return this.parsePointer(F.recordList({tag:F.tag,script:F.pointer({defaultLangSys:F.pointer(pi),langSysRecords:F.recordList({tag:F.tag,langSys:F.pointer(pi)})})}))||[]},F.prototype.parseFeatureList=function(){return this.parsePointer(F.recordList({tag:F.tag,feature:F.pointer({featureParams:F.offset16,lookupListIndexes:F.uShortList})}))||[]},F.prototype.parseLookupList=function(n){return this.parsePointer(F.list(F.pointer(function(){var o=this.parseUShort();bt.argument(1<=o&&o<=9,"GPOS/GSUB lookup type "+o+" unknown.");var h=this.parseUShort(),c=h&16;return{lookupType:o,lookupFlag:h,subtables:this.parseList(F.pointer(n[o])),markFilteringSet:c?this.parseUShort():void 0}})))||[]},F.prototype.parseFeatureVariationsList=function(){return this.parsePointer32(function(){var n=this.parseUShort(),o=this.parseUShort();bt.argument(n===1&&o<1,"GPOS/GSUB feature variations table unknown.");var h=this.parseRecordList32({conditionSetOffset:F.offset32,featureTableSubstitutionOffset:F.offset32});return h})||[]};var St={getByte:Pn,getCard8:Pn,getUShort:zr,getCard16:zr,getShort:gi,getULong:Gi,getFixed:Xi,getTag:No,getOffset:En,getBytes:Wi,bytesToString:te,Parser:F};function Dn(n,o){o.parseUShort(),n.length=o.parseULong(),n.language=o.parseULong();var h;n.groupCount=h=o.parseULong(),n.glyphIndexMap={};for(var c=0;c<h;c+=1)for(var u=o.parseULong(),g=o.parseULong(),p=o.parseULong(),A=u;A<=g;A+=1)n.glyphIndexMap[A]=p,p++}function Cn(n,o,h,c,u){n.length=o.parseUShort(),n.language=o.parseUShort();var g;n.segCount=g=o.parseUShort()>>1,o.skip("uShort",3),n.glyphIndexMap={};for(var p=new St.Parser(h,c+u+14),A=new St.Parser(h,c+u+16+g*2),y=new St.Parser(h,c+u+16+g*4),P=new St.Parser(h,c+u+16+g*6),E=c+u+16+g*8,O=0;O<g-1;O+=1)for(var C=void 0,B=p.parseUShort(),Z=A.parseUShort(),mt=y.parseShort(),ht=P.parseUShort(),ft=Z;ft<=B;ft+=1)ht!==0?(E=P.offset+P.relativeOffset-2,E+=ht,E+=(ft-Z)*2,C=St.getUShort(h,E),C!==0&&(C=C+mt&65535)):C=ft+mt&65535,n.glyphIndexMap[ft]=C}function fr(n,o){var h={};h.version=St.getUShort(n,o),bt.argument(h.version===0,"cmap table version should be 0."),h.numTables=St.getUShort(n,o+2);for(var c=-1,u=h.numTables-1;u>=0;u-=1){var g=St.getUShort(n,o+4+u*8),p=St.getUShort(n,o+4+u*8+2);if(g===3&&(p===0||p===1||p===10)||g===0&&(p===0||p===1||p===2||p===3||p===4)){c=St.getULong(n,o+4+u*8+4);break}}if(c===-1)throw new Error("No valid cmap sub-tables found.");var A=new St.Parser(n,o+c);if(h.format=A.parseUShort(),h.format===12)Dn(h,A);else if(h.format===4)Cn(h,A,n,o,c);else throw new Error("Only format 4 and 12 cmap tables are supported (found format "+h.format+").");return h}function Tn(n,o,h){n.segments.push({end:o,start:o,delta:-(o-h),offset:0,glyphIndex:h})}function Mo(n){n.segments.push({end:65535,start:65535,delta:1,offset:0})}function Rn(n){var o=!0,h;for(h=n.length-1;h>0;h-=1){var c=n.get(h);if(c.unicode>65535){console.log("Adding CMAP format 12 (needed!)"),o=!1;break}}var u=[{name:"version",type:"USHORT",value:0},{name:"numTables",type:"USHORT",value:o?1:2},{name:"platformID",type:"USHORT",value:3},{name:"encodingID",type:"USHORT",value:1},{name:"offset",type:"ULONG",value:o?12:20}];o||(u=u.concat([{name:"cmap12PlatformID",type:"USHORT",value:3},{name:"cmap12EncodingID",type:"USHORT",value:10},{name:"cmap12Offset",type:"ULONG",value:0}])),u=u.concat([{name:"format",type:"USHORT",value:4},{name:"cmap4Length",type:"USHORT",value:0},{name:"language",type:"USHORT",value:0},{name:"segCountX2",type:"USHORT",value:0},{name:"searchRange",type:"USHORT",value:0},{name:"entrySelector",type:"USHORT",value:0},{name:"rangeShift",type:"USHORT",value:0}]);var g=new pt.Table("cmap",u);for(g.segments=[],h=0;h<n.length;h+=1){for(var p=n.get(h),A=0;A<p.unicodes.length;A+=1)Tn(g,p.unicodes[A],h);g.segments=g.segments.sort(function(_t,wt){return _t.start-wt.start})}Mo(g);var y=g.segments.length,P=0,E=[],O=[],C=[],B=[],Z=[],mt=[];for(h=0;h<y;h+=1){var ht=g.segments[h];ht.end<=65535&&ht.start<=65535?(E=E.concat({name:"end_"+h,type:"USHORT",value:ht.end}),O=O.concat({name:"start_"+h,type:"USHORT",value:ht.start}),C=C.concat({name:"idDelta_"+h,type:"SHORT",value:ht.delta}),B=B.concat({name:"idRangeOffset_"+h,type:"USHORT",value:ht.offset}),ht.glyphId!==void 0&&(Z=Z.concat({name:"glyph_"+h,type:"USHORT",value:ht.glyphId}))):P+=1,!o&&ht.glyphIndex!==void 0&&(mt=mt.concat({name:"cmap12Start_"+h,type:"ULONG",value:ht.start}),mt=mt.concat({name:"cmap12End_"+h,type:"ULONG",value:ht.end}),mt=mt.concat({name:"cmap12Glyph_"+h,type:"ULONG",value:ht.glyphIndex}))}if(g.segCountX2=(y-P)*2,g.searchRange=Math.pow(2,Math.floor(Math.log(y-P)/Math.log(2)))*2,g.entrySelector=Math.log(g.searchRange/2)/Math.log(2),g.rangeShift=g.segCountX2-g.searchRange,g.fields=g.fields.concat(E),g.fields.push({name:"reservedPad",type:"USHORT",value:0}),g.fields=g.fields.concat(O),g.fields=g.fields.concat(C),g.fields=g.fields.concat(B),g.fields=g.fields.concat(Z),g.cmap4Length=14+E.length*2+2+O.length*2+C.length*2+B.length*2+Z.length*2,!o){var ft=16+mt.length*4;g.cmap12Offset=12+2*2+4+g.cmap4Length,g.fields=g.fields.concat([{name:"cmap12Format",type:"USHORT",value:12},{name:"cmap12Reserved",type:"USHORT",value:0},{name:"cmap12Length",type:"ULONG",value:ft},{name:"cmap12Language",type:"ULONG",value:0},{name:"cmap12nGroups",type:"ULONG",value:mt.length/3}]),g.fields=g.fields.concat(mt)}return g}var gr={parse:fr,make:Rn},Yr=[".notdef","space","exclam","quotedbl","numbersign","dollar","percent","ampersand","quoteright","parenleft","parenright","asterisk","plus","comma","hyphen","period","slash","zero","one","two","three","four","five","six","seven","eight","nine","colon","semicolon","less","equal","greater","question","at","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","bracketleft","backslash","bracketright","asciicircum","underscore","quoteleft","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","braceleft","bar","braceright","asciitilde","exclamdown","cent","sterling","fraction","yen","florin","section","currency","quotesingle","quotedblleft","guillemotleft","guilsinglleft","guilsinglright","fi","fl","endash","dagger","daggerdbl","periodcentered","paragraph","bullet","quotesinglbase","quotedblbase","quotedblright","guillemotright","ellipsis","perthousand","questiondown","grave","acute","circumflex","tilde","macron","breve","dotaccent","dieresis","ring","cedilla","hungarumlaut","ogonek","caron","emdash","AE","ordfeminine","Lslash","Oslash","OE","ordmasculine","ae","dotlessi","lslash","oslash","oe","germandbls","onesuperior","logicalnot","mu","trademark","Eth","onehalf","plusminus","Thorn","onequarter","divide","brokenbar","degree","thorn","threequarters","twosuperior","registered","minus","eth","multiply","threesuperior","copyright","Aacute","Acircumflex","Adieresis","Agrave","Aring","Atilde","Ccedilla","Eacute","Ecircumflex","Edieresis","Egrave","Iacute","Icircumflex","Idieresis","Igrave","Ntilde","Oacute","Ocircumflex","Odieresis","Ograve","Otilde","Scaron","Uacute","Ucircumflex","Udieresis","Ugrave","Yacute","Ydieresis","Zcaron","aacute","acircumflex","adieresis","agrave","aring","atilde","ccedilla","eacute","ecircumflex","edieresis","egrave","iacute","icircumflex","idieresis","igrave","ntilde","oacute","ocircumflex","odieresis","ograve","otilde","scaron","uacute","ucircumflex","udieresis","ugrave","yacute","ydieresis","zcaron","exclamsmall","Hungarumlautsmall","dollaroldstyle","dollarsuperior","ampersandsmall","Acutesmall","parenleftsuperior","parenrightsuperior","266 ff","onedotenleader","zerooldstyle","oneoldstyle","twooldstyle","threeoldstyle","fouroldstyle","fiveoldstyle","sixoldstyle","sevenoldstyle","eightoldstyle","nineoldstyle","commasuperior","threequartersemdash","periodsuperior","questionsmall","asuperior","bsuperior","centsuperior","dsuperior","esuperior","isuperior","lsuperior","msuperior","nsuperior","osuperior","rsuperior","ssuperior","tsuperior","ff","ffi","ffl","parenleftinferior","parenrightinferior","Circumflexsmall","hyphensuperior","Gravesmall","Asmall","Bsmall","Csmall","Dsmall","Esmall","Fsmall","Gsmall","Hsmall","Ismall","Jsmall","Ksmall","Lsmall","Msmall","Nsmall","Osmall","Psmall","Qsmall","Rsmall","Ssmall","Tsmall","Usmall","Vsmall","Wsmall","Xsmall","Ysmall","Zsmall","colonmonetary","onefitted","rupiah","Tildesmall","exclamdownsmall","centoldstyle","Lslashsmall","Scaronsmall","Zcaronsmall","Dieresissmall","Brevesmall","Caronsmall","Dotaccentsmall","Macronsmall","figuredash","hypheninferior","Ogoneksmall","Ringsmall","Cedillasmall","questiondownsmall","oneeighth","threeeighths","fiveeighths","seveneighths","onethird","twothirds","zerosuperior","foursuperior","fivesuperior","sixsuperior","sevensuperior","eightsuperior","ninesuperior","zeroinferior","oneinferior","twoinferior","threeinferior","fourinferior","fiveinferior","sixinferior","seveninferior","eightinferior","nineinferior","centinferior","dollarinferior","periodinferior","commainferior","Agravesmall","Aacutesmall","Acircumflexsmall","Atildesmall","Adieresissmall","Aringsmall","AEsmall","Ccedillasmall","Egravesmall","Eacutesmall","Ecircumflexsmall","Edieresissmall","Igravesmall","Iacutesmall","Icircumflexsmall","Idieresissmall","Ethsmall","Ntildesmall","Ogravesmall","Oacutesmall","Ocircumflexsmall","Otildesmall","Odieresissmall","OEsmall","Oslashsmall","Ugravesmall","Uacutesmall","Ucircumflexsmall","Udieresissmall","Yacutesmall","Thornsmall","Ydieresissmall","001.000","001.001","001.002","001.003","Black","Bold","Book","Light","Medium","Regular","Roman","Semibold"],Oo=["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","space","exclam","quotedbl","numbersign","dollar","percent","ampersand","quoteright","parenleft","parenright","asterisk","plus","comma","hyphen","period","slash","zero","one","two","three","four","five","six","seven","eight","nine","colon","semicolon","less","equal","greater","question","at","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","bracketleft","backslash","bracketright","asciicircum","underscore","quoteleft","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","braceleft","bar","braceright","asciitilde","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","exclamdown","cent","sterling","fraction","yen","florin","section","currency","quotesingle","quotedblleft","guillemotleft","guilsinglleft","guilsinglright","fi","fl","","endash","dagger","daggerdbl","periodcentered","","paragraph","bullet","quotesinglbase","quotedblbase","quotedblright","guillemotright","ellipsis","perthousand","","questiondown","","grave","acute","circumflex","tilde","macron","breve","dotaccent","dieresis","","ring","cedilla","","hungarumlaut","ogonek","caron","emdash","","","","","","","","","","","","","","","","","AE","","ordfeminine","","","","","Lslash","Oslash","OE","ordmasculine","","","","","","ae","","","","dotlessi","","","lslash","oslash","oe","germandbls"],Bo=["","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","space","exclamsmall","Hungarumlautsmall","","dollaroldstyle","dollarsuperior","ampersandsmall","Acutesmall","parenleftsuperior","parenrightsuperior","twodotenleader","onedotenleader","comma","hyphen","period","fraction","zerooldstyle","oneoldstyle","twooldstyle","threeoldstyle","fouroldstyle","fiveoldstyle","sixoldstyle","sevenoldstyle","eightoldstyle","nineoldstyle","colon","semicolon","commasuperior","threequartersemdash","periodsuperior","questionsmall","","asuperior","bsuperior","centsuperior","dsuperior","esuperior","","","isuperior","","","lsuperior","msuperior","nsuperior","osuperior","","","rsuperior","ssuperior","tsuperior","","ff","fi","fl","ffi","ffl","parenleftinferior","","parenrightinferior","Circumflexsmall","hyphensuperior","Gravesmall","Asmall","Bsmall","Csmall","Dsmall","Esmall","Fsmall","Gsmall","Hsmall","Ismall","Jsmall","Ksmall","Lsmall","Msmall","Nsmall","Osmall","Psmall","Qsmall","Rsmall","Ssmall","Tsmall","Usmall","Vsmall","Wsmall","Xsmall","Ysmall","Zsmall","colonmonetary","onefitted","rupiah","Tildesmall","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","","exclamdownsmall","centoldstyle","Lslashsmall","","","Scaronsmall","Zcaronsmall","Dieresissmall","Brevesmall","Caronsmall","","Dotaccentsmall","","","Macronsmall","","","figuredash","hypheninferior","","","Ogoneksmall","Ringsmall","Cedillasmall","","","","onequarter","onehalf","threequarters","questiondownsmall","oneeighth","threeeighths","fiveeighths","seveneighths","onethird","twothirds","","","zerosuperior","onesuperior","twosuperior","threesuperior","foursuperior","fivesuperior","sixsuperior","sevensuperior","eightsuperior","ninesuperior","zeroinferior","oneinferior","twoinferior","threeinferior","fourinferior","fiveinferior","sixinferior","seveninferior","eightinferior","nineinferior","centinferior","dollarinferior","periodinferior","commainferior","Agravesmall","Aacutesmall","Acircumflexsmall","Atildesmall","Adieresissmall","Aringsmall","AEsmall","Ccedillasmall","Egravesmall","Eacutesmall","Ecircumflexsmall","Edieresissmall","Igravesmall","Iacutesmall","Icircumflexsmall","Idieresissmall","Ethsmall","Ntildesmall","Ogravesmall","Oacutesmall","Ocircumflexsmall","Otildesmall","Odieresissmall","OEsmall","Oslashsmall","Ugravesmall","Uacutesmall","Ucircumflexsmall","Udieresissmall","Yacutesmall","Thornsmall","Ydieresissmall"],Ke=[".notdef",".null","nonmarkingreturn","space","exclam","quotedbl","numbersign","dollar","percent","ampersand","quotesingle","parenleft","parenright","asterisk","plus","comma","hyphen","period","slash","zero","one","two","three","four","five","six","seven","eight","nine","colon","semicolon","less","equal","greater","question","at","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","bracketleft","backslash","bracketright","asciicircum","underscore","grave","a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","braceleft","bar","braceright","asciitilde","Adieresis","Aring","Ccedilla","Eacute","Ntilde","Odieresis","Udieresis","aacute","agrave","acircumflex","adieresis","atilde","aring","ccedilla","eacute","egrave","ecircumflex","edieresis","iacute","igrave","icircumflex","idieresis","ntilde","oacute","ograve","ocircumflex","odieresis","otilde","uacute","ugrave","ucircumflex","udieresis","dagger","degree","cent","sterling","section","bullet","paragraph","germandbls","registered","copyright","trademark","acute","dieresis","notequal","AE","Oslash","infinity","plusminus","lessequal","greaterequal","yen","mu","partialdiff","summation","product","pi","integral","ordfeminine","ordmasculine","Omega","ae","oslash","questiondown","exclamdown","logicalnot","radical","florin","approxequal","Delta","guillemotleft","guillemotright","ellipsis","nonbreakingspace","Agrave","Atilde","Otilde","OE","oe","endash","emdash","quotedblleft","quotedblright","quoteleft","quoteright","divide","lozenge","ydieresis","Ydieresis","fraction","currency","guilsinglleft","guilsinglright","fi","fl","daggerdbl","periodcentered","quotesinglbase","quotedblbase","perthousand","Acircumflex","Ecircumflex","Aacute","Edieresis","Egrave","Iacute","Icircumflex","Idieresis","Igrave","Oacute","Ocircumflex","apple","Ograve","Uacute","Ucircumflex","Ugrave","dotlessi","circumflex","tilde","macron","breve","dotaccent","ring","cedilla","hungarumlaut","ogonek","caron","Lslash","lslash","Scaron","scaron","Zcaron","zcaron","brokenbar","Eth","eth","Yacute","yacute","Thorn","thorn","minus","multiply","onesuperior","twosuperior","threesuperior","onehalf","onequarter","threequarters","franc","Gbreve","gbreve","Idotaccent","Scedilla","scedilla","Cacute","cacute","Ccaron","ccaron","dcroat"];function ks(n){this.font=n}ks.prototype.charToGlyphIndex=function(n){var o=n.codePointAt(0),h=this.font.glyphs;if(h){for(var c=0;c<h.length;c+=1)for(var u=h.get(c),g=0;g<u.unicodes.length;g+=1)if(u.unicodes[g]===o)return c}return null};function pr(n){this.cmap=n}pr.prototype.charToGlyphIndex=function(n){return this.cmap.glyphIndexMap[n.codePointAt(0)]||0};function mr(n,o){this.encoding=n,this.charset=o}mr.prototype.charToGlyphIndex=function(n){var o=n.codePointAt(0),h=this.encoding[o];return this.charset.indexOf(h)};function zi(n){switch(n.version){case 1:this.names=Ke.slice();break;case 2:this.names=new Array(n.numberOfGlyphs);for(var o=0;o<n.numberOfGlyphs;o++)n.glyphNameIndex[o]<Ke.length?this.names[o]=Ke[n.glyphNameIndex[o]]:this.names[o]=n.names[n.glyphNameIndex[o]-Ke.length];break;case 2.5:this.names=new Array(n.numberOfGlyphs);for(var h=0;h<n.numberOfGlyphs;h++)this.names[h]=Ke[h+n.glyphNameIndex[h]];break;case 3:this.names=[];break;default:this.names=[];break}}zi.prototype.nameToGlyphIndex=function(n){return this.names.indexOf(n)},zi.prototype.glyphIndexToName=function(n){return this.names[n]};function Ps(n){for(var o,h=n.tables.cmap.glyphIndexMap,c=Object.keys(h),u=0;u<c.length;u+=1){var g=c[u],p=h[g];o=n.glyphs.get(p),o.addUnicode(parseInt(g))}for(var A=0;A<n.glyphs.length;A+=1)o=n.glyphs.get(A),n.cffEncoding?n.isCIDFont?o.name="gid"+A:o.name=n.cffEncoding.charset[A]:n.glyphNames.names&&(o.name=n.glyphNames.glyphIndexToName(A))}function mi(n){n._IndexToUnicodeMap={};for(var o=n.tables.cmap.glyphIndexMap,h=Object.keys(o),c=0;c<h.length;c+=1){var u=h[c],g=o[u];n._IndexToUnicodeMap[g]===void 0?n._IndexToUnicodeMap[g]={unicodes:[parseInt(u)]}:n._IndexToUnicodeMap[g].unicodes.push(parseInt(u))}}function Io(n,o){o.lowMemory?mi(n):Ps(n)}function v(n,o,h,c,u){n.beginPath(),n.moveTo(o,h),n.lineTo(c,u),n.stroke()}var R={line:v};function G(n,o){var h=o||new $t;return{configurable:!0,get:function(){return typeof h=="function"&&(h=h()),h},set:function(c){h=c}}}function q(n){this.bindConstructorValues(n)}q.prototype.bindConstructorValues=function(n){this.index=n.index||0,this.name=n.name||null,this.unicode=n.unicode||void 0,this.unicodes=n.unicodes||n.unicode!==void 0?[n.unicode]:[],"xMin"in n&&(this.xMin=n.xMin),"yMin"in n&&(this.yMin=n.yMin),"xMax"in n&&(this.xMax=n.xMax),"yMax"in n&&(this.yMax=n.yMax),"advanceWidth"in n&&(this.advanceWidth=n.advanceWidth),Object.defineProperty(this,"path",G(this,n.path))},q.prototype.addUnicode=function(n){this.unicodes.length===0&&(this.unicode=n),this.unicodes.push(n)},q.prototype.getBoundingBox=function(){return this.path.getBoundingBox()},q.prototype.getPath=function(n,o,h,c,u){n=n!==void 0?n:0,o=o!==void 0?o:0,h=h!==void 0?h:72;var g,p;c||(c={});var A=c.xScale,y=c.yScale;if(c.hinting&&u&&u.hinting&&(p=this.path&&u.hinting.exec(this,h)),p)g=u.hinting.getCommands(p),n=Math.round(n),o=Math.round(o),A=y=1;else{g=this.path.commands;var P=1/(this.path.unitsPerEm||1e3)*h;A===void 0&&(A=P),y===void 0&&(y=P)}for(var E=new $t,O=0;O<g.length;O+=1){var C=g[O];C.type==="M"?E.moveTo(n+C.x*A,o+-C.y*y):C.type==="L"?E.lineTo(n+C.x*A,o+-C.y*y):C.type==="Q"?E.quadraticCurveTo(n+C.x1*A,o+-C.y1*y,n+C.x*A,o+-C.y*y):C.type==="C"?E.curveTo(n+C.x1*A,o+-C.y1*y,n+C.x2*A,o+-C.y2*y,n+C.x*A,o+-C.y*y):C.type==="Z"&&E.closePath()}return E},q.prototype.getContours=function(){if(this.points===void 0)return[];for(var n=[],o=[],h=0;h<this.points.length;h+=1){var c=this.points[h];o.push(c),c.lastPointOfContour&&(n.push(o),o=[])}return bt.argument(o.length===0,"There are still points left in the current contour."),n},q.prototype.getMetrics=function(){for(var n=this.path.commands,o=[],h=[],c=0;c<n.length;c+=1){var u=n[c];u.type!=="Z"&&(o.push(u.x),h.push(u.y)),(u.type==="Q"||u.type==="C")&&(o.push(u.x1),h.push(u.y1)),u.type==="C"&&(o.push(u.x2),h.push(u.y2))}var g={xMin:Math.min.apply(null,o),yMin:Math.min.apply(null,h),xMax:Math.max.apply(null,o),yMax:Math.max.apply(null,h),leftSideBearing:this.leftSideBearing};return isFinite(g.xMin)||(g.xMin=0),isFinite(g.xMax)||(g.xMax=this.advanceWidth),isFinite(g.yMin)||(g.yMin=0),isFinite(g.yMax)||(g.yMax=0),g.rightSideBearing=this.advanceWidth-g.leftSideBearing-(g.xMax-g.xMin),g},q.prototype.draw=function(n,o,h,c,u){this.getPath(o,h,c,u).draw(n)},q.prototype.drawPoints=function(n,o,h,c){function u(O,C,B,Z){n.beginPath();for(var mt=0;mt<O.length;mt+=1)n.moveTo(C+O[mt].x*Z,B+O[mt].y*Z),n.arc(C+O[mt].x*Z,B+O[mt].y*Z,2,0,Math.PI*2,!1);n.closePath(),n.fill()}o=o!==void 0?o:0,h=h!==void 0?h:0,c=c!==void 0?c:24;for(var g=1/this.path.unitsPerEm*c,p=[],A=[],y=this.path,P=0;P<y.commands.length;P+=1){var E=y.commands[P];E.x!==void 0&&p.push({x:E.x,y:-E.y}),E.x1!==void 0&&A.push({x:E.x1,y:-E.y1}),E.x2!==void 0&&A.push({x:E.x2,y:-E.y2})}n.fillStyle="blue",u(p,o,h,g),n.fillStyle="red",u(A,o,h,g)},q.prototype.drawMetrics=function(n,o,h,c){var u;o=o!==void 0?o:0,h=h!==void 0?h:0,c=c!==void 0?c:24,u=1/this.path.unitsPerEm*c,n.lineWidth=1,n.strokeStyle="black",R.line(n,o,-1e4,o,1e4),R.line(n,-1e4,h,1e4,h);var g=this.xMin||0,p=this.yMin||0,A=this.xMax||0,y=this.yMax||0,P=this.advanceWidth||0;n.strokeStyle="blue",R.line(n,o+g*u,-1e4,o+g*u,1e4),R.line(n,o+A*u,-1e4,o+A*u,1e4),R.line(n,-1e4,h+-p*u,1e4,h+-p*u),R.line(n,-1e4,h+-y*u,1e4,h+-y*u),n.strokeStyle="green",R.line(n,o+P*u,-1e4,o+P*u,1e4)};function Q(n,o,h){Object.defineProperty(n,o,{get:function(){return n.path,n[h]},set:function(c){n[h]=c},enumerable:!0,configurable:!0})}function K(n,o){if(this.font=n,this.glyphs={},Array.isArray(o))for(var h=0;h<o.length;h++){var c=o[h];c.path.unitsPerEm=n.unitsPerEm,this.glyphs[h]=c}this.length=o&&o.length||0}K.prototype.get=function(n){if(this.glyphs[n]===void 0){this.font._push(n),typeof this.glyphs[n]=="function"&&(this.glyphs[n]=this.glyphs[n]());var o=this.glyphs[n],h=this.font._IndexToUnicodeMap[n];if(h)for(var c=0;c<h.unicodes.length;c++)o.addUnicode(h.unicodes[c]);this.font.cffEncoding?this.font.isCIDFont?o.name="gid"+n:o.name=this.font.cffEncoding.charset[n]:this.font.glyphNames.names&&(o.name=this.font.glyphNames.glyphIndexToName(n)),this.glyphs[n].advanceWidth=this.font._hmtxTableData[n].advanceWidth,this.glyphs[n].leftSideBearing=this.font._hmtxTableData[n].leftSideBearing}else typeof this.glyphs[n]=="function"&&(this.glyphs[n]=this.glyphs[n]());return this.glyphs[n]},K.prototype.push=function(n,o){this.glyphs[n]=o,this.length++};function ut(n,o){return new q({index:o,font:n})}function Mt(n,o,h,c,u,g){return function(){var p=new q({index:o,font:n});return p.path=function(){h(p,c,u);var A=g(n.glyphs,p);return A.unitsPerEm=n.unitsPerEm,A},Q(p,"xMin","_xMin"),Q(p,"xMax","_xMax"),Q(p,"yMin","_yMin"),Q(p,"yMax","_yMax"),p}}function qt(n,o,h,c){return function(){var u=new q({index:o,font:n});return u.path=function(){var g=h(n,u,c);return g.unitsPerEm=n.unitsPerEm,g},u}}var N={GlyphSet:K,glyphLoader:ut,ttfGlyphLoader:Mt,cffGlyphLoader:qt};function T(n,o){if(n===o)return!0;if(Array.isArray(n)&&Array.isArray(o)){if(n.length!==o.length)return!1;for(var h=0;h<n.length;h+=1)if(!T(n[h],o[h]))return!1;return!0}else return!1}function Dt(n){var o;return n.length<1240?o=107:n.length<33900?o=1131:o=32768,o}function I(n,o,h){var c=[],u=[],g=St.getCard16(n,o),p,A;if(g!==0){var y=St.getByte(n,o+2);p=o+(g+1)*y+2;for(var P=o+3,E=0;E<g+1;E+=1)c.push(St.getOffset(n,P,y)),P+=y;A=p+c[g]}else A=o+2;for(var O=0;O<c.length-1;O+=1){var C=St.getBytes(n,p+c[O],p+c[O+1]);h&&(C=h(C)),u.push(C)}return{objects:u,startOffset:o,endOffset:A}}function Ft(n,o){var h=[],c=St.getCard16(n,o),u,g;if(c!==0){var p=St.getByte(n,o+2);u=o+(c+1)*p+2;for(var A=o+3,y=0;y<c+1;y+=1)h.push(St.getOffset(n,A,p)),A+=p;g=u+h[c]}else g=o+2;return{offsets:h,startOffset:o,endOffset:g}}function rt(n,o,h,c,u){var g=St.getCard16(h,c),p=0;if(g!==0){var A=St.getByte(h,c+2);p=c+(g+1)*A+2}var y=St.getBytes(h,p+o[n],p+o[n+1]);return u&&(y=u(y)),y}function ue(n){for(var o="",h=15,c=["0","1","2","3","4","5","6","7","8","9",".","E","E-",null,"-"];;){var u=n.parseByte(),g=u>>4,p=u&15;if(g===h||(o+=c[g],p===h))break;o+=c[p]}return parseFloat(o)}function Fo(n,o){var h,c,u,g;if(o===28)return h=n.parseByte(),c=n.parseByte(),h<<8|c;if(o===29)return h=n.parseByte(),c=n.parseByte(),u=n.parseByte(),g=n.parseByte(),h<<24|c<<16|u<<8|g;if(o===30)return ue(n);if(o>=32&&o<=246)return o-139;if(o>=247&&o<=250)return h=n.parseByte(),(o-247)*256+h+108;if(o>=251&&o<=254)return h=n.parseByte(),-(o-251)*256-h-108;throw new Error("Invalid b0 "+o)}function Uo(n){for(var o={},h=0;h<n.length;h+=1){var c=n[h][0],u=n[h][1],g=void 0;if(u.length===1?g=u[0]:g=u,o.hasOwnProperty(c)&&!isNaN(o[c]))throw new Error("Object "+o+" already has key "+c);o[c]=g}return o}function yr(n,o,h){o=o!==void 0?o:0;var c=new St.Parser(n,o),u=[],g=[];for(h=h!==void 0?h:n.length;c.relativeOffset<h;){var p=c.parseByte();p<=21?(p===12&&(p=1200+c.parseByte()),u.push([p,g]),g=[]):g.push(Fo(c,p))}return Uo(u)}function Ar(n,o){return o<=390?o=Yr[o]:o=n[o-391],o}function Ph(n,o,h){for(var c={},u,g=0;g<o.length;g+=1){var p=o[g];if(Array.isArray(p.type)){var A=[];A.length=p.type.length;for(var y=0;y<p.type.length;y++)u=n[p.op]!==void 0?n[p.op][y]:void 0,u===void 0&&(u=p.value!==void 0&&p.value[y]!==void 0?p.value[y]:null),p.type[y]==="SID"&&(u=Ar(h,u)),A[y]=u;c[p.name]=A}else u=n[p.op],u===void 0&&(u=p.value!==void 0?p.value:null),p.type==="SID"&&(u=Ar(h,u)),c[p.name]=u}return c}function Vt(n,o){var h={};return h.formatMajor=St.getCard8(n,o),h.formatMinor=St.getCard8(n,o+1),h.size=St.getCard8(n,o+2),h.offsetSize=St.getCard8(n,o+3),h.startOffset=o,h.endOffset=o+4,h}var qs=[{name:"version",op:0,type:"SID"},{name:"notice",op:1,type:"SID"},{name:"copyright",op:1200,type:"SID"},{name:"fullName",op:2,type:"SID"},{name:"familyName",op:3,type:"SID"},{name:"weight",op:4,type:"SID"},{name:"isFixedPitch",op:1201,type:"number",value:0},{name:"italicAngle",op:1202,type:"number",value:0},{name:"underlinePosition",op:1203,type:"number",value:-100},{name:"underlineThickness",op:1204,type:"number",value:50},{name:"paintType",op:1205,type:"number",value:0},{name:"charstringType",op:1206,type:"number",value:2},{name:"fontMatrix",op:1207,type:["real","real","real","real","real","real"],value:[.001,0,0,.001,0,0]},{name:"uniqueId",op:13,type:"number"},{name:"fontBBox",op:5,type:["number","number","number","number"],value:[0,0,0,0]},{name:"strokeWidth",op:1208,type:"number",value:0},{name:"xuid",op:14,type:[],value:null},{name:"charset",op:15,type:"offset",value:0},{name:"encoding",op:16,type:"offset",value:0},{name:"charStrings",op:17,type:"offset",value:0},{name:"private",op:18,type:["number","offset"],value:[0,0]},{name:"ros",op:1230,type:["SID","SID","number"]},{name:"cidFontVersion",op:1231,type:"number",value:0},{name:"cidFontRevision",op:1232,type:"number",value:0},{name:"cidFontType",op:1233,type:"number",value:0},{name:"cidCount",op:1234,type:"number",value:8720},{name:"uidBase",op:1235,type:"number"},{name:"fdArray",op:1236,type:"offset"},{name:"fdSelect",op:1237,type:"offset"},{name:"fontName",op:1238,type:"SID"}],Ye=[{name:"subrs",op:19,type:"offset",value:0},{name:"defaultWidthX",op:20,type:"number",value:0},{name:"nominalWidthX",op:21,type:"number",value:0}];function kr(n,o){var h=yr(n,0,n.byteLength);return Ph(h,qs,o)}function gs(n,o,h,c){var u=yr(n,o,h);return Ph(u,Ye,c)}function Ho(n,o,h,c){for(var u=[],g=0;g<h.length;g+=1){var p=new DataView(new Uint8Array(h[g]).buffer),A=kr(p,c);A._subrs=[],A._subrsBias=0,A._defaultWidthX=0,A._nominalWidthX=0;var y=A.private[0],P=A.private[1];if(y!==0&&P!==0){var E=gs(n,P+o,y,c);if(A._defaultWidthX=E.defaultWidthX,A._nominalWidthX=E.nominalWidthX,E.subrs!==0){var O=P+E.subrs,C=I(n,O+o);A._subrs=C.objects,A._subrsBias=Dt(A._subrs)}A._privateDict=E}u.push(A)}return u}function Ju(n,o,h,c){var u,g,p=new St.Parser(n,o);h-=1;var A=[".notdef"],y=p.parseCard8();if(y===0)for(var P=0;P<h;P+=1)u=p.parseSID(),A.push(Ar(c,u));else if(y===1)for(;A.length<=h;){u=p.parseSID(),g=p.parseCard8();for(var E=0;E<=g;E+=1)A.push(Ar(c,u)),u+=1}else if(y===2)for(;A.length<=h;){u=p.parseSID(),g=p.parseCard16();for(var O=0;O<=g;O+=1)A.push(Ar(c,u)),u+=1}else throw new Error("Unknown charset format "+y);return A}function Eh(n,o,h){var c,u={},g=new St.Parser(n,o),p=g.parseCard8();if(p===0)for(var A=g.parseCard8(),y=0;y<A;y+=1)c=g.parseCard8(),u[c]=y;else if(p===1){var P=g.parseCard8();c=1;for(var E=0;E<P;E+=1)for(var O=g.parseCard8(),C=g.parseCard8(),B=O;B<=O+C;B+=1)u[B]=c,c+=1}else throw new Error("Unknown encoding format "+p);return new mr(u,h)}function _o(n,o,h){var c,u,g,p,A=new $t,y=[],P=0,E=!1,O=!1,C=0,B=0,Z,mt,ht,ft;if(n.isCIDFont){var _t=n.tables.cff.topDict._fdSelect[o.index],wt=n.tables.cff.topDict._fdArray[_t];Z=wt._subrs,mt=wt._subrsBias,ht=wt._defaultWidthX,ft=wt._nominalWidthX}else Z=n.tables.cff.topDict._subrs,mt=n.tables.cff.topDict._subrsBias,ht=n.tables.cff.topDict._defaultWidthX,ft=n.tables.cff.topDict._nominalWidthX;var ee=ht;function Xt(Rt,Me){O&&A.closePath(),A.moveTo(Rt,Me),O=!0}function ve(){var Rt;Rt=y.length%2!==0,Rt&&!E&&(ee=y.shift()+ft),P+=y.length>>1,y.length=0,E=!0}function Wt(Rt){for(var Me,Qe,Ze,ps,ke,Re,Be,Ie,_e,Ge,Fe,qe,Se=0;Se<Rt.length;){var Xe=Rt[Se];switch(Se+=1,Xe){case 1:ve();break;case 3:ve();break;case 4:y.length>1&&!E&&(ee=y.shift()+ft,E=!0),B+=y.pop(),Xt(C,B);break;case 5:for(;y.length>0;)C+=y.shift(),B+=y.shift(),A.lineTo(C,B);break;case 6:for(;y.length>0&&(C+=y.shift(),A.lineTo(C,B),y.length!==0);)B+=y.shift(),A.lineTo(C,B);break;case 7:for(;y.length>0&&(B+=y.shift(),A.lineTo(C,B),y.length!==0);)C+=y.shift(),A.lineTo(C,B);break;case 8:for(;y.length>0;)c=C+y.shift(),u=B+y.shift(),g=c+y.shift(),p=u+y.shift(),C=g+y.shift(),B=p+y.shift(),A.curveTo(c,u,g,p,C,B);break;case 10:ke=y.pop()+mt,Re=Z[ke],Re&&Wt(Re);break;case 11:return;case 12:switch(Xe=Rt[Se],Se+=1,Xe){case 35:c=C+y.shift(),u=B+y.shift(),g=c+y.shift(),p=u+y.shift(),Be=g+y.shift(),Ie=p+y.shift(),_e=Be+y.shift(),Ge=Ie+y.shift(),Fe=_e+y.shift(),qe=Ge+y.shift(),C=Fe+y.shift(),B=qe+y.shift(),y.shift(),A.curveTo(c,u,g,p,Be,Ie),A.curveTo(_e,Ge,Fe,qe,C,B);break;case 34:c=C+y.shift(),u=B,g=c+y.shift(),p=u+y.shift(),Be=g+y.shift(),Ie=p,_e=Be+y.shift(),Ge=p,Fe=_e+y.shift(),qe=B,C=Fe+y.shift(),A.curveTo(c,u,g,p,Be,Ie),A.curveTo(_e,Ge,Fe,qe,C,B);break;case 36:c=C+y.shift(),u=B+y.shift(),g=c+y.shift(),p=u+y.shift(),Be=g+y.shift(),Ie=p,_e=Be+y.shift(),Ge=p,Fe=_e+y.shift(),qe=Ge+y.shift(),C=Fe+y.shift(),A.curveTo(c,u,g,p,Be,Ie),A.curveTo(_e,Ge,Fe,qe,C,B);break;case 37:c=C+y.shift(),u=B+y.shift(),g=c+y.shift(),p=u+y.shift(),Be=g+y.shift(),Ie=p+y.shift(),_e=Be+y.shift(),Ge=Ie+y.shift(),Fe=_e+y.shift(),qe=Ge+y.shift(),Math.abs(Fe-C)>Math.abs(qe-B)?C=Fe+y.shift():B=qe+y.shift(),A.curveTo(c,u,g,p,Be,Ie),A.curveTo(_e,Ge,Fe,qe,C,B);break;default:console.log("Glyph "+o.index+": unknown operator 1200"+Xe),y.length=0}break;case 14:y.length>0&&!E&&(ee=y.shift()+ft,E=!0),O&&(A.closePath(),O=!1);break;case 18:ve();break;case 19:case 20:ve(),Se+=P+7>>3;break;case 21:y.length>2&&!E&&(ee=y.shift()+ft,E=!0),B+=y.pop(),C+=y.pop(),Xt(C,B);break;case 22:y.length>1&&!E&&(ee=y.shift()+ft,E=!0),C+=y.pop(),Xt(C,B);break;case 23:ve();break;case 24:for(;y.length>2;)c=C+y.shift(),u=B+y.shift(),g=c+y.shift(),p=u+y.shift(),C=g+y.shift(),B=p+y.shift(),A.curveTo(c,u,g,p,C,B);C+=y.shift(),B+=y.shift(),A.lineTo(C,B);break;case 25:for(;y.length>6;)C+=y.shift(),B+=y.shift(),A.lineTo(C,B);c=C+y.shift(),u=B+y.shift(),g=c+y.shift(),p=u+y.shift(),C=g+y.shift(),B=p+y.shift(),A.curveTo(c,u,g,p,C,B);break;case 26:for(y.length%2&&(C+=y.shift());y.length>0;)c=C,u=B+y.shift(),g=c+y.shift(),p=u+y.shift(),C=g,B=p+y.shift(),A.curveTo(c,u,g,p,C,B);break;case 27:for(y.length%2&&(B+=y.shift());y.length>0;)c=C+y.shift(),u=B,g=c+y.shift(),p=u+y.shift(),C=g+y.shift(),B=p,A.curveTo(c,u,g,p,C,B);break;case 28:Me=Rt[Se],Qe=Rt[Se+1],y.push((Me<<24|Qe<<16)>>16),Se+=2;break;case 29:ke=y.pop()+n.gsubrsBias,Re=n.gsubrs[ke],Re&&Wt(Re);break;case 30:for(;y.length>0&&(c=C,u=B+y.shift(),g=c+y.shift(),p=u+y.shift(),C=g+y.shift(),B=p+(y.length===1?y.shift():0),A.curveTo(c,u,g,p,C,B),y.length!==0);)c=C+y.shift(),u=B,g=c+y.shift(),p=u+y.shift(),B=p+y.shift(),C=g+(y.length===1?y.shift():0),A.curveTo(c,u,g,p,C,B);break;case 31:for(;y.length>0&&(c=C+y.shift(),u=B,g=c+y.shift(),p=u+y.shift(),B=p+y.shift(),C=g+(y.length===1?y.shift():0),A.curveTo(c,u,g,p,C,B),y.length!==0);)c=C,u=B+y.shift(),g=c+y.shift(),p=u+y.shift(),C=g+y.shift(),B=p+(y.length===1?y.shift():0),A.curveTo(c,u,g,p,C,B);break;default:Xe<32?console.log("Glyph "+o.index+": unknown operator "+Xe):Xe<247?y.push(Xe-139):Xe<251?(Me=Rt[Se],Se+=1,y.push((Xe-247)*256+Me+108)):Xe<255?(Me=Rt[Se],Se+=1,y.push(-(Xe-251)*256-Me-108)):(Me=Rt[Se],Qe=Rt[Se+1],Ze=Rt[Se+2],ps=Rt[Se+3],Se+=4,y.push((Me<<24|Qe<<16|Ze<<8|ps)/65536))}}}return Wt(h),o.advanceWidth=ee,A}function Dh(n,o,h,c){var u=[],g,p=new St.Parser(n,o),A=p.parseCard8();if(A===0)for(var y=0;y<h;y++){if(g=p.parseCard8(),g>=c)throw new Error("CFF table CID Font FDSelect has bad FD index value "+g+" (FD count "+c+")");u.push(g)}else if(A===3){var P=p.parseCard16(),E=p.parseCard16();if(E!==0)throw new Error("CFF Table CID Font FDSelect format 3 range has bad initial GID "+E);for(var O,C=0;C<P;C++){if(g=p.parseCard8(),O=p.parseCard16(),g>=c)throw new Error("CFF table CID Font FDSelect has bad FD index value "+g+" (FD count "+c+")");if(O>h)throw new Error("CFF Table CID Font FDSelect format 3 range has bad GID "+O);for(;E<O;E++)u.push(g);E=O}if(O!==h)throw new Error("CFF Table CID Font FDSelect format 3 range has bad final GID "+O)}else throw new Error("CFF Table CID Font FDSelect table has unsupported format "+A);return u}function Ch(n,o,h,c){h.tables.cff={};var u=Vt(n,o),g=I(n,u.endOffset,St.bytesToString),p=I(n,g.endOffset),A=I(n,p.endOffset,St.bytesToString),y=I(n,A.endOffset);h.gsubrs=y.objects,h.gsubrsBias=Dt(h.gsubrs);var P=Ho(n,o,p.objects,A.objects);if(P.length!==1)throw new Error("CFF table has too many fonts in 'FontSet' - count of fonts NameIndex.length = "+P.length);var E=P[0];if(h.tables.cff.topDict=E,E._privateDict&&(h.defaultWidthX=E._privateDict.defaultWidthX,h.nominalWidthX=E._privateDict.nominalWidthX),E.ros[0]!==void 0&&E.ros[1]!==void 0&&(h.isCIDFont=!0),h.isCIDFont){var O=E.fdArray,C=E.fdSelect;if(O===0||C===0)throw new Error("Font is marked as a CID font, but FDArray and/or FDSelect information is missing");O+=o;var B=I(n,O),Z=Ho(n,o,B.objects,A.objects);E._fdArray=Z,C+=o,E._fdSelect=Dh(n,C,h.numGlyphs,Z.length)}var mt=o+E.private[1],ht=gs(n,mt,E.private[0],A.objects);if(h.defaultWidthX=ht.defaultWidthX,h.nominalWidthX=ht.nominalWidthX,ht.subrs!==0){var ft=mt+ht.subrs,_t=I(n,ft);h.subrs=_t.objects,h.subrsBias=Dt(h.subrs)}else h.subrs=[],h.subrsBias=0;var wt;c.lowMemory?(wt=Ft(n,o+E.charStrings),h.nGlyphs=wt.offsets.length):(wt=I(n,o+E.charStrings),h.nGlyphs=wt.objects.length);var ee=Ju(n,o+E.charset,h.nGlyphs,A.objects);if(E.encoding===0?h.cffEncoding=new mr(Oo,ee):E.encoding===1?h.cffEncoding=new mr(Bo,ee):h.cffEncoding=Eh(n,o+E.encoding,ee),h.encoding=h.encoding||h.cffEncoding,h.glyphs=new N.GlyphSet(h),c.lowMemory)h._push=function(Wt){var Rt=rt(Wt,wt.offsets,n,o+E.charStrings);h.glyphs.push(Wt,N.cffGlyphLoader(h,Wt,_o,Rt))};else for(var Xt=0;Xt<h.nGlyphs;Xt+=1){var ve=wt.objects[Xt];h.glyphs.push(Xt,N.cffGlyphLoader(h,Xt,_o,ve))}}function Go(n,o){var h,c=Yr.indexOf(n);return c>=0&&(h=c),c=o.indexOf(n),c>=0?h=c+Yr.length:(h=Yr.length+o.length,o.push(n)),h}function Th(){return new pt.Record("Header",[{name:"major",type:"Card8",value:1},{name:"minor",type:"Card8",value:0},{name:"hdrSize",type:"Card8",value:4},{name:"major",type:"Card8",value:1}])}function $u(n){var o=new pt.Record("Name INDEX",[{name:"names",type:"INDEX",value:[]}]);o.names=[];for(var h=0;h<n.length;h+=1)o.names.push({name:"name_"+h,type:"NAME",value:n[h]});return o}function Xo(n,o,h){for(var c={},u=0;u<n.length;u+=1){var g=n[u],p=o[g.name];p!==void 0&&!T(p,g.value)&&(g.type==="SID"&&(p=Go(p,h)),c[g.op]={name:g.name,type:g.type,value:p})}return c}function Wo(n,o){var h=new pt.Record("Top DICT",[{name:"dict",type:"DICT",value:{}}]);return h.dict=Xo(qs,n,o),h}function zo(n){var o=new pt.Record("Top DICT INDEX",[{name:"topDicts",type:"INDEX",value:[]}]);return o.topDicts=[{name:"topDict_0",type:"TABLE",value:n}],o}function Rh(n){var o=new pt.Record("String INDEX",[{name:"strings",type:"INDEX",value:[]}]);o.strings=[];for(var h=0;h<n.length;h+=1)o.strings.push({name:"string_"+h,type:"STRING",value:n[h]});return o}function Nh(){return new pt.Record("Global Subr INDEX",[{name:"subrs",type:"INDEX",value:[]}])}function Yo(n,o){for(var h=new pt.Record("Charsets",[{name:"format",type:"Card8",value:0}]),c=0;c<n.length;c+=1){var u=n[c],g=Go(u,o);h.fields.push({name:"glyph_"+c,type:"SID",value:g})}return h}function Zu(n){var o=[],h=n.path;o.push({name:"width",type:"NUMBER",value:n.advanceWidth});for(var c=0,u=0,g=0;g<h.commands.length;g+=1){var p=void 0,A=void 0,y=h.commands[g];if(y.type==="Q"){var P=.3333333333333333,E=2/3;y={type:"C",x:y.x,y:y.y,x1:Math.round(P*c+E*y.x1),y1:Math.round(P*u+E*y.y1),x2:Math.round(P*y.x+E*y.x1),y2:Math.round(P*y.y+E*y.y1)}}if(y.type==="M")p=Math.round(y.x-c),A=Math.round(y.y-u),o.push({name:"dx",type:"NUMBER",value:p}),o.push({name:"dy",type:"NUMBER",value:A}),o.push({name:"rmoveto",type:"OP",value:21}),c=Math.round(y.x),u=Math.round(y.y);else if(y.type==="L")p=Math.round(y.x-c),A=Math.round(y.y-u),o.push({name:"dx",type:"NUMBER",value:p}),o.push({name:"dy",type:"NUMBER",value:A}),o.push({name:"rlineto",type:"OP",value:5}),c=Math.round(y.x),u=Math.round(y.y);else if(y.type==="C"){var O=Math.round(y.x1-c),C=Math.round(y.y1-u),B=Math.round(y.x2-y.x1),Z=Math.round(y.y2-y.y1);p=Math.round(y.x-y.x2),A=Math.round(y.y-y.y2),o.push({name:"dx1",type:"NUMBER",value:O}),o.push({name:"dy1",type:"NUMBER",value:C}),o.push({name:"dx2",type:"NUMBER",value:B}),o.push({name:"dy2",type:"NUMBER",value:Z}),o.push({name:"dx",type:"NUMBER",value:p}),o.push({name:"dy",type:"NUMBER",value:A}),o.push({name:"rrcurveto",type:"OP",value:8}),c=Math.round(y.x),u=Math.round(y.y)}}return o.push({name:"endchar",type:"OP",value:14}),o}function ju(n){for(var o=new pt.Record("CharStrings INDEX",[{name:"charStrings",type:"INDEX",value:[]}]),h=0;h<n.length;h+=1){var c=n.get(h),u=Zu(c);o.charStrings.push({name:c.name,type:"CHARSTRING",value:u})}return o}function Vs(n,o){var h=new pt.Record("Private DICT",[{name:"dict",type:"DICT",value:{}}]);return h.dict=Xo(Ye,n,o),h}function td(n,o){for(var h=new pt.Table("CFF ",[{name:"header",type:"RECORD"},{name:"nameIndex",type:"RECORD"},{name:"topDictIndex",type:"RECORD"},{name:"stringIndex",type:"RECORD"},{name:"globalSubrIndex",type:"RECORD"},{name:"charsets",type:"RECORD"},{name:"charStringsIndex",type:"RECORD"},{name:"privateDict",type:"RECORD"}]),c=1/o.unitsPerEm,u={version:o.version,fullName:o.fullName,familyName:o.familyName,weight:o.weightName,fontBBox:o.fontBBox||[0,0,0,0],fontMatrix:[c,0,0,c,0,0],charset:999,encoding:0,charStrings:999,private:[0,999]},g={},p=[],A,y=1;y<n.length;y+=1)A=n.get(y),p.push(A.name);var P=[];h.header=Th(),h.nameIndex=$u([o.postScriptName]);var E=Wo(u,P);h.topDictIndex=zo(E),h.globalSubrIndex=Nh(),h.charsets=Yo(p,P),h.charStringsIndex=ju(n),h.privateDict=Vs(g,P),h.stringIndex=Rh(P);var O=h.header.sizeOf()+h.nameIndex.sizeOf()+h.topDictIndex.sizeOf()+h.stringIndex.sizeOf()+h.globalSubrIndex.sizeOf();return u.charset=O,u.encoding=0,u.charStrings=u.charset+h.charsets.sizeOf(),u.private[1]=u.charStrings+h.charStringsIndex.sizeOf(),E=Wo(u,P),h.topDictIndex=zo(E),h}var Lh={parse:Ch,make:td};function ko(n,o){var h={},c=new St.Parser(n,o);return h.version=c.parseVersion(),h.fontRevision=Math.round(c.parseFixed()*1e3)/1e3,h.checkSumAdjustment=c.parseULong(),h.magicNumber=c.parseULong(),bt.argument(h.magicNumber===1594834165,"Font header has wrong magic number."),h.flags=c.parseUShort(),h.unitsPerEm=c.parseUShort(),h.created=c.parseLongDateTime(),h.modified=c.parseLongDateTime(),h.xMin=c.parseShort(),h.yMin=c.parseShort(),h.xMax=c.parseShort(),h.yMax=c.parseShort(),h.macStyle=c.parseUShort(),h.lowestRecPPEM=c.parseUShort(),h.fontDirectionHint=c.parseShort(),h.indexToLocFormat=c.parseShort(),h.glyphDataFormat=c.parseShort(),h}function ed(n){var o=Math.round(new Date().getTime()/1e3)+2082844800,h=o;return n.createdTimestamp&&(h=n.createdTimestamp+2082844800),new pt.Table("head",[{name:"version",type:"FIXED",value:65536},{name:"fontRevision",type:"FIXED",value:65536},{name:"checkSumAdjustment",type:"ULONG",value:0},{name:"magicNumber",type:"ULONG",value:1594834165},{name:"flags",type:"USHORT",value:0},{name:"unitsPerEm",type:"USHORT",value:1e3},{name:"created",type:"LONGDATETIME",value:h},{name:"modified",type:"LONGDATETIME",value:o},{name:"xMin",type:"SHORT",value:0},{name:"yMin",type:"SHORT",value:0},{name:"xMax",type:"SHORT",value:0},{name:"yMax",type:"SHORT",value:0},{name:"macStyle",type:"USHORT",value:0},{name:"lowestRecPPEM",type:"USHORT",value:0},{name:"fontDirectionHint",type:"SHORT",value:2},{name:"indexToLocFormat",type:"SHORT",value:0},{name:"glyphDataFormat",type:"SHORT",value:0}],n)}var Mh={parse:ko,make:ed};function Nn(n,o){var h={},c=new St.Parser(n,o);return h.version=c.parseVersion(),h.ascender=c.parseShort(),h.descender=c.parseShort(),h.lineGap=c.parseShort(),h.advanceWidthMax=c.parseUShort(),h.minLeftSideBearing=c.parseShort(),h.minRightSideBearing=c.parseShort(),h.xMaxExtent=c.parseShort(),h.caretSlopeRise=c.parseShort(),h.caretSlopeRun=c.parseShort(),h.caretOffset=c.parseShort(),c.relativeOffset+=8,h.metricDataFormat=c.parseShort(),h.numberOfHMetrics=c.parseUShort(),h}function sd(n){return new pt.Table("hhea",[{name:"version",type:"FIXED",value:65536},{name:"ascender",type:"FWORD",value:0},{name:"descender",type:"FWORD",value:0},{name:"lineGap",type:"FWORD",value:0},{name:"advanceWidthMax",type:"UFWORD",value:0},{name:"minLeftSideBearing",type:"FWORD",value:0},{name:"minRightSideBearing",type:"FWORD",value:0},{name:"xMaxExtent",type:"FWORD",value:0},{name:"caretSlopeRise",type:"SHORT",value:1},{name:"caretSlopeRun",type:"SHORT",value:0},{name:"caretOffset",type:"SHORT",value:0},{name:"reserved1",type:"SHORT",value:0},{name:"reserved2",type:"SHORT",value:0},{name:"reserved3",type:"SHORT",value:0},{name:"reserved4",type:"SHORT",value:0},{name:"metricDataFormat",type:"SHORT",value:0},{name:"numberOfHMetrics",type:"USHORT",value:0}],n)}var Oh={parse:Nn,make:sd};function rd(n,o,h,c,u){for(var g,p,A=new St.Parser(n,o),y=0;y<c;y+=1){y<h&&(g=A.parseUShort(),p=A.parseShort());var P=u.get(y);P.advanceWidth=g,P.leftSideBearing=p}}function id(n,o,h,c,u){n._hmtxTableData={};for(var g,p,A=new St.Parser(o,h),y=0;y<u;y+=1)y<c&&(g=A.parseUShort(),p=A.parseShort()),n._hmtxTableData[y]={advanceWidth:g,leftSideBearing:p}}function ot(n,o,h,c,u,g,p){p.lowMemory?id(n,o,h,c,u):rd(o,h,c,u,g)}function z(n){for(var o=new pt.Table("hmtx",[]),h=0;h<n.length;h+=1){var c=n.get(h),u=c.advanceWidth||0,g=c.leftSideBearing||0;o.fields.push({name:"advanceWidth_"+h,type:"USHORT",value:u}),o.fields.push({name:"leftSideBearing_"+h,type:"SHORT",value:g})}return o}var yi={parse:ot,make:z};function Zt(n){for(var o=new pt.Table("ltag",[{name:"version",type:"ULONG",value:1},{name:"flags",type:"ULONG",value:0},{name:"numTags",type:"ULONG",value:n.length}]),h="",c=12+n.length*4,u=0;u<n.length;++u){var g=h.indexOf(n[u]);g<0&&(g=h.length,h+=n[u]),o.fields.push({name:"offset "+u,type:"USHORT",value:c+g}),o.fields.push({name:"length "+u,type:"USHORT",value:n[u].length})}return o.fields.push({name:"stringPool",type:"CHARARRAY",value:h}),o}function Es(n,o){var h=new St.Parser(n,o),c=h.parseULong();bt.argument(c===1,"Unsupported ltag table version."),h.skip("uLong",1);for(var u=h.parseULong(),g=[],p=0;p<u;p++){for(var A="",y=o+h.parseUShort(),P=h.parseUShort(),E=y;E<y+P;++E)A+=String.fromCharCode(n.getInt8(E));g.push(A)}return g}var Ds={make:Zt,parse:Es};function zt(n,o){var h={},c=new St.Parser(n,o);return h.version=c.parseVersion(),h.numGlyphs=c.parseUShort(),h.version===1&&(h.maxPoints=c.parseUShort(),h.maxContours=c.parseUShort(),h.maxCompositePoints=c.parseUShort(),h.maxCompositeContours=c.parseUShort(),h.maxZones=c.parseUShort(),h.maxTwilightPoints=c.parseUShort(),h.maxStorage=c.parseUShort(),h.maxFunctionDefs=c.parseUShort(),h.maxInstructionDefs=c.parseUShort(),h.maxStackElements=c.parseUShort(),h.maxSizeOfInstructions=c.parseUShort(),h.maxComponentElements=c.parseUShort(),h.maxComponentDepth=c.parseUShort()),h}function nd(n){return new pt.Table("maxp",[{name:"version",type:"FIXED",value:20480},{name:"numGlyphs",type:"USHORT",value:n}])}var Bh={parse:zt,make:nd},Ai=["copyright","fontFamily","fontSubfamily","uniqueID","fullName","version","postScriptName","trademark","manufacturer","designer","description","manufacturerURL","designerURL","license","licenseURL","reserved","preferredFamily","preferredSubfamily","compatibleFullName","sampleText","postScriptFindFontName","wwsFamily","wwsSubfamily"],Ih={0:"en",1:"fr",2:"de",3:"it",4:"nl",5:"sv",6:"es",7:"da",8:"pt",9:"no",10:"he",11:"ja",12:"ar",13:"fi",14:"el",15:"is",16:"mt",17:"tr",18:"hr",19:"zh-Hant",20:"ur",21:"hi",22:"th",23:"ko",24:"lt",25:"pl",26:"hu",27:"es",28:"lv",29:"se",30:"fo",31:"fa",32:"ru",33:"zh",34:"nl-BE",35:"ga",36:"sq",37:"ro",38:"cz",39:"sk",40:"si",41:"yi",42:"sr",43:"mk",44:"bg",45:"uk",46:"be",47:"uz",48:"kk",49:"az-Cyrl",50:"az-Arab",51:"hy",52:"ka",53:"mo",54:"ky",55:"tg",56:"tk",57:"mn-CN",58:"mn",59:"ps",60:"ks",61:"ku",62:"sd",63:"bo",64:"ne",65:"sa",66:"mr",67:"bn",68:"as",69:"gu",70:"pa",71:"or",72:"ml",73:"kn",74:"ta",75:"te",76:"si",77:"my",78:"km",79:"lo",80:"vi",81:"id",82:"tl",83:"ms",84:"ms-Arab",85:"am",86:"ti",87:"om",88:"so",89:"sw",90:"rw",91:"rn",92:"ny",93:"mg",94:"eo",128:"cy",129:"eu",130:"ca",131:"la",132:"qu",133:"gn",134:"ay",135:"tt",136:"ug",137:"dz",138:"jv",139:"su",140:"gl",141:"af",142:"br",143:"iu",144:"gd",145:"gv",146:"ga",147:"to",148:"el-polyton",149:"kl",150:"az",151:"nn"},od={0:0,1:0,2:0,3:0,4:0,5:0,6:0,7:0,8:0,9:0,10:5,11:1,12:4,13:0,14:6,15:0,16:0,17:0,18:0,19:2,20:4,21:9,22:21,23:3,24:29,25:29,26:29,27:29,28:29,29:0,30:0,31:4,32:7,33:25,34:0,35:0,36:0,37:0,38:29,39:29,40:0,41:5,42:7,43:7,44:7,45:7,46:7,47:7,48:7,49:7,50:4,51:24,52:23,53:7,54:7,55:7,56:7,57:27,58:7,59:4,60:4,61:4,62:4,63:26,64:9,65:9,66:9,67:13,68:13,69:11,70:10,71:12,72:17,73:16,74:14,75:15,76:18,77:19,78:20,79:22,80:30,81:0,82:0,83:0,84:4,85:28,86:28,87:28,88:0,89:0,90:0,91:0,92:0,93:0,94:0,128:0,129:0,130:0,131:0,132:0,133:0,134:0,135:7,136:4,137:26,138:0,139:0,140:0,141:0,142:0,143:28,144:0,145:0,146:0,147:0,148:6,149:0,150:0,151:0},Fh={1078:"af",1052:"sq",1156:"gsw",1118:"am",5121:"ar-DZ",15361:"ar-BH",3073:"ar",2049:"ar-IQ",11265:"ar-JO",13313:"ar-KW",12289:"ar-LB",4097:"ar-LY",6145:"ary",8193:"ar-OM",16385:"ar-QA",1025:"ar-SA",10241:"ar-SY",7169:"aeb",14337:"ar-AE",9217:"ar-YE",1067:"hy",1101:"as",2092:"az-Cyrl",1068:"az",1133:"ba",1069:"eu",1059:"be",2117:"bn",1093:"bn-IN",8218:"bs-Cyrl",5146:"bs",1150:"br",1026:"bg",1027:"ca",3076:"zh-HK",5124:"zh-MO",2052:"zh",4100:"zh-SG",1028:"zh-TW",1155:"co",1050:"hr",4122:"hr-BA",1029:"cs",1030:"da",1164:"prs",1125:"dv",2067:"nl-BE",1043:"nl",3081:"en-AU",10249:"en-BZ",4105:"en-CA",9225:"en-029",16393:"en-IN",6153:"en-IE",8201:"en-JM",17417:"en-MY",5129:"en-NZ",13321:"en-PH",18441:"en-SG",7177:"en-ZA",11273:"en-TT",2057:"en-GB",1033:"en",12297:"en-ZW",1061:"et",1080:"fo",1124:"fil",1035:"fi",2060:"fr-BE",3084:"fr-CA",1036:"fr",5132:"fr-LU",6156:"fr-MC",4108:"fr-CH",1122:"fy",1110:"gl",1079:"ka",3079:"de-AT",1031:"de",5127:"de-LI",4103:"de-LU",2055:"de-CH",1032:"el",1135:"kl",1095:"gu",1128:"ha",1037:"he",1081:"hi",1038:"hu",1039:"is",1136:"ig",1057:"id",1117:"iu",2141:"iu-Latn",2108:"ga",1076:"xh",1077:"zu",1040:"it",2064:"it-CH",1041:"ja",1099:"kn",1087:"kk",1107:"km",1158:"quc",1159:"rw",1089:"sw",1111:"kok",1042:"ko",1088:"ky",1108:"lo",1062:"lv",1063:"lt",2094:"dsb",1134:"lb",1071:"mk",2110:"ms-BN",1086:"ms",1100:"ml",1082:"mt",1153:"mi",1146:"arn",1102:"mr",1148:"moh",1104:"mn",2128:"mn-CN",1121:"ne",1044:"nb",2068:"nn",1154:"oc",1096:"or",1123:"ps",1045:"pl",1046:"pt",2070:"pt-PT",1094:"pa",1131:"qu-BO",2155:"qu-EC",3179:"qu",1048:"ro",1047:"rm",1049:"ru",9275:"smn",4155:"smj-NO",5179:"smj",3131:"se-FI",1083:"se",2107:"se-SE",8251:"sms",6203:"sma-NO",7227:"sms",1103:"sa",7194:"sr-Cyrl-BA",3098:"sr",6170:"sr-Latn-BA",2074:"sr-Latn",1132:"nso",1074:"tn",1115:"si",1051:"sk",1060:"sl",11274:"es-AR",16394:"es-BO",13322:"es-CL",9226:"es-CO",5130:"es-CR",7178:"es-DO",12298:"es-EC",17418:"es-SV",4106:"es-GT",18442:"es-HN",2058:"es-MX",19466:"es-NI",6154:"es-PA",15370:"es-PY",10250:"es-PE",20490:"es-PR",3082:"es",1034:"es",21514:"es-US",14346:"es-UY",8202:"es-VE",2077:"sv-FI",1053:"sv",1114:"syr",1064:"tg",2143:"tzm",1097:"ta",1092:"tt",1098:"te",1054:"th",1105:"bo",1055:"tr",1090:"tk",1152:"ug",1058:"uk",1070:"hsb",1056:"ur",2115:"uz-Cyrl",1091:"uz",1066:"vi",1106:"cy",1160:"wo",1157:"sah",1144:"ii",1130:"yo"};function Uh(n,o,h){switch(n){case 0:if(o===65535)return"und";if(h)return h[o];break;case 1:return Ih[o];case 3:return Fh[o]}}var qo="utf-16",ad={0:"macintosh",1:"x-mac-japanese",2:"x-mac-chinesetrad",3:"x-mac-korean",6:"x-mac-greek",7:"x-mac-cyrillic",9:"x-mac-devanagai",10:"x-mac-gurmukhi",11:"x-mac-gujarati",12:"x-mac-oriya",13:"x-mac-bengali",14:"x-mac-tamil",15:"x-mac-telugu",16:"x-mac-kannada",17:"x-mac-malayalam",18:"x-mac-sinhalese",19:"x-mac-burmese",20:"x-mac-khmer",21:"x-mac-thai",22:"x-mac-lao",23:"x-mac-georgian",24:"x-mac-armenian",25:"x-mac-chinesesimp",26:"x-mac-tibetan",27:"x-mac-mongolian",28:"x-mac-ethiopic",29:"x-mac-ce",30:"x-mac-vietnamese",31:"x-mac-extarabic"},hd={15:"x-mac-icelandic",17:"x-mac-turkish",18:"x-mac-croatian",24:"x-mac-ce",25:"x-mac-ce",26:"x-mac-ce",27:"x-mac-ce",28:"x-mac-ce",30:"x-mac-icelandic",37:"x-mac-romanian",38:"x-mac-ce",39:"x-mac-ce",40:"x-mac-ce",143:"x-mac-inuit",146:"x-mac-gaelic"};function Hh(n,o,h){switch(n){case 0:return qo;case 1:return hd[h]||ad[o];case 3:if(o===1||o===10)return qo;break}}function Ln(n,o,h){for(var c={},u=new St.Parser(n,o),g=u.parseUShort(),p=u.parseUShort(),A=u.offset+u.parseUShort(),y=0;y<p;y++){var P=u.parseUShort(),E=u.parseUShort(),O=u.parseUShort(),C=u.parseUShort(),B=Ai[C]||C,Z=u.parseUShort(),mt=u.parseUShort(),ht=Uh(P,O,h),ft=Hh(P,E,O);if(ft!==void 0&&ht!==void 0){var _t=void 0;if(ft===qo?_t=ur.UTF16(n,A+mt,Z):_t=ur.MACSTRING(n,A+mt,Z,ft),_t){var wt=c[B];wt===void 0&&(wt=c[B]={}),wt[ht]=_t}}}var ee=0;return g===1&&(ee=u.parseUShort()),c}function Mn(n){var o={};for(var h in n)o[n[h]]=parseInt(h);return o}function ns(n,o,h,c,u,g){return new pt.Record("NameRecord",[{name:"platformID",type:"USHORT",value:n},{name:"encodingID",type:"USHORT",value:o},{name:"languageID",type:"USHORT",value:h},{name:"nameID",type:"USHORT",value:c},{name:"length",type:"USHORT",value:u},{name:"offset",type:"USHORT",value:g}])}function ld(n,o){var h=n.length,c=o.length-h+1;t:for(var u=0;u<c;u++)for(;u<c;u++){for(var g=0;g<h;g++)if(o[u+g]!==n[g])continue t;return u}return-1}function _h(n,o){var h=ld(n,o);if(h<0){h=o.length;for(var c=0,u=n.length;c<u;++c)o.push(n[c])}return h}function Vo(n,o){var h,c=[],u={},g=Mn(Ai);for(var p in n){var A=g[p];if(A===void 0&&(A=p),h=parseInt(A),isNaN(h))throw new Error('Name table entry "'+p+'" does not exist, see nameTableNames for complete list.');u[h]=n[p],c.push(h)}for(var y=Mn(Ih),P=Mn(Fh),E=[],O=[],C=0;C<c.length;C++){h=c[C];var B=u[h];for(var Z in B){var mt=B[Z],ht=1,ft=y[Z],_t=od[ft],wt=Hh(ht,_t,ft),ee=at.MACSTRING(mt,wt);ee===void 0&&(ht=0,ft=o.indexOf(Z),ft<0&&(ft=o.length,o.push(Z)),_t=4,ee=at.UTF16(mt));var Xt=_h(ee,O);E.push(ns(ht,_t,ft,h,ee.length,Xt));var ve=P[Z];if(ve!==void 0){var Wt=at.UTF16(mt),Rt=_h(Wt,O);E.push(ns(3,1,ve,h,Wt.length,Rt))}}}E.sort(function(Ze,ps){return Ze.platformID-ps.platformID||Ze.encodingID-ps.encodingID||Ze.languageID-ps.languageID||Ze.nameID-ps.nameID});for(var Me=new pt.Table("name",[{name:"format",type:"USHORT",value:0},{name:"count",type:"USHORT",value:E.length},{name:"stringOffset",type:"USHORT",value:6+E.length*12}]),Qe=0;Qe<E.length;Qe++)Me.fields.push({name:"record_"+Qe,type:"RECORD",value:E[Qe]});return Me.fields.push({name:"strings",type:"LITERAL",value:O}),Me}var Gh={parse:Ln,make:Vo},Cs=[{begin:0,end:127},{begin:128,end:255},{begin:256,end:383},{begin:384,end:591},{begin:592,end:687},{begin:688,end:767},{begin:768,end:879},{begin:880,end:1023},{begin:11392,end:11519},{begin:1024,end:1279},{begin:1328,end:1423},{begin:1424,end:1535},{begin:42240,end:42559},{begin:1536,end:1791},{begin:1984,end:2047},{begin:2304,end:2431},{begin:2432,end:2559},{begin:2560,end:2687},{begin:2688,end:2815},{begin:2816,end:2943},{begin:2944,end:3071},{begin:3072,end:3199},{begin:3200,end:3327},{begin:3328,end:3455},{begin:3584,end:3711},{begin:3712,end:3839},{begin:4256,end:4351},{begin:6912,end:7039},{begin:4352,end:4607},{begin:7680,end:7935},{begin:7936,end:8191},{begin:8192,end:8303},{begin:8304,end:8351},{begin:8352,end:8399},{begin:8400,end:8447},{begin:8448,end:8527},{begin:8528,end:8591},{begin:8592,end:8703},{begin:8704,end:8959},{begin:8960,end:9215},{begin:9216,end:9279},{begin:9280,end:9311},{begin:9312,end:9471},{begin:9472,end:9599},{begin:9600,end:9631},{begin:9632,end:9727},{begin:9728,end:9983},{begin:9984,end:10175},{begin:12288,end:12351},{begin:12352,end:12447},{begin:12448,end:12543},{begin:12544,end:12591},{begin:12592,end:12687},{begin:43072,end:43135},{begin:12800,end:13055},{begin:13056,end:13311},{begin:44032,end:55215},{begin:55296,end:57343},{begin:67840,end:67871},{begin:19968,end:40959},{begin:57344,end:63743},{begin:12736,end:12783},{begin:64256,end:64335},{begin:64336,end:65023},{begin:65056,end:65071},{begin:65040,end:65055},{begin:65104,end:65135},{begin:65136,end:65279},{begin:65280,end:65519},{begin:65520,end:65535},{begin:3840,end:4095},{begin:1792,end:1871},{begin:1920,end:1983},{begin:3456,end:3583},{begin:4096,end:4255},{begin:4608,end:4991},{begin:5024,end:5119},{begin:5120,end:5759},{begin:5760,end:5791},{begin:5792,end:5887},{begin:6016,end:6143},{begin:6144,end:6319},{begin:10240,end:10495},{begin:40960,end:42127},{begin:5888,end:5919},{begin:66304,end:66351},{begin:66352,end:66383},{begin:66560,end:66639},{begin:118784,end:119039},{begin:119808,end:120831},{begin:1044480,end:1048573},{begin:65024,end:65039},{begin:917504,end:917631},{begin:6400,end:6479},{begin:6480,end:6527},{begin:6528,end:6623},{begin:6656,end:6687},{begin:11264,end:11359},{begin:11568,end:11647},{begin:19904,end:19967},{begin:43008,end:43055},{begin:65536,end:65663},{begin:65856,end:65935},{begin:66432,end:66463},{begin:66464,end:66527},{begin:66640,end:66687},{begin:66688,end:66735},{begin:67584,end:67647},{begin:68096,end:68191},{begin:119552,end:119647},{begin:73728,end:74751},{begin:119648,end:119679},{begin:7040,end:7103},{begin:7168,end:7247},{begin:7248,end:7295},{begin:43136,end:43231},{begin:43264,end:43311},{begin:43312,end:43359},{begin:43520,end:43615},{begin:65936,end:65999},{begin:66e3,end:66047},{begin:66208,end:66271},{begin:127024,end:127135}];function cd(n){for(var o=0;o<Cs.length;o+=1){var h=Cs[o];if(n>=h.begin&&n<h.end)return o}return-1}function ud(n,o){var h={},c=new St.Parser(n,o);h.version=c.parseUShort(),h.xAvgCharWidth=c.parseShort(),h.usWeightClass=c.parseUShort(),h.usWidthClass=c.parseUShort(),h.fsType=c.parseUShort(),h.ySubscriptXSize=c.parseShort(),h.ySubscriptYSize=c.parseShort(),h.ySubscriptXOffset=c.parseShort(),h.ySubscriptYOffset=c.parseShort(),h.ySuperscriptXSize=c.parseShort(),h.ySuperscriptYSize=c.parseShort(),h.ySuperscriptXOffset=c.parseShort(),h.ySuperscriptYOffset=c.parseShort(),h.yStrikeoutSize=c.parseShort(),h.yStrikeoutPosition=c.parseShort(),h.sFamilyClass=c.parseShort(),h.panose=[];for(var u=0;u<10;u++)h.panose[u]=c.parseByte();return h.ulUnicodeRange1=c.parseULong(),h.ulUnicodeRange2=c.parseULong(),h.ulUnicodeRange3=c.parseULong(),h.ulUnicodeRange4=c.parseULong(),h.achVendID=String.fromCharCode(c.parseByte(),c.parseByte(),c.parseByte(),c.parseByte()),h.fsSelection=c.parseUShort(),h.usFirstCharIndex=c.parseUShort(),h.usLastCharIndex=c.parseUShort(),h.sTypoAscender=c.parseShort(),h.sTypoDescender=c.parseShort(),h.sTypoLineGap=c.parseShort(),h.usWinAscent=c.parseUShort(),h.usWinDescent=c.parseUShort(),h.version>=1&&(h.ulCodePageRange1=c.parseULong(),h.ulCodePageRange2=c.parseULong()),h.version>=2&&(h.sxHeight=c.parseShort(),h.sCapHeight=c.parseShort(),h.usDefaultChar=c.parseUShort(),h.usBreakChar=c.parseUShort(),h.usMaxContent=c.parseUShort()),h}function vr(n){return new pt.Table("OS/2",[{name:"version",type:"USHORT",value:3},{name:"xAvgCharWidth",type:"SHORT",value:0},{name:"usWeightClass",type:"USHORT",value:0},{name:"usWidthClass",type:"USHORT",value:0},{name:"fsType",type:"USHORT",value:0},{name:"ySubscriptXSize",type:"SHORT",value:650},{name:"ySubscriptYSize",type:"SHORT",value:699},{name:"ySubscriptXOffset",type:"SHORT",value:0},{name:"ySubscriptYOffset",type:"SHORT",value:140},{name:"ySuperscriptXSize",type:"SHORT",value:650},{name:"ySuperscriptYSize",type:"SHORT",value:699},{name:"ySuperscriptXOffset",type:"SHORT",value:0},{name:"ySuperscriptYOffset",type:"SHORT",value:479},{name:"yStrikeoutSize",type:"SHORT",value:49},{name:"yStrikeoutPosition",type:"SHORT",value:258},{name:"sFamilyClass",type:"SHORT",value:0},{name:"bFamilyType",type:"BYTE",value:0},{name:"bSerifStyle",type:"BYTE",value:0},{name:"bWeight",type:"BYTE",value:0},{name:"bProportion",type:"BYTE",value:0},{name:"bContrast",type:"BYTE",value:0},{name:"bStrokeVariation",type:"BYTE",value:0},{name:"bArmStyle",type:"BYTE",value:0},{name:"bLetterform",type:"BYTE",value:0},{name:"bMidline",type:"BYTE",value:0},{name:"bXHeight",type:"BYTE",value:0},{name:"ulUnicodeRange1",type:"ULONG",value:0},{name:"ulUnicodeRange2",type:"ULONG",value:0},{name:"ulUnicodeRange3",type:"ULONG",value:0},{name:"ulUnicodeRange4",type:"ULONG",value:0},{name:"achVendID",type:"CHARARRAY",value:"XXXX"},{name:"fsSelection",type:"USHORT",value:0},{name:"usFirstCharIndex",type:"USHORT",value:0},{name:"usLastCharIndex",type:"USHORT",value:0},{name:"sTypoAscender",type:"SHORT",value:0},{name:"sTypoDescender",type:"SHORT",value:0},{name:"sTypoLineGap",type:"SHORT",value:0},{name:"usWinAscent",type:"USHORT",value:0},{name:"usWinDescent",type:"USHORT",value:0},{name:"ulCodePageRange1",type:"ULONG",value:0},{name:"ulCodePageRange2",type:"ULONG",value:0},{name:"sxHeight",type:"SHORT",value:0},{name:"sCapHeight",type:"SHORT",value:0},{name:"usDefaultChar",type:"USHORT",value:0},{name:"usBreakChar",type:"USHORT",value:0},{name:"usMaxContext",type:"USHORT",value:0}],n)}var Yi={parse:ud,make:vr,unicodeRanges:Cs,getUnicodeRange:cd};function Xh(n,o){var h={},c=new St.Parser(n,o);switch(h.version=c.parseVersion(),h.italicAngle=c.parseFixed(),h.underlinePosition=c.parseShort(),h.underlineThickness=c.parseShort(),h.isFixedPitch=c.parseULong(),h.minMemType42=c.parseULong(),h.maxMemType42=c.parseULong(),h.minMemType1=c.parseULong(),h.maxMemType1=c.parseULong(),h.version){case 1:h.names=Ke.slice();break;case 2:h.numberOfGlyphs=c.parseUShort(),h.glyphNameIndex=new Array(h.numberOfGlyphs);for(var u=0;u<h.numberOfGlyphs;u++)h.glyphNameIndex[u]=c.parseUShort();h.names=[];for(var g=0;g<h.numberOfGlyphs;g++)if(h.glyphNameIndex[g]>=Ke.length){var p=c.parseChar();h.names.push(c.parseString(p))}break;case 2.5:h.numberOfGlyphs=c.parseUShort(),h.offset=new Array(h.numberOfGlyphs);for(var A=0;A<h.numberOfGlyphs;A++)h.offset[A]=c.parseChar();break}return h}function dd(){return new pt.Table("post",[{name:"version",type:"FIXED",value:196608},{name:"italicAngle",type:"FIXED",value:0},{name:"underlinePosition",type:"FWORD",value:0},{name:"underlineThickness",type:"FWORD",value:0},{name:"isFixedPitch",type:"ULONG",value:0},{name:"minMemType42",type:"ULONG",value:0},{name:"maxMemType42",type:"ULONG",value:0},{name:"minMemType1",type:"ULONG",value:0},{name:"maxMemType1",type:"ULONG",value:0}])}var Qo={parse:Xh,make:dd},Je=new Array(9);Je[1]=function(){var o=this.offset+this.relativeOffset,h=this.parseUShort();if(h===1)return{substFormat:1,coverage:this.parsePointer(F.coverage),deltaGlyphId:this.parseUShort()};if(h===2)return{substFormat:2,coverage:this.parsePointer(F.coverage),substitute:this.parseOffset16List()};bt.assert(!1,"0x"+o.toString(16)+": lookup type 1 format must be 1 or 2.")},Je[2]=function(){var o=this.parseUShort();return bt.argument(o===1,"GSUB Multiple Substitution Subtable identifier-format must be 1"),{substFormat:o,coverage:this.parsePointer(F.coverage),sequences:this.parseListOfLists()}},Je[3]=function(){var o=this.parseUShort();return bt.argument(o===1,"GSUB Alternate Substitution Subtable identifier-format must be 1"),{substFormat:o,coverage:this.parsePointer(F.coverage),alternateSets:this.parseListOfLists()}},Je[4]=function(){var o=this.parseUShort();return bt.argument(o===1,"GSUB ligature table identifier-format must be 1"),{substFormat:o,coverage:this.parsePointer(F.coverage),ligatureSets:this.parseListOfLists(function(){return{ligGlyph:this.parseUShort(),components:this.parseUShortList(this.parseUShort()-1)}})}};var vi={sequenceIndex:F.uShort,lookupListIndex:F.uShort};Je[5]=function(){var o=this.offset+this.relativeOffset,h=this.parseUShort();if(h===1)return{substFormat:h,coverage:this.parsePointer(F.coverage),ruleSets:this.parseListOfLists(function(){var g=this.parseUShort(),p=this.parseUShort();return{input:this.parseUShortList(g-1),lookupRecords:this.parseRecordList(p,vi)}})};if(h===2)return{substFormat:h,coverage:this.parsePointer(F.coverage),classDef:this.parsePointer(F.classDef),classSets:this.parseListOfLists(function(){var g=this.parseUShort(),p=this.parseUShort();return{classes:this.parseUShortList(g-1),lookupRecords:this.parseRecordList(p,vi)}})};if(h===3){var c=this.parseUShort(),u=this.parseUShort();return{substFormat:h,coverages:this.parseList(c,F.pointer(F.coverage)),lookupRecords:this.parseRecordList(u,vi)}}bt.assert(!1,"0x"+o.toString(16)+": lookup type 5 format must be 1, 2 or 3.")},Je[6]=function(){var o=this.offset+this.relativeOffset,h=this.parseUShort();if(h===1)return{substFormat:1,coverage:this.parsePointer(F.coverage),chainRuleSets:this.parseListOfLists(function(){return{backtrack:this.parseUShortList(),input:this.parseUShortList(this.parseShort()-1),lookahead:this.parseUShortList(),lookupRecords:this.parseRecordList(vi)}})};if(h===2)return{substFormat:2,coverage:this.parsePointer(F.coverage),backtrackClassDef:this.parsePointer(F.classDef),inputClassDef:this.parsePointer(F.classDef),lookaheadClassDef:this.parsePointer(F.classDef),chainClassSet:this.parseListOfLists(function(){return{backtrack:this.parseUShortList(),input:this.parseUShortList(this.parseShort()-1),lookahead:this.parseUShortList(),lookupRecords:this.parseRecordList(vi)}})};if(h===3)return{substFormat:3,backtrackCoverage:this.parseList(F.pointer(F.coverage)),inputCoverage:this.parseList(F.pointer(F.coverage)),lookaheadCoverage:this.parseList(F.pointer(F.coverage)),lookupRecords:this.parseRecordList(vi)};bt.assert(!1,"0x"+o.toString(16)+": lookup type 6 format must be 1, 2 or 3.")},Je[7]=function(){var o=this.parseUShort();bt.argument(o===1,"GSUB Extension Substitution subtable identifier-format must be 1");var h=this.parseUShort(),c=new F(this.data,this.offset+this.parseULong());return{substFormat:1,lookupType:h,extension:Je[h].call(c)}},Je[8]=function(){var o=this.parseUShort();return bt.argument(o===1,"GSUB Reverse Chaining Contextual Single Substitution Subtable identifier-format must be 1"),{substFormat:o,coverage:this.parsePointer(F.coverage),backtrackCoverage:this.parseList(F.pointer(F.coverage)),lookaheadCoverage:this.parseList(F.pointer(F.coverage)),substitutes:this.parseUShortList()}};function fd(n,o){o=o||0;var h=new F(n,o),c=h.parseVersion(1);return bt.argument(c===1||c===1.1,"Unsupported GSUB table version."),c===1?{version:c,scripts:h.parseScriptList(),features:h.parseFeatureList(),lookups:h.parseLookupList(Je)}:{version:c,scripts:h.parseScriptList(),features:h.parseFeatureList(),lookups:h.parseLookupList(Je),variations:h.parseFeatureVariationsList()}}var Qs=new Array(9);Qs[1]=function(o){return o.substFormat===1?new pt.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:1},{name:"coverage",type:"TABLE",value:new pt.Coverage(o.coverage)},{name:"deltaGlyphID",type:"USHORT",value:o.deltaGlyphId}]):new pt.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:2},{name:"coverage",type:"TABLE",value:new pt.Coverage(o.coverage)}].concat(pt.ushortList("substitute",o.substitute)))},Qs[2]=function(o){return bt.assert(o.substFormat===1,"Lookup type 2 substFormat must be 1."),new pt.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:1},{name:"coverage",type:"TABLE",value:new pt.Coverage(o.coverage)}].concat(pt.tableList("seqSet",o.sequences,function(h){return new pt.Table("sequenceSetTable",pt.ushortList("sequence",h))})))},Qs[3]=function(o){return bt.assert(o.substFormat===1,"Lookup type 3 substFormat must be 1."),new pt.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:1},{name:"coverage",type:"TABLE",value:new pt.Coverage(o.coverage)}].concat(pt.tableList("altSet",o.alternateSets,function(h){return new pt.Table("alternateSetTable",pt.ushortList("alternate",h))})))},Qs[4]=function(o){return bt.assert(o.substFormat===1,"Lookup type 4 substFormat must be 1."),new pt.Table("substitutionTable",[{name:"substFormat",type:"USHORT",value:1},{name:"coverage",type:"TABLE",value:new pt.Coverage(o.coverage)}].concat(pt.tableList("ligSet",o.ligatureSets,function(h){return new pt.Table("ligatureSetTable",pt.tableList("ligature",h,function(c){return new pt.Table("ligatureTable",[{name:"ligGlyph",type:"USHORT",value:c.ligGlyph}].concat(pt.ushortList("component",c.components,c.components.length+1)))}))})))},Qs[6]=function(o){if(o.substFormat===1){var h=new pt.Table("chainContextTable",[{name:"substFormat",type:"USHORT",value:o.substFormat},{name:"coverage",type:"TABLE",value:new pt.Coverage(o.coverage)}].concat(pt.tableList("chainRuleSet",o.chainRuleSets,function(g){return new pt.Table("chainRuleSetTable",pt.tableList("chainRule",g,function(p){var A=pt.ushortList("backtrackGlyph",p.backtrack,p.backtrack.length).concat(pt.ushortList("inputGlyph",p.input,p.input.length+1)).concat(pt.ushortList("lookaheadGlyph",p.lookahead,p.lookahead.length)).concat(pt.ushortList("substitution",[],p.lookupRecords.length));return p.lookupRecords.forEach(function(y,P){A=A.concat({name:"sequenceIndex"+P,type:"USHORT",value:y.sequenceIndex}).concat({name:"lookupListIndex"+P,type:"USHORT",value:y.lookupListIndex})}),new pt.Table("chainRuleTable",A)}))})));return h}else if(o.substFormat===2)bt.assert(!1,"lookup type 6 format 2 is not yet supported.");else if(o.substFormat===3){var c=[{name:"substFormat",type:"USHORT",value:o.substFormat}];c.push({name:"backtrackGlyphCount",type:"USHORT",value:o.backtrackCoverage.length}),o.backtrackCoverage.forEach(function(g,p){c.push({name:"backtrackCoverage"+p,type:"TABLE",value:new pt.Coverage(g)})}),c.push({name:"inputGlyphCount",type:"USHORT",value:o.inputCoverage.length}),o.inputCoverage.forEach(function(g,p){c.push({name:"inputCoverage"+p,type:"TABLE",value:new pt.Coverage(g)})}),c.push({name:"lookaheadGlyphCount",type:"USHORT",value:o.lookaheadCoverage.length}),o.lookaheadCoverage.forEach(function(g,p){c.push({name:"lookaheadCoverage"+p,type:"TABLE",value:new pt.Coverage(g)})}),c.push({name:"substitutionCount",type:"USHORT",value:o.lookupRecords.length}),o.lookupRecords.forEach(function(g,p){c=c.concat({name:"sequenceIndex"+p,type:"USHORT",value:g.sequenceIndex}).concat({name:"lookupListIndex"+p,type:"USHORT",value:g.lookupListIndex})});var u=new pt.Table("chainContextTable",c);return u}bt.assert(!1,"lookup type 6 format must be 1, 2 or 3.")};function gd(n){return new pt.Table("GSUB",[{name:"version",type:"ULONG",value:65536},{name:"scripts",type:"TABLE",value:new pt.ScriptList(n.scripts)},{name:"features",type:"TABLE",value:new pt.FeatureList(n.features)},{name:"lookups",type:"TABLE",value:new pt.LookupList(n.lookups,Qs)}])}var Wh={parse:fd,make:gd};function pd(n,o){var h=new St.Parser(n,o),c=h.parseULong();bt.argument(c===1,"Unsupported META table version."),h.parseULong(),h.parseULong();for(var u=h.parseULong(),g={},p=0;p<u;p++){var A=h.parseTag(),y=h.parseULong(),P=h.parseULong(),E=ur.UTF8(n,o+y,P);g[A]=E}return g}function md(n){var o=Object.keys(n).length,h="",c=16+o*12,u=new pt.Table("meta",[{name:"version",type:"ULONG",value:1},{name:"flags",type:"ULONG",value:0},{name:"offset",type:"ULONG",value:c},{name:"numTags",type:"ULONG",value:o}]);for(var g in n){var p=h.length;h+=n[g],u.fields.push({name:"tag "+g,type:"TAG",value:g}),u.fields.push({name:"offset "+g,type:"ULONG",value:c+p}),u.fields.push({name:"length "+g,type:"ULONG",value:n[g].length})}return u.fields.push({name:"stringPool",type:"CHARARRAY",value:h}),u}var zh={parse:pd,make:md};function Yh(n){return Math.log(n)/Math.log(2)|0}function Ko(n){for(;n.length%4!==0;)n.push(0);for(var o=0,h=0;h<n.length;h+=4)o+=(n[h]<<24)+(n[h+1]<<16)+(n[h+2]<<8)+n[h+3];return o%=Math.pow(2,32),o}function Ks(n,o,h,c){return new pt.Record("Table Record",[{name:"tag",type:"TAG",value:n!==void 0?n:""},{name:"checkSum",type:"ULONG",value:o!==void 0?o:0},{name:"offset",type:"ULONG",value:h!==void 0?h:0},{name:"length",type:"ULONG",value:c!==void 0?c:0}])}function Jo(n){var o=new pt.Table("sfnt",[{name:"version",type:"TAG",value:"OTTO"},{name:"numTables",type:"USHORT",value:0},{name:"searchRange",type:"USHORT",value:0},{name:"entrySelector",type:"USHORT",value:0},{name:"rangeShift",type:"USHORT",value:0}]);o.tables=n,o.numTables=n.length;var h=Math.pow(2,Yh(o.numTables));o.searchRange=16*h,o.entrySelector=Yh(h),o.rangeShift=o.numTables*16-o.searchRange;for(var c=[],u=[],g=o.sizeOf()+Ks().sizeOf()*o.numTables;g%4!==0;)g+=1,u.push({name:"padding",type:"BYTE",value:0});for(var p=0;p<n.length;p+=1){var A=n[p];bt.argument(A.tableName.length===4,"Table name"+A.tableName+" is invalid.");var y=A.sizeOf(),P=Ks(A.tableName,Ko(A.encode()),g,y);for(c.push({name:P.tag+" Table Record",type:"RECORD",value:P}),u.push({name:A.tableName+" table",type:"RECORD",value:A}),g+=y,bt.argument(!isNaN(g),"Something went wrong calculating the offset.");g%4!==0;)g+=1,u.push({name:"padding",type:"BYTE",value:0})}return c.sort(function(E,O){return E.value.tag>O.value.tag?1:-1}),o.fields=o.fields.concat(c),o.fields=o.fields.concat(u),o}function kh(n,o,h){for(var c=0;c<o.length;c+=1){var u=n.charToGlyphIndex(o[c]);if(u>0){var g=n.glyphs.get(u);return g.getMetrics()}}return h}function yd(n){for(var o=0,h=0;h<n.length;h+=1)o+=n[h];return o/n.length}function Si(n){for(var o=[],h=[],c=[],u=[],g=[],p=[],A=[],y,P=0,E=0,O=0,C=0,B=0,Z=0;Z<n.glyphs.length;Z+=1){var mt=n.glyphs.get(Z),ht=mt.unicode|0;if(isNaN(mt.advanceWidth))throw new Error("Glyph "+mt.name+" ("+Z+"): advanceWidth is not a number.");(y>ht||y===void 0)&&ht>0&&(y=ht),P<ht&&(P=ht);var ft=Yi.getUnicodeRange(ht);if(ft<32)E|=1<<ft;else if(ft<64)O|=1<<ft-32;else if(ft<96)C|=1<<ft-64;else if(ft<123)B|=1<<ft-96;else throw new Error("Unicode ranges bits > 123 are reserved for internal usage");if(mt.name!==".notdef"){var _t=mt.getMetrics();o.push(_t.xMin),h.push(_t.yMin),c.push(_t.xMax),u.push(_t.yMax),p.push(_t.leftSideBearing),A.push(_t.rightSideBearing),g.push(mt.advanceWidth)}}var wt={xMin:Math.min.apply(null,o),yMin:Math.min.apply(null,h),xMax:Math.max.apply(null,c),yMax:Math.max.apply(null,u),advanceWidthMax:Math.max.apply(null,g),advanceWidthAvg:yd(g),minLeftSideBearing:Math.min.apply(null,p),maxLeftSideBearing:Math.max.apply(null,p),minRightSideBearing:Math.min.apply(null,A)};wt.ascender=n.ascender,wt.descender=n.descender;var ee=Mh.make({flags:3,unitsPerEm:n.unitsPerEm,xMin:wt.xMin,yMin:wt.yMin,xMax:wt.xMax,yMax:wt.yMax,lowestRecPPEM:3,createdTimestamp:n.createdTimestamp}),Xt=Oh.make({ascender:wt.ascender,descender:wt.descender,advanceWidthMax:wt.advanceWidthMax,minLeftSideBearing:wt.minLeftSideBearing,minRightSideBearing:wt.minRightSideBearing,xMaxExtent:wt.maxLeftSideBearing+(wt.xMax-wt.xMin),numberOfHMetrics:n.glyphs.length}),ve=Bh.make(n.glyphs.length),Wt=Yi.make(Object.assign({xAvgCharWidth:Math.round(wt.advanceWidthAvg),usFirstCharIndex:y,usLastCharIndex:P,ulUnicodeRange1:E,ulUnicodeRange2:O,ulUnicodeRange3:C,ulUnicodeRange4:B,sTypoAscender:wt.ascender,sTypoDescender:wt.descender,sTypoLineGap:0,usWinAscent:wt.yMax,usWinDescent:Math.abs(wt.yMin),ulCodePageRange1:1,sxHeight:kh(n,"xyvw",{yMax:Math.round(wt.ascender/2)}).yMax,sCapHeight:kh(n,"HIKLEFJMNTZBDPRAGOQSUVWXY",wt).yMax,usDefaultChar:n.hasChar(" ")?32:0,usBreakChar:n.hasChar(" ")?32:0},n.tables.os2)),Rt=yi.make(n.glyphs),Me=gr.make(n.glyphs),Qe=n.getEnglishName("fontFamily"),Ze=n.getEnglishName("fontSubfamily"),ps=Qe+" "+Ze,ke=n.getEnglishName("postScriptName");ke||(ke=Qe.replace(/\s/g,"")+"-"+Ze);var Re={};for(var Be in n.names)Re[Be]=n.names[Be];Re.uniqueID||(Re.uniqueID={en:n.getEnglishName("manufacturer")+":"+ps}),Re.postScriptName||(Re.postScriptName={en:ke}),Re.preferredFamily||(Re.preferredFamily=n.names.fontFamily),Re.preferredSubfamily||(Re.preferredSubfamily=n.names.fontSubfamily);var Ie=[],_e=Gh.make(Re,Ie),Ge=Ie.length>0?Ds.make(Ie):void 0,Fe=Qo.make(),qe=Lh.make(n.glyphs,{version:n.getEnglishName("version"),fullName:ps,familyName:Qe,weightName:Ze,postScriptName:ke,unitsPerEm:n.unitsPerEm,fontBBox:[0,wt.yMin,wt.ascender,wt.advanceWidthMax]}),Se=n.metas&&Object.keys(n.metas).length>0?zh.make(n.metas):void 0,Xe=[ee,Xt,ve,Wt,_e,Me,Fe,qe,Rt];Ge&&Xe.push(Ge),n.tables.gsub&&Xe.push(Wh.make(n.tables.gsub)),Se&&Xe.push(Se);for(var va=Jo(Xe),Sg=va.encode(),wg=Ko(Sg),Sa=va.fields,Dl=!1,Ue=0;Ue<Sa.length;Ue+=1)if(Sa[Ue].name==="head table"){Sa[Ue].value.checkSumAdjustment=2981146554-wg,Dl=!0;break}if(!Dl)throw new Error("Could not find head table with checkSum to adjust.");return va}var Ad={make:Jo,fontToTable:Si,computeCheckSum:Ko};function $o(n,o){for(var h=0,c=n.length-1;h<=c;){var u=h+c>>>1,g=n[u].tag;if(g===o)return u;g<o?h=u+1:c=u-1}return-h-1}function Ne(n,o){for(var h=0,c=n.length-1;h<=c;){var u=h+c>>>1,g=n[u];if(g===o)return u;g<o?h=u+1:c=u-1}return-h-1}function qh(n,o){for(var h,c=0,u=n.length-1;c<=u;){var g=c+u>>>1;h=n[g];var p=h.start;if(p===o)return h;p<o?c=g+1:u=g-1}if(c>0)return h=n[c-1],o>h.end?0:h}function ki(n,o){this.font=n,this.tableName=o}ki.prototype={searchTag:$o,binSearch:Ne,getTable:function(n){var o=this.font.tables[this.tableName];return!o&&n&&(o=this.font.tables[this.tableName]=this.createDefaultTable()),o},getScriptNames:function(){var n=this.getTable();return n?n.scripts.map(function(o){return o.tag}):[]},getDefaultScriptName:function(){var n=this.getTable();if(n){for(var o=!1,h=0;h<n.scripts.length;h++){var c=n.scripts[h].tag;if(c==="DFLT")return c;c==="latn"&&(o=!0)}if(o)return"latn"}},getScriptTable:function(n,o){var h=this.getTable(o);if(h){n=n||"DFLT";var c=h.scripts,u=$o(h.scripts,n);if(u>=0)return c[u].script;if(o){var g={tag:n,script:{defaultLangSys:{reserved:0,reqFeatureIndex:65535,featureIndexes:[]},langSysRecords:[]}};return c.splice(-1-u,0,g),g.script}}},getLangSysTable:function(n,o,h){var c=this.getScriptTable(n,h);if(c){if(!o||o==="dflt"||o==="DFLT")return c.defaultLangSys;var u=$o(c.langSysRecords,o);if(u>=0)return c.langSysRecords[u].langSys;if(h){var g={tag:o,langSys:{reserved:0,reqFeatureIndex:65535,featureIndexes:[]}};return c.langSysRecords.splice(-1-u,0,g),g.langSys}}},getFeatureTable:function(n,o,h,c){var u=this.getLangSysTable(n,o,c);if(u){for(var g,p=u.featureIndexes,A=this.font.tables[this.tableName].features,y=0;y<p.length;y++)if(g=A[p[y]],g.tag===h)return g.feature;if(c){var P=A.length;return bt.assert(P===0||h>=A[P-1].tag,"Features must be added in alphabetical order."),g={tag:h,feature:{params:0,lookupListIndexes:[]}},A.push(g),p.push(P),g.feature}}},getLookupTables:function(n,o,h,c,u){var g=this.getFeatureTable(n,o,h,u),p=[];if(g){for(var A,y=g.lookupListIndexes,P=this.font.tables[this.tableName].lookups,E=0;E<y.length;E++)A=P[y[E]],A.lookupType===c&&p.push(A);if(p.length===0&&u){A={lookupType:c,lookupFlag:0,subtables:[],markFilteringSet:void 0};var O=P.length;return P.push(A),y.push(O),[A]}}return p},getGlyphClass:function(n,o){switch(n.format){case 1:return n.startGlyph<=o&&o<n.startGlyph+n.classes.length?n.classes[o-n.startGlyph]:0;case 2:var h=qh(n.ranges,o);return h?h.classId:0}},getCoverageIndex:function(n,o){switch(n.format){case 1:var h=Ne(n.glyphs,o);return h>=0?h:-1;case 2:var c=qh(n.ranges,o);return c?c.index+o-c.start:-1}},expandCoverage:function(n){if(n.format===1)return n.glyphs;for(var o=[],h=n.ranges,c=0;c<h.length;c++)for(var u=h[c],g=u.start,p=u.end,A=g;A<=p;A++)o.push(A);return o}};function Ts(n){ki.call(this,n,"gpos")}Ts.prototype=ki.prototype,Ts.prototype.init=function(){var n=this.getDefaultScriptName();this.defaultKerningTables=this.getKerningTables(n)},Ts.prototype.getKerningValue=function(n,o,h){for(var c=0;c<n.length;c++)for(var u=n[c].subtables,g=0;g<u.length;g++){var p=u[g],A=this.getCoverageIndex(p.coverage,o);if(!(A<0))switch(p.posFormat){case 1:for(var y=p.pairSets[A],P=0;P<y.length;P++){var E=y[P];if(E.secondGlyph===h)return E.value1&&E.value1.xAdvance||0}break;case 2:var O=this.getGlyphClass(p.classDef1,o),C=this.getGlyphClass(p.classDef2,h),B=p.classRecords[O][C];return B.value1&&B.value1.xAdvance||0}}return 0},Ts.prototype.getKerningTables=function(n,o){if(this.font.tables.gpos)return this.getLookupTables(n,o,"kern",2)};function os(n){ki.call(this,n,"gsub")}function vd(n,o){var h=n.length;if(h!==o.length)return!1;for(var c=0;c<h;c++)if(n[c]!==o[c])return!1;return!0}function Zo(n,o,h){for(var c=n.subtables,u=0;u<c.length;u++){var g=c[u];if(g.substFormat===o)return g}if(h)return c.push(h),h}os.prototype=ki.prototype,os.prototype.createDefaultTable=function(){return{version:1,scripts:[{tag:"DFLT",script:{defaultLangSys:{reserved:0,reqFeatureIndex:65535,featureIndexes:[]},langSysRecords:[]}}],features:[],lookups:[]}},os.prototype.getSingle=function(n,o,h){for(var c=[],u=this.getLookupTables(o,h,n,1),g=0;g<u.length;g++)for(var p=u[g].subtables,A=0;A<p.length;A++){var y=p[A],P=this.expandCoverage(y.coverage),E=void 0;if(y.substFormat===1){var O=y.deltaGlyphId;for(E=0;E<P.length;E++){var C=P[E];c.push({sub:C,by:C+O})}}else{var B=y.substitute;for(E=0;E<P.length;E++)c.push({sub:P[E],by:B[E]})}}return c},os.prototype.getMultiple=function(n,o,h){for(var c=[],u=this.getLookupTables(o,h,n,2),g=0;g<u.length;g++)for(var p=u[g].subtables,A=0;A<p.length;A++){var y=p[A],P=this.expandCoverage(y.coverage),E=void 0;for(E=0;E<P.length;E++){var O=P[E],C=y.sequences[E];c.push({sub:O,by:C})}}return c},os.prototype.getAlternates=function(n,o,h){for(var c=[],u=this.getLookupTables(o,h,n,3),g=0;g<u.length;g++)for(var p=u[g].subtables,A=0;A<p.length;A++)for(var y=p[A],P=this.expandCoverage(y.coverage),E=y.alternateSets,O=0;O<P.length;O++)c.push({sub:P[O],by:E[O]});return c},os.prototype.getLigatures=function(n,o,h){for(var c=[],u=this.getLookupTables(o,h,n,4),g=0;g<u.length;g++)for(var p=u[g].subtables,A=0;A<p.length;A++)for(var y=p[A],P=this.expandCoverage(y.coverage),E=y.ligatureSets,O=0;O<P.length;O++)for(var C=P[O],B=E[O],Z=0;Z<B.length;Z++){var mt=B[Z];c.push({sub:[C].concat(mt.components),by:mt.ligGlyph})}return c},os.prototype.addSingle=function(n,o,h,c){var u=this.getLookupTables(h,c,n,1,!0)[0],g=Zo(u,2,{substFormat:2,coverage:{format:1,glyphs:[]},substitute:[]});bt.assert(g.coverage.format===1,"Single: unable to modify coverage table format "+g.coverage.format);var p=o.sub,A=this.binSearch(g.coverage.glyphs,p);A<0&&(A=-1-A,g.coverage.glyphs.splice(A,0,p),g.substitute.splice(A,0,0)),g.substitute[A]=o.by},os.prototype.addMultiple=function(n,o,h,c){bt.assert(o.by instanceof Array&&o.by.length>1,'Multiple: "by" must be an array of two or more ids');var u=this.getLookupTables(h,c,n,2,!0)[0],g=Zo(u,1,{substFormat:1,coverage:{format:1,glyphs:[]},sequences:[]});bt.assert(g.coverage.format===1,"Multiple: unable to modify coverage table format "+g.coverage.format);var p=o.sub,A=this.binSearch(g.coverage.glyphs,p);A<0&&(A=-1-A,g.coverage.glyphs.splice(A,0,p),g.sequences.splice(A,0,0)),g.sequences[A]=o.by},os.prototype.addAlternate=function(n,o,h,c){var u=this.getLookupTables(h,c,n,3,!0)[0],g=Zo(u,1,{substFormat:1,coverage:{format:1,glyphs:[]},alternateSets:[]});bt.assert(g.coverage.format===1,"Alternate: unable to modify coverage table format "+g.coverage.format);var p=o.sub,A=this.binSearch(g.coverage.glyphs,p);A<0&&(A=-1-A,g.coverage.glyphs.splice(A,0,p),g.alternateSets.splice(A,0,0)),g.alternateSets[A]=o.by},os.prototype.addLigature=function(n,o,h,c){var u=this.getLookupTables(h,c,n,4,!0)[0],g=u.subtables[0];g||(g={substFormat:1,coverage:{format:1,glyphs:[]},ligatureSets:[]},u.subtables[0]=g),bt.assert(g.coverage.format===1,"Ligature: unable to modify coverage table format "+g.coverage.format);var p=o.sub[0],A=o.sub.slice(1),y={ligGlyph:o.by,components:A},P=this.binSearch(g.coverage.glyphs,p);if(P>=0){for(var E=g.ligatureSets[P],O=0;O<E.length;O++)if(vd(E[O].components,A))return;E.push(y)}else P=-1-P,g.coverage.glyphs.splice(P,0,p),g.ligatureSets.splice(P,0,[y])},os.prototype.getFeature=function(n,o,h){if(/ss\d\d/.test(n))return this.getSingle(n,o,h);switch(n){case"aalt":case"salt":return this.getSingle(n,o,h).concat(this.getAlternates(n,o,h));case"dlig":case"liga":case"rlig":return this.getLigatures(n,o,h);case"ccmp":return this.getMultiple(n,o,h).concat(this.getLigatures(n,o,h));case"stch":return this.getMultiple(n,o,h)}},os.prototype.add=function(n,o,h,c){if(/ss\d\d/.test(n))return this.addSingle(n,o,h,c);switch(n){case"aalt":case"salt":return typeof o.by=="number"?this.addSingle(n,o,h,c):this.addAlternate(n,o,h,c);case"dlig":case"liga":case"rlig":return this.addLigature(n,o,h,c);case"ccmp":return o.by instanceof Array?this.addMultiple(n,o,h,c):this.addLigature(n,o,h,c)}};function Sd(){return!0}function Vh(n){for(var o=new ArrayBuffer(n.length),h=new Uint8Array(o),c=0;c<n.length;++c)h[c]=n[c];return o}function wd(n){for(var o=new V(n.byteLength),h=new Uint8Array(n),c=0;c<o.length;++c)o[c]=h[c];return o}function Js(n,o){if(!n)throw o}function Qh(n,o,h,c,u){var g;return(o&c)>0?(g=n.parseByte(),(o&u)===0&&(g=-g),g=h+g):(o&u)>0?g=h:g=h+n.parseShort(),g}function Kh(n,o,h){var c=new St.Parser(o,h);n.numberOfContours=c.parseShort(),n._xMin=c.parseShort(),n._yMin=c.parseShort(),n._xMax=c.parseShort(),n._yMax=c.parseShort();var u,g;if(n.numberOfContours>0){for(var p=n.endPointIndices=[],A=0;A<n.numberOfContours;A+=1)p.push(c.parseUShort());n.instructionLength=c.parseUShort(),n.instructions=[];for(var y=0;y<n.instructionLength;y+=1)n.instructions.push(c.parseByte());var P=p[p.length-1]+1;u=[];for(var E=0;E<P;E+=1)if(g=c.parseByte(),u.push(g),(g&8)>0)for(var O=c.parseByte(),C=0;C<O;C+=1)u.push(g),E+=1;if(bt.argument(u.length===P,"Bad flags."),p.length>0){var B=[],Z;if(P>0){for(var mt=0;mt<P;mt+=1)g=u[mt],Z={},Z.onCurve=!!(g&1),Z.lastPointOfContour=p.indexOf(mt)>=0,B.push(Z);for(var ht=0,ft=0;ft<P;ft+=1)g=u[ft],Z=B[ft],Z.x=Qh(c,g,ht,2,16),ht=Z.x;for(var _t=0,wt=0;wt<P;wt+=1)g=u[wt],Z=B[wt],Z.y=Qh(c,g,_t,4,32),_t=Z.y}n.points=B}else n.points=[]}else if(n.numberOfContours===0)n.points=[];else{n.isComposite=!0,n.points=[],n.components=[];for(var ee=!0;ee;){u=c.parseUShort();var Xt={glyphIndex:c.parseUShort(),xScale:1,scale01:0,scale10:0,yScale:1,dx:0,dy:0};(u&1)>0?(u&2)>0?(Xt.dx=c.parseShort(),Xt.dy=c.parseShort()):Xt.matchedPoints=[c.parseUShort(),c.parseUShort()]:(u&2)>0?(Xt.dx=c.parseChar(),Xt.dy=c.parseChar()):Xt.matchedPoints=[c.parseByte(),c.parseByte()],(u&8)>0?Xt.xScale=Xt.yScale=c.parseF2Dot14():(u&64)>0?(Xt.xScale=c.parseF2Dot14(),Xt.yScale=c.parseF2Dot14()):(u&128)>0&&(Xt.xScale=c.parseF2Dot14(),Xt.scale01=c.parseF2Dot14(),Xt.scale10=c.parseF2Dot14(),Xt.yScale=c.parseF2Dot14()),n.components.push(Xt),ee=!!(u&32)}if(u&256){n.instructionLength=c.parseUShort(),n.instructions=[];for(var ve=0;ve<n.instructionLength;ve+=1)n.instructions.push(c.parseByte())}}}function $s(n,o){for(var h=[],c=0;c<n.length;c+=1){var u=n[c],g={x:o.xScale*u.x+o.scale01*u.y+o.dx,y:o.scale10*u.x+o.yScale*u.y+o.dy,onCurve:u.onCurve,lastPointOfContour:u.lastPointOfContour};h.push(g)}return h}function xd(n){for(var o=[],h=[],c=0;c<n.length;c+=1){var u=n[c];h.push(u),u.lastPointOfContour&&(o.push(h),h=[])}return bt.argument(h.length===0,"There are still points left in the current contour."),o}function $e(n){var o=new $t;if(!n)return o;for(var h=xd(n),c=0;c<h.length;++c){var u=h[c],g=null,p=u[u.length-1],A=u[0];if(p.onCurve)o.moveTo(p.x,p.y);else if(A.onCurve)o.moveTo(A.x,A.y);else{var y={x:(p.x+A.x)*.5,y:(p.y+A.y)*.5};o.moveTo(y.x,y.y)}for(var P=0;P<u.length;++P)if(g=p,p=A,A=u[(P+1)%u.length],p.onCurve)o.lineTo(p.x,p.y);else{var E=g,O=A;g.onCurve||(E={x:(p.x+g.x)*.5,y:(p.y+g.y)*.5}),A.onCurve||(O={x:(p.x+A.x)*.5,y:(p.y+A.y)*.5}),o.quadraticCurveTo(p.x,p.y,O.x,O.y)}o.closePath()}return o}function Sr(n,o){if(o.isComposite)for(var h=0;h<o.components.length;h+=1){var c=o.components[h],u=n.get(c.glyphIndex);if(u.getPath(),u.points){var g=void 0;if(c.matchedPoints===void 0)g=$s(u.points,c);else{if(c.matchedPoints[0]>o.points.length-1||c.matchedPoints[1]>u.points.length-1)throw Error("Matched points out of range in "+o.name);var p=o.points[c.matchedPoints[0]],A=u.points[c.matchedPoints[1]],y={xScale:c.xScale,scale01:c.scale01,scale10:c.scale10,yScale:c.yScale,dx:0,dy:0};A=$s([A],y)[0],y.dx=p.x-A.x,y.dy=p.y-A.y,g=$s(u.points,y)}o.points=o.points.concat(g)}}return $e(o.points)}function Ae(n,o,h,c){for(var u=new N.GlyphSet(c),g=0;g<h.length-1;g+=1){var p=h[g],A=h[g+1];p!==A?u.push(g,N.ttfGlyphLoader(c,g,Kh,n,o+p,Sr)):u.push(g,N.glyphLoader(c,g))}return u}function qi(n,o,h,c){var u=new N.GlyphSet(c);return c._push=function(g){var p=h[g],A=h[g+1];p!==A?u.push(g,N.ttfGlyphLoader(c,g,Kh,n,o+p,Sr)):u.push(g,N.glyphLoader(c,g))},u}function bd(n,o,h,c,u){return u.lowMemory?qi(n,o,h,c):Ae(n,o,h,c)}var Jh={getPath:$e,parse:bd},wr,xr,$h,jo;function On(n){this.font=n,this.getCommands=function(o){return Jh.getPath(o).commands},this._fpgmState=this._prepState=void 0,this._errorState=0}function ta(n){return n}function as(n){return Math.sign(n)*Math.round(Math.abs(n))}function Pd(n){return Math.sign(n)*Math.round(Math.abs(n*2))/2}function Ed(n){return Math.sign(n)*(Math.round(Math.abs(n)+.5)-.5)}function ea(n){return Math.sign(n)*Math.ceil(Math.abs(n))}function Dd(n){return Math.sign(n)*Math.floor(Math.abs(n))}var sa=function(n){var o=this.srPeriod,h=this.srPhase,c=this.srThreshold,u=1;return n<0&&(n=-n,u=-1),n+=c-h,n=Math.trunc(n/o)*o,n+=h,n<0?h*u:n*u},_s={x:1,y:0,axis:"x",distance:function(n,o,h,c){return(h?n.xo:n.x)-(c?o.xo:o.x)},interpolate:function(n,o,h,c){var u,g,p,A,y,P,E;if(!c||c===this){if(u=n.xo-o.xo,g=n.xo-h.xo,y=o.x-o.xo,P=h.x-h.xo,p=Math.abs(u),A=Math.abs(g),E=p+A,E===0){n.x=n.xo+(y+P)/2;return}n.x=n.xo+(y*A+P*p)/E;return}if(u=c.distance(n,o,!0,!0),g=c.distance(n,h,!0,!0),y=c.distance(o,o,!1,!0),P=c.distance(h,h,!1,!0),p=Math.abs(u),A=Math.abs(g),E=p+A,E===0){_s.setRelative(n,n,(y+P)/2,c,!0);return}_s.setRelative(n,n,(y*A+P*p)/E,c,!0)},normalSlope:Number.NEGATIVE_INFINITY,setRelative:function(n,o,h,c,u){if(!c||c===this){n.x=(u?o.xo:o.x)+h;return}var g=u?o.xo:o.x,p=u?o.yo:o.y,A=g+h*c.x,y=p+h*c.y;n.x=A+(n.y-y)/c.normalSlope},slope:0,touch:function(n){n.xTouched=!0},touched:function(n){return n.xTouched},untouch:function(n){n.xTouched=!1}},Zs={x:0,y:1,axis:"y",distance:function(n,o,h,c){return(h?n.yo:n.y)-(c?o.yo:o.y)},interpolate:function(n,o,h,c){var u,g,p,A,y,P,E;if(!c||c===this){if(u=n.yo-o.yo,g=n.yo-h.yo,y=o.y-o.yo,P=h.y-h.yo,p=Math.abs(u),A=Math.abs(g),E=p+A,E===0){n.y=n.yo+(y+P)/2;return}n.y=n.yo+(y*A+P*p)/E;return}if(u=c.distance(n,o,!0,!0),g=c.distance(n,h,!0,!0),y=c.distance(o,o,!1,!0),P=c.distance(h,h,!1,!0),p=Math.abs(u),A=Math.abs(g),E=p+A,E===0){Zs.setRelative(n,n,(y+P)/2,c,!0);return}Zs.setRelative(n,n,(y*A+P*p)/E,c,!0)},normalSlope:0,setRelative:function(n,o,h,c,u){if(!c||c===this){n.y=(u?o.yo:o.y)+h;return}var g=u?o.xo:o.x,p=u?o.yo:o.y,A=g+h*c.x,y=p+h*c.y;n.y=y+c.normalSlope*(n.x-A)},slope:Number.POSITIVE_INFINITY,touch:function(n){n.yTouched=!0},touched:function(n){return n.yTouched},untouch:function(n){n.yTouched=!1}};Object.freeze(_s),Object.freeze(Zs);function Vi(n,o){this.x=n,this.y=o,this.axis=void 0,this.slope=o/n,this.normalSlope=-n/o,Object.freeze(this)}Vi.prototype.distance=function(n,o,h,c){return this.x*_s.distance(n,o,h,c)+this.y*Zs.distance(n,o,h,c)},Vi.prototype.interpolate=function(n,o,h,c){var u,g,p,A,y,P,E;if(p=c.distance(n,o,!0,!0),A=c.distance(n,h,!0,!0),u=c.distance(o,o,!1,!0),g=c.distance(h,h,!1,!0),y=Math.abs(p),P=Math.abs(A),E=y+P,E===0){this.setRelative(n,n,(u+g)/2,c,!0);return}this.setRelative(n,n,(u*P+g*y)/E,c,!0)},Vi.prototype.setRelative=function(n,o,h,c,u){c=c||this;var g=u?o.xo:o.x,p=u?o.yo:o.y,A=g+h*c.x,y=p+h*c.y,P=c.normalSlope,E=this.slope,O=n.x,C=n.y;n.x=(E*O-P*A+y-C)/(E-P),n.y=E*(n.x-O)+C},Vi.prototype.touch=function(n){n.xTouched=!0,n.yTouched=!0};function Qi(n,o){var h=Math.sqrt(n*n+o*o);return n/=h,o/=h,n===1&&o===0?_s:n===0&&o===1?Zs:new Vi(n,o)}function js(n,o,h,c){this.x=this.xo=Math.round(n*64)/64,this.y=this.yo=Math.round(o*64)/64,this.lastPointOfContour=h,this.onCurve=c,this.prevPointOnContour=void 0,this.nextPointOnContour=void 0,this.xTouched=!1,this.yTouched=!1,Object.preventExtensions(this)}js.prototype.nextTouched=function(n){for(var o=this.nextPointOnContour;!n.touched(o)&&o!==this;)o=o.nextPointOnContour;return o},js.prototype.prevTouched=function(n){for(var o=this.prevPointOnContour;!n.touched(o)&&o!==this;)o=o.prevPointOnContour;return o};var Ki=Object.freeze(new js(0,0)),wi={cvCutIn:17/16,deltaBase:9,deltaShift:.125,loop:1,minDis:1,autoFlip:!0};function tr(n,o){switch(this.env=n,this.stack=[],this.prog=o,n){case"glyf":this.zp0=this.zp1=this.zp2=1,this.rp0=this.rp1=this.rp2=0;case"prep":this.fv=this.pv=this.dpv=_s,this.round=as}}On.prototype.exec=function(n,o){if(typeof o!="number")throw new Error("Point size is not a number!");if(!(this._errorState>2)){var h=this.font,c=this._prepState;if(!c||c.ppem!==o){var u=this._fpgmState;if(!u){tr.prototype=wi,u=this._fpgmState=new tr("fpgm",h.tables.fpgm),u.funcs=[],u.font=h,Y.DEBUG&&(console.log("---EXEC FPGM---"),u.step=-1);try{xr(u)}catch(P){console.log("Hinting error in FPGM:"+P),this._errorState=3;return}}tr.prototype=u,c=this._prepState=new tr("prep",h.tables.prep),c.ppem=o;var g=h.tables.cvt;if(g)for(var p=c.cvt=new Array(g.length),A=o/h.unitsPerEm,y=0;y<g.length;y++)p[y]=g[y]*A;else c.cvt=[];Y.DEBUG&&(console.log("---EXEC PREP---"),c.step=-1);try{xr(c)}catch(P){this._errorState<2&&console.log("Hinting error in PREP:"+P),this._errorState=2}}if(!(this._errorState>1))try{return $h(n,c)}catch(P){this._errorState<1&&(console.log("Hinting error:"+P),console.log("Note: further hinting errors are silenced")),this._errorState=1;return}}},$h=function(n,o){var h=o.ppem/o.font.unitsPerEm,c=h,u=n.components,g,p,A;if(tr.prototype=o,!u)A=new tr("glyf",n.instructions),Y.DEBUG&&(console.log("---EXEC GLYPH---"),A.step=-1),jo(n,A,h,c),p=A.gZone;else{var y=o.font;p=[],g=[];for(var P=0;P<u.length;P++){var E=u[P],O=y.glyphs.get(E.glyphIndex);A=new tr("glyf",O.instructions),Y.DEBUG&&(console.log("---EXEC COMP "+P+"---"),A.step=-1),jo(O,A,h,c);for(var C=Math.round(E.dx*h),B=Math.round(E.dy*c),Z=A.gZone,mt=A.contours,ht=0;ht<Z.length;ht++){var ft=Z[ht];ft.xTouched=ft.yTouched=!1,ft.xo=ft.x=ft.x+C,ft.yo=ft.y=ft.y+B}var _t=p.length;p.push.apply(p,Z);for(var wt=0;wt<mt.length;wt++)g.push(mt[wt]+_t)}n.instructions&&!A.inhibitGridFit&&(A=new tr("glyf",n.instructions),A.gZone=A.z0=A.z1=A.z2=p,A.contours=g,p.push(new js(0,0),new js(Math.round(n.advanceWidth*h),0)),Y.DEBUG&&(console.log("---EXEC COMPOSITE---"),A.step=-1),xr(A),p.length-=2)}return p},jo=function(n,o,h,c){for(var u=n.points||[],g=u.length,p=o.gZone=o.z0=o.z1=o.z2=[],A=o.contours=[],y,P=0;P<g;P++)y=u[P],p[P]=new js(y.x*h,y.y*c,y.lastPointOfContour,y.onCurve);for(var E,O,C=0;C<g;C++)y=p[C],E||(E=y,A.push(C)),y.lastPointOfContour?(y.nextPointOnContour=E,E.prevPointOnContour=y,E=void 0):(O=p[C+1],y.nextPointOnContour=O,O.prevPointOnContour=y);if(!o.inhibitGridFit){if(Y.DEBUG){console.log("PROCESSING GLYPH",o.stack);for(var B=0;B<g;B++)console.log(B,p[B].x,p[B].y)}if(p.push(new js(0,0),new js(Math.round(n.advanceWidth*h),0)),xr(o),p.length-=2,Y.DEBUG){console.log("FINISHED GLYPH",o.stack);for(var Z=0;Z<g;Z++)console.log(Z,p[Z].x,p[Z].y)}}},xr=function(n){var o=n.prog;if(o){var h=o.length,c;for(n.ip=0;n.ip<h;n.ip++){if(Y.DEBUG&&n.step++,c=wr[o[n.ip]],!c)throw new Error("unknown instruction: 0x"+Number(o[n.ip]).toString(16));c(n)}}};function Bn(n){for(var o=n.tZone=new Array(n.gZone.length),h=0;h<o.length;h++)o[h]=new js(0,0)}function ra(n,o){var h=n.prog,c=n.ip,u=1,g;do if(g=h[++c],g===88)u++;else if(g===89)u--;else if(g===64)c+=h[c+1]+1;else if(g===65)c+=2*h[c+1]+1;else if(g>=176&&g<=183)c+=g-176+1;else if(g>=184&&g<=191)c+=(g-184+1)*2;else if(o&&u===1&&g===27)break;while(u>0);n.ip=c}function Zh(n,o){Y.DEBUG&&console.log(o.step,"SVTCA["+n.axis+"]"),o.fv=o.pv=o.dpv=n}function jh(n,o){Y.DEBUG&&console.log(o.step,"SPVTCA["+n.axis+"]"),o.pv=o.dpv=n}function tl(n,o){Y.DEBUG&&console.log(o.step,"SFVTCA["+n.axis+"]"),o.fv=n}function el(n,o){var h=o.stack,c=h.pop(),u=h.pop(),g=o.z2[c],p=o.z1[u];Y.DEBUG&&console.log("SPVTL["+n+"]",c,u);var A,y;n?(A=g.y-p.y,y=p.x-g.x):(A=p.x-g.x,y=p.y-g.y),o.pv=o.dpv=Qi(A,y)}function sl(n,o){var h=o.stack,c=h.pop(),u=h.pop(),g=o.z2[c],p=o.z1[u];Y.DEBUG&&console.log("SFVTL["+n+"]",c,u);var A,y;n?(A=g.y-p.y,y=p.x-g.x):(A=p.x-g.x,y=p.y-g.y),o.fv=Qi(A,y)}function In(n){var o=n.stack,h=o.pop(),c=o.pop();Y.DEBUG&&console.log(n.step,"SPVFS[]",h,c),n.pv=n.dpv=Qi(c,h)}function rl(n){var o=n.stack,h=o.pop(),c=o.pop();Y.DEBUG&&console.log(n.step,"SPVFS[]",h,c),n.fv=Qi(c,h)}function Cd(n){var o=n.stack,h=n.pv;Y.DEBUG&&console.log(n.step,"GPV[]"),o.push(h.x*16384),o.push(h.y*16384)}function Td(n){var o=n.stack,h=n.fv;Y.DEBUG&&console.log(n.step,"GFV[]"),o.push(h.x*16384),o.push(h.y*16384)}function Rd(n){n.fv=n.pv,Y.DEBUG&&console.log(n.step,"SFVTPV[]")}function Nd(n){var o=n.stack,h=o.pop(),c=o.pop(),u=o.pop(),g=o.pop(),p=o.pop(),A=n.z0,y=n.z1,P=A[h],E=A[c],O=y[u],C=y[g],B=n.z2[p];Y.DEBUG&&console.log("ISECT[], ",h,c,u,g,p);var Z=P.x,mt=P.y,ht=E.x,ft=E.y,_t=O.x,wt=O.y,ee=C.x,Xt=C.y,ve=(Z-ht)*(wt-Xt)-(mt-ft)*(_t-ee),Wt=Z*ft-mt*ht,Rt=_t*Xt-wt*ee;B.x=(Wt*(_t-ee)-Rt*(Z-ht))/ve,B.y=(Wt*(wt-Xt)-Rt*(mt-ft))/ve}function Ld(n){n.rp0=n.stack.pop(),Y.DEBUG&&console.log(n.step,"SRP0[]",n.rp0)}function Md(n){n.rp1=n.stack.pop(),Y.DEBUG&&console.log(n.step,"SRP1[]",n.rp1)}function Od(n){n.rp2=n.stack.pop(),Y.DEBUG&&console.log(n.step,"SRP2[]",n.rp2)}function qr(n){var o=n.stack.pop();switch(Y.DEBUG&&console.log(n.step,"SZP0[]",o),n.zp0=o,o){case 0:n.tZone||Bn(n),n.z0=n.tZone;break;case 1:n.z0=n.gZone;break;default:throw new Error("Invalid zone pointer")}}function Bd(n){var o=n.stack.pop();switch(Y.DEBUG&&console.log(n.step,"SZP1[]",o),n.zp1=o,o){case 0:n.tZone||Bn(n),n.z1=n.tZone;break;case 1:n.z1=n.gZone;break;default:throw new Error("Invalid zone pointer")}}function il(n){var o=n.stack.pop();switch(Y.DEBUG&&console.log(n.step,"SZP2[]",o),n.zp2=o,o){case 0:n.tZone||Bn(n),n.z2=n.tZone;break;case 1:n.z2=n.gZone;break;default:throw new Error("Invalid zone pointer")}}function Id(n){var o=n.stack.pop();switch(Y.DEBUG&&console.log(n.step,"SZPS[]",o),n.zp0=n.zp1=n.zp2=o,o){case 0:n.tZone||Bn(n),n.z0=n.z1=n.z2=n.tZone;break;case 1:n.z0=n.z1=n.z2=n.gZone;break;default:throw new Error("Invalid zone pointer")}}function Fd(n){n.loop=n.stack.pop(),Y.DEBUG&&console.log(n.step,"SLOOP[]",n.loop)}function Ud(n){Y.DEBUG&&console.log(n.step,"RTG[]"),n.round=as}function Hd(n){Y.DEBUG&&console.log(n.step,"RTHG[]"),n.round=Ed}function _d(n){var o=n.stack.pop();Y.DEBUG&&console.log(n.step,"SMD[]",o),n.minDis=o/64}function Gd(n){Y.DEBUG&&console.log(n.step,"ELSE[]"),ra(n,!1)}function Xd(n){var o=n.stack.pop();Y.DEBUG&&console.log(n.step,"JMPR[]",o),n.ip+=o-1}function Fn(n){var o=n.stack.pop();Y.DEBUG&&console.log(n.step,"SCVTCI[]",o),n.cvCutIn=o/64}function Wd(n){var o=n.stack;Y.DEBUG&&console.log(n.step,"DUP[]"),o.push(o[o.length-1])}function ia(n){Y.DEBUG&&console.log(n.step,"POP[]"),n.stack.pop()}function zd(n){Y.DEBUG&&console.log(n.step,"CLEAR[]"),n.stack.length=0}function Yd(n){var o=n.stack,h=o.pop(),c=o.pop();Y.DEBUG&&console.log(n.step,"SWAP[]"),o.push(h),o.push(c)}function kd(n){var o=n.stack;Y.DEBUG&&console.log(n.step,"DEPTH[]"),o.push(o.length)}function Un(n){var o=n.stack,h=o.pop(),c=o.pop();Y.DEBUG&&console.log(n.step,"LOOPCALL[]",h,c);var u=n.ip,g=n.prog;n.prog=n.funcs[h];for(var p=0;p<c;p++)xr(n),Y.DEBUG&&console.log(++n.step,p+1<c?"next loopcall":"done loopcall",p);n.ip=u,n.prog=g}function qd(n){var o=n.stack.pop();Y.DEBUG&&console.log(n.step,"CALL[]",o);var h=n.ip,c=n.prog;n.prog=n.funcs[o],xr(n),n.ip=h,n.prog=c,Y.DEBUG&&console.log(++n.step,"returning from",o)}function Vd(n){var o=n.stack,h=o.pop();Y.DEBUG&&console.log(n.step,"CINDEX[]",h),o.push(o[o.length-h])}function Qd(n){var o=n.stack,h=o.pop();Y.DEBUG&&console.log(n.step,"MINDEX[]",h),o.push(o.splice(o.length-h,1)[0])}function Kd(n){if(n.env!=="fpgm")throw new Error("FDEF not allowed here");var o=n.stack,h=n.prog,c=n.ip,u=o.pop(),g=c;for(Y.DEBUG&&console.log(n.step,"FDEF[]",u);h[++c]!==45;);n.ip=c,n.funcs[u]=h.slice(g+1,c)}function Ji(n,o){var h=o.stack.pop(),c=o.z0[h],u=o.fv,g=o.pv;Y.DEBUG&&console.log(o.step,"MDAP["+n+"]",h);var p=g.distance(c,Ki);n&&(p=o.round(p)),u.setRelative(c,Ki,p,g),u.touch(c),o.rp0=o.rp1=h}function nl(n,o){var h=o.z2,c=h.length-2,u,g,p;Y.DEBUG&&console.log(o.step,"IUP["+n.axis+"]");for(var A=0;A<c;A++)u=h[A],!n.touched(u)&&(g=u.prevTouched(n),g!==u&&(p=u.nextTouched(n),g===p&&n.setRelative(u,u,n.distance(g,g,!1,!0),n,!0),n.interpolate(u,g,p,n)))}function ol(n,o){for(var h=o.stack,c=n?o.rp1:o.rp2,u=(n?o.z0:o.z1)[c],g=o.fv,p=o.pv,A=o.loop,y=o.z2;A--;){var P=h.pop(),E=y[P],O=p.distance(u,u,!1,!0);g.setRelative(E,E,O,p),g.touch(E),Y.DEBUG&&console.log(o.step,(o.loop>1?"loop "+(o.loop-A)+": ":"")+"SHP["+(n?"rp1":"rp2")+"]",P)}o.loop=1}function xi(n,o){var h=o.stack,c=n?o.rp1:o.rp2,u=(n?o.z0:o.z1)[c],g=o.fv,p=o.pv,A=h.pop(),y=o.z2[o.contours[A]],P=y;Y.DEBUG&&console.log(o.step,"SHC["+n+"]",A);var E=p.distance(u,u,!1,!0);do P!==u&&g.setRelative(P,P,E,p),P=P.nextPointOnContour;while(P!==y)}function al(n,o){var h=o.stack,c=n?o.rp1:o.rp2,u=(n?o.z0:o.z1)[c],g=o.fv,p=o.pv,A=h.pop();Y.DEBUG&&console.log(o.step,"SHZ["+n+"]",A);var y;switch(A){case 0:y=o.tZone;break;case 1:y=o.gZone;break;default:throw new Error("Invalid zone")}for(var P,E=p.distance(u,u,!1,!0),O=y.length-2,C=0;C<O;C++)P=y[C],g.setRelative(P,P,E,p)}function Jd(n){for(var o=n.stack,h=n.loop,c=n.fv,u=o.pop()/64,g=n.z2;h--;){var p=o.pop(),A=g[p];Y.DEBUG&&console.log(n.step,(n.loop>1?"loop "+(n.loop-h)+": ":"")+"SHPIX[]",p,u),c.setRelative(A,A,u),c.touch(A)}n.loop=1}function $d(n){for(var o=n.stack,h=n.rp1,c=n.rp2,u=n.loop,g=n.z0[h],p=n.z1[c],A=n.fv,y=n.dpv,P=n.z2;u--;){var E=o.pop(),O=P[E];Y.DEBUG&&console.log(n.step,(n.loop>1?"loop "+(n.loop-u)+": ":"")+"IP[]",E,h,"<->",c),A.interpolate(O,g,p,y),A.touch(O)}n.loop=1}function hl(n,o){var h=o.stack,c=h.pop()/64,u=h.pop(),g=o.z1[u],p=o.z0[o.rp0],A=o.fv,y=o.pv;A.setRelative(g,p,c,y),A.touch(g),Y.DEBUG&&console.log(o.step,"MSIRP["+n+"]",c,u),o.rp1=o.rp0,o.rp2=u,n&&(o.rp0=u)}function na(n){for(var o=n.stack,h=n.rp0,c=n.z0[h],u=n.loop,g=n.fv,p=n.pv,A=n.z1;u--;){var y=o.pop(),P=A[y];Y.DEBUG&&console.log(n.step,(n.loop>1?"loop "+(n.loop-u)+": ":"")+"ALIGNRP[]",y),g.setRelative(P,c,0,p),g.touch(P)}n.loop=1}function Zd(n){Y.DEBUG&&console.log(n.step,"RTDG[]"),n.round=Pd}function oa(n,o){var h=o.stack,c=h.pop(),u=h.pop(),g=o.z0[u],p=o.fv,A=o.pv,y=o.cvt[c];Y.DEBUG&&console.log(o.step,"MIAP["+n+"]",c,"(",y,")",u);var P=A.distance(g,Ki);n&&(Math.abs(P-y)<o.cvCutIn&&(P=y),P=o.round(P)),p.setRelative(g,Ki,P,A),o.zp0===0&&(g.xo=g.x,g.yo=g.y),p.touch(g),o.rp0=o.rp1=u}function jd(n){var o=n.prog,h=n.ip,c=n.stack,u=o[++h];Y.DEBUG&&console.log(n.step,"NPUSHB[]",u);for(var g=0;g<u;g++)c.push(o[++h]);n.ip=h}function tf(n){var o=n.ip,h=n.prog,c=n.stack,u=h[++o];Y.DEBUG&&console.log(n.step,"NPUSHW[]",u);for(var g=0;g<u;g++){var p=h[++o]<<8|h[++o];p&32768&&(p=-((p^65535)+1)),c.push(p)}n.ip=o}function ef(n){var o=n.stack,h=n.store;h||(h=n.store=[]);var c=o.pop(),u=o.pop();Y.DEBUG&&console.log(n.step,"WS",c,u),h[u]=c}function sf(n){var o=n.stack,h=n.store,c=o.pop();Y.DEBUG&&console.log(n.step,"RS",c);var u=h&&h[c]||0;o.push(u)}function rf(n){var o=n.stack,h=o.pop(),c=o.pop();Y.DEBUG&&console.log(n.step,"WCVTP",h,c),n.cvt[c]=h/64}function nf(n){var o=n.stack,h=o.pop();Y.DEBUG&&console.log(n.step,"RCVT",h),o.push(n.cvt[h]*64)}function ll(n,o){var h=o.stack,c=h.pop(),u=o.z2[c];Y.DEBUG&&console.log(o.step,"GC["+n+"]",c),h.push(o.dpv.distance(u,Ki,n,!1)*64)}function cl(n,o){var h=o.stack,c=h.pop(),u=h.pop(),g=o.z1[c],p=o.z0[u],A=o.dpv.distance(p,g,n,n);Y.DEBUG&&console.log(o.step,"MD["+n+"]",c,u,"->",A),o.stack.push(Math.round(A*64))}function aa(n){Y.DEBUG&&console.log(n.step,"MPPEM[]"),n.stack.push(n.ppem)}function ul(n){Y.DEBUG&&console.log(n.step,"FLIPON[]"),n.autoFlip=!0}function of(n){var o=n.stack,h=o.pop(),c=o.pop();Y.DEBUG&&console.log(n.step,"LT[]",h,c),o.push(c<h?1:0)}function ha(n){var o=n.stack,h=o.pop(),c=o.pop();Y.DEBUG&&console.log(n.step,"LTEQ[]",h,c),o.push(c<=h?1:0)}function af(n){var o=n.stack,h=o.pop(),c=o.pop();Y.DEBUG&&console.log(n.step,"GT[]",h,c),o.push(c>h?1:0)}function hf(n){var o=n.stack,h=o.pop(),c=o.pop();Y.DEBUG&&console.log(n.step,"GTEQ[]",h,c),o.push(c>=h?1:0)}function la(n){var o=n.stack,h=o.pop(),c=o.pop();Y.DEBUG&&console.log(n.step,"EQ[]",h,c),o.push(h===c?1:0)}function dl(n){var o=n.stack,h=o.pop(),c=o.pop();Y.DEBUG&&console.log(n.step,"NEQ[]",h,c),o.push(h!==c?1:0)}function lf(n){var o=n.stack,h=o.pop();Y.DEBUG&&console.log(n.step,"ODD[]",h),o.push(Math.trunc(h)%2?1:0)}function cf(n){var o=n.stack,h=o.pop();Y.DEBUG&&console.log(n.step,"EVEN[]",h),o.push(Math.trunc(h)%2?0:1)}function uf(n){var o=n.stack.pop();Y.DEBUG&&console.log(n.step,"IF[]",o),o||(ra(n,!0),Y.DEBUG&&console.log(n.step,"EIF[]"))}function df(n){Y.DEBUG&&console.log(n.step,"EIF[]")}function ff(n){var o=n.stack,h=o.pop(),c=o.pop();Y.DEBUG&&console.log(n.step,"AND[]",h,c),o.push(h&&c?1:0)}function gf(n){var o=n.stack,h=o.pop(),c=o.pop();Y.DEBUG&&console.log(n.step,"OR[]",h,c),o.push(h||c?1:0)}function pf(n){var o=n.stack,h=o.pop();Y.DEBUG&&console.log(n.step,"NOT[]",h),o.push(h?0:1)}function bi(n,o){var h=o.stack,c=h.pop(),u=o.fv,g=o.pv,p=o.ppem,A=o.deltaBase+(n-1)*16,y=o.deltaShift,P=o.z0;Y.DEBUG&&console.log(o.step,"DELTAP["+n+"]",c,h);for(var E=0;E<c;E++){var O=h.pop(),C=h.pop(),B=A+((C&240)>>4);if(B===p){var Z=(C&15)-8;Z>=0&&Z++,Y.DEBUG&&console.log(o.step,"DELTAPFIX",O,"by",Z*y);var mt=P[O];u.setRelative(mt,mt,Z*y,g)}}}function mf(n){var o=n.stack,h=o.pop();Y.DEBUG&&console.log(n.step,"SDB[]",h),n.deltaBase=h}function yf(n){var o=n.stack,h=o.pop();Y.DEBUG&&console.log(n.step,"SDS[]",h),n.deltaShift=Math.pow(.5,h)}function Af(n){var o=n.stack,h=o.pop(),c=o.pop();Y.DEBUG&&console.log(n.step,"ADD[]",h,c),o.push(c+h)}function vf(n){var o=n.stack,h=o.pop(),c=o.pop();Y.DEBUG&&console.log(n.step,"SUB[]",h,c),o.push(c-h)}function Le(n){var o=n.stack,h=o.pop(),c=o.pop();Y.DEBUG&&console.log(n.step,"DIV[]",h,c),o.push(c*64/h)}function Gs(n){var o=n.stack,h=o.pop(),c=o.pop();Y.DEBUG&&console.log(n.step,"MUL[]",h,c),o.push(c*h/64)}function Sf(n){var o=n.stack,h=o.pop();Y.DEBUG&&console.log(n.step,"ABS[]",h),o.push(Math.abs(h))}function wf(n){var o=n.stack,h=o.pop();Y.DEBUG&&console.log(n.step,"NEG[]",h),o.push(-h)}function $i(n){var o=n.stack,h=o.pop();Y.DEBUG&&console.log(n.step,"FLOOR[]",h),o.push(Math.floor(h/64)*64)}function xf(n){var o=n.stack,h=o.pop();Y.DEBUG&&console.log(n.step,"CEILING[]",h),o.push(Math.ceil(h/64)*64)}function Hn(n,o){var h=o.stack,c=h.pop();Y.DEBUG&&console.log(o.step,"ROUND[]"),h.push(o.round(c/64)*64)}function bf(n){var o=n.stack,h=o.pop(),c=o.pop();Y.DEBUG&&console.log(n.step,"WCVTF[]",h,c),n.cvt[c]=h*n.ppem/n.font.unitsPerEm}function ca(n,o){var h=o.stack,c=h.pop(),u=o.ppem,g=o.deltaBase+(n-1)*16,p=o.deltaShift;Y.DEBUG&&console.log(o.step,"DELTAC["+n+"]",c,h);for(var A=0;A<c;A++){var y=h.pop(),P=h.pop(),E=g+((P&240)>>4);if(E===u){var O=(P&15)-8;O>=0&&O++;var C=O*p;Y.DEBUG&&console.log(o.step,"DELTACFIX",y,"by",C),o.cvt[y]+=C}}}function Pf(n){var o=n.stack.pop();Y.DEBUG&&console.log(n.step,"SROUND[]",o),n.round=sa;var h;switch(o&192){case 0:h=.5;break;case 64:h=1;break;case 128:h=2;break;default:throw new Error("invalid SROUND value")}switch(n.srPeriod=h,o&48){case 0:n.srPhase=0;break;case 16:n.srPhase=.25*h;break;case 32:n.srPhase=.5*h;break;case 48:n.srPhase=.75*h;break;default:throw new Error("invalid SROUND value")}o&=15,o===0?n.srThreshold=0:n.srThreshold=(o/8-.5)*h}function Ef(n){var o=n.stack.pop();Y.DEBUG&&console.log(n.step,"S45ROUND[]",o),n.round=sa;var h;switch(o&192){case 0:h=Math.sqrt(2)/2;break;case 64:h=Math.sqrt(2);break;case 128:h=2*Math.sqrt(2);break;default:throw new Error("invalid S45ROUND value")}switch(n.srPeriod=h,o&48){case 0:n.srPhase=0;break;case 16:n.srPhase=.25*h;break;case 32:n.srPhase=.5*h;break;case 48:n.srPhase=.75*h;break;default:throw new Error("invalid S45ROUND value")}o&=15,o===0?n.srThreshold=0:n.srThreshold=(o/8-.5)*h}function Df(n){Y.DEBUG&&console.log(n.step,"ROFF[]"),n.round=ta}function Cf(n){Y.DEBUG&&console.log(n.step,"RUTG[]"),n.round=ea}function Tf(n){Y.DEBUG&&console.log(n.step,"RDTG[]"),n.round=Dd}function Zi(n){var o=n.stack.pop();Y.DEBUG&&console.log(n.step,"SCANCTRL[]",o)}function fl(n,o){var h=o.stack,c=h.pop(),u=h.pop(),g=o.z2[c],p=o.z1[u];Y.DEBUG&&console.log(o.step,"SDPVTL["+n+"]",c,u);var A,y;n?(A=g.y-p.y,y=p.x-g.x):(A=p.x-g.x,y=p.y-g.y),o.dpv=Qi(A,y)}function Rf(n){var o=n.stack,h=o.pop(),c=0;Y.DEBUG&&console.log(n.step,"GETINFO[]",h),h&1&&(c=35),h&32&&(c|=4096),o.push(c)}function Nf(n){var o=n.stack,h=o.pop(),c=o.pop(),u=o.pop();Y.DEBUG&&console.log(n.step,"ROLL[]"),o.push(c),o.push(h),o.push(u)}function Lf(n){var o=n.stack,h=o.pop(),c=o.pop();Y.DEBUG&&console.log(n.step,"MAX[]",h,c),o.push(Math.max(c,h))}function ua(n){var o=n.stack,h=o.pop(),c=o.pop();Y.DEBUG&&console.log(n.step,"MIN[]",h,c),o.push(Math.min(c,h))}function _n(n){var o=n.stack.pop();Y.DEBUG&&console.log(n.step,"SCANTYPE[]",o)}function Mf(n){var o=n.stack.pop(),h=n.stack.pop();switch(Y.DEBUG&&console.log(n.step,"INSTCTRL[]",o,h),o){case 1:n.inhibitGridFit=!!h;return;case 2:n.ignoreCvt=!!h;return;default:throw new Error("invalid INSTCTRL[] selector")}}function br(n,o){var h=o.stack,c=o.prog,u=o.ip;Y.DEBUG&&console.log(o.step,"PUSHB["+n+"]");for(var g=0;g<n;g++)h.push(c[++u]);o.ip=u}function Pr(n,o){var h=o.ip,c=o.prog,u=o.stack;Y.DEBUG&&console.log(o.ip,"PUSHW["+n+"]");for(var g=0;g<n;g++){var p=c[++h]<<8|c[++h];p&32768&&(p=-((p^65535)+1)),u.push(p)}o.ip=h}function Pt(n,o,h,c,u,g){var p=g.stack,A=n&&p.pop(),y=p.pop(),P=g.rp0,E=g.z0[P],O=g.z1[y],C=g.minDis,B=g.fv,Z=g.dpv,mt,ht,ft,_t;ht=mt=Z.distance(O,E,!0,!0),ft=ht>=0?1:-1,ht=Math.abs(ht),n&&(_t=g.cvt[A],c&&Math.abs(ht-_t)<g.cvCutIn&&(ht=_t)),h&&ht<C&&(ht=C),c&&(ht=g.round(ht)),B.setRelative(O,E,ft*ht,Z),B.touch(O),Y.DEBUG&&console.log(g.step,(n?"MIRP[":"MDRP[")+(o?"M":"m")+(h?">":"_")+(c?"R":"_")+(u===0?"Gr":u===1?"Bl":u===2?"Wh":"")+"]",n?A+"("+g.cvt[A]+","+_t+")":"",y,"(d =",mt,"->",ft*ht,")"),g.rp1=g.rp0,g.rp2=y,o&&(g.rp0=y)}wr=[Zh.bind(void 0,Zs),Zh.bind(void 0,_s),jh.bind(void 0,Zs),jh.bind(void 0,_s),tl.bind(void 0,Zs),tl.bind(void 0,_s),el.bind(void 0,0),el.bind(void 0,1),sl.bind(void 0,0),sl.bind(void 0,1),In,rl,Cd,Td,Rd,Nd,Ld,Md,Od,qr,Bd,il,Id,Fd,Ud,Hd,_d,Gd,Xd,Fn,void 0,void 0,Wd,ia,zd,Yd,kd,Vd,Qd,void 0,void 0,void 0,Un,qd,Kd,void 0,Ji.bind(void 0,0),Ji.bind(void 0,1),nl.bind(void 0,Zs),nl.bind(void 0,_s),ol.bind(void 0,0),ol.bind(void 0,1),xi.bind(void 0,0),xi.bind(void 0,1),al.bind(void 0,0),al.bind(void 0,1),Jd,$d,hl.bind(void 0,0),hl.bind(void 0,1),na,Zd,oa.bind(void 0,0),oa.bind(void 0,1),jd,tf,ef,sf,rf,nf,ll.bind(void 0,0),ll.bind(void 0,1),void 0,cl.bind(void 0,0),cl.bind(void 0,1),aa,void 0,ul,void 0,void 0,of,ha,af,hf,la,dl,lf,cf,uf,df,ff,gf,pf,bi.bind(void 0,1),mf,yf,Af,vf,Le,Gs,Sf,wf,$i,xf,Hn.bind(void 0,0),Hn.bind(void 0,1),Hn.bind(void 0,2),Hn.bind(void 0,3),void 0,void 0,void 0,void 0,bf,bi.bind(void 0,2),bi.bind(void 0,3),ca.bind(void 0,1),ca.bind(void 0,2),ca.bind(void 0,3),Pf,Ef,void 0,void 0,Df,void 0,Cf,Tf,ia,ia,void 0,void 0,void 0,void 0,void 0,Zi,fl.bind(void 0,0),fl.bind(void 0,1),Rf,void 0,Nf,Lf,ua,_n,Mf,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,void 0,br.bind(void 0,1),br.bind(void 0,2),br.bind(void 0,3),br.bind(void 0,4),br.bind(void 0,5),br.bind(void 0,6),br.bind(void 0,7),br.bind(void 0,8),Pr.bind(void 0,1),Pr.bind(void 0,2),Pr.bind(void 0,3),Pr.bind(void 0,4),Pr.bind(void 0,5),Pr.bind(void 0,6),Pr.bind(void 0,7),Pr.bind(void 0,8),Pt.bind(void 0,0,0,0,0,0),Pt.bind(void 0,0,0,0,0,1),Pt.bind(void 0,0,0,0,0,2),Pt.bind(void 0,0,0,0,0,3),Pt.bind(void 0,0,0,0,1,0),Pt.bind(void 0,0,0,0,1,1),Pt.bind(void 0,0,0,0,1,2),Pt.bind(void 0,0,0,0,1,3),Pt.bind(void 0,0,0,1,0,0),Pt.bind(void 0,0,0,1,0,1),Pt.bind(void 0,0,0,1,0,2),Pt.bind(void 0,0,0,1,0,3),Pt.bind(void 0,0,0,1,1,0),Pt.bind(void 0,0,0,1,1,1),Pt.bind(void 0,0,0,1,1,2),Pt.bind(void 0,0,0,1,1,3),Pt.bind(void 0,0,1,0,0,0),Pt.bind(void 0,0,1,0,0,1),Pt.bind(void 0,0,1,0,0,2),Pt.bind(void 0,0,1,0,0,3),Pt.bind(void 0,0,1,0,1,0),Pt.bind(void 0,0,1,0,1,1),Pt.bind(void 0,0,1,0,1,2),Pt.bind(void 0,0,1,0,1,3),Pt.bind(void 0,0,1,1,0,0),Pt.bind(void 0,0,1,1,0,1),Pt.bind(void 0,0,1,1,0,2),Pt.bind(void 0,0,1,1,0,3),Pt.bind(void 0,0,1,1,1,0),Pt.bind(void 0,0,1,1,1,1),Pt.bind(void 0,0,1,1,1,2),Pt.bind(void 0,0,1,1,1,3),Pt.bind(void 0,1,0,0,0,0),Pt.bind(void 0,1,0,0,0,1),Pt.bind(void 0,1,0,0,0,2),Pt.bind(void 0,1,0,0,0,3),Pt.bind(void 0,1,0,0,1,0),Pt.bind(void 0,1,0,0,1,1),Pt.bind(void 0,1,0,0,1,2),Pt.bind(void 0,1,0,0,1,3),Pt.bind(void 0,1,0,1,0,0),Pt.bind(void 0,1,0,1,0,1),Pt.bind(void 0,1,0,1,0,2),Pt.bind(void 0,1,0,1,0,3),Pt.bind(void 0,1,0,1,1,0),Pt.bind(void 0,1,0,1,1,1),Pt.bind(void 0,1,0,1,1,2),Pt.bind(void 0,1,0,1,1,3),Pt.bind(void 0,1,1,0,0,0),Pt.bind(void 0,1,1,0,0,1),Pt.bind(void 0,1,1,0,0,2),Pt.bind(void 0,1,1,0,0,3),Pt.bind(void 0,1,1,0,1,0),Pt.bind(void 0,1,1,0,1,1),Pt.bind(void 0,1,1,0,1,2),Pt.bind(void 0,1,1,0,1,3),Pt.bind(void 0,1,1,1,0,0),Pt.bind(void 0,1,1,1,0,1),Pt.bind(void 0,1,1,1,0,2),Pt.bind(void 0,1,1,1,0,3),Pt.bind(void 0,1,1,1,1,0),Pt.bind(void 0,1,1,1,1,1),Pt.bind(void 0,1,1,1,1,2),Pt.bind(void 0,1,1,1,1,3)];function Vr(n){this.char=n,this.state={},this.activeState=null}function da(n,o,h){this.contextName=h,this.startIndex=n,this.endOffset=o}function Of(n,o,h){this.contextName=n,this.openRange=null,this.ranges=[],this.checkStart=o,this.checkEnd=h}function hs(n,o){this.context=n,this.index=o,this.length=n.length,this.current=n[o],this.backtrack=n.slice(0,o),this.lookahead=n.slice(o+1)}function Gn(n){this.eventId=n,this.subscribers=[]}function Bf(n){var o=this,h=["start","end","next","newToken","contextStart","contextEnd","insertToken","removeToken","removeRange","replaceToken","replaceRange","composeRUD","updateContextsRanges"];h.forEach(function(u){Object.defineProperty(o.events,u,{value:new Gn(u)})}),n&&h.forEach(function(u){var g=n[u];typeof g=="function"&&o.events[u].subscribe(g)});var c=["insertToken","removeToken","removeRange","replaceToken","replaceRange","composeRUD"];c.forEach(function(u){o.events[u].subscribe(o.updateContextsRanges)})}function me(n){this.tokens=[],this.registeredContexts={},this.contextCheckers=[],this.events={},this.registeredModifiers=[],Bf.call(this,n)}Vr.prototype.setState=function(n,o){return this.state[n]=o,this.activeState={key:n,value:this.state[n]},this.activeState},Vr.prototype.getState=function(n){return this.state[n]||null},me.prototype.inboundIndex=function(n){return n>=0&&n<this.tokens.length},me.prototype.composeRUD=function(n){var o=this,h=!0,c=n.map(function(g){return o[g[0]].apply(o,g.slice(1).concat(h))}),u=function(g){return typeof g=="object"&&g.hasOwnProperty("FAIL")};if(c.every(u))return{FAIL:"composeRUD: one or more operations hasn't completed successfully",report:c.filter(u)};this.dispatch("composeRUD",[c.filter(function(g){return!u(g)})])},me.prototype.replaceRange=function(n,o,h,c){o=o!==null?o:this.tokens.length;var u=h.every(function(p){return p instanceof Vr});if(!isNaN(n)&&this.inboundIndex(n)&&u){var g=this.tokens.splice.apply(this.tokens,[n,o].concat(h));return c||this.dispatch("replaceToken",[n,o,h]),[g,h]}else return{FAIL:"replaceRange: invalid tokens or startIndex."}},me.prototype.replaceToken=function(n,o,h){if(!isNaN(n)&&this.inboundIndex(n)&&o instanceof Vr){var c=this.tokens.splice(n,1,o);return h||this.dispatch("replaceToken",[n,o]),[c[0],o]}else return{FAIL:"replaceToken: invalid token or index."}},me.prototype.removeRange=function(n,o,h){o=isNaN(o)?this.tokens.length:o;var c=this.tokens.splice(n,o);return h||this.dispatch("removeRange",[c,n,o]),c},me.prototype.removeToken=function(n,o){if(!isNaN(n)&&this.inboundIndex(n)){var h=this.tokens.splice(n,1);return o||this.dispatch("removeToken",[h,n]),h}else return{FAIL:"removeToken: invalid token index."}},me.prototype.insertToken=function(n,o,h){var c=n.every(function(u){return u instanceof Vr});return c?(this.tokens.splice.apply(this.tokens,[o,0].concat(n)),h||this.dispatch("insertToken",[n,o]),n):{FAIL:"insertToken: invalid token(s)."}},me.prototype.registerModifier=function(n,o,h){this.events.newToken.subscribe(function(c,u){var g=[c,u],p=o===null||o.apply(this,g)===!0,A=[c,u];if(p){var y=h.apply(this,A);c.setState(n,y)}}),this.registeredModifiers.push(n)},Gn.prototype.subscribe=function(n){return typeof n=="function"?this.subscribers.push(n)-1:{FAIL:"invalid '"+this.eventId+"' event handler"}},Gn.prototype.unsubscribe=function(n){this.subscribers.splice(n,1)},hs.prototype.setCurrentIndex=function(n){this.index=n,this.current=this.context[n],this.backtrack=this.context.slice(0,n),this.lookahead=this.context.slice(n+1)},hs.prototype.get=function(n){switch(!0){case n===0:return this.current;case(n<0&&Math.abs(n)<=this.backtrack.length):return this.backtrack.slice(n)[0];case(n>0&&n<=this.lookahead.length):return this.lookahead[n-1];default:return null}},me.prototype.rangeToText=function(n){if(n instanceof da)return this.getRangeTokens(n).map(function(o){return o.char}).join("")},me.prototype.getText=function(){return this.tokens.map(function(n){return n.char}).join("")},me.prototype.getContext=function(n){var o=this.registeredContexts[n];return o||null},me.prototype.on=function(n,o){var h=this.events[n];return h?h.subscribe(o):null},me.prototype.dispatch=function(n,o){var h=this,c=this.events[n];c instanceof Gn&&c.subscribers.forEach(function(u){u.apply(h,o||[])})},me.prototype.registerContextChecker=function(n,o,h){if(this.getContext(n))return{FAIL:"context name '"+n+"' is already registered."};if(typeof o!="function")return{FAIL:"missing context start check."};if(typeof h!="function")return{FAIL:"missing context end check."};var c=new Of(n,o,h);return this.registeredContexts[n]=c,this.contextCheckers.push(c),c},me.prototype.getRangeTokens=function(n){var o=n.startIndex+n.endOffset;return[].concat(this.tokens.slice(n.startIndex,o))},me.prototype.getContextRanges=function(n){var o=this.getContext(n);return o?o.ranges:{FAIL:"context checker '"+n+"' is not registered."}},me.prototype.resetContextsRanges=function(){var n=this.registeredContexts;for(var o in n)if(n.hasOwnProperty(o)){var h=n[o];h.ranges=[]}},me.prototype.updateContextsRanges=function(){this.resetContextsRanges();for(var n=this.tokens.map(function(c){return c.char}),o=0;o<n.length;o++){var h=new hs(n,o);this.runContextCheck(h)}this.dispatch("updateContextsRanges",[this.registeredContexts])},me.prototype.setEndOffset=function(n,o){var h=this.getContext(o).openRange.startIndex,c=new da(h,n,o),u=this.getContext(o).ranges;return c.rangeId=o+"."+u.length,u.push(c),this.getContext(o).openRange=null,c},me.prototype.runContextCheck=function(n){var o=this,h=n.index;this.contextCheckers.forEach(function(c){var u=c.contextName,g=o.getContext(u).openRange;if(!g&&c.checkStart(n)&&(g=new da(h,null,u),o.getContext(u).openRange=g,o.dispatch("contextStart",[u,h])),g&&c.checkEnd(n)){var p=h-g.startIndex+1,A=o.setEndOffset(p,u);o.dispatch("contextEnd",[u,A])}})},me.prototype.tokenize=function(n){this.tokens=[],this.resetContextsRanges();var o=Array.from(n);this.dispatch("start");for(var h=0;h<o.length;h++){var c=o[h],u=new hs(o,h);this.dispatch("next",[u]),this.runContextCheck(u);var g=new Vr(c);this.tokens.push(g),this.dispatch("newToken",[g,u])}return this.dispatch("end",[this.tokens]),this.tokens};function Er(n){return/[\u0600-\u065F\u066A-\u06D2\u06FA-\u06FF]/.test(n)}function gl(n){return/[\u0630\u0690\u0621\u0631\u0661\u0671\u0622\u0632\u0672\u0692\u06C2\u0623\u0673\u0693\u06C3\u0624\u0694\u06C4\u0625\u0675\u0695\u06C5\u06E5\u0676\u0696\u06C6\u0627\u0677\u0697\u06C7\u0648\u0688\u0698\u06C8\u0689\u0699\u06C9\u068A\u06CA\u066B\u068B\u06CB\u068C\u068D\u06CD\u06FD\u068E\u06EE\u06FE\u062F\u068F\u06CF\u06EF]/.test(n)}function Dr(n){return/[\u0600-\u0605\u060C-\u060E\u0610-\u061B\u061E\u064B-\u065F\u0670\u06D6-\u06DC\u06DF-\u06E4\u06E7\u06E8\u06EA-\u06ED]/.test(n)}function Xn(n){return/[A-z]/.test(n)}function pl(n){return/\s/.test(n)}function ls(n){this.font=n,this.features={}}function Qr(n){this.id=n.id,this.tag=n.tag,this.substitution=n.substitution}function ji(n,o){if(!n)return-1;switch(o.format){case 1:return o.glyphs.indexOf(n);case 2:for(var h=o.ranges,c=0;c<h.length;c++){var u=h[c];if(n>=u.start&&n<=u.end){var g=n-u.start;return u.index+g}}break;default:return-1}return-1}function If(n,o){var h=ji(n,o.coverage);return h===-1?null:n+o.deltaGlyphId}function tn(n,o){var h=ji(n,o.coverage);return h===-1?null:o.substitute[h]}function Cr(n,o){for(var h=[],c=0;c<n.length;c++){var u=n[c],g=o.current;g=Array.isArray(g)?g[0]:g;var p=ji(g,u);p!==-1&&h.push(p)}return h.length!==n.length?-1:h}function Ff(n,o){var h=o.inputCoverage.length+o.lookaheadCoverage.length+o.backtrackCoverage.length;if(n.context.length<h)return[];var c=Cr(o.inputCoverage,n);if(c===-1)return[];var u=o.inputCoverage.length-1;if(n.lookahead.length<o.lookaheadCoverage.length)return[];for(var g=n.lookahead.slice(u);g.length&&Dr(g[0].char);)g.shift();var p=new hs(g,0),A=Cr(o.lookaheadCoverage,p),y=[].concat(n.backtrack);for(y.reverse();y.length&&Dr(y[0].char);)y.shift();if(y.length<o.backtrackCoverage.length)return[];var P=new hs(y,0),E=Cr(o.backtrackCoverage,P),O=c.length===o.inputCoverage.length&&A.length===o.lookaheadCoverage.length&&E.length===o.backtrackCoverage.length,C=[];if(O)for(var B=0;B<o.lookupRecords.length;B++)for(var Z=o.lookupRecords[B],mt=Z.lookupListIndex,ht=this.getLookupByIndex(mt),ft=0;ft<ht.subtables.length;ft++){var _t=ht.subtables[ft],wt=this.getLookupMethod(ht,_t),ee=this.getSubstitutionType(ht,_t);if(ee==="12")for(var Xt=0;Xt<c.length;Xt++){var ve=n.get(Xt),Wt=wt(ve);Wt&&C.push(Wt)}}return C}function Uf(n,o){var h=n.current,c=ji(h,o.coverage);if(c===-1)return null;for(var u,g=o.ligatureSets[c],p=0;p<g.length;p++){u=g[p];for(var A=0;A<u.components.length;A++){var y=n.lookahead[A],P=u.components[A];if(y!==P)break;if(A===u.components.length-1)return u}}return null}function Wn(n,o){var h=ji(n,o.coverage);return h===-1?null:o.sequences[h]}ls.prototype.getDefaultScriptFeaturesIndexes=function(){for(var n=this.font.tables.gsub.scripts,o=0;o<n.length;o++){var h=n[o];if(h.tag==="DFLT")return h.script.defaultLangSys.featureIndexes}return[]},ls.prototype.getScriptFeaturesIndexes=function(n){var o=this.font.tables;if(!o.gsub)return[];if(!n)return this.getDefaultScriptFeaturesIndexes();for(var h=this.font.tables.gsub.scripts,c=0;c<h.length;c++){var u=h[c];if(u.tag===n&&u.script.defaultLangSys)return u.script.defaultLangSys.featureIndexes;var g=u.langSysRecords;if(g)for(var p=0;p<g.length;p++){var A=g[p];if(A.tag===n){var y=A.langSys;return y.featureIndexes}}}return this.getDefaultScriptFeaturesIndexes()},ls.prototype.mapTagsToFeatures=function(n,o){for(var h={},c=0;c<n.length;c++){var u=n[c].tag,g=n[c].feature;h[u]=g}this.features[o].tags=h},ls.prototype.getScriptFeatures=function(n){var o=this.features[n];if(this.features.hasOwnProperty(n))return o;var h=this.getScriptFeaturesIndexes(n);if(!h)return null;var c=this.font.tables.gsub;return o=h.map(function(u){return c.features[u]}),this.features[n]=o,this.mapTagsToFeatures(o,n),o},ls.prototype.getSubstitutionType=function(n,o){var h=n.lookupType.toString(),c=o.substFormat.toString();return h+c},ls.prototype.getLookupMethod=function(n,o){var h=this,c=this.getSubstitutionType(n,o);switch(c){case"11":return function(u){return If.apply(h,[u,o])};case"12":return function(u){return tn.apply(h,[u,o])};case"63":return function(u){return Ff.apply(h,[u,o])};case"41":return function(u){return Uf.apply(h,[u,o])};case"21":return function(u){return Wn.apply(h,[u,o])};default:throw new Error("lookupType: "+n.lookupType+" - substFormat: "+o.substFormat+" is not yet supported")}},ls.prototype.lookupFeature=function(n){var o=n.contextParams,h=o.index,c=this.getFeature({tag:n.tag,script:n.script});if(!c)return new Error("font '"+this.font.names.fullName.en+"' doesn't support feature '"+n.tag+"' for script '"+n.script+"'.");for(var u=this.getFeatureLookups(c),g=[].concat(o.context),p=0;p<u.length;p++)for(var A=u[p],y=this.getLookupSubtables(A),P=0;P<y.length;P++){var E=y[P],O=this.getSubstitutionType(A,E),C=this.getLookupMethod(A,E),B=void 0;switch(O){case"11":B=C(o.current),B&&g.splice(h,1,new Qr({id:11,tag:n.tag,substitution:B}));break;case"12":B=C(o.current),B&&g.splice(h,1,new Qr({id:12,tag:n.tag,substitution:B}));break;case"63":B=C(o),Array.isArray(B)&&B.length&&g.splice(h,1,new Qr({id:63,tag:n.tag,substitution:B}));break;case"41":B=C(o),B&&g.splice(h,1,new Qr({id:41,tag:n.tag,substitution:B}));break;case"21":B=C(o.current),B&&g.splice(h,1,new Qr({id:21,tag:n.tag,substitution:B}));break}o=new hs(g,h),!(Array.isArray(B)&&!B.length)&&(B=null)}return g.length?g:null},ls.prototype.supports=function(n){if(!n.script)return!1;this.getScriptFeatures(n.script);var o=this.features.hasOwnProperty(n.script);if(!n.tag)return o;var h=this.features[n.script].some(function(c){return c.tag===n.tag});return o&&h},ls.prototype.getLookupSubtables=function(n){return n.subtables||null},ls.prototype.getLookupByIndex=function(n){var o=this.font.tables.gsub.lookups;return o[n]||null},ls.prototype.getFeatureLookups=function(n){return n.lookupListIndexes.map(this.getLookupByIndex.bind(this))},ls.prototype.getFeature=function(o){if(!this.font)return{FAIL:"No font was found"};this.features.hasOwnProperty(o.script)||this.getScriptFeatures(o.script);var h=this.features[o.script];return h?h.tags[o.tag]?this.features[o.script].tags[o.tag]:null:{FAIL:"No feature for script "+o.script}};function Tr(n){var o=n.current,h=n.get(-1);return h===null&&Er(o)||!Er(h)&&Er(o)}function Hf(n){var o=n.get(1);return o===null||!Er(o)}var _f={startCheck:Tr,endCheck:Hf};function fa(n){var o=n.current,h=n.get(-1);return(Er(o)||Dr(o))&&!Er(h)}function Gf(n){var o=n.get(1);switch(!0){case o===null:return!0;case(!Er(o)&&!Dr(o)):var h=pl(o);if(!h)return!0;if(h){var c=!1;if(c=n.lookahead.some(function(u){return Er(u)||Dr(u)}),!c)return!0}break;default:return!1}}var Xf={startCheck:fa,endCheck:Gf};function Wf(n,o,h){o[h].setState(n.tag,n.substitution)}function zf(n,o,h){o[h].setState(n.tag,n.substitution)}function Yf(n,o,h){n.substitution.forEach(function(c,u){var g=o[h+u];g.setState(n.tag,c)})}function Rr(n,o,h){var c=o[h];c.setState(n.tag,n.substitution.ligGlyph);for(var u=n.substitution.components.length,g=0;g<u;g++)c=o[h+g+1],c.setState("deleted",!0)}var ml={11:Wf,12:zf,63:Yf,41:Rr};function ga(n,o,h){n instanceof Qr&&ml[n.id]&&ml[n.id](n,o,h)}function yl(n){for(var o=[].concat(n.backtrack),h=o.length-1;h>=0;h--){var c=o[h],u=gl(c),g=Dr(c);if(!u&&!g)return!0;if(u)return!1}return!1}function kf(n){if(gl(n.current))return!1;for(var o=0;o<n.lookahead.length;o++){var h=n.lookahead[o],c=Dr(h);if(!c)return!0}return!1}function Al(n){var o=this,h="arab",c=this.featuresTags[h],u=this.tokenizer.getRangeTokens(n);if(u.length!==1){var g=new hs(u.map(function(A){return A.getState("glyphIndex")}),0),p=new hs(u.map(function(A){return A.char}),0);u.forEach(function(A,y){if(!Dr(A.char)){g.setCurrentIndex(y),p.setCurrentIndex(y);var P=0;yl(p)&&(P|=1),kf(p)&&(P|=2);var E;switch(P){case 1:E="fina";break;case 2:E="init";break;case 3:E="medi";break}if(c.indexOf(E)!==-1){var O=o.query.lookupFeature({tag:E,script:h,contextParams:g});if(O instanceof Error)return console.info(O.message);O.forEach(function(C,B){C instanceof Qr&&(ga(C,u,B),g.context[B]=C.substitution)})}}})}}function vl(n,o){var h=n.map(function(c){return c.activeState.value});return new hs(h,o||0)}function qf(n){var o=this,h="arab",c=this.tokenizer.getRangeTokens(n),u=vl(c);u.context.forEach(function(g,p){u.setCurrentIndex(p);var A=o.query.lookupFeature({tag:"rlig",script:h,contextParams:u});A.length&&(A.forEach(function(y){return ga(y,c,p)}),u=vl(c))})}function Vf(n){var o=n.current,h=n.get(-1);return h===null&&Xn(o)||!Xn(h)&&Xn(o)}function Qf(n){var o=n.get(1);return o===null||!Xn(o)}var Kf={startCheck:Vf,endCheck:Qf};function Sl(n,o){var h=n.map(function(c){return c.activeState.value});return new hs(h,o||0)}function Jf(n){var o=this,h="latn",c=this.tokenizer.getRangeTokens(n),u=Sl(c);u.context.forEach(function(g,p){u.setCurrentIndex(p);var A=o.query.lookupFeature({tag:"liga",script:h,contextParams:u});A.length&&(A.forEach(function(y){return ga(y,c,p)}),u=Sl(c))})}function Rs(n){this.baseDir=n||"ltr",this.tokenizer=new me,this.featuresTags={}}Rs.prototype.setText=function(n){this.text=n},Rs.prototype.contextChecks={latinWordCheck:Kf,arabicWordCheck:_f,arabicSentenceCheck:Xf};function pa(n){var o=this.contextChecks[n+"Check"];return this.tokenizer.registerContextChecker(n,o.startCheck,o.endCheck)}function Nr(){return pa.call(this,"latinWord"),pa.call(this,"arabicWord"),pa.call(this,"arabicSentence"),this.tokenizer.tokenize(this.text)}function $f(){var n=this,o=this.tokenizer.getContextRanges("arabicSentence");o.forEach(function(h){var c=n.tokenizer.getRangeTokens(h);n.tokenizer.replaceRange(h.startIndex,h.endOffset,c.reverse())})}Rs.prototype.registerFeatures=function(n,o){var h=this,c=o.filter(function(u){return h.query.supports({script:n,tag:u})});this.featuresTags.hasOwnProperty(n)?this.featuresTags[n]=this.featuresTags[n].concat(c):this.featuresTags[n]=c},Rs.prototype.applyFeatures=function(n,o){if(!n)throw new Error("No valid font was provided to apply features");this.query||(this.query=new ls(n));for(var h=0;h<o.length;h++){var c=o[h];this.query.supports({script:c.script})&&this.registerFeatures(c.script,c.tags)}},Rs.prototype.registerModifier=function(n,o,h){this.tokenizer.registerModifier(n,o,h)};function ma(){if(this.tokenizer.registeredModifiers.indexOf("glyphIndex")===-1)throw new Error("glyphIndex modifier is required to apply arabic presentation features.")}function ya(){var n=this,o="arab";if(this.featuresTags.hasOwnProperty(o)){ma.call(this);var h=this.tokenizer.getContextRanges("arabicWord");h.forEach(function(c){Al.call(n,c)})}}function wl(){var n=this,o="arab";if(this.featuresTags.hasOwnProperty(o)){var h=this.featuresTags[o];if(h.indexOf("rlig")!==-1){ma.call(this);var c=this.tokenizer.getContextRanges("arabicWord");c.forEach(function(u){qf.call(n,u)})}}}function Zf(){var n=this,o="latn";if(this.featuresTags.hasOwnProperty(o)){var h=this.featuresTags[o];if(h.indexOf("liga")!==-1){ma.call(this);var c=this.tokenizer.getContextRanges("latinWord");c.forEach(function(u){Jf.call(n,u)})}}}Rs.prototype.checkContextReady=function(n){return!!this.tokenizer.getContext(n)},Rs.prototype.applyFeaturesToContexts=function(){this.checkContextReady("arabicWord")&&(ya.call(this),wl.call(this)),this.checkContextReady("latinWord")&&Zf.call(this),this.checkContextReady("arabicSentence")&&$f.call(this)},Rs.prototype.processText=function(n){(!this.text||this.text!==n)&&(this.setText(n),Nr.call(this),this.applyFeaturesToContexts())},Rs.prototype.getBidiText=function(n){return this.processText(n),this.tokenizer.getText()},Rs.prototype.getTextGlyphs=function(n){this.processText(n);for(var o=[],h=0;h<this.tokenizer.tokens.length;h++){var c=this.tokenizer.tokens[h];if(!c.state.deleted){var u=c.activeState.value;o.push(Array.isArray(u)?u[0]:u)}}return o};function ce(n){n=n||{},n.tables=n.tables||{},n.empty||(Js(n.familyName,"When creating a new Font object, familyName is required."),Js(n.styleName,"When creating a new Font object, styleName is required."),Js(n.unitsPerEm,"When creating a new Font object, unitsPerEm is required."),Js(n.ascender,"When creating a new Font object, ascender is required."),Js(n.descender<=0,"When creating a new Font object, negative descender value is required."),this.names={fontFamily:{en:n.familyName||" "},fontSubfamily:{en:n.styleName||" "},fullName:{en:n.fullName||n.familyName+" "+n.styleName},postScriptName:{en:n.postScriptName||(n.familyName+n.styleName).replace(/\s/g,"")},designer:{en:n.designer||" "},designerURL:{en:n.designerURL||" "},manufacturer:{en:n.manufacturer||" "},manufacturerURL:{en:n.manufacturerURL||" "},license:{en:n.license||" "},licenseURL:{en:n.licenseURL||" "},version:{en:n.version||"Version 0.1"},description:{en:n.description||" "},copyright:{en:n.copyright||" "},trademark:{en:n.trademark||" "}},this.unitsPerEm=n.unitsPerEm||1e3,this.ascender=n.ascender,this.descender=n.descender,this.createdTimestamp=n.createdTimestamp,this.tables=Object.assign(n.tables,{os2:Object.assign({usWeightClass:n.weightClass||this.usWeightClasses.MEDIUM,usWidthClass:n.widthClass||this.usWidthClasses.MEDIUM,fsSelection:n.fsSelection||this.fsSelectionValues.REGULAR},n.tables.os2)})),this.supported=!0,this.glyphs=new N.GlyphSet(this,n.glyphs||[]),this.encoding=new ks(this),this.position=new Ts(this),this.substitution=new os(this),this.tables=this.tables||{},this._push=null,this._hmtxTableData={},Object.defineProperty(this,"hinting",{get:function(){if(this._hinting)return this._hinting;if(this.outlinesFormat==="truetype")return this._hinting=new On(this)}})}ce.prototype.hasChar=function(n){return this.encoding.charToGlyphIndex(n)!==null},ce.prototype.charToGlyphIndex=function(n){return this.encoding.charToGlyphIndex(n)},ce.prototype.charToGlyph=function(n){var o=this.charToGlyphIndex(n),h=this.glyphs.get(o);return h||(h=this.glyphs.get(0)),h},ce.prototype.updateFeatures=function(n){return this.defaultRenderOptions.features.map(function(o){return o.script==="latn"?{script:"latn",tags:o.tags.filter(function(h){return n[h]})}:o})},ce.prototype.stringToGlyphs=function(n,o){var h=this,c=new Rs,u=function(O){return h.charToGlyphIndex(O.char)};c.registerModifier("glyphIndex",null,u);var g=o?this.updateFeatures(o.features):this.defaultRenderOptions.features;c.applyFeatures(this,g);for(var p=c.getTextGlyphs(n),A=p.length,y=new Array(A),P=this.glyphs.get(0),E=0;E<A;E+=1)y[E]=this.glyphs.get(p[E])||P;return y},ce.prototype.nameToGlyphIndex=function(n){return this.glyphNames.nameToGlyphIndex(n)},ce.prototype.nameToGlyph=function(n){var o=this.nameToGlyphIndex(n),h=this.glyphs.get(o);return h||(h=this.glyphs.get(0)),h},ce.prototype.glyphIndexToName=function(n){return this.glyphNames.glyphIndexToName?this.glyphNames.glyphIndexToName(n):""},ce.prototype.getKerningValue=function(n,o){n=n.index||n,o=o.index||o;var h=this.position.defaultKerningTables;return h?this.position.getKerningValue(h,n,o):this.kerningPairs[n+","+o]||0},ce.prototype.defaultRenderOptions={kerning:!0,features:[{script:"arab",tags:["init","medi","fina","rlig"]},{script:"latn",tags:["liga","rlig"]}]},ce.prototype.forEachGlyph=function(n,o,h,c,u,g){o=o!==void 0?o:0,h=h!==void 0?h:0,c=c!==void 0?c:72,u=Object.assign({},this.defaultRenderOptions,u);var p=1/this.unitsPerEm*c,A=this.stringToGlyphs(n,u),y;if(u.kerning){var P=u.script||this.position.getDefaultScriptName();y=this.position.getKerningTables(P,u.language)}for(var E=0;E<A.length;E+=1){var O=A[E];if(g.call(this,O,o,h,c,u),O.advanceWidth&&(o+=O.advanceWidth*p),u.kerning&&E<A.length-1){var C=y?this.position.getKerningValue(y,O.index,A[E+1].index):this.getKerningValue(O,A[E+1]);o+=C*p}u.letterSpacing?o+=u.letterSpacing*c:u.tracking&&(o+=u.tracking/1e3*c)}return o},ce.prototype.getPath=function(n,o,h,c,u){var g=new $t;return this.forEachGlyph(n,o,h,c,u,function(p,A,y,P){var E=p.getPath(A,y,P,u,this);g.extend(E)}),g},ce.prototype.getPaths=function(n,o,h,c,u){var g=[];return this.forEachGlyph(n,o,h,c,u,function(p,A,y,P){var E=p.getPath(A,y,P,u,this);g.push(E)}),g},ce.prototype.getAdvanceWidth=function(n,o,h){return this.forEachGlyph(n,0,0,o,h,function(){})},ce.prototype.draw=function(n,o,h,c,u,g){this.getPath(o,h,c,u,g).draw(n)},ce.prototype.drawPoints=function(n,o,h,c,u,g){this.forEachGlyph(o,h,c,u,g,function(p,A,y,P){p.drawPoints(n,A,y,P)})},ce.prototype.drawMetrics=function(n,o,h,c,u,g){this.forEachGlyph(o,h,c,u,g,function(p,A,y,P){p.drawMetrics(n,A,y,P)})},ce.prototype.getEnglishName=function(n){var o=this.names[n];if(o)return o.en},ce.prototype.validate=function(){var n=this;function o(c,u){}function h(c){var u=n.getEnglishName(c);u&&u.trim().length>0}h("fontFamily"),h("weightName"),h("manufacturer"),h("copyright"),h("version"),this.unitsPerEm>0},ce.prototype.toTables=function(){return Ad.fontToTable(this)},ce.prototype.toBuffer=function(){return console.warn("Font.toBuffer is deprecated. Use Font.toArrayBuffer instead."),this.toArrayBuffer()},ce.prototype.toArrayBuffer=function(){for(var n=this.toTables(),o=n.encode(),h=new ArrayBuffer(o.length),c=new Uint8Array(h),u=0;u<o.length;u++)c[u]=o[u];return h},ce.prototype.download=function(n){var o=this.getEnglishName("fontFamily"),h=this.getEnglishName("fontSubfamily");n=n||o.replace(/\s/g,"")+"-"+h+".otf";var c=this.toArrayBuffer();if(Sd())if(window.URL=window.URL||window.webkitURL,window.URL){var u=new DataView(c),g=new Blob([u],{type:"font/opentype"}),p=document.createElement("a");p.href=window.URL.createObjectURL(g),p.download=n;var A=document.createEvent("MouseEvents");A.initEvent("click",!0,!1),p.dispatchEvent(A)}else console.warn("Font file could not be downloaded. Try using a different browser.");else{var y=b(339644),P=wd(c);y.writeFileSync(n,P)}},ce.prototype.fsSelectionValues={ITALIC:1,UNDERSCORE:2,NEGATIVE:4,OUTLINED:8,STRIKEOUT:16,BOLD:32,REGULAR:64,USER_TYPO_METRICS:128,WWS:256,OBLIQUE:512},ce.prototype.usWidthClasses={ULTRA_CONDENSED:1,EXTRA_CONDENSED:2,CONDENSED:3,SEMI_CONDENSED:4,MEDIUM:5,SEMI_EXPANDED:6,EXPANDED:7,EXTRA_EXPANDED:8,ULTRA_EXPANDED:9},ce.prototype.usWeightClasses={THIN:100,EXTRA_LIGHT:200,LIGHT:300,NORMAL:400,MEDIUM:500,SEMI_BOLD:600,BOLD:700,EXTRA_BOLD:800,BLACK:900};function xl(n,o){var h=JSON.stringify(n),c=256;for(var u in o){var g=parseInt(u);if(!(!g||g<256)){if(JSON.stringify(o[u])===h)return g;c<=g&&(c=g+1)}}return o[c]=n,c}function jf(n,o,h){var c=xl(o.name,h);return[{name:"tag_"+n,type:"TAG",value:o.tag},{name:"minValue_"+n,type:"FIXED",value:o.minValue<<16},{name:"defaultValue_"+n,type:"FIXED",value:o.defaultValue<<16},{name:"maxValue_"+n,type:"FIXED",value:o.maxValue<<16},{name:"flags_"+n,type:"USHORT",value:0},{name:"nameID_"+n,type:"USHORT",value:c}]}function Pi(n,o,h){var c={},u=new St.Parser(n,o);return c.tag=u.parseTag(),c.minValue=u.parseFixed(),c.defaultValue=u.parseFixed(),c.maxValue=u.parseFixed(),u.skip("uShort",1),c.name=h[u.parseUShort()]||{},c}function tg(n,o,h,c){for(var u=xl(o.name,c),g=[{name:"nameID_"+n,type:"USHORT",value:u},{name:"flags_"+n,type:"USHORT",value:0}],p=0;p<h.length;++p){var A=h[p].tag;g.push({name:"axis_"+n+" "+A,type:"FIXED",value:o.coordinates[A]<<16})}return g}function eg(n,o,h,c){var u={},g=new St.Parser(n,o);u.name=c[g.parseUShort()]||{},g.skip("uShort",1),u.coordinates={};for(var p=0;p<h.length;++p)u.coordinates[h[p].tag]=g.parseFixed();return u}function sg(n,o){var h=new pt.Table("fvar",[{name:"version",type:"ULONG",value:65536},{name:"offsetToData",type:"USHORT",value:0},{name:"countSizePairs",type:"USHORT",value:2},{name:"axisCount",type:"USHORT",value:n.axes.length},{name:"axisSize",type:"USHORT",value:20},{name:"instanceCount",type:"USHORT",value:n.instances.length},{name:"instanceSize",type:"USHORT",value:4+n.axes.length*4}]);h.offsetToData=h.sizeOf();for(var c=0;c<n.axes.length;c++)h.fields=h.fields.concat(jf(c,n.axes[c],o));for(var u=0;u<n.instances.length;u++)h.fields=h.fields.concat(tg(u,n.instances[u],n.axes,o));return h}function rg(n,o,h){var c=new St.Parser(n,o),u=c.parseULong();bt.argument(u===65536,"Unsupported fvar table version.");var g=c.parseOffset16();c.skip("uShort",1);for(var p=c.parseUShort(),A=c.parseUShort(),y=c.parseUShort(),P=c.parseUShort(),E=[],O=0;O<p;O++)E.push(Pi(n,o+g+O*A,h));for(var C=[],B=o+g+p*A,Z=0;Z<y;Z++)C.push(eg(n,B+Z*P,E,h));return{axes:E,instances:C}}var zn={make:sg,parse:rg},ig=function(){return{coverage:this.parsePointer(F.coverage),attachPoints:this.parseList(F.pointer(F.uShortList))}},bl=function(){var n=this.parseUShort();if(bt.argument(n===1||n===2||n===3,"Unsupported CaretValue table version."),n===1)return{coordinate:this.parseShort()};if(n===2)return{pointindex:this.parseShort()};if(n===3)return{coordinate:this.parseShort()}},ng=function(){return this.parseList(F.pointer(bl))},og=function(){return{coverage:this.parsePointer(F.coverage),ligGlyphs:this.parseList(F.pointer(ng))}},ag=function(){return this.parseUShort(),this.parseList(F.pointer(F.coverage))};function Yn(n,o){o=o||0;var h=new F(n,o),c=h.parseVersion(1);bt.argument(c===1||c===1.2||c===1.3,"Unsupported GDEF table version.");var u={version:c,classDef:h.parsePointer(F.classDef),attachList:h.parsePointer(ig),ligCaretList:h.parsePointer(og),markAttachClassDef:h.parsePointer(F.classDef)};return c>=1.2&&(u.markGlyphSets=h.parsePointer(ag)),u}var hg={parse:Yn},Ns=new Array(10);Ns[1]=function(){var o=this.offset+this.relativeOffset,h=this.parseUShort();if(h===1)return{posFormat:1,coverage:this.parsePointer(F.coverage),value:this.parseValueRecord()};if(h===2)return{posFormat:2,coverage:this.parsePointer(F.coverage),values:this.parseValueRecordList()};bt.assert(!1,"0x"+o.toString(16)+": GPOS lookup type 1 format must be 1 or 2.")},Ns[2]=function(){var o=this.offset+this.relativeOffset,h=this.parseUShort();bt.assert(h===1||h===2,"0x"+o.toString(16)+": GPOS lookup type 2 format must be 1 or 2.");var c=this.parsePointer(F.coverage),u=this.parseUShort(),g=this.parseUShort();if(h===1)return{posFormat:h,coverage:c,valueFormat1:u,valueFormat2:g,pairSets:this.parseList(F.pointer(F.list(function(){return{secondGlyph:this.parseUShort(),value1:this.parseValueRecord(u),value2:this.parseValueRecord(g)}})))};if(h===2){var p=this.parsePointer(F.classDef),A=this.parsePointer(F.classDef),y=this.parseUShort(),P=this.parseUShort();return{posFormat:h,coverage:c,valueFormat1:u,valueFormat2:g,classDef1:p,classDef2:A,class1Count:y,class2Count:P,classRecords:this.parseList(y,F.list(P,function(){return{value1:this.parseValueRecord(u),value2:this.parseValueRecord(g)}}))}}},Ns[3]=function(){return{error:"GPOS Lookup 3 not supported"}},Ns[4]=function(){return{error:"GPOS Lookup 4 not supported"}},Ns[5]=function(){return{error:"GPOS Lookup 5 not supported"}},Ns[6]=function(){return{error:"GPOS Lookup 6 not supported"}},Ns[7]=function(){return{error:"GPOS Lookup 7 not supported"}},Ns[8]=function(){return{error:"GPOS Lookup 8 not supported"}},Ns[9]=function(){return{error:"GPOS Lookup 9 not supported"}};function lg(n,o){o=o||0;var h=new F(n,o),c=h.parseVersion(1);return bt.argument(c===1||c===1.1,"Unsupported GPOS table version "+c),c===1?{version:c,scripts:h.parseScriptList(),features:h.parseFeatureList(),lookups:h.parseLookupList(Ns)}:{version:c,scripts:h.parseScriptList(),features:h.parseFeatureList(),lookups:h.parseLookupList(Ns),variations:h.parseFeatureVariationsList()}}var cg=new Array(10);function ug(n){return new pt.Table("GPOS",[{name:"version",type:"ULONG",value:65536},{name:"scripts",type:"TABLE",value:new pt.ScriptList(n.scripts)},{name:"features",type:"TABLE",value:new pt.FeatureList(n.features)},{name:"lookups",type:"TABLE",value:new pt.LookupList(n.lookups,cg)}])}var dg={parse:lg,make:ug};function Kr(n){var o={};n.skip("uShort");var h=n.parseUShort();bt.argument(h===0,"Unsupported kern sub-table version."),n.skip("uShort",2);var c=n.parseUShort();n.skip("uShort",3);for(var u=0;u<c;u+=1){var g=n.parseUShort(),p=n.parseUShort(),A=n.parseShort();o[g+","+p]=A}return o}function fg(n){var o={};n.skip("uShort");var h=n.parseULong();h>1&&console.warn("Only the first kern subtable is supported."),n.skip("uLong");var c=n.parseUShort(),u=c&255;if(n.skip("uShort"),u===0){var g=n.parseUShort();n.skip("uShort",3);for(var p=0;p<g;p+=1){var A=n.parseUShort(),y=n.parseUShort(),P=n.parseShort();o[A+","+y]=P}}return o}function gg(n,o){var h=new St.Parser(n,o),c=h.parseUShort();if(c===0)return Kr(h);if(c===1)return fg(h);throw new Error("Unsupported kern table version ("+c+").")}var be={parse:gg};function pg(n,o,h,c){for(var u=new St.Parser(n,o),g=c?u.parseUShort:u.parseULong,p=[],A=0;A<h+1;A+=1){var y=g.call(u);c&&(y*=2),p.push(y)}return p}var mg={parse:pg};function Aa(n,o){var h=b(339644);h.readFile(n,function(c,u){if(c)return o(c.message);o(null,Vh(u))})}function yg(n,o){var h=new XMLHttpRequest;h.open("get",n,!0),h.responseType="arraybuffer",h.onload=function(){return h.response?o(null,h.response):o("Font could not be loaded: "+h.statusText)},h.onerror=function(){o("Font could not be loaded")},h.send()}function Pl(n,o){for(var h=[],c=12,u=0;u<o;u+=1){var g=St.getTag(n,c),p=St.getULong(n,c+4),A=St.getULong(n,c+8),y=St.getULong(n,c+12);h.push({tag:g,checksum:p,offset:A,length:y,compression:!1}),c+=16}return h}function Ag(n,o){for(var h=[],c=44,u=0;u<o;u+=1){var g=St.getTag(n,c),p=St.getULong(n,c+4),A=St.getULong(n,c+8),y=St.getULong(n,c+12),P=void 0;A<y?P="WOFF":P=!1,h.push({tag:g,offset:p,compression:P,compressedLength:A,length:y}),c+=20}return h}function Pe(n,o){if(o.compression==="WOFF"){var h=new Uint8Array(n.buffer,o.offset+2,o.compressedLength-2),c=new Uint8Array(o.length);if(_(h,c),c.byteLength!==o.length)throw new Error("Decompression error: "+o.tag+" decompressed length doesn't match recorded length");var u=new DataView(c.buffer,0);return{data:u,offset:0}}else return{data:n,offset:o.offset}}function Jr(n,o){o=o==null?{}:o;var h,c,u=new ce({empty:!0}),g=new DataView(n,0),p,A=[],y=St.getTag(g,0);if(y==="\0\0\0"||y==="true"||y==="typ1")u.outlinesFormat="truetype",p=St.getUShort(g,4),A=Pl(g,p);else if(y==="OTTO")u.outlinesFormat="cff",p=St.getUShort(g,4),A=Pl(g,p);else if(y==="wOFF"){var P=St.getTag(g,4);if(P==="\0\0\0")u.outlinesFormat="truetype";else if(P==="OTTO")u.outlinesFormat="cff";else throw new Error("Unsupported OpenType flavor "+y);p=St.getUShort(g,12),A=Ag(g,p)}else throw new Error("Unsupported OpenType signature "+y);for(var E,O,C,B,Z,mt,ht,ft,_t,wt,ee,Xt,ve=0;ve<p;ve+=1){var Wt=A[ve],Rt=void 0;switch(Wt.tag){case"cmap":Rt=Pe(g,Wt),u.tables.cmap=gr.parse(Rt.data,Rt.offset),u.encoding=new pr(u.tables.cmap);break;case"cvt ":Rt=Pe(g,Wt),Xt=new St.Parser(Rt.data,Rt.offset),u.tables.cvt=Xt.parseShortList(Wt.length/2);break;case"fvar":O=Wt;break;case"fpgm":Rt=Pe(g,Wt),Xt=new St.Parser(Rt.data,Rt.offset),u.tables.fpgm=Xt.parseByteList(Wt.length);break;case"head":Rt=Pe(g,Wt),u.tables.head=Mh.parse(Rt.data,Rt.offset),u.unitsPerEm=u.tables.head.unitsPerEm,h=u.tables.head.indexToLocFormat;break;case"hhea":Rt=Pe(g,Wt),u.tables.hhea=Oh.parse(Rt.data,Rt.offset),u.ascender=u.tables.hhea.ascender,u.descender=u.tables.hhea.descender,u.numberOfHMetrics=u.tables.hhea.numberOfHMetrics;break;case"hmtx":ht=Wt;break;case"ltag":Rt=Pe(g,Wt),c=Ds.parse(Rt.data,Rt.offset);break;case"maxp":Rt=Pe(g,Wt),u.tables.maxp=Bh.parse(Rt.data,Rt.offset),u.numGlyphs=u.tables.maxp.numGlyphs;break;case"name":wt=Wt;break;case"OS/2":Rt=Pe(g,Wt),u.tables.os2=Yi.parse(Rt.data,Rt.offset);break;case"post":Rt=Pe(g,Wt),u.tables.post=Qo.parse(Rt.data,Rt.offset),u.glyphNames=new zi(u.tables.post);break;case"prep":Rt=Pe(g,Wt),Xt=new St.Parser(Rt.data,Rt.offset),u.tables.prep=Xt.parseByteList(Wt.length);break;case"glyf":C=Wt;break;case"loca":_t=Wt;break;case"CFF ":E=Wt;break;case"kern":ft=Wt;break;case"GDEF":B=Wt;break;case"GPOS":Z=Wt;break;case"GSUB":mt=Wt;break;case"meta":ee=Wt;break}}var Me=Pe(g,wt);if(u.tables.name=Gh.parse(Me.data,Me.offset,c),u.names=u.tables.name,C&&_t){var Qe=h===0,Ze=Pe(g,_t),ps=mg.parse(Ze.data,Ze.offset,u.numGlyphs,Qe),ke=Pe(g,C);u.glyphs=Jh.parse(ke.data,ke.offset,ps,u,o)}else if(E){var Re=Pe(g,E);Lh.parse(Re.data,Re.offset,u,o)}else throw new Error("Font doesn't contain TrueType or CFF outlines.");var Be=Pe(g,ht);if(yi.parse(u,Be.data,Be.offset,u.numberOfHMetrics,u.numGlyphs,u.glyphs,o),Io(u,o),ft){var Ie=Pe(g,ft);u.kerningPairs=be.parse(Ie.data,Ie.offset)}else u.kerningPairs={};if(B){var _e=Pe(g,B);u.tables.gdef=hg.parse(_e.data,_e.offset)}if(Z){var Ge=Pe(g,Z);u.tables.gpos=dg.parse(Ge.data,Ge.offset),u.position.init()}if(mt){var Fe=Pe(g,mt);u.tables.gsub=Wh.parse(Fe.data,Fe.offset)}if(O){var qe=Pe(g,O);u.tables.fvar=zn.parse(qe.data,qe.offset,u.names)}if(ee){var Se=Pe(g,ee);u.tables.meta=zh.parse(Se.data,Se.offset),u.metas=u.tables.meta}return u}function vg(n,o,h){h=h==null?{}:h;var c=!1,u=c&&!h.isUrl?Aa:yg;return new Promise(function(g,p){u(n,function(A,y){if(A){if(o)return o(A);p(A)}var P;try{P=Jr(y,h)}catch(E){if(o)return o(E,null);p(E)}if(o)return o(null,P);g(P)})})}function El(n,o){var h=b(339644),c=h.readFileSync(n);return Jr(Vh(c),o)}var Ht=Object.freeze({__proto__:null,Font:ce,Glyph:q,Path:$t,BoundingBox:oe,_parse:St,parse:Jr,load:vg,loadSync:El});const st=Ht},896587:(ae,Et,b)=>{b.d(Et,{A:()=>X,N:()=>U});var V=(Tt=>(Tt[Tt.CONTENT=0]="CONTENT",Tt[Tt.MEASURES_HEADER=1]="MEASURES_HEADER",Tt[Tt.PARTS_HEADER=2]="PARTS_HEADER",Tt))(V||{});function U(){return[0,1,2]}const X=V},928816:(ae,Et,b)=>{b.d(Et,{A:()=>j});var V=b(390253),U=b(87053);const X=V.A.MM_PER_INCH/V.A.POINTS_BY_INCH;function Tt(vt,xt){const k=tt(vt.fontSize,xt);return{fontFamily:vt.fontFamily,fontSize:k,italic:vt.italic,bold:vt.bold}}function tt(vt,xt){return vt.unit===U.A.SPACE?vt.value:vt.value*X/xt}function j(vt,xt,k){const ct=vt.get(k);if(!ct)throw new Error(`Font options for text type "${k}" not found in the map.`);return Tt(ct,xt)}}}])});eW();})();


//# debugId=d4b53e08-eab2-5a75-bd4d-bcb9a3985996

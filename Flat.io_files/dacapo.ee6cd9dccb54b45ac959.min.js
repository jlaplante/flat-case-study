"use strict";
!function(){try{var e="undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:{},n=(new e.Error).stack;n&&(e._sentryDebugIds=e._sentryDebugIds||{},e._sentryDebugIds[n]="0344d81d-bb50-5b9f-81be-84b1c01c8bec")}catch(e){}}();
(()=>{/*! Copyright (c) 2025 Tutteo Ltd. */(self.webpackChunk_flat_flat=self.webpackChunk_flat_flat||[]).push([[21081],{426041:(Ut,Be,v)=>{v.d(Be,{Mw:()=>fe,UU:()=>x});const ie="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";function Z(q,le){const pe=ie.indexOf(q.charAt(q.length-1)),ot=ie.indexOf(q.charAt(q.length-1));let ne=Math.ceil(3*q.length/4);pe===64&&ne--,ot===64&&ne--;let Ee,je,He,at,Qe,V,Ye,ge,ye=0,Ie=0;for(le?Ee=new Uint8Array(le):Ee=new Uint8Array(ne),q=q.replace(/[^A-Za-z0-9+/=]/g,""),ye=0;ye<ne;ye+=3)Qe=ie.indexOf(q.charAt(Ie++)),V=ie.indexOf(q.charAt(Ie++)),Ye=ie.indexOf(q.charAt(Ie++)),ge=ie.indexOf(q.charAt(Ie++)),je=Qe<<2|V>>4,He=(V&15)<<4|Ye>>2,at=(Ye&3)<<6|ge,Ee[ye]=je,Ye!==64&&(Ee[ye+1]=He),ge!==64&&(Ee[ye+2]=at);return Ee}function x(q){const le=Math.ceil(3*q.length/4),pe=new ArrayBuffer(le);return Z(q,pe),pe}function fe(q){let le="";const pe=new Uint8Array(q),ot=pe.byteLength;for(let ne=0;ne<ot;ne++)le+=String.fromCharCode(pe[ne]);return window.btoa(le)}},445619:(Ut,Be,v)=>{v.d(Be,{g:()=>ie});function ie(Z,x){if(Z==null)throw new Error(x)}},852922:(Ut,Be,v)=>{v.d(Be,{A:()=>ie});function ie(Z,x){if(typeof Z=="string"){const q=document.getElementById(Z);if(!q||!(q instanceof HTMLElement))throw new Error("DOM element not found while creating AlternativePlayer");Z=q}if(Z instanceof HTMLMediaElement)return Z;if(!x)throw new Error("No provided URL for AlternativePlayer");const fe=document.createElement("audio");return fe.setAttribute("src",x),fe.setAttribute("crossOrigin","anonymous"),Z.appendChild(fe),fe}},989353:(Ut,Be,v)=>{v.d(Be,{zT:()=>$t,R_:()=>Lt,F6:()=>d,MC:()=>je,jd:()=>ge,$D:()=>g,RL:()=>Ie,fW:()=>vt,tB:()=>Ds,dv:()=>ne,tc:()=>Hi,_T:()=>ct,fm:()=>us,eu:()=>Fs,iF:()=>Ke,D_:()=>Pi,Gk:()=>Ae,p4:()=>gi,mP:()=>Ts,mX:()=>Ti,LC:()=>Ni,yq:()=>As,oK:()=>ks,G1:()=>Es,N1:()=>ws,Ay:()=>bo,Mw:()=>yi.Mw,gx:()=>te.g,Ck:()=>Xn.A});var ie={};v.r(ie),v.d(ie,{BufferUtils:()=>Se,CommonUtils:()=>g,DrumsetConf:()=>Hi,InstrumentConf:()=>ct,OrnamentsUtils:()=>Ne,ParamsUtils:()=>qe,ReaderUtils:()=>C});var Z={};v.r(Z),v.d(Z,{AudioContextStateValues:()=>be,DefaultValues:()=>G,DynamicsMappedVelocities:()=>Dt,ExportValues:()=>wt,Expression:()=>pi,MIDIValues:()=>li,MetronomeModes:()=>gi,PlayingModes:()=>Ur,VelocityValues:()=>se});var x=v(645369);function fe(o){const e=Error.call(this);return this.name=e.name="BadLocationError",this.stack=e.stack,this.message=`The location object [${o}] is invalid. `,this}fe.prototype=Object.create(Error.prototype,{constructor:{value:fe}});const q=fe;function le(o,e){const t=Error.call(this);return this.name=t.name="BadMeasureIdxError",this.stack=t.stack,this.message=`The measure index [${o}] is out of range. It shouldn't exceed [${e}]`,this}le.prototype=Object.create(Error.prototype,{constructor:{value:le}});const pe=le;class ot extends Error{constructor(e){super(e),Object.defineProperty(this,"keepPlaybackActive",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"name",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"i18n",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.keepPlaybackActive=!0,this.name="DacapoError"}}const ne=ot;class Ee extends ne{constructor(e){super(`elapsed time before next note cannot be 0. part ${e.partIdx}, measure ${e.measureIdx}, voice ${e.voiceId}, noteIdx ${e.noteIdx}`),this.name="BadMinDurationError"}}const je=Ee;function He(o,e){const t=Error.call(this);return this.name=t.name="BadNoteIdxError",this.stack=t.stack,this.message=`The note index [${o}] was not expected. ${e||""}`,this}He.prototype=Object.create(Error.prototype,{constructor:{value:He}});const at=He;function Qe(o,e){const t=Error.call(this);return this.name=t.name="BadPartIdxError",this.stack=t.stack,this.message=`The part index [${o}] was not expected. ${e||""}`,this}Qe.prototype=Object.create(Error.prototype,{constructor:{value:Qe}});const V=Qe;class Ye extends ne{constructor(e){super("The web audio timer is stuck."),Object.defineProperty(this,"webAudioCurrentTime",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"webAudioState",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"savedCurrentTime",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"when",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="BlockedWAAPIError",this.webAudioCurrentTime=e.currentTime,this.webAudioState=e.state,this.savedCurrentTime=e.formerTime,this.when=e.when}}const ge=Ye;function ye(o,e){const t=Error.call(this,o);return this.name=t.name="CompatibilityError",this.stack=t.stack,this.message=t.message,typeof e!="undefined"&&(this.code=e),this}ye.prototype=Object.create(Error.prototype,{constructor:{value:ye}});const Ie=ye;class Us extends ne{constructor(e,t){const i=Number(e.substring(e.lastIndexOf("(")+1,e.lastIndexOf(")"))),s=`The maximum number of connection to the audio card (${i}) has been reached.`;super(s),Object.defineProperty(this,"maxConnections",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"code",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.name="ConnectionOverflowError",this.maxConnections=i,t!==void 0&&(this.code=t)}}const vt=Us;function zt(o){const e=Error.call(this);return this.name=e.name="CreateGainInitError",this.stack=e.stack,this.message="An error occured while trying to create a gain node",this.audioContext=o,this}zt.prototype=Object.create(Error.prototype,{constructor:{value:zt}});const _i=zt;function Gt(o){const e=Error.call(this);return this.name=e.name="InvalidMediaElementError",this.stack=e.stack,o instanceof HTMLElement?this.message=`The provided element is not a valid media element. The node name is ${o.nodeName} but should be AUDIO or VIDEO.`:this.message="The provided element is not a valid DOM element.",this}Gt.prototype=Object.create(Error.prototype,{constructor:{value:Gt}});const zs=Gt;function Wt(o){const e=Error.call(this);return this.name=e.name="InvalidNoteIndexError",this.stack=e.stack,this.message=`The note index [${o}] is invalid. A note index within the range of the measure is required.`,this}Wt.prototype=Object.create(Error.prototype,{constructor:{value:Wt}});const Vi=Wt;function jt(){const o=Error.call(this);return this.name=o.name="InvalidSourceError",this.stack=o.stack,this.message="The alternative source buffer is invalid or has not been set. The source cannot be changed.",this}jt.prototype=Object.create(Error.prototype,{constructor:{value:jt}});const Ht=jt;function Qt(o){const e=Error.call(this);return o=o||"",this.name=e.name="MIDIAccessDeniedError",this.stack=e.stack,this.message=`MIDI access has been denied. ${o}`,this}Qt.prototype=Object.create(Error.prototype,{constructor:{value:Qt}});const $i=Qt;function Yt(o){const e=Error.call(this);return this.name=e.name="MIDICalibrationError",this.stack=e.stack,this.message=o||"An error happened during the MIDI Calibration",this}Yt.prototype=Object.create(Error.prototype,{constructor:{value:Yt}});const Ke=Yt;function Kt(o,e,t){const i=Error.call(this);return this.name=i.name="MissingInitError",this.stack=i.stack,this.extra=t,this.message=`The object [${o}] has not been initialized.`,e&&(this.message+=` Metronome mode: [${e.mode}], solo: [${e.solo}], count: [${e.count}]`),this}Kt.prototype=Object.create(Error.prototype,{constructor:{value:Kt}});const Gs=Kt;function Jt(o,e){const t=Error.call(this);return this.name=t.name="MissingInstrumentManagerError",this.stack=t.stack,this.extra=e,this.message=`The InstrumentManager in [${o}] is missing. [${o}] may have not been properly initialized.`,this}Jt.prototype=Object.create(Error.prototype,{constructor:{value:Jt}});const Li=Jt;function Xt(o,e){const t=Error.call(this),i=o&&o.constructor&&o.constructor.name,s=e&&e.constructor&&e.constructor.name;return this.name=t.name="NodeConnectionError",this.stack=t.stack,this.message=`An occured while trying to connect [${i}] to [${s}]`,this}Xt.prototype=Object.create(Error.prototype,{constructor:{value:Xt}});const Zt=Xt;function ei(o,e){const t=Error.call(this);return this.name=t.name="NoteOutOfRangeError",this.stack=t.stack,this.message=`The note index [${o}] is out of range. It shouldn't exceed [${e}]`,this}ei.prototype=Object.create(Error.prototype,{constructor:{value:ei}});const Fi=ei;function ti(o,e){const t=Error.call(this,o);return this.name=t.name="ParseError",this.stack=t.stack,this.message=t.message,typeof e!="undefined"&&(this.code=e),this}ti.prototype=Object.create(Error.prototype,{constructor:{value:ti}});const ii=ti;function si(){const o=Error.call(this);return this.name=o.name="PlaybackOngoingError",this.stack=o.stack,this.message="The playback is currently in progress, so the requested action cannot be performed.",this}si.prototype=Object.create(Error.prototype,{constructor:{value:si}});const Ws=si;function ri(){const o=Error.call(this);return this.name=o.name="UndefinedContextError",this.stack=o.stack,this.message="The audio context is not defined and wanted action cannot be performed.",this}ri.prototype=Object.create(Error.prototype,{constructor:{value:ri}});const he=ri;function ni(o,e){const t=Error.call(this);return this.name=t.name="UnexpectedVoiceError",this.stack=t.stack,this.message=`An unexpected voice has been found. Voice [${o}] was expected but voice [${e}] was found.`,this}ni.prototype=Object.create(Error.prototype,{constructor:{value:ni}});const js=ni;function oi(o,e){const t=Error.call(this);return this.name=t.name="UnregisteredUnpitchedElementError",this.stack=t.stack,this.message=`The requested unpitched element [${o}] isn't registered in the note mapping. ${e||""}`,this}oi.prototype=Object.create(Error.prototype,{constructor:{value:oi}});const Bi=oi,It={BadLocationError:q,BadMeasureIdxError:pe,BadMinDurationError:je,BadNoteIdxError:at,BadPartIdxError:V,BlockedWAAPIError:ge,CompatibilityError:Ie,ConnectionOverflowError:vt,CreateGainInitError:_i,InvalidMediaElementError:zs,InvalidNoteIndexError:Vi,InvalidSourceError:Ht,MIDIAccessDeniedError:$i,MIDICalibrationError:Ke,MissingInitError:Gs,MissingInstrumentManagerError:Li,NodeConnectionError:Zt,NoteOutOfRangeError:Fi,ParseError:ii,PlaybackOngoingError:Ws,UndefinedContextError:he,UnexpectedVoiceError:js,UnregisteredUnpitchedElementError:Bi};let Je=null;const qi=x("dacapo:workertimer");function Hs(){const o={},e=[];this.onmessage=t=>{let i;switch(t.data.command){case"interval:start":i=setInterval(()=>{postMessage({message:"interval:tick",id:t.data.id})},t.data.interval),postMessage({message:"interval:started",id:t.data.id}),o[t.data.id]=i;break;case"timeout:start":i=setTimeout(()=>{postMessage({message:"timeout:tick",id:t.data.id})},t.data.timeout),postMessage({message:"timeout:started",id:t.data.id}),e[t.data.id]=i;break;case"interval:clear":clearInterval(o[t.data.id]),postMessage({message:"interval:cleared",id:t.data.id}),delete o[t.data.id];break;case"timeout:clear":clearTimeout(e[t.data.id]),postMessage({message:"timeout:cleared",id:t.data.id});break;default:}}}const $={id:0,callbacks:{},setInterval(o,e,t){this.id++;const{id:i}=this;return this.callbacks[i]={fn:o,context:t},Je.postMessage({command:"interval:start",interval:e,id:i}),i},setTimeout(o,e,t,i){qi(`set new timeout of ${e}ms`),this.id++;const{id:s}=this;return this.callbacks[s]={fn:o,context:t,args:i},Je.postMessage({command:"timeout:start",timeout:e,id:s}),s},onMessage(o){let e;switch(o.data.message){case"interval:tick":e=this.callbacks[o.data.id],e&&e.fn&&e.fn.apply(e.context);break;case"interval:cleared":delete this.callbacks[o.data.id];break;case"timeout:tick":e=this.callbacks[o.data.id],e&&e.fn&&e.fn.apply(e.context,e.args);break;case"timeout:cleared":delete this.callbacks[o.data.id],typeof this.cbCleared=="function"&&this.cbCleared();break;default:}},clearInterval(o){Je.postMessage({command:"interval:clear",id:o})},clearTimeout(o,e){qi(`clear timeout ${o}`),Je.postMessage({command:"timeout:clear",id:o}),this.cbCleared=e}};function ut(){const o=window.URL||window.webkitURL;if(o&&window.Blob&&window.Worker){let e=Hs.toString();e=e.substring(e.indexOf("{")+1,e.lastIndexOf("}"));const t=o.createObjectURL(new Blob([e],{type:"text/javascript"}));Je=new Worker(t),Je.onmessage=$.onMessage.bind($)}else throw new It.CompatibilityError("Cannot instantiate worker due to browser compatibility")}var Ui=(o,e,t)=>new Promise((i,s)=>{var r=a=>{try{u(t.next(a))}catch(l){s(l)}},n=a=>{try{u(t.throw(a))}catch(l){s(l)}},u=a=>a.done?i(a.value):Promise.resolve(a.value).then(r,n);u((t=t.apply(o,e)).next())});const S={},lt=x("dacapo:init");S.initialized=!1,S.exporting=!1;function zi(){if(window.AudioContext||!window.webkitAudioContext||!S.AudioContexts.context||S.AudioContexts.context.state!=="suspended")return!1;const o=()=>{S.AudioContexts.resume(),setTimeout(()=>{S.AudioContexts.context.state==="running"&&document.body.removeEventListener("touchend",o,!1)},0)};return document.body.addEventListener("touchend",o,!1),!0}S.initOfflineContext=function(e,t,i){if(lt(`init new offline context. Already initialized? ${S.initialized}`),!S.initialized){if(typeof Promise=="undefined")throw new S.Error("Promises are not available on this browser");S.AudioContexts.initOfflineContext(e,t,i)&&(S.Config.initOutput(),S.mainOutput=S.Config.mainOutput,ut(),S.exporting=!0,S.initialized=!0)}},S.renewOfflineContext=function(e){S.Config.dispose(),S.AudioContexts.renewOfflineContext(e)&&(S.Config.initOutput(),S.mainOutput=S.Config.mainOutput)},S.init=function(){if(lt(`init new normal context. Already initialized? ${S.initialized}`),!S.initialized){if(typeof Promise=="undefined")throw new S.Error("Promises are not available on this browser");S.AudioContexts.init()&&(S.Config.initOutput(),S.mainOutput=S.Config.mainOutput,zi(),ut(),S.initialized=!0)}},S.renewContext=function(){return Ui(this,null,function*(){if(lt("request to renew AudioContext"),!S.initialized)throw Error("Dacapo has never been initialized, use Dacapo.init() first");yield S.AudioContexts.renew(),S.Config.initOutput(),S.mainOutput=S.Config.mainOutput,zi(),ut(),S.initialized=!0})},S.initVirtual=function(){S.initialized||(lt("init virtual dacapo context"),S.AudioContexts.initVirtual()&&(ut(),S.initialized=!0))},S.closeContexts=function(){return Ui(this,null,function*(){lt("close contexts"),S.initialized=!1,S.mainOutput=null,yield S.AudioContexts.closeContexts()})},window.Dacapo=S;const N=S,be={RUNNING:"running",SUSPENDED:"suspended",INTERRUPTED:"interrupted",CLOSED:"closed"};var Gi=(o,e,t)=>new Promise((i,s)=>{var r=a=>{try{u(t.next(a))}catch(l){s(l)}},n=a=>{try{u(t.throw(a))}catch(l){s(l)}},u=a=>a.done?i(a.value):Promise.resolve(a.value).then(r,n);u((t=t.apply(o,e)).next())});const Oe={context:null,initialized:!1,init(){if(!this.initialized){let o=null;if(o=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.oAudioContext||window.msAudioContext||void 0,navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia,!o)throw new Ie("Web Audio API is not available on this browser");try{this.context=new o}catch(e){throw e.name==="NotSupportedError"&&!e.message.indexOf("Failed to construct 'AudioContext': The number of hardware contexts provided")?new vt(e.message):e}return this.initialized=!0,!!this.context}return!1},resume(){if(!this.context)throw new Error("AudioContext cannot be resumed because it doesn't exists");if(this.context.state===be.SUSPENDED||this.context.state===be.INTERRUPTED)return this.context.resume()},renew(){return Gi(this,null,function*(){if(!this.initialized||!this.context)throw new Error("Dacapo first need to initialize the AudioContext using init()");return this.context.state!=="closed"&&(yield this.context.close()),this.initialized=!1,this.init()})},close(){return Gi(this,null,function*(){this.context&&(yield this.context.close(),this.context=null),this.initialized=!1})}},ht={initialized:!1,context:null,init(o,e,t){if(!this.initialized){let i=null;if(i=window.OfflineAudioContext||window.webkitOfflineAudioContext||void 0,typeof i=="undefined")throw new Error("Offline context of Web Audio API is not available on this browser");if(i){try{this.context=new i(o,e,t)}catch(s){throw s.name==="NotSupportedError"&&!s.message.indexOf("Failed to construct 'OfflineAudioContext': The number of hardware contexts provided")?new vt(s.message):s}return this.initialized=!0,!0}}return!1},renew(o,e,t){if(!this.initialized||!this.context)throw new Error("Dacapo first need to initialize the OfflineAudioContext using initOfflineContext()");return o=o||this.context.destination.channelCount,e=e||this.context.length,t=t||this.context.sampleRate,this.context=new OfflineAudioContext(o,e,t),!0},close(){this.context=null,this.initialized=!1}},Wi={context:null,initialized:!1,init(){if(!this.initialized){const o=+new Date;this.context={get currentTime(){return(+new Date-o)/1e3}}}return this.initialized=!0,!0},close(){return this.initialized=!1,Promise.resolve()}};var ji=(o,e,t)=>new Promise((i,s)=>{var r=a=>{try{u(t.next(a))}catch(l){s(l)}},n=a=>{try{u(t.throw(a))}catch(l){s(l)}},u=a=>a.done?i(a.value):Promise.resolve(a.value).then(r,n);u((t=t.apply(o,e)).next())});const d={context:null,rtContext:null,init(){const o=Oe.init();return this.context=Oe.context,o},renewContext(){return ji(this,null,function*(){const o=yield Oe.renew();return this.context=Oe.context,o})},resume(){return Oe.resume()},initVirtual(){const o=Wi.init();return this.context=Wi.context,o},initOfflineContext(o,e,t){const i=ht.init(o,e,t);this.context=ht.context;const s=Oe.init();return this.rtContext=Oe.context,i&&s},renewOfflineContext(o){const e=this.context.destination.channelCount,{sampleRate:t}=this.context;o=o||this.context.length/t;const i=Math.ceil(o*t),s=ht.renew(e,i,t);return this.context=ht.context,s},closeContexts(){return ji(this,null,function*(){ht.close(),yield Oe.close(),this.context=null,this.rtContext=null})}},ct={1:{id:"acoustic_grand_piano",sustainStart:.2,release:2,maxDuration:10,attenuation:.2,tremolo:"alternate",ghostNote:"quickRelease",filter:{type:"lowpass",frequency:7998},samplerv2:!1,sampleRate:44100,samples:[{notename:"D1",basenote:26,range:{start:0,end:30},loop:{start:170893,end:219499}},{notename:"Gb1",basenote:30,range:{start:27,end:30},loop:{start:160113,end:195247}},{notename:"Bb1",basenote:34,range:{start:31,end:34},loop:{start:129454,end:165045}},{notename:"D2",basenote:38,range:{start:35,end:38},loop:{start:158947,end:193111}},{notename:"Gb2",basenote:42,range:{start:39,end:42},loop:{start:120490,end:155602}},{notename:"Bb2",basenote:46,range:{start:43,end:46},loop:{start:109152,end:141103}},{notename:"D3",basenote:50,range:{start:47,end:50},loop:{start:77368,end:109543}},{notename:"Gb3",basenote:54,range:{start:51,end:54},loop:{start:55019,end:84480}},{notename:"Bb3",basenote:58,range:{start:55,end:58},loop:{start:52686,end:87542}},{notename:"D4",basenote:62,range:{start:59,end:62},loop:{start:73030,end:103885}},{notename:"Gb4",basenote:66,range:{start:63,end:66},loop:{start:62381,end:88426}},{notename:"Bb4",basenote:70,range:{start:67,end:70},loop:{start:51471,end:71088}},{notename:"D5",basenote:74,range:{start:71,end:74},loop:{start:44165,end:67047}},{notename:"Gb5",basenote:78,range:{start:75,end:78},loop:{start:47507,end:75718}},{notename:"C6",basenote:84,range:{start:79,end:84},loop:{start:43879,end:46535}},{notename:"Gb6",basenote:90,range:{start:85,end:90},loop:{start:40281,end:60328}},{notename:"Bb6",basenote:94,range:{start:91,end:94},loop:{start:40230,end:41513}},{notename:"Eb7",basenote:99,range:{start:95,end:99},loop:{start:17820,end:18113}},{notename:"Ab7",basenote:104,range:{start:100,end:104},loop:{start:13695,end:14104}},{notename:"C8",basenote:108,range:{start:105,end:127},loop:{start:12048,end:12733}}]},2:{id:"bright_acoustic_piano",sustainStart:.2,release:1.5,tremolo:"alternate",attack:.008,attenuation:.41,samplerv2:!1,sampleRate:32e3,samples:1},7:{id:"harpsichord",decay:25,sustain:1e-5,release:.45,tremolo:"alternate",filter:{type:"lowpass",frequency:8799},samplerv2:!1,sampleRate:44100,samples:[{notename:"D2",basenote:38,range:{start:0,end:39},loop:{start:167374,end:170995}},{notename:"G2",basenote:43,range:{start:40,end:44},loop:{start:82026,end:86528}},{notename:"C3",basenote:48,range:{start:45,end:48},loop:{start:99441,end:102477}},{notename:"F3",basenote:53,range:{start:49,end:54},loop:{start:47196,end:47448}},{notename:"C4",basenote:60,range:{start:55,end:61},loop:{start:91398,end:93249}},{notename:"F4",basenote:65,range:{start:62,end:65},loop:{start:36618,end:36997}},{notename:"B4",basenote:71,range:{start:66,end:71},loop:{start:37383,end:39081}},{notename:"F5",basenote:77,range:{start:72,end:77},loop:{start:30673,end:31873}},{notename:"D6",basenote:86,range:{start:78,end:86},loop:{start:30172,end:30397}},{notename:"B6",basenote:95,range:{start:87,end:95},loop:{start:20130,end:20576}},{notename:"C7",basenote:96,range:{start:96,end:127},loop:{start:35993,end:36753}}]},9:{id:"celesta",transposechromatic:12,hold:.1,decay:2,sustain:1e-5,release:3.5,attenuation:.31,tremolo:"alternate",samplerv2:!1,sampleRate:44100,samples:[{notename:"Gb3",basenote:54,range:{start:0,end:54},loop:{start:25359,end:26312}},{notename:"C4",basenote:60,range:{start:60,end:65},loop:{start:19225,end:19562}},{notename:"Gb4",basenote:66,range:{start:66,end:71},loop:{start:24481,end:24958}},{notename:"C5",basenote:72,range:{start:72,end:77},loop:{start:22571,end:23245}},{notename:"Gb5",basenote:78,range:{start:78,end:83},loop:{start:21396,end:21873}},{notename:"C6",basenote:84,range:{start:84,end:89},loop:{start:19665,end:20126}},{notename:"Gb6",basenote:90,range:{start:90,end:95},loop:{start:9497,end:9884}},{notename:"C7",basenote:96,range:{start:96,end:127},loop:{start:11684,end:11705}}]},10:{id:"glockenspiel",transposechromatic:24,release:4,tremolo:"roll"},11:{id:"music_box",release:4,tremolo:"roll"},12:{id:"vibraphone",release:4,tremolo:"roll"},13:{id:"marimba",release:2,tremolo:"roll"},14:{id:"xylophone",transposechromatic:12,release:3,tremolo:"roll"},15:{id:"tubular_bells",release:4,tremolo:"roll"},17:{id:"drawbar_organ",release:2,attenuation:.3,tremolo:"vibrato",filter:{type:"lowpass",frequency:8598},samplerv2:!1,sampleRate:32e3,samples:[{notename:"C7",basenote:96,range:{start:0,end:127},loop:{start:11297,end:49216}}]},18:{id:"percussive_organ",release:2,attenuation:.3,tremolo:"vibrato",sampleRate:44100,samplerv2:!1,samples:[{notename:"Eb2",basenote:39,range:{start:0,end:39},loop:{start:31226,end:100902}},{notename:"G2",basenote:43,range:{start:40,end:43},loop:{start:25250,end:91806}},{notename:"A2",basenote:45,range:{start:44,end:45},loop:{start:23602,end:81285}},{notename:"C3",basenote:48,range:{start:46,end:48},loop:{start:12457,end:76458}},{notename:"Db3",basenote:49,range:{start:49,end:50},loop:{start:19729,end:83951}},{notename:"E3",basenote:52,range:{start:51,end:54},loop:{start:24602,end:91436}},{notename:"Ab3",basenote:56,range:{start:55,end:59},loop:{start:46308,end:114633}},{notename:"D4",basenote:62,range:{start:60,end:65},loop:{start:12457,end:76458}},{notename:"Ab4",basenote:68,range:{start:66,end:69},loop:{start:20025,end:82645}},{notename:"C5",basenote:72,range:{start:70,end:76},loop:{start:62080,end:128769}},{notename:"Ab5",basenote:80,range:{start:77,end:80},loop:{start:37396,end:99327}},{notename:"C6",basenote:84,range:{start:81,end:87},loop:{start:19477,end:95770}},{notename:"F6",basenote:89,range:{start:88,end:89},loop:{start:57843,end:158670}},{notename:"G6",basenote:91,range:{start:90,end:127},loop:{start:33792,end:93185}}]},19:{id:"rock_organ",release:2,attenuation:.3,tremolo:"vibrato",samplerv2:!1,sampleRate:32e3,samples:[{notename:"Ab2",basenote:44,range:{start:0,end:44},loop:{start:23350,end:72007}},{notename:"B2",basenote:47,range:{start:45,end:49},loop:{start:54861,end:104311}},{notename:"E3",basenote:52,range:{start:50,end:55},loop:{start:47211,end:97269}},{notename:"A3",basenote:57,range:{start:56,end:58},loop:{start:34474,end:83056}},{notename:"C4",basenote:60,range:{start:59,end:63},loop:{start:66612,end:119553}},{notename:"F4",basenote:65,range:{start:64,end:70},loop:{start:50002,end:99845}},{notename:"Db5",basenote:73,range:{start:71,end:76},loop:{start:46895,end:94475}},{notename:"G5",basenote:79,range:{start:77,end:82},loop:{start:6688,end:77081}},{notename:"B5",basenote:83,range:{start:83,end:86},loop:{start:15126,end:62973}},{notename:"F6",basenote:89,range:{start:87,end:89},loop:{start:11787,end:61146}},{notename:"G6",basenote:91,range:{start:90,end:127},loop:{start:12309,end:60922}}]},20:{id:"church_organ",release:2.42,attenuation:.3,tremolo:"vibrato",samplerv2:!1,sampleRate:22050,samples:[{notename:"C2",basenote:36,range:{start:0,end:36},loop:{start:24522,end:61248}},{notename:"Gb2",basenote:42,range:{start:37,end:45},loop:{start:46262,end:91741}},{notename:"Eb3",basenote:51,range:{start:46,end:54},loop:{start:47046,end:97886}},{notename:"C4",basenote:60,range:{start:55,end:63},loop:{start:45472,end:90380}},{notename:"A4",basenote:69,range:{start:64,end:72},loop:{start:47913,end:78779}},{notename:"Gb5",basenote:78,range:{start:73,end:81},loop:{start:27869,end:61623}},{notename:"Eb6",basenote:87,range:{start:82,end:90},loop:{start:31911,end:71007}},{notename:"C7",basenote:96,range:{start:91,end:127},loop:{start:17894,end:51289}}]},21:{id:"reed_organ",release:2,tremolo:"vibrato",attenuation:.125,samplerv2:!1,sampleRate:44100,samples:[{notename:"Gb3",basenote:54,sampleRate:26e3,range:{start:0,end:54},loop:{start:3092,end:3373}},{notename:"C4",basenote:60,sampleRate:24e3,range:{start:55,end:60},loop:{start:1970,end:2062}},{notename:"Gb4",basenote:66,sampleRate:38e3,range:{start:61,end:66},loop:{start:3011,end:3216}},{notename:"C5",basenote:72,sampleRate:4e4,range:{start:67,end:72},loop:{start:2831,end:3137}},{notename:"Gb5",basenote:78,range:{start:73,end:78},loop:{start:3103,end:3282}},{notename:"C6",basenote:84,sampleRate:32e3,range:{start:79,end:84},loop:{start:971,end:1124}},{notename:"Gb6",basenote:90,range:{start:85,end:90},loop:{start:1457,end:1576}},{notename:"C7",basenote:96,sampleRate:38e3,range:{start:91,end:127},loop:{start:2080,end:2298}}]},22:{id:"accordion",release:1.5,tremolo:"vibrato",glissando:"slide"},23:{id:"harmonica",slur:!0,release:1.5,tremolo:"vibrato"},25:{id:"acoustic_guitar_nylon",release:1.5,tremolo:"strum",glissando:"slide",deadNote:"alternativeSample",ghostNote:"alternativeSample",children:{deadNote:"acoustic_guitar_dead_notes",ghostNote:"acoustic_guitar_dead_notes"}},26:{id:"acoustic_guitar_steel",release:1.5,tremolo:"strum",glissando:"slide",deadNote:"alternativeSample",ghostNote:"alternativeSample",children:{deadNote:"acoustic_guitar_dead_notes",ghostNote:"acoustic_guitar_dead_notes"}},27:{id:"electric_guitar_jazz",release:1.5,tremolo:"strum",glissando:"slide",deadNote:"alternativeSample",ghostNote:"alternativeSample",children:{deadNote:"electric_guitar_dead_notes",ghostNote:"electric_guitar_dead_notes"}},28:{id:"electric_guitar_clean",release:1.5,tremolo:"strum",glissando:"slide",deadNote:"alternativeSample",ghostNote:"alternativeSample",children:{deadNote:"electric_guitar_dead_notes",ghostNote:"electric_guitar_dead_notes"}},29:{id:"electric_guitar_muted",release:1.5,tremolo:"strum",glissando:"slide",deadNote:"alternativeSample",ghostNote:"alternativeSample",children:{deadNote:"electric_guitar_dead_notes",ghostNote:"electric_guitar_dead_notes"}},31:{id:"distortion_guitar",release:1.5,tremolo:"strum",glissando:"slide",deadNote:"alternativeSample",ghostNote:"alternativeSample",children:{deadNote:"electric_guitar_dead_notes",ghostNote:"electric_guitar_dead_notes"}},34:{id:"electric_bass_finger",release:1.5,tremolo:"strum",glissando:"slide",deadNote:"alternativeSample",ghostNote:"alternativeSample",children:{deadNote:"electric_bass_dead_notes",ghostNote:"electric_bass_dead_notes"}},35:{id:"electric_bass_pick",release:1.5,tremolo:"strum",glissando:"slide",deadNote:"alternativeSample",ghostNote:"alternativeSample",children:{deadNote:"electric_bass_dead_notes",ghostNote:"electric_bass_dead_notes"}},37:{id:"slap_bass_1",release:1.4,tremolo:"strum",glissando:"slide",deadNote:"alternativeSample",ghostNote:"alternativeSample",children:{deadNote:"electric_bass_dead_notes",ghostNote:"electric_bass_dead_notes"}},39:{id:"synth_bass_1",release:.5,gradualVelocity:!0,children:{velocity_f:{id:"synth_bass_1_strong"}}},40:{id:"synth_bass_2",release:.5,gradualVelocity:!0,children:{velocity_f:{id:"synth_bass_2_strong"}}},41:{id:"violin",release:.6,slur:!0,tremolo:"friction",glissando:"slide",gradualVelocity:!0,children:{pizzicato:"violin_pizz"}},42:{id:"viola",release:.6,slur:!0,tremolo:"friction",glissando:"slide",gradualVelocity:!0,children:{pizzicato:"viola_pizz"}},43:{id:"cello",release:.7,slur:!0,tremolo:"friction",glissando:"slide",gradualVelocity:!0,children:{pizzicato:"cello_pizz"}},44:{id:"contrabass",release:.7,slur:!0,tremolo:"friction",glissando:"slide",gradualVelocity:!0,children:{pizzicato:"contrabass_pizz"}},46:{id:"string_ensemble_1_pizz",tremolo:"strum",release:1},47:{id:"orchestral_harp",release:6,tremolo:"strum"},48:{id:"timpani",release:6,tremolo:"roll"},49:{id:"string_ensemble_1",tremolo:"friction",release:1,glissando:"slide",gradualVelocity:!0,children:{pizzicato:"string_ensemble_1_pizz"}},53:{id:"choir_aahs",release:1.2,tremolo:"vibrato",glissando:"slide",gradualVelocity:!0},54:{id:"voice_oohs",release:1.2,tremolo:"vibrato",glissando:"slide",gradualVelocity:!0},55:{id:"synth_choir",release:1.2,tremolo:"vibrato",glissando:"slide",gradualVelocity:!0},57:{id:"trumpet",transposechromatic:-2,release:.3,slur:!0,tremolo:"vibrato",glissando:"slide",gradualVelocity:!0},58:{id:"trombone",release:.5,slur:!0,tremolo:"alternate",glissando:"slide",gradualVelocity:!0},59:{id:"tuba",release:.5,slur:!0,tremolo:"alternate",glissando:"slide",gradualVelocity:!0},61:{id:"french_horn",transposechromatic:-7,shorten:.96,release:1.2,slur:!0,tremolo:"alternate",glissando:"slide",gradualVelocity:!0},62:{id:"brass_section",release:1.2,tremolo:"alternate",glissando:"slide",gradualVelocity:!0},65:{id:"soprano_sax",transposechromatic:-2,release:.3,slur:!0,tremolo:"alternate",gradualVelocity:!0},66:{id:"alto_sax",transposechromatic:-9,release:.3,slur:!0,tremolo:"alternate",gradualVelocity:!0},67:{id:"tenor_sax",transposechromatic:-14,release:.3,slur:!0,tremolo:"alternate",gradualVelocity:!0},68:{id:"baritone_sax",transposechromatic:-21,release:.3,slur:!0,tremolo:"alternate",gradualVelocity:!0},69:{id:"oboe",release:.5,slur:!0,tremolo:"alternate",gradualVelocity:!0},70:{id:"english_horn",transposechromatic:-7,release:.6,slur:!0,tremolo:"alternate",gradualVelocity:!0},71:{id:"bassoon",release:.5,slur:!0,tremolo:"alternate",gradualVelocity:!0},72:{id:"clarinet",transposechromatic:-2,release:.3,slur:!0,tremolo:"alternate",gradualVelocity:!0},73:{id:"piccolo",transposechromatic:12,release:.9,slur:!0,tremolo:"alternate",gradualVelocity:!0},74:{id:"flute",release:.9,slur:!0,tremolo:"alternate",gradualVelocity:!0},75:{id:"recorder",release:.5,slur:!0,tremolo:"alternate",gradualVelocity:!0},76:{id:"pan_flute",slur:!0,release:2,tremolo:"vibrato",gradualVelocity:!0},78:{id:"shakuhachi_flute",release:1.2,slur:!0,tremolo:"alternate",gradualVelocity:!0,children:{velocity_p:{id:"shakuhachi_flute_soft"},velocity_f:{id:"shakuhachi_flute_strong"}}},79:{id:"whistle",release:.5,slur:!0,tremolo:"vibrato",gradualVelocity:!0},80:{id:"ocarina",slur:!0,release:2,tremolo:"vibrato",gradualVelocity:!0},81:{id:"lead_synth_vin3",release:.5,gradualVelocity:!0},82:{id:"lead_synth_mod2",release:.5,gradualVelocity:!0},83:{id:"lead_synth_vin6",release:.5,gradualVelocity:!0},84:{id:"lead_synth_vin1",release:.5,gradualVelocity:!0},85:{id:"lead_synth_mod5",release:.5,gradualVelocity:!0},86:{id:"lead_6_voice",tremolo:"vibrato",glissando:"slide",gradualVelocity:!0},87:{id:"lead_synth_mod4",release:.5,gradualVelocity:!0},88:{id:"lead_synth_mod1",release:.5,gradualVelocity:!0},92:{id:"pad_4_choir",tremolo:"vibrato",glissando:"slide",gradualVelocity:!0},105:{id:"sitar",release:4,tremolo:"strum",glissando:"slide",deadNote:"alternativeSample",ghostNote:"alternativeSample",children:{deadNote:"acoustic_guitar_dead_notes",ghostNote:"acoustic_guitar_dead_notes"}},106:{id:"banjo",release:2,tremolo:"strum",glissando:"slide",deadNote:"alternativeSample",ghostNote:"alternativeSample",children:{deadNote:"acoustic_guitar_dead_notes",ghostNote:"acoustic_guitar_dead_notes"}},107:{id:"shamisen",release:3,tremolo:"strum",glissando:"slide",children:{velocity_p:{id:"shamisen_soft"},velocity_f:{id:"shamisen_strong"}}},108:{id:"koto",release:4,tremolo:"strum",glissando:"slide",children:{velocity_p:{id:"koto_soft"},velocity_f:{id:"koto_strong"}}},110:{id:"bagpipe",transposechromatic:-2,slur:!0,release:1.2,tremolo:"vibrato",glissando:"slide",gradualVelocity:!0},115:{id:"steel_drums",release:3,tremolo:"roll"},131:{id:"premium_electric_guitar_distortion",release:.3,tremolo:"strum",glissando:"slide",deadNote:"alternativeSample",ghostNote:"alternativeSample",children:{deadNote:"premium_electric_guitar_distortion_dead",ghostNote:"premium_electric_guitar_distortion_dead"}},139:{id:"synth_bass_3",release:.5,gradualVelocity:!0,children:{velocity_f:{id:"synth_bass_3_strong"}}},140:{id:"bassline_808_underwide",release:.5,gradualVelocity:!0},148:{id:"premium_timpani",release:4,tremolo:"roll",children:{velocity_p:{id:"premium_timpani_soft"},velocity_f:{id:"premium_timpani_strong"}}},153:{id:"premium_choir_soprano_women",release:1.2,tremolo:"vibrato",glissando:"slide",gradualVelocity:!0},154:{id:"premium_choir_alto_women",release:1.2,tremolo:"vibrato",glissando:"slide",gradualVelocity:!0},155:{id:"premium_choir_tenor_men_1",release:1.2,tremolo:"vibrato",glissando:"slide",gradualVelocity:!0,children:{velocity_f:{id:"premium_choir_tenor_men_1_strong"}}},156:{id:"premium_choir_bass_1",release:1.2,tremolo:"vibrato",glissando:"slide",gradualVelocity:!0},159:{id:"premium_tuba",release:.5,slur:!0,tremolo:"alternate",glissando:"slide",gradualVelocity:!0,children:{velocity_p:{id:"premium_tuba_soft"},velocity_f:{id:"premium_tuba_strong"},mute:{id:"premium_tuba_mute",children:{velocity_p:{id:"premium_tuba_mute_soft"},velocity_f:{id:"premium_tuba_mute_strong"}}}}},161:{id:"french_horn_premium",transposechromatic:-7,release:1.2,slur:!0,tremolo:"alternate",glissando:"slide",gradualVelocity:!0,children:{velocity_p:{id:"french_horn_soft_premium"},velocity_f:{id:"french_horn_strong_premium"},mute:{id:"french_horn_mute_premium",children:{velocity_f:{id:"french_horn_mute_strong_premium"}}}}},165:{id:"sax_soprano_premium",transposechromatic:-2,shorten:.94,release:.3,slur:!0,tremolo:"alternate",gradualVelocity:!0,children:{velocity_p:{id:"sax_soprano_piano_premium"},velocity_f:{id:"sax_soprano_forte_premium"}}},166:{id:"sax_alto_premium",transposechromatic:-9,release:.3,slur:!0,tremolo:"alternate",gradualVelocity:!0,children:{velocity_p:{id:"sax_alto_piano_premium"},velocity_f:{id:"sax_alto_forte_premium"}}},167:{id:"sax_tenor_premium",transposechromatic:-14,release:.3,slur:!0,tremolo:"alternate",gradualVelocity:!0,children:{velocity_p:{id:"sax_tenor_piano_premium"},velocity_f:{id:"sax_tenor_forte_premium"}}},168:{id:"sax_baritone_premium",transposechromatic:-21,release:.3,slur:!0,tremolo:"alternate",gradualVelocity:!0,children:{velocity_p:{id:"sax_baritone_piano_premium"},velocity_f:{id:"sax_baritone_forte_premium"}}},171:{id:"contrabassoon",shorten:.93,release:.5,slur:!0,tremolo:"alternate",gradualVelocity:!0,children:{velocity_p:{id:"contrabassoon_soft"},velocity_f:{id:"contrabassoon_strong"}}},172:{id:"concert_clarinet",transposechromatic:-2,release:.3,slur:!0,tremolo:"alternate",gradualVelocity:!0},174:{id:"orchestral_flute",release:.9,slur:!0,tremolo:"alternate",gradualVelocity:!0},178:{id:"dizi_flute",release:1.2,slur:!0,tremolo:"alternate",gradualVelocity:!0,children:{velocity_p:{id:"dizi_flute_soft"},velocity_f:{id:"dizi_flute_strong"}}},181:{id:"lead_synth_ot4",release:.5,gradualVelocity:!0},182:{id:"lead_synth_vin4",release:.5,gradualVelocity:!0},183:{id:"lead_synth_mod7",release:.5,gradualVelocity:!0},184:{id:"lead_synth_vin2",release:.5,gradualVelocity:!0},185:{id:"lead_synth_ot3",release:.5,gradualVelocity:!0},186:{id:"lead_synth_ot1",tremolo:"vibrato",glissando:"slide",gradualVelocity:!0},187:{id:"lead_synth_ot2",release:.5,gradualVelocity:!0},188:{id:"lead_synth_vin5",release:.5,gradualVelocity:!0},207:{id:"oud",release:3,tremolo:"strum",glissando:"slide",children:{velocity_p:{id:"oud_soft"},velocity_f:{id:"oud_strong"}}},215:{id:"steel_drums",release:3,tremolo:"roll"},224:{id:"ukulele",release:1.2,tremolo:"strum",deadNote:"alternativeSample",ghostNote:"alternativeSample",children:{deadNote:"acoustic_guitar_dead_notes",ghostNote:"acoustic_guitar_dead_notes"}},225:{id:"mandolin",release:1.5,tremolo:"strum",deadNote:"alternativeSample",ghostNote:"alternativeSample",children:{deadNote:"acoustic_guitar_dead_notes",ghostNote:"acoustic_guitar_dead_notes"}},231:{id:"premium_electric_guitar_crunch",release:.5,tremolo:"strum",glissando:"slide",deadNote:"alternativeSample",ghostNote:"alternativeSample",children:{deadNote:"premium_electric_guitar_distortion_dead",ghostNote:"premium_electric_guitar_distortion_dead"}},239:{id:"bassline_808_solide",release:.5,gradualVelocity:!0},240:{id:"bassline_808_light",release:.5,gradualVelocity:!0},241:{id:"violin_lead",release:.6,slur:!0,tremolo:"friction",glissando:"slide",gradualVelocity:!0,children:{pizzicato:"violin_pizz"}},242:{id:"premium_viola",release:.6,slur:!0,tremolo:"friction",glissando:"slide",gradualVelocity:!0,children:{velocity_p:{id:"premium_viola_soft"},velocity_f:{id:"premium_viola_strong"},pizzicato:{id:"premium_viola_pizz",children:{velocity_p:{id:"premium_viola_pizz_soft"},velocity_f:{id:"premium_viola_pizz_strong"}}}}},243:{id:"premium_cello",release:.7,slur:!0,tremolo:"friction",glissando:"slide",gradualVelocity:!0,children:{velocity_p:{id:"premium_cello_soft"},velocity_f:{id:"premium_cello_strong"},pizzicato:{id:"premium_cello_pizz",children:{velocity_p:{id:"premium_cello_pizz_soft"},velocity_f:{id:"premium_cello_pizz_strong"}}}}},244:{id:"premium_contrabass",release:.7,slur:!0,tremolo:"friction",glissando:"slide",gradualVelocity:!0,children:{velocity_p:{id:"premium_contrabass_soft"},velocity_f:{id:"premium_contrabass_strong"},pizzicato:{id:"premium_contrabass_pizz",children:{velocity_p:{id:"premium_contrabass_pizz_soft"},velocity_f:{id:"premium_contrabass_pizz_strong"}}}}},253:{id:"premium_choir_soprano_girls",release:1.2,tremolo:"vibrato",glissando:"slide",gradualVelocity:!0,children:{velocity_p:{id:"premium_choir_soprano_girls_soft"},velocity_f:{id:"premium_choir_soprano_girls_strong"}}},254:{id:"premium_choir_alto_girls",release:1.2,tremolo:"vibrato",glissando:"slide",gradualVelocity:!0,children:{velocity_p:{id:"premium_choir_alto_girls_soft"}}},255:{id:"premium_choir_tenor_men_2",release:1.2,tremolo:"vibrato",glissando:"slide",gradualVelocity:!0},256:{id:"premium_choir_bass_2",release:1.2,tremolo:"vibrato",glissando:"slide",gradualVelocity:!0},257:{id:"premium_trumpet",transposechromatic:-2,release:.3,slur:!0,tremolo:"vibrato",glissando:"slide",gradualVelocity:!0,children:{velocity_p:{id:"premium_trumpet_soft"},velocity_f:{id:"premium_trumpet_strong"},mute:{id:"premium_trumpet_mute",children:{velocity_p:{id:"premium_trumpet_mute_soft"},velocity_f:{id:"premium_trumpet_mute_strong"}}}}},258:{id:"premium_trombone",release:.5,slur:!0,tremolo:"alternate",glissando:"slide",gradualVelocity:!0,children:{velocity_p:{id:"premium_trombone_soft"},velocity_f:{id:"premium_trombone_strong"},mute:{id:"premium_trombone_mute",children:{velocity_p:{id:"premium_trombone_mute_soft"},velocity_f:{id:"premium_trombone_mute_strong"}}}}},268:{id:"baritone_horn",slur:!0,tremolo:"alternate",glissando:"slide",gradualVelocity:!0},269:{id:"baritone_horn",transposechromatic:-14,slur:!0,tremolo:"alternate",glissando:"slide",gradualVelocity:!0},270:{id:"euphonium",slur:!0,tremolo:"alternate",glissando:"slide",gradualVelocity:!0},271:{id:"contrabass_clarinet",transposechromatic:-26,release:.3,slur:!0,tremolo:"alternate",gradualVelocity:!0},272:{id:"bass_clarinet",transposechromatic:-14,release:.3,slur:!0,tremolo:"alternate",gradualVelocity:!0},273:{id:"alto_clarinet",transposechromatic:-9,release:.3,slur:!0,tremolo:"alternate",gradualVelocity:!0},274:{id:"alto_flute",transposechromatic:-5,release:.3,slur:!0,tremolo:"alternate",gradualVelocity:!0},281:{id:"lead_synth_mod3",release:.5,gradualVelocity:!0},282:{id:"lead_synth_mod6",release:.5,gradualVelocity:!0},286:{id:"kazoo",tremolo:"vibrato",glissando:"slide",gradualVelocity:!0},301:{id:"premium_piano",sustainStart:.2,release:2,maxDuration:10,attenuation:.2,tremolo:"alternate",ghostNote:"quickRelease",filter:{type:"lowpass",frequency:7998},children:{velocity_p:{id:"premium_piano_soft"},velocity_f:{id:"premium_piano_strong"}},samplerv2:!1},302:{id:"piano_tight",sustainStart:.2,release:2,maxDuration:10,tremolo:"alternate",ghostNote:"quickRelease",filter:{type:"lowpass",frequency:7998},children:{velocity_p:{id:"piano_tight_soft"},velocity_f:{id:"piano_tight_strong"}},samplerv2:!1},303:{id:"piano_concert",sustainStart:.2,release:2,maxDuration:10,tremolo:"alternate",ghostNote:"quickRelease",filter:{type:"lowpass",frequency:7998},children:{velocity_p:{id:"piano_concert_soft"},velocity_f:{id:"piano_concert_strong"}},samplerv2:!1},324:{id:"premium_ukulele",release:1.2,tremolo:"strum",deadNote:"alternativeSample",ghostNote:"alternativeSample",children:{deadNote:"premium_ukulele_dead",ghostNote:"premium_ukulele_dead",velocity_p:{id:"premium_ukulele_soft"},velocity_f:{id:"premium_ukulele_strong"}}},325:{id:"premium_acoustic_guitar",release:1.5,tremolo:"strum",glissando:"slide",deadNote:"alternativeSample",ghostNote:"alternativeSample",children:{deadNote:"premium_acoustic_guitar_dead",ghostNote:"premium_acoustic_guitar_dead",velocity_p:{id:"premium_acoustic_guitar_soft"},velocity_f:{id:"premium_acoustic_guitar_strong"},mute:{id:"premium_acoustic_guitar_mute"}}},328:{id:"premium_electric_guitar",release:1.5,tremolo:"strum",glissando:"slide",deadNote:"alternativeSample",ghostNote:"alternativeSample",children:{deadNote:"premium_electric_guitar_dead",ghostNote:"premium_electric_guitar_dead",velocity_p:{id:"premium_electric_guitar_soft"},velocity_f:{id:"premium_electric_guitar_strong"}}},331:{id:"premium_electric_guitar_lead",release:.5,tremolo:"strum",glissando:"slide",deadNote:"alternativeSample",ghostNote:"alternativeSample",children:{deadNote:"premium_electric_guitar_distortion_dead",ghostNote:"premium_electric_guitar_distortion_dead"}},334:{id:"premium_modern_electric_bass",release:1.5,tremolo:"strum",glissando:"slide",deadNote:"alternativeSample",ghostNote:"alternativeSample",children:{deadNote:"premium_modern_electric_bass_dead",ghostNote:"premium_modern_electric_bass_dead",velocity_p:{id:"premium_modern_electric_bass_soft"},velocity_f:{id:"premium_modern_electric_bass_strong"}}},335:{id:"premium_vintage_electric_bass",release:1.5,tremolo:"strum",glissando:"slide",deadNote:"alternativeSample",ghostNote:"alternativeSample",children:{deadNote:"premium_vintage_electric_bass_dead",ghostNote:"premium_vintage_electric_bass_dead",velocity_p:{id:"premium_vintage_electric_bass_soft"},velocity_f:{id:"premium_vintage_electric_bass_strong"}}},339:{id:"bassline_808_airbass",release:.5,gradualVelocity:!0},340:{id:"bassline_808_evolution",release:.5,gradualVelocity:!0},341:{id:"premium_violin",release:.6,tremolo:"friction",glissando:"slide",gradualVelocity:!0,children:{velocity_p:{id:"premium_violin_soft"},velocity_f:{id:"premium_violin_strong"},pizzicato:{id:"premium_violin_pizz",children:{velocity_f:{id:"premium_violin_pizz_strong"}}}}},353:{id:"premium_choir_soprano_boys",release:1.2,tremolo:"vibrato",glissando:"slide",gradualVelocity:!0,children:{velocity_p:{id:"premium_choir_soprano_boys_soft"},velocity_f:{id:"premium_choir_soprano_boys_strong"}}},354:{id:"premium_choir_countertenor_men",shorten:.92,release:1.2,tremolo:"vibrato",glissando:"slide",gradualVelocity:!0},368:{id:"baritone_horn_premium",slur:!0,tremolo:"alternate",glissando:"slide",release:1.2,gradualVelocity:!0,children:{velocity_p:{id:"baritone_horn_soft_premium"},velocity_f:{id:"baritone_horn_strong_premium"}}},369:{id:"baritone_horn_premium",transposechromatic:-14,release:1.2,slur:!0,tremolo:"alternate",glissando:"slide",gradualVelocity:!0,children:{velocity_p:{id:"baritone_horn_soft_premium"},velocity_f:{id:"baritone_horn_strong_premium"}}},372:{id:"clarinet_ensemble",transposechromatic:-2,release:.3,slur:!0,tremolo:"alternate",gradualVelocity:!0},374:{id:"traditional_flute",release:.9,slur:!0,tremolo:"alternate",gradualVelocity:!0},439:{id:"bassline_808_weekend",release:.5,gradualVelocity:!0},440:{id:"bassline_808_plucky",release:.5,gradualVelocity:!0},441:{id:"erhu",release:.5,tremolo:"friction",glissando:"slide",gradualVelocity:!0,children:{velocity_f:{id:"erhu_strong"},pizzicato:{id:"erhu_pizz",children:{velocity_f:{id:"erhu_pizz_strong"}}}}},539:{id:"bassline_808_phase",release:.5,gradualVelocity:!0},540:{id:"bassline_808_out",release:.5,gradualVelocity:!0},666:{id:"cat",tremolo:"vibrato",gradualVelocity:!0}},Hi={1:{id:"percussion_kit","midi-unpitched":!0,instruments:{36:{name:"Acoustic Bass Drum"},37:{name:"Bass Drum"},38:{name:"Side Stick"},39:{name:"Snare (Acoustic)"},40:{name:"Clapping Hands"},41:{name:"Snare (Electric)"},42:{name:"Tom 5"},43:{name:"Hi-Hat Close"},44:{name:"Tom 4"},45:{name:"Hi-Hat Pedal"},46:{name:"Tom 3"},47:{name:"Hi-Hat Open"},48:{name:"Tom 2"},49:{name:"Tom 1"},50:{name:"Crash 1"},51:{name:"Tom"},52:{name:"Ride"},53:{name:"China"},54:{name:"Ride (bell)"},55:{name:"Tambourine"},56:{name:"Splash Cymbal"},57:{name:"Cowbell"}}},2:{id:"marching_band_set","midi-unpitched":!0,instruments:{36:{name:"Bass Drum 5"},37:{name:"Bass Drum Rims"},38:{name:"Bass Drum 4"},39:{name:"Bass Drum Unison"},40:{name:"Bass Drum 3"},41:{name:"Bass Drum 2"},43:{name:"Bass Drum 1"},44:{name:"Cymbal Smash"},45:{name:"Cymbal Crash"},46:{name:"Hi Hat Choke"},47:{name:"Cymbal Crash Choke"},48:{name:"Snare Left Hand"},49:{name:"Snare Left Hand Rimshot"},50:{name:"Snare Right Hand"},51:{name:"Snare Right Hand Rimshot"},52:{name:"Snare Gok"},53:{name:"Snare Short Guz"},54:{name:"Snare Long Guz"},55:{name:"Snare Left Hand Rim"},56:{name:"Snare Right Hand Rim"},57:{name:"Snare Cross Shot"},58:{name:"Snare Stick Shot"},59:{name:"Snare Stick Click"},60:{name:"Snare Roll Short"},64:{name:"Snare Brush"},65:{name:"Tenor Drum 4"},66:{name:"Tenor Drum 4 Rimshot"},67:{name:"Tenor Drum 4 Buzz Roll"},69:{name:"Tenor Drum 3"},70:{name:"Tenor Drum 3 Rimshot"},71:{name:"Tenor Drum 3 Buzz Roll"},72:{name:"Tenor Drum 2"},73:{name:"Tenor Drum 2 Rimshot"},74:{name:"Tenor Drum 2 Buzz Roll"},76:{name:"Tenor Drum 1"},77:{name:"Tenor Drum 1 Rimshot"},78:{name:"Tenor Drum 1 Buzz Roll"},79:{name:"Tenor Drum Spock"},80:{name:"Tenor Drum Spock Rimshot"},81:{name:"Tenor Drum Hi"},82:{name:"Tenor Drum Lo"},83:{name:"Tenor Stick Click"}}},3:{id:"hip_hop_drum_set","midi-unpitched":!0,instruments:{36:{name:"Kick"},39:{name:"Snare"},40:{name:"Clap"},43:{name:"Hi Hat Closed"},47:{name:"Hi Hat Open"},50:{name:"Crash Cymbal"},57:{name:"Misc Perc. 1"},66:{name:"Misc Perc. 2"}}},4:{id:"suspended_cymbal","midi-unpitched":!0,instruments:{60:{name:"Suspended Cymbal"}}},5:{id:"finger_snap","midi-unpitched":!0,instruments:{60:{name:"Finger Snap"}}},6:{id:"gong","midi-unpitched":!0,instruments:{59:{name:"Gong Forte"},60:{name:"Gong Fortissimo"},61:{name:"Gong Short 1"},62:{name:"Gong Short 2"},63:{name:"Gong Short 3"}}},7:{id:"claves","midi-unpitched":!0,instruments:{59:{name:"Clave Piano"},60:{name:"Clave Forte"}}},8:{id:"concert-bass-drum","midi-unpitched":!0,instruments:{59:{name:"Bass Drum 1"},60:{name:"Bass Drum 2"}}},9:{id:"wind_chimes","midi-unpitched":!0,instruments:{57:{name:"Short Glissando Down"},58:{name:"Medium Glissando Down"},59:{name:"Long Glissando Down"},60:{name:"Short Glissando Up"},61:{name:"Medium Glissando Up"},62:{name:"Long Glissando Up"}}},10:{id:"nagado_drums","midi-unpitched":!0,children:{velocity_p:{id:"nagado_drums_soft"},velocity_f:{id:"nagado_drums_strong"}}},11:{id:"woodblocks","midi-unpitched":!0},49:{id:"orchestral_drumset","midi-unpitched":!0,children:{velocity_p:{id:"orchestral_drumset_soft"},velocity_f:{id:"orchestral_drumset_strong"}}},80:{id:"starwars_set","midi-unpitched":!0,instruments:[{name:"Blaster",unpitched:636},{name:"Lightsaber On",unpitched:637},{name:"Lightsaber Off",unpitched:638},{name:"R2D2",unpitched:639},{name:"Vader Breath",unpitched:640},{name:"I Am Your Father",unpitched:641},{name:"Chewbacca",unpitched:642},{name:"X Wing",unpitched:643},{name:"Tie Fighter",unpitched:644},{name:"Tie Fire",unpitched:645}]},101:{id:"premium_default_drum_set","midi-unpitched":!0,children:{velocity_p:{id:"premium_default_drum_set_soft"},velocity_f:{id:"premium_default_drum_set_strong"}}},102:{id:"marching_bass_drums_hq","midi-unpitched":!0,children:{velocity_f:{id:"marching_bass_drums_hq_strong"}}},103:{id:"marching_cymbals_hq","midi-unpitched":!0,children:{velocity_f:{id:"marching_cymbals_hq_strong"}}},104:{id:"marching_snare_hq","midi-unpitched":!0,children:{velocity_p:{id:"marching_snare_hq_soft"},velocity_f:{id:"marching_snare_hq_strong"}}},105:{id:"marching_tenor_hq","midi-unpitched":!0,children:{velocity_p:{id:"marching_tenor_hq_soft"},velocity_f:{id:"marching_tenor_hq_strong"}}}};var Qi=v(595382),Qs=v(138717),R=v(724095),Nt=v(723631),T=v(123491),Xe=v(351277),St=Math.pow;const y={};y.EPSILON=St(2,-30),y.TEMPO_DEFAULT=80,y.TEMPO_MAX=500,y.GRACE_RATIO=.2,y.ARPEGGIO_DURATION=.1,y.TEMPORARY_AMP=1.73,y.oscWaves={0:"sine",1:"square",2:"sawtooth",3:"triangle"},y.NoteName={C0:12,D0:14,E0:16,F0:17,G0:19,A0:21,B0:23,C1:24,D1:26,E1:28,F1:29,G1:31,A1:33,B1:35,C2:36,D2:38,E2:40,F2:41,G2:43,A2:45,B2:47,C3:48,D3:50,E3:52,F3:53,G3:55,A3:57,B3:59,C4:60,D4:62,E4:64,F4:65,G4:67,A4:69,B4:71,C5:72,D5:74,E5:76,F5:77,G5:79,A5:81,B5:83,C6:84,D6:86,E6:88,F6:89,G6:91,A6:93,B6:95,C7:96,D7:98,E7:100,F7:101,G7:103,A7:105,B7:107,C8:108,D8:110,E8:112,F8:113,G8:115,A8:117,B8:119},y.MIDINotes={},y.MapUnpitched={635:36,636:37,637:38,638:39,639:40,640:41,641:42,642:43,643:44,644:45},y.DiatonicScale=["C","D","E","F","G","A","B"],y.KeyToNote={},y.NoteToKey={},y.Keys=[],function(){let e,t,i;const n=["C","Db","D","Eb","E","F","Gb","G","Ab","A","Bb","B"],u=Object.entries(y.NoteName);for(e=21;e<=108;e++)i=(e-12)/12>>0,t=n[e%12]+i,y.KeyToNote[t]=e,y.NoteToKey[e]=t,y.Keys.push(t);for(e=0;e<u.length;e++)[y.MIDINotes[u[e][1]]]=u[e]}(),y.NoteNameToFreq=function(e){return y.MIDIToFreq(y.NoteNameToMIDI(e))},y.NoteNameToMIDI=function(e){const t=y.NoteName[e.step+e.octave];if(typeof e.alter!="undefined"){let i=Number.parseInt(e.alter,10);return Xe.default.hasQuarterToneAccidental(e)&&(i=Number.parseFloat(e.alter,10)),t+i}return t},y.freqToMIDI=function(e){return Math.round(69+12*Math.log(e/440)/Math.log(2))},y.MIDIToFreq=function(e){return 440*St(2,(Math.floor(e)-69)/12)},y.MIDIToPitchObject=function(e){e=Number.parseInt(e,10);let t=y.getKeyByValue(y.NoteName,e),i=0;if(typeof t=="undefined"&&(t=y.getKeyByValue(y.NoteName,e+1),i--),typeof t=="undefined")throw new Error("Note out of range");const s={step:t.substr(0,1),octave:Number.parseInt(t.substr(1,1),10)};return i&&(s.alter=i),s},y.MIDIToPitchObjectForQuarterTone=function(e){const t=Number.parseInt(e,10);let i=y.getKeyByValue(y.NoteName,t),s=0;if(typeof i=="undefined"&&(i=y.getKeyByValue(y.NoteName,t+1),s--),typeof i=="undefined")throw new Error("Note out of range");const r={step:i.substr(0,1),octave:Number.parseInt(i.substr(1,1),10)};return s&&(r.alter=s),Number.isInteger(e)||(r.alter+=.5),r},y.NoteStrToNoteObj=function(e,t){const i={};return i.step=e.substr(0,1),i.octave=Number.parseInt(e.substr(1,1),10),i.alter=t,i},y.isQuarterToneMIDIValue=function(e){return typeof e=="number"&&!Number.isInteger(e)},y.normalizePitch=function(e,t=0){const i=e.alter?Number(e.alter):0;let s={step:e.step,octave:Number(e.octave)};const r=this.NoteNameToMIDI(e)+t;return typeof this.getKeyByValue(y.NoteName,r)=="undefined"&&(Math.abs(i)===1||Math.abs(i)===.5)?(s.alter=i,s):(s=this.MIDIToPitchObject(r),s)},y.velocityToVolume=function(e){return .7086614173228346*e/100},y.gainToVelocity=function(e){return Math.round(e*100/.7086614173228346)},y.decibelsToMIDIVelocity=function(e){return y.gainToVelocity(St(10,e/20))},y.MIDIVelocityToDecibels=function(e){let t=y.velocityToVolume(e);return t<.01&&(t=.01),Math.log10(t)*20},y.adjustVelocityWithDbs=function(e,t){if(t!==0){let i=y.MIDIVelocityToDecibels(e);i+=t,e=y.decibelsToMIDIVelocity(i)}return e},y.getFinalSustainedVolume=function(e){return y.velocityToVolume(e)*y.TEMPORARY_AMP},y.exportMIDIVelocity=function(e){let t=y.MIDIVelocityToDecibels(e+4);return t=t<-26.4?-26.4:t,t=t>-.81?-.81:t,Math.floor(t*5+132)},y.chain=function(...e){for(let t=e.length-1;t>=1;--t)e[t-1].connectTo(e[t])},y.epsEqu=function(e,t){return Math.abs(e-t)<y.EPSILON},y.roundAccurate=function(e){const t=Math.round(e);return y.epsEqu(t,e)?t:e},y.roundDecimal=function(e,t=St(10,12)){return Math.round(e*t)/t},y.isFunction=function(e){return e&&{}.toString.call(e)==="[object Function]"},y.isMediaElement=function(e){return e instanceof HTMLElement&&(e.nodeName==="AUDIO"||e.nodeName==="VIDEO")},y.trueModulo=function(e,t){return(e%t+t)%t},y.getGCD=function(e){const t=e.length;let i=e[0];for(let s=1;s<t;s++){let r=e[s];if(i<0||r<0)return 1;for(;i&&r;)i>r?i%=r:r%=i;i+=r}return i},y.getLCM=function(e){const t=e.length;let i=Math.abs(e[0]);for(let s=1;s<t;s++){let r=Math.abs(e[s]);const n=i;for(;i&&r;)i>r?i%=r:r%=i;i=Math.abs(n*e[s])/(i+r)}return i},y.pitchObjectToGuitarString=function(e){return T.default.hasFretData(e)?T.default.getString(e):0},y.minArray=function(e){return e.reduce((t,i)=>t<i?t:i)},y.maxArray=function(e){return e.reduce((t,i)=>t>i?t:i)},y.floatPart=function(e){return e-this.intPart(e)},y.intPart=function(e){return Number.parseInt(e,10)},y.deepCopy=function(e){return e&&JSON.parse(JSON.stringify(e))},y.getKeyByValue=function(e,t){return Object.keys(e).find(i=>e[i]===t)},y.arrayUnique=function(e){const t=e.concat();for(let i=0;i<t.length;++i)for(let s=i+1;s<t.length;++s)t[i]===t[s]&&t.splice(s--,1);return t},y.mergeArrays=function(e,t){const i=e.concat(t);return this.arrayUnique(i)},y.groupArrayBy=function(e,t){return e.reduce((i,s)=>((i[s[t]]=i[s[t]]||[]).push(s),i),{})};const g=y,ai=x("dacapo:utils:ornaments"),Ne={OrnamentSequences:{mordent:[0,1,0],lowerMordent:[0,-1,0],longMordent:[1,0,1,0,1,0,1,0],longLowerMordent:[1,0,1,0,1,0,-1,0],belowApproachMordent:[-1,0,1,0,1,0,1,0],aboveApproachMordent:[1,0,-1,0,1,0,1,0],belowApproachLowerMordent:[-1,0,1,0,1,0,-1,0],aboveApproachLowerMordent:[1,0,-1,0,1,0,-1,0],belowDepartureMordent:[1,0,1,0,-1,-2,-1,0],aboveDepartureMordent:[1,0,1,0,1,2,1,0],turn:[1,0,-1,0],lowerTurn:[-1,0,1,0]},OrnamentalSequencesPropertyNames:[R.A.TRILLMARK,R.A.MORDENT,R.A.INVERTED_MORDENT,R.A.TURN,R.A.INVERTED_TURN],getNextDiatonicNote(o){const e=g.normalizePitch(o);let t=g.DiatonicScale.indexOf(e.step);return++t>=g.DiatonicScale.length?(e.octave+=1,e.step=g.DiatonicScale[0]):e.step=g.DiatonicScale[t],g.normalizePitch(e)},getDiatonicNoteWithDiff(o,e,t=0){ai(`[getDiatonicNoteWithDiff], pitch ${JSON.stringify(o)}, diff ${e}, transpo ${t}`);const i=g.normalizePitch(o,t),s=g.DiatonicScale.indexOf(i.step),r=g.DiatonicScale.length,n=s+e,u=g.trueModulo(n,r);return i.octave+=Math.floor(n/r),i.step=g.DiatonicScale[u],o.alter===0&&e===0&&(i.alter=0),i},getTrillNotePitch(o,e={fifths:0}){const t=Qi.A.normalize(o,e);return Qi.A.shiftDiatonicUp(t,e)},isInvertedMordent(o){return o===R.A.INVERTED_MORDENT||o===R.A.TURN},invertSequence(o){return o.map(e=>-e)},getFirstOrnamentalSequenceName(o){for(let e=0;e<this.OrnamentalSequencesPropertyNames.length;e++){const t=this.OrnamentalSequencesPropertyNames[e];if(o[t])return t}return null},isOrnamentalSequence(o){return o===R.A.TRILLMARK||o===R.A.MORDENT||o===R.A.INVERTED_MORDENT||o===R.A.TURN||o===R.A.INVERTED_TURN},hasOrnamentalSequence(o){return o[R.A.TRILLMARK]||o[R.A.MORDENT]||o[R.A.INVERTED_MORDENT]||o[R.A.TURN]||o[R.A.INVERTED_TURN]},buildOrnamentalPitchOffsetSequence(o,e){const t=e.transposition||0;ai(`getOrnamentalSequence for [${o}] with options %O with a transposition of ${t}`,e);let i=[],s=[0,1];e.long===Qs.A.YES&&(i=[1,0,1,0,1]),(o===R.A.MORDENT||o===R.A.TURN)&&(s=this.invertSequence(s)),e.approach===Nt.A.ABOVE?i[2]=-1:e.approach===Nt.A.BELOW&&(i[0]=-1),e.departure===Nt.A.ABOVE?s=[0,-1,-2,-1]:e.departure===Nt.A.BELOW&&(s=[0,1,2,1]),o===R.A.TURN?i[0]=1:o===R.A.INVERTED_TURN&&(i[0]=-1);const r=i.concat(s);return ai("final sequence diff %o",r),r},getOrnamentalPitchSequence(o,e){const t=e.originalPitch,i=e.transposition||0,r=this.buildOrnamentalPitchOffsetSequence(o,e).map(n=>this.getDiatonicNoteWithDiff(t,n,i));return r.push(this.getDiatonicNoteWithDiff(t,0,i)),r},getOrnamentalMIDISequence(o,e,t={currentAccidental:null,previousAccidentals:{},fifths:0}){const i=e.originalPitch,s=e.transposition||0,n=this.buildOrnamentalPitchOffsetSequence(o,e).map(u=>this.convertPitchOffsetToMIDINote(i,u,s,t));return n.push(this.convertPitchOffsetToMIDINote(i,0,s,t)),n},convertPitchOffsetToMIDINote(o,e,t,i){const s=this.getDiatonicNoteWithDiff(o,e,t),r=`${s.step}${s.octave}`;return i.previousAccidentals[r]?s.alter=Xe.default.accidentalToAlter(i.previousAccidentals[r]):i.fifths&&(s.alter=Xe.default.stepToAlter(s.step,i.fifths)),g.NoteNameToMIDI(s)}},qe={checkMIDIRange(o){if(o>127&&(o=g.MapUnpitched[o]||129),o>127||o<0)throw new Error("Note out of range");return o},getPlayingMode(o){return o.mode?o.mode:o.pizzicato?"pizzicato":"default"}};var Ze=v(603581),et=v(735178),Pt=v(956112),Mt=v(995677),Ce=v(612040),ui=v(832560),I=v(701387),tt=v(110976),xt=v(536949),Yi=v(447819),B=v(952818),Ys=v(496819),ke=v(782615);const li={MIN:0,MAX:127},se={VELOCITY_DEFAULT:50,WEDGE_DEFAULT_DELTA:30,MINIMUM_VELOCITY:4,MAXIMUM_VELOCITY:127},Dt={ppp:9,pp:16,p:25,mp:35,mf:50,f:70,ff:99,fff:127,sfz:99,rfz:99,fp:25,pf:70},Ki={pizzicato:xt.A,mute:Yi.A},Ks={pizzicato:Ze.A.ARCO,mute:Pt.A.NO};function Js(o,e,t){let i,s;if(o[e]&&(s=o[e].length,s>0))if(typeof t!="undefined"){for(i=s-1;i>=0;i--)if(o[e][i].measureId===t)return o[e][i]}else return o[e][s-1];return null}function Xs(o,e){const t=I.default.getNotes(o),i={};for(let s=0;s<t.length;s++){const r=t[s];if(r.staff===e){const n=T.default.getVoiceIdx(r);typeof i[n]=="undefined"&&(i[n]=[]),i[n].push(r)}}return i}function Zs(o,e){const t=I.default.getNotes(o),i={};for(let s=0;s<t.length;s++){const r=t[s];if(T.default.getStaffIdx(r)===e){const n=T.default.getVoiceIdx(r);i[n]=o}}return i}function er(o,e,t){return I.default.getNotes(o).some(s=>T.default.getVoiceIdx(s)===t&&T.default.getStaffIdx(s)===e)}function tr(o){return new ui.A(o).getVoicesIndexes()}function Ji(o,e){return o.note.reduce((t,i)=>T.default.getVoiceIdx(i)===e?t+1:t,0)}function ir(o,e,t=0){return o.note.slice(t).reduce((s,r)=>!r.chord&&r.duration&&T.default.getVoiceIdx(r)===e?s+1:s,0)}function sr(o,e=0){const t=I.default.getDivisionsPerQuarter(o),i=g.groupArrayBy(o.note,"voice"),s=Object.keys(i),r={};for(let n=0;n<s.length;n++){const u=s[n],a=i[u];let l=0;for(let h=0;h<a.length;h++){const c=a[h];if(!c.chord){l>=e&&(r[l]=!0);const m=T.default.getDuration(c)/t;l+=m}}}return Object.keys(r).length}function rr(o,e){let t=-1,i=0;const s=o.note.length,r=I.default.getDivisionsPerQuarter(o);for(let n=0;n<s;n++){const u=o.note[n];if(t===-1&&(t=T.default.getVoiceIdx(u)),!u.chord&&T.default.getVoiceIdx(u)===t){const a=T.default.getDuration(u)/r;if(i+=a,i>e)return n}}throw new Error(`The given timePos {${e}} is greater than the measure total duration`)}function nr(o,e,t=1){const i=e.getTempo(o);let s=tt.default.getQpm(i)>>0;return s=s>g.TEMPO_MAX?g.TEMPO_MAX:s,60/s*t}function hi(o){const e=I.default.getAnyTime(o),t=e.beatType||e["beat-type"];return e.beats*(4/t)}function or(o,e){const t=hi(o);return e*t}function ar(o,e,t){const{divisions:i}=o.$adagio.attributes,s=o.note,r=Ji(o,e);let n,u=0,a=0;for(n=0;n<s.length;n++){const l=s[n];if(T.default.getVoiceIdx(l)===e){if(a>=t){const m=a-t;return{noteIdx:u,realNoteIdx:n,delay:m,lastNoteInVoice:u===r-1}}const c=(l.duration||0)/i;a+=c,u++}}if(a===0)throw new Error(`The voice ${e} has not been found in measure ${o.id}`);if(t>=a)throw new Error(`initial quarterPosStart [${t}] is out of the range of the voice ${e} in measure ${o.Id}`);{const l=a-t;return{noteIdx:u-1,realNoteIdx:n-1,lastNoteInVoice:!0,delay:l}}}function Xi(o,e){const t=o[e],i=T.default.getVoiceIdx(t);for(let s=e+1;s<o.length;s++){const r=o[s];if(T.default.getVoiceIdx(r)===i)return!1}return!0}function ur(o,e,t,i){let s=!1;const r=[],n=o.measure;for(let u=t.measureIdx;u<n.length&&u<i.measureIdx+1;u++){let a=0,l=0;const h=n[u],{divisions:c}=h.$adagio.attributes,m=h.note;for(let f=0;f<m.length;f++){if(u>=i.measureIdx&&a>=i.quarterPos)return r;const p=m[f];if(T.default.getVoiceIdx(p)===e){let w=0;const D=(p.duration||0)/c;if(!s&&a+D>t.quarterPos&&(w=t.quarterPos-a,s=!0),s){const k=Xi(m,f),O={idx:l,realIdx:f,measureIdx:u,quarterFromMeasureStart:a,voiceId:e,quarterDuration:D,isLastMeasureNote:k,quarterFromNoteStart:w};r.push(O)}l++,a+=D}}}return r}function ci(o,e){const t=o.measure[e.measureIdx],i=t.note,{divisions:s}=t.$adagio.attributes;let r=0,n=0;for(let u=0;u<i.length&&n<e.noteIdx;u++){const a=i[u],l=T.default.getVoiceIdx(a);if(e.voiceIdx===l){const h=(a.duration||0)/s;r+=h,n++}}return r}function Zi(o,e,t){let i=null;for(let s=0;s<e.length;s++){const r=e[s];if(xt.A.getTimePos(r)/t>o)return i;i=r}return i}function lr(o,e,t,i){let s=null;for(let r=0;r<t.length;r++){const n=t[r];if(Ki[e].getTimePos(n)/i>o)return s;s=n}return null}function hr(o,e){let t;const i=ci(o,e);for(let s=e.measureIdx;s>=0;s--){const r=o.measure[s],n=I.default.getPizzicatos(r,e.staffIdx||0);if(n.length>0){if(s===e.measureIdx){const{divisions:u}=r.$adagio.attributes;t=Zi(i,n,u)}else t=n[n.length-1];if(t)return xt.A.getType(t)}}return Ze.A.ARCO}function cr(o,e,t){const i=ci(e,t);for(let s=t.measureIdx;s>=0;s--){const n=`get${o[0].toUpperCase()+o.slice(1)}s`,u=e.measure[s],a=I.default[n](u,t.staffIdx||0);if(a.length>0){let l=a[a.length-1];if(s===t.measureIdx){const{divisions:h}=u.$adagio.attributes;l=lr(i,o,a,h)}if(l)return Ki[o].getType(l)}}return Ks[o]}function dr(o,e){let t;for(t=e.note.length-1;t>=0;t--)if(!e.note[t].chord&&T.default.getVoiceIdx(e.note[t])===o)return t;return 0}function mr(o,e,t){for(;e>0;){const i=o[e];if(!i.chord&&T.default.getVoiceIdx(i)===t)return e;e--}return 0}function fr(o){return o.reduce((e,t)=>{const i=B.A.getStaffIdx(t);return(e[i]=e[i]||[]).push(t),e},{})}function pr(o,e=1){return o.reduce((t,i)=>{const s=B.A.getTimePos(i)/e;return(t[s]=t[s]||[]).push(i),t},{})}function gr(o,e,t){return o.concat(e).sort((s,r)=>B.A.getTimePos(s)-B.A.getTimePos(r)).reduce((s,r)=>{const n=B.A.getTimePos(r)/t,u=B.A.getType(r);return s[n]=s[n]||{},u===et.A.WEDGE?(typeof s[n][u]=="undefined"&&(s[n][u]=[]),s[n][u].push(r)):s[n][u]=r,s},{})}function di(o){const e=Ys.A.getStyle(o),t=Dt[e];return typeof t!="undefined"?t:se.VELOCITY_DEFAULT}function es(o,e,t){return e*=t===Mt.A.CRESCENDO?1:-1,Math.max(Math.min(o+e,li.MAX),se.MINIMUM_VELOCITY)}function ts(o,e){return es(o,se.WEDGE_DEFAULT_DELTA,e)}function yr(o,e,t){const i=e-o;return Math.abs(i)/t}function br(o,e,t=0,i){const s=I.default.getDivisionsPerQuarter(o);return o.note.filter(n=>{const u=T.default.getTimePos(n)/s;return T.default.getStaffIdx(n)===e&&u>=t&&(typeof i=="undefined"||u<=i.timePos)})}function Tr(o){let e=0;return o.forEach(t=>{t.duration&&!t.chord&&e++}),e}function vr(o,e){if(!e)return!1;const t=e.wedgeArray;if(e.ongoingWedge){const s=e.ongoingWedge.stop;if(s.measure>o.measureIdx||s.time>o.quarterPos)return!0}if(t.length===0)return!1;const i=t[t.length-1];return i.stop.measure>o.measureIdx||i.stop.measure===o.measureIdx&&i.stop.time>o.quarterPos}function Ir(o,e,t,i){let s=t;for(;s>=0;s--){const r=o.measure[s];let n=I.default.getWedges(r,e);if(s===t&&n.length>0){const u=I.default.getDivisionsPerQuarter(r);n=n.filter(a=>B.A.getTimePos(a)/u<=i)}if(n.length>0){const u=I.default.getDivisionsPerQuarter(r),a=n[n.length-1],l=B.A.getTimePos(a)/u;return{measureIdx:s,quarterPos:l,wedge:a}}}return null}function Nr(o,e){let t=e.measureIdx;for(e.quarterPos===0&&t--;t>=0;t--){const i=o.measure[t];let s=I.default.getDynamics(i,e.staffIdx);if(t===e.measureIdx&&s.length>0){const r=I.default.getDivisionsPerQuarter(i);s=s.filter(n=>B.A.getTimePos(n)/r<e.quarterPos)}if(s.length>0){const r=I.default.getDivisionsPerQuarter(i),n=s[s.length-1],u=B.A.getTimePos(n)/r;return{measureIdx:t,quarterPos:u,dynamic:n}}}return null}function Sr(o,e,t,i,s){const r=I.default.getWedges(o,t);if(r.length>0){const n=I.default.getDivisionsPerQuarter(o),u=r.find(a=>{const l=B.A.getTimePos(a)/n;return!(l<s.timePos||ke.A.getLocation(B.A.getWedge(a))!==Ce.A.RIGHT||e===s.measureIdx&&l===s.timePos)});if(u){const a=I.default.getDynamics(o,t),l=B.A.getTimePos(u);if(a.length>0){const c=a.find(m=>B.A.getTimePos(m)===l);if(typeof c!="undefined")return{velocity:di(c),timePos:l/n}}return{velocity:ts(s.velocity,i),timePos:l/n}}}}function Pr(o){const e=o.nbNotes-o.stepsRemaining,t=o.type===Mt.A.CRESCENDO?1:-1,i=o.velocityInterval*e*t;return o.start.velocity+i}function Mr(o){const e=o[et.A.WEDGE];return typeof e=="undefined"?!1:e.some(t=>{const i=B.A.getWedge(t);return ke.A.getLocation(i)===Ce.A.RIGHT})}function xr(o,e,t){let i=t.measure[e.measureIdx];const s=hi(i);if(e.timePos===s&&e.measureIdx+1<t.measure.length){e.measureIdx++,e.timePos=0,i=t.measure[e.measureIdx];const n=I.default.getDynamics(i,o).find(u=>B.A.getTimePos(u)===0);return typeof n!="undefined"&&(e.velocity=di(n)),!0}return!1}function Dr(o,e){const t=o.measure[e.measureIdx],i=I.default.getDivisionsPerQuarter(t),s=[];for(let r=0;r<t.note.length;r++){const n=t.note[r];if(T.default.getStaffIdx(n)===e.staffIdx){const u=T.default.getTimePos(n)/i;if(u===e.timePos&&s.push(n),u>e.timePos)return s}}return s}function wr(o){const e=[];for(let t=0;t<o.length;t++){const i=o[t];i!==null&&e.push(i.noteId)}return e}const C={searchForTag:Js,copyMeasureNotesByVoiceForStaffIdx:Xs,getVoicesInStaff:Zs,staffInMeasureContainsVoice:er,getMeasureVoices:tr,getNoteCountForVoice:Ji,getChordCountForVoice:ir,getChordCountFromTimePos:sr,timePosToRawNoteIdx:rr,getUnitDurationForMeasure:nr,getMeasureQuarterDuration:hi,getMeasureDuration:or,getSingleNoteInfoAtQuarterPos:ar,isLastMeasureNote:Xi,getVoiceElementsInRange:ur,getNoteQuarterPosFromMeasureStart:ci,getLastPizzicatoBeforeQuarterPos:Zi,getLastPizzicatoType:hr,getLastMeasureMode:cr,getLastNoteFromVoice:dr,getNoteIdxOfFirstChordNote:mr,groupDirectionsByStaffIdx:fr,groupDirectionsByTime:pr,mergeDynamicsAndWedgesByTime:gr,convertDynamicDirectionToVelocity:di,capWedgeVelocity:es,getWedgeDefaultStopVelocity:ts,computeVelocityStepInWedge:yr,filterMeasureNotesInWedge:br,getNbChordsInNotesArray:Tr,locationIsInWedgeRange:vr,getLastWedgeFrom:Ir,getLastDynamicBefore:Nr,findWedgeStopInMeasure:Sr,computeCurrentVelocityFromOngoingWedge:Pr,containsWedgeStop:Mr,updateWedgeStopIfEndTimePos:xr,getNotesAtTimePos:Dr,extractNoteIdsFromResults:wr};function Ar(o){return o===0&&1/o===Number.NEGATIVE_INFINITY}function is(o,e){return o===null?0:Ar(o)?e:o<=-e?0:o<0?e+o%e:Math.min(e,o)}function Er(o,e,t){const{length:i}=o[0],s=new AudioBuffer({length:i,numberOfChannels:e||2,sampleRate:t||44100});for(let r=0,n=o.length;r<n;r++){const u=o[r],a=u instanceof Float32Array?u:new Float32Array(u);s.getChannelData(r).set(a)}return s}const Se={concatBuffers(o,e,t=0){t<0&&(t+=o.length);for(let i=0;i<o.numberOfChannels;i++){const s=o.getChannelData(i),r=e.getChannelData(i);for(let n=t,u=0;n<o.length&&u<e.length;n++,u++)s[n]+=r[u]}return o},slice(o,e,t){if(e=e?is(e,o.length):0,t=t?is(t,o.length):o.length,t-e===0)return o;const i=[];for(let s=0;s<o.numberOfChannels;s++){const r=o.getChannelData(s);i.push(r.slice(e,t))}return Er(i,o.numberOfChannels,o.sampleRate)},trimRight(o,e=0){let t=0;e=Math.abs(e);for(let i=0,s=o.numberOfChannels;i<s;i++){const r=o.getChannelData(i);for(let n=r.length-1;n>=0&&!(n<t);n--)if(Math.abs(r[n])>e){t=n+1;break}}return this.slice(o,0,t)},convertBlobToArrayBuffer(o){if(o.arrayBuffer)return o.arrayBuffer();const e=new FileReader,t=new Promise((i,s)=>{e.onloadend=()=>{i(e.result)},e.onerror=()=>{s(e.error)}});return e.readAsArrayBuffer(o),t}};class Or{constructor(){this.init()}init(){const{context:e}=d;if(e){try{this.input=e.createGain()}catch(t){throw new _i(e)}this.inputGain=e.createGain(),this.output=e.createGain(),this.outputGain=e.createGain(),this.bypassed=!1,this.input.connect(this.inputGain),this.inputGain.connect(this.outputGain),this.outputGain.connect(this.output)}}connectTo(e){if(Object.prototype.toString.call(e.input)==="[object GainNode]")return this.output.connect(e.input),e;throw new Zt(this,e)}connect(e){this.output.connect(e)}disconnect(){this.output.disconnect()}setGain(e){this.outputGain.gain.value=e}getGain(){return this.outputGain.gain.value}isBypassed(){return this.bypassed}bypass(){this.bypassed||(this.bypassed=!0,this.outputGain.disconnect(),this.input.connect(this.output))}use(){this.bypassed&&(this.bypassed=!1,this.input.disconnect(),this.input.connect(this.inputGain),this.outputGain.connect(this.output))}disconnectAll(){this.inputGain.disconnect(),this.input.disconnect(),this.output.disconnect(),this.outputGain.disconnect()}}const ce=Or;class Cr extends ce{constructor(){const{context:e}=d;super(),this.compressor=e.createDynamicsCompressor(),this.inputGain.disconnect(),this.inputGain.connect(this.compressor),this.compressor.connect(this.outputGain),this.muted=!1}setThreshold(e){this.compressor.threshold.setValueAtTime(e,0)}mute(){this.muted=!0,this.inputGain.gain.value=0}unmute(){this.muted=!1,this.inputGain.gain.value=1}isMuted(){return this.muted}disconnectAll(){super.disconnectAll(),this.compressor.disconnect()}dispose(){this.disconnectAll(),this.compressor=null,this.input=null,this.inputGain=null,this.outputGain=null,this.output=null}}const kr=Cr;class Rr extends ce{constructor(){super(),this.muted=!1}mute(){this.muted=!0,this.inputGain.gain.value=0}unmute(){this.muted=!1,this.inputGain.gain.value=1}isMuted(){return this.muted}}const _r=Rr;var ss=Math.pow;class Vr extends ce{constructor(){super(),this.init()}init(){super.init(),this.instanciateNewConvolver(),this.active=!1,this.reverse=!1,this.seconds=0,this.decay=1}buildImpulse(){const e=d.context.sampleRate,t=e*this.seconds>>0,{decay:i}=this;let s,r,n,u,a;if(t>0){if(this.convolver&&this.convolver.buffer&&this.convolver.buffer.length===t)return;for(this.use(),this.removeCurrentConvolver(),this.instanciateNewConvolver(),s=d.context.createBuffer(2,t,e),r=s.getChannelData(0),n=s.getChannelData(1),a=0;a<t;a++)u=this.reverse?t-a:a,r[a]=(Math.random()*2-1)*ss(1-u/t,i),n[a]=(Math.random()*2-1)*ss(1-u/t,i);this.convolver.buffer=s}else this.bypass(),this.convolver.buffer=null}removeCurrentConvolver(){this.convolver.disconnect(),this.inputGain.disconnect(),this.convolver=null}instanciateNewConvolver(){this.convolver=d.context.createConvolver(),this.inputGain.connect(this.convolver),this.convolver.connect(this.outputGain)}getDuration(){return this.seconds}setDuration(e){this.seconds=e,this.buildImpulse()}getDecay(){return this.decay}setDecay(e){this.decay=e,this.buildImpulse()}isReverse(){return this.reverse}setReverse(e){this.reverse=e,this.buildImpulse()}isActive(){return this.active}dispose(){this.disconnectAllNodes(),this.input=null,this.inputGain=null,this.convolver=null,this.output=null,this.outputGain=null}disconnectAllNodes(){this.input.disconnect(),this.inputGain.disconnect(),this.convolver.disconnect(),this.output.disconnect(),this.outputGain.disconnect()}renewWebAudioNodes(){this.disconnectAllNodes(),super.init(),this.instanciateNewConvolver(),this.buildImpulse()}}const mi=Vr;class $r extends ce{constructor(){super(),this.a=.005,this.d=.015,this.s=.35,this.r=.05,this.rateDecay=-this.d/Math.log(.001),this.rateRelease=-this.r/Math.log(.001),this.active=!1}getAttack(){return this.a}setAttack(e){this.a=e}getDecay(){return this.d}setDecay(e){this.d=e,this.rateDecay=-this.d/Math.log(.001)}getSustain(){return this.s}setSustain(e){this.s=e}getRelease(){return this.r}setRelease(e){this.r=e,this.rateRelease=-this.r/Math.log(.001)}isActive(){return this.active}noteOn(e){const t=e||d.context.currentTime,i=this.inputGain.gain;i.cancelScheduledValues(t),i.setValueAtTime(0,t),i.linearRampToValueAtTime(1,t+this.a),i.setTargetAtTime(this.s,t+this.a,this.rateDecay),this.active=!0}noteOff(e){const t=e||d.context.currentTime,i=this.inputGain.gain;i.cancelScheduledValues(t),i.setTargetAtTime(0,t,this.rateRelease),this.active=!1}}const Lr=$r;class Fr{constructor(){this.initGenerator()}initGenerator(){const{context:e}=d;this.displayName="",e&&e.createGain!==void 0?(this.outputGain=e.createGain(),this.output=e.createGain(),this.outputGain.connect(this.output)):(this.outputGain=null,this.output=null),this.active=!0}setName(e){this.displayName=e}getName(){return this.displayName}connectTo(e){if(Object.prototype.toString.call(e.input)==="[object GainNode]")return this.output.connect(e.input),e;throw new Zt(this,e)}connect(e){this.output&&this.output.connect(e)}disconnect(){this.output&&this.output.disconnect()}switchOn(){this.active||(this.active=!0,this.outputGain&&this.output&&this.outputGain.connect(this.output))}switchOff(){this.active&&(this.active=!1,this.outputGain&&this.outputGain.disconnect())}isOn(){return this.active}setVolume(e){this.outputGain&&(this.outputGain.gain.value=e)}getVolume(){return this.outputGain?this.outputGain.gain.value:1}}const Ue=Fr;class Br extends Ue{constructor(){super(),this.nodes=[],this.playingOsc=[],this.modTarget={freq:null,gain:null},this.setType(0),this.switchOn()}setFrequency(e){return e===void 0?!1:(this.osc.frequency.cancelScheduledValues(0),this.osc.frequency.setValueAtTime(e,0),!0)}getFrequency(){return this.osc.frequency.value}setType(e){if(typeof e=="string")this.type=e;else if(typeof e=="number")if(e=Number.parseInt(e,10),e>=0&&e<=3)this.type=g.oscWaves[e];else return!1;else return!1;return!0}getType(){return this.osc.frequency.type}setMIDINote(e){this.setFrequency(g.MIDIToFreq(e))}playNote(e,t){const i=d.context.createOscillator(),s=d.context.createGain();s.connect(this.outputGain),i.type=this.type,i.frequency.setValueAtTime(g.MIDIToFreq(e),0),i.connect(s),s.gain.value=1,i.start(d.context.currentTime),this.playingOsc.push({osc:i,gain:s});const r=this.playingOsc.length-1;return typeof t!="undefined"&&t!==null&&t!==0&&(s.gain.linearRampToValueAtTime(.01,d.context.currentTime+t),this.playingOsc[r].timerId=$.setTimeout(()=>{i.stop(0),s.disconnect(),i.disconnect()},d.context.currentTime+t*1e3)),r}instantPlayNote(e){const t=d.context.createOscillator(),i=d.context.createGain();i.connect(this.outputGain),t.type=this.osc.type,t.frequency.setValueAtTime(g.MIDIToFreq(e),0),t.connect(i),t.start(d.context.currentTime),i.gain.value=1}stopNote(e){const t=this.playingOsc[e];t.osc.stop(0),t.osc.disconnect(),t.gain.disconnect(),$.clearTimeout(t.timerId)}stopNotes(){for(let e=0;e<this.playingOsc.length;e++)this.playingOsc[e]!==null&&this.stopNote(e);this.playingOsc=[]}getMIDINote(){return g.FreqToMIDI(this.getFrequency())}slideFreq(e,t){this.osc.frequency.setValueAtTime(this.getFrequency(),d.context.currentTime),this.osc.frequency.linearRampToValueAtTime(e,d.context.currentTime+t)}}const rs=Br;class qr extends rs{constructor(e){super(),this.init(e)}init(e){this.osc=d.context.createOscillator(),this.setFrequency(e)}start(e=0){this.osc.start(e)}stop(e=0){this.osc.stop(e)}setFrequency(e){this.osc.frequency.setValueAtTime(e,0)}connect(e){this.osc.connect(e)}}const fi=qr;ce.Mixer=kr,ce.Fader=_r,ce.Reverb=mi,ce.ADSR=Lr,ce.LFO=fi;const ns=ce,ae={mainOutput:null,initOutput(){if(d.context)return this.mainOutput=new ns.Mixer,this.mainOutput.connect(d.context.destination),!0;throw new he},dispose(){this.mainOutput&&this.mainOutput.dispose()}},wt={CONTEXT_DELAY:.4},pi={tremolo:{pattern:[{durationDiff:-2e-4,attack:.015},{durationDiff:4e-4,attack:.008},{durationDiff:-3e-4,attack:.01,filters:[{type:"peaking",frequencyMultiplier:4.2,q:20,gain:20},{type:"peaking",frequencyMultiplier:4,q:10,gain:7},{type:"peaking",frequencyMultiplier:3,q:10,gain:4}]},{durationDiff:2e-4,attack:.01},{durationDiff:0,attack:.005},{durationDiff:1e-4,attack:.015,filters:[{type:"peaking",frequencyMultiplier:2.5,q:40,gain:30},{type:"peaking",frequencyMultiplier:3.2,q:30,gain:20}]},{durationDiff:1e-4,attack:.009,filters:[{type:"peaking",frequencyMultiplier:2.7,q:40,gain:25}]},{durationDiff:0,attack:.02},{durationDiff:-2e-4,attack:.005},{durationDiff:2e-4,attack:.006},{durationDiff:0,attack:.002},{durationDiff:0,attack:.002},{durationDiff:-1e-4,attack:.002},{durationDiff:3e-4,attack:.003}]}},gi={COUNT_IN:0,CONTINUOUS:1,DISABLED:2,CONTINUOUS_NO_COUNT_IN:3},Ur={NORMAL:"normal",PIZZICATO:"pizzicato",MUTED:"mute"},G={WINDOW_SIZE:2,LOADING_DELAY:.1,SCHEDULING_INTERVAL:500,DEFAULT_OCTAVE:4,GRACE_RATIO:.2,ACCACCIATURA_DURATION:.04,DEFAULT_DURATION_ADJUSTMENT:-.2};var zr=Math.pow;const de={};de.EPSILON=zr(2,-30),de.INNER_TICKS_PER_QUARTER_NOTE=480,de.DEFAULT_TEMPO=120,de.ChannelEvent={},de.ChannelEvent.TYPE={NOTE_OFF:8,NOTE_ON:9,NOTE_AFTERTOUCH:10,CONTROLLER:11,PROGRAM_CHANGE:12,CHANNEL_AFTERTOUCH:13,PITCH_BEND:14,NON_MUSICAL_COMMAND:15},de.MIDICommands={128:"noteOff",129:"noteOff",130:"noteOff",131:"noteOff",132:"noteOff",133:"noteOff",134:"noteOff",135:"noteOff",136:"noteOff",137:"noteOff",138:"noteOff",139:"noteOff",140:"noteOff",141:"noteOff",142:"noteOff",143:"noteOff",144:"noteOn",145:"noteOn",146:"noteOn",147:"noteOn",148:"noteOn",149:"noteOn",150:"noteOn",151:"noteOn",152:"noteOn",153:"noteOn",154:"noteOn",155:"noteOn",156:"noteOn",157:"noteOn",158:"noteOn",159:"noteOn",160:"afterTouch",176:"continuousController",192:"patchChange",208:"channelPressure",224:"pitchBend",240:"nonMusicalCommand"},de.TimeSignature={},de.TimeSignature.isCompound=function(e){return e.beats%3===0&&e.beats>3},de.epsEqu=function(e,t){return Math.abs(e-t)<de.EPSILON};const Te=de;class it{constructor(e,t){this.num=e,this.den=t}static fromTicks(e,t){return new it(e,t*4)}copy(){return new it(this.num,this.den)}value(){return this.num/this.den}toTicks(e){typeof e=="undefined"&&(e=480);const t=e*4/this.den;return Math.floor(this.num*t)}reduce(){const e=g.getGCD([this.num,this.den]);return e===0&&(this.num=0,this.den=1),this.num/=e,this.den/=e,this}add(e){const t=g.getLCM([this.den,e.den]);return this.num=t/this.den*this.num+t/e.den*e.num,this.den=t,this}sub(e){const t=g.getLCM([this.den,e.den]);return this.num=t/this.den*this.num-t/e.den*e.num,this.den=t,this}mul(e){return e instanceof it?(this.num*=e.num,this.den*=e.den):typeof e=="number"&&(this.num*=e),this}div(e){return e instanceof it?(this.num*=e.den,this.den*=e.num):typeof e=="number"&&(this.den*=e),this}}const W=it;class Gr{constructor(){this.baseQuant=new W(1,8),this.minAllowedDuration=new W(1,32),this.ticksPerQuarterNote=480}adaptQuantIfDotted(e,t){const i=e.div(t).value();return i>1.45&&i<1.55&&t.div(2),t}getAdequateQuantForLength(e){let t=this.baseQuant.copy();for(;t.value()>e.value()&&t.value()>this.minAllowedDuration.value()*2;)t.div(2);return t.value()>=this.minAllowedDuration.value()*2&&(t=this.adaptQuantIfDotted(e.copy(),t.copy())),t}getAdequateQuantForTuplet(e,t){const i=e.copy().div(t);return i>=this.minAllowedDuration&&i.div(2),i}quantize(e,t){let i=e.num*t.den;const s=e.den*t.num,r=e.den*t.den;return i=Math.floor((i+s/2)/s)*s,new W(i,r).reduce()}quantizeNoteOn(e,t){let i=!1;typeof e=="number"&&(i=!0,e=W.fromTicks(e,this.ticksPerQuarterNote));const s=this.quantize(e,t);return i?s.toTicks():s}quantizeNoteOff(e,t,i){let s=!1;typeof e=="number"&&typeof t=="number"&&(s=!0,e=W.fromTicks(e,this.ticksPerQuarterNote),t=W.fromTicks(t,this.ticksPerQuarterNote));let r=this.quantize(t,i);for(;r.value()<=e.value();)i.value()>=this.baseQuant.value()?i.div(2):r=new W(e.num,e.den).add(i);return s?r.toTicks():r}quantizeValue(e){const t=W.fromTicks(e>>0,this.ticksPerQuarterNote),i=this.getAdequateQuantForLength(t);return this.quantize(t,i).toTicks(this.ticksPerQuarterNote)}quantizeWithQuant(e,t){const i=W.fromTicks(e>>0,this.ticksPerQuarterNote);return this.quantize(i,t).toTicks(this.ticksPerQuarterNote)}quantizeNote(e){let t=W.fromTicks(e.timeOn,this.ticksPerQuarterNote),i=W.fromTicks(e.timeOff,this.ticksPerQuarterNote);const s=W.fromTicks(e.duration,this.ticksPerQuarterNote),r=this.getAdequateQuantForLength(s);return t=this.quantizeNoteOn(t,r),i=this.quantizeNoteOff(t,i,r),e.setTimeOn(t.toTicks()>>0),e.setTimeOff(i.toTicks()>>0),this}setTicksPerQuarterNote(e){this.ticksPerQuarterNote=e}}const At=Gr;class Wr{constructor(e){this.release=1*44100*2,this.lengthWithoutRelease=0,this.totalLength=0,this.maxOffset=0,this.bufferResult=null,typeof e!="undefined"&&this.setScoreLength(e)}write(e,t,i,s,r){if(typeof this.bufferResult=="undefined"||typeof e=="undefined")return 0;(typeof r!="number"||Number.isNaN(r))&&(r=.8);const n=[],u=i*44100*2;let a=t*44100*2,l,h,c;if(e instanceof Float32Array)c=e;else{for(l=0;l<e.numberOfChannels;l++)n.push(e.getChannelData(l));c=this.interleaveBuffers(n)}for(h=0,l=s>>0;h<c.length&&l<this.totalLength&&h<a;l++,h++)this.bufferResult[l]=Math.min(Math.max(this.bufferResult[l]+c[h]*r,-1),1);if(l<this.totalLength&&h<c.length){a+=u;for(let m=u;h<c.length&&l<this.totalLength&&h<a;l++,h++,m--)this.bufferResult[l]=Math.min(Math.max(this.bufferResult[l]+c[h]*(m/u)*r,-1),1)}return l>this.maxOffset&&(this.maxOffset=l),h}interleaveBuffers(e){let t,i,s=0,r=0;for(t=0;t<e.length;t++)s+=e[t].length;const n=new Float32Array(s);for(t=0;t<s;t++){for(i=0;i<e.length;i++)n[t++]=e[i][r];i=0,r++}return n}finishExport(){for(let e=this.maxOffset+1;e<this.totalLength;e++)this.bufferResult[e]=0}getResult(){return this.bufferResult}setScoreLength(e){this.lengthWithoutRelease=e>>0,this.totalLength=this.lengthWithoutRelease+this.release,this.bufferResult=new Float32Array(this.totalLength)}}const jr=Wr;var os=v(353922),Hr=v(364596);const Pe={handleGetNoteNameErrors(o){if(o.message!=="Note does not exists"&&o.message!=="Note out of range")throw o},handleGetNoteErrors(o){if(o.message==="Out of range")return null;throw o}};var Et=Math.pow;const re=x("dacapo:utils"),Qr=1e-5,Yr={buildSingleSubNote(o,{pitch:e=o.pitch,duration:t=o.duration,startTime:i=o.startTime,velocity:s=o.velocity,mode:r=o.mode,holdNote:n=o.holdNote,pauseOffset:u=o.pauseOffset}={}){const a={};return a.startTime=g.roundDecimal(i,Et(10,12)),a.duration=t,a.velocity=s,a.mode=r||"default",n&&(a.holdNote=n),u&&(a.startOffset=u),o.preview&&(a.preview=!0),o.midiProgram&&(a.midiProgram=o.midiProgram),a.pitch=qe.checkMIDIRange(e),g.isQuarterToneMIDIValue(e)&&(a.pitch=Number.parseInt(e,10),a.detune=50),a},buildSlidingGlissando(o,e){return re(`build sliding glissando from notes ${e.pitch} to ${o.glissando.pitch}`),{startTime:e.startTime||0,pitch:e.pitch,duration:e.duration,velocity:e.velocity,mode:e.mode,holdNote:e.holdNote,envelope:e.envelope,automations:{pitch:[{target:o.glissando.pitch,startTime:(e.startTime||0)+(o.startTime||0),duration:o.duration-Qr}]}}},buildGlissandoNotes({ornaments:o,opts:e,instInfo:t={},notesArray:i,delays:s}){re(`build glissando for note ${e.pitch} with delays before ${s.before}, after ${s.after}`);const r=o.glissando.pitch,n=o.duration;e.startTime=e.startTime||0;const u=o.startTime+e.startTime,a=i.pop();if(e.mode=qe.getPlayingMode(e),t.glissando==="slide"&&e.mode!=="pizzicato")return e=this.buildSlidingGlissando(o,e),a&&(a.automations?a.automations.pitch?a.automations.pitch.push(...e.automations.pitch):a.automations.pitch=e.automations.pitch:a.automations=e.automations,e=a),i.push(e),i;const l=g.isQuarterToneMIDIValue(e.pitch)||g.isQuarterToneMIDIValue(r);let h=e.pitch,c=0,m=u,f=Math.abs(r-e.pitch);l&&(f*=2);let p=.05;f*p>n&&(p=n/(f+1));const M=Math.sign(r-e.pitch);let w=M;for(l&&(w=M/2),a&&a.startTime<u+p&&(this.cutNoteAt(a,u+p),i.push(a),c=o.startTime+p,m+=p,h+=w);h!==r&&Math.sign(r-h)===M;h+=w){let O=p;h===e.pitch&&e.ornamentDelay&&(O=e.ornamentDelay);try{const X=this.buildSingleSubNote(e,{pitch:h,duration:O,startTime:m});i.push(X)}catch(X){Pe.handleGetNoteNameErrors(X)}m+=O,c+=O}const D=m,k=g.roundDecimal(e.duration-c,Et(10,12));try{const O=this.buildSingleSubNote(e,{pitch:r,duration:k,startTime:D});i.push(O)}catch(O){Pe.handleGetNoteNameErrors(O)}return e.pitch=r,i},getTrillSingleNoteDuration(o){let e=.0875;return o/e<3&&(e=o/3),e},getTrillIntroDuration(o,e,t){let i=e;return t?0:(o>=e*7?i=e*2:o>=e*5&&(i=e),i)},buildTrillNotes({ornaments:o,opts:e,notesArray:t,delays:i}){e.startTime=e.startTime||0,re(`build trill for note ${e.pitch}`);const s=e.pitch;let r=o.duration+i.after,n=o.startTime+e.startTime;const u=o[R.A.TRILLMARK],a=u.keySignature||{fifths:0};e.mode=qe.getPlayingMode(e);const l=Ne.getTrillNotePitch(u.originalPitch,a),h=g.NoteNameToMIDI(l)+(u.transposition||0),c=t.pop();o.glissando&&(r/=2);const m=c.startTime+c.duration,f=c&&c.startTime<n&&m>=n,p=this.getTrillSingleNoteDuration(r),M=this.getTrillIntroDuration(r,p,f);c&&c.startTime<n&&(this.cutNoteAt(c,n),t.push(c));const w=(r-M)/p>>0,D=w/2,k=5;if(M){const O=this.buildSingleSubNote(e,{pitch:s,duration:M,startTime:n});O.velocity+=k,O.envelope={attack:.01,shortenRatio:.1},t.push(O),n+=M}for(let O=0;O<w;O++){const X=O%2===0?h:s,z=Math.random()*2e-4+p-1e-4,qs=this.buildSingleSubNote(e,{pitch:X,duration:z,startTime:n});O<D&&(qs.velocity+=k),t.push(qs),n+=z}return o.glissando&&(o.startTime+=r,o.duration=r),t},getOrnamentSubNoteDuration(o,e){const{quarterDuration:t,duration:i}=o,s=i/t;let r=t;o.glissando&&(r/=2);let n=.25;for(;n*e>r;)n/=2;return n*s},buildOrnamentalSequence({ornaments:o,opts:e,notesArray:t,delays:i}){re(`build ornamental sequence for note ${e.pitch}`),e.startTime=e.startTime||0;let s,{duration:r}=o,{velocity:n}=e;const u=t.pop();let a=o.startTime+e.startTime;o.glissando?r/=2:r+=i.after,u&&u.startTime<a&&(this.cutNoteAt(u,a),t.push(u));const l=Ne.getFirstOrnamentalSequenceName(o),c=o[l].pitches,m=c.length,f=this.getOrnamentSubNoteDuration(o,m),p=m/2,M=Math.ceil(18/p);let w=0;for(s=0;s<m-1;s++){const k=c[s];s<p?n+=M:s>=p&&(n-=M*2),n<12&&(n=12);const O=this.buildSingleSubNote(e,{startTime:a,pitch:k,duration:f,velocity:n});t.push(O),a+=f,w+=f}let D=r-w;return o.glissando&&(D=f),t.push(this.buildSingleSubNote(e,{startTime:a,pitch:c[s],duration:D})),a+=D,w+=D,o.glissando&&(o.startTime+=w,o.duration-=w),t},alterPitchWithKey(o,e){if(typeof o.alter=="undefined"){const t=Hr.default.getFifths(e),i=Xe.default.stepToAlter(o.step,t);o.alter=i}return o},createFilterOptions(o,e,t){let i;const s=Math.floor(Math.random()*3);if(e){if(o>71||s!==0)return null;for(i=0;i<e.length;i++)e[i].frequencyMultiplier&&(e[i].frequency=t*e[i].frequencyMultiplier)}return e},buildTremoloVibrato(o,e,{subNoteDuration:t,totalDuration:i,startTime:s}){const r=1/t/2,n=[],u=this.buildSingleSubNote(o);return u.automations={velocity:{effect:"vibrato",startTime:s,duration:i,frequency:r,depth:.3}},n.push(u),n},buildTremoloFriction(o,e,{totalStrokes:t,subNoteDuration:i,startTime:s}){re(`build friction tremolo with ${t} strokes of duration ${i}`);const{pattern:r}=pi.tremolo,{velocity:n,release:u}=o,a=[];for(let l=0;l<t;l++){const h=r[l%r.length],c=i+h.durationDiff,m=this.buildSingleSubNote(o,{startTime:s,duration:c,velocity:Math.max(l%2===1?n:n-2,4)});m.envelope={attack:h.attack||0,release:l===t-1?u:.5},m.detune=l%2===1?Math.random()*30-30:0,a.push(m),s+=c}return a},buildTremoloStrum(o,e,{totalStrokes:t,subNoteDuration:i,startTime:s}){re(`build strum tremolo with ${t} strokes of duration ${i}`);const{release:r,velocity:n}=o,u=[];for(let a=0;a<t;a++){const l=Math.random()*.001+i-5e-4,h=Math.round(Math.random()*64)+n-64,c=this.buildSingleSubNote(o,{startTime:s,duration:l,velocity:h});c.envelope={attack:a===0?0:.01,release:r},u.push(c),s+=l}return u},buildTremoloAlternate(o,e,{totalStrokes:t,subNoteDuration:i,startTime:s}){re(`build alternate tremolo with ${t} strokes of duration ${i}`);const{velocity:r,pitch:n}=o,u=[];for(let a=0;a<t;a++){const l=Math.random()*1e-4+i-5e-5,h=Math.round(Math.random()*12)+r-12,c=this.buildSingleSubNote(o,{pitch:n,startTime:s,duration:l,velocity:h});e["midi-unpitched"]&&(c.detune=a%2===1?Math.floor(Math.random()*50)-50:Math.floor(Math.random()*20)),u.push(c),s+=l}return u},getTremoloFunctionName(o,e){let t=e.tremolo||"alternate";o.mode==="pizzicato"&&(t="strum");let s=`buildTremolo${t.charAt(0).toUpperCase()+t.slice(1)}`;return typeof this[s]=="undefined"&&(s="buildTremoloAlternate"),s},findTremoloStrokesNumber(o,e){const t=o&&o.nbBeam||3;let i=Et(2,t);return e>=2&&(i*=e),i>32&&(i=32),i},buildTremoloNotes({ornaments:o,opts:e,instInfo:t,notesArray:i,delays:s}){re(`build tremolo for note ${e.pitch}`),e.startTime=e.startTime||0,e.release=e.release||t.release||.1,e.mode=qe.getPlayingMode(e);const r=i.pop(),n=e.startTime+o.startTime,{quarterDuration:u}=o;let a=o.duration+s.after;const l=this.getTremoloFunctionName(e,t),h=o[R.A.TREMOLO]||o[R.A.BUZZ];o.glissando&&(a/=2);let c=this.findTremoloStrokesNumber(h,u),m=a/c;o[R.A.BUZZ]&&(m=.047,c=Math.round(a/m));const f={totalStrokes:c,subNoteDuration:m,totalDuration:a,startTime:n},p=this[l](e,t,f);p.length===1&&p[0].automations?r&&(r.automations=p[0].automations,i.push(r)):i.push(...p),o.glissando&&(o.startTime+=a,o.duration=a)},cutNoteAt(o,e){const t=o.startTime+o.duration;o.startTime>=e||t<e||(o.duration=g.roundDecimal(e-o.startTime,Et(10,12)))},applyOrnamentsForSingleNote({opts:o,instInfo:e={},ornaments:t,notesArray:i,delays:s}){if(t[R.A.TREMOLO]||t[R.A.BUZZ])this.buildTremoloNotes({ornaments:t,opts:o,instInfo:e,notesArray:i,delays:s});else if(t[R.A.TRILLMARK]&&!e["midi-unpitched"])this.buildTrillNotes({ornaments:t,opts:o,instInfo:e,notesArray:i,delays:s});else if(Ne.hasOrnamentalSequence(t))this.buildOrnamentalSequence({ornaments:t,opts:o,instInfo:e,notesArray:i,delays:s});else if(!t.glissando){const r=this.buildSingleSubNote(o);i.push(r)}t.glissando&&this.buildGlissandoNotes({ornaments:t,opts:o,instInfo:e,notesArray:i,delays:s})},applyWedgeVelocitiesOnNotesArray(o,e,t){if(!e.wedgeInterval)return;const i=e.velocity;let s=i,r=i;for(let n=0;n<o.length;n++){const u=o[n];u.velocity=r;const a=u.duration/e.duration,l=e.wedgeInterval*a;s+=l,r=Math.ceil(g.roundDecimal(s,10)),t.gradualVelocity&&u.velocity!==r&&(typeof u.automations=="undefined"&&(u.automations={}),u.automations.velocity={target:r,startTime:u.startTime||0,duration:u.duration})}},buildOrnamentsSerie(o,e){const t=[];o.startTime=o.startTime||0;const i=this.buildSingleSubNote(o);t.push(i);let s=0;for(let r=0;r<o.ornaments.length;r++){const n=o.ornaments[r],u=o.ornaments[r+1],a=n.startTime+n.duration,l=n.startTime-s;let h=o.duration-a;u&&(h=u.startTime-a);const c={before:l,after:h};this.applyOrnamentsForSingleNote({ornaments:n,opts:o,instInfo:e,notesArray:t,delays:c}),s=a}return t},processNoteEffects(o,e){if(!o.effects)return;const t=o.effects[0];re(`process note effect ${t}`);const i=e[t];re(`process ${t} using ${i}`),i==="alternativeSample"?(o.mode=t,o.pitch=59+o.guitarString):t==="ghostNote"&&(o.velocity=se.MINIMUM_VELOCITY),delete o.effects},getSlurDurationAdjustment(o){let e=G.DEFAULT_DURATION_ADJUSTMENT;return o<2&&(e=.01),e},getSlurVelocityRatio(o){let e=1;return o===0?e=1.3:o===1?e=.85:o===2&&(e=1.15),e},limitAutomationsDurations(o){if(!o.automations)return;const e=o.startTime+o.duration,t=Object.keys(o.automations);for(let i=0;i<t.length;i++){const s=t[i];let r=o.automations[s];Array.isArray(r)||(r=[r]);for(let n=0;n<r.length;n++){const u=r[n];u.startTime+u.duration>e&&(u.duration=e-u.startTime)}}},applyEnvelope(o,e={release:.1},t){const{slurIdx:i}=o,s=o.releaseRatio||1;let r=G.DEFAULT_DURATION_ADJUSTMENT,n=1;typeof i!="undefined"&&i!==null&&(r=this.getSlurDurationAdjustment(i),n=this.getSlurVelocityRatio(i));for(let u=0;u<t.length;u++){const a=t[u];a.release=e.release||.1;let l=1;typeof s=="undefined"&&typeof a.pitch=="number"?l=60/a.pitch:l=s,a.duration<2&&(r=-a.duration*.05),a.duration+=r,a.velocity*=n,a.release*=l,a.velocity=Math.round(a.velocity),a.velocity<se.MINIMUM_VELOCITY?a.velocity=se.MINIMUM_VELOCITY:a.velocity>se.MAXIMUM_VELOCITY&&(a.velocity=se.MAXIMUM_VELOCITY),this.limitAutomationsDurations(a)}},applyPedalEndTime(o,e){if(o.pedalEndTime){re("apply pedalEndTime",o.pedalEndTime);for(let t=0;t<e.length;t++){const i=e[t],s=i.startTime+i.duration;re("note original end time",s),s<o.pedalEndTime&&(i.duration=o.pedalEndTime-i.startTime,i.release/=4,re("updated note duration",i.duration)),delete i.holdNote}}},buildNotesSequence(o,e={}){re("build notes sequence for %O",o);let t=[];if(o.startTime=o.startTime||0,this.processNoteEffects(o,e),o.ornaments&&o.ornaments.length>0)t=this.buildOrnamentsSerie(o,e);else{const i=this.buildSingleSubNote(o);t.push(i)}return this.applyWedgeVelocitiesOnNotesArray(t,o,e),this.applyEnvelope(o,e,t),this.applyPedalEndTime(o,t),t}},A={qpm:120,timeSignature:{beats:null,beatType:null},measureIdx:0,playbackSpeed:1,unitDuration:60/120,beatDuration:60/120,swing:!1};var as=(o,e,t)=>new Promise((i,s)=>{var r=a=>{try{u(t.next(a))}catch(l){s(l)}},n=a=>{try{u(t.throw(a))}catch(l){s(l)}},u=a=>a.done?i(a.value):Promise.resolve(a.value).then(r,n);u((t=t.apply(o,e)).next())});const Re=x("dacapo:instrumentmanager");class Kr{constructor(){this.instrumentStack=[],this.currentPlayedNote=null,this.midiOutputEnabled=!1,this.metronome=null,this.selected=0,this.soloCount=0,this.timeMapping=null,this.logger=null}addInstrument(e,t){typeof t=="undefined"?this.instrumentStack.push(e):this.instrumentStack[Number(t)]=e}playSelectedInstrument(e,t){this.instrumentStack[this.selected]||(this.selected=0);const i={pitch:e,duration:Number.POSITIVE_INFINITY,velocity:t};this.midiOutput&&this.midiOutputEnabled?this.midiOutput.playNote(i,this.selected):this.instrumentStack[this.selected].playNote(i)}stopSelectedInstrument(e,t){this.instrumentStack[this.selected]&&(this.midiOutput&&this.midiOutputEnabled?this.midiOutput.stopNotesWithPitch(e,this.selected):this.instrumentStack[this.selected].stopNotesWithPitch(e,t))}getSelectedIndex(){return this.instrumentStack[this.selected]?this.selected:0}hasInstruAtIdx(e){return!!(this.instrumentStack&&this.instrumentStack[e])}playNoteAtPosition(e){return as(this,null,function*(){if(Re("play note preview at pos %o",e),!this.data||!d.context||this.data.getNbMeasures()<=e.measureIdx)return!1;d.context.state!==be.RUNNING&&(Re("audio context is not running, trying to resume..."),yield d.resume());let t=d.context.currentTime,i;this.selected=e.partIdx,this.hasMode(e.partIdx,"pizzicato")&&(i=C.getLastPizzicatoType(this.data.score["score-partwise"].part[e.partIdx],e));const s=this.data.getNoteData({noteIdx:e.noteIdx,voiceIdx:e.voiceIdx,voiceUuid:e.voiceUuid,measureIdx:e.measureIdx,measureUuid:e.measureUuid,partIdx:e.partIdx,partUuid:e.partUuid,isConcertPitch:!0}),n={duration:.5,velocity:50,slurIdx:0,preview:!0,mode:i===Ze.A.PIZZICATO?"pizzicato":"default"};if(!s.isRest){if(this.stopCurrentPlayAtPos(),s.nbGraces){const u=g.GRACE_RATIO*n.duration/s.nbGraces;for(let a=0;a<s.nbGraces;a++){n.duration=u;const l=this.data.getGraceData({graceIdx:a,noteIdx:e.noteIdx,voiceIdx:e.voiceIdx,voiceUuid:e.voiceUuid,measureIdx:e.measureIdx,measureUuid:e.measureUuid,partIdx:e.partIdx,partUuid:e.partUuid,isConcertPitch:!0});this.playNoteData(l,n,e,t),t+=u}n.duration=g.GRACE_RATIO*1}this.playNoteData(s,n,e,t),this.playedPartIdx=e.partIdx}return!0})}playNoteData(e,t,i,s){let r,n;if(typeof e.pitches!="undefined")for(r=0,n=e.pitches.length;r<n;r++)this.getArticulations(e,t,r),t.pitch=g.NoteNameToMIDI(e.pitches[r]),t.startTime=s,this.playNoteSequence(t,i.partIdx);else if(typeof e.unpitched!="undefined")for(r=0,n=e.unpitched.length;r<n;r++)this.getArticulations(e,t,r),t.pitch=Number(e.unpitched[r].MIDIUnpitched)-1,t.midiProgram=Number(e.unpitched[r].MIDIProgram),t.startTime=s,this.playNoteSequence(t,i.partIdx)}getArticulations(e,t,i){const s=[];e.ghostNotes&&e.ghostNotes[i]?s.push("ghostNote"):e.noteheads&&e.noteheads[i]===os.A.X&&s.push("deadNote"),s.length>0&&(t.effects=s,e.tabsData&&(t.guitarString=e.tabsData[i].string))}playAudioNotesInRange(e,t){const i=[];Re(`[playAudioNotesInRange] isFirst: ${t} notes: %O`,e),Re.enabled&&console.table(e.filter(s=>s.partIdx!==-1),["partIdx","startTime","duration","pitch"]);for(let s=0;s<e.length;s++){const r=e[s];if(r.partIdx===-1)this.metronome&&this.metronome.scheduleTickAt(r.startTime,r.unpitched.midiProgram);else{const n=this.playNote(r,r.partIdx);i.push(n)}}return Promise.all(i)}getMaxEndingTimeForNotes(e){return as(this,null,function*(){const t=[];for(let r=0;r<e.length;r++){const n=e[r];t.push(this.playNote(n,n.partIdx))}const i=yield Promise.all(t);return this.getMaxEndingTimeFromPlayNoteResults(i)})}getMaxEndingTimeFromPlayNoteResults(e){let t=0;for(let i=0;i<e.length;i++){const s=e[i];s&&s.endTime>t&&(t=s.endTime)}return t}exportAudioNotesInRange(e){const t=[];let i=0;e.sort((s,r)=>s.startTime-r.startTime),e.sort((s,r)=>s.partIdx-r.partIdx),Re("[exportAudioNotesInRange] notes: %O",e);for(let s=0;s<e.length;s++){const r=e[s];this.timeMapping&&r.startTime>i&&this.updateExportMetaFromTime(r.startTime,r.partIdx);const n=this.playNote(r,r.partIdx);i=r.startTime,n.catch(u=>{this.logger&&this.logger.logError?this.logger.logError(u,{extra:r}):console.error(u)}),t.push(n)}return Promise.all(t)}updateExportMetaFromTime(e){for(let t=0;t<this.instrumentStack.length;t++)this.updateExportMetaFromTimeForPart(e,t)}updateExportMetaFromTimeForPart(e,t){if(!this.timeMapping)throw new Error("No timeMapping provided");const i=this.timeMapping.getTimeEntryAtSeconds(e);if(!i)throw new Error(`No time entry found for the given time ${e}`);const s=this.instrumentStack[t].getSpq();i.spq!==s&&this.updateSpq(i.spq,i.time,t)}finalizeMIDIExportAtTime(e){for(let t=0;t<this.instrumentStack.length;t++)this.instrumentStack[t].closeExpiredNotes(e)}adaptAudioNoteTimesRelativeTo(e,t){e.startTime=Math.max(e.startTime-t,0),e.automations&&Object.values(e.automations).forEach(i=>{if(Array.isArray(i))for(let s=0;s<i.length;s++)i[s].startTime=Math.max(i[s].startTime-t,0);else i.startTime=Math.max(i.startTime-t,0)})}playNoteSequence(e,t){if(Re("partIdx %d, play notes sequence at time %f for: %O",t,e.startTime,e),!this.instrumentStack[t])throw new V(t);let i=ct[1];const s=[];this.instrumentStack&&this.instrumentStack[t]&&this.instrumentStack[t].getInstrumentInfo&&(i=this.instrumentStack[t].getInstrumentInfo());const r=Yr.buildNotesSequence(e,i);for(let n=0;n<r.length;n++){const u=r[n],a=this.playNote(u,t);s.push(a)}return Promise.all(s)}stopCurrentPlayAtPos(){Re(`stop current note preview for partIdx ${this.playedPartIdx}`),this.playedPartIdx!==null&&this.instrumentStack[this.playedPartIdx]&&(this.instrumentStack[this.playedPartIdx].stopNotesPreview(),this.playedPartIdx=null)}playNote(e,t){if(this.instrumentStack[t]){if(this.midiOutput&&this.midiOutputEnabled){const i=this.data.getPartHeader(t);return e.header=i,this.midiOutput.playNote(e,t)}return this.instrumentStack[t].playNote(e)}throw new V(t)}cancelNote(e,t){if(this.instrumentStack[t])return this.midiOutput&&this.midiOutputEnabled?this.midiOutput.cancelNote(t):this.instrumentStack[t].cancelNote(e,t);throw new V(t)}getNoteName(e,t){if(this.instrumentStack[t])return this.midiOutputEnabled?0:this.instrumentStack[t].getNoteName(e);throw new V(t)}isDrumset(e){if(this.instrumentStack[e])return this.midiOutputEnabled?!1:this.instrumentStack[e].isDrumset();throw new V(e)}stopPedal(e,t){if(this.instrumentStack[e])this.midiOutput&&this.midiOutputEnabled?this.midiOutput.stopPedalForChannel(e,t):this.instrumentStack[e].stopPedal(t);else throw new V(e)}getDefaultOctave(e,t){if(this.instrumentStack[e])return this.midiOutput&&this.midiOutputEnabled?4:this.instrumentStack[e].getDefaultOctave(t);throw new V(e)}hasMode(e,t){if(this.instrumentStack[e])return this.midiOutput&&this.midiOutputEnabled?!1:this.instrumentStack[e].hasMode(t);throw new V(e)}writeNote(e,t){return this.instrumentStack[t]?this.instrumentStack[t].writeNote(e):!0}updateOffset(e,t){if(!this.instrumentStack[t])throw new V(t);typeof this.instrumentStack[t].updateOffset=="function"&&this.instrumentStack[t].updateOffset(e)}updateTempo(e,t,i){if(!this.instrumentStack[i])throw new V(i);this.instrumentStack[i].updateTempo&&this.instrumentStack[i].updateTempo(e,t)}updateSpq(e,t,i){if(!this.instrumentStack[i])throw new V(i);this.instrumentStack[i].updateSpq&&this.instrumentStack[i].updateSpq(e,t)}updateTimeSignature(e,t,i){if(!this.instrumentStack[i])throw new V(i);this.instrumentStack[i].updateTimeSignature&&this.instrumentStack[i].updateTimeSignature(e,t)}updateKeySignature(e,t,i){if(!this.instrumentStack[i])throw new V(i);this.instrumentStack[i].updateKeySignature&&this.instrumentStack[i].updateKeySignature(e,t)}stopNoteWithId(e,t,i){if(!this.instrumentStack[i])throw new V(i);this.midiOutput&&this.midiOutputEnabled?this.midiOutput.stopNoteWithId(i,e,t):this.instrumentStack[i].stopNoteWithId(e,t)}stopAllScheduledNotes(){this.instrumentStack.map(e=>{e.stopNotes(.1)})}cancelNoteWithId(e,t){if(Re(`cancel note with id ${e} in part ${t}`),!this.instrumentStack[t])throw new V(t);this.midiOutput&&this.midiOutputEnabled?this.midiOutput.cancelNoteWithId(t,e):this.instrumentStack[t].cancelNoteWithId(e)}getInstruments(){return this.instrumentStack}selectInstrument(e){this.selected=e}stopAll(){if(this.midiOutput&&this.midiOutputEnabled)this.midiOutput.stopNotes(.01);else for(let e=0;e<this.instrumentStack.length;e++)this.instrumentStack[e].stopNotes(.01)}setTransport(e){this.transport=e}getInstrumentTranspo(e){if(e>=0&&e<this.instrumentStack.length)return this.instrumentStack[e].getTranspo();throw new V(e)}setInstrumentVolume(e,t){if(e>=0&&e<this.instrumentStack.length)t=Number(t),typeof t=="number"&&Number.isFinite(t)&&this.instrumentStack[e].setVolume(t);else throw new V(e)}getInstrumentVolume(e){if(e>=0&&e<this.instrumentStack.length)return d.context?this.instrumentStack[e].getVolume():1;throw new V(e)}setInstrumentReverb(e,t){if(e>=0&&e<this.instrumentStack.length){if(typeof t=="number"&&Number.isFinite(t))return this.instrumentStack[e].setReverb(t);throw new Error("Invalid value for reverbRate",t)}throw new V(e)}getInstrumentReverb(e){if(e>=0&&e<this.instrumentStack.length){if(d.context)return this.instrumentStack[e].getReverb();throw new he}throw new V(e)}muteAllInstruments(){let e;for(e=0;e<this.instrumentStack.length;e++)this.instrumentStack[e].mute()}unmuteAllInstruments(){let e;for(e=0;e<this.instrumentStack.length;e++)this.instrumentStack[e].unmute()}muteInstrument(e){e>=0&&e<this.instrumentStack.length&&d.context&&(this.instrumentStack[e].isMuted()||(this.unsetInstrumentSolo(e),this.instrumentStack[e].mute()))}unmuteInstrument(e){e>=0&&e<this.instrumentStack.length&&d.context&&this.instrumentStack[e].isMuted()&&this.instrumentStack[e].unmute()}isInstrumentMuted(e){return e>=0&&e<this.instrumentStack.length&&d.context?this.instrumentStack[e].isMuted():!1}setInstrumentSolo(e){e>=0&&e<this.instrumentStack.length&&d.context&&(this.instrumentStack[e].isSolo()||(this.soloCount===0&&this.muteAllInstruments(),this.unmuteInstrument(e),this.instrumentStack[e].setSoloMode(),this.soloCount++))}unsetInstrumentSolo(e){e>=0&&e<this.instrumentStack.length&&d.context&&this.instrumentStack[e].isSolo()&&(this.instrumentStack[e].unsetSoloMode(),this.soloCount--,this.soloCount===0&&this.unmuteAllInstruments())}isInstrumentSolo(e){if(e>=0&&e<this.instrumentStack.length&&d.context)return this.instrumentStack[e].isSolo();throw new V(e)}getMasterVolume(){return d.context?ae.mainOutput.getGain():1}getCursorPosition(){return null}getCurrentPosition(){if(this.transport){const e=this.transport.getHeadPosition(this.selected);return{measureIdx:e.currentMeasure,quarterPos:e.timeFromMeasureStart/A.unitDuration}}return null}preloadInstrumentSamples(e,t){return this.instrumentStack[e]||Promise.reject(new Error("The partIdx is invalid")),this.instrumentStack[e].preloadSamples(t)}preloadSamples(e){const t=[];for(let i=0;i<e.length;i++)t.push(this.preloadInstrumentSamples(i,e[i]));return Promise.all(t)}enablePreloadMode(e){if(!this.instrumentStack[e])throw new V(e);return this.instrumentStack[e].enablePreloadMode()}disablePreloadMode(e){if(!this.instrumentStack[e])throw new V(e);return this.instrumentStack[e].disablePreloadMode()}playRandomBufferToInitReverbFirefox(e){if(!this.instrumentStack[e])throw new V(e);return this.instrumentStack[e].playRandomBufferToInitReverbFirefox()}setData(e){this.data=e,e&&(this.commonContent=e.getCommonContent())}setMidiOutput(e){this.midiOutput=e}enableMidiOutput(){this.midiOutputEnabled=!0}disableMidiOutput(){this.midiOutputEnabled=!1}resetInstruments(){this.instrumentStack=[],this.selected=0,this.soloCount=0}renewWebAudioNodes(){for(let e=0;e<this.instrumentStack.length;e++){const t=this.instrumentStack[e];t&&t.renewWebAudioNodes()}}connectAllInstrumentsTo(e){for(let t=0;t<this.instrumentStack.length;t++){const i=this.instrumentStack[t];i&&i.connectTo&&i.connectTo(e)}}setMetronome(e){this.metronome=e}setTimeMapping(e){this.timeMapping=e}setLogger(e){this.logger=e}}const us=Kr;var yi=v(426041),ls=(o,e,t)=>new Promise((i,s)=>{var r=a=>{try{u(t.next(a))}catch(l){s(l)}},n=a=>{try{u(t.throw(a))}catch(l){s(l)}},u=a=>a.done?i(a.value):Promise.resolve(a.value).then(r,n);u((t=t.apply(o,e)).next())});const Ot="Error while loading soundfonts",st=x("dacapo:sfbuffer");class bi{constructor(){st("instanciate SFBuffer"),this.encodedSamples={},this.PCMSamples={},this.decodingSamples={},this.subBuffers={},this.loaderList={},this.info=null,this.ongoingLoadingPromise=null,this.pitchRange=[],this.lastDecodePrms=null,this.format=null,this.mainId=null}init(e){this.info=e,this.mainId=e.id,this.ids=[this.mainId],this.decodingSamples={},this.PCMSamples={},this.encodedSamples={},this.subBuffers={},this.loaderList={},e.children&&(this.ids=this.ids.concat(Object.keys(e.children)));for(let t=0;t<this.ids.length;t++){const i=this.ids[t];let s,r;if(t>0){const n=e.children[i];r=n.id||n,s=new bi,this.subBuffers[i]=s,n.id&&(this.subBuffers[i].info=n)}else s=this,r=this.mainId;this.loaderList[r]=0}}decodeAudioData(e){const{context:t,rtContext:i}=d,s=i||t;return new Promise((r,n)=>{const u=s.decodeAudioData(e,a=>{r(a)},a=>{n(a)});u instanceof Promise&&u.catch(a=>{n(a)})})}decodeNote(e){return ls(this,null,function*(){let t;const i=this.encodedSamples[e];if(typeof i=="undefined")return!1;try{t=yield this.decodeAudioData(i)}catch(s){throw delete this.decodingSamples[e],s===null?new Error(`Failed to decode note ${e} in ${this.mainId} soundfont (${this.format} format)`):s}return this.PCMSamples[e]=t,delete this.decodingSamples[e],t})}preloadAll(){const e=Object.keys(this.encodedSamples);for(let t=0;t<e.length;t++)this.loadNote(e[t])}decodeBase64(e){const t=e.split(",")[1];return(0,yi.UU)(t)}setSoundfont(e){let t;const i=Object.keys(e);for(t=0;t<i.length;t++){const s=i[t],r=g.KeyToNote[s];let n=e[s];typeof e[s]=="string"&&(n=this.decodeBase64(n)),this.encodedSamples[r]=n}this.setPitchRange()}setPitchRange(){const e=Object.keys(this.encodedSamples);e.sort((s,r)=>Number(s)-Number(r));const[t]=e,i=e[e.length-1];this.pitchRange=[g.MIDIToPitchObject(t),g.MIDIToPitchObject(i)]}chooseBestFormat(){if(typeof Audio=="undefined")return"Web Audio API is not supported";const e=new Audio;if(typeof e.canPlayType=="undefined")return"Audio.canPlayType is not supported";const t=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),i=e.canPlayType('audio/ogg; codecs="vorbis"');if(!t&&(i==="probably"||i==="maybe"))return"ogg";const s=e.canPlayType("audio/mpeg");return s==="probably"||s==="maybe"?"mp3":"Neither ogg nor mp3 are supported"}loadSoundfont(e){const t=[];for(let i=0;i<this.ids.length;i++){const s=this.ids[i],r=this.getSoundfontId(s),n=this.loadChildSoundfont(r,s,e);t.push(n)}return this.ongoingLoadingPromise=Promise.all(t),this.ongoingLoadingPromise.then(()=>(this.ongoingLoadingPromise=null,st("sf loaded %o",this.ids),Promise.resolve())).catch(i=>(this.ongoingLoadingPromise=null,st("err while loading sf: %o / %o",this.ids,i),Promise.reject(i)))}waitUntilSoundfontLoaded(){const e=this.ongoingLoadingPromise;return e||Promise.resolve()}loadChildSoundfont(e,t,i){const s=this.subBuffers[t]||this;return i?i[e]?(s.setSoundfont(i[e]),this.loaderList[e]=1,Promise.resolve(e)):Promise.reject(Error(`soundfont data for ${e} has not been provided`)):s.downloadSoundfont(e,this.info).then(()=>{this.loaderList[e]=1})}hasMissingSoundfonts(){return Object.values(this.loaderList).includes(0)}getMissingSoundfontsIds(){const e=[];for(let t=0;t<this.ids.length;t++){const i=this.ids[t],s=this.getSoundfontId(i);this.loaderList[s]||e.push(s)}return e}retrySoundfontsLoading(){const e=[];if(!this.hasMissingSoundfonts())throw new Error("Cannot retry soundfonts loading because they are already loaded");for(let t=0;t<this.ids.length;t++){const i=this.ids[t],s=this.getSoundfontId(i);if(!this.loaderList[i]){const r=this.loadChildSoundfont(s,i);e.push(r)}}return Promise.all(e)}downloadSoundfont(e,t){return t=t||{},new Promise((i,s)=>{let r;const n=new XMLHttpRequest;return this.format=t.forcedFormat||this.chooseBestFormat(),r=`${window.flatSettings.assetsurl+(t.soundfontsPath||"")}/soundfonts/${e}`,this.format!=="ogg"&&this.format!=="mp3"?s(new Error(`Flat isn't compatible with ${this.format} yet`),e):(r=`${r}-${this.format}.json`,st("dl sf %s",r),n.open("GET",r,!0),n.responseType="json",n.onload=()=>{if(n.status<400&&n.response&&Object.prototype.toString.call(n.response)==="[object Object]"){try{st("dl done %s",e),this.setSoundfont(n.response)}catch(a){return s(a,e)}return i(e)}const u=new Error(`${Ot} with status code ${n.status}`);return console.error(`${Ot}, status code ${n.status}, response ${n.response}`),u.xhr=n,s(u,e)},n.onerror=u=>{const a=new Error(Ot);return a.xhrCallback="onerror",a.xhrRequest=u.target,s(a,e)},n.onabort=u=>{const a=new Error(Ot);return a.xhrCallback="onabort",a.xhrRequest=u.target,s(a,e)},n.send(),null)})}getSoundfontId(e=null){return e&&this.info.children&&this.info.children[e]?typeof this.info.children[e]=="string"?this.info.children[e]:this.info.children[e].id:this.mainId}getVolumeAdjustment(e=null){return this.info?e&&this.info.children&&this.info.children[e]&&typeof this.info.children[e]=="object"?this.info.children[e].dbDiff||0:this.info.dbDiff||0:0}getFirstValidNote(){const t=Object.keys(this.encodedSamples)[0];return this.getNote(t)}loadNoteInQueue(e,t){return ls(this,null,function*(){return t&&this.lastDecodePrms&&(yield this.lastDecodePrms),yield this.decodeNote(e)})}loadNote(e,t){return this.lastDecodePrms=this.loadNoteInQueue(e,t),this.decodingSamples[e]=this.lastDecodePrms,this.lastDecodePrms}getNote(e,t="default",i="default",s=!1){return st("getNote: %s for %s and dynamics mode %s",e,t,i),t!=="default"&&this.subBuffers[t]?this.subBuffers[t].getNote(e,i,"default",s):t==="default"&&i!=="default"&&this.subBuffers[i]&&this.subBuffers[i].hasNote(e,t,"default")?this.subBuffers[i].getNote(e,"default","default",s):this.PCMSamples[e]?Promise.resolve(this.PCMSamples[e]):this.decodingSamples[e]?this.decodingSamples[e]:this.encodedSamples[e]?this.loadNote(e,s):Promise.reject(Error("Out of range"))}hasNote(e,t="default",i="default"){return t!=="default"?this.subBuffers[t]?this.subBuffers[t].hasNote(e,i):!1:i!=="default"?this.subBuffers[i]?this.subBuffers[i].hasNote(e):!1:!!this.encodedSamples[e]}hasMode(e){return typeof this.subBuffers[e]!="undefined"}hasDynamicMode(e,t="default"){return t!=="default"&&this.subBuffers[t]?this.subBuffers[t].hasDynamicMode(e):this.hasMode(e)}hasDynamicsLevels(){return typeof this.subBuffers.velocity_p!="undefined"||typeof this.subBuffers.velocity_f!="undefined"}getPitchRange(){return this.pitchRange}}const Ti=bi;class vi{constructor(){this.encodedSamples={},this.PCMSamples={},this.instrumentId=0,this.subBuffers={},this.info={}}init(e,t,i,s){this.info=e,this.samples=this.info.samples,typeof this.samples=="number"&&(this.samples=ct[this.samples].samples),this.id=e.id,this.loaderList={},this.cbLoaded=t,this.cbLoading=s,this.cbErr=i||(()=>{})}loadedChild(e,t){if(e){this.cbErr(e);return}this.loaderList[t]=1;const i=Object.values(this.loaderList);for(let s=0;s<i.length;s++)if(i[s]===0)return;this.cbLoaded(null,this.id)}decodeAudioData(e){const{context:t,rtContext:i}=d,s=i||t;return new Promise((r,n)=>{const u=s.decodeAudioData(e,a=>{r(a)},a=>{n(a)});u instanceof Promise&&u.catch(a=>{n(a)})})}loadKeyfont(e){const t=this.encodedSamples[e];return typeof t=="undefined"?!1:this.decodeAudioData(t).then(i=>(this.PCMSamples[e]=i,i)).catch(i=>i)}preloadAll(){const e=Object.keys(this.encodedSamples);for(let t=0;t<e.length;t++)this.loadKeyfont(e[t])}setKeyfont(e,t){const i=e[t].split(",")[1],s=g.KeyToNote[t],r=(0,yi.UU)(i);this.encodedSamples[s]=r}setSoundfont(e){const t=Object.keys(e);for(let i=0;i<t.length;i++)this.setKeyfont(e,t[i])}loadSoundfont(e,t){let i,s=[e.id];e.children&&(s=s.concat(Object.keys(e.children)));for(let r=0;r<s.length;r++)r>0?(i=new vi,this.subBuffers[s[r]]=i,s[r]=e.children[s[r]]):i=this,this.loaderList[s[r]]=0,t&&t[s[r]]?(i.setSoundfont(t[s[r]]),this.loadedChild(null,s[r])):i.downloadSoundfont(s[r],e,this.loadedChild.bind(this),this.cbErr)}downloadSoundfont(e,t,i,s){let r;const n=new XMLHttpRequest,u=this.chooseBestFormat();if(this.id=e,r=`${window.flatSettings.assetsurl}/soundfonts/${e}`,u!=="ogg"&&u!=="mp3"){t(u);return}r=`${r}-${u}.json`,n.open("GET",r,!0),n.responseType="json",n.onprogress=a=>{s&&s(a,e)},n.onload=()=>{if(n.status<400&&n.response&&Object.prototype.toString.call(n.response)==="[object Object]")try{this.setSoundfont(n.response),t&&t(null,e)}catch(a){throw new Error(`Unable to load soundfont ${e}. ${a}`)}},n.onerror=()=>{typeof i=="function"&&i(e)},n.onabort=()=>{typeof i=="function"&&i(e)},n.send()}setSample(e,t){const i=g.KeyToNote[e];return this.decodeAudioData(t).then(s=>{this.PCMSamples[i]=s})}downloadSamples(e,t,i,s){let r,n;const u={},a=[];this.id=e;const l=(h,c,m,f)=>{h?(typeof u[f]=="undefined"?u[f]=0:u[f]++,u[f]<3?this.downloadSample(m,c,f,l):s(m,h)):a.includes(f)||(a.push(f),i&&a.length===this.samples.length&&i(null,m))};for(r=0;r<this.samples.length;r++)({notename:n}=this.samples[r]),this.downloadSample(e,t,n,l)}downloadSample(e,t,i,s){const r=`${window.flatSettings.assetsurl+(t.soundfontsPath||"")}/samples/${e}/stereo/${i}.wav`,n=new XMLHttpRequest;n.open("GET",r,!0),n.responseType="arraybuffer",n.onload=()=>{n.status<400&&n.response&&this.setSample(i,n.response).then(()=>{s(null,t,e,i)}).catch(u=>{s(u,t,e,i)})},n.onerror=u=>{typeof s=="function"&&s(new Error(`Unable to download soundfont ${e}. ${u}`),t,e,i)},n.onabort=n.onerror,n.send()}getNote(e,t){return t!=="default"&&this.subBuffers[t]?this.subBuffers[t].getNote(e):this.PCMSamples[e]?Promise.resolve(this.PCMSamples[e]):this.encodedSamples[e]?this.loadKeyfont(e):Promise.reject(Error("Out of range"))}hasNote(e,t){return t?this.subBuffers[t]?this.subBuffers[t].hasNote(e):!1:!!this.encodedSamples[e]}hasMode(e){return typeof this.subBuffers[e]!="undefined"}}const Jr=vi;var Xr=v(210888),dt=v(383279),Ii=v(856219);class Zr extends Ue{constructor(){super(),this.instrumentsMap={},this.release=1,this.instInfo=null,this.drumSet=!1}setInstrumentInfo(e){const t=Object.values(e)[0];this.instInfo=t,this.instrumentsInfo=e,this.release=t.release||.1}getInstrumentInfo(){return this.instInfo}hasMode(e){return this.instInfo.children&&this.instInfo.children[e]}getAvailableModes(){return Object.keys(this.instInfo.children||{})}setHeader(e){this.headerInstrument=e,this.MIDIInstruments=dt.default.getMIDIInstruments(e),this.defaultMidiProgram=Ii.default.getMIDIProgram(this.MIDIInstruments[0]),this.createUnpitchedMap()}setDrumSet(e){this.drumSet=e}isDrumset(){return this.drumset}createUnpitchedMap(){this.instrumentsMap={};for(let e=0;e<this.MIDIInstruments.length;e++){const t=this.MIDIInstruments[e],i=Ii.default.getId(t);this.instrumentsMap[i]=t}}}const hs=Zr;var en=(o,e,t)=>new Promise((i,s)=>{var r=a=>{try{u(t.next(a))}catch(l){s(l)}},n=a=>{try{u(t.throw(a))}catch(l){s(l)}},u=a=>a.done?i(a.value):Promise.resolve(a.value).then(r,n);u((t=t.apply(o,e)).next())});const mt=x("dacapo:sampler");class tn extends hs{constructor({bridgeHandler:e}){super(),mt("creating new sampler"),this.bridgeHandler=e,this.volumeOutput=1,this.muted=!1,this.solo=!1,this.samplerUuid=Xr.default.generate()}getBridgeLoadingInfo(){return{samplerUuid:this.samplerUuid,instrumentsInfo:this.instrumentsInfo}}connectTo(){}playNote(e){return en(this,arguments,function*({startTime:t,pitch:i,duration:s,velocity:r=100,startOffset:n=0,mode:u="default",holdNote:a=!1,preview:l=!1,release:h=this.release,automations:c}){mt(`play note ${i} at ${t} in mode ${u} and velocity ${r}`);const{context:m}=d,f={currentTime:m.currentTime,startTime:t,pitch:i,duration:s,velocity:r,mode:u,holdNote:a,preview:l,automations:c,release:h,startOffset:n};return this.playSample(f)})}playSample(e){e.samplerUuid=this.samplerUuid,this.bridgeHandler.callHandler("AudioEvent.playNote",e)}stopNote(e,t){mt(`stop note ${e} (forceRelease = ${t}`),this.bridgeHandler.callHandler("AudioEvent.stopNote",{samplerUuid:this.samplerUuid,pitch:e,forceRelease:t})}stopNotesPreview(){}setVolume(e){mt(`set volume to ${e}`),this.volumeOutput=e}getVolume(){return this.volumeOutput}mute(){this.muted=!0}unmute(){this.muted=!1}isMuted(){return this.muted}setSoloMode(){this.unmute(),this.solo=!0}unsetSoloMode(){this.mute(),this.solo=!1}isSolo(){return this.solo}setReverb(e){mt(`set reverb to ${e}`)}getReverb(){return 0}}const sn=tn;var cs=(o,e,t)=>new Promise((i,s)=>{var r=a=>{try{u(t.next(a))}catch(l){s(l)}},n=a=>{try{u(t.throw(a))}catch(l){s(l)}},u=a=>a.done?i(a.value):Promise.resolve(a.value).then(r,n);u((t=t.apply(o,e)).next())});const _=x("dacapo:sampler"),rn=x("dacapo:samplerGrouped");class nn extends hs{constructor(e=0){_(`creating new sampler for part ${e}`),super(),this.partIdx=e,this.nodes=[],this.ready=!1,this.transposition=0,this.drumSet=!1,this.solo=!1,this.scheduledNotes={},this.playing=[];for(let t=0;t<128;t++)this.playing[t]=[];this.initReverbEffect(),this.playingPreview={},this.infos={},this.sfBuffer={},this.defaultMidiProgram=1,this.octaves=[],this.fullOctaves=[],this.defaultOctave=G.DEFAULT_OCTAVE,this.offset=0,this.headerInstrument={},this.noteId=0,this.volumeOutput=1,this.switchOn(),this.preloadMode=!1}initReverbEffect(){d.context&&(this.reverbEffect=new mi,this.connectReverb())}connectReverb(){this.outputGain.connect(this.reverbEffect.input),this.reverbEffect.output.connect(this.output)}playRandomBufferToInitReverbFirefox(){return cs(this,null,function*(){const{context:e}=d,t=this.reverbEffect.getDuration(),i=(wt.CONTEXT_DELAY+t)*2;if(this.preloadMode)return i;const s=e.createBufferSource(),r=e.createGain(),n=yield this.sfBuffer[this.defaultMidiProgram].getFirstValidNote();return s.buffer=n,s.connect(r),r.connect(this.outputGain),s.start(0),r.gain.setValueAtTime(0,wt.CONTEXT_DELAY-.01),s.stop(wt.CONTEXT_DELAY),i})}preloadSamplesWithMode(e){_(`[part ${this.partIdx}] preload samples of the notes in score (with modes)`);const t=[];for(let i=0;i<e.length;i++){const s=e[i],{midiProgram:r}=s,{muteMode:n,guitarString:u}=s;let{mode:a,pitch:l}=s;typeof n=="string"&&(n==="ghost"||n==="dead")&&(a=n==="ghost"?"ghostNote":"deadNote",typeof u=="number"&&(l=59+u));try{t.push(this.sfBuffer[r].getNote(l,a).catch(Pe.handleGetNoteErrors))}catch(h){Pe.handleGetNoteNameErrors(h)}}return Promise.all(t)}preloadSamples(e){_(`[part ${this.partIdx}] preload samples of the notes in score`);const t=[];for(let i=0;i<e.length;i++){const s=this.getMidiProgramForNote(e[i]);try{const r=this.getNoteName(e[i],s);t.push(this.sfBuffer[s].getNote(r).catch(Pe.handleGetNoteErrors));const n=this.getAvailableModes();for(let u=0;u<n.length;u++){const a=n[u];t.push(this.sfBuffer[s].getNote(r,a).catch(Pe.handleGetNoteErrors))}}catch(r){Pe.handleGetNoteNameErrors(r)}}return Promise.all(t)}getNoteFallback(e,t,i){return e==="deadNote"&&!this.sfBuffer[i].hasNote(t,e)?60:t}getNoteName(e,t=this.defaultMidiProgram,i){if(typeof e=="number"?e=qe.checkMIDIRange(e):this.drumSet&&typeof this.instrumentsMap[e]!="undefined"&&(e=Number(this.instrumentsMap[e]["midi-unpitched"])-1,e=qe.checkMIDIRange(e)),this.sfBuffer[t]&&!this.sfBuffer[t].hasNote(e,i))throw new Error("Note does not exists");return e}getMidiProgramForNote(e,t,i){if(typeof t=="number"&&(i=t,t=void 0),typeof i=="undefined"){if(typeof e=="number")return this.defaultMidiProgram;if(typeof t=="undefined"||typeof t.midiKey=="undefined"){const s=this.instrumentsMap[e];if(typeof s=="undefined")throw new Bi(e);i=Ii.default.getMIDIProgram(s)}else typeof t!="undefined"&&(i=t.midiProgram)}return this.sfBuffer[i]?i:this.defaultMidiProgram}createFilter(e={type:"lowpass",frequency:"22000",q:"0.0001",gain:0}){const{context:t}=d,i=t.createBiquadFilter();return i.type=e.type,i.frequency.setValueAtTime(e.frequency,0),i.Q.setValueAtTime(e.q,0),i.gain.value=e.gain,i}createLFOGainNode(e={depth:1,frequency:5}){_(`[part ${this.partIdx}] create a new LFO with a depth of ${e.depth}, and frequency of ${e.frequency}`);const{context:t}=d,i=t.createGain(),s=new fi(e.frequency);return s.connect(i.gain),s.start(),i}createAndConnectAudioNodesForNote(){const{context:e}=d,t=e.createBufferSource(),i=e.createGain(),s=e.createGain(),r={srcNode:t,srcGainNode:i,envelopeGainNode:s};return t.connect(i),i.connect(s),s.connect(this.outputGain),r}logNoteInfo(e,t,i){_(`Note ${i}: [part ${this.partIdx}] ${e}`),t(e)}printGroupedLogs(e,t,i){x.enabled("dacapo:samplerGrouped")&&(console.groupCollapsed(`[part ${this.partIdx}] Note ${e} (${i}) complete`),t.forEach(s=>rn(s)),console.groupEnd())}playNote({startTime:e=0,pitch:t,unpitched:i,duration:s,velocity:r=100,startOffset:n=0,muteMode:u,mode:a="default",holdNote:l=!1,preview:h=!1,release:c=this.release,automations:m,midiProgram:f,detune:p,guitarString:M}){const w=this.noteId,D=[],k=z=>{D.push(`[part ${this.partIdx}] Note ${w}: ${z}`)};try{if(f=this.getMidiProgramForNote(t,i,f),typeof i!="undefined"){const z=i.midiKey-1;this.logNoteInfo(`play note ${z} at ${e} in mode ${a} and velocity ${r}`,k,w),t=this.getNoteName(z,f,a),this.logNoteInfo(`unpitched value converted to pitch ${t}`,k,w)}else this.logNoteInfo(`play note ${t} at ${e} in mode ${a} and velocity ${r}`,k,w),typeof t=="number"&&g.isQuarterToneMIDIValue(t)&&(t=Math.floor(t),p=50),t=this.getNoteName(t,f,a)}catch(z){return Pe.handleGetNoteNameErrors(z),this.printGroupedLogs(this.noteId,D,t),Promise.resolve(null)}typeof u=="string"&&(u==="ghost"||u==="dead")&&(a=u==="ghost"?"ghostNote":"deadNote",typeof M=="number"&&(t=59+M));const O={startTime:e,pitch:t,duration:s,velocity:r,midiProgram:f,mode:a,holdNote:l,preview:h,automations:m,release:c,startOffset:n,detune:p,noteLogger:k};return this.playSample(O).then(z=>(this.printGroupedLogs(w,D,t),z))}playSample(e){return cs(this,null,function*(){const{context:t}=d,{pitch:i,midiProgram:s,detune:r,noteLogger:n=f=>_(`[part ${this.partIdx}] ${f}`)}=e;let u="default",a=e.startTime;const{mode:l}=e;this.logNoteInfo(`play sample ${i} at ${e.startTime} (currentTime: ${t.currentTime})`,n,this.noteId);const h=this.createAndConnectAudioNodesForNote(),c=this.saveNote(e,h);this.sfBuffer[s].hasDynamicsLevels(l)&&(u=this.getDynamicsMode(this.sfBuffer[s],l,e.velocity));const m=this.sfBuffer[s].getVolumeAdjustment(l);e.velocity=g.adjustVelocityWithDbs(e.velocity,m);try{const f=yield this.sfBuffer[s].getNote(e.pitch,l,u,this.preloadMode);this.logNoteInfo("got note from sfBuffer successfully",n,c),e.startTime||(e.startTime=t.currentTime);const p=this.computeFinalEnvelope(e,f.duration);if(this.preloadMode)return a=this.getMaximumEndTime(e,p,f.duration),this.logNoteInfo(`sample in preload mode, aborting playSample..., endTime ${a}`,n,c),{noteId:c,endTime:a};r&&h.srcNode.detune&&h.srcNode.detune.setValueAtTime(r,e.startTime),h.srcNode.buffer=f,this.logNoteInfo(`got audio buffer for note ${c} with pitch ${e.pitch}: duration ${f.duration}`,n,c),this.logNoteInfo(`init velocity gain node with gain value ${p.velocity}`,n,c),h.srcGainNode.gain.setValueAtTime(p.velocity,e.startTime),this.scheduleAutomations(e,h,p),this.applyEnvelope(h.envelopeGainNode,p,e.startTime),e.noteId=c,this.playSourceNode(e,p,h),a=this.getMaximumEndTime(e,p,f.duration)}catch(f){Pe.handleGetNoteErrors(f)}return{noteId:c,endTime:a}})}getDynamicsMode(e,t,i){let s="default";return i<=Dt.p&&e.hasDynamicMode("velocity_p",t)?s="velocity_p":i>=Dt.ff&&e.hasDynamicMode("velocity_f",t)&&(s="velocity_f"),s}playSourceNode(e,{duration:t,velocity:i,release:s},r){const{context:n}=d,{startTime:u,startOffset:a,noteLogger:l,noteId:h}=e,c=l||(m=>_(`[part ${this.partIdx}] ${m}`));if(this.logNoteInfo(`start buffer source node at ${u} with offset ${a}, duration ${t}s, velocity ${i}`,c,h),!r.srcNode||!r.srcGainNode)return Number.POSITIVE_INFINITY;if(a?r.srcNode.start(u,a):r.srcNode.start(u),t&&t>0&&Number.isFinite(t)){const m=this.computeStopTime(u,t,s);return r.srcNode.stop(m),e.nodes=r,this.logNoteInfo(`buffer source node scheduled to be killed at ${m}`,l,h),this.setNodeKilling(e,Math.abs(m-n.currentTime)),m}return Number.POSITIVE_INFINITY}pitchScheduleAutomation(e,t,i,s,r){const{startTime:n,duration:u,pitch:a}=t,{srcNode:l}=i,h=e.startTime||n;_(`[part ${this.partIdx}] schedule pitch automation for note ${a} at time ${h}`);const c=g.MIDIToFreq(a);let m=c;typeof r!="undefined"&&typeof r.target=="number"&&(m=g.MIDIToFreq(r.target));const f=g.MIDIToFreq(e.target),p=m/c,M=f/c;_(`[part ${this.partIdx}] setValueCurveAtTime([${p}, ${M}], ${h}, ${e.duration})`),l.playbackRate.setValueCurveAtTime(new Float32Array([p,M]),h,e.duration||u)}velocityScheduleAutomation(e,t,i,s){if(_(`[part ${this.partIdx}] schedule velocity automation for note ${t.pitch} at time ${t.startTime}`),e.effect==="vibrato"){const r=this.createLFOGainNode(e);i.srcGainNode.disconnect(),i.srcGainNode.connect(r),r.connect(i.envelopeGainNode),i.LFOGainNode=r}else{const r=e.startTime+e.duration,n=g.getFinalSustainedVolume(e.target);_(`[part ${this.partIdx}] schedule gradual velocity automation from ${s.velocity} to ${n}, stopping at time ${r}`),i.srcGainNode.gain.linearRampToValueAtTime(n,r)}}computeStopTime(e,t,i){return e+t+i+1}scheduleAutomations(e,t,i){_(`[part ${this.partIdx}] scheduleAutomations for note %O`,e);const{automations:s}=e;if(s){const r=Object.keys(s);for(let n=0;n<r.length;n++){const u=r[n];this.scheduleAutomationsForProperty(u,e,t,i)}}}scheduleAutomationsForProperty(e,t,i,s){_(`[part ${this.partIdx}] scheduleAutomations for property ${e} for note %O`,t);const{automations:r}=t,n=r[e],u=`${e}ScheduleAutomation`;if(typeof this[u]=="function")if(Array.isArray(n)){let l;for(let h=0;h<n.length;h++){const c=n[h];this[u](c,t,i,s,l),l=c}}else this[u](n,t,i,s)}applyEnvelope(e,t,i){if(t.attack>0){const s=i+t.attack;_(`[part ${this.partIdx}] change attack to reach full velocity 1 at ${s}`),e.gain.setValueAtTime(0,i),e.gain.linearRampToValueAtTime(1,s)}else _(`[part ${this.partIdx}] setting initial velocity value 1 at time ${i}`),e.gain.setValueAtTime(1,i);if(Number.isFinite(t.duration)){const s=i+t.duration,r=t.release/8;_(`[part ${this.partIdx}] buffer source node scheduled to decrease volume at ${s}, release: ${t.release}`),e.gain.setTargetAtTime(0,s,r>0?r:.01)}}computeFinalEnvelope(e,t){const i={};return i.attack=e.attack||0,i.release=e.release||this.release,i.duration=this.getFinalDuration(e,i,t),i.velocity=g.getFinalSustainedVolume(e.velocity),i}getFinalDuration({duration:e,holdNote:t},i,s){return Number.isNaN(e)||this.drumSet||t?Number.POSITIVE_INFINITY:e+i.release>s?(e>=s?i.release=.1*s:i.release=s-e,s-i.release):e}saveNote({pitch:e,release:t,startTime:i,duration:s,holdNote:r,preview:n},u){const a={id:this.noteId,pitch:e,nodes:u,release:t,startTime:i,stopTime:i+s+t+1,duration:s,holding:r};return this.noteId++,this.scheduledNotes[a.id]=a,n?this.playingPreview[e]=a:this.playing[e].push(a),a.id}setNodeKilling({id:e,pitch:t,startTime:i,duration:s,release:r,nodes:n},u,a){const l=i+s+r;return _(`[part ${this.partIdx}] set killing for note id ${e}, pitch ${t} starting at ${i} stopping at ${l}, currentTime ${d.context.currentTime}, in ${u}s`),$.setTimeout(()=>{this.killSourceNode({id:e,nodes:n,pitch:t,startTime:i,maxStopTime:l,isPreview:a})},u*1e3)}killSourceNode({id:e,nodes:t,pitch:i,startTime:s,maxStopTime:r,isPreview:n}){const{context:u}=d;_(`[part ${this.partIdx}] kill buffer source node id ${e} for pitch ${i}, startTime ${s}, maxStopTime ${r}, currentTime ${d.context.currentTime}`);const a=Object.keys(t);for(let l=0;l<a.length;l++){const h=a[l],c=t[h];if(h==="srcNode"&&u.currentTime>s&&u.currentTime<r)try{c.stop()}catch(m){if(m.name!=="InvalidStateError")throw m}c.disconnect(),delete t[h]}n&&delete this.playingPreview[i]}transpose(e){typeof e!="undefined"&&(this.transposition=e)}getTranspo(){return this.transposition}stopNoteObj(e,t=e.release){_(`[part ${this.partIdx}] stopNoteObj pitch ${e.pitch} started at ${e.startTime} with release ${t}`);const{context:i}=d;let s=t/8;if(e.nodes&&e.nodes.srcGainNode){s=s>0?s:.01,e.nodes.srcGainNode.gain.cancelScheduledValues(i.currentTime),e.nodes.srcGainNode.gain.setTargetAtTime(0,i.currentTime,s),e.timer&&$.clearTimeout(e.timer);let n=e.startTime+.1-i.currentTime;n<0&&(n=0),n+=t,e.timer=this.setNodeKilling(e,n)}}cancelNoteObj(e){if(_(`[part ${this.partIdx}] cancelNoteObj, id ${e.id}, nodes %O`,e.nodes),e.nodes&&e.nodes.srcGainNode){e.nodes.srcGainNode.gain.value=0;const t=e.startTime+e.duration+e.release;this.killSourceNode({id:e.id,nodes:e.nodes,pitch:e.pitch,startTime:e.startTime,maxStopTime:t,isPreview:!1})}}stopNoteWithId(e,t){_(`[part ${this.partIdx}] stopNoteWithId ${e}, forceRelease ${t}`);const i=this.scheduledNotes[e];if(i){this.stopNoteObj(i,t),delete this.scheduledNotes[e];const s=this.playing[i.pitch];for(let r=0;r<s.length;r++)s[r].id===e&&s.splice(r,1)}}cancelNoteWithId(e){_(`[part ${this.partIdx}] cancelNote with id ${e}`);const t=this.scheduledNotes[e];if(t){this.cancelNoteObj(t),delete this.scheduledNotes[e];const i=this.playing[t.pitch];for(let s=0;s<i.length;s++)i[s].id===e&&i.splice(s,1)}}stopNotesWithPitch(e,t){if(_(`[part ${this.partIdx}] stopNotesWithPitch ${e} and apply release ${t}`),this.playing[e]){let i=this.playing[e].shift();for(;i;)this.stopNoteObj(i,t),delete this.scheduledNotes[i.id],i=this.playing[e].shift()}this.playing[e]=[]}stopNotes(e){_(`[part ${this.partIdx}] stop all the notes for sampler, instrumentId: ${this.defaultMidiProgram}, forced release: ${e}`);for(let t=0;t<this.playing.length;t++)this.playing[t].constructor===Array&&this.playing[t].length>0&&this.stopNotesWithPitch(t,e)}stopNotePreview(e){_(`[part ${this.partIdx}] stop note preview for pitch ${e}`);const{context:t}=d;if(this.playingPreview[e]){const i=this.playingPreview[e];if(i&&i.nodes&&i.nodes.srcGainNode){const s=i.release/8;i.nodes.srcGainNode.gain.setTargetAtTime(0,t.currentTime,s>0?s:.01),i.timer&&$.clearTimeout(i.timer);let n=i.startTime+.1-t.currentTime;n<.2&&(n=.2),this.setNodeKilling(i,n,!0)}}}stopNotesPreview(){_(`[part ${this.partIdx}] stop all the notes preview`);const e=Object.keys(this.playingPreview);_(`[part ${this.partIdx}] currently ${e.length} notes preview occuring`);for(let t=0;t<e.length;t++)this.stopNotePreview(e[t])}stopPedalForVoice(e,t){_(`[part ${this.partIdx}] stopPedalForVoice at ${t} for pitch ${e}`);const{context:i}=d;for(let s=0;s<this.playing[e].length;s++){const r=this.playing[e][s];if(r&&r.holding&&r.nodes&&r.nodes.srcNode&&r.startTime<t){const n=r.release/32;if(r.startTime+r.duration<=t){r.nodes.srcGainNode.gain.setTargetAtTime(0,t,n>0?n:.01);const a=t+r.release+1-i.currentTime;this.setNodeKilling(r,a),this.playing[e].splice(s--,1)}else if(r.startTime+r.duration>t){r.stopTime=r.startTime+r.duration,r.nodes.srcGainNode.gain.setTargetAtTime(0,r.stopTime,n>0?n:.01);const a=r.stopTime+r.release+1-i.currentTime;this.setNodeKilling(r,a),this.playing[e].splice(s--,1)}}}}stopPedal(e){for(let t=0;t<this.playing.length;t++)this.playing[t].constructor===Array&&this.playing[t].length>0&&this.stopPedalForVoice(t,e)}setVolume(e){_(`[part ${this.partIdx}] set volume to ${e}`),this.volumeOutput=e,this.outputGain&&(this.outputGain.gain.value=e)}getVolume(){return this.volumeOutput}mute(){this.output&&(this.output.gain.setValueAtTime(0,.1),this.muted=!0)}unmute(){this.output&&(this.output.gain.setValueAtTime(this.volumeOutput||1,.1),this.muted=!1)}isMuted(){return this.muted===!0}setSoloMode(){this.unmute(),this.solo=!0}unsetSoloMode(){this.mute(),this.solo=!1}isSolo(){return this.solo}setReverb(e){let t;_(`[part ${this.partIdx}] set reverb to ${e}`),this.reverbEffect&&(t=e/20,this.reverbEffect.setDuration(t))}getReverb(){return this.reverbEffect?20*this.reverbEffect.getDuration():0}setDrumSet(e){this.drumSet=e}isDrumset(){return this.drumSet}findBestOctaves(){const e=this.sfBuffer[this.defaultMidiProgram].getPitchRange(),t=e[0].octave,i=e[1].octave,s=i-t+1,r=e[0].step==="C"&&!e[0].alter,n=e[1].step==="B"&&!e[0].alter;this.defaultOctave=Math.ceil((s-1)/2)+t;for(let u=t;u<=i;u++)(u===t&&r||u===i&&n||u!==t&&u!==i)&&this.fullOctaves.push(u),this.octaves.push(u)}getDefaultOctave(){return this.octaves.length||this.findBestOctaves(),this.defaultOctave}addSFBuffer(e,t){Object.keys(this.sfBuffer).length||(this.defaultMidiProgram=e),this.sfBuffer[e]=t}enablePreloadMode(){this.preloadMode=!0}disablePreloadMode(){this.preloadMode=!1}disconnectAllNodes(){this.output.disconnect(),this.outputGain.disconnect(),this.reverbEffect&&this.reverbEffect.disconnect&&this.reverbEffect.disconnect()}getMaximumEndTime(e,t,i){const s=this.reverbEffect.getDuration();let r=this.computeStopTime(e.startTime,t.duration,t.release);return r===Number.POSITIVE_INFINITY&&(r=e.startTime+i),r+s}renewWebAudioNodes(){this.disconnectAllNodes(),this.reverbEffect.renewWebAudioNodes();const e=this.output.gain.value,t=this.outputGain.gain.value;this.initGenerator(),this.output.gain.value=e,this.outputGain.gain.value=t,this.connectReverb()}}const Ni=nn;var ds=Math.pow;class on extends Ue{constructor(){super();let e;for(this.nodes=[],this.ready=!1,this.transposition=0,this.drumSet=!1,this.shortenRatio=.95,this.slur=!1,this.solo=!1,this.playing=[],e=0;e<128;e++)this.playing[e]=[];this.playingPreview={},d.context&&(this.reverbEffect=new mi,this.outputGain.connect(this.reverbEffect.input),this.reverbEffect.output.connect(this.output)),this.headerInstrument={},this.tremoloTable=pi.tremolo.pattern,this.instInfo={},this.volumeOutput=1,this.switchOn()}setInstrumentInfo(e){this.instInfo=e,this.transpose(e.transposechromatic),this.sampleList=this.instInfo.samples,typeof this.sampleList=="number"&&(this.sampleList=ct[this.sampleList].samples),typeof e.shorten!="undefined"&&(this.shortenRatio=e.shorten),this.slur=e.slur}getClosestSampleInfo(e){let t,i;for(t=0;t<this.sampleList.length;t++)if(i=this.sampleList[t],e>=i.range.start&&e<=i.range.end||e<i.range.start)return i;return i}computePlaybackRate(e,t){const i=e-t.basenote;return ds(2,i/12)}getNoteInfo(e){const t=this.getClosestSampleInfo(e);return{basenote:t.basenote,detune:t.detune||0,playbackRate:this.computePlaybackRate(e,t),loop:t.loop,sampleRate:t.sampleRate||this.instInfo.sampleRate,filter:t.filter||this.instInfo.filter,attenuation:t.attenuation||this.instInfo.attenuation,envelope:{attack:t.attack||this.instInfo.attack||0,hold:t.hold||this.instInfo.hold||0,decay:t.decay||this.instInfo.decay,sustain:t.sustain||this.instInfo.sustain||1e-5,release:t.release||this.instInfo.release||.1}}}preloadSamples(e,t){t()}getNoteName(e){if(typeof e=="number"){if(e>128&&(e=g.MapUnpitched[e]||129),e>128||e<0)throw new Error("Note out of range")}else this.drumSet&&dt.default.hasInstrumentId(this.headerInstrument,e)&&(e=Number(dt.default.searchInstrumentMIDIUnpitched(this.headerInstrument,e))-1,e>128&&(e=g.MapUnpitched[e]));return e}hasPairNoteRolls(e){return!!(this.instInfo.pairNotes&&this.instInfo.pairNotes[e]&&this.instInfo.pairNotes[e].roll)}playTremolo(e,t){let i,s,r,n,u=1;const a=3;let l,h;const c=e.velocity;let m,f,{duration:p}=e,M=!1;if(Number.isFinite(p)||(M=!0,p=e.origDuration),typeof this.instInfo.tremolo!="undefined"||this.drumSet)if(f=this.drumSet?.5:.7,r=f/ds(2,a),n=1/r,u=p/r,this.instInfo.tremolo==="amplitude")e.lfoVol=d.context.createGain(),s=new fi(n),s.connect(e.lfoVol.gain),s.start(),this.playSample(e,t);else if(this.instInfo.tremolo==="friction"&&!e.pizzicato)for(h=r+.004,e.duration=h,i=0;i<u;i++)e.detuneDiff=i%2===1?Math.random()*30-30:0,e.releaseDiff=i===u-1?0:.5,e.velocity=i%2===1?c:c-.25,this.playSample(e,t),h=e.duration,m=this.tremoloTable[i%this.tremoloTable.length],e.duration=r+m.duration,e.attackDiff=m.attack,t+=h;else if(this.instInfo.tremolo==="strum")for(h=r,e.duration=h,i=0;i<u;i++)e.attackDiff=i===0?0:.01,e.releaseDiff=0,e.velocity=Math.random()*.5+c-.5,this.playSample(e,t),h=e.duration,e.duration=Math.random()*.001+r-5e-4,t+=h;else if(this.hasPairNoteRolls(e.note))for(l=this.getPairNote(e.note),i=0;i<u;i++)this.playSample(e,t+i++*r),i<u&&this.playSample(l,t+i*r);else for(h=r,e.duration=M?Number.POSITIVE_INFINITY:h,i=0;i<u;i++)this.drumSet?(e.detuneDiff=i%2===1?Math.floor(Math.random()*50)-50:Math.floor(Math.random()*20),e.velocity=Math.random()*.4+c-.2):e.velocity=Math.random()*.6+c-.3,this.playSample(e,t),t+=h,h=Math.random()*1e-4+r-5e-5,e.duration=M?Number.POSITIVE_INFINITY:h}playTrill(e,t){let i,s,r=!1,n,{duration:u}=e;const a=e.note,h=.7/8;let c=h;try{s=this.getNoteName(e.trillPitch)}catch(M){return}Number.isFinite(u)||(r=!0,u=e.origDuration),u>=h*7?c=h*4:u>=h*5&&(c=h*2);const m=(u-c)/h>>0,f=m/2,p=.15/f;for(n=c,e.duration=r?Number.POSITIVE_INFINITY:n,this.playSample(e,t),t+=n,i=0;i<m;i++)n=Math.random()*2e-4+h-1e-4,e.duration=r?Number.POSITIVE_INFINITY:n,i<f?e.velocity+=p:i>=f&&(e.velocity-=p*2),e.note=i%2===0?s:a,this.playSample(e,t),t+=n}playOrnamentalSequence(e,t){let i=!1,{velocity:s}=e;Number.isFinite(e.duration)||(i=!0);const r=e.ornamentalSequence.length,n=r/2,u=.15/n;for(let a=0;a<r;a++){const l=e.ornamentalSequence[a],h=Math.random()*2e-4+l.duration-1e-4;a<n?s+=u:a>=n&&(s-=u*2),l.duration=i?Number.POSITIVE_INFINITY:l.duration,this.playSample({note:l.pitch,duration:l.duration,velocity:s,pizzicato:e.pizzicato,release:e.release},t),t+=h}}playNote(e,t=d.context.currentTime){try{e.note=this.getNoteName(e.pitch)}catch(i){return null}return e.release=this.release,e.velocity=e.velocity||.8,e.ornaments&&e.ornaments.length>0?this.playOrnaments(e,t):e.glissando?this.playGlissando(e,t):this.playSampleNormal(e,t)}scheduleNote(e,t){let i;if(typeof e.pauseOffset=="undefined"){try{e.note=this.getNoteName(e.pitch)}catch(s){return null}e.velocity=e.velocity||.8}return!Number.isFinite(e.duration)&&this.instInfo.maxDuration&&(e.duration=this.instInfo.maxDuration),e.ornaments&&e.ornaments.length>0?i=this.playOrnaments(e,t):e.glissando?i=this.playGlissando(e,t):i=this.playSampleNormal(e,t),i}playOrnaments(e,t){return e.ornaments[0]===R.A.TREMOLO?this.playTremolo(e,t):e.ornaments[0]===R.A.TRILLMARK&&!this.drumSet?this.playTrill(e,t):e.ornamentalSequence?this.playOrnamentalSequence(e,t):this.playSampleNormal(e,t)}playGlissando(e,t){let i,s=!1,{totalDuration:r}=e.glissando;const n=e.glissando.pitch,u=Math.abs(n-e.pitch);let a;if(this.instInfo.glissando==="slide")e.slide=!0,this.playSample(e,t);else{if(a=.05,Number.isFinite(e.duration)&&(e.duration=a),u*a>r&&(a=r/(u+1)),delete e.glissando,e.pitch<n)for(i=e.pitch;i<n;i++){try{e.note=this.getNoteName(i)}catch(l){s=!0}s||(this.playSample(e,t),t+=a,r-=a)}else for(i=e.pitch;i>n;i--){try{e.note=this.getNoteName(i)}catch(l){s=!0}s||(this.playSample(e,t),t+=a,r-=a)}s||(e.pitch=n,e.duration=r,this.scheduleNote(e,t))}}playSampleNormal(e,t){return(Number.isNaN(e.duration)||this.drumSet)&&(e.duration=Number.POSITIVE_INFINITY),typeof e.pauseOffset=="undefined"&&(e.sampleStart=e.pauseOffset),this.playSample(e,t)}playSample(e,t){const{lfoVol:i}=e,s=e.srcVol||d.context.createGain(),r=e.src||d.context.createBufferSource(),n=d.context.createGain();let u,a,l,h;t=t||d.context.currentTime,e=JSON.parse(JSON.stringify(e)),e.duration===null&&(e.duration=Number.POSITIVE_INFINITY);const c=this.getNoteInfo(e.note),m=e.detuneDiff||0,f=e.filters||[];return f.length>0||typeof c.filter!="undefined"?(f.unshift(c.filter),this.applyFilters(f,s)):s.connect(this.outputGain),r.connect(n),n.gain.setTargetAtTime(1,t,.01),c.attenuation&&n.gain.setTargetAtTime(c.attenuation,t,.01),i?(n.connect(i),i.connect(s)):n.connect(s),e.pizzicato&&(h="pizzicato"),this.computeEnvelope(e,c),s.gain.setValueAtTime(0,t),s.gain.linearRampToValueAtTime(e.velocity,t+c.envelope.attack),c.envelope.decay&&s.gain.setTargetAtTime(c.envelope.sustain,t+c.envelope.attack+c.envelope.hold,c.envelope.decay/8),e.slide&&(u=g.MIDIToFreq(e.note),a=g.MIDIToFreq(e.glissando.pitch),l=a/u,r.playbackRate.setValueCurveAtTime(new Float32Array([1,(l-1)*.1+1,l]),t,e.duration)),this.saveNote(r,s,e,t),this.sfBuffer.getNote(c.basenote,h).then(p=>{r.buffer=p,r.detune&&c.detune+m&&r.detune.setValueAtTime(c.detune+m,t),r.playbackRate.setValueAtTime(c.playbackRate,t),c.loop&&(r.loop=!0,r.loopStart=c.loop.start/c.sampleRate,r.loopEnd=c.loop.end/c.sampleRate),this.playSourceNode(r,s,e,t)}),{srcVol:s,src:r}}playSourceNode(e,t,i,s){i.sampleStart?e.start(s,i.sampleStart):e.start(s),i.duration&&i.duration>0&&Number.isFinite(i.duration)&&(t.gain.setTargetAtTime(0,s+i.duration,i.release/8),e.stop(s+i.duration+i.release+1),this.setNodeKilling(e,t,i,s-d.context.currentTime+i.duration+i.release+1))}createFilter(e){const t=d.context.createBiquadFilter();return t.type=e.type,t.frequency.setValueAtTime(e.frequency,0),t.Q.setValueAtTime(e.Q||0,0),t.gain.setTargetAtTime(e.gain||0,0,.01),t}applyFilters(e,t){let i,s,r=null;for(i=0;i<e.length;i++)s=this.createFilter(e[i]),r?r.connect(s):t.connect(s),r=s;s.connect(this.outputGain)}computeEnvelope(e,t){t.envelope.attack=this.getAttack(e,t),e.duration=this.getDuration(e.duration,e.slurIdx),e.velocity=this.getVelocity(e.slurIdx,e.velocity),e.release=this.getRelease(e,t)}getAttack(e,t){let{attack:i}=t.envelope;const s=e.attackDiff||0;return i+=s,i}getDuration(e,t){if(t!==null){if(this.slur)return t<2?e*1.1:e*.8;if(t===2)return e*.75}return e*this.shortenRatio}getVelocity(e,t){if(this.slur){if(e>0)return t*.85}else{if(e===1)return t*.9;if(e===2)return t*1.15}return t}getRelease(e,t){const i=e.releaseDiff||0;return t.envelope.release+i}saveNote(e,t,i,s){const r={sample:e,gain:t,release:i.release,startTime:s,stopTime:s+i.duration+i.release+1,duration:i.duration,origDuration:i.origDuration};i.preview?this.playingPreview[i.note]=r:this.playing[i.note].push(r)}setNodeKilling(e,t,i,s){return $.setTimeout(()=>{this.killSourceNode(e,t,i.note,i.preview)},s*1e3)}killSourceNode(e,t,i,s){t.disconnect(),e.disconnect(),s&&delete this.playingPreview[i]}stopNote(e,t){let i,s=t;if(this.playing[e])for(i=this.playing[e].shift();i;)typeof t=="undefined"&&(s=i.release/8),i.gain.gain.setTargetAtTime(0,d.context.currentTime,s),i.timer&&$.clearTimeout(i.timer),i.timer=this.setNodeKilling(i.sample,i.gain,{note:e,preview:!1},i.release),i=this.playing[e].shift()}stopVoice(e,t){for(let i=0,s=this.playing[e].length;i<s;i++)this.stopNote(e,t);this.playing[e]=[]}stopNotes(e){for(let t=0;t<this.playing.length;t++)this.playing[t].constructor===Array&&this.playing[t].length>0&&this.stopVoice(t,e)}stopNotePreview(e){let t;this.playingPreview[e]&&(t=this.playingPreview[e],t&&(t.gain.gain.setTargetAtTime(0,d.context.currentTime,t.release/8),t.timer&&$.clearTimeout(t.timer),this.setNodeKilling(t.sample,t.gain,{note:e,preview:!0},t.release)))}stopNotesPreview(){const e=Object.keys(this.playingPreview);for(let t=0;t<e.length;t++)this.stopNotePreview(e[t])}stopPedalForVoice(e,t){let i,s;for(i=0;i<this.playing[e].length;i++)s=this.playing[e][i],s.startTime<t&&s.startTime+s.origDuration<=t?s.gain.gain.setTargetAtTime(0,t,s.release/32):s.startTime<t&&s.startTime+s.origDuration>t&&(s.duration=s.origDuration,s.stopTime=s.startTime+s.duration,s.gain.gain.setTargetAtTime(0,s.stopTime,s.release/8))}stopPedal(e){for(let t=0;t<this.playing.length;t++)this.playing[t].constructor===Array&&this.playing[t].length>0&&this.stopPedalForVoice(t,e)}transpose(e){typeof e!="undefined"&&(this.transposition=e)}getTranspo(){return this.transposition}setVolume(e){this.volumeOutput=e,this.outputGain&&this.outputGain.gain.setTargetAtTime(e,0,.01)}mute(){this.output&&(this.output.gain.setTargetAtTime(0,0,.01),this.muted=!0)}unmute(){this.output&&(this.output.gain.setTargetAtTime(1,0,.01),this.muted=!1)}isMuted(){return this.muted===!0}setSoloMode(){this.unmute(),this.solo=!0}unsetSoloMode(){this.mute(),this.solo=!1}isSolo(){return this.solo}setDrumSet(e){this.drumSet=e}isDrumset(){return this.drumset}setHeader(e){this.headerInstrument=e}setSFBuffer(e){this.sfBuffer=e}hasMode(e){return this.instInfo.children&&this.instInfo.children[e]}setReverb(e){let t;this.reverbEffect&&(t=e/20,this.reverbEffect.setDuration(t))}getReverb(){return this.reverbEffect?20*this.reverbEffect.getDuration():0}}const an=on,Me=x("dacapo:metronome"),rt=60,Si=61;class un extends Ue{constructor(e){super(),this.init(e),this.timerIds=[],this.sequenceTimerId=null,this.scheduledTicks=[],this.pauseNewScheduling=!1,this.endSequenceTime=0,this.mode=0,this.counter=0,this.active=!1,this.solo=!1}init(e){const t={id:"metronome"};this.smp=new Ni,this.buf=new Ti,this.outputGain.gain.value=.4,this.smp.addSFBuffer(1,this.buf),this.smp.setDrumSet(!0),this.smp.connect(this.outputGain),this.buf.init(t),this.buf.loadSoundfont(e)}tick(e){let t;return this.counter===0?t=rt:t=Si,this.active&&this.smp.playNote(t,.05),this.counter=(this.counter+1)%e,this.counter===0}scheduleTickAt(e,t){const i={time:e,upbeat:t===rt};if(Me(`schedule ${t===rt?"up":"down"} tick at ${e}`),this.active){const s={startTime:e,pitch:t,duration:.05},r=this.smp.playNote(s);i.prms=r,r.then(n=>{n&&(s.noteId=n.noteId)})}this.scheduledTicks.push(i)}scheduleTick(e,t){const i=this.counter===0?rt:Si,s={time:t,upbeat:this.counter===0};if(Me(`schedule ${i===rt?"up":"down"} tick at ${t}`),this.active){const r={startTime:t,pitch:i,duration:.05},n=this.smp.playNote(r);s.prms=n,n.then(u=>{u&&(r.noteId=u.noteId)})}return this.scheduledTicks.push(s),this.counter=(this.counter+1)%e,this.counter===0}rescheduleTick(e){Me(`reschedule tick at new time ${e.time}, upbeat ${e.upbeat}`);const t=e.upbeat?rt:Si;e.prms=this.smp.playNote({startTime:e.time,pitch:t,duration:.05}),e.prms.then(i=>{i&&(e.noteId=i.noteId)})}scheduleSequence(e,t,i){Me(`schedule sequence at ${t}`),this.reset();for(let s=0;s<e.sequences;s++)for(let r=0;r<e.clicks;r++){this.scheduleTick(e.clicks,t);const n=Math.abs(t-d.context.currentTime);t+=e.quarterDuration,i&&this.timerIds.unshift($.setTimeout(i,n*1e3))}return t}reScheduleTicksWithSpeedFromTime(e,t,i){this.pauseNewScheduling=!0,Me("re-schedule metronome ticks with new speed %f (previous speed: %f) at %f",e,t,i);for(let s=0;s<this.scheduledTicks.length;s++){const r=this.scheduledTicks[s];r.time>i&&(r.time=this.computeNewStartTimeWithSpeed(r,e,t,i),this.cancelTick(r),this.rescheduleTick(r))}this.pauseNewScheduling=!1}computeNewStartTimeWithSpeed(e,t,i,s){const n=(e.time-s)*t/i;return s+n}scheduleCountIn(e,t,i,s){const n=e.clicks*e.unitDuration,u=n*e.sequences;this.endSequenceTime=t+u,this.switchOn(),this.unmute(),this.scheduleSequenceRecur(e,n,t,0,i,()=>{this.endSequenceTime=0,s()})}scheduleSequenceRecur(e,t,i,s,r,n){if(Me("scheduleSequenceRecur"),s<e.sequences&&d.context.currentTime+G.WINDOW_SIZE>=i&&(this.scheduleSequence({sequences:1,clicks:e.clicks,quarterDuration:e.unitDuration},i,r),s++,i+=t,s>=e.sequences)){Me("last call of scheduleSequenceRecur"),this.sequenceTimerId=$.setTimeout(n,(i-d.context.currentTime)*1e3);return}this.sequenceTimerId=$.setTimeout(()=>{this.scheduleSequenceRecur(e,t,i,s,r,n)},G.SCHEDULING_INTERVAL,this),Me(`scheduled new timer of ${G.SCHEDULING_INTERVAL}ms, ID: ${this.sequenceTimerId}`)}scheduleCountdown(e,t){this.switchOn(),e.map(i=>{this.scheduleTickAt(t+i.startTime,i.unpitched.midiProgram)}),this.switchOff(),this.solo=!1}isClickTime(){const e=this.scheduledTicks.find(t=>{if(!t.done&&Math.abs(t.time-d.context.currentTime)<.02)return!0});return typeof e!="undefined"?(e.done=!0,!0):!1}scheduleIntro(e,t,i){return Me(`schedule sequence at ${e}`),this.solo=!0,this.switchOn(),e=this.scheduleSequence({sequences:1,clicks:t.beats,quarterDuration:4/t.beatType*i},e),this.switchOff(),this.solo=!1,e}cancelTick(e){e.prms&&e.prms.then(t=>{t.noteId&&this.smp.cancelNoteWithId(t.noteId)})}cancelSequence(){let e;for(this.endSequenceTime=0,this.sequenceTimerId&&$.clearTimeout(this.sequenceTimerId),this.smp.stopNotes(1e-4),e=0;e<this.timerIds.length;e++)$.clearTimeout(this.timerIds[e])}clearScheduledTicks(){this.scheduledTicks=[]}getStartMeasureTimeFrom(e){let t;for(t=this.scheduledTicks.length-1;t>=0;t--)if(this.scheduledTicks[t].time<=e){for(;t>=0&&!this.scheduledTicks[t].upbeat;)t--;return t<0?e:this.scheduledTicks[t].time}return this.scheduledTicks.length>0?this.scheduledTicks[0].time:0}hasScheduledNotesFrom(e){const t=this.scheduledTicks.length-1;return this.scheduledTicks[t].time>e}getNextPossibleTime(){if(typeof this.endSequenceTime=="number"&&this.endSequenceTime>d.context.currentTime)return this.endSequenceTime;let e=d.context.currentTime+.1,t=0;const i=this.scheduledTicks.length-1;return i+1>1&&(t=this.scheduledTicks[i].time-this.scheduledTicks[i-1].time,this.scheduledTicks[i].time+t>e?e=this.scheduledTicks[i].time:t=0),e+t}setMode(e){this.mode=e,this.reset()}getMode(){return this.mode}setCount(e){this.counter=e}getCount(){return this.counter}reset(){this.setCount(0)}switchOff(){this.active=!1}switchOn(){this.active=!0}mute(){this.output.gain.value=0}unmute(){this.output.gain.value=1}isSolo(){return this.solo}setSolo(e){this.solo=e}}const Pi=un;class wo extends Ue{constructor(){super(),this.inputComponents=[],this.soundComponents=[],this.selected=null,this.clickEvent=null,this.dragEvent=null,this.releaseEvent=null}getContext(){return this.graphicContext}addSoundComponent(e,t,i,s){this.soundComponents.push(e),e.connectTo(s),i.connectTo(e)}bindGraphicComponent(e){this.graphicComponents.push(e)}}const Ao=null;class Eo extends Ue{constructor(){super(),this.nodes=[],this.modTarget={freq:null,gain:null},this.audioSource.connect(this.outputGain),this.switchOn()}}const Oo=null;var ft=v(474976),ln=v(601277),ms=v(359932),Ct=v(316197),hn=v(292681);const P=x("dacapo:reader:voicereader");class cn{constructor({partData:e,measureIndex:t,staffIndex:i,id:s,quarterPosStart:r=0,divisions:n=1,transpo:u=0,prevMeasureInfo:a,swing:l=!1,hasSlashNotation:h=!1,measureReader:c}){let m=0;this.id=s,this.partData=e,this.measureIndex=t,this.staffIndex=i,this.measureData=e.measure[t],this.notes=this.measureData.note,this.inSlur=!1,this.slurIdx=null,this.hasSlashNotation=h,this.measureReader=c,this.divisions=n,this.transpo=u,this.currentDivisions=0,this.flagParsed=!1,this.accidentals={},typeof a!="undefined"&&(this.inSlur=a.slur,this.slurIdx=a.slurIdx,m=a.delay),this.init(m,r,l)}init(e=0,t=0,i=!1){P(`init voice ${this.id} with nextNoteDelay ${e} at quarter position ${t}`),this.lastParsedElement={},this.nextNoteDelay=e,this.velocity=se.VELOCITY_DEFAULT,this.keySig={fifths:0},this.measureReader&&(this.keySig=this.measureReader.getKeySignature(this.staffIndex)),this.currentNoteIndex=0,this.nextNoteSwung=!1,this.currentNoteDuration=0,this.timeFromNoteStart=0,this.quarterPosition=this.initIndexes(t,i),this.wedge=null}initIndexes(e=0,t=!1){let i,s=0,r=0;for(P(`[initIndexes] init indexes for voice ${this.id} at quarter pos ${e}, swing flag is ${t}`),i=0;i<this.notes.length;i++){const n=this.notes[i],u=T.default.getVoiceIdx(n);if(!n.chord&&u===this.id){if(s>=e){this.noteIndex=i,this.currentNoteIndex=r;const l=s-e;return this.nextNoteDelay+=l,P(`[initIndexes] found matching note at index ${i}, idx in voice is ${r} and nextNoteDelay is ${this.nextNoteDelay}`),s}const a=(n.duration||0)/this.divisions;s+=a,P(`[initIndexes] quarter pos updated to ${s} with duration ${a} at idx ${i}`),r++}}if(s===0&&(this.noteIndex=i,this.currentNoteIndex=i),e>=s)this.noteIndex=i,this.currentNoteIndex=i;else{this.noteIndex=i,this.currentNoteIndex=r;const n=s-e;this.nextNoteDelay+=n}return s}setMeasureData(e){P(`force set measure data for voice ${this.id}`),this.measureData=e,this.notes=e.note,this.divisions=e.$adagio.attributes.divisions,this.currentDivisions=0,this.flagParsed=!1,this.init(this.nextNoteDelay,this.quarterPosition)}isFinished(){return this.noteIndex>=this.notes.length}getNoteCount(){const e=this.id;return this.notes.reduce((t,i)=>T.default.getVoiceIdx(i)===e?t+1:t,0)}substractElapsedTime(e){P(`substract elapsed time ${e} from nextNoteDelay ${this.nextNoteDelay} to voice ${this.id}`),this.nextNoteDelay-=e,P(`next note delay after substracting elapsed time: ${this.nextNoteDelay}`),this.timeFromNoteStart+=e,g.epsEqu(this.nextNoteDelay,0)&&(this.nextNoteDelay=0)}nextNoteReached(){return this.nextNoteDelay<=0}getParsedElement(){const e=this.lastParsedElement;return this.lastParsedElement={},e}parseGraceNotesAndInvalidNotes(){const e=[];let t,i=!1,s=this.notes[this.noteIndex];for(;s&&(!s.duration||s.duration==="0");){if(T.default.getVoiceIdx(s)===this.id)if(s.grace){typeof s.chord=="undefined"&&(t=[],e.push(t),i=!1,T.default.isSlashedGrace(s)&&(i=!0));const n={pitch:this.getNotePitch(),slurIdx:null};i&&(n.accacciatura=!0),t.push(n)}else this.currentNoteIndex++;this.noteIndex++,s=this.notes[this.noteIndex]}return e}moveIdxToNextNoteFromVoice(){for(;this.noteIndex<this.notes.length;this.noteIndex++){const e=this.notes[this.noteIndex];if(T.default.getVoiceIdx(e)===this.id)return}}getNotesToPlay(e){let t=!1;const i=[];let s=0,r=0,n=[],u=!1,a=Number.POSITIVE_INFINITY,l=[],h=[],c=!1,m=!1;this.flagParsed&&this.currentNoteIndex++,P(`get notes to play for voice ${this.id}`),this.flagParsed=!0;const f=this.parseGraceNotesAndInvalidNotes();let p=this.notes[this.noteIndex];for(;p&&(p.chord||!t);){const w=[];if(t||(r=p.duration/this.divisions,P(`found chord duration: ${r}`),this.lastParsedElement={idx:this.currentNoteIndex,realIdx:this.noteIndex,voiceId:this.id,duration:r},e&&(this.lastParsedElement.duration=this.getSwingTimeForNote({noteIdx:this.noteIndex,measureIdx:this.measureIndex},this.quarterPosition,r)),P(`register parsed element: { duration: ${this.lastParsedElement.duration} }`),this.hasSlashNotation||(u=T.default.hasArpeggiate(p),n=T.default.getArticulationsList(p),h=T.default.getTechnicalList(p),(h.includes(ms.default.STOPPED)||h.includes(ms.default.SNAP_PIZZICATO))&&(c=!0),l=this.getOrnamentsWithOpts(p),this.updateSlursInfo(p))),s=this.getNoteDuration({swing:e,ornamentsStack:w}),P(`got note full duration (with ties and ornaments) ${s}, also found tied ornaments %o`,w),this.currentDivisions&&(this.divisions=this.currentDivisions,this.currentDivisions=0),s<a&&(a=s),!p.rest&&!this.hasSlashNotation&&!T.default.hasTieStop(p)&&!T.default.hasGlissandoStop(p)){const D=this.buildArticulationsEffectsObject({note:p,articulations:n,noteFullDuration:s,swing:e}),k=this.buildSingleNoteObject({note:p,originalDuration:s,articulationsEffects:D,chordOrnaments:l,tiedOrnaments:w});i.push(k)}else p.rest&&(m=!0);this.currentDivisions&&(this.divisions=this.currentDivisions,this.currentDivisions=0),this.noteIndex++,t=!0,p=this.notes[this.noteIndex]}this.moveIdxToNextNoteFromVoice();const M={notesArr:i,voiceId:this.id,quarterPosition:this.quarterPosition,graceNotes:f,chordDuration:a,arpeggio:u};return m&&(M.rest=!0),this.nextNoteDelay===0&&(this.nextNoteDelay=a),this.quarterPosition+=r,this.quarterPosition=g.roundAccurate(this.quarterPosition),this.currentNoteDuration=this.nextNoteDelay,this.timeFromNoteStart=0,c&&(M.mode="pizzicato"),P(`nextNoteDelay set for voice ${this.id}: ${this.nextNoteDelay}`),M}buildSingleNoteObject({note:e,originalDuration:t,articulationsEffects:i,chordOrnaments:s,tiedOrnaments:r}){const n=this.getNotePitch();P("[buildSingleNoteObject] for note pitch %d, with properties %o",n,i);const u={pitch:n,velocityDiff:0,slurIdx:this.slurIdx,staffIdx:T.default.getStaffIdx(e)};Object.assign(u,i),T.default.hasFretData(e)&&(u.guitarString=T.default.getString(e));const a=this.getChordOrnamentsDetailsForSingleNote({note:e,chordOrnaments:s,startTime:0,noteDuration:u.duration}),l=[],h=this.getSingleNotePitchedOrnaments({measureIdx:this.measureIndex,noteIdx:this.noteIndex,noteDuration:t,ornamentsStack:l});return h!==t&&(u.duration=h),l.length>0?Object.assign(l[0],a):Object.keys(a).length>0&&l.push(a),l.push(...r),l.length>0&&(u.ornaments=l),u}buildArticulationsEffectsObject({note:e,articulations:t,noteFullDuration:i,swing:s}){const r={duration:i,velocityDiff:0};return t.includes(ft.default.STACCATO)?(r.duration/=2,r.releaseRatio=.4):t.includes(ft.default.STACCATISSIMO)?(r.duration*=.35,r.velocityDiff=4,r.releaseRatio=.2):t.includes(ft.default.TENUTO)?r.duration+=.1:T.default.hasNotation(e,ln.default.FERMATA)&&(r.duration*=2),t.includes(ft.default.ACCENT)?r.velocityDiff=5:t.includes(ft.default.STRONG)&&(r.velocityDiff=8),s&&this.quarterPosition%1===.5&&(r.velocityDiff+=3),T.default.hasHeadParentheses(e)?r.effects=["ghostNote"]:T.default.getHead(e)===os.A.X&&(r.effects=["deadNote"]),r}getOrnamentsWithOpts(e){const t=T.default.getOrnamentsList(e),i={};if(t.length>0){P(`found ornaments: ${t}`);for(let s=0;s<t.length;s++){const r=t[s];if(typeof e.pitch!="undefined"||r===R.A.TREMOLO||r===R.A.BUZZ){const n=T.default.getOrnamentOpts(e,r);i[r]=n}}}return i}updateSlursInfo(e){T.default.hasSlurStop(e)?(this.inSlur=!1,this.slurIdx=2):T.default.hasSlurStart(e)?(this.inSlur=!0,this.slurIdx=0):this.inSlur?this.slurIdx=1:this.slurIdx=null}getChordOrnamentsDetailsForSingleNote({note:e,chordOrnaments:t,startTime:i,noteDuration:s}){const r={};if(Object.keys(t).length>0){if(Object.assign(r,g.deepCopy(t)),Ne.hasOrnamentalSequence(r)){const n=Ne.getFirstOrnamentalSequenceName(r);r[n].originalPitch=g.deepCopy(e.pitch),r[n].transposition=this.transpo;let u=null;T.default.hasAccidental(e)&&(u=T.default.getAccidental(e));const a={currentAccidental:u,previousAccidentals:this.accidentals,fifths:this.keySig.fifths},l=Ne.getOrnamentalMIDISequence(n,r[n],a);r[n].pitches=l}r.startTime=i,r.duration=s}return r}getSingleNotePitchedOrnaments({measureIdx:e,noteIdx:t,noteDuration:i,ornamentsStack:s,startTime:r=0,quarterFromStart:n}){P(`[getSingleNotePitchedOrnaments] looking for pitched ornaments for note ${t} in measure ${e}, relative startTime ${r}`);let{notes:u}=this;e!==this.measureIndex&&(u=this.partData.measure[e].note);const a=u[t];if(T.default.hasGlissandoStart(a)){const l=this.getInfoObjectForSingleNoteOrnaments(r,s);P("[getSingleNotePitchedOrnaments] found glissando start on note %d in measure %d",t,e);const h=Ct.default.getNumber(a);this.nextNoteDelay===0&&(this.nextNoteDelay=i,P(`[getSingleNotePitchedOrnaments] set new value for nextNoteDelay ${this.nextNoteDelay}`));const c=this.getGlissandoEnd(h,{noteIdx:t+1,measureIdx:e,startTime:r+i,ornamentsStack:s,quarterFromStart:n});l.duration=i,i+=c.duration,l.glissando=c.glissandoObj,this.currentDivisions&&(this.divisions=this.currentDivisions,this.currentDivisions=0)}return i}getInfoObjectForSingleNoteOrnaments(e,t){const i=t.length;if(i>0){const r=t[i-1];if(e===r.startTime)return r}const s={startTime:e};return t.push(s),s}getNextNoteDelay(){return this.nextNoteDelay}noteIsSwingable(e,t){if(!e||!e.duration)return!1;const i=[.5,1.5,.75,.875,1.75,3.5],s=e.duration/t;return i.includes(s)}closestChordIsSwingable({measureIdx:e,noteIdx:t},i){P(`[closestChordIsSwingable] measure ${e}, note ${t}, direction ${i}`);let{divisions:s}=this,{notes:r}=this;if(e!==this.measureIndex){const u=this.partData.measure[e];s=Number(u.$adagio.attributes.divisions),r=u.note}const n=i>0?r.length:-1;for(let u=t;u!==n;u+=i){const a=r[u];if(a&&!a.chord&&T.default.getVoiceIdx(a)===this.id)return this.noteIsSwingable(a,s)}return!1}getTupletFullQuarterDuration(e,t){let{divisions:i}=this,{notes:s}=this;if(e!==this.measureIndex){const u=this.partData.measure[e];i=Number(u.$adagio.attributes.divisions),s=u.note}let r=0,n=0;for(let u=0;u<s.length;u++){const a=s[u];if(typeof a.duration!="undefined"&&!a.chord&&T.default.getVoiceIdx(a)===this.id){const l=a.duration/i;if(r>=t&&(n+=l,T.default.hasTupletStop(a)))return n;r+=l,g.epsEqu(r,t)&&(r=t)}}return n}getTupletStartQuarterTimePos({noteIdx:e,measureIdx:t},i){P(`[getTupletStartQuarterTimePos] at note ${e} in measure ${t} with startQuarterTimePos === ${i}`);let{divisions:s}=this,{notes:r}=this;if(t!==this.measureIndex){const u=this.partData.measure[t];s=Number(u.$adagio.attributes.divisions),r=u.note}e=C.getNoteIdxOfFirstChordNote(r,e,this.id);let n=r[e];if(T.default.hasTupletStart(n))return i;e-=1;for(let u=e;u>=0;u--)if(n=r[u],!n.chord&&T.default.getVoiceIdx(n)===this.id&&n.duration){const a=n.duration/s;if(i-=a,T.default.hasTupletStart(n)){const l=g.roundDecimal(i);return g.epsEqu(l,i)&&(i=l),i}}return 0}getSwingTimeForNote({noteIdx:e,measureIdx:t},i,s){P(`[getSwingTimeForNote] at note ${e} in measure ${t}, startQuarterTimePos ${i}, quarterDuration ${s}`);let{notes:r}=this;t!==this.measureIndex&&(r=this.partData.measure[t].note);const n=r[e];if(!T.default.hasNormalTimeModif(n)){P("[getSwingTimeForNote] note is in tuplet, computing tuplet information...");const a=this.getTupletStartQuarterTimePos({noteIdx:e,measureIdx:t},i);P(`[getSwingTimeForNote] quarter time position of the start of the tuplet ${a}`);const l=this.getTupletFullQuarterDuration(t,a);P(`[getSwingTimeForNote] full tuplet quarter duration ${l}`);const c=this.linearToSwingQuarterDuration(a,l)/l;return s*c}return this.linearToSwingQuarterDuration(i,s)}linearToSwingQuarterDuration(e,t){P(`[linearToSwingQuarterDuration] convert ${t} to swing time`);const i=e+t;let s=0;for(;e<i;){const r=g.floatPart(e);if(P(`[linearToSwingQuarterDuration] startTimePos ${e} < stopTimePos ${i}`),r===0&&i-e>=1)s+=1,e+=1;else if(r<.5){const n=.5-r,u=Math.min(i-e,n);P(`[linearToSwingQuarterDuration] floatPart is smaller than 0.5, apply 2 / 3 on shardDuration: ${u}`),s+=u*2*2/3,e+=u}else if(r<1){const n=1-r,u=Math.min(i-e,n);P(`[linearToSwingQuarterDuration] floatPart is smaller than 1, apply 1 / 3 on shardDuration: ${u}`),s+=u*2*1/3,e+=u}else throw new Error("Should not happen")}return P(`[linearToSwingQuarterDuration] final swing duration ${s}`),s}getGlissandoEnd(e,{measureIdx:t=this.measureIndex,noteIdx:i=this.noteIndex,startTime:s,ornamentsStack:r,quarterFromStart:n}={measureIdx:this.measureIndex,noteIdx:this.noteIndex}){let u;P(`[getGlissandoEnd] searching glissando stop from note ${i} in measure ${t}, relative startTime ${s}`);for(const a=this.partData.measure.length;t<a;t++){for(;i<this.partData.measure[t].note.length;i++)if(u=this.partData.measure[t].note[i],u&&T.default.getVoiceIdx(u)===this.id&&T.default.hasGlissandoStop(u)&&Ct.default.getNumber(u)===e){P(`[getGlissandoEnd] found glissando stop at note ${i} in measure ${t}`);let l=this.getNoteDuration({measureIdx:t,noteIdx:i,startNote:u,ornamentsStack:r,durationFromStart:s,quarterFromStart:n});P(`[getGlissandoEnd] found glissando stop note duration ${l}`);const h={pitch:g.NoteNameToMIDI(u.pitch)+this.transpo};if(T.default.hasFretData(u)&&(h.guitarString=T.default.getString(u)),T.default.hasGlissandoStart(u)){const c=s+l;P("[getGlissandoEnd] found glissando stop is chained to another glissando");const m={startTime:s,duration:l};r.push(m);const f=Ct.default.getNumber(u),p=this.getGlissandoEnd(f,{measureIdx:t,noteIdx:i+1,startTime:c,ornamentsStack:r,quarterFromStart:n});l+=p.duration,m.glissando=p.glissandoObj}return{duration:l,glissandoObj:h}}i=0}return null}buildGlissandoObj({note:e,measureIdx:t,noteIdx:i,startTime:s,duration:r,ornaments:n}){const u={startTime:s,duration:r};n.push(u);const a=Ct.default.getNumber(e),l=this.getGlissandoEnd(a,{measureIdx:t,noteIdx:i+1,startTime:s+r,ornaments:n});u.glissando=l}getNotePitch(){let e;const t=this.notes[this.noteIndex];if(T.default.hasUnpitched(t))e=T.default.getInstrumentId(t);else{const{pitch:i}=t;if(e=g.NoteNameToMIDI(i)+this.transpo,T.default.hasAccidental(t)){const s=`${i.step}${i.octave}`;this.accidentals[s]=T.default.getAccidental(t)}}return e}getNoteQuarterPosition(e,t){const i=this.partData.measure[e],{divisions:s}=i.$adagio.attributes,r=i.note[t];let n=0,u=0;for(let a=0;a<i.note.length;a++){const l=i.note[a];if(T.default.getVoiceIdx(l)===this.id&&l.duration&&!l.chord&&(n+=u,u=Number(r.duration)/s),a===t)return n}return null}getNoteDuration({measureIdx:e,noteIdx:t,startNote:i,durationFromStart:s=0,quarterFromStart:r=0,swing:n=!1,ornamentsStack:u=[]}={}){let a,l;typeof e=="number"&&typeof t=="number"?(a=this.partData.measure[e].note[t],n&&(l=this.getNoteQuarterPosition(e,t))):(e=this.measureIndex,t=this.noteIndex,a=this.notes[t],l=this.quarterPosition),P(`[getNoteDuration] searching duration of note index ${t} in measure ${e} and starting at ${s} since the first note`);let h=Number(a.duration)/this.divisions;return r+=h,P(`[getNoteDuration] original note duration ${h}`),n&&(P("[getNoteDuration] swing is enabled, altering duration..."),h=this.getSwingTimeForNote({noteIdx:t,measureIdx:e},l,h),P(`[getNoteDuration] note duration turned into swing time ${h}`)),T.default.hasTieStart(a)&&(P("[getNoteDuration] note has tie start, start finding tie end"),s+=h,h+=this.findTieEnd({measureIdx:e,noteIdx:t+1,durationFromStart:s,quarterFromStart:r,startNote:i,swing:n,ornamentsStack:u}),P(`[getNoteDuration] found tie end, total tie duration ${h}`)),h}findTieEnd({measureIdx:e,noteIdx:t,durationFromStart:i,quarterFromStart:s,startNote:r,swing:n,ornamentsStack:u}){let a,l,h;for(P(`[findTieEnd] look for tie end starting from note ${t} in measure ${e}, relative startTime ${i}`),r=r||this.notes[this.noteIndex],a=this.partData.measure.length;e<a;e++){for(;t<this.partData.measure[e].note.length;t++){l=this.partData.measure[e].note[t];const c=T.default.getVoiceIdx(l);if(c===this.id){for(P(`[findTieEnd] found note in good voice ${c} in measure ${e}, idx ${t}`);this.nextNoteDelay===0&&l&&l.chord;)l=this.partData.measure[e].note[++t];if(typeof l!="undefined"&&(this.nextNoteDelay===0&&(this.nextNoteDelay=i),l.chord||(h=this.getOrnamentsWithOpts(l)),T.default.hasTieStop(l))){if(typeof l.pitch!="undefined"&&r.pitch!=="undefined"&&Xe.default.isSamePitch(l.pitch,r.pitch)){P("[findTieEnd] found note has same pitch and tie stop, check duration...");let m=this.getNoteDuration({measureIdx:e,noteIdx:t,startNote:r,durationFromStart:i,quarterFromStart:s,ornamentsStack:u,swing:n});if(P(`[findTieEnd] duration of tie stop note found : ${m}`),Object.keys(h).length>0&&(h=this.getChordOrnamentsDetailsForSingleNote({note:l,chordOrnaments:h,startTime:i,noteDuration:m}),P("[findTieEnd] add chordOrnaments to the ornamentsStack",JSON.stringify(h)),u.push(h)),!T.default.hasTieStart(l)){P(`[findTieEnd] note doesn't have a tie start, so check for ornaments at idx ${t} in measure ${e}`);const f=this.getSingleNotePitchedOrnaments({measureIdx:e,noteIdx:t,noteDuration:m,ornamentsStack:u,startTime:i,quarterFromStart:s});f!==m&&(P(`[findTieEnd] found glissando starting after tie, total noteDuration is ${f}`),m=f)}return m}if(typeof l.unpitched!="undefined"&&r.unpitched!=="undefined"&&hn.default.isSame(l.unpitched,r.unpitched))return this.getNoteDuration({measureIdx:e,noteIdx:t,startNote:r,durationFromStart:i,quarterFromStart:s,swing:n})}}}t=0,e+1<a&&(this.currentDivisions||(this.currentDivisions=this.divisions),this.divisions=this.partData.measure[e+1].$adagio.attributes.divisions)}return 0}isValidNote(e){return typeof e.duration!="undefined"&&Number(e.duration)>0&&!e.chord&&T.default.getVoiceIdx(e)===this.id}getVoiceDurationInRange(e,t){let i,s,r=t,n=0;for(typeof e=="undefined"&&(e=0),this.checkNoteIndex(e),typeof t=="undefined"&&(t=this.notes.length-1,r=this.notes.length),this.checkNoteIndex(t),i=t;i>e&&!this.isValidNote(this.notes[i]);)i--;if(i===e)throw new at(t,"It is either a chord note, a note without duration or on a different voice.");for(i<t&&(t=i,r=i),i=e||0;i<r;i++)s=this.notes[i],this.isValidNote(s)&&(n+=s.duration/this.divisions);return n}findLocationFromTime(e,t,i){let s,r,n,u,a,l=0;const h={isLastMeasureNote:!1};let c=-1,m=-1;for(a=e,s=0;s<this.notes.length&&a<=i;s++){if(u=l,n=a,r=this.notes[s],this.isValidNote(r)){const f=r.duration/this.divisions;l+=f,a+=f*t,c++}m++}return h.currentNoteIdx=c,h.currentNoteRealIdx=m,h.timeFromNoteStart=i-n,h.timeFromMeasureStart=i-e,h.currentNoteDuration=r.duration/this.divisions,h.currentVoiceId=this.id,h.quarterNotePos=u,(m+1>=this.notes.length||!this.nextNoteIsSameVoice(m))&&(h.isLastMeasureNote=!0),h}nextNoteIsSameVoice(e){for(let t=e+1;t<this.notes.length;t++){const i=this.notes[t];if(!i.chord&&i.duration&&Number(i.duration)>0)return T.default.getVoiceIdx(i)===this.id}return!1}checkNoteIndex(e){if(e<0||e>=this.notes.length)throw new Vi(e)}}const fs=cn;var xe=v(868743),j=v(607801),dn=v(759240),mn=v(743475),fn=v(446921),pn=v(614653),K=v(515819),kt=v(377180),Rt=v(584416),_t=v(209175),gn=v(668674),yn=v(555172),bn=v(269032);const F=x("dacapo:measurereader");class Mi{constructor({data:e,partIdx:t,measureIdx:i=0,quarterPosStart:s=0,commonContent:r,mapping:n,sliderVoice:u=0,partReader:a=null}){F("instanciating MeasureReader"),this.idx=i,this.data=e,this.partIdx=t,this.partData=e.score["score-partwise"].part[t],this.commonContent=r,this.partReader=a,this.nbStaff=fn.A.getNbStaves(this.partData),this.mapping=n,this.qpm=g.TEMPO_DEFAULT,this.unitDuration=60/this.qpm*A.playbackSpeed,this.sliderVoice=u,this.pizzicatoPart=!1,this.mutePart=!1,this.swing=A.swing,this.nextMeasureSwing=null,this.voiceMap={},this.init({quarterPosStart:s})}init({voicesOpts:e,prevDynamics:t,pizzStatus:i,muteStatus:s,quarterPosStart:r=0}={quarterPosStart:0}){if(F(`init MeasureReader for measure ${this.idx}`),this.newMeasure=r===0,this.timePastInMeasure=r,this.divisions=1,this.voices=[],this.played=!1,this.dynamics=[],this.allDynamicsByTime={},this.wedgeInitStack=[],this.lastVelocity=se.VELOCITY_DEFAULT,this.pedals=[],this.pedalsIdx=0,this.pedalActive=!1,this.pizzicatos=[],this.pizzicatoIdx=0,this.pizzActive=i,this.mutes=[],this.muteIdx=0,this.muteActive=s,this.harmonies=[],this.harmonyIdx=0,this.slashes=[],this.hasOnlySlashes=!1,this.slashDurationSequence=null,this.measureData=null,this.measureData=this.partData.measure[this.idx],this.measureData){this.uuid=this.data.getMeasureUuid(this.idx),F(`new measure uuid ${this.uuid}`),this.barline=this.measureData.barline,this.rightBarline=I.default.getRightBarline(this.measureData),this.divisions=I.default.getDivisionsPerQuarter(this.measureData),this.beatType=this.measureData.$adagio.attributes.time["beat-type"],this.beats=this.measureData.$adagio.attributes.time.beats;const n=I.default.getTranspose(this.measureData);this.transpo=kt.default.getChromatic(n[0])+kt.default.getOctaveChange(n[0])*12,this.tempo=this.commonContent.getTempo(this.idx),this.qpm=tt.default.getQpm(this.tempo)>>0,this.qpm=this.qpm>g.TEMPO_MAX?g.TEMPO_MAX:this.qpm,this.unitDuration=60/this.qpm*A.playbackSpeed;const u={nbDots:tt.default.getNbDots(this.tempo),durationType:tt.default.getDurationType(this.tempo)};this.bpm=this.qpm*K.default.durationOptsToQuarter(u),this.beatDuration=60/this.bpm;const a=this.getRepeatedVoices();this.initSwing(),this.initPedal(),this.initPizzicato(),this.initMutes(),this.initDynamics(t),this.initJazzHarmonies(),this.initSlashes(),this.hasNotes=this.hasNotesInMeasure(),F("repeatedVoices %O",a),this.initVoices({voicesOpts:e,repeatedVoices:a,quarterPosStart:r})}}getRepeatedVoices(){const e={};for(let t=0;t<this.nbStaff;t++)if(I.default.hasMeasureRepeat(this.measureData,t)){const i=this.getLastNormalMeasureForStaffIdx(t);if(i){const s=C.getVoicesInStaff(i,t);Object.assign(e,s)}}return e}getLastNormalMeasureForStaffIdx(e){for(let t=this.idx-1;t>=0;t--){const i=this.partData.measure[t];if(!I.default.hasMeasureRepeat(i,e))return i}return null}initSwing(){F("init swing");let e=this.commonContent.getSwing(this.idx);typeof e=="object"&&(e=!!e.swing),typeof e!="boolean"&&(e=!1),this.swing=e,this.nextMeasureSwing!==null&&(this.swing=this.nextMeasureSwing,this.nextMeasureSwing=null),F(`swing is ${this.swing}`)}initJazzHarmonies(){F("init jazz harmonies");const e=I.default.getJazzHarmonies(this.measureData);for(let t=0;t<e.length;t++){const i=e[t];this.harmonies.push({time:pn.default.getTimePos(i)/this.divisions,harmony:i})}this.harmonies.sort((t,i)=>t.time-i.time)}initPedal(){for(let e=0;e<this.nbStaff;e++){I.default.hasLeftPedal(this.measureData,e)&&(this.pedalActive=!0);const t=I.default.getPedals(this.measureData,e);for(let i=0;i<t.length;i++){const s=Rt.A.getTimePos(t[i])/this.divisions,r=Rt.A.getType(t[i]),n={time:s,type:r,staffIdx:e};this.pedals.push(n)}}for(let e=0;e<this.pedals.length;e++){const t=this.pedals[e];if(t.type===xe.A.START)if(e<this.pedals.length-1){const i=this.pedals[e+1];t.duration=(i.time-t.time)*this.unitDuration}else t.duration=this.computePedalDuration(t.time,t.staffIdx)}this.pedals.sort((e,t)=>e.time-t.time)}initPizzicato(){if(this.pizzicatoPart){if(!this.pizzActive){const e=this.getLastMeasureMode("pizzicato",this.idx);this.pizzActive=e===Ze.A.PIZZICATO}this.cacheCurrentMeasureModes(this.pizzicatos,I.default.getPizzicatos,xt.A)}}initMutes(){if(this.mutePart){if(typeof this.muteActive=="undefined"){const e=this.getLastMeasureMode("mute",this.idx);this.muteActive=e===Pt.A.ON}this.cacheCurrentMeasureModes(this.mutes,I.default.getMutes,Yi.A)}}cacheCurrentMeasureModes(e,t,i){for(let s=0;s<this.nbStaff;s++){const r=t(this.measureData,s);for(let n=0;n<r.length;n++)e.push({time:i.getTimePos(r[n])/this.divisions,type:i.getType(r[n])})}e.sort((s,r)=>s.time-r.time)}initDynamicsStaves(e){F("initDynamicsStaves");for(let t=0;t<this.nbStaff;t++){let i=se.VELOCITY_DEFAULT,s=null;e&&e[t]&&(i=e[t].velocity,s=e[t].ongoingWedge),this.dynamics.push({velocity:i,dynamicsArray:[],dynamicsIdx:0,wedgeArray:[],wedgeIdx:0,ongoingWedge:s})}}initDynamics(e){!e&&this.idx>0?this.registerLastDynamics():this.initDynamicsStaves(e);for(let t=0;t<this.nbStaff;t++){const i=I.default.getDynamics(this.measureData,t),s=I.default.getWedges(this.measureData,t);this.initStaffDynamics(t,i,s)}}initStaffDynamics(e,t,i){F(`initStaffDynamics for staffIdx ${e}`),this.allDynamicsByTime[e]=C.mergeDynamicsAndWedgesByTime(t,i,this.divisions);const s=Object.keys(this.allDynamicsByTime[e]);for(let r=0;r<s.length;r++){const n=s[r],u=this.allDynamicsByTime[e][n];this.initDynamicsAtTimePos(e,u)}}initDynamicsAtTimePos(e,t){F(`initDynamicsAtTimePos, staffIdx ${e}`);const i=t[et.A.DYNAMIC],s=t[et.A.WEDGE];if(!s||s.length===0){this.saveTextDynamicDirection(e,i);return}for(let r=0;r<s.length;r++){const n=s[r],u=B.A.getWedge(n);if(ke.A.getLocation(u)===Ce.A.LEFT){const a=this.findWedgeStartVelocity(e,i);this.saveWedgeDirection(e,n,a)}}}saveTextDynamicDirection(e,t){const i=C.convertDynamicDirectionToVelocity(t);if(i>=0){const s=this.dynamics[e],r={time:B.A.getTimePos(t)/this.divisions,staff:e,velocity:i};if(!C.locationIsInWedgeRange({measureIdx:this.idx,quarterPos:r.time},s)){let n=s.dynamicsArray.length;for(;n>0&&r.time<s.dynamicsArray[n-1].time;)n--;s.dynamicsArray.splice(n,0,r)}}}findWedgeStartVelocity(e,t){if(t)return C.convertDynamicDirectionToVelocity(t);const i=this.dynamics[e];let s=i.velocity,r=0;const n=i.dynamicsArray;if(n&&n.length>0){const a=n[n.length-1];s=a.velocity,r=a.time}const u=i.wedgeArray;if(u&&u.length>0){const a=u[u.length-1];a.stop.time>=r&&(s=a.stop.velocity)}else i.ongoingWedge&&i.ongoingWedge.stop.time>=r&&(s=i.ongoingWedge.stop.velocity);return s}saveWedgeDirection(e,t,i){F(`saveWedgeDirection for staffIdx ${e} and with startVelocity ${i}`);const s=B.A.getTimePos(t)/this.divisions,r={velocity:i,measureIdx:this.idx,timePos:s},n=this.createWedgeObject(e,t,r);this.dynamics[e].wedgeArray.push(n)}createWedgeObject(e,t,i){const s=B.A.getWedge(t),r=ke.A.getType(s),n=this.findWedgeStopInfo(e,r,i),u=C.getNbChordsInNotesArray(n.notesInWedge)-1,a=C.computeVelocityStepInWedge(i.velocity,n.velocity,u);return{type:r,staff:e,nbNotes:u,velocityInterval:a,start:{time:i.timePos,measure:i.measureIdx,velocity:i.velocity},stop:{time:n.timePos,measure:n.measureIdx,velocity:n.velocity}}}findWedgeStopInfo(e,t,i){i=g.deepCopy(i);const s=[];let r=i.measureIdx===this.idx,n;for(let u=i.measureIdx;u<this.partData.measure.length;u++){const a=this.partData.measure[u];r?n=this.findWedgeStopInCurrentMeasure(e,t,i):n=C.findWedgeStopInMeasure(a,u,e,t,i);const l=C.filterMeasureNotesInWedge(a,e,i.timePos,n);if(s.push(...l),typeof n!="undefined")return n.measureIdx=u,C.updateWedgeStopIfEndTimePos(e,n,this.partData)&&s.push(...C.getNotesAtTimePos(this.partData,{staffIdx:e,measureIdx:n.measureIdx,timePos:0})),{velocity:n.velocity,timePos:n.timePos,measureIdx:n.measureIdx,notesInWedge:s};i.timePos=0,r=!1}return{velocity:t===Mt.A.CRESCENDO?li.MAX:se.MINIMUM_VELOCITY,timePos:0,measureIdx:this.partData.measure.length,notesInWedge:s}}findWedgeStopInCurrentMeasure(e,t,i){const s=this.allDynamicsByTime[e],r=Object.keys(s);let n=r.indexOf(i.timePos.toString());for(n++;n<r.length;n++){const u=Number.parseFloat(r[n]),a=s[u];if(C.containsWedgeStop(a))return typeof a[et.A.DYNAMIC]!="undefined"?{velocity:C.convertDynamicDirectionToVelocity(a[et.A.DYNAMIC]),timePos:u}:{velocity:C.getWedgeDefaultStopVelocity(i.velocity,t),timePos:u}}}registerLastDynamics(){F("registerLastDynamics");for(let e=0;e<this.nbStaff;e++){const t=this.getLastVelocityState(e);this.dynamics[e]={velocity:t.velocity,dynamicsArray:[],dynamicsIdx:0,wedgeIdx:0,wedgeArray:[],ongoingWedge:t.ongoingWedge}}}getLastVelocityState(e,t=this.idx,i=0){const s=C.getLastDynamicBefore(this.partData,{staffIdx:e,measureIdx:t,quarterPos:i});if(!s)return this.applyWedgesInBetweenToVelocity(se.VELOCITY_DEFAULT,0,0,e);const r=C.getLastWedgeFrom(this.partData,e,s.measureIdx,s.quarterPos);if(!r||s.measureIdx===r.measureIdx&&s.quarterPos===r.quarterPos||ke.A.getLocation(B.A.getWedge(r.wedge))===Ce.A.RIGHT){const n=C.convertDynamicDirectionToVelocity(s.dynamic);return this.applyWedgesInBetweenToVelocity(n,s.quarterPos,s.measureIdx,e)}return this.getLastVelocityState(e,r.measureIdx,r.quarterPos)}applyWedgesInBetweenToVelocity(e,t,i,s){let r=Ce.A.RIGHT,n=null,u=null,a=null,l=!0;for(;i<this.idx;i++){const h=this.partData.measure[i],c=I.default.getWedges(h,s);let m=0;if(c.length>0){if(a=i,l){const f=I.default.getDivisionsPerQuarter(h);m=c.findIndex(p=>{const M=B.A.getWedge(p);return ke.A.getLocation(M)===Ce.A.LEFT&&B.A.getTimePos(p)/f>=t}),l=!1}if(m>=0){for(m;m<c.length;m++)if(n=c[m],u=B.A.getWedge(n),r=ke.A.getLocation(u),r===Ce.A.RIGHT){const f=ke.A.getType(u);e=C.getWedgeDefaultStopVelocity(e,f)}}}}if(u&&r===Ce.A.LEFT){const h=this.createOngoingWedgeObject(s,n,e,a);return e=C.computeCurrentVelocityFromOngoingWedge(h),{velocity:e,ongoingWedge:h}}return{velocity:e,ongoingWedge:null}}createOngoingWedgeObject(e,t,i,s){const r=this.partData.measure[s],n=I.default.getDivisionsPerQuarter(r),u=B.A.getTimePos(t)/n,a={velocity:i,measureIdx:s,timePos:u},l=this.createWedgeObject(e,t,a),h=this.countChordsFromPosToCurrentMeasure(s,e,u)-1;return l.stepsRemaining=l.nbNotes-h,l}countChordsFromPosToCurrentMeasure(e,t,i){let s=0,r=this.partData.measure[e];for(;e<this.idx;e++)r=this.partData.measure[e],s+=C.getChordCountFromTimePos(r,i),i=0;return s}initSlashes(){let e=!1;this.hasOnlySlashes=!0;for(let t=0;t<this.nbStaff;t++)if(I.default.hasSlash(this.measureData,t)){const i=I.default.getSlash(this.measureData,t);gn.A.isUsingStems(i)?this.slashes[t]="rhythmic":(e=!0,this.slashes[t]="slash")}else this.hasOnlySlashes=!1,this.slashes[t]=null;e&&(this.slashDurationSequence=this.buildSlashDurationSequence())}initVoices({voicesOpts:e={},repeatedVoices:t={},quarterPosStart:i=0}){let s=0;const r={};let n=Object.keys(e);for(let a=0;a<n.length;a++){const l=n[a];r[l]=e[l],e[l].delay>s&&(s=e[l].delay)}n=C.getMeasureVoices(this.measureData);const u=Object.keys(t).map(Number);n=g.mergeArrays(n,u);for(let a=0;a<n.length;a++){const l=n[a];typeof r[l]=="undefined"&&(e[l]={delay:s,slur:!1,slurIdx:0});const h=this.mapping[l],c=!!this.slashes[h],m=new fs({partData:this.partData,measureIndex:this.idx,staffIndex:h,id:l,divisions:this.divisions,transpo:this.transpo,prevMeasureInfo:e[l],quarterPosStart:i,swing:this.swing,hasSlashNotation:c,slashDurationSequence:this.slashDurationSequence,measureReader:this});t[l]&&(F(`applying previous measure data for voice ${l}`),m.setMeasureData(t[l])),l===this.sliderVoice?this.voices.unshift(m):this.voices.push(m)}this.buildVoiceMap()}computePedalDuration(e,t){let s=(this.getMeasureQuarterDuration()-e)*this.unitDuration;for(let r=this.idx+1;r<this.partData.measure.length;r++){const n=this.partData.measure[r],u=I.default.getPedals(n,t);for(let h=0;h<u.length;h++){const c=u[h];if(Rt.A.getType(c)===xe.A.STOP){const f=I.default.getDivisionsPerQuarter(n),p=C.getUnitDurationForMeasure(r,this.commonContent,A.playbackSpeed),M=Rt.A.getTimePos(c)/f*p;return s+=M,s}}const a=C.getUnitDurationForMeasure(r,this.commonContent,A.playbackSpeed),l=C.getMeasureDuration(n,a);s+=l}return null}buildVoiceMap(){let e;for(this.voiceMap={},e=0;e<this.voices.length;e++)this.voiceMap[this.voices[e].id]=e}nextMeasure(){const e=this.getVoicesInfo();this.idx++,F(`go to next measure ${this.idx}`),this.init({voicesOpts:e,prevDynamics:this.dynamics,pizzStatus:this.pizzActive,muteStatus:this.muteActive})}jumpToMeasure(e){if(F(`jump to measure ${e}`),e>=0&&e<this.partData.measure.length){const t=this.getVoicesInfo();return this.idx=e,this.init({voicesOpts:t}),!0}return!1}forceEndSong(){return F("forceEndSong"),this.idx=this.partData.measure.length,!0}getVoicesDelay(){const e=[];for(let t=0;t<this.voices.length;t++)this.voices[t]&&(e[this.voices[t].id]=this.voices[t].nextNoteDelay);return e}getVoicesInfo(){const e={};for(let t=0;t<this.voices.length;t++)this.voices[t]&&(e[this.voices[t].id]={delay:this.voices[t].nextNoteDelay,slur:this.voices[t].inSlur,slurIdx:this.voices[t].slurIdx});return e}substractElapsedTime(e){F(`substractElapsedTime ${e}, newMeasure: ${this.newMeasure}`),this.newMeasure?this.newMeasure=!1:this.timePastInMeasure+=e;for(let t=0;t<this.voices.length;t++)this.voices[t]&&this.voices[t].substractElapsedTime(e)}isFinished(){let e=!0;for(let t=0;t<this.voices.length;t++)this.voices[t]&&!this.voices[t].isFinished()&&(e=!1);return e}noMoreDelay(){let e=!0;for(let t=0;t<this.voices.length;t++)this.voices[t]&&!this.voices[t].nextNoteReached()&&(e=!1);return e}getVoiceCount(){return this.voices.length}getSliderVoice(){return this.voices[0].id}getMinDuration(e=!1){let t,i,s=Number.POSITIVE_INFINITY,r;for(t=0;t<this.voices.length;t++)if(this.voices[t]){if(i=this.voices[t].getNextNoteDelay(),i===0&&!e)throw new je({partIdx:this.partIdx,measureIdx:this.idx,voiceId:this.voices[t].id,noteIdx:this.voices[t].noteIndex});s=i<s?i:s}return this.pedalsIdx<this.pedals.length&&(r=this.pedals[this.pedalsIdx],r.type===xe.A.STOP&&r.time-this.timePastInMeasure<s&&r.time-this.timePastInMeasure>0&&(s=r.time-this.timePastInMeasure)),s}getNotes(){let e=[],t;this.played=!1;for(let i=0;i<this.voices.length;i++)if(t=this.voices[i],t&&t.nextNoteReached()&&!t.isFinished()){F(`[part ${this.partIdx}] getNotes() for voice ${t.id} in measure ${this.idx}`);const s=this.voices[i].getNotesToPlay(this.swing);s.measureIdx=this.idx,e=e.concat(s),this.played=!0,this.updateDynamicsForVoice(t.id)}return e.length>0&&(this.fillHarmoniesIfEmpty(e),this.epurNotes(e)),e}epurNotes(e){for(let t=0;t<e.length;t++){const i=e[t];delete i.rest}}getParsedElement(e){let t;if(e<this.voices.length){const i=this.voices[e],s=i.id,r=this.mapping[s];F(`get last parsed element for voice ${s} in staff ${r}`),I.default.hasMeasureRepeat(this.measureData,r-1)?t=this.getDisplayedElemFromQuarterPos(s,this.timePastInMeasure):t=i.getParsedElement(),Object.keys(t).length>0&&(t.quarterDuration=t.duration,t.duration*=this.unitDuration,t.measureIdx=this.idx,t.measureUuid=this.uuid,t.quarterFromMeasureStart=this.timePastInMeasure,t.timePastInMeasure=this.timePastInMeasure*this.unitDuration,t.unitDuration=this.unitDuration,t.isLastMeasureNote=i.isFinished())}return F("got parsed element, %O",t),t}buildSlashDurationSequence(){const e=I.default.getDpq(this.measureData),t=I.default.getAnyTime(this.measureData),i=K.default.getBeatQuarterDuration(t),s=K.default.quarterToDuration(i,e),r=0,n=I.default.getNbDivisions(this.measureData),u=_t.default.createDefault(),a=new dn.A(r,s,n,e,u);a.dispatch();const l=a.getDispatchedRests();for(let h=0;h<l.length;h++){const c=l[h];l[h]=c/e}return l}fillHarmoniesIfEmpty(e){if(!this.harmonies||this.harmonies.length===0||!this.hasOnlySlashes)return;this.updateJazzHarmonies();const t=this.harmonies[this.harmonyIdx];if(!t)return;const i=e.shift(),s=this.mapping[i.voiceId];if(this.slashes[s]==="rhythmic"&&i.rest){e.unshift(i);return}if(!this.slashes[s]&&t.time!==this.timePastInMeasure){e.unshift(i);return}const r=this.getChordDuration(i),n=(0,mn.default)(t.harmony);if(!n){e.unshift(i);return}const u=this.getDefaultJazzHarmonyOctave();i.notesArr=[];for(let a=0;a<n.length;a++){const l=n[a];l.octave=u;const c={pitch:g.NoteNameToMIDI(l)+this.transpo,duration:r,slurIdx:null,velocityDiff:0};i.notesArr.push(c)}e.unshift(i)}getChordDuration(e){return e.chordDuration}getDefaultJazzHarmonyOctave(){return this.partReader?this.partReader.instru.getDefaultOctave(this.partIdx):G.DEFAULT_OCTAVE}getDisplayedElemFromQuarterPos(e,t){F(`getDisplayedElemFromQuarterPos for voice ${e} at quarterPos ${t}`);const i=this.measureData.note;let s=0,r=0;const n={};for(let u=0;u<i.length;u++){const a=i[u],l=T.default.getVoiceIdx(a);if(a.duration&&l===e){const h=a.duration/this.divisions;if(s===t)return{idx:r,realIdx:u,duration:h,voiceId:e};if(s>t)return n;n.voiceIdx=r,n.realIdx=u,n.duration=h,s+=h,r++}}return n}getPedalStatus(){return this.pedalActive}getPedalStartTime(){return this.pedalStartTime}getPizzicatoStatus(){return this.pizzActive}getMuteStatus(){return this.muteActive}getTempo(){return this.qpm}getVelocity(e,t){F(`getVelocity for voice ${e}, dbDiff ${t}`),(typeof t=="undefined"||t===null)&&(t=0),typeof e=="undefined"&&(e=this.voices[0].id);const i=this.mapping[e],s=this.dynamics[i].velocity;if(t===0)return F(`getVelocity() for voice ${e} -> final velocity ${s}`),s;const r=g.MIDIVelocityToDecibels(s),n=g.decibelsToMIDIVelocity(r+t);return F(`getVelocity() for voice ${e}, MIDI velocity ${s}, dbBase ${r} -> final velocity ${n}`),n}getWedgeIntervalForVoice(e){typeof e=="undefined"&&(e=this.voices[0].id);const t=this.mapping[e];if(!this.dynamics[t].ongoingWedge)return 0;const i=this.dynamics[t].ongoingWedge;return(i.type===Mt.A.CRESCENDO?1:-1)*i.velocityInterval}updatePedals(e=!1){let t=null;if(this.pedalsIdx<this.pedals.length&&(e||this.pedals[this.pedalsIdx].time<=this.timePastInMeasure)){const i=this.pedals[this.pedalsIdx];if(t={type:i.type},i.type===xe.A.START){this.pedalActive=!0;const s=this.timePastInMeasure-i.time;t.duration=i.duration-s*this.unitDuration}else i.type===xe.A.STOP&&(this.pedalActive=!1);this.pedalsIdx++}return t}updateModes(){this.updatePizzicato(),this.updateMute()}updatePizzicato(){this.pizzicatoIdx<this.pizzicatos.length&&this.pizzicatos[this.pizzicatoIdx].time<=this.timePastInMeasure&&(this.pizzicatos[this.pizzicatoIdx].type===Ze.A.PIZZICATO?this.pizzActive=!0:this.pizzicatos[this.pizzicatoIdx].type===Ze.A.ARCO&&(this.pizzActive=!1),this.pizzicatoIdx++)}updateMute(){this.muteIdx<this.mutes.length&&this.mutes[this.muteIdx].time<=this.timePastInMeasure&&(this.mutes[this.muteIdx].type===Pt.A.ON?this.muteActive=!0:this.mutes[this.muteIdx].type===Pt.A.OFF&&(this.muteActive=!1),this.muteIdx++)}updateJazzHarmonies(){if(this.harmonyIdx<this.harmonies.length-1){const e=this.harmonies[this.harmonyIdx+1];if(e&&this.timePastInMeasure>=e.time)return F("update jazz harmony index"),this.harmonyIdx++,!0}return!1}updateDynamicsForVoice(e){const t=this.mapping[e];this.updateTextDynamics(t),this.updateWedges(t)}updateTextDynamics(e){F(`update dynamics for staff ${e}`);const t=this.dynamics[e];t.dynamicsIdx<t.dynamicsArray.length&&t.dynamicsArray[t.dynamicsIdx].time<=this.timePastInMeasure&&(t.velocity=t.dynamicsArray[t.dynamicsIdx].velocity,t.dynamicsIdx++)}updateWedges(e){const t=this.dynamics[e];t.wedgeIdx<t.wedgeArray.length&&t.wedgeArray[t.wedgeIdx].start.time<=this.timePastInMeasure?(t.ongoingWedge=JSON.parse(JSON.stringify(t.wedgeArray[t.wedgeIdx])),t.ongoingWedge.stepsRemaining=t.ongoingWedge.nbNotes,t.velocity=t.ongoingWedge.start.velocity,t.wedgeIdx++):t.ongoingWedge!==null&&(t.velocity=C.capWedgeVelocity(t.velocity,t.ongoingWedge.velocityInterval,t.ongoingWedge.type),--t.ongoingWedge.stepsRemaining<=0&&(t.velocity=t.ongoingWedge.stop.velocity,t.ongoingWedge=null))}hasRepeatForward(){return!!(this.measureData&&I.default.hasRepeatForward(this.measureData))}hasRepeatBackward(){return!!(this.measureData&&I.default.hasRepeatBackward(this.measureData))}getNumberRepeated(){let e,t,i,s=null;const r=[],n=[];let u;e=1;for(let a=this.idx;a<this.partData.measure.length;a++){if(i=this.partData.measure[a],I.default.hasRepeatForward(i)&&r.push({measure:a,counter:0}),I.default.hasRepeatBackward(i))if(r.length>0)r.pop();else{t=new Mi({data:this.data,partIdx:this.partIdx,measureIdx:a,commonContent:this.commonContent,mapping:this.mapping,sliderVoice:this.sliderVoice});for(let l=this.idx;l>=0&&!s;l--)this.commonContent.hasEnding(l)&&(s=this.commonContent.getEnding(l));s?(e=e===1?s.length:e+s.length,s=null):e+=t.getRepeatTimes()}this.commonContent&&this.commonContent.hasJumpCall(a)&&(u=this.commonContent.getJumpCall(a),(u===j.A.DACAPO||u===j.A.DALSEGNO)&&e++),this.commonContent&&this.commonContent.hasJumpTag(a)&&n.push(this.commonContent.getJumpTag(a))}return e}hasTag(){return!!(this.commonContent&&this.idx<this.partData.measure.length&&this.commonContent.hasJumpTag(this.idx))}getTag(){return this.hasTag()?this.commonContent.getJumpTag(this.idx):null}hasCall(){return!!(this.commonContent&&this.idx<this.partData.measure.length&&this.commonContent.hasJumpCall(this.idx))}getCall(){return this.hasCall()?this.commonContent.getJumpCall(this.idx):null}hasPizzicatos(){return this.pizzicatos.length>0}getRepeatTimes(e=0){let t;if(this.rightBarline){if(e>0)return t=this.checkNextMeasureForEnding(),t>e&&(e=t),e-1;const i=yn.A.getRepeat(this.rightBarline);return bn.A.getNbRepeat(i)}return 0}checkNextMeasureForEnding(){let e;return this.idx<this.partData.measure.length-1&&this.commonContent.hasEnding(this.idx+1)?(e=this.commonContent.getEnding(this.idx+1),e[e.length-1]):0}getKeySignature(e){return I.default.getWrappedKey(this.measureData).getEntry(e)}getMeasureLength(e,t){e=e||this.unitDuration;const i=this.getMeasureQuarterDuration(t);return e*i}getMeasureQuarterDuration(e){e=e||I.default.getAnyTime(this.measureData);const t=e.beatType||e["beat-type"];return e.beats*(4/t)}getQuarterNotesCount(e,t){let i,s,r;return e||t?(r=this.voiceMap[e.voiceId],s=this.voices[r],i=s.getVoiceDurationInRange(void 0,void 0)):i=this.beats*(4/this.beatType),i}getMeasureDurationFromLocation(e,t){let i,s,r=0;return e&&({noteIdx:i}=e,e.voiceId&&(r=this.voiceMap[e.voiceId])),t&&(s=t.noteIdx,t.voiceId&&(r=this.voiceMap[t.voiceId])),this.voices[r].getVoiceDurationInRange(i,s)}findLocationFromTime(e,t,i,s=this.sliderVoice){let r=0;r=this.voiceMap[s],typeof r=="undefined"&&(r=0);const u=this.voices[r].findLocationFromTime(e,t,i);return u.measureUuid=this.uuid,u.currentMeasure=this.idx,u.currentNoteDuration*=t,u.quarterFromMeasureStart=u.timeFromMeasureStart/t,u}hasNotesInMeasure(){for(let e=0;e<this.measureData.note.length;e++)if(!this.measureData.note[e].rest)return!0;return!1}hasPlayingElementsInMeasure(){return this.hasNotes||this.harmonies.length>0&&this.hasOnlySlashes}getLastPizzicato(e){const t={measureIdx:e,partIdx:this.partIdx,noteIdx:0,staffIdx:0,voiceIdx:0};return C.getLastPizzicatoType(this.partData,t)}getLastMeasureMode(e,t){const i={measureIdx:t,partIdx:this.partIdx,noteIdx:0,staffIdx:0,voiceIdx:0};return C.getLastMeasureMode(e,this.partData,i)}enablePizzicato(){this.pizzicatoPart=!0}enableMute(){this.mutePart=!0}enableSwing(){this.nextMeasureSwing=!0}disableSwing(){this.nextMeasureSwing=!1}setUnitDuration(e){this.unitDuration=e}}const xi=Mi;var ps=v(518558),Tn=Math.pow,gs=(o,e,t)=>new Promise((i,s)=>{var r=a=>{try{u(t.next(a))}catch(l){s(l)}},n=a=>{try{u(t.throw(a))}catch(l){s(l)}},u=a=>a.done?i(a.value):Promise.resolve(a.value).then(r,n);u((t=t.apply(o,e)).next())});const b=x("dacapo:partreader"),ys=x("dacapo:slider");class vn{constructor(e,t,i,s,r,n,u,a,l=!1){b(`instanciating PartReader for part ${i}`),this.idx=i,this.uuid=e.getPartUuid(this.idx),this.data=e,this.part=t,this.commonContent=r,this.instru=s,this.mapping={},this.qpm=null,this.timeSignature={beats:null,beatType:null},this.keySignature={fifths:null,mode:"major"},this.sliderMode=l,this.nextMeasureIdx=0,this.init(n||0,u||0,a||0)}init(e=0,t=0,i=0){b(`init PartReader ${this.idx} at measure ${e} and time ${t}`),this.repeatStack=[],this.tags={},this.repeat=!0,this.nextNote=0,this.measureTag={},this.pendingPromises=[],this.minDelay=0,this.scheduledNotes=[],this.voiceMap=[],this.initStaves(),this.measureStart=e,this.timeStart=t,this.timePastInPart=0,this.sliderVoice=i,this.nextTime=this.timeStart+this.timePastInPart,this.currentMeasure=new xi({data:this.data,partIdx:this.idx,measureIdx:e,commonContent:this.commonContent,mapping:this.mapping,sliderVoice:this.sliderVoice,partReader:this}),this.updateGlobalMeta(),this.timePastFromBeginning=0,this.isNewMeasure=!0,this.bufferOverflow=!1,this.timeFromNoteStart=0,this.currentNoteIndex=0,this.currentNoteDuration=0,this.lastEndingMet=0,this.pedalEndTime=null,this.measureChanged=!1,this.elapsed=0,this.checkRepeatForward(),this.saveJumpTags(),this.predictNextMeasure(),this.instru&&this.instru.hasInstruAtIdx(this.idx)&&!this.sliderMode&&(this.updateMeta(),this.instru.hasMode(this.idx,"pizzicato")&&(this.currentMeasure.enablePizzicato(),this.currentMeasure.init()),this.instru.hasMode(this.idx,"mute")&&(this.currentMeasure.enableMute(),this.currentMeasure.init()))}initStaves(){let e;this.data.getPartVoicesIndexes(this.idx).forEach(i=>{e=this.data.getPartVoiceMainStaffIdx(this.idx,i),this.mapping[i]=e})}findPrevRepeatsAndTags(e){let t,i,s;const r=[];for(this.repeatStack=[],t=0;t<=e&&t<this.part.measure.length;t++)I.default.hasRepeatForward(this.part.measure[t])&&(i={measure:t,counter:0},this.repeatStack.push(i),r.push(JSON.parse(JSON.stringify(i)))),t<e&&I.default.hasRepeatBackward(this.part.measure[t])&&(this.repeatStack.pop(),r.pop()),this.commonContent.hasJumpTag(t)&&(i={measure:t,counter:0,tag:this.commonContent.getJumpTag(t)},this.addTag(i.tag,i),r.push(JSON.parse(JSON.stringify(i))));return this.repeatStack.length>0&&this.commonContent.hasEnding(e)&&(s=this.commonContent.getEnding(e),i=this.repeatStack[this.repeatStack.length-1],i.counter=s[0]-1,i=r[this.repeatStack.length-1],i.counter=s[0]-1),r}setPrevRepeatsAndTags(e){let t;this.repeatStack=[];for(let i=0;i<e.length;i++)t={measure:e[i].measure,counter:e[i].counter},e[i].tag?this.addTag(e[i].tag,t):this.repeatStack.push(t)}partCallback(e){let t=!0;if(this.endOfPart())return Number.POSITIVE_INFINITY;if(this.currentMeasure.substractElapsedTime(e),this.isNewMeasure&&(t=this.currentMeasure.noMoreDelay()),this.isNewMeasure&&t&&(this.isNewMeasure=!1,this.updateGlobalMeta()),!this.isNewMeasure){this.updatePedal(this.timePastFromBeginning),this.currentMeasure.updatePedals(),this.currentMeasure.updateModes();const s=this.currentMeasure.getNotes(),r=s.length;for(let n=0;n<r;n++)this.playChord(s[n]);this.saveNoteHead()}if(this.timeFromNoteStart=this.currentMeasure.voices[0].timeFromNoteStart,this.bufferOverflow)return Number.POSITIVE_INFINITY;const i=this.getMinDuration();if(this.updateOffset(i),this.timePastFromBeginning+=i*this.currentMeasure.unitDuration,this.currentMeasure.isFinished()){const s=this.currentMeasure.updatePedals(!0);s&&s.type===xe.A.STOP&&(this.pedalEndTime=null),this.changeMeasure(),this.measureChanged=!0}return i}schedulePartWindow(e,t){let i=0,s=!0,r;b(`schedulePartWindow for part ${this.idx}, window: ${e} - ${t}`);for(let n=0;n<this.scheduledNotes.length;n++)this.scheduledNotes[n].endTime<e&&this.scheduledNotes.splice(n--,1);if(this.removeVoiceMapElemDoneBefore(e),this.nextTime>t)return b(`partIdx ${this.idx} -> end of window reached (nextTime: ${this.nextTime} > endWindow ${t}), returning ${this.elapsed} to reader`),this.elapsed;if(this.endOfPart())return b(`partIdx ${this.idx} -> end of part reached, returning to reader`),Number.POSITIVE_INFINITY;for(;!this.endOfPart();){if(this.currentMeasure.substractElapsedTime(this.elapsed),this.isNewMeasure&&(s=this.currentMeasure.noMoreDelay(),b(`new measure still has delay? ${!s}`),s&&(this.isNewMeasure=!1,this.updateGlobalMeta())),!this.isNewMeasure){this.updatePedal(this.nextTime),this.currentMeasure.updateModes();const n=this.currentMeasure.getNotes(),u=n.length;for(let a=0;a<u;a++)this.scheduleChord(this.nextTime,n[a]);r=this.currentMeasure.getParsedElement(0),r&&Object.keys(r).length>0&&(r.voiceUuid=this.data.getPartVoiceUuid(this.idx,r.voiceId),r.startTime=this.nextTime,r.endTime=this.nextTime+r.duration,r.nextMeasureIdx=this.nextMeasureIdx,b("push new voiceMap element %O",r),this.voiceMap.push(r))}if(this.elapsed=this.getMinDuration(),b(`duration elapsed (quarter unit) ${this.elapsed}`),i=this.elapsed*this.currentMeasure.unitDuration,this.timePastInPart+=i,this.nextTime=this.timeStart+this.timePastInPart,this.currentMeasure.isFinished()){const n=this.currentMeasure.updatePedals(!0);n&&n.type===xe.A.STOP&&this.stopPlayingNotes(this.nextTime),this.changeMeasure()}if(this.nextTime>t)return b(`partIdx ${this.idx} -> end of window reached, returning ${this.elapsed} to reader`),this.elapsed}return b(`partIdx ${this.idx} -> returning ${this.elapsed} to reader`),this.elapsed}updatePedal(e){const t=this.currentMeasure.updatePedals();t&&t.type===xe.A.STOP?(this.stopPlayingNotes(e),this.pedalEndTime=null,this.updatePedal(e)):t&&t.type===xe.A.START&&t.duration&&(this.pedalEndTime=e+t.duration)}updateOffset(e){this.instru&&this.currentMeasure.played&&this.instru.updateOffset(e*this.currentMeasure.unitDuration,this.idx)}updateMeta(){const e=this.instru.hasInstruAtIdx(this.idx);if(this.endOfPart())return;this.qpm!==this.currentMeasure.qpm&&(this.qpm=this.currentMeasure.qpm,e&&this.instru.updateTempo&&this.instru.updateTempo(this.qpm,this.nextTime,this.idx)),(this.timeSignature.beats!==this.currentMeasure.beats||this.timeSignature.beatType!==this.currentMeasure.beatType)&&(this.timeSignature.beats=this.currentMeasure.beats,this.timeSignature.beatType=this.currentMeasure.beatType,e&&this.instru.updateTimeSignature&&this.instru.updateTimeSignature(this.timeSignature.beats,this.timeSignature.beatType,this.idx));const t=this.currentMeasure.getKeySignature(0);this.keySignature.fifths!==t.fifths&&(this.keySignature.fifths=t.fifths,this.keySignature.mode=t.mode||"major",e&&this.instru.updateKeySignature&&this.instru.updateKeySignature(this.keySignature.fifths,this.keySignature.mode,this.idx))}updateGlobalMeta(){b("update global meta"),A.qpm=Number(this.currentMeasure.qpm),A.bpm=Number(this.currentMeasure.bpm),A.timeSignature.beats=Number(this.currentMeasure.beats),A.timeSignature.beatType=Number(this.currentMeasure.beatType),A.measureIdx=Number(this.currentMeasure.idx),A.unitDuration=Number(this.currentMeasure.unitDuration),A.beatDuration=Number(this.currentMeasure.beatDuration)}changeMeasure(e=!1){let t=!0;if(this.changedMeasure=!1,b(`changing measure of part ${this.idx}${e?" to predict next measure":""}`),this.repeat&&this.currentMeasure.hasRepeatBackward()&&(t=this.handleBackwardRepeat(e)),this.repeat&&!this.changedMeasure&&this.currentMeasure.hasCall()&&(this.changedMeasure=this.checkJumpCalls(!1,e)),e){this.changedMeasure||(this.nextMeasureIdx=this.currentMeasure.idx+1),this.nextMeasureIdx>=this.part.measure.length&&(this.nextMeasureIdx=null),b(`next measure predicted to be idx ${this.nextMeasureIdx}`);return}this.changedMeasure||(this.currentMeasure.nextMeasure(),b(`go to next measure ${this.currentMeasure.idx}`)),this.measureTag&&this.measureTag.idx===this.currentMeasure.idx&&this.measureTag.counter++,this.repeat&&t&&this.checkRepeatForward(),this.saveJumpTags(),this.endOfPart()||this.checkEndings(),this.instru&&!this.sliderMode&&this.updateMeta(),b(`measure changed to ${this.currentMeasure.idx}`),this.isNewMeasure=!0,this.predictNextMeasure()}predictNextMeasure(){this.changeMeasure(!0)}checkEndings(){let e,t;this.commonContent.hasEnding(this.currentMeasure.idx)?(e=this.commonContent.getEnding(this.currentMeasure.idx),b(`measure ${this.currentMeasure.idx} has endings ${e}`),this.repeatStack.length>0?t=this.findCorrectRepeatObjectAt(this.currentMeasure.idx,!0):(t={measure:0,counter:0},this.repeatStack.push(t)),typeof t!="undefined"&&t!==null&&(typeof t.measureEnd=="undefined"||t.measureEnd>=this.currentMeasure.idx)&&(this.lastEndingMet=this.getCorrectEnding(e,t.counter),b(`set lastEndingMet with ${this.lastEndingMet}`),e.includes(t.counter+1)||this.changeMeasure())):this.lastEndingMet>0&&(t=this.repeatStack[this.repeatStack.length-1],typeof t!="undefined"&&this.lastEndingMet!==t.counter+1&&this.changeMeasure())}handleBackwardRepeat(e=!1){let t=!0;b("found repeat backward");let i=this.findRepeatEndingAt(this.currentMeasure.idx);return i===null?i=this.createNewRepeatObj(0,this.currentMeasure.idx,!e):(t=!1,e&&(i=JSON.parse(JSON.stringify(i)))),typeof i.measureEnd=="undefined"&&(i.measureEnd=this.currentMeasure.idx),typeof i.nbRepeat=="undefined"&&(i.nbRepeat=this.getRepeatTimes(i),b(`should be repeated ${i.nbRepeat} times`)),this.lastEndingMet=0,e?(t=!1,i===null?(this.nextMeasureIdx=0,this.changedMeasure=!0):i.counter+1<i.nbRepeat+1&&(this.nextMeasureIdx=i.measure,this.changedMeasure=!0)):(b(`counter ${i.counter+1} < ${i.nbRepeat+1}`),++i.counter<i.nbRepeat+1?(this.checkJumpCalls(!0),b(`jumping to measure ${i.measure}`),this.currentMeasure.jumpToMeasure(i.measure),this.changedMeasure=!0):t=!0),t}createNewRepeatObj(e=0,t=this.currentMeasure.idx,i=!0){const s={measure:e,measureEnd:t,counter:0};return i&&this.repeatStack.push(s),s}getRepeatTimes(e){let t;return this.lastEndingMet>0?t=this.findMaxEnding(e)-1:t=this.currentMeasure.getRepeatTimes(),t}findMaxEnding(e){let t=0,i=0;const s=e.measure||0;for(let r=s;r<=e.measureEnd+1&&r<this.part.measure.length;r++){const n=this.part.measure[r];if(r>s&&r<e.measureEnd&&(I.default.hasRepeatBackward(n)&&i++,I.default.hasRepeatForward(n)&&i--),i===0&&this.commonContent.hasEnding(r)){const u=this.commonContent.getEnding(r),a=g.maxArray(u);a>t&&(t=a)}}return b(`max ending found : ${t}`),t}checkRepeatForward(){this.currentMeasure.hasRepeatForward()&&!this.findRepeatStartingAt(this.currentMeasure.idx)&&(this.lastEndingMet=0,this.repeatStack.push({measure:this.currentMeasure.idx,counter:0}))}findCorrectRepeatObjectAt(e,t){let i;for(i=this.repeatStack.length-1;i>=0;i--)if(this.repeatStack[i].measure<=e&&(typeof this.repeatStack[i].measureEnd=="undefined"||this.repeatStack[i].measureEnd>=e||this.repeatStack[i].measureEnd+1===e&&t))return this.repeatStack[i];return null}findRepeatEndingAt(e){let t;for(t=this.repeatStack.length-1;t>=0;t--)if(this.repeatStack[t].measureEnd===e)return this.repeatStack[t];for(t=this.repeatStack.length-1;t>=0;t--)if(typeof this.repeatStack[t].measureEnd=="undefined")return this.repeatStack[t];return null}findRepeatStartingAt(e){let t;for(t=0;t<this.repeatStack.length;t++)if(this.repeatStack[t].measure===e)return this.repeatStack[t];return null}findAndSaveCodaTag(){if(!this.tags[j.A.CODA]){for(let e=this.part.measure.length-1;e>=0;e--)if(this.commonContent&&this.commonContent.hasJumpTag(e)&&this.commonContent.getJumpTag(e)===j.A.CODA)return this.addTag(j.A.CODA,{counter:0,measure:e}),this.tags[j.A.CODA][0];return null}return this.tags[j.A.CODA][0]}saveJumpTags(){const e=this.currentMeasure.getTag();let t;e!==j.A.CODA&&(t=this.searchForTag(e,this.currentMeasure.idx),e&&!t&&(t?t.counter===0&&t.counter++:this.addTag(e,{counter:0,measure:this.currentMeasure.idx})))}addTag(e,t){this.tags[e]||(this.tags[e]=[]),this.tags[e].push(t)}searchForTag(e,t){let i,s;if(this.tags[e]&&(s=this.tags[e].length,s>0))if(typeof t!="undefined"){for(i=s-1;i>=0;i--)if(this.tags[e][i].measure===t)return this.tags[e][i]}else return this.tags[e][s-1];return null}checkJumpCalls(e=!1,t=!1){let i,s,r;const n=this.currentMeasure.getCall();if(n){if(n===j.A.FINE)return b(`found a fine at measure ${this.currentMeasure.idx}`),s=this.searchForTag(j.A.SEGNO),r=this.searchForTag(j.A.DACAPO),!e&&s&&s.counter===1||r&&r.measure>this.currentMeasure.idx?(t?this.nextMeasureIdx=null:(b("interpreting Fine, stopping playback now..."),this.forceEndPlayback()),!0):!1;if(n===j.A.DACAPO)return b(`found a Da Capo at measure ${this.currentMeasure.idx}`),!e&&!this.searchForTag(j.A.DACAPO,this.currentMeasure.idx)?(t?this.nextMeasureIdx=0:(this.addTag(j.A.DACAPO,{measure:this.currentMeasure.idx,counter:1}),b("Da Capo marking registered, jumping to measure 0..."),this.currentMeasure.jumpToMeasure(0)),!0):!1;if(n===j.A.DALSEGNO)return b(`found a Dal Segno at measure ${this.currentMeasure.idx}`),i=this.searchForTag(j.A.SEGNO),!e&&i&&i.counter===0?(t?this.nextMeasureIdx=i.measure:(i.counter++,b(`interpreting Dal Segno, jumping to measure ${i.measure}...`),this.currentMeasure.jumpToMeasure(i.measure)),!0):!1;if(n===j.A.TOCODA)return b(`found a To Coda at measure ${this.currentMeasure.idx}`),i=this.searchForTag(j.A.CODA),!i&&!t?(i=this.findAndSaveCodaTag(),i&&(i.callMeasure=this.currentMeasure.idx,i.maxCount=this.currentMeasure.getNumberRepeated(),i.counter++,b(`found the Coda tag in measure ${i.measure}.`),b(`To Coda measure will be played ${i.maxCount} times.`)),!1):!i||e||i.callMeasure!==this.currentMeasure.idx?!1:t?i.counter+1>=i.maxCount?(this.nextMeasureIdx=i.measure,!0):!1:(b(`To Coda counter is currently at ${i.counter}`),++i.counter>=i.maxCount?(b("Jumping to the Coda..."),this.currentMeasure.jumpToMeasure(i.measure),!0):!1)}return!1}currentMeasureWillBeRepeated(){const e=Object.keys(this.tags);for(let t=0;t<e.length;t++){const i=e[t],s=this.tags[i];for(let r=0;r<s.length;r++){const n=s[r];if(i!=="coda"&&n.counter===0)return!0}}for(let t=0;t<this.repeatStack.length;t++){const i=this.repeatStack[t];if(i.measure<this.currentMeasure.idx&&i.counter<i.nbRepeat)return!0}return!1}getCorrectEnding(e,t){for(let i=0;i<e.length;i++)if(e[i]===t+1)return e[i];return e[0]}forceEndPlayback(){b("force end playback (after fine)");const e=this.getLastVoiceMapEvent();this.currentMeasure.forceEndSong();const t={startTime:e.endTime,endTime:e.endTime,idx:e.idx,realIdx:e.realIdx,voiceId:e.voiceId,measureIdx:e.measureIdx,duration:0,unitDuration:e.unitDuration,quarterFromMeasureStart:e.quarterFromMeasureStart,isLastMeasureNote:!0,forceEnd:!0};this.voiceMap.push(t)}getLastVoiceMapEvent(){let e=null;for(let t=0;t<this.voiceMap.length;t++){const i=this.voiceMap[t];(!e||i.endTime>e.endTime)&&(e=i)}return e||(e={startTime:0,endTime:0,duration:0,idx:this.currentMeasure.voices[0].notes.length-1,realIdx:this.currentMeasure.voices[0].notes.length-1,voiceId:this.currentMeasure.sliderVoice,measureIdx:this.currentMeasure.idx,unitDuration:this.currentMeasure.unitDuration,quarterFromMeasureStart:this.currentMeasure.timePastInMeasure}),e}updateScheduledData(e,t){if(b(`update window on part ${this.idx} with action %O at ${t}`,e),this.voiceMap.length===0){b("nothing scheduled yet, returning...");return}this.scheduling=!0;const i=this.findLocationAtTimeFromVoiceMap(t);if(!i){b(`no voice map element schedule around ${t}, aborting update...`);return}b(`previous version location %O at ${t}`,i);const s=this.updateLocationInScore(i);b(`updated location %O at ${t}`,s),this.clearVoiceMapAndUpdateBefore(t,s),this.cancelNotesInTimeRange(t),this.currentMeasure=new xi({data:this.data,partIdx:this.idx,measureIdx:s.measureIdx,quarterPosStart:s.quarterPos,commonContent:this.commonContent,mapping:this.mapping,sliderVoice:this.sliderVoice,partReader:this}),this.instru.hasMode(this.idx,"pizzicato")&&(this.currentMeasure.enablePizzicato(),this.currentMeasure.initPizzicato()),this.instru.hasMode(this.idx,"mute")&&(this.currentMeasure.enableMute(),this.currentMeasure.initMutes()),this.elapsed=this.getMinDuration(!0),b(`updated elapsed time: ${this.elapsed}`);const r=this.elapsed*this.currentMeasure.unitDuration;this.nextTime=t+r,b(`updated nextTime ${this.nextTime}`),this.timePastInPart=this.nextTime-this.timeStart,b(`updated timePastInPart: ${this.timePastInPart}`),this.currentMeasure.isFinished()&&this.changeMeasure(),this.updateGlobalMeta(),this.isNewMeasure=!1,this.scheduling=!1,this.schedulePartWindow(t,t+2)}updateLocationInScore(e){b("updateLocationInScore for previous location %O",e);let t=e.measureIdx,i=e.quarterPos;const s=this.part.measure.length;t>=s&&(b(`previous measureIdx ${t} is now out of bounds, setting it to ${s-1}`),t=s-1);let r=this.data.getMeasureUuid(t);if(r!==e.measureUuid){b(`measure uuid for idx ${e.measureIdx} has changed, new uuid ${r}`);try{t=this.data.getMeasureIdxFromUuid(e.measureUuid),r=e.measureUuid}catch(f){if(f.code!=="BadMeasureUuid")throw f;t=e.measureIdx,b(`cannot find measure uuid ${e.measureUuid}, fallback to previous idx ${t}`)}}const n=this.part.measure[t],u=n.$adagio.attributes.time["beat-type"],{beats:a}=n.$adagio.attributes.time,l=a*(4/u);e.quarterPos>=l&&(b(`previous version quarterPos ${e.quarterPos} is exceeding the quarter
        duration of the measure (${l})`),i=0,t<this.part.measure.length-1&&(t++,r=this.data.getMeasureUuid(t))),b(`final location: measureIdx ${t}, uuid ${r}, quarterPos  ${i}`);const h=this.commonContent.getTempo(t);let c=tt.default.getQpm(h)>>0;c=c>g.TEMPO_MAX?g.TEMPO_MAX:c;const m=60/c*A.playbackSpeed;return{measureIdx:t,measureUuid:r,quarterPos:i,unitDuration:m}}getVoiceMapIdxAtTime(e){for(let t=0;t<this.voiceMap.length;t++)if(this.voiceMap[t].startTime>e)return t;return this.voiceMap.length}clearVoiceMapAndUpdateBefore(e,t){b(`update voiceMap before ${e}, position %O`,t);const i=this.voiceMap[0],s={measureIdx:i.measureIdx,measureUuid:i.measureUuid,quarterPos:i.quarterFromMeasureStart,unitDuration:i.unitDuration},r=this.updateLocationInScore(s);this.voiceMap=[];const n=C.getVoiceElementsInRange(this.part,this.sliderVoice,r,t);let{startTime:u}=i;for(let a=0;a<n.length;a++){const l=n[a],{measureIdx:h,quarterFromNoteStart:c}=l,m=this.commonContent.getTempo(h);let f=tt.default.getQpm(m)>>0;f=f>g.TEMPO_MAX?g.TEMPO_MAX:f;const p=60/f*A.playbackSpeed;l.unitDuration=p,l.duration=l.quarterDuration*p,l.measureUuid=this.data.getMeasureUuid(h),l.timePastInMeasure=l.quarterFromMeasureStart*p,l.startTime=u-c*p,l.endTime=l.startTime+l.duration,u=l.endTime}this.voiceMap.unshift(...n)}cancelNotesInTimeRange(e,t=Number.POSITIVE_INFINITY){for(let i=0;i<this.scheduledNotes.length;){const s=this.scheduledNotes[i];s.startTime>=e&&s.startTime<t?(b(`cancel note starting at ${s.startTime}, pitch ${s.pitch}`),this.cancelNote(s),this.scheduledNotes.splice(i,1)):i++}}reScheduleNotesWithSpeedFromTime(e,t,i){b("re-schedule notes with new speed %f (previous speed: %f) at %f",e,t,i);const s=this.currentMeasure.unitDuration/t*e;this.currentMeasure.setUnitDuration(s);const r=i-this.timeStart,u=(this.nextTime-i)*e/t;this.timePastInPart=r+u,this.nextTime=this.timeStart+this.timePastInPart,b(`new nextTime ${this.nextTime}`);for(let a=0;a<this.voiceMap.length;a++){const l=this.voiceMap[a];if(l.endTime>i){const h=this.computeNewTimingsWithSpeed(l,e,t,i);b(`new timings for note { startTime: ${l.startTime}, endTime: ${l.endTime}, duration ${l.duration} } => %O`,h),Object.assign(l,h)}}for(let a=0;a<this.scheduledNotes.length;a++){const l=this.scheduledNotes[a];if(l.endTime>i){b(`re-schedule note { startTime: ${l.startTime}, pitch: ${l.pitch}, duration: ${l.duration} }
          with new speed ${e} at ${i}`);const h=this.computeNewTimingsWithSpeed(l,e,t,i);this.changeScheduledNoteTimings(l,h)}}}computeNewTimingsWithSpeed(e,t,i,s){if(e.startTime<s){const c=(e.endTime-s)*t/i,m=s+c;return{duration:m-e.startTime,endTime:m}}const n=(e.startTime-s)*t/i,u=s+n,a=e.duration*t/i,l=u+a;return{duration:a,startTime:u,endTime:l}}changeScheduledNoteTimings(e,t){t.startTime&&t.startTime!==e.startTime&&(this.cancelNote(e),this.rescheduleNote(e,t)),Object.assign(e,t)}cancelNote(e){b(`cancelNote { startTime: ${e.startTime} pitch: ${e.pitch} duration ${e.duration} }`),this.instru&&e.prms&&e.prms.then(t=>{for(let i=0;i<t.length;i++){const s=t[i];this.instru.cancelNoteWithId(s.id,this.idx)}})}findFirstMeasureNoteIdxInHistory(e){for(let t=0;t<this.scheduledNotes.length;t++)if(this.scheduledNotes[t].measureIdx===e)return t;return null}findGraceNotePoolQuarterDuration(e){let t=0;const{graceNotes:i}=e,s=G.ACCACCIATURA_DURATION/this.currentMeasure.unitDuration;for(let r=0;r<i.length;r++){if(!i[r][0].accacciatura)return b("[findGraceNotePoolDuration] grace note is not an accacciatura, returning..."),e.chordDuration*G.GRACE_RATIO;t+=s}return t}buildPlayOpts(e,t,i,s){b("part %i: buildPlayOpts for note %O in chord %O, velocity %f, unit duration %f",this.idx,e,t,i,this.currentMeasure.unitDuration);const r={pitch:e.pitch,quarterDuration:e.duration,duration:e.duration*this.currentMeasure.unitDuration,velocity:i,slurIdx:e.slurIdx};if(t.pizzicato||t.mode==="pizzicato"||this.currentMeasure.getPizzicatoStatus()?r.mode="pizzicato":(t.mute||t.mode==="mute"||this.currentMeasure.getMuteStatus())&&(r.mode="mute"),typeof e.ornaments!="undefined"){for(let n=0;n<e.ornaments.length;n++){const u=e.ornaments[n];if(u.startTime*=this.currentMeasure.unitDuration,u.quarterDuration=u.duration,u.duration*=this.currentMeasure.unitDuration,Ne.hasOrnamentalSequence(u)){const a=Ne.getFirstOrnamentalSequenceName(e.ornaments[n]);u[a].keySignature=this.currentMeasure.getKeySignature(e.staffIdx)}}r.ornaments=e.ornaments}return typeof e.forcedVelocity=="number"&&(r.velocity=e.forcedVelocity),t.wedgeInterval&&typeof t.wedgeInterval=="number"&&(r.wedgeInterval=t.wedgeInterval),typeof e.releaseRatio!="undefined"&&(r.releaseRatio=e.releaseRatio),typeof e.effects!="undefined"&&(r.effects=e.effects,e.guitarString&&(r.guitarString=e.guitarString)),r.origDuration=r.duration,this.currentMeasure.getPedalStatus()&&(r.holdNote=!0,this.pedalEndTime&&(r.pedalEndTime=this.pedalEndTime)),typeof s!="undefined"&&(r.offset=s),typeof e.glissando!="undefined"&&(r.glissando={pitch:e.glissando.pitch}),r}playChord(e){let t=0,i=0,s=0;if(e.notesArr.length>0){const r=this.getVelocity(e.notesArr[0],e.voiceId);e.graceNotes.length>0&&(i=this.playGraceNote(e,r),t+=i*this.currentMeasure.unitDuration),e.arpeggio&&e.notesArr.length>1&&(s=g.ARPEGGIO_DURATION,s*e.notesArr.length>e.chordDuration-i&&(s=(e.chordDuration-i)/e.notesArr.length),this.sortPitches(e.notesArr)),e.wedgeInterval=this.currentMeasure.getWedgeIntervalForVoice(e.voiceId);for(let n=0;n<e.notesArr.length;n++)e.notesArr[n].duration-=i,e.arpeggio&&e.notesArr.length>1&&(e.notesArr[n].duration=e.chordDuration-i,n>0&&(t+=s*this.currentMeasure.unitDuration)),this.playNote(e.notesArr[n],e,r,t)}}playGraceNote(e,t){let i=0;const{graceNotes:s}=e,r=this.findGraceNotePoolQuarterDuration(e);b(`[playGraceNote] gracePoolDuration ${r}`);const n=r/e.graceNotes.length;b(`[playGraceNote] unitGraceDuration ${n}`);for(let u=0;u<s.length;u++){const a=s[u];for(let l=0;l<a.length;l++)a[l].duration=n,this.playNote(a[l],e,t,i);i+=n*this.currentMeasure.unitDuration}return r}playNote(e,t,i,s){let r;if(this.instru&&!this.sliderMode){s=s||0,r=this.buildPlayOpts(e,t,i),r.startTime=this.timePastFromBeginning+s;const n=this.instru.playNoteSequence(r,this.idx);n.catch(u=>{this.logger&&this.logger.logError?(t.partIdx=this.idx,this.logger.logError(u,{extra:t})):console.error(u)}),this.pendingPromises.push(n)}}scheduleChord(e,t){let i=e,s=0,r=0;if(t.notesArr.length>0){b(`partIdx ${this.idx} -> scheduling chord at ${e} with ${t.notesArr.length} notes`);const n=this.getVelocity(t.notesArr[0],t.voiceId);t.graceNotes.length>0&&(s=this.scheduleGraceNotes(t,n,i),i+=s*this.currentMeasure.unitDuration),t.arpeggio&&t.notesArr.length>1&&(r=g.ARPEGGIO_DURATION,r*t.notesArr.length>t.chordDuration-s&&(r=(t.chordDuration-s)/t.notesArr.length),this.sortPitches(t.notesArr)),t.wedgeInterval=this.currentMeasure.getWedgeIntervalForVoice(t.voiceId);for(let u=0;u<t.notesArr.length;u++)t.notesArr[u].duration-=s,t.arpeggio&&t.notesArr.length>1&&(t.notesArr[u].duration=t.chordDuration-s,u>0&&(i+=r*this.currentMeasure.unitDuration)),this.scheduleNote(i,t.notesArr[u],t,n)}}scheduleGraceNotes(e,t,i){const s=this.findGraceNotePoolQuarterDuration(e);b(`[scheduleGraceNote] gracePoolDuration ${s}`);const r=s/e.graceNotes.length;b(`[scheduleGraceNote] unitGraceDuration ${r}`);for(let n=0;n<e.graceNotes.length;n++){for(let u=0;u<e.graceNotes[n].length;u++)e.graceNotes[n][u].duration=r,this.scheduleNote(i,e.graceNotes[n][u],e,t);i+=r*this.currentMeasure.unitDuration}return s}scheduleNote(e,t,i,s){let r,n;if(b(`schedule note %O in chord %O at ${e} for part ${this.idx}`,t,i),this.instru&&!this.sliderMode){r=this.buildPlayOpts(t,i,s),r.startTime=e,{duration:n}=r;const u=this.instru.playNoteSequence(r,this.idx),a={opts:r,prms:u,measureIdx:i.measureIdx,voiceId:i.voiceId,quarterPosition:i.quarterPosition,pitch:t.pitch,velocity:s,inSlur:t.inSlur,startTime:e,duration:n,quarterDuration:r.quarterDuration,unitDuration:n/r.quarterDuration,endTime:e+n};this.scheduledNotes.push(a),u.catch(l=>{this.logger&&this.logger.logError?(i.partIdx=this.idx,this.logger.logError(l,{extra:i})):console.error(l)}).then(l=>{a.noteIds=C.extractNoteIdsFromResults(l)})}}sortPitches(e){e.sort((t,i)=>t.pitch-i.pitch)}stopPlayingNotes(e){this.instru&&!this.sliderMode&&this.instru.stopPedal(this.idx,e)}rescheduleNote(e,t){return gs(this,null,function*(){b("re-schedule note(s) %O with %O",e.noteIds,t);const i=e.opts,s=Object.assign(i,t);if(this.instru&&!this.sliderMode){const r=this.instru.playNoteSequence(s,this.idx);e.prms=r,e.opts=s,e.startTime=s.startTime,e.duration=s.duration,e.endTime=e.startTime+e.duration,r.then(n=>{e.noteIds=C.extractNoteIdsFromResults(n)})}})}stopNoteSequenceNodes(e){if(e){b(`stopNoteSequenceNodes ${e}`);for(let t=0;t<e.length;t++){const i=e[t];this.instru.cancelNoteWithId(i,this.idx)}}}stopScheduledNotes(){b("stop scheduled notes");for(let e=0;e<this.scheduledNotes.length;e++){const t=this.scheduledNotes[e],{prms:i}=t;i&&i.then(s=>{this.stopNoteSequenceNodes(s)})}this.scheduledNotes=[]}pauseScheduledNotes(){const e=d.context.currentTime;b("pause scheduled notes");for(let t=0;t<this.scheduledNotes.length;t++){const i=this.scheduledNotes[t],{prms:s}=i;s.then(r=>{this.stopNoteSequenceNodes(r)}),e-i.startTime>0&&(i.pauseOffset=e-i.startTime)}}resumeScheduledNotes(e){b("resume scheduled notes"),this.nextTime+=e,this.timeStart+=e;for(let t=0;t<this.scheduledNotes.length;t++){const i=this.scheduledNotes[t];if(i.startTime+=e,i.endTime+=e,i.endTime>this.timeStart){i.opts.duration=i.duration,i.opts.pauseOffset=i.pauseOffset,i.opts.startTime=i.startTime;const s=this.instru.playNoteSequence(i.opts,this.idx);s&&(i.nodePrms=s)}}for(let t=0;t<this.voiceMap.length;t++){const i=this.voiceMap[t];i.startTime+=e,i.endTime+=e}}endOfPart(){return this.currentMeasure.idx>=this.part.measure.length}getUnitDuration(){return this.currentMeasure.unitDuration}getMinDuration(e=!1){return this.currentMeasure.getMinDuration(e)}getVelocity(e,t){return typeof e=="undefined"?this.currentMeasure.getVelocity():this.currentMeasure.getVelocity(t,e.velocityDiff)}getPendingPromises(){return this.pendingPromises}resetPendingPromises(){this.pendingPromises=[]}getNextBeat(){const e=d.context.currentTime,t=this.getCurrentOrNextNote(e),i=this.part.measure[t.measureIdx],s=I.default.getAnyTime(i),r=ps.default.getBeats(s),u=1/(4/ps.default.getBeatType(s));let a=e-t.startTime;a<0&&(a=0);const h=(t.quarterFromMeasureStart*t.unitDuration+a)/t.unitDuration,c=Math.ceil(h*u)/u;return{time:c*t.unitDuration+this.timeStart,count:c%r}}getCurrentOrNextNote(e=d.context.currentTime){const t=this.getCurrentPlayingNote(e);return t.note?t.note:t.note===null?this.voiceMap[0]:{startTime:this.timeStart,quarterFromMeasureStart:0,unitDuration:1,measureIdx:0,noteIdx:0,voiceId:1,duration:1}}saveNoteHead(){const e=this.currentMeasure.voices[0];e?(this.currentNoteIndex=e.currentNoteIndex,this.currentNoteDuration=e.currentNoteDuration):(this.currentNoteIndex=0,this.currentNoteDuration=A.timeSignature.beats*(4/A.timeSignature.beatType))}createPlayingObject(e,t,i){const s=Tn(10,12),r={idx:0,realIdx:0,voiceId:i,measureIdx:this.measureStart||0,nextMeasureIdx:this.measureStart,currentNoteDuration:1,timeFromNoteStart:0,timeFromMeasureStart:0,unitDuration:1,quarterFromMeasureStart:0,quarterNotePos:0,isLastMeasureNote:!1};return e?(r.idx=e.idx,r.realIdx=e.realIdx,r.voiceId=e.voiceId,r.measureIdx=e.measureIdx,r.nextMeasureIdx=e.nextMeasureIdx,r.measureUuid=e.measureUuid,r.voiceUuid=e.voiceUuid,r.currentNoteDuration=e.duration,r.timeFromNoteStart=Math.round((t-e.startTime)*s)/s,r.unitDuration=e.unitDuration,r.quarterNotePos=e.quarterFromMeasureStart,r.timeFromMeasureStart=r.quarterNotePos*e.unitDuration+r.timeFromNoteStart,r.quarterFromMeasureStart=Math.round(r.timeFromMeasureStart/e.unitDuration*s)/s,r.isLastMeasureNote=e.isLastMeasureNote):r.measureUuid=this.data.getMeasureUuid(0),r}getCurrentPlayingNote(e=d.context.currentTime){let t,i,s=0;for(t=0;t<this.voiceMap.length;t++)if(i=this.voiceMap[t],e>=i.startTime&&e<i.endTime)return t>0&&this.voiceMap.splice(0,t),{note:i};if(i)if(e<i.startTime)i=null,s=this.voiceMap[0].voiceId;else{const r=this.voiceMap.length-1;i=this.voiceMap[r]}else s=this.currentMeasure.getSliderVoice();return{note:i,defaultVoiceId:s}}removeVoiceMapElemDoneBefore(e=d.context.currentTime){for(let t=0;t<this.voiceMap.length;t++){const i=this.voiceMap[t];e>=i.startTime&&e<i.endTime&&t>0&&this.voiceMap.splice(0,t)}}getPlayingHeadPosition(e=d.context.currentTime){const t=this.getCurrentPlayingNote(e);ys("noteInfo: %O",t);const i=this.createPlayingObject(t.note,e,t.defaultVoiceId),s={timeFromNoteStart:i.timeFromNoteStart,timeFromMeasureStart:i.timeFromMeasureStart,currentNoteIndex:i.idx,currentNoteRealIdx:i.realIdx,currentNoteDuration:i.currentNoteDuration,currentVoiceId:i.voiceId,currentMeasure:i.measureIdx,nextMeasure:i.nextMeasureIdx,partUuid:this.uuid,measureUuid:i.measureUuid,voiceUuid:i.voiceUuid,quarterFromMeasureStart:i.quarterFromMeasureStart,quarterNotePos:i.quarterNotePos,isLastMeasureNote:i.isLastMeasureNote};return t&&t.note&&t.note.forceEnd&&(s.forceEnd=!0),ys("currentNote: %O",s),s}getPartLength(){let e=0;for(;!this.endOfPart();)e+=this.currentMeasure.getMeasureLength(),this.changeMeasure();return e}getPartTimeEnd(){let e=0,t=0,i=0;for(;!this.endOfPart();){const s=this.currentMeasure.getMeasureLength();this.currentMeasure.hasPlayingElementsInMeasure()?(e+=s+t,t=0):t+=s,this.changeMeasure(),this.endOfPart()&&e>0&&(i=e+s)}return i}getCurrentMeasureMaxEndingTime(){return gs(this,null,function*(){const e=this.currentMeasure.idx;for(this.measureChanged=!1;!this.measureChanged&&!this.endOfPart();)this.minDelay=this.partCallback(this.minDelay),b("minDelay",this.minDelay);b("finished parsing measure",e);const t=yield Promise.all(this.pendingPromises),i=this.getMeasureEndingTimeFromResults(t);return this.pendingPromises=[],i})}getMeasureEndingTimeFromResults(e){let t=0;for(let i=0;i<e.length;i++){const s=e[i];for(let r=0;r<s.length;r++){const n=s[r];n&&n.endTime>t&&(t=n.endTime)}}return t}resetTimePastFromBeginning(e=0){this.pedalEndTime!==null&&(this.pedalEndTime-=this.timePastFromBeginning,this.pedalEndTime+=e),this.timePastFromBeginning=e,this.measureChanged=!1}getRangeDuration(e,t){let i=0;const s=this.currentMeasure;if(e.repeat=e.repeat||1,t.repeat=t.repeat||1,e.end&&t.end)return 0;if(e.measureIdx===t.measureIdx&&e.repeat===t.repeat)return s.getMeasureDurationFromLocation(e,t);for(e.noteIdx>0&&(i+=s.getMeasureDurationFromLocation(e),this.changeMeasure()),t.repeat>1&&(this.measureTag={counter:this.countRepeatedLocation(t),idx:t.measureIdx});!this.endOfPart()&&!this.isPassedLocation(t);)i+=s.getMeasureLength(1),this.changeMeasure();return t.noteIdx>0&&(i+=s.getMeasureDurationFromLocation({measureIdx:t.measureIdx,voiceId:t.voiceId,noteIdx:0},t)),i}countRepeatedLocation(e){let t,i=0;const s=this.currentMeasure;for(let r=0;r<this.repeatStack.length;r++)t=this.repeatStack[r],t.measure<=e.measureIdx&&(typeof t.measureEnd=="undefined"||t.measureEnd>=e.measureIdx)&&(i+=t.counter);return e.measureIdx<=s.idx&&i++,i}isPassedLocation(e){const t=this.currentMeasure;return e.repeat>1?this.measureTag.counter>=e.repeat:t.idx>=e.measureIdx}changeRepeatsAndTagsCount(e,t){let i,s=t.repeat;for(i=e.length-1;i>=0;i--)s>1&&e[i].counter<1&&(s--,e[i].counter++);if(s>1)for(i=t.measureIdx;i<this.part.measure.length;i++){if(I.default.hasRepeatBackward(this.part.measure[i])){e.unshift({measure:0,counter:1,measureEnd:i});return}if(this.commonContent.hasJumpTag(i)&&this.commonContent.getJumpTag(i)===j.A.DACAPO){this.addTag(j.A.DACAPO,{measure:i,counter:1});return}}}findLocationFromTime(e,t,i){let s,r,n;const u=this.currentMeasure;for(s=e.time,e.location.noteIdx>0&&(s+=u.getMeasureDurationFromLocation(e.location),n=u.idx,this.changeMeasure()),r=s;s<i&&!this.endOfPart();)r=s,s+=u.getMeasureLength(t),n=u.idx,this.changeMeasure();this.endOfPart()||s>i&&typeof n!="undefined"?u.jumpToMeasure(n):s===i&&(r=s),this.predictNextMeasure();const a=u.findLocationFromTime(r,t,i,e.location.voiceId);return a.nextMeasure=this.nextMeasureIdx,a.partUuid=this.uuid,a.voiceUuid=this.data.getPartVoiceUuid(this.idx,a.currentVoiceId),a}buildAnchorList(){const e=[];let t=0,i=0;for(;!this.endOfPart();){const s=this.currentMeasure.getMeasureLength();s!==i&&e.push(this.buildAnchorOfCurrentLocation(t)),i=s,t+=i,this.changeMeasure()}return e.push({type:"end",time:t}),e}buildAnchorOfCurrentLocation(e){return{type:"measure",time:e,location:{measureIdx:this.currentMeasure.idx,voiceId:0,noteIdx:0},measureUuid:this.data.getMeasureUuid(this.currentMeasure.idx)}}findLocationAtTimeFromVoiceMap(e){const t=this.findElementIdxAtTimeInVoiceMap(e);if(t<0)return null;const i=this.voiceMap[t];b("found previous element in voiceMap %O",i);const{measureIdx:s,measureUuid:r}=i,u=(e-i.startTime)/i.unitDuration,a=i.quarterFromMeasureStart+u;return{measureIdx:s,measureUuid:r,quarterPos:a}}findElementIdxAtTimeInVoiceMap(e){b(`[findElementIdxAtTimeInVoiceMap] check for time ${e}`);for(let t=0;t<this.voiceMap.length;t++){const i=this.voiceMap[t];if(i.startTime===e)return t;if(i.startTime>e)return t-1}return-1}getMetaMap(){const e=[];for(this.init(0),this.setNoRepeat();!this.endOfPart();)e[this.currentMeasure.idx]={beats:this.currentMeasure.beats,beatType:this.currentMeasure.beatType,tempo:this.currentMeasure.qpm},this.changeMeasure();return this.init(0),this.setRepeat(),e}getPlayedNotesInPart(){let e,t,i,s,r;const n=[];for(e=0;e<this.part.measure.length;e++){i=this.part.measure[e];const u=I.default.getTranspose(i),a=kt.default.getChromatic(u[0])+kt.default.getOctaveChange(u[0])*12;for(t=0;t<i.note.length;t++)i.note[t].pitch?(r=g.NoteNameToMIDI(i.note[t].pitch),r+=a,n.includes(r)||n.push(r)):i.note[t].unpitched&&(s=T.default.getInstrumentId(i.note[t]),n.includes(s)||n.push(s))}return n}setRepeat(){this.repeat=!0}setNoRepeat(){this.repeat=!1}setTimeStart(e){this.timeStart=e,this.nextTime=this.timeStart+this.timePastInPart}enableSwing(){this.currentMeasure.enableSwing()}disableSwing(){this.currentMeasure.disableSwing()}setLogger(e){b(`set logger on part ${this.idx}`),this.logger=e}}const ze=vn;var In=v(615542),Nn=v(944115);function Di(o){const e=Error.call(this);return this.name=e.name="MissingIdxInLocationObject",this.stack=e.stack,this.message=`The ${o} idx and uuid are missing from the given location object. Please provide at least one of them.`,this}Di.prototype=Object.create(Error.prototype,{constructor:{value:Di}});const bs=Di;var Vt=(o,e,t)=>new Promise((i,s)=>{var r=a=>{try{u(t.next(a))}catch(l){s(l)}},n=a=>{try{u(t.throw(a))}catch(l){s(l)}},u=a=>a.done?i(a.value):Promise.resolve(a.value).then(r,n);u((t=t.apply(o,e)).next())});const L=x("dacapo:reader");class Sn{constructor(e,t){L("instanciating Reader"),this.data=null,this.schedule=[],this.parts=[],this.manager=e,this.setData(t),this.playTime=0,this.pauseTime=0,this.measureStartTime=0,this.nextTick=0,this.metronome=null,this.sliderMode=!1}init(e=0){let t,i,s,r;if(this.minDelay=0,this.parts=[],L("initializing reader..."),this.schedule.length>0){for(d.context&&(this.playTime=d.context.currentTime+.1),r=0;r<this.schedule.length;r++)if(this.schedule[r]&&([t]=this.data.getPartStaffVoicesIndexes(r,0),s=new ze(this.data,this.schedule[r],r,this.manager,this.commonContent,e,this.playTime,t,this.sliderMode),this.parts.push(s),this.logger&&s.setLogger(this.logger),e>0))if(r===0){if(e>=this.parts[r].part.measure.length)throw new ii(`The measure index ${e} is too high. Max measure index is ${this.parts[r].part.measure.length-1}`);i=this.parts[r].findPrevRepeatsAndTags(e)}else this.parts[r].setPrevRepeatsAndTags(i);this.started=!1}}initPart(e,t,i=0){L(`init part ${e}`);let s;if(this.parts=[],this.minDelay=0,this.nextTime=0,this.currentMeasureIdx=i,this.schedule[e]){const r=this.data.getPartStaffVoicesIndexes(e,0)[0]+1,n=new ze(this.data,this.schedule[e],e,this.manager,this.commonContent,i,this.playTime,r,this.sliderMode);if(this.parts[e]=n,this.initPartBufferForExport(e,t),this.logger&&n.setLogger(this.logger),i>0)if(e===0){if(i>=this.parts[e].part.measure.length)throw new ii(`The measure index ${i} is too high. Max measure index is ${this.parts[e].part.measure.length-1}`);s=this.parts[e].findPrevRepeatsAndTags(i)}else this.parts[e].setPrevRepeatsAndTags(s)}this.started=!1}initPartBufferForExport(e,t){const i=t||this.parts[e].getPartLength(),s=Math.ceil(i*44100);this.finalBuffer=new AudioBuffer({sampleRate:44100,numberOfChannels:2,length:s}),this.parts[e].init()}updateMeasureData(e,t){L("update measure data for all the parts");for(let i=0;i<this.parts.length;i++)this.parts[i].updateScheduledData(e,t)}updateData(e,t){L("update data with actions on measure: %O / on voices: %O",e,t);const i=d.context.currentTime+.5;this.updateMeasureData(null,i)}getTimeAtMeasure(e){let t=null,i=null,s=null,r=0,n=0;for(;n<e&&n<this.schedule[0].measure.length;)t=this.commonContent.getTempo(n)>>0,{"beat-type":s,beats:i}=this.schedule[0].measure[n].$adagio.attributes.time,r+=60/t*i*(4/s),n++;return r}loopCallback(){const e=[];if(!this.metronomeSolo||typeof require!="undefined"){this.started||(this.started=!0,this.minDelay=0);for(let t=0,i=this.parts.length;t<i;t++)e[t]=this.parts[t].partCallback(this.minDelay);this.minDelay=g.minArray(e)}else this.minDelay=4/A.timeSignature.beatType;return this.minDelay===Number.POSITIVE_INFINITY||this.minDelay===0}loopSinglePartCallback(e){return this.minDelay=this.parts[e].partCallback(this.minDelay),this.minDelay===Number.POSITIVE_INFINITY||this.minDelay===0}exportNextSectionInSinglePart(e){return Vt(this,null,function*(){L(`exportNextSectionInSinglePart for part ${e}`);const t=this.parts[e],i=yield this.manager.playRandomBufferToInitReverbFirefox(e);t.resetTimePastFromBeginning(i);const s=t.currentMeasure.getMeasureLength();for(L(`measure ${this.currentMeasureIdx} duration ${s}s`);!t.measureChanged&&!t.endOfPart();)this.minDelay=t.partCallback(this.minDelay);if(L(`finished parsing measure ${this.currentMeasureIdx}`),(yield this.notesHaveBeenPlayedInPart(e))>0){L("all sampler promises resolved, start rendering....");let u=yield d.context.startRendering();L(`rendering done for measure ${this.currentMeasureIdx}`);const a=i*u.sampleRate;u=Se.slice(u,a),u=Se.trimRight(u),L(`buf length after trimming ${u.length}`);const l=Math.round(this.nextTime*44100);L(`sample offset ${l}`),Se.concatBuffers(this.finalBuffer,u,l)}else L(`no notes in measure ${this.currentMeasureIdx}, skip rendering...`);return this.parts[e].resetPendingPromises(),this.currentMeasureIdx=t.currentMeasure.idx,this.nextTime+=s,t.endOfPart()||this.minDelay===Number.POSITIVE_INFINITY||this.minDelay===0})}preloadSinglePartAndGetSectionsDurations(e){return Vt(this,null,function*(){L(`preloadNextSectionInSinglePart for part ${e}`);const t=[],i=this.parts[e];let s=0,r=0;for(;!i.endOfPart();){const n=i.currentMeasure.getMeasureLength(),u=i.currentMeasure.idx;L(`[preload] part ${e}: going to preload measure ${u}`);const a=yield this.manager.playRandomBufferToInitReverbFirefox(e),l=yield i.getCurrentMeasureMaxEndingTime();if(L(`[preload] part ${e}: found maxEndingTime for measure ${u} -> ${l}`),l>0){L(`[preload] part ${e}: end of measure ${u} reached, maxEndingTime ${l}`);const h=l-s;l>r&&(r=l),L(`[preload] part ${e}: max duration ${h}`),t.push(a+h)}else L("[preload] measure is empty, do not save");s+=n,L(`[preload] part ${e}: nextMeasureStartTime ${s}`)}return{sectionsDurations:t,partFullDuration:r}})}getNextMeasureMaxEndingTime(e){return Vt(this,null,function*(){const t=this.parts[e];this.manager.enablePreloadMode(e);const i=yield t.getCurrentMeasureMaxEndingTime();return this.manager.disablePreloadMode(e),i})}getPendingPromisesForPart(e){return this.parts[e].getPendingPromises()}notesHaveBeenPlayedInPart(e){return Vt(this,null,function*(){const t=this.getPendingPromisesForPart(e),i=yield Promise.all(t);for(let s=0;s<i.length;s++)if(i[s].some(n=>n!==null))return!0;return!1})}getFinalBuffer(){return this.finalBuffer}scheduleWindow(e){const t=[],i=d.context.currentTime,s=i+e;if(!this.metronome||!this.metronome.isSolo()){if(this.started=this.started||!0,this.parts.length<=0)return!0;for(let r=0,n=this.parts.length;r<n;r++)t[r]=this.parts[r].schedulePartWindow(i,s);this.minDelay=g.minArray(t)}else this.minDelay=1;return this.minDelay===Number.POSITIVE_INFINITY&&this.hasEndedSlider()?!0:(this.metronome&&(this.minDelay!==Number.POSITIVE_INFINITY||this.metronome.getMode()===1)&&this.scheduleTicksMetronome(s),!1)}stopScheduledNotes(){for(let e=0,t=this.parts.length;e<t;e++)this.parts[e].stopScheduledNotes();this.manager.stopAll()}pauseScheduledNotes(){this.pauseTime=d.context.currentTime;for(let e=0;e<this.parts.length;e++)this.parts[e].pauseScheduledNotes();this.manager.stopAll()}resumeScheduledNotes(){let e;const t=d.context.currentTime-this.pauseTime;for(this.playTime=this.pauseTime+t,e=0;e<this.parts.length;e++)this.parts[e].resumeScheduledNotes(t)}scheduleMetronomeIntro(){L("schedule metronome intro"),this.metronome&&(this.playTime=this.metronome.scheduleIntro(this.playTime,A.timeSignature,A.unitDuration),this.changeTimeStart(this.playTime),this.setNextTick(this.playTime))}scheduleTicksMetronome(e){for(;this.nextTick<=e;)this.waitEndMeasure&&this.metronome.getCount()===0&&(this.changeTimeStart(this.nextTick),this.metronome.setSolo(!1),this.waitEndMeasure=!1),this.metronome.scheduleTick(A.timeSignature.beats,this.nextTick),this.nextTick+=4/A.timeSignature.beatType*A.unitDuration}setMetronome(e){this.metronome=e}setNextTick(e){this.nextTick=e}setDefaultNextTick(){let e={time:0,count:0};this.parts[0]&&(e=this.parts[0].getNextBeat(),L("metronome starting at %o",e)),this.setNextTick(e.time),this.metronome.setCount(e.count)}changeTimeStart(e){let t;for(t=0;t<this.parts.length;t++)this.parts[t].setTimeStart(e)}hasEndedSlider(){let e,t,i,s;if(this.parts&&this.parts[0]){if(e=this.getPlayingHeadPosition(0),L("hasEndedSlider: current Head %O",e),e.forceEnd)return L("force playback end from slider"),!0;if(t=this.parts[0].part.measure.length-1,e.currentMeasure===t&&(i=this.parts[0].part.measure[t],s=C.getLastNoteFromVoice(e.currentVoiceId,i),e.currentNoteRealIdx===s))return e.timeFromNoteStart>=e.currentNoteDuration}return!1}getPlayingHeadPosition(e=0){return this.parts.length>0&&this.started?this.parts[e].getPlayingHeadPosition():{timeFromNoteStart:0,timeFromMeasureStart:0,currentNoteIndex:0,currentNoteRealIndex:0,currentNoteDuration:1,currentVoiceId:0,currentMeasure:0,nextMeasure:null,quarterFromMeasureStart:0,quarterNotePos:0,isLastMeasureNote:!1}}getMetaMap(){return this.parts[0].getMetaMap()}getClosestNoteTime(){return this.minDelay*A.unitDuration*A.playbackSpeed}getTotalLength(){this.init(0);const e=this.parts[0].getPartLength();return this.init(0),e}getTotalDuration(){let e,t,i=0;for(this.init(0),e=0;e<this.parts.length;e++)t=this.parts[e].getPartTimeEnd(),t>i&&(i=t);return this.init(0),i}isLastPartPosition(e){return(0,In.A)(this.data,e)?(0,Nn.A)(this.data,e):!1}checkLocation(e){if(!e)throw new q(e);const t=this.schedule[0].measure;if(typeof t[e.measureIdx]=="undefined"){if(e.end&&typeof t[e.measureIdx-1]!="undefined")return;throw new pe(e.measureIdx,t.length-1)}const i=t[e.measureIdx].note;if(typeof i[e.noteIdx]=="undefined")throw new Fi(e.noteIdx,i.length-1)}getRangeDuration(e,t){return this.checkLocation(e),this.checkLocation(t),new ze(this.data,this.schedule[0],0,this.manager,this.commonContent,e.measureIdx,this.playTime,e.voiceId,!0).getRangeDuration(e,t)}findLocationFromTimeInRange(e,t,i){L(`findLocationFromTimeInRange: t = ${i}`),this.checkLocation(e.location),this.checkLocation(t.location);const s=new ze(this.data,this.schedule[0],0,this.manager,this.commonContent,e.location.measureIdx,this.playTime,e.location.voiceId,!0);e.location.repeat=e.location.repeat||1,t.location.repeat=t.location.repeat||1;const r=s.findPrevRepeatsAndTags(e.location.measureIdx);s.changeRepeatsAndTagsCount(r,e.location),s.setPrevRepeatsAndTags(r);const n=s.getRangeDuration(e.location,t.location),u=(t.time-e.time)/n;return s.init(e.location.measureIdx),s.setPrevRepeatsAndTags(r),s.findLocationFromTime(e,u,i)}normalizeAnchorList(e,t){let i,s,r=[],n;const u={},a=e;t=t||[],e=e.splice(0,e.length);const l=Object.values(e);let h=-1;for(let f=0;f<l.length;f++){const p=l[f];if(p.location=p.location||{},i=!1,p.type==="end"&&(p.location.end=!0,p.location.measureIdx=this.data.getNbMeasures()),p.measureUuid){p.measureUuid=p.measureUuid.toLowerCase();try{p.location={measureIdx:this.data.getMeasureIdxFromUuid(p.measureUuid)}}catch(M){i=!0}}i||t.totalTime&&p.time>t.totalTime&&p.type!=="end"||(p.location.noteIdx=p.location.noteIdx||0,p.time>h&&(typeof u[p.location.measureIdx]=="undefined"?u[p.location.measureIdx]=[a.length]:(u[p.location.measureIdx].push(a.length),p.location.repeat=u[p.location.measureIdx].length),a.push(p),h=p.time))}const c=new ze(this.data,this.schedule[0],0,this.manager,this.commonContent,0,0,0,!0),m=Object.keys(u);for(let f=0;f<m.length;f++)if(s=u[m[f]],s.length>1)for(c.init(Number.parseInt(m[f],10),0,a[s[0]].location.voice),r=c.findPrevRepeatsAndTags(Number.parseInt(m[f],10)),n=c.currentMeasure.getNumberRepeated(r);n<u[m[f]].length;)a.splice(u[m[f]].pop(),1);return(a.length===0||a[0].location.measureIdx!==0)&&a.unshift({type:"measure",measureUuid:this.data.getMeasureUuid(0),time:0,location:{measureIdx:0,noteIdx:0}}),a.length===1&&t.totalTime&&a.push({type:"end",time:t.totalTime,location:{end:!0,measureIdx:this.data.getNbMeasures()}}),a.sort((f,p)=>f.time-p.time),a}buildAnchorList(){return new ze(this.data,this.schedule[0],0,this.manager,this.commonContent,0,0,0,!0).buildAnchorList()}addAnchor(e,t,i){typeof t=="number"&&(t={measureIdx:t,noteIdx:0}),this.checkLocation(t);const s={type:"measure",location:t,measureUuid:this.data.getMeasureUuid(t.measureIdx),time:i};let r=0;for(let n=0;n<e.length;n++){if(e[n].location.end||s.time>r&&s.time<=e[n].time)return e.splice(n,0,s),s;r=e[n].time}return null}addBestAnchor(e,t,i){if(!this.getAnchorByMeasureIdx(e,t))return this.addAnchor(e,t,i);let s;const r=this.data.getNbMeasures();for(s=t;s<r;s++)if(!this.getAnchorByMeasureIdx(e,s))return this.addAnchor(e,s,i);for(s=0;s<r;s++)if(!this.getAnchorByMeasureIdx(e,s))return this.addAnchor(e,s,i);throw new q(new Error("There are already anchors for all the measures"))}getAnchorByMeasureIdx(e,t){for(let i=0;i<e.length;i++)if(e[i].location.measureIdx===t&&!e[i].location.noteIdx)return e[i];return null}findTimePosition(e,t){let i,s,r=null,n=null;for(L("find pos %o",t),this.fillLocationObjIndexes(t),i=0;i<e.length;i++){if(r=e[i],s=r.location,s.measureIdx===t.measureIdx){if(s.noteIdx===t.noteIdx)return r.time;if(s.noteIdx>t.noteIdx)break}else if(s.measureIdx>t.measureIdx)break;n=r}return this.computeTimePosition(n,r,t)}fillLocationObjIndexes(e){if(typeof e.partIdx=="undefined"&&(e.partUuid?e.partIdx=this.data.getPartIdxFromUuid(e.partUuid):e.partIdx=0),typeof e.measureIdx=="undefined"){if(!e.measureUuid)throw new bs("measure");e.measureIdx=this.data.getMeasureIdxFromUuid(e.measureUuid)}if(typeof e.voiceId=="undefined"&&e.voiceUuid){if(!e.voiceUuid)throw new bs("voice");e.voiceId=this.data.getPartVoiceIdxFromUuid(e.partIdx,e.voiceUuid)}}computeLocationProgressInRange(e,t,i){const s=this.getRangeDuration(e,i),r=this.getRangeDuration(e,t);return s/r}computeTimePosition(e,t,i){const s=this.computeLocationProgressInRange(e.location,t.location,i),n=(t.time-e.time)*s+e.time;return L("time pos %d",n),n}setNoRepeat(){for(let e=0;e<this.parts.length;e++)this.parts[e].setNoRepeat()}getPlayedNotesInParts(){let e;const t=[];for(this.init(0),e=0;e<this.parts.length;e++)t[e]=this.parts[e].getPlayedNotesInPart();return t}setData(e){e&&(this.data=e,this.commonContent=this.data.getCommonContent(),this.schedule=e.score["score-partwise"].part)}enableSwing(){let e;for(A.swing=!0,e=0;e<this.parts.length;e++)this.parts[e]&&this.parts[e].enableSwing()}disableSwing(){let e;for(A.swing=!1,e=0;e<this.parts.length;e++)this.parts[e]&&this.parts[e].disableSwing()}setPlaybackSpeed(e){if(e<=0||e>10)throw new Error(`Incorrect value: playback speed should greater than 0 and lower or equal to 10, current value [${e}]`);const t=A.playbackSpeed,i=1/e;A.playbackSpeed=i,this.reScheduleNotesWithSpeed(i,t)}reScheduleNotesWithSpeed(e,t){const i=d.context.currentTime+.1;for(let r=0;r<this.parts.length;r++)this.parts[r].reScheduleNotesWithSpeedFromTime(e,t,i);if(!this.metronome)return;const s=this.nextTick-i;this.nextTick=i+s*e/t,this.metronome.reScheduleTicksWithSpeedFromTime(e,t,i),A.unitDuration=A.unitDuration/t*e}getPlaybackSpeed(){return 1/A.playbackSpeed}setLogger(e){this.logger=e;for(let t=0;t<this.parts.length;t++)this.parts[t].setLogger(e)}enableSliderMode(){this.sliderMode=!0}disableSliderMode(){this.sliderMode=!1}}const Ts=Sn;class Co extends ce{constructor(){const{context:e}=d;super(),this.compressor=e.createDynamicsCompressor(),this.active=!1,this.inputGain.connect(this.compressor),this.compressor.connect(this.outputGain),this.setAttack(1),this.setThreshold(-120),this.setRatio(10),this.setKnee(1),this.setRelease(2)}getAttack(){return this.compressor.attack}setAttack(e){this.compressor.attack.setValueAtTime(e,0)}getThreshold(){return this.compressor.threshold}setThreshold(e){this.compressor.threshold.setValueAtTime(e,0)}getRatio(){return this.compressor.ratio}setRatio(e){this.compressor.ratio.setValueAtTime(e,0)}getKnee(){return this.compressor.knee}setKnee(e){this.compressor.knee.setValueAtTime(e,0)}getRelease(){return this.compressor.release}setRelease(e){this.compressor.release.setValueAtTime(e,0)}isActive(){return this.active}}const ko=null;function Pn(){function o(D,k){return new Promise((O,X)=>{const z=new XMLHttpRequest;z.open("GET",D),z.responseType="arraybuffer",z.onload=()=>{O(WebAssembly.instantiate(z.response,k))},z.onerror=X,z.send()})}function e(D,k){if(!WebAssembly.instantiateStreaming)return o(D,k);const O=fetch(D,{credentials:"same-origin"});return WebAssembly.instantiateStreaming(O,k).catch(X=>{if(X.message&&X.message.indexOf("Argument 0 must be provided and must be a Response")>0)return o(D,k);throw X})}const t=5*1024*1024,i=16*1024*1024,s=64*1024;let r=null,n=t,u=!1;function a(D){const k=n;return n+=D,k}function l(D){postMessage({type:"internal-error",data:D})}let h=null,c=null,m=null;function f(D){if(c=h.vmsg_init(D),!c)return!1;const k=new Uint32Array(r.buffer,c,1)[0];return m=new Float32Array(r.buffer,k),!0}function p(D){return m.set(D),h.vmsg_encode(c,D.length)>=0}function M(){if(h.vmsg_flush(c)<0)return null;const D=new Uint32Array(r.buffer,c+4,1)[0],k=new Uint32Array(r.buffer,c+8,1)[0],O=new Uint8Array(r.buffer,D,k),X=new Blob([O],{type:"audio/mpeg"});return h.vmsg_free(c),c=null,m=null,X}function w(){const D=new Uint8Array([0,97,115,109,1,0,0,0,1,6,1,96,1,127,1,127,3,2,1,0,5,3,1,0,1,7,8,1,4,116,101,115,116,0,0,10,16,1,14,0,32,0,65,1,54,2,0,32,0,40,2,0,11]),k=new WebAssembly.Module(D);return new WebAssembly.Instance(k,{}).exports.test(4)!==0}onmessage=D=>{const k=D.data;switch(k.type){case"init":{const{wasmURL:O,shimURL:X}=k.data;Promise.resolve().then(()=>(self.WebAssembly&&!w()&&delete self.WebAssembly,self.WebAssembly||importScripts(X),r=new WebAssembly.Memory({initial:i/s,maximum:i/s}),{memory:r,pow:Math.pow,exit:l,powf:Math.pow,exp:Math.exp,sqrtf:Math.sqrt,cos:Math.cos,log:Math.log,sin:Math.sin,sbrk:a})).then(z=>e(O,{env:z})).then(z=>{h=z.instance.exports,postMessage({type:"init",data:null})}).catch(z=>{postMessage({type:"init-error",data:z.toString()})});break}case"start":f(k.data)||postMessage({type:"error",data:"vmsg_init"}),u=!0;break;case"data":if(!u)return;p(k.data)||postMessage({type:"error",data:"vmsg_encode"});break;case"stop":{const O=M();if(!O){postMessage({type:"error",data:"vmsg_flush"});return}postMessage({type:"stop",data:O});break}default:break}}}function Mn(o,e){const t=window.URL||window.webkitURL;if(!t||!window.Blob||!window.Worker)throw new It.CompatibilityError("Cannot instantiate worker due to browser compatibility");const i=new Blob(["(",Pn.toString(),")()"],{type:"application/javascript"}),s=t.createObjectURL(i),r=new Worker(s);return new Promise((n,u)=>{r.onmessage=a=>{const l=a.data;switch(l.type){case"init":n(r);break;case"init-error":r.terminate(),t.revokeObjectURL(s),u(new Error(l.data));break;default:console.log("received unexpected message type");break}},r.postMessage({type:"init",data:{wasmURL:o,shimURL:e}})})}const xn=Mn;var Dn=Math.pow,nt=(o,e,t)=>new Promise((i,s)=>{var r=a=>{try{u(t.next(a))}catch(l){s(l)}},n=a=>{try{u(t.throw(a))}catch(l){s(l)}},u=a=>a.done?i(a.value):Promise.resolve(a.value).then(r,n);u((t=t.apply(o,e)).next())});const ee=x("dacapo:recording"),wn=2;class An{constructor(e="http://localhost:3000/dist/js/",t="vmsg.wasm",i="wasm-polyfill.js"){this.baseUrl=e,this.baseUrl.endsWith("/")||(this.baseUrl+="/"),this.encoderFileName=t,this.encoderUrl=`${this.baseUrl}${this.encoderFileName}`,this.wasmPolyfillUrl=`${this.baseUrl}${i}`,this.selectedDevice=null,this.stream=null,this.microphone=null,this.recorder=null,this.scriptProcessorNode=null,this.recordedChunks=[],this.initPrmsHandlers=null,this.finalPrmsHandlers=null,this.analyserNode=null,this.analyserNodeSampleBuf=null,this.startRecordingTime=0,this.startedStream=!1,this.startRecordingTime=0,this.recordedAudioBuffer=null}init(){return nt(this,null,function*(){ee("init VmsgAudioRecorder")})}listInputDevices(){return nt(this,null,function*(){return(yield navigator.mediaDevices.enumerateDevices()).filter(t=>t.kind==="audioinput")})}selectInputDevice(e){return nt(this,null,function*(){const i=(yield this.listInputDevices()).filter(s=>s.deviceId===e);if(i.length===0)throw new Error(`given audio input ID ${e} doesn't exist`);this.selectedDevice=i.pop()})}initScriptProcessorNode(){return nt(this,null,function*(){this.finalPrmsHandlers=null,this.recorderWorker=yield xn(this.encoderUrl,this.wasmPolyfillUrl),this.recorderWorker.onmessage=this.handleWorkerMessage.bind(this),this.scriptProcessorNode=d.context.createScriptProcessor(0,2,2),this.scriptProcessorNode.onaudioprocess=this.handleScriptProcessor.bind(this),this.scriptProcessorNode.connect(d.context.destination)})}initAnalyserNode(){ee("initAnalyserNode"),this.analyserNode=d.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNodeSampleBuf=new Float32Array(this.analyserNode.fftSize),this.microphone.connect(this.analyserNode)}getAverageInputPower(){if(!this.analyserNode)return-100;this.analyserNode.getFloatTimeDomainData(this.analyserNodeSampleBuf);let e=0;for(let i=0;i<this.analyserNodeSampleBuf.length;i++)e+=Dn(this.analyserNodeSampleBuf[i],2);return 10*Math.log10(e/this.analyserNodeSampleBuf.length)}getElapsedTime(){return this.startRecordingTime?(performance.now()-this.startRecordingTime)/1e3:0}checkIfStreamStarted(e){for(let t=0;t<e.length;t++)if(e[t]){this.startedStream=!0,ee("non-zero bits detected, starting recording..."),this.initPrmsHandlers.resolve();return}}handleScriptProcessor(e){const t=[];ee(`chunk sampleRate ${e.inputBuffer.sampleRate}`);for(let i=0;i<wn;i++)t[i]=e.inputBuffer.getChannelData(i);this.startedStream||d.context.currentTime>=this.startRecordingTime&&(ee(`received data from microphone, but current time ${d.context.currentTime}
          is less than startRecordingTime ${this.startRecordingTime}, not recording`),this.checkIfStreamStarted(t[0])),this.recorderWorker.postMessage({type:"data",data:t[0]})}handleWorkerMessage(e){return nt(this,null,function*(){if(ee("handleWorkerMessage"),!(!e||!e.data)){if(e.data.type==="stop"){this.encodedBlob=e.data.data,this.encodedArrayBuffer=yield Se.convertBlobToArrayBuffer(this.encodedBlob);const t=this.encodedArrayBuffer.slice(0);this.recordedAudioBuffer=yield d.context.decodeAudioData(t),this.finalPrmsHandlers&&this.finalPrmsHandlers.resolve&&this.finalPrmsHandlers.resolve(this.encodedBlob)}else if(e.data.type==="error"||e.data.type==="internal-error")throw this.finalPrmsHandlers&&this.finalPrmsHandlers.resolve&&this.finalPrmsHandlers.reject(e.data.data),console.log("ERROR while encoding",e.data.data),new Error(e.data.data)}})}startListening(){return nt(this,null,function*(){if(ee("startListening()"),!d.context)throw ee("undefined audio context"),new he;typeof d.context.resume!="undefined"&&(d.context.state==="running"&&d.context.suspend(),d.context.resume()),yield this.initScriptProcessorNode(),this.startedStream=!1,this.recordedChunks=[];const e={video:!1,audio:{deviceId:"default",echoCancellation:!1,sampleRate:d.context.sampleRate,noiseSupression:!1,mozNoiseSuppression:!1}};this.selectedDevice&&(e.audio.deviceId=this.selectedDevice.deviceId),ee(`opts deviceId ${e.audio.deviceId}`),ee(`opts sampleRate ${e.audio.sampleRate}`),ee("going to request user media"),this.stream=yield navigator.mediaDevices.getUserMedia(e),ee("got user media stream")})}startRecording(e=0){if(ee("startRecording()"),!d.context)throw ee("undefined audio context"),new he;typeof d.context.resume!="undefined"&&(d.context.state==="running"&&d.context.suspend(),d.context.resume()),this.startRecordingTime=e;const t=new Promise((i,s)=>{this.initPrmsHandlers={resolve:i,reject:s}});return this.microphone=d.context.createMediaStreamSource(this.stream),this.microphone.connect(this.scriptProcessorNode),this.initAnalyserNode(),t.then(()=>{this.recorderWorker.postMessage({type:"start",data:d.context.sampleRate}),this.startRecordingTime=performance.now()}),t}stopRecording(){if(ee("stopRecording"),!this.stream||!this.microphone)return Promise.reject();const e=new Promise((i,s)=>{this.finalPrmsHandlers={resolve:i,reject:s}});this.recorderWorker.postMessage({type:"stop"}),this.scriptProcessorNode.disconnect(),this.scriptProcessorNode.onaudioprocess=null,this.scriptProcessorNode=null;const t=this.stream.getAudioTracks();for(let i=0;i<t.length;i++)t[i].stop();return this.stream=null,this.microphone.disconnect(),this.selectedDevice=null,this.recorder=null,this.startRecordingTime=null,this.initPrmsHandlers=null,e}getArrayBuffer(){return this.encodedArrayBuffer}getAudioBuffer(){return this.recordedAudioBuffer}printChunk(e){console.log("new chunk",e.size)}reset(){this.encodedArrayBuffer=null,this.encodedBlob=null,this.finalPrmsHandlers=null}}const vs=An;function Is(o){let e,t=Promise.resolve();return d.context&&(e=d.context.currentTime,t=new Promise((i,s)=>{$.setTimeout(()=>{e>=d.context.currentTime?o?(typeof d.context.resume!="undefined"&&(d.context.state==="running"&&d.context.suspend(),d.context.resume()),Is().then(()=>{i()}).catch(()=>{s(new ge({curTime:e,when:"starting",currentTime:d.context.currentTime,state:d.context.state}))})):s(new ge({curTime:e,currentTime:d.context.currentTime,when:"starting",state:d.context.state})):i()},1e4)})),t}const Ns=Is;var wi;(function(o){o.START="start",o.STOP="stop",o.PAUSE="pause",o.END="end"})(wi||(wi={}));const De=wi;var pt=v(818873),oe=(o,e,t)=>new Promise((i,s)=>{var r=a=>{try{u(t.next(a))}catch(l){s(l)}},n=a=>{try{u(t.throw(a))}catch(l){s(l)}},u=a=>a.done?i(a.value):Promise.resolve(a.value).then(r,n);u((t=t.apply(o,e)).next())});const me=x("dacapo:alternative-player"),En=o=>new Promise(e=>setTimeout(e,o));class On{constructor(e){Object.defineProperty(this,"playing",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"paused",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"canPlay",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"htmlElem",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"media",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"url",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"abPromise",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"audioBuffer",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"loopRange",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"countRetry",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"cbState",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"originalAnchorList",{enumerable:!0,configurable:!0,writable:!0,value:[]}),Object.defineProperty(this,"anchorList",{enumerable:!0,configurable:!0,writable:!0,value:[]}),this.reader=e,this.setAnchorList([])}setElement(e,t){if(typeof e=="string"&&(e=document.getElementById(e)),!e||!(e instanceof HTMLElement))throw new Error("DOM element not found while creating AlternativePlayer");if(this.url=t,g.isMediaElement(e))this.htmlElem=e;else{if(!t)throw new Error("No provided URL for AlternativePlayer");me("creating new <audio>");const i=document.createElement("audio");i.setAttribute("src",t),i.setAttribute("crossOrigin","anonymous"),e.appendChild(i),this.htmlElem=i}if(d.context&&ae.mainOutput){if(me("creating media el source"),this.media=d.context.createMediaElementSource(this.htmlElem),!this.media)throw new Error("couldn't create a MediaElementAudioSourceNode from the <audio> tag");this.media.connect(ae.mainOutput.input)}this.htmlElem.addEventListener("canplay",this.handleCanplayEvent.bind(this)),this.htmlElem.addEventListener("ended",this.handleEndedEvent.bind(this)),this.htmlElem.addEventListener("error",this.handleErrorEvent.bind(this))}handleErrorEvent(){if(!this.htmlElem)throw new Error("Unexpected, htmlElem is null");const e=this.htmlElem.error;if(!e)return this.throwThroughCallbackState("The <audio>/<video> tag thrown an error but no details have been provided");console.error(e.message),e.code===MediaError.MEDIA_ERR_NETWORK&&this.countRetry<10?(console.error("A network error happened while loading the media, retrying..."),this.htmlElem.load(),this.countRetry++):e.code!==MediaError.MEDIA_ERR_ABORTED&&this.throwThroughCallbackState(new Error(e.message))}handleCanplayEvent(){me("canplay"),this.canPlay=!0,this.normalizeAnchorList()}handleEndedEvent(){this.htmlElem&&(this.loopRange&&this.reader.isLastPartPosition(this.loopRange.right)?(me("received ended event, but looping is on, so resume the track playback"),this.jumpTo(this.loopRange.left),this.htmlElem.play()):(me("received ended event, stopping playback"),this.stop()))}fetchAudioBuffer(e){this.abPromise=fetch(e)}getAudioBuffer(){return oe(this,null,function*(){if(this.audioBuffer)return this.audioBuffer;if(!this.url)throw new Error("cannot get any AudioBuffer for this track: no audio file url was provided");this.abPromise||this.fetchAudioBuffer(this.url);const e=yield this.abPromise;if(!e)return null;const t=yield e.arrayBuffer();return this.audioBuffer=yield d.context.decodeAudioData(t),this.audioBuffer})}getAudioTag(){return this.htmlElem}setAnchorList(e){this.originalAnchorList=e,this.isReady&&this.normalizeAnchorList()}normalizeAnchorList(){return oe(this,null,function*(){if(!this.htmlElem)return;const e=this.htmlElem.duration;me("normalize anchors list, duration is %d",e),this.anchorList=this.reader.normalizeAnchorList(this.originalAnchorList,{totalTime:e}),me("anchors: %o",this.anchorList)})}get isReady(){return this.htmlElem!==null&&this.media!==null&&this.canPlay}ready(){return oe(this,null,function*(){for(;!this.isReady;)me("not ready yet"),yield En(250)})}isPlaying(){return this.playing}throwThroughCallbackState(e){if(typeof e=="string"&&(e=new Error(e)),!this.cbState)return console.error(`No callback has been provided to AlternativePlayer, it cannot throw error ${e} properly`);this.cbState(e)}setCallbackState(e){this.cbState=e}start(e,t){return oe(this,null,function*(){if(t&&(this.cbState=t),!this.playing){if(d.context&&(d.context.state==="suspended"||d.context.state==="interrupted")&&(me("audio context suspended, trying to resume..."),d.context.resume()),!this.htmlElem)throw new Error("Cannot start AlternativePlayer because no MediaElement has been set, use .setElement()");this.htmlElem.readyState<3&&this.htmlElem.load(),yield this.ready(),typeof e!="undefined"&&!this.paused&&this.jumpToMeasure(e),this.htmlElem.play(),this.paused=!1,this.playing=!0,this.cbState&&this.cbState(null,De.START)}})}pause(){return oe(this,null,function*(){if(this.playing){if(yield this.ready(),!this.htmlElem)throw new Error("Unexpected, htmlElem is null");this.htmlElem.pause(),this.paused=!0,this.playing=!1,this.cbState&&this.cbState(null,De.PAUSE)}})}stop(){return oe(this,null,function*(){if(yield this.ready(),!this.htmlElem)throw new Error("Unexpected, htmlElem is null");this.htmlElem.pause(),this.htmlElem.currentTime=0,this.paused=!1,this.playing=!1,this.cbState&&this.cbState(null,De.STOP)})}seekTo(e){return oe(this,null,function*(){if(me("seek to %s",e),yield this.ready(),!this.htmlElem)throw new Error("Unexpected, htmlElem is null");this.htmlElem.currentTime=e})}loopInRange(e,t){return oe(this,null,function*(){return yield this.ready(),this.loopRange=t,e===null?yield this.jumpTo(t.left):(e.noteIdx=e.currentNoteIdx,(0,pt.A)(this.reader.data,e,t.right)>0?yield this.jumpTo(t.left):!1)})}disableLoop(){this.loopRange=null}getTimeFromLocation(e){return this.reader.findTimePosition(this.anchorList,e)}jumpTo(e){return oe(this,null,function*(){yield this.ready();const t=this.getTimeFromLocation(e);if(this.htmlElem===null)throw new Error("Unexpected, htmlElem is null");return this.htmlElem.currentTime=t,!0})}jumpToMeasure(e){const t={measureIdx:e,partIdx:0,voiceId:0,noteIdx:0};return this.jumpTo(t)}getSliderLocation(e){let t=null,i=null;if(typeof e=="undefined"){if(!this.htmlElem)throw new Error("Cannot getSliderLocation because no time has been provided, and no htmlElem have been set on AlternativePlayer");e=this.htmlElem.currentTime}for(let r=0;r<this.anchorList.length&&(t=this.anchorList[r],!(t.time>e));r++)i=t;return i&&i.location&&i.location.end?null:this.reader.findLocationFromTimeInRange(i,t,e)}setPlaybackSpeed(e){return oe(this,null,function*(){if(me(`set AlternativePlayer playback speed to ${e}`),yield this.ready(),!this.htmlElem)throw new Error("Unexpected, htmlElem is null");this.htmlElem.playbackRate=e,this.htmlElem.defaultPlaybackRate&&(this.htmlElem.defaultPlaybackRate=e)})}getAvailablePlaybackSpeedList(){return oe(this,null,function*(){return null})}addBestAnchor(e){return new Promise(t=>{this.getCurrentTime().then(i=>{t(this.reader.addBestAnchor(this.anchorList,e,i))})})}addAnchor(e){return this.reader.addAnchor(this.anchorList,e.location||e,e.time)}getCurrentTime(){return oe(this,null,function*(){if(yield this.ready(),!this.htmlElem)throw new Error("Unexpected, htmlElem is null");return this.htmlElem.currentTime})}getDuration(){return oe(this,null,function*(){if(yield this.ready(),!this.htmlElem)throw new Error("Unexpected, htmlElem is null");return this.htmlElem.duration})}}const $t=On;function Ss(o,e){let t=o.measureIdx;if(t!==void 0){const i=e.getNbMeasures();if(t<0||t>=i)throw new Error(`The measure idx ${t} is invalid`);return t}if(o.measureUuid===void 0)throw new Error("measureUuid or measureIdx is required");return t=e.getMeasureIdxFromUuid(o.measureUuid),t}function Ps(o,e){let t=o.partIdx;if(t!==void 0){const s=e.getNbParts();if(t<0||t>=s)throw new Error(`The part idx ${t} is invalid`)}else{if(o.partUuid===void 0)throw new Error("partUuid or partIdx is required");t=e.getPartIdxFromUuid(o.partUuid)}let i=o.voiceIdx;if(i!==void 0){if(!e.getPartVoicesIndexes(t).includes(i))throw new Error(`The voice idx ${i} is invalid`)}else{if(o.voiceUuid===void 0)throw new Error("voiceUuid or voiceIdx is required");i=e.getPartVoiceIdxFromUuid(t,o.voiceUuid)}return{partIdx:t,voiceIdx:i}}function Cn(o,e,t){if(typeof o.dpq=="number"&&typeof o.timePos=="number")return o.timePos/o.dpq;const i=o.noteIdx;if(typeof i!="number")throw new Error("Invalid raw position: noteIdx is required");const{partIdx:s,voiceIdx:r}=Ps(o,t),n=t.getMeasure(s,e),u=new ui.A(n),a=u.getVoice(r),l=a.getNbNotes();if(i<0||i>=l)throw new Error(`Invalid note index: ${i} (valid range: 0-${l-1})`);const h=a.getRangeSpace(0,i),c=u.getDpqValue();return h/c}function Ms(o,e){const t=Ss(o,e),i=Cn(o,t,e);return{scoreMeasureIdx:t,quarterPosInMeasure:i}}function kn(o,e,t){if(typeof o.dpq=="number"&&typeof o.timePos=="number")return o.timePos/o.dpq;const i=o.noteIdx;if(typeof i!="number")throw new Error("Invalid raw position: noteIdx is required");const{partIdx:s,voiceIdx:r}=Ps(o,t),n=t.getMeasure(s,e),u=new ui.A(n),a=u.getVoice(r),l=a.getNbNotes();if(i<0||i>=l)throw new Error(`Invalid note index: ${i} (valid range: 0-${l-1})`);const h=a.getRangeSpace(0,i+1),c=u.getDpqValue();return h/c}function Rn(o,e){const t=Ss(o,e),i=kn(o,t,e);return{scoreMeasureIdx:t,quarterPosInMeasure:i}}function _n(o,e){try{const t=Ms(o.left,e),i=Rn(o.right,e);return{left:t,right:i}}catch(t){return null}}function Vn(o,e){const t=e.getPlayOrder(),i=xs(t.measuresList,o.left.scoreMeasureIdx),s=xs(t.measuresList,o.right.scoreMeasureIdx);let r=null;const n=i.find((u,a)=>{const l=a+1<i.length?i[a+1].audioMeasureIdx:null;if(r=s.find(h=>!(h.audioMeasureIdx<u.audioMeasureIdx||l!==null&&h.audioMeasureIdx>l))||null,r)return!0});return n&&r?(r=r,{left:{audioMeasureIdx:n.audioMeasureIdx,quarterPosInMeasure:o.left.quarterPosInMeasure},right:{audioMeasureIdx:r.audioMeasureIdx,quarterPosInMeasure:o.right.quarterPosInMeasure}}):null}function xs(o,e){const t=[];return o.forEach((i,s)=>{i===e&&t.push({scoreMeasureIdx:i,audioMeasureIdx:s})}),t}function Ai(o,e){const i=e.getPlayOrderQuarterMapping().measureIdxToQuarter(o.audioMeasureIdx)+o.quarterPosInMeasure;return e.getTimeMapping().quarterToSeconds(i)}function $n(o,e){const t=Ai(o.left,e),i=Ai(o.right,e);return{startTime:t,endTime:i}}function Ln(o,e){const i=e.getPlayOrder().measuresList.map((s,r)=>({scoreMeasureIdx:s,audioMeasureIdx:r})).find(s=>s.scoreMeasureIdx===o.scoreMeasureIdx);if(!i)throw new Error("Invalid score measure index");return{audioMeasureIdx:i.audioMeasureIdx,quarterPosInMeasure:o.quarterPosInMeasure}}var ue=(o,e,t)=>new Promise((i,s)=>{var r=a=>{try{u(t.next(a))}catch(l){s(l)}},n=a=>{try{u(t.throw(a))}catch(l){s(l)}},u=a=>a.done?i(a.value):Promise.resolve(a.value).then(r,n);u((t=t.apply(o,e)).next())});const _e=x("dacapo:alternative-player-default-sync"),Fn=o=>new Promise(e=>setTimeout(e,o));class Lt{constructor(e){var t;if(Object.defineProperty(this,"playing",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"paused",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"canPlay",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"initialPlaybackSpeed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"htmlElem",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"media",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"url",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"abPromise",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"loopRange",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"countRetry",{enumerable:!0,configurable:!0,writable:!0,value:0}),Object.defineProperty(this,"cbState",{enumerable:!0,configurable:!0,writable:!0,value:null}),Object.defineProperty(this,"boundHandleCanplayEvent",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"boundHandleEndedEvent",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"boundHandleErrorEvent",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),this.reader=e.reader,this.url=e.url,this.initialPlaybackSpeed=(t=e.initialPlaybackSpeed)!=null?t:1,this.htmlElem=e.htmlElem,qn()&&zn()){_e("creating media el source");const i=Ft(),s=Un(),r=i.createMediaElementSource(this.htmlElem);if(!r)throw new Error("couldn't create a MediaElementAudioSourceNode from the <audio> tag");r.connect(s),this.media=r}this.boundHandleCanplayEvent=this.handleCanplayEvent.bind(this),this.boundHandleEndedEvent=this.handleEndedEvent.bind(this),this.boundHandleErrorEvent=this.handleErrorEvent.bind(this),this.htmlElem.addEventListener("canplay",this.boundHandleCanplayEvent),this.htmlElem.addEventListener("ended",this.boundHandleEndedEvent),this.htmlElem.addEventListener("error",this.boundHandleErrorEvent)}destroy(){this.htmlElem.removeEventListener("canplay",this.boundHandleCanplayEvent),this.htmlElem.removeEventListener("ended",this.boundHandleEndedEvent),this.htmlElem.removeEventListener("error",this.boundHandleErrorEvent)}handleErrorEvent(){const e=this.htmlElem.error;if(!e)return this.throwThroughCallbackState("The <audio>/<video> tag thrown an error but no details have been provided");console.error(e.message),e.code===MediaError.MEDIA_ERR_NETWORK&&this.countRetry<10?(console.error("A network error happened while loading the media, retrying..."),this.htmlElem.load(),this.countRetry++):e.code!==MediaError.MEDIA_ERR_ABORTED&&this.throwThroughCallbackState(new Error(e.message))}handleCanplayEvent(){_e("canplay"),this.canPlay=!0}handleEndedEvent(){this.loopRange?(_e("received ended event, but looping is on, so resume the track playback"),this.htmlElem.currentTime=this.loopRange.startTime,this.htmlElem.play()):(_e("received ended event, stopping playback"),this.stop())}getAudioBuffer(){return this.getAudioBufferPromise()}getAudioBufferPromise(){return this.abPromise||(this.abPromise=ue(this,null,function*(){if(!this.url)throw new Error("cannot get any AudioBuffer for this track: no audio file url was provided");const e=yield fetch(this.url);if(!e)throw new Error(`Cannot fetch the audio file at ${this.url}`);const t=yield e.arrayBuffer();return yield Ft().decodeAudioData(t)})),this.abPromise}getAudioTag(){return this.htmlElem}get isReady(){return this.media!==null&&this.canPlay}ready(){return ue(this,null,function*(){if(!this.media)throw new Error("Cannot be ready because the AudioContext was not present");for(;!this.isReady;)_e("not ready yet"),yield Fn(250)})}isPlaying(){return this.playing}throwThroughCallbackState(e){if(typeof e=="string"&&(e=new Error(e)),!this.cbState)return console.error(`No callback has been provided to AlternativePlayer, it cannot throw error ${e} properly`);this.cbState(e)}setCallbackState(e){this.cbState=e}start(e,t){return ue(this,null,function*(){if(t&&(this.cbState=t),this.playing)return;const i=Ft();(i.state==="suspended"||i.state==="interrupted")&&(_e("audio context suspended, trying to resume..."),i.resume()),this.htmlElem.readyState<3&&this.htmlElem.load(),yield this.ready();const s=this.htmlElem.currentTime;this.loopRange&&(s<this.loopRange.startTime||s>this.loopRange.endTime)?this.htmlElem.currentTime=this.loopRange.startTime:typeof e!="undefined"&&!this.paused&&this.jumpToMeasure(e),this.htmlElem.play(),this.paused=!1,this.playing=!0,this.cbState&&this.cbState(null,De.START)})}pause(){return ue(this,null,function*(){this.playing&&(yield this.ready(),this.htmlElem.pause(),this.paused=!0,this.playing=!1,this.cbState&&this.cbState(null,De.PAUSE))})}stop(){return ue(this,null,function*(){yield this.ready(),this.htmlElem.pause(),this.htmlElem.currentTime=0,this.paused=!1,this.playing=!1,this.cbState&&this.cbState(null,De.STOP)})}seekTo(e){return ue(this,null,function*(){_e("seek to %s",e),yield this.ready(),this.htmlElem.currentTime=e})}setLoopRange(e){const t=_n(e,this.reader.scoreData);if(t===null){this.loopRange=null;return}const i=Vn(t,this.reader);if(i===null){this.loopRange=null;return}this.loopRange=$n(i,this.reader),this.loopRange.startTime*=this.initialPlaybackSpeed,this.loopRange.endTime*=this.initialPlaybackSpeed}loopInRange(){return ue(this,null,function*(){if(this.loopRange===null)return;if(this.htmlElem===null)throw new Error("Unexpected, htmlElem is null");const e=this.htmlElem.currentTime;return e<this.loopRange.startTime||e>this.loopRange.endTime?(this.htmlElem.currentTime=this.loopRange.startTime,!0):!1})}disableLoop(){this.loopRange=null}getTimeFromLocation(e){const t=Ms(e,this.reader.scoreData),i=Ln(t,this.reader);return Ai(i,this.reader)*this.initialPlaybackSpeed}jumpTo(e){return ue(this,null,function*(){yield this.ready();const t=this.getTimeFromLocation(e);if(this.htmlElem===null)throw new Error("Unexpected, htmlElem is null");return this.htmlElem.currentTime=t,!0})}jumpToMeasure(e){const t={measureIdx:e,timePos:0,dpq:1};return this.jumpTo(t)}getSliderLocation(e){typeof e=="undefined"&&(e=this.htmlElem.currentTime);const t=Bn();e-=t,e=Math.max(e,0),e/=this.initialPlaybackSpeed;const i=this.reader.getSecondsDuration();e=Math.min(e,i);const s=this.reader.getPlayOrderQuarterMapping(),r=this.reader.getTimeMapping().secondsToQuarter(e),n=s.quarterToMeasureIdx(r),u=s.getRelativeQuarterPosition(n,r),a=this.reader.getPlayOrder(),l=a.audioToScoreMeasureIdx(n),h=n+1;let c=null;return h<a.getNbMeasures()&&(c=a.audioToScoreMeasureIdx(h)),{quarterFromMeasureStart:u,currentMeasure:l,nextMeasure:c}}setPlaybackSpeed(e){return ue(this,null,function*(){_e(`set AlternativePlayer playback speed to ${e}`),yield this.ready(),this.htmlElem.playbackRate=e,this.htmlElem.defaultPlaybackRate&&(this.htmlElem.defaultPlaybackRate=e)})}getAvailablePlaybackSpeedList(){return ue(this,null,function*(){return null})}getCurrentTime(){return ue(this,null,function*(){return yield this.ready(),this.htmlElem.currentTime})}getDuration(){return ue(this,null,function*(){return yield this.ready(),this.htmlElem.duration})}}function Bn(){const o=Ft();let e=0;return typeof o.outputLatency=="number"&&(e=o.outputLatency),e}function Ft(){if(!d||!d.context)throw Error("The audio context doesn't exists");return d.context}function qn(){return!(!d||!d.context)}function Un(){if(!ae||!ae.mainOutput||!ae.mainOutput.input)throw Error("The main output doesn't exists");return ae.mainOutput.input}function zn(){return!(!ae||!ae.mainOutput||!ae.mainOutput.input)}var we=(o,e,t)=>new Promise((i,s)=>{var r=a=>{try{u(t.next(a))}catch(l){s(l)}},n=a=>{try{u(t.throw(a))}catch(l){s(l)}},u=a=>a.done?i(a.value):Promise.resolve(a.value).then(r,n);u((t=t.apply(o,e)).next())});const U=x("dacapo:clock"),Gn=x("dacapo:slider");class Wn{constructor(e){U("instanciating Clock"),this.isPlaying=!1,this.isPaused=!1,this.isRecording=!1,this.isExporting=!1,this.loopMode=!1,this.endReached=!1,this.metronome=null,this.swing=!1,this.reader=e,this.startInterval=0,this.nextNoteRelative=0,this.playingOptions={},this.interval=25,this.timerID=null,this.nextNote=0,this.ahead=.1,this.cbState=null,this.prmsResolver=null,this.altPlayers={},this.altPlayer=null,this.exportProgressCallback=null,this.sectionsDurations=[],this.totalNumberOfSections=0,this.audioRecorder=null}getInterval(){return this.interval}setInterval(e){this.interval=e}getPlayingHeadPosition(){if(this.altPlayer&&(!this.playingOptions||!this.playingOptions.forceClassicPlayback)){const t=this.altPlayer.getSliderLocation();return Gn("slider location: %O",t),t}const e=this.reader.getPlayingHeadPosition();return this.isPlaying||(e.currentMeasure=0),e}loop(){if(this.endReached=this.reader.loopCallback(),!this.loopMode&&this.endReached){this.isExporting=!1,this.cbState!==null&&this.cbState(null,"end");return}this.loop()}loopSinglePart(e){if(this.endReached=this.reader.loopSinglePartCallback(e),!this.loopMode&&this.endReached){this.isExporting=!1,this.cbState!==null&&Promise.all(this.reader.getPendingPromisesForPart(e)).then(()=>{this.cbState(null,"end")});return}this.loopSinglePart(e)}exportSinglePartSplitIntoMeasures(e){return we(this,null,function*(){if(d.context.state===be.CLOSED){const i=this.sectionsDurations.shift();i>0&&this.renewOfflineContext(i)}this.endReached=yield this.reader.exportNextSectionInSinglePart(e);const t=(this.totalNumberOfSections-this.sectionsDurations.length)/this.totalNumberOfSections;return this.exportProgressCallback({partIdx:e,stage:"exporting",progress:t,time:Date.now()}),!this.loopMode&&this.endReached?(this.isExporting=!1,this.reader.getFinalBuffer()):this.exportSinglePartSplitIntoMeasures(e)})}renewOfflineContext(e){N.renewOfflineContext(e),U(`just renewed the offline context with a duration of ${e}s`),this.reader.manager.renewWebAudioNodes(),this.reader.manager.connectAllInstrumentsTo(N.mainOutput)}startPlaybackLoop(){return this.cbState&&(!this.metronome||!this.metronome.isSolo())&&this.cbState(null,"start"),new Promise((e,t)=>{this.prmsResolver=e,U("starting loopSchedule recursive function"),this.loopSchedule(e,t)})}loopSchedule(e,t){let i;U("loopSchedule, calling reader to schedule upcoming notes...");try{this.endReached=this.reader.scheduleWindow(G.WINDOW_SIZE)}catch(s){this.cbState!==null&&this.cbState(s)}if(!this.loopMode&&this.endReached){if(this.isPlaying=!1,this.cbState!==null&&(this.cbState(null,"end"),e()),!this.metronome||this.metronome.getMode()!==1){this.cleanWorker();return}this.metronome.setSolo(!0)}(this.isPlaying||this.metronome&&this.metronome.isSolo())&&(i=d.context.currentTime,this.timerID=$.setTimeout(this.loopScheduleCallback,G.SCHEDULING_INTERVAL,this,[i,e,t]))}loopScheduleCallback(e,t,i){return we(this,null,function*(){if(d.context.currentTime===Number.POSITIVE_INFINITY)t();else{if(!this.isPlaying&&!(this.metronome&&this.metronome.isSolo())){t();return}U(`loopScheduleCallback called at ${d.context.currentTime}`),e>=d.context.currentTime&&(typeof d.context.resume!="undefined"&&(yield d.resume()),d.context.state!==be.RUNNING&&Ns().catch(()=>{i(new ge({curTime:e,currentTime:d.context.currentTime,when:"playing",state:d.context.state}))})),this.loopSchedule(t,i)}})}loopOn(){this.loopMode=!0}loopOff(){this.loopMode=!1}togglePlay(){this.isPlaying?this.stop():this.start()}start(e,t){return we(this,arguments,function*(i,s,r={}){let n=0;return typeof i=="function"&&(s=i,i=0),U(`start at measure ${i}`),typeof s=="function"&&(this.cbState=s),N.initialized||N.init(),this.playingOptions&&(this.playingOptions=JSON.parse(JSON.stringify(r))),this.altPlayer&&!r.forceClassicPlayback?this.altPlayer.start(i,s):d.context?this.isPlaying?(U("playback already active"),Promise.resolve()):(d.context.state!==be.RUNNING&&(U("audio context is not running, trying to resume..."),yield d.resume()),this.isPaused?(U("playback currently paused , resuming..."),this.isPaused=!1,this.isPlaying=!0,this.reader.resumeScheduledNotes(),this.prms=this.startPlaybackLoop()):(this.metronome&&(n=this.metronome.getMode()),this.reader.init(i),this.isPlaying=!0,U(`current metronome mode ${n}`),n!==1?(typeof this.reader.playTime=="number"&&this.reader.setNextTick(this.reader.playTime),this.metronome&&n===0&&(this.metronome.setSolo(!0),this.reader.scheduleMetronomeIntro()),this.prms=this.startPlaybackLoop()):(U("metronome currently in continuous mode, waiting the end of the measure to start..."),this.reader.waitEndMeasure=!0,this.cbState&&this.cbState(null,"start"))),this.prms):Promise.reject(Error("No valid context"))})}exportMIDI(){this.isExporting=!0,this.loop()}export(){return this.isExporting=!0,new Promise((e,t)=>{this.cbState=(i,s)=>i?t(i):s==="end"?d.context.startRendering().then(e).catch(t):t(new Error(`Unexpected State: [${s}]`)),this.loop()})}exportPart(e){return this.exporting=!0,this.exportProgressCallback({partIdx:e,stage:"scheduling",time:Date.now()}),new Promise((t,i)=>{this.cbState=(s,r)=>s?i(s):r==="end"?(this.reportExportProgressRecur(e),d.context.startRendering().then(n=>{clearTimeout(this.reportingTimer),t(n)}).catch(i)):i(new Error(`Unexpected State: [${r}]`)),this.loopSinglePart(e)})}exportPartSequenced(e,t){return we(this,null,function*(){return this.exporting=!0,this.sectionsDurations=t,this.totalNumberOfSections=this.sectionsDurations.length,this.exportProgressCallback({partIdx:e,stage:"scheduling",time:Date.now()}),yield this.exportSinglePartSplitIntoMeasures(e)})}initOrRenewContextForPreloading(e){d.context?this.renewOfflineContext(e):N.initOfflineContext(2,e*44100,44100)}preloadPartExport(e){return we(this,null,function*(){this.initOrRenewContextForPreloading(.1),U(`preload part ${e}`),this.reader.manager.enablePreloadMode(e),U("preload mode activated"),U(`launched part ${e} preloading, waiting for promises to resolve...`);const t=yield this.reader.preloadSinglePartAndGetSectionsDurations(e);return this.reader.manager.disablePreloadMode(e),U(`part ${e} finished preloading`),yield d.context.startRendering(),t})}reportExportProgressRecur(e){const{currentTime:t}=d.context,i=d.context.length/d.context.sampleRate,s=t/i*100>>0;this.exportProgressCallback({partIdx:e,stage:"exporting",progress:s,time:Date.now()}),this.reportingTimer=setTimeout(this.reportExportProgressRecur.bind(this,e),5e3)}setExportProgressCallback(e){this.exportProgressCallback=e}pause(){if(U("pause playback"),this.altPlayer){this.isPlaying=!1,this.isPaused=!0,this.altPlayer.pause();return}d.context&&(!this.isPlaying&&!(this.metronome&&this.metronome.isSolo())||(this.cleanWorker(),this.reader.pauseScheduledNotes(),this.isPlaying=!1,this.isPaused=!0,this.prmsResolver()))}stop(){return we(this,null,function*(){if(d.context){if(U("stop playback"),this.isPaused=!1,this.altPlayer){this.isPlaying=!1,this.altPlayer.stop();return}this.isPlaying&&(this.isPlaying=!1,this.reader.stopScheduledNotes(),!this.metronome||this.metronome.getMode()!==1?(yield this.cleanWorker(),this.metronome&&(this.metronome.cancelSequence(),this.metronome.reset())):this.metronome.setSolo(!0),this.prmsResolver()),this.reader.init()}})}restart(){return d.context?this.altPlayer?(this.altPlayer.jumpTo({measureIdx:0,noteIdx:0}),Promise.resolve()):(this.isPaused=!1,this.reader.stopScheduledNotes(),this.prmsResolver(),this.prms=new Promise((e,t)=>{this.prmsResolver=e,this.isPlaying&&(!this.metronome||this.metronome.getMode()!==1)?(this.cleanWorker(),this.reader.init(0),this.loopSchedule(e,t)):(this.metronome.setSolo(!0),this.reader.init(0),this.reader.waitEndMeasure=!0)}),this.prms):Promise.reject()}jumpToMeasure(e){return this.altPlayer?this.altPlayer.jumpTo({measureIdx:e,noteIdx:0}):(this.reader.stopScheduledNotes(),this.prmsResolver(),this.prms=new Promise((t,i)=>{this.prmsResolver=t,this.cleanWorker(),this.reader.init(e),this.loopSchedule(t,i)}),this.prms)}cleanWorker(){U(`cleaning worker timer... timerID: ${this.timerID}`);let e=Promise.resolve();return typeof this.timerID!="undefined"&&(e=new Promise(t=>{$.clearTimeout(this.timerID,()=>{t()})})),e}startRecording(e){if(!d.context)throw new he;this.isRecording||(this.isRecording=!0,this.inputMIDI.startRecording(e))}stopRecord(){if(!d.context)throw new he;this.isRecording&&(this.isRecording=!1)}startAudioListening(){return we(this,null,function*(){if(!d.context)throw new he;U("start audio listening"),yield this.audioRecorder.startListening()})}startAudioRecording(){return we(this,null,function*(){if(!d.context)throw new he;this.isRecording||(yield this.audioRecorder.startRecording(),this.isRecording=!0)})}stopAudioRecording(){if(!d.context)throw new he;if(!this.isRecording)throw Error("No recording is currently ongoing");return this.isRecording=!1,this.audioRecorder.stopRecording()}resetAudioRecording(){this.isRecording=!1,this.audioRecorder&&this.audioRecorder.reset()}getRecordedArrayBuffer(){return this.audioRecorder.getArrayBuffer()}getRecordedAudioBuffer(){return this.audioRecorder.getAudioBuffer()}getTrackAudioBuffer(){return this.altPlayer instanceof $t||this.altPlayer instanceof Lt?this.altPlayer.getAudioBuffer():null}getAudioInputs(){return we(this,null,function*(){return yield this.audioRecorder.listInputDevices()})}getAverageAudioInputPower(){return this.audioRecorder.getAverageInputPower()}getAudioRecordingTime(){return this.audioRecorder.getElapsedTime()}initAudioRecorder(e,t,i){this.audioRecorder=new vs(e,t,i)}setReader(e){this.reader=e}setNoRepeat(){this.reader&&this.reader.setNoRepeat()}setMetronome(e){this.metronome=e,this.reader.setMetronome(e)}scheduleMetronomeSequence(e,t,i){return U(`schedule metronome sequence at ${t}s`),new Promise(s=>{if(!this.metronome){s();return}this.metronome.scheduleCountIn(e,t,i,()=>{s()})})}stopMetronomeSequence(){this.reader.metronome&&this.reader.metronome.cancelSequence(),this.cleanWorker()}toggleMetronome(){let e,t;return this.metronome&&(t=this.metronome.getMode(),e=(t+1)%3,this.setMetronomeMode(e)),e}setMetronomeMode(e,t=0,i=!0){if(U(`setMetronomeMode(mode = ${e}, time = ${t}, stopCurrentSequence = ${i})`),!this.metronome)return;if(!Object.values(gi).includes(e))throw new Error(`Tried to set unknown metronome mode: ${e}`);let s;const r=this.metronome.getMode();U(`currentMode is ${r}, going to change to mode ${e}`),e!==r&&(this.metronome.setMode(e),r===1&&(i&&(this.metronome.switchOff(),this.cleanWorker(),this.metronome.cancelSequence()),this.isPlaying||(this.stop(),this.metronome.setSolo(!1))),e===2?this.metronome.mute():r===2&&this.metronome.unmute(),e===1&&(this.metronome.switchOn(),this.isPlaying?this.reader.setDefaultNextTick():(this.reader.init(),this.metronome.setSolo(!0),t?s=t:s=this.metronome.getNextPossibleTime(),U(`setNextTick at ${s}`),this.reader.setNextTick(s),this.prms=this.startPlaybackLoop())))}getAvailablePlaybackSpeedList(){return this.altPlayer?this.altPlayer.getAvailablePlaybackSpeedList?this.altPlayer.getAvailablePlaybackSpeedList():Promise.resolve([]):null}setGlobalPlaybackSpeed(e){U(`set global playback speed: ${e}`),this.reader.setPlaybackSpeed(e),this.altPlayer&&this.altPlayer.setPlaybackSpeed(e)}getGlobalPlaybackSpeed(){return this.reader.getPlaybackSpeed()}toggleSwing(){this.swing?this.reader.disableSwing():this.reader.enableSwing(),this.swing=!this.swing}enableSwing(){this.swing||(this.swing=!0,this.reader.enableSwing())}disableSwing(){this.swing&&(this.swing=!0,this.reader.disableSwing())}isSwingEnabled(){return this.swing}getAltPlayer(){return this.altPlayer}setAltPlayer(e,t){this.altPlayers[e]=t}enableAltPlayer(e){if(this.isPlaying&&this.stop(),!this.altPlayers[e])throw new Ht;this.altPlayer=this.altPlayers[e]}disableAltPlayer(){this.altPlayer&&(this.altPlayer.stop(),this.altPlayer=null)}}const jn=Wn;var Ve=(o,e,t)=>new Promise((i,s)=>{var r=a=>{try{u(t.next(a))}catch(l){s(l)}},n=a=>{try{u(t.throw(a))}catch(l){s(l)}},u=a=>a.done?i(a.value):Promise.resolve(a.value).then(r,n);u((t=t.apply(o,e)).next())});const gt=x("dacapo:custom-player"),Hn=o=>new Promise(e=>setTimeout(e,o));class Qn{constructor(e){this.timeStart=0,this.pausedCurrentTime=0,this.duration=0,this.reader=e,this.setAnchorList([]),this.anchorIdx=0,this.canPlay=!0,this.playing=!1,this.paused=!1,this.loopRange=null}setAnchorList(e){this.originalAnchorList=e,this.isReady&&this.normalizeAnchorList()}normalizeAnchorList(){return new Promise(e=>{const t=this.duration;gt("normalize anchors list, duration is %d",t),this.anchorList=this.reader.normalizeAnchorList(this.originalAnchorList,{totalTime:t}),gt("anchors: %o",this.anchorList),e()})}get isReady(){return this.canPlay}get absoluteTime(){return performance.now()/1e3+this.duration}ready(){return Ve(this,null,function*(){for(;!this.isReady;)gt("not ready yet"),yield Hn(250)})}isPlaying(){return this.playing}setCallbackState(e){this.cbState=e}start(e,t){return Ve(this,arguments,function*(i,s,r=this.absoluteTime){s&&(this.cbState=s),this.playing||(this.timeStart=r,this.paused&&(this.timeStart-=this.pausedCurrentTime,this.pausedCurrentTime=0),typeof i!="undefined"&&!this.paused&&this.jumpToMeasure(i,r),this.paused=!1,this.playing=!0,s&&this.cbState(null,"start"))})}pause(){return Ve(this,arguments,function*(e=this.absoluteTime){this.playing&&(this.pausedCurrentTime=this.currentTime(e),this.paused=!0,this.playing=!1,this.cbState&&this.cbState(null,"pause"))})}stop(){return Ve(this,null,function*(){this.timeStart=0,this.pausedCurrentTime=0,this.paused=!1,this.playing=!1,this.cbState&&this.cbState(null,"stop")})}getTimeFromLocation(e){return this.reader.findTimePosition(this.anchorList,e)}jumpTo(e){return Ve(this,arguments,function*(t,i=this.absoluteTime){const s=this.getTimeFromLocation(t);return this.timeStart=i-s,!0})}seekTo(e,t=this.absoluteTime){return new Promise(i=>{this.ready().then(()=>{gt("seek to %s",e);const s=t;this.timeStart=s-e,i()})})}loopInRange(e,t){return Ve(this,null,function*(){return yield this.ready(),this.loopRange=t,e===null?this.jumpTo(t.left):(e.noteIdx=e.currentNoteIdx,(0,pt.A)(this.reader.data,e,t.right)>0?this.jumpTo(t.left):!1)})}disableLoop(){this.loopRange=null}jumpToMeasure(e,t=this.absoluteTime){const i={measureIdx:e,noteIdx:0};return this.jumpTo(i,t)}getSliderLocation(e,t=this.absoluteTime){let i,s=null,r=null;if(typeof e=="undefined"&&(!this.playing&&!this.paused?e=0:!this.playing&&this.paused?e=this.pausedCurrentTime:e=this.currentTime(t)),!this.anchorList||this.anchorList.length===0)return{timeFromNoteStart:0,timeFromMeasureStart:0,currentNoteIdx:0,currentNoteRealIdx:0,currentNoteDuration:1,currentVoiceId:0,currentMeasure:0,quarterFromMeasureStart:0,quarterNotePos:0,isLastMeasureNote:!1};for(e>this.duration&&(e=this.duration),e<0&&(e=0),i=this.anchorIdx;i<this.anchorList.length&&(s=this.anchorList[i],!(s.time>e));i++)i<this.anchorList.length-1&&(r=s);return r?this.reader.findLocationFromTimeInRange(r,s,e):(gt("before first anchor"),{timeFromNoteStart:0,timeFromMeasureStart:0,currentNoteIdx:0,currentNoteRealIdx:0,currentNoteDuration:1,currentVoiceId:0,currentMeasure:0,quarterFromMeasureStart:0,quarterNotePos:0,isLastMeasureNote:!1})}addBestAnchor(e,t=this.absoluteTime){t=this.currentTime(t),this.reader.addBestAnchor(this.anchorList,e,t)}addAnchor(e){return this.reader.addAnchor(this.anchorList,e.location,e.time)}currentTime(e=this.absoluteTime){return e-this.timeStart}getCurrentTime(e){return Ve(this,null,function*(){return this.currentTime(e)})}getDuration(){return Ve(this,null,function*(){return this.duration})}setDuration(e){this.duration=e}}const Ds=Qn;var ve=(o,e,t)=>new Promise((i,s)=>{var r=a=>{try{u(t.next(a))}catch(l){s(l)}},n=a=>{try{u(t.throw(a))}catch(l){s(l)}},u=a=>a.done?i(a.value):Promise.resolve(a.value).then(r,n);u((t=t.apply(o,e)).next())});const Q=x("dacapo:yt");class Yn{constructor(e,t){this.reader=e,this.elementContainer=t.element,this.videoId=t.videoId,this.height=t.height||390,this.width=t.width||640,this.readyPromises=[],this.setAnchorList(t.anchorList||[]),this.anchorIdx=0,this.playing=!1,this.paused=!1,this.isReady=!1,this.loopRange=null,this.loadIframeAPI().then(this.loadVideo.bind(this)).then(this.normalizeAnchorList.bind(this)).then(()=>{Q("ready"),this.isReady=!0,this.readyPromises.forEach(i=>{i()})})}ready(){return new Promise(e=>{this.isReady?e():this.readyPromises.push(e)})}loadIframeAPI(){return new Promise(e=>{if(typeof YT=="undefined"){Q("loading Youtube API"),document.addEventListener("YTApiReady",()=>{Q("YT API loaded"),e()},{once:!0,passive:!0});const t=document.createElement("script");t.src="https://www.youtube.com/iframe_api";const[i]=document.getElementsByTagName("script");i.parentNode.insertBefore(t,i)}else Q("YT API already loaded"),e()})}loadVideo(){return new Promise(e=>{typeof this.elementContainer=="string"&&(this.elementContainer=document.getElementById(this.elementContainer)),this.elementContainer.innerHTML="",this.element=document.createElement("div"),this.elementContainer.appendChild(this.element),this.player=new YT.Player(this.element,{height:this.height,width:this.width,videoId:this.videoId,playerVars:{autoplay:0,modestbranding:1,iv_load_policy:3,fs:0,disablekb:1,widget_referrer:"flat.io"},events:{onReady:t=>{Q("video loaded"),this.player=t.target,this.player.setVolume(100),this.player.unMute(),e()},onStateChange:this.ytStateChange.bind(this)}})})}ytStateChange(e){return ve(this,null,function*(){Q("yt player state changed to %s",e.data),e.data===YT.PlayerState.PLAYING?(this.playing=!0,this.paused=!1,(yield this.getCurrentTime())<this.anchorList[0].time?(this.player.seekTo(this.anchorList[0].time,!0),this.cbState&&setTimeout(()=>{this.cbState(null,"start")},500)):this.cbState&&this.cbState(null,"start")):e.data===YT.PlayerState.PAUSED?(this.playing=!1,(yield this.getCurrentTime())>0&&(this.paused=!0),this.cbState&&this.cbState(null,"pause")):(e.data===YT.PlayerState.ENDED||e.data===YT.PlayerState.CUED)&&(this.loopRange&&this.reader.isLastPartPosition(this.loopRange.right)?(Q("received ended or cued event, but looping is on, so resume the track playback"),this.jumpTo(this.loopRange.left)):(Q("received ended event, stopping playback"),this.playing=!1,this.paused=!1,this.cbState&&this.cbState(null,"stop")))})}setAnchorList(e){this.originalAnchorList=e,this.isReady&&this.normalizeAnchorList()}normalizeAnchorList(){return new Promise(e=>{Q("normalize anchors list"),this.duration=this.duration||this.player.getDuration(),this.anchorList=this.reader.normalizeAnchorList(this.originalAnchorList,{totalTime:this.duration}),e()})}addBestAnchor(e){return new Promise(t=>{this.getCurrentTime().then(i=>{t(this.reader.addBestAnchor(this.anchorList,e,i))})})}addAnchor(e){return this.reader.addAnchor(this.anchorList,e.location,e.time)}isPlaying(){return this.playing}getDuration(){return ve(this,null,function*(){return yield this.ready(),this.duration=this.duration||this.player.getDuration(),this.duration})}getAvailablePlaybackSpeedList(){return ve(this,null,function*(){return yield this.ready(),[]})}getCurrentTime(){return ve(this,null,function*(){return yield this.ready(),this.currentTime=this.player&&this.player.getCurrentTime()||0,this.currentTime})}getTitle(){return ve(this,null,function*(){return yield this.ready(),this.player.getVideoData().title})}setCallbackState(e){this.cbState=e}start(e,t){return ve(this,null,function*(){t&&(this.cbState=t),yield this.ready(),typeof e!="undefined"&&!this.paused&&(yield this.jumpToMeasure(e)),Q("yt.playVideo()"),this.player.playVideo(),this.paused=!1,this.playing=!0})}pause(){return ve(this,null,function*(){yield this.ready(),this.playing&&(Q("yt.pauseVideo()"),this.player.pauseVideo(),this.paused=!0,this.playing=!1)})}stop(){return ve(this,null,function*(){yield this.ready(),Q("yt.stopVideo()"),this.player.pauseVideo(),this.player.seekTo(0),this.paused=!1,this.playing=!1})}getTimeFromLocation(e){return this.reader.findTimePosition(this.anchorList,e)}seekTo(e){return new Promise(t=>{this.ready().then(()=>{Q("seek to %s",e),this.player.seekTo(e,!0),t()})})}jumpTo(e){return ve(this,null,function*(){return yield this.ready(),this.jumpToSync(e)})}jumpToSync(e){const t=this.getTimeFromLocation(e);return Q("[jumpTo] seek to %s",t),this.player.seekTo(t,!0),t}loopInRange(e,t){return ve(this,null,function*(){return yield this.ready(),this.loopRange=t,e===null?this.jumpToSync(t.left)>=0:(e.noteIdx=e.currentNoteIdx,(0,pt.A)(this.reader.data,e,t.right)>0?this.jumpToSync(t.left)>=0:!1)})}disableLoop(){this.loopRange=null}jumpToMeasure(e){const t={measureIdx:e,noteIdx:0};return this.jumpTo(t)}getSliderLocation(e){let t,i=null,s=null;if(typeof e=="undefined"&&(this.player&&this.player.getCurrentTime?e=this.currentTime=this.player.getCurrentTime():e=this.currentTime=0),!this.anchorList||this.anchorList.length===0)return{timeFromNoteStart:0,timeFromMeasureStart:0,currentNoteIndex:0,currentNoteRealIdx:0,currentNoteDuration:1,currentVoiceId:0,currentMeasure:0,nextMeasure:null,quarterFromMeasureStart:0,quarterNotePos:0,isLastMeasureNote:!1};for(Q("slider ts %f",e),t=this.anchorIdx;t<this.anchorList.length&&(i=this.anchorList[t],!(i.time>e));t++)s=i;if(!s)return Q("before first anchor"),null;if(s===i)if(this.isReady&&this.loopRange&&this.reader.isLastPartPosition(this.loopRange.right)){Q("reached last anchor, but looping is on, so resume the track playback at loop start");const n=this.jumpToSync(this.loopRange.left);return this.getSliderLocation(n)}else return Q("after last anchor, ending track"),this.stop(),this.cbState&&this.cbState(null,"stop"),null;const r=this.reader.findLocationFromTimeInRange(s,i,e);return{timeFromMeasureStart:r.timeFromMeasureStart,timeFromNoteStart:r.timeFromNoteStart,currentNoteIndex:r.currentNoteIdx,currentNoteRealIdx:r.currentNoteRealIdx,currentNoteDuration:r.currentNoteDuration||1,currentVoiceId:r.currentVoiceId,currentMeasure:r.currentMeasure,nextMeasure:r.nextMeasure,quarterFromMeasureStart:r.quarterFromMeasureStart,quarterNotePos:r.quarterNotePos,isLastMeasureNote:r.isLastMeasureNote,measureUuid:r.measureUuid,partUuid:r.partUuid,voiceUuid:r.voiceUuid}}}typeof window.onYouTubeIframeAPIReady=="undefined"&&(window.onYouTubeIframeAPIReady=()=>{document.dispatchEvent(new Event("YTApiReady"))});const ws=Yn;var Ge=(o,e,t)=>new Promise((i,s)=>{var r=a=>{try{u(t.next(a))}catch(l){s(l)}},n=a=>{try{u(t.throw(a))}catch(l){s(l)}},u=a=>a.done?i(a.value):Promise.resolve(a.value).then(r,n);u((t=t.apply(o,e)).next())});const H=x("dacapo:sc");class Kn{constructor(e,t){this.reader=e,this.elementContainer=t.element,this.trackUrl=t.trackUrl,this.readyPromises=[],this.setAnchorList(t.anchorList||[]),this.anchorIdx=0,this.currentTime=0,this.playing=!1,this.paused=!1,this.stopping=!1,this.loopRange=null,this.loadIframeAPI().then(this.loadSound.bind(this)).then(this.normalizeAnchorList.bind(this)).then(()=>{H("ready"),this.isReady=!0,this.readyPromises.forEach(i=>{i()})})}ready(){return new Promise(e=>{this.isReady?e():this.readyPromises.push(e)})}loadIframeAPI(){return new Promise(e=>{if(typeof SC=="undefined"){H("loading soundcloud API");const t=document.createElement("script");t.src="https://w.soundcloud.com/player/api.js",t.onload=()=>{e()};const[i]=document.getElementsByTagName("script");i.parentNode.insertBefore(t,i)}else H("SC API already loaded"),e()})}loadSound(){return new Promise(e=>{const t=["auto_play=false","buying=false","liking=false","download=false","sharing=false","show_artwork=true","show_comments=false","show_playcount=false","show_user=true","hide_related=true","visual=false","start_track=0"];t.push(`url=${encodeURIComponent(this.trackUrl)}`);const i=`https://w.soundcloud.com/player/?${t.join("&")}`;typeof this.elementContainer=="string"&&(this.elementContainer=document.getElementById(this.elementContainer)),this.elementContainer.innerHTML="";const s=this.element=document.createElement("iframe");s.setAttribute("width","100%"),s.setAttribute("height","100%"),s.setAttribute("frameborder","no"),s.setAttribute("scrolling","no"),s.setAttribute("src",i),s.setAttribute("allow","autoplay"),this.elementContainer.appendChild(s),this.player=new SC.Widget(s),this.player.setVolume(100),this.player.bind(SC.Widget.Events.PLAY,()=>{H("event play"),this.playing=!0,this.paused=!1,this.currentTime<this.anchorList[0].time?(this.player.seekTo(this.anchorList[0].time*1e3),this.cbState&&setTimeout(()=>{this.cbState(null,"start")},500)):this.cbState&&this.cbState(null,"start")}),this.player.bind(SC.Widget.Events.PAUSE,()=>{H("event pause"),this.playing&&(this.paused=!0),this.playing=!1,this.cbState&&!this.stopping&&this.cbState(null,"pause"),this.stopping=!1}),this.player.bind(SC.Widget.Events.FINISH,()=>{H("event finish"),this.loopRange&&this.reader.isLastPartPosition(this.loopRange.right)?(H("received FINISH event, but looping is on, so resume the track playback"),this.jumpTo(this.loopRange.left),this.player.play()):(H("received FINISH event, stopping playback"),this.paused=!1,this.playing=!1,this.cbState&&this.cbState(null,"stop"))}),this.player.bind(SC.Widget.Events.PLAY_PROGRESS,r=>{this.currentTime=r.currentPosition/1e3}),this.player.bind(SC.Widget.Events.READY,()=>{e()})})}setAnchorList(e){this.originalAnchorList=e,this.isReady&&this.normalizeAnchorList()}normalizeAnchorList(){return new Promise(e=>{H("normalize anchors list"),this.player.getDuration(t=>{this.duration=t/1e3,this.anchorList=this.reader.normalizeAnchorList(this.originalAnchorList,{totalTime:this.duration}),e()})})}addBestAnchor(e){return new Promise(t=>{this.getCurrentTime().then(i=>{t(this.reader.addBestAnchor(this.anchorList,e,i))})})}addAnchor(e){return this.reader.addAnchor(this.anchorList,e.location,e.time)}isPlaying(){return this.playing}getDuration(){return new Promise(e=>{this.ready().then(()=>{this.player.getDuration(t=>{this.duration=t/1e3,e(this.duration)})})})}getCurrentTime(){return Ge(this,null,function*(){return yield this.ready(),this.currentTime})}getTitle(){return new Promise(e=>{this.ready().then(()=>{this.player.getCurrentSound(t=>{e(t.title)})})})}setCallbackState(e){this.cbState=e}start(e,t){return Ge(this,null,function*(){H("start soundcloud player"),t&&(this.cbState=t),yield this.ready(),H("soundcloud player ready"),yield this.getDuration(),typeof e!="undefined"&&!this.paused&&this.jumpToMeasure(e),this.paused=!1,this.playing=!0,H("sc.play()"),this.player.play()})}pause(){return Ge(this,null,function*(){yield this.ready(),this.playing&&(H("sc.pause()"),this.player.pause(),this.paused=!0,this.playing=!1)})}stop(){return Ge(this,null,function*(){yield this.ready(),H("sc.pause() (stop)"),this.stopping=!0,this.player.pause(),this.seekTo(0),this.paused=!1,this.playing=!1,this.cbState&&this.cbState(null,"stop")})}seekTo(e){return Ge(this,null,function*(){yield this.ready(),H("[seekTo] seek to %s",e),this.player.seekTo(e*1e3)})}getTimeFromLocation(e){return this.reader.findTimePosition(this.anchorList,e)}jumpTo(e){return Ge(this,null,function*(){return yield this.ready(),this.jumpToSync(e)})}jumpToSync(e){const t=this.getTimeFromLocation(e);return H("seek to %s",t),this.player.seekTo(t*1e3),t}loopInRange(e,t){return Ge(this,null,function*(){return yield this.ready(),this.loopRange=t,e===null?this.jumpToSync(t.left)>=0:(e.noteIdx=e.currentNoteIdx,(0,pt.A)(this.reader.data,e,t.right)>0?this.jumpToSync(t.left)>=0:!1)})}disableLoop(){this.loopRange=null}jumpToMeasure(e){const t={measureIdx:e,noteIdx:0};return this.jumpTo(t)}getSliderLocation(e){let t,i=null,s=null;for(typeof e=="undefined"&&(e=this.currentTime),H("slider ts %s",e),t=this.anchorIdx;t<this.anchorList.length&&(i=this.anchorList[t],!(i.time>e));t++)s=i;if(!s)return H("before first anchor"),null;if(s===i)if(this.isReady&&this.loopRange&&this.reader.isLastPartPosition(this.loopRange.right)){H("reached last anchor, but looping is on, so resume the track playback at loop start");const n=this.jumpToSync(this.loopRange.left);return this.getSliderLocation(n)}else return H("after last anchor, ending track"),this.stop(),this.cbState&&this.cbState(null,"stop"),null;const r=this.reader.findLocationFromTimeInRange(s,i,e);return{timeFromMeasureStart:r.timeFromMeasureStart,timeFromNoteStart:r.timeFromNoteStart,currentNoteIndex:r.currentNoteIdx,currentNoteRealIdx:r.currentNoteRealIdx,currentNoteDuration:r.currentNoteDuration||1,currentVoiceId:r.currentVoiceId,currentMeasure:r.currentMeasure,nextMeasure:r.nextMeasure,quarterFromMeasureStart:r.quarterFromMeasureStart,quarterNotePos:r.quarterNotePos,isLastMeasureNote:r.isLastMeasureNote,measureUuid:r.measureUuid,partUuid:r.partUuid,voiceUuid:r.voiceUuid}}}const As=Kn;var $e=(o,e,t)=>new Promise((i,s)=>{var r=a=>{try{u(t.next(a))}catch(l){s(l)}},n=a=>{try{u(t.throw(a))}catch(l){s(l)}},u=a=>a.done?i(a.value):Promise.resolve(a.value).then(r,n);u((t=t.apply(o,e)).next())});const Y=x("dacapo:vimeo");class Jn{constructor(e,t){this.reader=e,this.elementContainer=t.element,this.videoId=t.videoId,this.readyPromises=[],this.setAnchorList(t.anchorList||[]),this.anchorIdx=0,this.currentTime=0,this.playing=!1,this.paused=!1,this.loopRange=null,this.loadIframeAPI().then(this.loadSound.bind(this)).then(this.normalizeAnchorList.bind(this)).then(()=>{Y("ready"),this.isReady=!0,this.readyPromises.forEach(i=>{i()})})}ready(){return new Promise(e=>{this.isReady?e():this.readyPromises.push(e)})}loadIframeAPI(){return new Promise(e=>{if(typeof Vimeo=="undefined"){Y("loading vimeo API");const t=document.createElement("script");t.src="https://player.vimeo.com/api/player.js",t.onload=()=>{e()};const[i]=document.getElementsByTagName("script");i.parentNode.insertBefore(t,i)}else Y("Vimeo API already loaded"),e()})}loadSound(){return new Promise(e=>{typeof this.elementContainer=="string"&&(this.elementContainer=document.getElementById(this.elementContainer)),this.elementContainer.innerHTML="";const t=this.element=document.createElement("iframe");t.setAttribute("width","100%"),t.setAttribute("height","100%"),t.setAttribute("frameborder","no"),t.setAttribute("scrolling","no"),t.setAttribute("src",`https://player.vimeo.com/video/${this.videoId}`),t.setAttribute("allow","autoplay"),this.elementContainer.appendChild(t),this.player=new Vimeo.Player(this.elementContainer),this.player.ready().then(()=>{e()}),this.player.setVolume(1),this.player.on("play",()=>{Y("event play"),this.playing=!0,this.paused=!1,this.player.getCurrentTime().then(i=>{i<this.anchorList[0].time?this.player.setCurrentTime(this.anchorList[0].time).then(()=>{this.cbState&&this.cbState(null,"start")}):this.cbState&&this.cbState(null,"start")})}),this.player.on("pause",()=>{Y("event pause"),this.playing&&(this.paused=!0),this.playing=!1,this.cbState&&this.cbState(null,this.paused?"pause":"stop")}),this.player.on("ended",()=>{this.loopRange&&this.reader.isLastPartPosition(this.loopRange.right)?(Y("received ended event, but looping is on, so resume the track playback"),this.jumpTo(this.loopRange.left),this.player.play()):(Y("received ended event, stopping playback"),this.paused=!1,this.playing=!1,this.cbState&&this.cbState(null,"stop"))}),this.player.on("timeupdate",i=>{this.currentTime=i.seconds})})}setAnchorList(e){this.originalAnchorList=e,this.isReady&&this.normalizeAnchorList()}normalizeAnchorList(){return $e(this,null,function*(){Y("normalize anchors list");const e=yield this.player.getDuration();this.duration=e,this.anchorList=this.reader.normalizeAnchorList(this.originalAnchorList,{totalTime:this.duration})})}addBestAnchor(e){return $e(this,null,function*(){const t=yield this.getCurrentTime();return this.reader.addBestAnchor(this.anchorList,e,t)})}addAnchor(e){return this.reader.addAnchor(this.anchorList,e.location,e.time)}isPlaying(){return this.playing}getDuration(){return $e(this,null,function*(){return yield this.ready(),this.duration=this.duration||(yield this.player.getDuration()),this.duration})}getCurrentTime(){return $e(this,null,function*(){return yield this.ready(),yield this.player.getCurrentTime()})}getTitle(){return $e(this,null,function*(){return yield this.ready(),yield this.player.getVideoTitle()})}setCallbackState(e){this.cbState=e}start(e,t){return $e(this,null,function*(){t&&(this.cbState=t),yield this.ready(),yield this.getDuration(),typeof e!="undefined"&&!this.paused&&this.jumpToMeasure(e),this.paused=!1,this.playing=!0,Y("vimeo.play()"),this.player.play()})}pause(){this.ready().then(()=>{this.playing&&(Y("vimeo.pause()"),this.player.pause(),this.paused=!0,this.playing=!1)})}stop(){this.ready().then(()=>{Y("vimeo.pause() (stop)"),this.player.pause(),this.paused=!1,this.playing=!1})}seekTo(e){return new Promise((t,i)=>{this.ready().then(()=>{Y("seek to %s",e),this.player.setCurrentTime(e).then(()=>{t()}).catch(i)})})}getTimeFromLocation(e){return this.reader.findTimePosition(this.anchorList,e)}jumpTo(e){return $e(this,null,function*(){yield this.ready();const t=this.getTimeFromLocation(e);return Y("seek to %s",t),yield this.player.setCurrentTime(t),t})}jumpToSync(e){const t=this.getTimeFromLocation(e);return Y("[jumpTo] seek to %s",t),this.player.setCurrentTime(t),t}loopInRange(e,t){return $e(this,null,function*(){return yield this.ready(),this.loopRange=t,e===null?(yield this.jumpTo(t.left))>=0:(e.noteIdx=e.currentNoteIdx,(0,pt.A)(this.reader.data,e,t.right)>0?(yield this.jumpTo(t.left))>=0:!1)})}disableLoop(){this.loopRange=null}jumpToMeasure(e){const t={measureIdx:e,noteIdx:0};return this.jumpTo(t)}getSliderLocation(e){let t,i=null,s=null;for(typeof e=="undefined"&&(e=this.currentTime),Y("slider ts %s",e),t=this.anchorIdx;t<this.anchorList.length&&(i=this.anchorList[t],!(i.time>e));t++)s=i;if(!s)return Y("before first anchor"),null;if(s===i)if(this.isReady&&this.loopRange&&this.reader.isLastPartPosition(this.loopRange.right)){Y("reached last anchor, but looping is on, so resume the track playback at loop start");const n=this.jumpToSync(this.loopRange.left);return this.getSliderLocation(n)}else return Y("after last anchor, ending track"),this.stop(),null;const r=this.reader.findLocationFromTimeInRange(s,i,e);return{timeFromMeasureStart:r.timeFromMeasureStart,timeFromNoteStart:r.timeFromNoteStart,currentNoteIndex:r.currentNoteIdx,currentNoteRealIdx:r.currentNoteRealIdx,currentNoteDuration:r.currentNoteDuration||1,currentVoiceId:r.currentVoiceId,currentMeasure:r.currentMeasure,nextMeasure:r.nextMeasure,quarterFromMeasureStart:r.quarterFromMeasureStart,quarterNotePos:r.quarterNotePos,isLastMeasureNote:r.isLastMeasureNote,measureUuid:r.measureUuid,partUuid:r.partUuid,voiceUuid:r.voiceUuid}}}const Es=Jn;var Os=v(997512),Ei;(function(o){o[o.COUNT_IN=0]="COUNT_IN",o[o.CONTINUOUS=1]="CONTINUOUS",o[o.DISABLED=2]="DISABLED",o[o.CONTINUOUS_NO_COUNT_IN=3]="CONTINUOUS_NO_COUNT_IN"})(Ei||(Ei={}));const Ae=Ei;var te=v(445619),J=(o,e,t)=>new Promise((i,s)=>{var r=a=>{try{u(t.next(a))}catch(l){s(l)}},n=a=>{try{u(t.throw(a))}catch(l){s(l)}},u=a=>a.done?i(a.value):Promise.resolve(a.value).then(r,n);u((t=t.apply(o,e)).next())});const E=x("dacapo:transport"),Cs=x("dacapo:slider");class ks{constructor(e,t,i=!0){Object.defineProperty(this,"playing",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"paused",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"recordingMIDI",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"recordingAudio",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exporting",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"loopMode",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metronome",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"metronomeSolo",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"instrumentManager",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"reader",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"formerReader",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"scoreData",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"alternativePlayers",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"alternativePlayer",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"sliderMode",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"forceMetronome",{enumerable:!0,configurable:!0,writable:!0,value:!1}),Object.defineProperty(this,"audioRecorder",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"playbackOptions",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"timerID",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"stateCallback",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exportProgressCallback",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"exportSectionsDuration",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"scoreTotalDuration",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"maxStartTimePlayed",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lastStartSecondsRange",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"startRecordingTime",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"startPlaybackTime",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"startPlaybackTimeWithDelay",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"startTimePosition",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"pauseTime",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"startMeasureIdx",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"playbackSpeedRatio",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),Object.defineProperty(this,"lastPlaybackSpeedChange",{enumerable:!0,configurable:!0,writable:!0,value:void 0}),E("new Transport instance created"),this.playing=!1,this.paused=!1,this.recordingMIDI=!1,this.recordingAudio=!1,this.exporting=!1,this.loopMode=!1,this.reader=new Os.gk(e),this.scoreData=e,this.instrumentManager=t,this.alternativePlayers={},this.alternativePlayer=null,this.sliderMode=!1,this.audioRecorder=null,this.playbackOptions={},this.metronome=null,this.metronomeSolo=!1,i&&this.initMetronome(),this.startRecordingTime=0,this.startPlaybackTime=0,this.startPlaybackTimeWithDelay=0,this.startTimePosition=0,this.pauseTime=0,this.maxStartTimePlayed=-1,this.lastStartSecondsRange=0,this.exportProgressCallback=null,this.exportSectionsDuration=[],this.scoreTotalDuration=this.reader.getSecondsDuration(),this.startMeasureIdx=0,this.playbackSpeedRatio=1,this.lastPlaybackSpeedChange=null}setNewData(e){this.scoreData=e,this.reader=new Os.gk(e)}start(){return J(this,arguments,function*(e=0,t={forceClassicPlayback:!1}){if(E(`start playback at measure ${e}`),N.initialized||N.init(),yield this.resumeAudioContextIfSuspended(),this.playbackOptions.forceClassicPlayback=!!t.forceClassicPlayback,this.alternativePlayer&&!t.forceClassicPlayback)return this.alternativePlayer.start(e,this.stateCallback);if(!this.playing){if(this.playing=!0,this.paused)return E("playback currently paused , resuming..."),this.paused=!1,this.resumePlaybackLoop();this.startMeasureIdx=e,this.startTimePosition=this.reader.scoreMeasureIdxToSeconds(e),this.startPlaybackLoop()}})}pause(){if(E("pause playback"),this.alternativePlayer&&!this.playbackOptions.forceClassicPlayback){this.alternativePlayer.pause();return}if(!d.context||!this.playing&&!(this.metronome&&this.metronome.isSolo()))return;this.cleanWorker(),this.instrumentManager.stopAllScheduledNotes();const t=Le().currentTime;this.pauseTime=t-this.startPlaybackTimeWithDelay+this.startTimePosition,this.playing=!1,this.paused=!0}stop(){return J(this,null,function*(){if(E("stop playback"),!!d.context){if(this.alternativePlayer&&!this.playbackOptions.forceClassicPlayback){this.playing=!1,this.alternativePlayer.stop();return}!this.playing&&!this.paused||(this.paused=!1,this.playing&&(this.playing=!1,this.instrumentManager.stopAll(),E("cleaning worker"),yield this.cleanWorker(),this.stopMetronome()))}})}restart(){return J(this,null,function*(){if(!d.context)return Promise.reject();if(this.alternativePlayer){const e={partUuid:this.scoreData.getPartUuid(0),measureUuid:this.scoreData.getMeasureUuid(0),voiceUuid:this.scoreData.getPartVoiceUuid(0,0),noteIdx:0};return this.alternativePlayer.jumpTo(e)}this.paused=!1,this.instrumentManager.stopAll(),yield this.cleanWorker(),this.startPlaybackLoop()})}setStartPlaybackTime(e){this.startPlaybackTime=e,this.startPlaybackTimeWithDelay=e+G.LOADING_DELAY,E(`startPlaybackTime: ${this.startPlaybackTime}, startPlaybackTimeWithDelay: ${this.startPlaybackTimeWithDelay}`)}startPlaybackLoop(){const e=Le();this.sendStateUpdate(De.START),this.maxStartTimePlayed=-1,this.setStartPlaybackTime(e.currentTime),this.hasMetronomeCountIn()&&!this.sliderMode&&this.scheduleMetronomeCountdown(),(!this.sliderMode||this.forceMetronome)&&(E("starting loopSchedule recursive function"),this.loopSchedule(!0))}resumePlaybackLoop(){const e=Le();this.sendStateUpdate(De.START),this.startTimePosition=this.pauseTime,this.maxStartTimePlayed=this.startTimePosition,this.pauseTime=0,this.setStartPlaybackTime(e.currentTime),(!this.sliderMode||this.forceMetronome)&&(E("resuming calls to loopSchedule recursive function"),this.loopSchedule(!0))}loopSchedule(e){const t={getContinuedNotes:e,includeMetronome:!0,parts:null};this.forceMetronome&&(t.parts=new Map);const i=Le();let s=i.currentTime;const r=Math.max(s-this.startPlaybackTimeWithDelay,0),n=this.startTimePosition+r/this.playbackSpeedRatio,u={from:n,to:n+G.WINDOW_SIZE};E(`loopSchedule, calling score reader to schedule upcoming notes at currentTime ${s}...`);try{E(`getting notes in range ${u.from} - ${u.to} (Web Audio time: ${u.from+this.startPlaybackTimeWithDelay} - ${u.to+this.startPlaybackTimeWithDelay})`);let a=this.reader.getAudioNotesInRange(u,t);a.sort((l,h)=>l.startTime-h.startTime),a=a.filter(l=>l.startTime>this.maxStartTimePlayed),a.length>0&&(this.maxStartTimePlayed=a[a.length-1].startTime),this.convertAllNotesToWebAudioTimeWithPlaybackSpeed(a),this.instrumentManager.playAudioNotesInRange(a,e)}catch(a){this.sendAsyncError(a)}!this.loopMode&&this.isScoreEndReached()&&this.stopPlaybackLoop(),this.playing&&(s=i.currentTime,this.timerID=$.setTimeout(this.loopScheduleCallback,G.SCHEDULING_INTERVAL,this,[s]))}loopScheduleCallback(e){return J(this,null,function*(){const t=Le(),i=t.currentTime;if(i!==Number.POSITIVE_INFINITY){if(!this.playing&&!(this.metronome&&this.metronome.isSolo()))return;E(`loopScheduleCallback called at ${i}`),e>=i&&(typeof t.resume!="undefined"&&(yield d.resume()),t.state!==be.RUNNING&&Ns().catch(()=>{this.sendAsyncError(new ge({formerTime:e,currentTime:i,when:"playing",state:t.state}))})),this.loopSchedule(!1)}})}getSecondsFromScoreBeginning(){let e=d.context.currentTime-this.startPlaybackTimeWithDelay;return e=Math.max(e,0)/this.playbackSpeedRatio,this.startTimePosition+e}isScoreEndReached(){const e=this.getSecondsFromScoreBeginning(),t=this.reader.getSecondsDuration();return e>t+G.SCHEDULING_INTERVAL/1e3}stopPlaybackLoop(){this.playing=!1,this.sendStateUpdate(De.END),this.cleanWorker()}cleanWorker(){E(`cleaning worker timer... timerID: ${this.timerID}`);let e=Promise.resolve();return typeof this.timerID!="undefined"&&(e=new Promise(t=>{$.clearTimeout(this.timerID,()=>{t()})})),e}getSliderPosition(){if(this.alternativePlayer&&!this.playbackOptions.forceClassicPlayback){const p=this.alternativePlayer.getSliderLocation();return Cs("slider location: %O",p),p}const e=Le();let t=0;typeof e.outputLatency=="number"&&(t=e.outputLatency);let i=e.currentTime-this.startPlaybackTimeWithDelay-t;i=Math.max(i,0);let s=i/this.playbackSpeedRatio+this.startTimePosition;const r=this.reader.getSecondsDuration();s=Math.min(s,r),Cs(`[getPlayingHeadPosition] currentTime ${e.currentTime}, secondsFromScoreBeginning ${s}`);const n=this.reader.getPlayOrderQuarterMapping(),u=this.reader.getTimeMapping().secondsToQuarter(s),a=n.quarterToMeasureIdx(u),l=n.getRelativeQuarterPosition(a,u),h=this.reader.getPlayOrder(),c=h.audioToScoreMeasureIdx(a),m=a+1;let f=null;return m<h.getNbMeasures()&&(f=h.audioToScoreMeasureIdx(m)),{quarterFromMeasureStart:l,currentMeasure:c,nextMeasure:f}}enableSliderMode(e=!1){this.sliderMode=!0,this.forceMetronome=e}disableSliderMode(){this.sliderMode=!1,this.forceMetronome=!1}initMetronome(){d.context&&(this.metronome=new Pi)}setMetronome(e){this.metronome=e,this.instrumentManager.setMetronome(e)}getCurrentMetronomeMode(){return this.metronome?this.metronome.getMode():Ae.DISABLED}hasMetronomeCountIn(){const e=this.getCurrentMetronomeMode();return e===Ae.COUNT_IN||e===Ae.CONTINUOUS}isMetronomeContinuous(){const e=this.getCurrentMetronomeMode();return e===Ae.CONTINUOUS||e===Ae.CONTINUOUS_NO_COUNT_IN}setMetronomeMode(e){if(E(`setMetronomeMode(mode = ${e})`),!this.metronome)return;if(!Object.values(Ae).includes(e))throw new Error(`Tried to set unknown metronome mode: ${e}`);const t=this.metronome.getMode();if(e===t){E(`currentMode is already ${t}, no need to change mode`);return}E(`currentMode is ${t}, going to change to mode ${e}`),this.metronome.setMode(e),e===Ae.DISABLED||e===Ae.COUNT_IN&&this.playing?this.metronome.mute():(this.metronome.unmute(),this.metronome.switchOn()),E(`metronome status: mode = ${this.metronome.mode}, active = ${this.metronome.active}, gain = ${this.metronome.output.gain.value}`)}stopMetronomeSequence(){this.stopMetronome(),this.cleanWorker()}stopMetronome(){this.metronome&&this.metronome.cancelSequence()}scheduleMetronomeCountdown(e={}){if(!this.metronome)return;this.metronome.unmute();let t=1;e.sequenceOpts&&(t=e.sequenceOpts.sequences||1);const{duration:i,notes:s}=this.reader.getMetronomeCountdownAtScoreMeasure(e.timeSignatureMeasureIdx||this.startMeasureIdx||0);this.applyPlaybackSpeedToAudioNotes(s);const r=i*this.playbackSpeedRatio;let n=e.startTime||this.startPlaybackTimeWithDelay;for(let u=0;u<t;u++)this.metronome.scheduleCountdown(s,n),n+=r;this.setStartPlaybackTime(n-G.LOADING_DELAY),this.isMetronomeContinuous()&&this.metronome.switchOn()}getMetronomeCountdownInfo(e=0){const{duration:t,notes:i}=this.reader.getMetronomeCountdownAtScoreMeasure(e),s=i.length,r=t/s;return{clicks:s,unitDuration:r}}isMetronomeClickTime(){return(0,te.g)(d.context,"The audio context doesn't exists"),this.metronome?this.metronome.isClickTime():!1}startMetronomeSolo(){return J(this,arguments,function*(e={}){this.metronomeSolo=!0,(this.playing||this.paused)&&(yield this.stop()),this.loopMetronomeSolo(e)})}loopMetronomeSolo(e){if(!this.metronome){console.error("Metronome is not initialized"),this.stopMetronomeSolo();return}const t=e.startTime||0,{duration:i,notes:s}=this.reader.getMetronomeCountdownAtScoreMeasure(e.timeSignatureMeasureIdx||this.startMeasureIdx||0);this.metronome.scheduleCountdown(s,t),e.startTime=t+i,this.metronomeSolo&&(this.timerID=$.setTimeout(this.loopMetronomeSolo,(i-.2)*1e3,this,[e]))}stopMetronomeSolo(){return J(this,null,function*(){this.metronome&&(this.stopMetronome(),this.metronome.clearScheduledTicks(),yield this.cleanWorker(),this.metronomeSolo=!1)})}setStateCallback(e){this.stateCallback=e}sendStateUpdate(e){E(`sending state update: ${e}`),this.stateCallback&&this.stateCallback(null,e)}setGlobalPlaybackSpeed(e){if(E(`set global playback speed: ${e}`),e<=0||e>10)throw new Error(`Incorrect value: playback speed should greater than 0 and lower or equal to 10, current value [${e}]`);this.playing||this.paused||(this.playbackSpeedRatio=1/e,this.lastPlaybackSpeedChange={time:0,sliderPosition:this.getSliderPosition()},this.alternativePlayer&&"setPlaybackSpeed"in this.alternativePlayer&&this.alternativePlayer.setPlaybackSpeed(e))}getGlobalPlaybackSpeed(){return 1/this.playbackSpeedRatio}applyPlaybackSpeedToAudioNotes(e){for(const t of e)t.startTime*=this.playbackSpeedRatio,t.duration*=this.playbackSpeedRatio,t.automations&&Object.entries(t.automations).forEach(([i,s])=>{s.forEach(r=>{r.startTime*=this.playbackSpeedRatio,r.duration*=this.playbackSpeedRatio})})}convertAllNotesToWebAudioTimeWithPlaybackSpeed(e){for(const t of e)this.convertNoteToWebAudioTimeWithPlaybackSpeed(t)}convertNoteToWebAudioTimeWithPlaybackSpeed(e){e.startTime=this.convertTimeToWebAudioTime(e.startTime),e.duration*=this.playbackSpeedRatio,e.automations&&Object.entries(e.automations).forEach(([t,i])=>{i.forEach(s=>{s.startTime=this.convertTimeToWebAudioTime(s.startTime),s.duration*=this.playbackSpeedRatio})})}convertTimeToWebAudioTime(e){return e-=this.startTimePosition,e*=this.playbackSpeedRatio,e+=this.startPlaybackTimeWithDelay,e}setAltPlayer(e,t){this.alternativePlayers[e]=t}enableAltPlayer(e){if(this.playing&&this.stop(),!this.alternativePlayers[e])throw new Ht;this.alternativePlayer=this.alternativePlayers[e]}disableAltPlayer(){this.alternativePlayer&&(this.alternativePlayer.stop(),this.alternativePlayer=null)}trackIdIsCurrentlyUsed(e){return!!(this.alternativePlayer&&this.alternativePlayers[e]&&this.alternativePlayers[e]===this.alternativePlayer)}getAvailablePlaybackSpeedList(){return this.alternativePlayer?"getAvailablePlaybackSpeedList"in this.alternativePlayer?this.alternativePlayer.getAvailablePlaybackSpeedList():Promise.resolve([]):Promise.resolve(null)}getTrackAudioBuffer(){return this.alternativePlayer instanceof $t||this.alternativePlayer instanceof Lt?this.alternativePlayer.getAudioBuffer():null}initAudioRecorder(e,t,i){(0,te.g)(d.context,"The audio context doesn't exists"),this.audioRecorder=new vs(e,t,i)}startAudioListening(){return J(this,null,function*(){(0,te.g)(d.context,"The audio context doesn't exists"),(0,te.g)(this.audioRecorder,"Audio recorder is not initialized"),E("start audio listening"),yield this.audioRecorder.startListening()})}startAudioRecording(){return J(this,arguments,function*(e={}){if((0,te.g)(this.audioRecorder,"Audio recorder is not initialized"),this.recordingAudio)throw new Error("An audio recording is already ongoing");if(e.metronomeSequence){(0,te.g)(d.context,"The audio context doesn't exists");const i=Le().currentTime+.1;this.scheduleMetronomeCountdown({startTime:i,sequenceOpts:e.metronomeSequence})}this.startRecordingTime=this.startPlaybackTimeWithDelay,yield this.audioRecorder.startRecording(this.startRecordingTime),this.recordingAudio=!0})}stopAudioRecording(){if((0,te.g)(d.context,"The audio context doesn't exists"),(0,te.g)(this.audioRecorder,"Audio recorder is not initialized"),!this.recordingAudio)throw Error("No recording is currently ongoing");return this.recordingAudio=!1,this.audioRecorder.stopRecording()}resetAudioRecording(){this.recordingAudio=!1,this.audioRecorder&&this.audioRecorder.reset()}getRecordedArrayBuffer(){return(0,te.g)(this.audioRecorder,"Audio recorder is not initialized"),this.audioRecorder.getArrayBuffer()}getRecordedAudioBuffer(){return(0,te.g)(this.audioRecorder,"Audio recorder is not initialized"),this.audioRecorder.getAudioBuffer()}getAudioInputs(){return J(this,null,function*(){return(0,te.g)(this.audioRecorder,"Audio recorder is not initialized"),yield this.audioRecorder.listInputDevices()})}getAverageAudioInputPower(){return(0,te.g)(this.audioRecorder,"Audio recorder is not initialized"),this.audioRecorder.getAverageInputPower()}getAudioRecordingTime(){return(0,te.g)(this.audioRecorder,"Audio recorder is not initialized"),this.audioRecorder.getElapsedTime()}hasRecordingStarted(){return(0,te.g)(d.context,"The audio context doesn't exists"),this.recordingAudio&&d.context.currentTime>=this.startRecordingTime}MIDIExportLoop(){const e={getContinuedNotes:!1,includeMetronome:!1,omitNonLegatoGaps:!0,parts:null},t={from:this.lastStartSecondsRange,to:this.lastStartSecondsRange+G.WINDOW_SIZE};this.lastStartSecondsRange=t.to,E(`[MIDIExportLoop] getting notes in range ${t.from} - ${t.to}`),this.instrumentManager.updateExportMetaFromTime(t.from);const i=this.reader.getAudioNotesInRange(t,e);if(this.instrumentManager.exportAudioNotesInRange(i),t.to>=this.scoreTotalDuration){this.exporting=!1;return}this.MIDIExportLoop()}exportMIDI(){this.exporting=!0,this.scoreTotalDuration=this.reader.getSecondsDuration();const e=this.reader.getTimeMapping();this.instrumentManager.setTimeMapping(e),this.lastStartSecondsRange=0,this.startPlaybackTime=0,this.startTimePosition=0,this.MIDIExportLoop(),this.instrumentManager.finalizeMIDIExportAtTime(this.scoreTotalDuration)}renewOfflineContext(e){N.renewOfflineContext(e),E(`just renewed the offline context with a duration of ${e}s`),this.instrumentManager.renewWebAudioNodes(),this.instrumentManager.connectAllInstrumentsTo(ae.mainOutput)}initOrRenewContextForPreloading(e){d.context?this.renewOfflineContext(e):N.initOfflineContext(2,e*44100,44100)}preloadPartExport(e){return J(this,null,function*(){if(!d.context)throw new Error("Audio context is not available");this.initOrRenewContextForPreloading(.1),E(`preload part ${e}`),this.instrumentManager.enablePreloadMode(e),E("preload mode activated"),E(`launched part ${e} preloading, waiting for promises to resolve...`);const t=yield this.preloadSinglePartAndGetSectionsDurations(e);return this.instrumentManager.disablePreloadMode(e),E(`part ${e} finished preloading`),yield d.context.startRendering(),t})}getAudioNotesInPart(e,t){const i=this.scoreData.getPartUuid(e);E(`getAllAudioNotesInPart for part ${e} (uuid: ${i})`);const s={getContinuedNotes:!1,includeMetronome:!1,parts:new Map([[i,!0]])};t||(t={from:0,to:this.reader.getSecondsDuration()});let r=this.reader.getAudioNotesInRange(t,s);return r.sort((n,u)=>n.startTime-u.startTime),r=r.filter(n=>n.startTime>this.maxStartTimePlayed),r.length>0&&(this.maxStartTimePlayed=r[r.length-1].startTime),r}preloadSingleSectionAndGetFullDuration(e,t,i){return J(this,null,function*(){if(E(`[preload] part ${e}: going to preload section from ${i} to ${i+G.WINDOW_SIZE}`),t.length===0)return{maxEndingTime:0,maxDuration:0};const s=yield this.instrumentManager.playRandomBufferToInitReverbFirefox(e),r=yield this.instrumentManager.getMaxEndingTimeForNotes(t);E(`[preload] part ${e}: found maxEndingTime: ${r}`);const n=r-i;return E(`[preload] part ${e}: max duration ${n}`),n===0?(E(`[preload] part ${e}: measure has no notes playing, returning without reverb delay`),{maxEndingTime:r,maxDuration:n}):{maxEndingTime:r,maxDuration:n+s}})}createArrayOfWindowsAndPutAudioNotesIn(e){const t=[];if(e.length===0)return t;const i=e.reduce((r,n)=>n.startTime>r?n.startTime:r,Number.NEGATIVE_INFINITY),s=2;for(let r=0;r<=i;r+=G.WINDOW_SIZE){const n=e.filter(u=>u.startTime>=r&&u.startTime<r+s);t.push(n)}return t}preloadSinglePartAndGetSectionsDurations(e){return J(this,null,function*(){E(`preloadNextSectionInSinglePart for part ${e}`);let t=0;const i=[],s=[],r=this.getAudioNotesInPart(e),n=this.createArrayOfWindowsAndPutAudioNotesIn(r);for(const a of n){if(a.length===0)i.push(0),s.push(0);else{const{maxEndingTime:l,maxDuration:h}=yield this.preloadSingleSectionAndGetFullDuration(e,a,t);i.push(l),s.push(h)}t+=G.WINDOW_SIZE}const u=i.reduce((a,l)=>Math.max(a,l),Number.NEGATIVE_INFINITY);return{sectionsBuffersDurations:s,partFullDuration:u}})}setExportProgressCallback(e){this.exportProgressCallback=e}createPartBufferForExport(e){const s=Math.ceil(e*44100);return new AudioBuffer({sampleRate:44100,numberOfChannels:2,length:s})}exportSectionInSinglePart(e,t,i){return J(this,null,function*(){if(E(`exportSectionInSinglePart for part ${e}, range ${t.from} - ${t.to}`),!d.context)throw new Error("Audio context is not available");if(i.length>0){const s=yield this.instrumentManager.playRandomBufferToInitReverbFirefox(e);i.forEach(u=>this.instrumentManager.adaptAudioNoteTimesRelativeTo(u,t.from-s)),this.instrumentManager.exportAudioNotesInRange(i);let r=yield d.context.startRendering();E(`rendering done for part ${e}, range ${t.from} - ${t.to}, reverbDelay ${s}`);const n=s*r.sampleRate;return n>=r.length?null:(r=Se.slice(r,n),r=Se.trimRight(r),E(`buf length after trimming ${r.length}`),r)}return null})}exportSinglePartSections(e,t){return J(this,null,function*(){if(E(`exportSinglePartSections for ${e}`),!d.context)throw new Error("Audio context is not available");const i=t.partFullDuration,s=t.sectionsBuffersDurations,r=s.length,n=G.WINDOW_SIZE,u=this.createPartBufferForExport(i);let a=0,l=0;const h=this.getAudioNotesInPart(e),c=this.createArrayOfWindowsAndPutAudioNotesIn(h);for(;a<i&&l<s.length;){const m=s[l];if(m>0){d.context.state===be.CLOSED&&m&&this.renewOfflineContext(m);const p={from:a,to:a+n},M=c[l],w=yield this.exportSectionInSinglePart(e,p,M);if(w){const D=Math.round(a*44100);E(`sample offset ${D}`),Se.concatBuffers(u,w,D)}}const f=l/r;this.exportProgressCallback&&this.exportProgressCallback({partIdx:e,stage:"exporting",progress:f,time:Date.now()}),a+=n,l++}return this.exporting=!1,u})}exportPartSequenced(e,t){return J(this,null,function*(){return this.exporting=!0,this.exportProgressCallback&&this.exportProgressCallback({partIdx:e,stage:"scheduling",time:Date.now()}),this.maxStartTimePlayed=-1,yield this.exportSinglePartSections(e,t)})}buildAnchorList(){const e=[],t=this.reader.getTimeMapping(),i=this.reader.getPlayOrderQuarterMapping(),s=this.reader.getPlayOrder(),r=t.timeEntries,n=this.reader.getSecondsDuration(),u=s.getNbMeasures();for(let a=0;a<r.length;a++){const l=r[a],h=i.quarterToMeasureIdx(l.quarterPosition),c=h+1,m=s.audioToScoreMeasureIdx(h),f=this.scoreData.getMeasureUuid(m),p=c<u?s.audioToScoreMeasureIdx(c):null;e.push({type:"measure",measureIdx:m,nextMeasureIdx:p,voiceId:0,noteIdx:0,measureUuid:f,time:l.time})}return e.push({type:"end",time:n}),e}sendAsyncError(e){this.stateCallback&&this.stateCallback(e)}resumeAudioContextIfSuspended(){return J(this,null,function*(){Le().state!==be.RUNNING&&(E("audio context is not running, trying to resume..."),yield d.resume())})}getScoreDuration(){return this.reader.getSecondsDuration()}}function Le(){if(!d||!d.context)throw Error("The audio context doesn't exists");return d.context}if(!/^(32811|6275|9655)$/.test(v.j))var Xn=v(852922);const Zn=x("dacapo:midi:note");class Bt{constructor(e,t,i,s){this.pitch=e,this.velocity=t,this.timeOn=i,this.duration=s,this.timeOff=this.timeOn+this.duration,this.voice=0,this.tieStart=!1,this.tieStop=!1,this.noteTiedLeft=null,this.noteTiedRight=null,this.finalNoteName=null,this.noteNames={},this.possibleLines=[],typeof e!="undefined"&&this.setPossibleNoteNames()}copy(){let e;const t=new Bt(this.pitch,this.velocity,this.timeOn,this.duration),i=Object.keys(this.noteNames);for(t.voice=this.voice,t.tieStart=this.tieStart,t.tieStop=this.tieStop,t.noteTiedLeft=this.noteTiedLeft,t.noteTiedRight=this.noteTiedRight,t.finalNoteName=this.finalNoteName,t.noteNames={},e=0;e<i.length;e++)t.noteNames[i[e]]=this.noteNames[i[e]];for(e=0;e<this.possibleLines.length;e++)t.possibleLines[e]=this.possibleLines[e];return t}setPossibleNoteNames(){let e;for(let t=-1;t<=1&&(e=g.getKeyByValue(g.NoteName,this.pitch+t),typeof e!="undefined"&&(this.noteNames[e]=g.NoteStrToNoteObj(e,-t),this.possibleLines.push(e)),!(t===0&&this.possibleLines.length===2));t++);this.possibleLines.length===1?this.finalNoteName=this.noteNames[this.possibleLines[0]]:this.possibleLines.length>1&&this.noteNames[this.possibleLines[1]].alter===0&&this.possibleLines.reverse()}cut(e){const t=new Bt(void 0,this.velocity,e);return t.pitch=this.pitch,t.finalNoteName=this.finalNoteName,t.noteNames=this.noteNames,t.possibleLines=this.possibleLines,t.voice=this.voice,t.setTimeOff(this.timeOff),t.setTieStop(this),this.setTimeOff(e),this.setTieStart(t),t}setTimeOn(e){this.timeOn=e,typeof this.timeOff!="undefined"&&(this.duration=this.timeOff-this.timeOn)}setTimeOff(e){this.duration=e-this.timeOn,this.timeOff=this.timeOn+this.duration}setDuration(e){this.duration=e,this.timeOff=this.timeOn+this.duration}setVoice(e){this.voice=e}setTieStart(e){this.tieStart||(this.tieStart=!0,e&&(this.noteTiedRight=e))}setTieStop(e){this.tieStop||(this.tieStop=!0,e&&(this.noteTiedLeft=e))}removeTieStart(){this.tieStart&&(this.tieStart=!1,this.noteTiedRight&&(this.noteTiedRight.removeTieStop(),this.noteTiedRight=null))}removeTieStop(){this.tieStop&&(this.tieStop=!1,this.noteTiedLeft&&(this.noteTiedLeft.removeTieStop(),this.noteTiedLeft=null))}removeAllTies(){this.removeTieStart(),this.removeTieStop()}hasTie(){return this.tieStart||this.tieStop}hasTieStart(){return this.tieStart&&this.noteTiedRight}hasTieStop(){return this.tieStop&&this.noteTiedLeft}getTieArray(){const e=[];return this.tieStart&&e.push({$type:"start"}),this.tieStop&&e.push({$type:"stop"}),e}printNote(){Zn("timeOn:",this.timeOn,", duration:",this.duration,", timeOff:",this.timeOff,", pitch:",this.pitch,this.finalNoteName)}}const Rs=Bt,eo=x("dacapo:midi:chord");function We(o){this.timeOn=-1,this.timeOff=Number.POSITIVE_INFINITY,this.voice=o||0,this.notes=[],this.inTuplet=!1,this.tupletHead=!1,this.tupletInfo={},this.bar=-1,this.orig=null}We.prototype={copy(){let o;const e=new We(this.voice);for(e.timeOn=this.timeOn,e.timeOff=this.timeOff,e.notes=this.notes,e.inTuplet=this.inTuplet,e.tupletHead=this.tupletHead,e.tupletInfo={},e.bar=this.bar,o=0;o<this.notes.length;o++)e.notes[o]=this.notes[o].copy();if(this.tupletInfo){const t=Object.keys(this.tupletInfo);for(o=0;o<t.length;o++)e.tupletInfo[t[o]]=this.tupletInfo[t[o]]}return e},addNote(o){const e=this.getNoteIdxByPitch(o.pitch);return e>-1?(o.timeOff>this.notes[e].timeOff&&this.notes[e].setTimeOff(o.timeOff),!0):(this.timeOn<0&&(this.timeOn=o.timeOn),o.timeOff<this.timeOff&&(this.timeOff=o.timeOff),this.notes.push(o),!0)},preventChordOverlap(o,e){let t,i,s=null;for(t=0;t<this.notes.length;t++)i=this.notes[t].cut(o),i.duration>e?(s||(s=new We),s.addNote(i)):this.notes[t].removeTieStart();return this.timeOff=o,s},sortNotesByLength(){this.notes.sort((o,e)=>o.timeOff-e.timeOff)},assignPitches(){let o,e;const t=[];for(o=0;o<this.notes.length;o++)this.notes[o].finalNoteName!==null&&t.push(this.notes[o].possibleLines[0]);for(o=0;o<this.notes.length;o++)if(this.notes[o].finalNoteName===null){for(let i=0;i<2;i++)if(e=this.notes[o].possibleLines[i],t.indexOf(e)===-1){t.push(e),this.notes[o].finalNoteName=this.notes[o].noteNames[e];break}}this.epurChord()},epurChord(){for(let o=0;o<this.notes.length;o++)this.notes[o].finalNoteName===null&&(this.notes[o].removeAllTies(),this.notes.splice(o,1))},cutOverLengthNotes(){let o,e;if(this.notes.length>1)for(let t=0;t<this.notes.length;t++)this.notes[t].timeOff>this.timeOff&&(o=this.notes[t].cut(this.timeOff),typeof e=="undefined"&&(e=new We,e.voice=this.voice,this.inTuplet&&this.tupletInfo.timeOff>o.timeOn&&e.setTuplet(this.tupletInfo)),e.addNote(o));return e},mergeChord(o){if(this.inTuplet){const e=new At;o.tupletInfo=this.tupletInfo,o.quantizeChordTuplet(e)}for(let e=0;e<o.notes.length;e++)this.addNote(o.notes[e])},cutNotesAtTime(o){const e=new We;let t;for(let i=0;i<this.notes.length;i++)t=this.notes[i].cut(o),e.addNote(t);return this.timeOff=o,e},cutNotesAtLength(o){return this.cutNotesAtTime(this.timeOn+o)},setNotesOnAt(o){for(let e=0;e<this.notes.length;e++)this.notes[e].setTimeOn(o)},getNoteIdxByPitch(o){for(let e=0;e<this.notes.length;e++)if(this.notes[e].pitch===o)return e;return-1},getMinDuration(){let o,e=this.notes[0].duration;for(o=1;o<this.notes.length;o++)this.notes[o].duration<e&&(e=this.notes[o].duration);return e},hasANoteLongerOrEqualThan(o){for(let e=0;e<this.notes.length;e++)if(this.notes[e].duration>=o)return!0;return!1},setBar(o){this.bar=o},setTuplet(o){return this.inTuplet=!0,this.tupletInfo=o,!0},setTupletHead(){this.tupletHead=!0},removeTuplet(){this.inTuplet=!1,this.tupletInfo={},this.tupletHead=!1},quantizeChord(o){let e,t=Number.POSITIVE_INFINITY;for(e=0;e<this.notes.length;e++)o.quantizeNote(this.notes[e]),this.notes[e].timeOn<t&&(t=this.notes[e].timeOn);for(this.timeOn=t,this.timeOff=this.notes[0].timeOff,e=0;e<this.notes.length;e++)this.notes[e].setTimeOn(this.timeOn),this.notes[e].timeOn>=this.notes[e].timeOff?this.notes.splice(e--,1):this.notes[e].timeOff<this.timeOff&&(this.timeOff=this.notes[e].timeOff)},quantizeChordTuplet(o){let e,t;const i=this.tupletInfo.timeOff;let s=Number.POSITIVE_INFINITY,r;const n=new We(this.voice),u=o.getAdequateQuantForTuplet(this.tupletInfo.len,this.tupletInfo.type);if(this.tupletHead?e=this.tupletInfo.timeOn:e=o.quantizeNoteOn(this.timeOn,u),e>=i)return this.removeTuplet(),this.setNotesOnAt(e),this.quantizeChord(o,e),n;for(let a=0;a<this.notes.length;a++)this.notes[a].setTimeOn(e),t=o.quantizeNoteOff(e,this.notes[a].timeOff,u),this.notes[a].setTimeOff(t),t>i&&(r=this.notes[a].cut(i),n.addNote(r),i<s&&(s=i)),t<s&&(s=t);return this.timeOn=e,this.timeOff=s,n},printChord(){eo("-- CHORD: voice",this.voice,", timeOn",this.timeOn,", timeOff",this.timeOff,"bar",this.bar,"inTuplet",this.inTuplet);for(let o=0;o<this.notes.length;o++)this.notes[o].printNote()}};const Oi=We,to=x("dacapo:midi:bar");class yt{constructor(e,t,i,s){this.idx=e,this.timeStart=i||0,this.timeEnd=s||0,this.timeSig=t,this.chords=[],this.voiceMax=0,this.prevBar=null,this.nextBar=null}addChord(e){e.setBar(this.idx),this.chords.push(e)}addChordToTop(e){return e.setBar(this.idx),this.chords.length>0&&e.timeOn===this.chords[0].timeOn?this.chords[0].mergeChord(e):(this.chords.unshift(e),null)}setPrevBar(e){this.prevBar=e,e.nextBar=this}setNextBar(e){this.nextBar=e,e.prevBar=this}getChordsInRange(e,t){const i=[];for(let s=0;s<this.chords.length;s++)this.chords[s].timeOn>=e&&this.chords[s].timeOn<=t&&i.push(this.chords[s]);return i}hasChordsInVoice(e){for(let t=0;t<this.chords.length;t++)if(this.chords[t].voice===e)return!0;return!1}getFirstChordInVoice(e){for(let t=0;t<this.chords.length;t++)if(this.chords[t].voice===e)return this.chords[t];return this.nextBar?this.nextBar.getFirstChordInVoice(e):null}getChordsFromVoiceForTuplets(e){const t=[];for(let i=0;i<this.chords.length;i++)this.chords[i].voice===e&&t.push(this.chords[i]);return this.nextBar!==null&&this.nextBar.hasChordsInVoice(e)&&t.push(this.nextBar.getFirstChordInVoice(e)),t}quantizeChords(e){let t,i,s;for(t=0;t<this.chords.length;t++)this.chords[t].inTuplet?(i=this.chords[t].quantizeChordTuplet(e),i.notes.length>0&&this.placeNewChord(i,t)):this.chords[t].quantizeChord(e),s=this.getNextChordInVoice(t+1,this.chords[t].voice),this.chords[t].timeOn>=this.chords[t].timeOff||this.chords[t].notes.length===0?this.chords.splice(t--,1):!this.chords[t].inTuplet&&s&&s.inTuplet&&this.chords[t].timeOn===s.tupletInfo.timeOn&&(s.mergeChord(this.chords[t]),this.chords.splice(t--,1));for(t=this.chords.length-1;t>=0;t--)s=this.getNextChordInVoice(t+1,this.chords[t].voice),this.chords[t].timeOn>=this.timeEnd?(this.nextBar||(this.nextBar=new yt(this.idx+1,this.timeSig,this.timeEnd,this.timeEnd+(this.timeEnd-this.timeStart))),this.nextBar.addChordToTop(this.chords.splice(t,1)[0])):s&&s.timeOn===this.chords[t].timeOn&&(s.mergeChord(this.chords[t]),this.chords.splice(t,1))}getChordsByVoices(){let e;const t=[];for(e=0;e<this.chords.length;e++)typeof t[this.chords[e].voice]=="undefined"&&(t[this.chords[e].voice]=[]),t[this.chords[e].voice].push(this.chords[e]);return t}cutChords(){let e,t;for(e=0;e<this.chords.length;e++)t=this.chords[e].cutOverLengthNotes(),t&&(this.placeNewChord(t,e+1),this.chords[e].inTuplet&&t.timeOn<this.chords[e].tupletInfo.timeOff&&t.setTuplet(this.chords[e].tupletInfo));for(e=0;e<this.chords.length;e++)this.chords[e].timeOff>this.timeEnd&&(t=this.chords[e].cutNotesAtTime(this.timeEnd),this.nextBar||(this.nextBar=new yt(this.idx+1,this.timeSig,this.timeEnd,this.timeEnd+(this.timeEnd-this.timeStart))),this.nextBar.placeNewChord(t,0))}cutSuperimposedChords(){let e,t,i,s;for(e=0;e<this.chords.length;e++)s=this.getNextChordInVoice(e+1,this.chords[e].voice),t=this.chords[e].cutOverLengthNotes(),t&&s&&this.placeNewChord(t,e+1),this.chords[e].timeOff>this.timeEnd&&(t=this.chords[e].cutNotesAtTime(this.timeEnd),this.placeNewChord(t,e+1)),s&&this.chords[e].timeOff>s.timeOn&&(i=this.chords[e].cutNotesAtTime(s.timeOn),s.mergeChord(i)),this.chords[e].assignPitches()}placeNewChord(e,t){if(e.timeOn>=this.timeEnd){this.nextBar||(this.nextBar=new yt(this.idx+1,this.timeSig,this.timeEnd,this.timeEnd+(this.timeEnd-this.timeStart)),this.nextBar.prevBar=this),this.nextBar.placeNewChord(e,0);return}for(;t<this.chords.length&&(e.timeOn>this.chords[t].timeOn||this.chords[t].voice!==e.voice);)t++;const i=this.getPrevChordInVoice(t-1,e.voice);i&&i.inTuplet&&i.tupletInfo.timeOff>e.timeOn&&e.setTuplet(i.tupletInfo),t<this.chords.length&&e.timeOn===this.chords[t].timeOn&&this.chords[t].voice===e.voice?this.chords[t].mergeChord(e):(e.setBar(this.idx),this.chords.splice(t,0,e))}getPrevChordInVoice(e,t){for(;e>=0;e--)if(this.chords[e].voice===t)return this.chords[e];return null}getNextChordInVoice(e,t){for(;e<this.chords.length;e++)if(this.chords[e].voice===t)return this.chords[e];return this.nextBar?this.nextBar.getFirstChordInVoice(t):null}printBar(){let e;for(to("---- BAR index:",this.idx,"tickStart:",this.timeStart,", tickEnd:",this.timeEnd),e=0;e<this.chords.length;e++)this.chords[e].printChord()}}const Ci=yt,{ChannelEvent:ki}=Te,bt=x("dacapo:midi:part");class io{constructor(e,t,i){this.channel=e,this.drumPart=!1,e===9&&(this.drumPart=!0),this.metaPart=i,this.transpose=0,this.ticksPerBeat=t||480,this.minDuration=t/4,this.quantizer=new At,this.incompleteNotes={},this.lastNoteStop={},this.lastFullNote=null,this.notes=[],this.chords=[],this.bars=[],this.tuplets=[],this.staves=1,this.noteRange={max:0,min:128},this.chordThreshold=.04,this.instrumentId=1,this.lastAbsoluteTime=0,this.humanDelay=.2}addEvent(e,t){let i;const r=60/this.metaPart.getEventsAt(0).tempo,n=this.humanDelay/r*this.ticksPerBeat>>0;if(t=t/r*this.ticksPerBeat>>0,e.type===ki.TYPE.NOTE_ON&&e.velocity>0){if(this.incompleteNotes[e.note]===void 0){if(i=new Rs(e.note+this.transpose,e.velocity,t),this.lastFullNote&&(this.lastFullNote.pitch===i.pitch&&t-this.lastFullNote.timeOff<n+(n*.3>>0)?this.lastFullNote.setTimeOff(t-1):this.lastFullNote.pitch!==i.pitch&&t-this.lastFullNote.timeOff<n*.3>>0&&this.lastFullNote.setTimeOff(t-1)),i.possibleLines.length===0)return;this.notes.push(i),this.incompleteNotes[e.note]=i}}else(e.type===ki.TYPE.NOTE_ON||e.type===ki.TYPE.NOTE_OFF)&&this.incompleteNotes[e.note]!==void 0&&(i=this.incompleteNotes[e.note],i.setTimeOff(t),this.lastFullNote=i,delete this.incompleteNotes[e.note],this.updateStavesCount(e.note));this.lastAbsoluteTime=t}removeIncompleteNotes(){let e;for(let t=this.notes.length-1;t>=0&&Object.keys(this.incompleteNotes).length>0;t--)({pitch:e}=this.notes[t]),typeof this.incompleteNotes[e]!="undefined"&&(this.notes.splice(t,1),delete this.incompleteNotes[e])}prepareNewTrack(){this.incompleteNote={}}sortNotes(){this.notes.sort((e,t)=>e.timeOn-t.timeOn)}sortChords(){for(let e=0;e<this.staves;e++)this.chords[e].sort((t,i)=>t.timeOn-i.timeOn)}quantizeNotes(){for(let e=0;e<this.notes.length;e++)this.quantizer.quantizeNote(this.notes[e])}gatherObviousChords(){let e,t=0;const i=[-1,-1,-1],s=[];let r=this.metaPart.getEventsAt(0),{timeSig:n}=r,u=this.chordThreshold/(60/r.tempo)*this.ticksPerBeat>>0,a=0,l=n.beats*4/n.beatType*this.ticksPerBeat,h=0,c=new Ci(h,n,a,l),m;for(this.initChordsArray(),e=0;e<this.notes.length;e++){if(this.staves>1&&(this.assignVoice(this.notes[e]),{voice:t}=this.notes[e]),this.notes[e].timeOn>=l)for(;l<=this.notes[e].timeOn;)this.bars.push(c),h++,r=this.metaPart.getEventsAt(l),{timeSig:n}=r,u=this.chordThreshold/(60/r.tempo)*this.ticksPerBeat>>0,a=l,l+=n.beats*4/n.beatType*this.ticksPerBeat,m=new Ci(h,n,a,l),m.setPrevBar(c),c=m;(typeof s[t]=="undefined"||this.notes[e].timeOn>s[t].timeOn+u)&&(typeof s[t]!="undefined"&&this.chords[t].push(s[t]),s[t]=new Oi(t),c.addChord(s[t])),s[t].addNote(this.notes[e]),i[t]=this.notes[e].timeOn}this.bars.push(c)}correctHumanMistakes(){let e,t,i,s,r,n,u;for(e=0;e<this.chords.length;e++)for(r=this.chords[e],t=0;t<r.length;t++)n=r[t],i&&(u=i.timeOff-n.timeOn,u>0&&u<this.minDuration&&(s=i.preventChordOverlap(n.timeOn,this.minDuration),s&&n.mergeChord(s))),i=n}assignBars(){let e,t,i=0,s=this.metaPart.getTimeSignatureAt(0),r=s.beats*4/s.beatType*this.ticksPerBeat;for(t=0;t<this.chords.length;t++)for(e=0;e<this.chords[t].length;e++)this.chords[e].noteOn>r&&(i++,s=this.metaPart.getTimeSignatureAt(this.chords[e].noteOn),r=s.beats*4/s.beatType*this.ticksPerBeat),this.chords[e].setBar(i)}findTupletsInPart(){let e;for(e=0;e<this.chords.length;e++)this.findTupletsInVoice(e)}findTupletsInVoice(e){let t;for(t=0;t<this.bars.length;t++)this.setTupletsInBar(this.bars[t].getChordsFromVoiceForTuplets(e),this.bars[t].timeStart,this.bars[t].timeSig)}findTupletsInMeasure(e,t,i){let s,r,n,u,a;if(e.length>0){for(r=e[0].timeOn,a=this.getAllowedTupletsType(r,i),i=new W(i.beats,i.beatType),s=0;s<a.length;s++)u=this.isAllowedTuplet(a[s],i,e,t),typeof u!="undefined"&&this.isBestTupletForChords(u,n)&&(n=u);typeof bestTuplet!="undefined"&&this.setTupletInChords(n)}}setTupletsInBar(e,t,i){let s,r,n,u,a=[];if(e.length>0){for(r=e[0].timeOn,n=this.getAllowedTupletsType(r,i),i=new W(i.beats,i.beatType),u=this.getDivisionsOfBar(i),s=0;s<u.length;s++)a=a.concat(this.getTupletInfosForLen(t,u[s],i,e,n));this.setTupletFromArrayInfo(a)}}setTupletFromArrayInfo(e){let t,i;for(t=0;t<e.length-1;t++)if(e[t])for(i=t+1;i<e.length&&!(e[i]&&this.haveCommonChords(e[t],e[i])&&this.keepBestTuplet(e,t,i)===t);i++);for(this.epurInfoArr(e),t=0;t<e.length;t++)this.setTupletInChords(e[t])}haveCommonChords(e,t){let i,s;for(i=0;i<e.chordsInRange.length;i++)for(s=0;s<t.chordsInRange.length;s++)if(e.chordsInRange[i]===t.chordsInRange[s])return!0;return!1}keepBestTuplet(e,t,i){let s=0;const r=e[t].chords.length,n=e[i].chords.length,u=r-n,a=e[i].tupletSumError-e[t].tupletSumError;return u!==0&&(s+=u/Math.abs(u)),a!==0&&(s+=a/Math.abs(a)),s<0?(e[t]=null,t):s>0||e[t].len>e[i].len?(e[i]=null,i):(e[t]=null,t)}epurInfoArr(e){let t;for(t=0;t<e.length;)e[t]===null?e.splice(t,1):t++}isAllowedTuplet(e,t,i,s){const r=this.getDivisionsOfBar(t),n=t.num*4/t.den*this.ticksPerBeat;let u,a,l,h,c,m,f;const p=[];let M,w;for(M=0;M<r.length;M++)for(u=r[M],a=t.copy().div(u).value(),w=0;w<a;w++)if(l=s+w*u.value()*n,h=s+(w+1)*u.value()*n,f=this.extractChordsInRange(l,h,i),f.length>0)if(this.tupletIsAllowedInRange(u,e.type,f))c=this.getTupletInfo(f,e,u,l),this.confirmTupletFromInfo(c,e)&&this.isBestTupletForChords(c,m)&&(m=c,p.push(c));else return m;return m}getTupletInfosForLen(e,t,i,s,r){let n,u,a,l;const h=i.copy().div(t).value()>>0;let c;const m=[];for(n=0;n<h;n++)a=e+n*t.toTicks(this.ticksPerBeat),l=e+(n+1)*t.toTicks(this.ticksPerBeat),u=this.extractChordsInRange(a,l,s),u.length>0&&(c=this.getTupletInfoForDiv(t,a,u,r),c&&m.push(c));return m}getTupletInfoForDiv(e,t,i,s){let r,n,u;if(i.length===0)return null;for(r=0;r<s.length;r++)this.tupletIsAllowedInRange(e,s[r].type,i)&&(n=this.getTupletInfo(i,s[r],e,t),this.confirmTupletFromInfo(n,s[r])&&this.isBestTupletForChords(n,u)&&(u=n));return u}isBestTupletForChords(e,t){let i,s;if(typeof t=="undefined")return!0;for(let r=0;r<e.chords.length;r++)if(e.chords[r].inTuplet&&(t.chords.length<e.chords.length||(i=e.tupletSumError-e.regularSumError,s=t.tupletSumError-t.regularSumError,s<i)))return!1;return!0}setTupletInChords(e){if(typeof e!="undefined")for(let t=0;t<e.chordsInRange.length;t++)e.chordsInRange[t].setTuplet(e),t===0&&e.chordsInRange[t].setTupletHead()}confirmTupletFromInfo(e,t){let i,s,r,n;const u=t.minChords;if(e.chords.length===1&&e.type===3&&e.index===0){for([s]=e.chords,i=0;i<s.notes.length;i++)if(Math.abs(s.notes[i].duration-e.noteLen)>e.noteLen/2>>0)return!1}if(e.chords.length<u||e.tupletSumError>=e.regularSumError||e.chords[0].timeOn!==e.timeOn&&(r=this.quantizer.getAdequateQuantForTuplet(e.len,e.type),n=this.quantizer.quantizeNoteOn(e.chords[0].timeOn,r),n!==e.timeOn))return!1;for(i=0;i<e.chords.length;i++)if(e.chords[i].hasANoteLongerOrEqualThan(e.noteLen/2>>0))return!0;return!1}getQuantErrorOnTimes(e){const t=e.getMinDuration(),i=W.fromTicks(t,this.ticksPerBeat),s=this.quantizer.getAdequateQuantForLength(i),r=W.fromTicks(e.timeOn,this.ticksPerBeat),n=this.quantizer.quantizeNoteOn(r,s);return Math.abs(e.timeOn-n.toTicks(this.ticksPerBeat))}getTupletInfo(e,t,i,s){let r,n,u=0;const l=i.copy().toTicks(this.ticksPerBeat)/t.type,h={type:t.type,len:i,ratio:t.ratio,index:0,noteLen:l,tupletSumError:0,regularSumError:0,chords:[],chordsInRange:e,timeOn:s,timeOff:s+t.type*l},c=[],m=[];let f,p,M,w;for(r=0;r<t.type;r++)for(f=s+l*r,n=0;n<e.length;n++)if(e[n].timeOn>=f-l/2)if(e[n].timeOn<=f+l/2)p=Math.abs(e[n].timeOn-f),M=this.getQuantErrorOnTimes(e[n]),w=p-M,c.push({index:r,tupletError:p,regularError:M,diff:w,chord:e[n],qTimeOn:f});else break;for(r=0;r<c.length&&u+c[r].diff<=0;r++)m.indexOf(c[r].index)&&(u+=c[r].diff,h.chords.push(c[r].chord),h.tupletSumError+=c[r].tupletError,h.regularSumError+=c[r].regularError,r===0&&(h.index=c[r].index),m.push(c[r].index));return h}extractChordsInRange(e,t,i){const s=[];for(let r=0;r<i.length;r++)i[r].timeOn>=e&&i[r].timeOn<t&&s.push(i[r]);return s}shortestQuantizedNoteInRange(e){let t,i=this.ticksPerBeat,s=e[0].getMinDuration();const{minAllowedDuration:r}=this.quantizer;for(t=1;t<e.length;t++)s=e[t].getMinDuration();for(;i>r;){if(i<=s)return i;i/=2}return i}findQuantForRange(e){const t=this.shortestQuantizedNoteInRange(e);return this.quantizer.getAdequateQuantForLength(W.fromTicks(t,this.ticksPerBeat))}tupletIsAllowedInRange(e,t,i){const s=e.copy().div(t),r=this.findQuantForRange(i);return s.toTicks(this.ticksPerBeat)%1>0?!1:s.value()>=r.value()}getDivisionsOfBar(e){let t=0;const i=[];for(i.push(e.copy()),e.num===2||e.num===6||e.num%4===0?i.push(i[t++].copy().div(2)):e.num%3===0&&e.num>3?i.push(i[t++].copy().div(3)):e.num%5===0?i.push(i[t++].copy().div(5)):e.num%7===0?i.push(i[t++].copy().div(7)):i.push(i[t++].copy().div(e.num));i[t].value()>=this.quantizer.minAllowedDuration.value()*2;)i.push(i[t++].copy().div(2));return i}getAllowedTupletsType(e,t=this.metaPart.getTimeSignatureAt(e)){return Te.TimeSignature.isCompound(t)?[]:[{type:3,ratio:new W(3,2),minChords:2},{type:5,ratio:new W(5,4),minChords:4},{type:6,ratio:new W(6,4),minChords:4}]}quantizeNotesAndGatherChords(){let e,t=0;const i=[-1,-1,-1],s=[];for(this.initChordsArray(),e=0;e<this.notes.length;e++)this.quantizer.quantizeNote(this.notes[e]),this.staves>1&&(this.assignVoice(this.notes[e]),{voice:t}=this.notes[e]),this.notes[e].timeOn!==i[t]&&(typeof s[t]!="undefined"&&this.chords[t].push(s[t]),s[t]=new Oi(t)),s[t].addNote(this.notes[e]),i[t]=this.notes[e].timeOn;for(e=0;e<this.staves;e++)s[e]&&this.chords[e].push(s[e])}quantizeChordsInBars(){let e;for(e=0;e<this.bars.length;e++)this.bars[e].quantizeChords(this.quantizer);this.addNewBars()}assignVoice(e){e.pitch<58&&this.staves>1&&e.setVoice(1)}initChordsArray(){for(let e=0;e<this.staves;e++)this.chords[e]=[]}cutChords(){let e;for(let t=0;t<this.chords.length;t++)for(let i=0;i<this.chords[t].length;i++)e=this.chords[t][i].cutOverLengthNotes(),e&&this.chords[t][i+1]&&(this.chords[t][i+1].timeOn===e.timeOn?this.chords[t][i+1].mergeChord(e):e.timeOn<this.chords[t][i+1].timeOn?this.chords[t].splice(i+1,0,e):this.placeNewChord(e,i+1,t))}cutChordsInBars(){let e;for(e=0;e<this.bars.length;e++)this.bars[e].cutChords();this.addNewBars()}cutSuperimposedChords(){let e,t,i;for(let s=0;s<this.chords.length;s++)for(let r=0;r<this.chords[s].length;r++)i=this.chords[s][r+1],e=this.chords[s][r].cutOverLengthNotes(),e&&i&&(i.timeOn===e.timeOn?i.mergeChord(e):e.timeOn<i.timeOn?this.chords[s].splice(r+1,0,e):this.placeNewChord(e,r+1,s)),i&&this.chords[s][r].timeOff>i.timeOn&&(t=this.chords[s][r].cutNotesAtTime(i.timeOn),i.mergeChord(t)),this.chords[s][r].assignPitches()}cutSuperimposedChordsInBars(){let e;for(e=0;e<this.bars.length;e++)this.bars[e].cutSuperimposedChords();this.addNewBars()}addNewBars(){let e;for(e=this.bars.length-1;e<this.bars.length;e++)this.bars[e].nextBar&&this.bars.push(this.bars[e].nextBar)}placeNewChord(e,t,i){for(;t<this.chords[i].length&&e.timeOn>this.chords[i][t].timeOn;)t++;t<this.chords[i].length&&e.timeOn===this.chords[i][t].timeOn?this.chords[i][t].mergeChord(e):this.chords[i].splice(t,0,e)}getChordsForMeasure(e){let t,i;const s=[];for(let r=0;r<this.staves;r++)if(this.chords[r])for(s[r]=[];this.chords[r][0]&&this.chords[r][0].timeOn<e;)t=this.chords[r].shift(),t.timeOff>e&&(i=t.cutNotesAtTime(e),this.chords[r].unshift(i)),s[r].push(t);return s}getBar(e){return typeof this.bars[e]!="undefined"?this.bars[e]:null}hasChordsLeft(){for(let e=0;e<this.staves;e++)if(this.chords[e]&&this.chords[e].length>0)return!0;return!1}getPartProperties(e){const t={};return this.isDrumPart()?(t.name=this.getPartName(),t.instrumentsList=Te.Drumset.instruments,t.pitchMapping=Te.Drumset.mapping):(t.partName=this.getPartName(),t.instrumentName=this.getInstrumentName(),t.MIDIProgram=this.getInstrumentId(),t.staves=this.getStaves(e)),t}updateStavesCount(e){e>this.noteRange.max&&(this.noteRange.max=e),e<this.noteRange.min&&(this.noteRange.min=e),!this.drumPart&&(this.staves=Math.floor((this.noteRange.max-this.noteRange.min)/30)+1,this.staves>2&&(this.staves=2))}setInstrumentId(e){this.instrumentId=e+1,this.isDrumPart()||this.setTransposition(Te.getInstrumentTranspo(e))}setInstrumentName(e){this.instrumentName=e.replace(/(^| )(\w)/g,t=>t.toUpperCase()),this.partName===void 0&&(this.partName=this.instrumentName)}getInstrumentId(){return this.instrumentId}getPartName(){return this.partName!==void 0?this.partName:this.instrumentName}getInstrumentName(){return this.instrumentName!==void 0?this.instrumentName:this.isDrumPart()?"Drumset":"Grand Piano"}setTransposition(e){this.transpose=e}getStaves(e){let t;const i=[],s=this.computeClefs();for(let r=0;r<this.staves;r++)t={},t.clef={sign:s[r]},s[r]==="F"&&this.noteRange.min<24&&(t.clef["clef-octave-change"]=-1),t.concertKey={fifths:e.fifths||0},t.transpose={chromatic:0,diatonic:0},i.push(t);return i}computeClefs(){return this.staves>1?["G","F"]:this.staves===1&&this.noteRange.min>50?["G"]:this.staves===1&&this.noteRange.max<58?["F"]:["G"]}isDrumPart(){return this.drumPart}hasNotes(){return this.notes.length>0}setHumanDelay(e){this.humanDelay=e}printNotes(){for(let e=0;e<this.notes.length;e++)this.notes[e].printNote()}printChords(){bt("ID",this.getInstrumentId(),"NAME",this.getPartName()),bt("NOTERANGE",this.noteRange);for(let e=0;e<this.chords.length;e++){bt("---------------------------------VOICE",e);for(let t=0;t<this.chords[e].length;t++)this.chords[e][t].printChord()}}printBars(){bt("ID",this.getInstrumentId(),"NAME",this.getPartName());for(let e=0;e<this.bars.length;e++)this.bars[e].printBar()}printBar(e){bt("ID",this.getInstrumentId(),"NAME",this.getPartName()),this.bars[e].printBar()}}const _s=io,so={Note:Rs,Chord:Oi,Bar:Ci,Part:_s},ro=x("dacapo:midi:metapart");class no{constructor(e,t){this.events=e,this.innerTicks=t||480,this.barIndex=0,this.currentMeta={},this.currentIndex=0,this.currentTicks=0}getEventsAt(e){let t,i,s;for(e<this.currentTicks?(t=0,this.currentTicks=0):t=this.currentIndex;t<this.events.length;t++){if(i=this.events[t],this.currentMeta=i,this.currentTicks>=e)return this.currentIndex=t,this.getMetaCopy(i);s=i.beats*4/i.beatType*this.innerTicks,this.currentTicks+=s}return this.getMetaCopy(i)}getMetaCopy(e){return{timeSig:{beats:e.beats,beatType:e.beatType},tempo:e.tempo}}getTimeSignatureAt(e){return this.getEventsAt(e).timeSig}getTempoAt(e){return this.getEventsAt(e).tempo}setMetaArray(e){this.events=e,this.currentIndex=0,this.currentTicks=0}printMetaPart(){ro("Meta Part")}}const Vs=no;class oo{constructor(e){this.innerTicks=Te.INNER_TICKS_PER_QUARTER_NOTE,this.metaMap={},this.setMetaMap(e),this.midiPart=new _s(0,this.innerTicks,this.metaMap),this.drumPart=!1,this.dataStaff={},this.selectedVoice=0,this.humanDelayBase=.02,this.tempo=120,this.timeSignature={beats:4,beatType:4},this.initDataStaff(this.drumPart)}initDataStaff(e){this.dataStaff={notes:[],ties:[],slurs:[],isUnpitched:e,attributes:this.createDefaultAttributes()}}processPart(e,t){let i,s,r;for(this.midiPart.setHumanDelay(this.humanDelayBase),i=0;i<t.length;i++)s=t[i],r=s.time-e,this.midiPart.addEvent({type:s.type>>4,note:s.data1,velocity:s.data2},r);return this.midiPart.removeIncompleteNotes(),this.midiPart.sortNotes(),this.midiPart.prepareNewTrack(),this.quantizePart(this.midiPart),this.buildPart(),this.dataStaff}quantizePart(e){e.gatherObviousChords(),e.correctHumanMistakes(),e.findTupletsInPart(),e.quantizeChordsInBars(),e.cutChordsInBars(),e.cutSuperimposedChordsInBars()}buildPart(){let e,t=!1,i=0,s=0,r,n=this.timeSignature.beats*this.innerTicks*4/this.timeSignature.beatType;for(r=n,i=0;!t;r+=n,i++)t=this.buildMeasure(i),s=r,e=this.metaMap.getEventsAt(s),n=e.timeSig.beats*this.innerTicks*4/e.timeSig.beatType}buildMeasure(e){let t,i,s=!0;const r=this.midiPart.getBar(e);if(r){for(i=r.getChordsByVoices(),t=0;t<i.length;t++)i[t]&&i[t].length>0?(this.selectedVoice=t,this.buildVoice(i[t],e,r.timeStart,r.timeEnd)):this.addRest(r.timeEnd-r.timeStart);t===0&&this.addRest(r.timeEnd-r.timeStart),s=!1}return s}buildVoice(e,t,i,s){let r=i,n,u;for(u=0;u<e.length;u++)e[u].timeOn>r&&(u>0&&e[u-1].inTuplet?(n=e[u-1],e[u].inTuplet&&e[u].tupletInfo===e[u-1].tupletInfo?this.addRest(e[u].timeOn-r,e[u].tupletInfo):n.tupletInfo.timeOff>n.timeOff&&(this.addRest(n.tupletInfo.timeOff-n.timeOff,n.tupletInfo),e[u].timeOn>n.tupletInfo.timeOff&&this.addRest(e[u].timeOn-n.tupletInfo.timeOff))):this.addRest(e[u].timeOn-r)),r=e[u].timeOff,e[u].inTuplet&&e[u].tupletHead?this.buildTuplet(e[u]):e[u].timeOff>e[u].timeOn&&this.buildChord(e[u]);r<s&&this.addRest(s-r)}addRest(e,t){let i,s=e/this.innerTicks;t&&(i=_t.default.create(t.ratio.num,t.ratio.den),s=K.default.actualToNormal(s,i));const r=this.getDurationArray(s);for(let n=0;n<r.length;n++)r[n].isRest=!0,this.dataStaff.notes.push(r[n])}buildTuplet(e){let i=(e.timeOff-e.timeOn)/this.innerTicks;const s=e.tupletInfo,u=s.len.toTicks(this.innerTicks)/this.innerTicks/s.ratio.den,a=K.default.quarterToDurationOpts(u),l=_t.default.create(s.ratio.num,s.ratio.den);i=K.default.actualToNormal(i,l);const h=K.default.quarterToDurationOpts(i),c={tuplet:{durationType:a.durationType,timeModif:l},durationType:h.durationType,nbDots:h.nbDots,heads:[]};this.drumPart?this.buildNotesDrums(e.notes,c):this.buildNotes(e.notes,c)}buildChord(e){let t,i,s,r,n=e.timeOff-e.timeOn,u=n/this.innerTicks,a=[e];const l=e.tupletInfo;let h;for(e.inTuplet&&(i=_t.default.create(l.ratio.num,l.ratio.den),u=K.default.actualToNormal(u,i)),this.isImpossibleDuration(u)&&(a=this.computeSubChords(e,i)),t=0;t<a.length;t++)h=!1,e=a[t],n=e.timeOff-e.timeOn,u=n/this.innerTicks,e.inTuplet&&(u=K.default.actualToNormal(u,i)),r=K.default.quarterToDurationOpts(u),t<a.length-1&&(h=!0),s={durationType:r.durationType,nbDots:r.nbDots,heads:[],tie:h},this.drumPart?this.buildNotesDrums(e.notes,s):this.buildNotes(e.notes,s)}buildNotes(e,t){let i,s;const r=this.dataStaff.notes.length;for(i=0;i<e.length;i++)s=e[i].finalNoteName,t.heads.push({pitch:s}),(t.tie||e[i].hasTieStart())&&this.dataStaff.ties.push({step:s.step,octave:s.octave,alter:s.alter,noteIdx:r});delete t.tie,this.dataStaff.notes.push(t)}buildNotesDrums(e,t){let i,s;for(i=0;i<e.length;i++)s=Te.MIDIToPercu(e[i].pitch),t.heads.push(s);this.dataStaff.notes.push(t)}getDurationArray(e){let t;const i=[];let s=e;for(;s>0;)s>4?t=4:t=K.default.extractBaseDuration(s),s-=t,t=K.default.quarterToDurationOpts(t),i.push(t);return i}computeSubChords(e,t){let i=e.copy(),s;const r=[];let n,a=(i.timeOff-i.timeOn)/this.innerTicks;for(e.inTuplet&&(a=K.default.actualToNormal(a,t));a>0;)a>4?n=4:n=K.default.extractBaseDuration(a),n!==a?(e.inTuplet?(s=i.cutNotesAtLength(K.default.normalToActual(n,t)*this.innerTicks),s.setTuplet(e.tupletInfo)):s=i.cutNotesAtLength(n*this.innerTicks),r.push(i),i=s):r.push(i),a-=n;return r}isImpossibleDuration(e){let t;if(e>4)return!0;for(;e>.0625;){if(t=K.default.extractSmallestBaseDuration(e),e-=t,e===0)return!1;if(!Te.epsEqu(e/2,t))return!0}return!1}createDefaultAttributes(){return{transpose:{chromatic:"0"},staffDetails:{"staff-lines":5}}}getMetaAt(e){return this.metaMap[e]}setMetaMap(e){this.metaMap=new Vs(e,this.innerTicks)}setHumanDelay(e){this.humanDelayBase=e,this.midiPart&&this.midiPart.setHumanDelay(e)}}const Ri=oo;x.formatters.h=o=>`0x${o.toString(16)}`;const Tt=x("dacapo:InputMIDI");class ao{constructor(e){this.manager=e,this.divisions=240,this.minDivisions=240/16,this.minRestDuration=120/240,this.quantizer=new At,this.quantizer.setTicksPerQuarterNote(this.divisions),this.playingNotes={},this.playingNotesNum=0,this.waitingNotes=[],this.thresholdLimit=.04,this.fudgeTime=.01,this.threshExt=.02,this.thresholdStart=0,this.threshExtUsed=!1,this.humanDelayBase=.02,this.mappings={"Maschine Mikro MK2 In":{note:{offset:0},controller:{108:"play",109:"record",104:"restart"}},UMA25S:{note:{offset:0},controller:{22:"restart",25:"stop",26:"pause",27:"play",28:"record"}}},this.activeNotation=!0,this.recording=!1,this.calibrating=!1,this.timerID=null,this.tempo=A.qpm,this.unitDuration=A.unitDuration,this.measureStartTime=0,this.quarterNotePerMeasure=4,this.startRecordTime=0,this.transposition=0,this.lastEventTime=0,this.qLastEventTime=0,this.firstChordNote={},this.delay=0,this.currentNotePos={measureIdx:0,quarterPos:0},this.metaMap=[],this.postProcessor=new Ri(this.metaMap),this.lengthStack=[],this.eventStack=[],this.cbValidate=null,this.calibrationNote=0}init(e,t,i,s,r){Tt("init dacapo InputMIDI"),this.setInstrumentManager(e),this.insertNotesAtCursor=t,this.insertCallback=i,this.cursorCallback=s,this.tempoCallback=r}handleMIDIMessage(e){const t=d.context.currentTime;if(e.data.length===3){let i,s,r,n,u;const a=Te.MIDICommands[e.data[0]];Tt("event %h,%h,%h | %o | status = %s",e.data[0],e.data[1],e.data[2],e.data,a),this.recording&&(this.firstNote||(this.firstNote=!0,this.startRecordTime=t),this.saveLiveEvent(t,e.data[0],e.data[1],e.data[2])),a==="noteOn"||a==="noteOff"?(i=this.getMappedMIDIPitch(e.data[1]),s=e.data[2]):(r=e.data[1],n=e.data[2]),a==="noteOn"?s>0?this.startNote(i,s):this.stopNote(i):a==="noteOff"?this.stopNote(i):a==="continuousController"&&this.selectedInput&&this.mappings[this.selectedInput.name]&&(u=this.mappings[this.selectedInput.name].controller[r],u==="play"?n===127?this.manager.transport.start():this.manager.transport.pause():u==="record"?n===127?this.startRecording():this.stopRecording():u==="restart"&&this.manager.transport.restart()),this.calibrating&&this.cbValidate&&((a==="noteOn"||a==="noteOff")&&(a==="noteOn"&&s>0||this.calibrationNote)&&this.saveLiveEvent(t,a,i,s),a==="noteOn"&&s>0&&(this.calibrationNote||(this.calibrationNote=i),this.calibrationNote===i&&this.cbValidate()))}}saveLiveEvent(e,t,i,s){this.noteLiveStack.push({time:e,type:t,data1:i,data2:s})}isChordNote(e){let t=!1,i=0;return this.playingNotesNum===0?(this.thresholdStart=e,this.threshExtUsed=!1):this.threshExtUsed?(i=e-this.thresholdStart,i<this.thresholdLimit+this.threshExt?t=!0:(this.thresholdStart=e,this.threshExtUsed=!1)):(i=e-this.thresholdStart,i<this.thresholdLimit?(t=!0,i>this.thresholdLimit-this.fudgeTime&&(this.threshExtUsed=!0)):this.thresholdStart=e),t}isSignificant(e){return e>=this.minRestDuration}startNote(e,t){Tt(`start midi note : pitch ${e}, velocity ${t}`);const i=d.context.currentTime,s=0;let r;this.playNote(e,r,i,s,t),this.activeNotation&&(r=this.isChordNote(i),this.recording&&(this.lastEventTime=i,this.qLastEventTime=s))}playNote(e,t,i,s,r){if(Tt(`play midi note : pitch ${e}, velocity ${r}, chord ${t}, startTime ${i}, qStartTime ${s}`),!this.manager)throw new Li("InputMIDI");this.manager.playSelectedInstrument(e,r),this.playingNotes[e]={pitch:e,inChord:t,startTime:i,qStartTime:s,measureStart:this.currentNotePos.measureIdx,quarterPos:this.currentNotePos.quarterPos},this.playingNotesNum++}stopNote(e){Tt(`stop midi note : pitch ${e}`);let t,i,s,r;const n=d.context.currentTime,u=this.playingNotes[e];u&&(this.playingNotesNum--,delete this.playingNotes[e],this.manager.stopSelectedInstrument(e),this.activeNotation&&(t=n-u.startTime,i=t+this.delay+.04,this.calibrating||(!this.recording&&!this.calibrating&&this.updateTempoAtCursorPos(),!this.recording&&!this.calibrating&&this.cursorCallback&&(r=this.cursorCallback()),this.waitingNotes.push(u),this.playingNotesNum>0?!this.timer&&typeof require=="undefined"&&(this.timerID=$.setTimeout(()=>{this.timerID=null,this.insertNotes(this.waitingNotes,r),this.saveLength(t,i,s),this.recording&&(this.lastEventTime=n,this.qLastEventTime=u.qStartTime+r*this.unitDuration)},40)):(this.timerID&&($.clearTimeout(this.timerID),this.timerID=null),this.insertNotes(this.waitingNotes,r),this.saveLength(t,i,s),this.recording&&(this.lastEventTime=n,this.qLastEventTime=u.qStartTime+r*this.unitDuration)))))}guessDuration(e){let t,i={prob:0};const s=e/this.unitDuration*this.divisions,r=this.getEligibleDurations(s);this.editProbaWithHistory(r);const n=this.getRemainingTimeInMeasure();for(this.trimOrExpandIfNecessary(n,r),t=0;t<r.length;t++)r[t].prob>=i.prob&&(i=r[t]);return i.duration}editProbaWithHistory(e){let t,i,s=.25,r=e.length,n=this.lengthStack.length-1;const u=n-10;for(;n>=0&&n>=u&&r>0;){for(i=this.lengthStack[n].qDelta,t=0;t<e.length;t++)if(typeof e[t].history=="undefined"&&e[t].duration===i){e[t].prob+=s,e[t].history=n,r--;break}n===this.lengthStack.length-1&&(s*=.5),n--}}getEligibleDurations(e){let t,i;const s=[],r=[],n=new W(1,8);let u=1,a=0;for(e<=240?u=4:e<=480?u=3:u=2;u>r.length&&n.value()>this.quantizer.minAllowedDuration.value();)t=this.quantizer.quantizeWithQuant(e,n),i=Math.abs(t-e),s.includes(t)||(r.push({delta:i,duration:t}),s.push(t),a+=i),n.div(2);if(r.length>1)for(let l=0;l<r.length;l++)r[l].prob=1-r[l].delta/a;else r[0].prob=1;return r}trimOrExpandIfNecessary(e,t){let i,s;for(i=0;i<t.length;i++)s=Math.abs(t[i].duration-e),t[i].duration<this.minDivisions&&(t[i].duration=this.minDivisions),s<=.5?t[i].prob+=1.51:s<1&&typeof t[i].history!="undefined"?t[i].prob+=.5:s<1&&(t[i].prob+=.1)}getRemainingTimeInMeasure(){let e,t;return this.recording||(e=this.cursorCallback(),t=e*this.divisions),t}insertChord(e){this.insertNotes(this.waitingNotes,e)}insertRest(e){this.insertCallback({quarterDuration:e,pitches:[]},this.currentNotePos.measureIdx,Number(this.currentNotePos.quarterPos.toFixed(4))),this.updateCurrentPosition(e)}collectPitches(e){const t=[];let i=0;i=this.getInstrumentTranspo();for(let s=0;s<e.length;s++)try{t[s]=g.MIDIToPitchObject(e[s].pitch-i),t[s].accidental=Xe.default.alterToAccidental(t[s].alter||0)}catch(r){t.splice(s,1),e.splice(s--,1)}return t}insertNotes(e,t){let i={};if(e.length>0){const{measureStart:s,quarterPos:r,qStartTime:n}=e[0];e=this.collectPitches(e),i={quarterDuration:t,pitches:e},this.recording&&this.insertCallback?(this.insertCallback(i,s,Number(r.toFixed(4))),this.updateCurrentPosition(t+(n-this.qLastEventTime)/this.unitDuration)):this.insertNotesAtCursor&&this.insertNotesAtCursor(i),this.waitingNotes=[]}}saveLength(e,t,i){this.lengthStack.push({realLength:e,delta:t,qDelta:i,errorDelta:Math.abs(i-t),error:Math.abs(i-e)})}updateCurrentPosition(e){let t=this.currentNotePos.quarterPos+e,s=(d.context.currentTime-this.startMeasureTime)/this.unitDuration;if(t>=this.quarterNotePerMeasure)for(;t>=this.quarterNotePerMeasure;)t-=this.quarterNotePerMeasure,s-=this.quarterNotePerMeasure,this.startMeasureTime+=this.quarterNotePerMeasure*this.unitDuration,this.currentNotePos.measureIdx++,this.updateTimeSignature(this.currentNotePos.measureIdx);this.currentNotePos.quarterPos=Number(t.toFixed(4)),this.findDelay(s)}updateTimeSignature(e){typeof this.metaMap[e]!="undefined"&&(this.quarterNotePerMeasure=this.metaMap[e].beats*(4/this.metaMap[e].beatType),this.tempo=this.metaMap[e].tempo,this.unitDuration=60/this.tempo,this.timePerMeasure=this.quarterNotePerMeasure*this.unitDuration)}updateTempoAtCursorPos(){this.tempoCallback&&(this.tempo=this.tempoCallback(),this.unitDuration=60/this.tempo)}findDelay(e){this.delay=this.unitDuration*(e-this.currentNotePos.quarterPos)}getMappedMIDIPitch(e){let t=0;return this.selectedInput&&this.mappings[this.selectedInput.name]&&({offset:t}=this.mappings[this.selectedInput.name].note),e+t}getInstrumentTranspo(){const e=this.manager.getSelectedIndex();return this.manager.getInstrumentTranspo(e)||0}startRecording(e=0,t){typeof t=="undefined"&&(t=!1),this.recording||(this.delay=0,this.firstNote=!1,this.noteLiveStack=[],this.postProcessor=new Ri(this.metaMap),this.postProcessor.setHumanDelay(this.humanDelayBase),this.recording=!0,this.currentNotePos={measureIdx:0,quarterPos:0},this.tempo=A.qpm,this.unitDuration=A.unitDuration,this.quarterNotePerMeasure=A.timeSignature.beats*(4/A.timeSignature.beatType),this.timePerMeasure=this.quarterNotePerMeasure*this.unitDuration,this.startRecordTime=e,this.lastEventTime=this.startRecordTime,this.qLastEventTime=this.lastEventTime,this.startMeasureTime=this.startRecordTime)}setEndMeasureTimer(){return $.setTimeout(()=>{this.postProcessing(this.startMeasureTime,this.startMeasureTime+this.timePerMeasure),this.startMeasureTime+=this.timePerMeasure,this.updateTimeSignature()},this.timePerMeasure*1e3)}setMetaMap(e){this.metaMap=e,this.postProcessor.setMetaMap(e)}setInstrumentManager(e){this.manager=e}stopRecording(e){let t,i;return this.recording?(this.recording=!1,i={startRecord:this.startRecordTime,events:this.noteLiveStack,humanDelay:this.humanDelayBase,tempo:this.tempo},typeof require=="undefined"&&($.clearTimeout(this.timerID),$.clearTimeout(this.nextMeasureTimer)),Number.isFinite(e)||(e=this.startRecordTime),t=this.postProcessor.processPart(e,this.noteLiveStack),{resultVoices:t,resultEvents:i}):null}getStartRecordTime(){return this.startRecordTime}startCalibration(e,t){const i={sequences:Number.POSITIVE_INFINITY,clicks:4,quarterDuration:e};!this.recording&&!this.calibrating&&(this.calibrating=!0,this.calibrationNote=0,this.cbValidate=t,this.noteLiveStack=[],this.manager.transport.scheduleMetronomeSequence(i,d.context.currentTime+.1))}analyzeCalibration(e,t){let i,s,r,n,u,a=0,l=null;const h=[],c={events:this.noteLiveStack};if(this.noteLiveStack.length<=0)throw new Ke("The note sequence is empty! Please try again");const m=.5-t/1e3;for(i=0;i<this.noteLiveStack.length;i++){if(r=this.noteLiveStack[i],l&&r.type==="noteOn"&&r.data2>0){if(s=r.time-l.time,a=i/2>>0,a>=1&&a<=e.length){if(u=r.time-n,u<e[a-1]-m)throw new Ke(`The note ${a} is too short`);if(u>e[a-1]+m/4)throw new Ke(`The note ${a} is too long`)}if(s>m)throw new Ke(`The time between note ${a} and note ${a+1} is too long`);n=r.time,h.push(s)}l=r}const f=Math.ceil(h.length/2),p=h.sort()[f];return this.setHumanDelay(p),{median:p,resultEvents:c}}stopCalibration(e,t){return this.calibrating?(this.calibrating=!1,this.manager.transport.stopMetronomeSequence(),this.analyzeCalibration(e,t)):null}cancelCalibration(){this.calibrating&&(this.calibrating=!1,this.manager.transport.stopMetronomeSequence())}setHumanDelay(e){this.humanDelayBase=e,this.postProcessor&&this.postProcessor.setHumanDelay(e)}enableNotation(){this.activeNotation=!0}disableNotation(){this.activeNotation=!1}}const $s=ao;class uo{constructor(e,t){this.notesByPitch={},this.notesById={},this.noteIds={},this.MIDICommands={noteOff:128,noteOn:144,afterTouch:160,continuousController:176,patchChange:192,channelPressure:208,pitchBend:224,nonMusicalCommand:240},this.send=e,this.clear=t}createChannelEvent(e,t,i,s){const r=[];return s=s>127?127:s,this.MIDICommands[e]&&i<16&&s<128&&t<128&&(r[0]=this.MIDICommands[e]|i,r[1]=t,r[2]=s),r}getNoteName(e,t){if(typeof e=="number"){if(e>128&&(e=g.MapUnpitched[e]||129),e>128||e<0)throw new Error("Note out of range")}else t&&dt.default.hasInstrumentId(t,e)&&(e=Number(dt.default.searchInstrumentMIDIUnpitched(t,e))-1,e>128&&(e=g.MapUnpitched[e]));return e}playNote({startTime:e=d.context.currentTime,pitch:t,header:i,duration:s=0,velocity:r=100,holdNote:n=!1},u){let a;try{t=this.getNoteName(t,i)}catch(p){return null}const l=e-d.context.currentTime;e=l*1e3+window.performance.now();const h=e+s*1e3,c=this.createChannelEvent("noteOn",t,u,r),m=this.createChannelEvent("noteOff",t,u,0);s*=1e3,this.send(c,e);const f={startTime:e,stopTime:h,duration:s,channel:u,pitch:t};return s&&Number.isFinite(s)&&s>0&&!n&&(this.send(m,h),a=this.setNodeKilling(u,l+s,f)),f.timer=a,this.addNoteInStack(f)}setNodeKilling(e,t,i){return $.setTimeout(()=>{this.notesByPitch[e]&&this.notesByPitch[e][i.pitch]&&(this.notesByPitch[e][i.pitch].shift(),delete this.notesById[e][i.id])},t*1e3)}addNoteInStack(e){const{channel:t,pitch:i}=e;typeof this.notesByPitch[t]=="undefined"&&(this.notesByPitch[t]={},this.notesById[t]={}),typeof this.notesByPitch[t][i]=="undefined"&&(this.notesByPitch[t][i]=[]);const s=this.getNewNoteIdForChannel(t);return e.id=s,this.notesByPitch[t][i].push(e),this.notesById[t][s]=e,s}stopNote(e){if(e){$.clearTimeout(e.timer);const t=this.createChannelEvent("noteOff",e.pitch,e.channel,0);this.send(t,e.startTime),delete this.notesById[e.channel][e.id]}}stopNotesWithPitch(e,t){for(;this.notesByPitch[t]&&this.notesByPitch[t][e].length>0;){const i=this.notesByPitch[t][e].shift();this.stopNote(i)}}stopNotesFromChannel(e,t){let i;if(this.notesByPitch[e]){const s=Object.keys(this.notesByPitch[e]);for(i=0;i<s.length;i++)this.stopNotesWithPitch(s[i],e,t),delete this.notesByPitch[e][s[i]]}}stopNotes(){let e;const t=Object.keys(this.notesByPitch);for(e=0;e<t.length;e++)this.stopNotesFromChannel(t[e]);this.notesByPitch={}}stopPedalForPitch(e,t,i){for(;this.notesByPitch[t]&&this.notesByPitch[t][e].length>0;){const s=this.notesByPitch[t][e].shift();if(s){if(i>s.startTime&&s.startTime+s.origDuration<i)this.stopNote(s);else if(i>s.startTime&&s.startTime+s.origDuration>i){s.stopTime=s.startTime+s.origDuration,this.stopNote(s),this.notesByPitch[t][e].push(s);return}}}}stopPedalForChannel(e,t){let i;if(t=(t-d.context.currentTime)*1e3+window.performance.now(),this.notesByPitch[e]){const r=Object.keys(this.notesByPitch[e]);for(i=0;i<r.length;i++)this.stopPedalForPitch(r[i],e,t)&&delete this.notesByPitch[e][r[i]]}}getNewNoteIdForChannel(e){return typeof this.noteIds[e]=="undefined"&&(this.noteIds[e]=0),this.noteIds[e]++}stopNoteWithId(e,t){this.cancelNoteWithId(e,t)}cancelNoteWithId(e,t){if(this.notesById[e]){const i=this.notesById[e][t];this.stopNote(i)}}}const Ls=uo,lo=x("dacapo:MIDI");class ho{constructor(e){this.MIDI=null,this.inputPorts=[],this.outputPorts=[],this.selectedInput=null,this.selectedOuput=null,this.midiInput=new $s,this.midiOutput=new Ls(this.handleSend.bind(this),this.clearScheduled.bind(this)),this.metaMap={},this.lengthStack=[],this.initFocusControl(),this.updateCallback=e}init(){if(!this.isWebMIDICompliant())throw new Ie("MIDI API is not supported in your browser");return navigator.requestMIDIAccess().then(e=>{if(this.MIDI=e,this.MIDI.onstatechange=this.updateDevices.bind(this),this.MIDI.inputs&&this.MIDI.inputs.size>0){const t=this.MIDI.inputs.values(),i=this.MIDI.outputs.values();let s,r;for(s=t.next();s&&!s.done;s=t.next())this.inputPorts.push(s.value);for(r=i.next();r&&!r.done;r=i.next())this.outputPorts.push(r.value)}}).catch(e=>{throw new $i(e.message)})}isWebMIDICompliant(){return typeof navigator.requestMIDIAccess=="function"}initFocusControl(){this.focused=!0,window.onfocus=()=>{this.focused=!0},window.onblur=()=>{this.focused=!1}}updateDevices(e){const t=e.port.state;t==="connected"?this.connectPort(e.port):t==="disconnected"&&this.disconnectPort(e.port),this.updateCallback&&this.updateCallback()}connectPort(e){const t=e.type,i=t.charAt(0).toUpperCase()+t.slice(1),s=this[`${t}Ports`];this[`isIn${i}PortsList`](e)||s.push(e)}disconnectPort(e){let t;const i=e.type,s=i.charAt(0).toUpperCase()+i.slice(1),r=this[`${i}Ports`];for(t=0;t<r.length;t++)if(r[t].id===e.id){r.splice(t,1);break}this[`selected${s}`]=null}findPortFromId(e,t){const i=this[`${e}Ports`];for(let s=0;s<i.length;s++)if(i[s].id===t)return i[s];return null}selectInputDevice(e){const t=this.findPortFromId("input",e);t&&lo(`midi input device ${t.name} selected`),this.selectedInput!==null&&(this.selectedInput.onmidimessage=null),this.selectedInput=t,this.selectedInput.onmidimessage=i=>{(this.focused||this.midiInput.recording)&&this.midiInput.handleMIDIMessage(i)}}selectOutputDevice(e){const t=this.findPortFromId("output",e);this.selectedOutput=t}handleSend(e,t){this.selectedOutput&&(t=t||0,this.selectedOutput.send(e,t))}clearScheduled(){this.selectedOutput&&this.selectedOutput.clear()}unselectInputDevice(){this.selectedInput!==null&&(this.selectedInput.onmidimessage=null,this.selectedInput=null)}unselectOutputDevice(){this.selectedOutput!==null&&(this.selectedOutput=null)}isInInputPortsList(e){for(let t=0;t<this.inputPorts.length;t++)if(this.inputPorts[t].id===e.id)return!0;return!1}isInOutputPortsList(e){for(let t=0;t<this.outputPorts.length;t++)if(this.outputPorts[t].id===e.id)return!0;return!1}getInputs(){return this.inputPorts}getOutputs(){return this.outputPorts}hasInputs(){return this.inputPorts.length>0}getMidiInput(){return this.midiInput}getMidiOutput(){return this.midiOutput}hasOutputs(){return this.outputPorts.length>0}disconnectAllInputPorts(){for(let e=0;e<this.inputPorts.length;e++)this.disconnectPort(this.inputPorts[e])}disconnectAllOutputPorts(){for(let e=0;e<this.outputPorts.length;e++)this.disconnectPort(this.outputPorts[e])}disconnectAllDevices(){this.disconnectAllInputPorts(),this.disconnectAllOutputPorts()}destroy(){this.disconnectAllDevices(),this.midiInput&&(this.midiInput.stopRecording(),this.midiInput.insertNotesAtCursor=null,this.midiInput.insertCallback=null,this.midiInput.cursorCallback=null,this.midiInput.tempoCallback=null)}}const Fs=ho;function co(){self.Mp3LameEncoderConfig={locateFile:(o,e)=>o.endsWith(".mem")?"$memInitUrl":e+o},importScripts("$encoderUrl"),this.error=o=>{this.postMessage({command:"error",message:o})},this.init=o=>{this.sampleRate=o.config&&o.config.sampleRate||44100,this.numChannels=o.config&&o.config.numChannels||2,this.options=o.options||{},this.recording=!1},this.setOptions=o=>{this.encoder||this.recBuffers?this.error("cannot set options during recording"):this.options=o},this.start=()=>{this.options.encodeAfterRecord?this.recBuffers=[]:this.encoder=new Mp3LameEncoder(this.sampleRate,320),this.recording=!0},this.record=o=>{this.recording&&(this.encoder?this.encoder.encode(o):this.recBuffers.push(o))},this.finish=()=>{if(this.recBuffers)for(this.encoder=new Mp3LameEncoder(44100,320);this.recBuffers.length>0;){const e=this.recBuffers.shift();this.encoder.encode(e)}const o=this.encoder.finish();o.arrayBuffer().then(e=>{console.log("DONE",e)}),this.postMessage({command:"complete",blob:o})},this.onmessage=o=>{const{data:e}=o;switch(e.command){case"init":this.init(e);break;case"options":this.setOptions(e.options);break;case"start":this.start(e.bufferSize);break;case"record":this.record(e.buffer);break;case"finish":this.finish();break;case"cancel":this.cleanup();break;default:this.handleDefault()}}}function mo(o="http://localhost:3000/dist/js/dacapo.mp3Encoder.js",e="http://localhost:3000/dist/js/dacapo.mp3Encoder.min.js.mem"){const t=window.URL||window.webkitURL;if(!t||!window.Blob||!window.Worker)throw new It.CompatibilityError("Cannot instantiate worker due to browser compatibility");let i=co.toString();i=i.substring(i.indexOf("{")+1,i.lastIndexOf("}")),i=i.replace("$encoderUrl",o),i=i.replace("$memInitUrl",e);const s=t.createObjectURL(new Blob([i],{type:"text/javascript"}));return new Worker(s)}const fo=mo;var po=Math.pow,qt=(o,e,t)=>new Promise((i,s)=>{var r=a=>{try{u(t.next(a))}catch(l){s(l)}},n=a=>{try{u(t.throw(a))}catch(l){s(l)}},u=a=>a.done?i(a.value):Promise.resolve(a.value).then(r,n);u((t=t.apply(o,e)).next())});const Fe=x("dacapo:recording"),Bs=2;class go{constructor(e="http://localhost:3000/dist/js/",t="dacapo.mp3Encoder.js",i="dacapo.mp3Encoder.min.js.mem"){this.baseUrl=e,this.baseUrl.endsWith("/")||(this.baseUrl+="/"),this.encoderFileName=t,this.memInitFileName=i,this.encoderUrl=`${this.baseUrl}${this.encoderFileName}`,this.memInitUrl=`${this.baseUrl}${this.memInitFileName}`,this.selectedDevice=null,this.stream=null,this.microphone=null,this.recorder=null,this.audioWorkletNode=null,this.scriptProcessorNode=null,this.recordedChunks=[],this.finalPrmsHandlers=null,this.analyserNode=null,this.analyserNodeSampleBuf=null,this.startRecordingTime=0}init(){return qt(this,null,function*(){})}listInputDevices(){return qt(this,null,function*(){return(yield navigator.mediaDevices.enumerateDevices()).filter(t=>t.kind==="audioinput")})}selectInputDevice(e){this.selectedDevice=e}initScriptProcessorNode(){this.scriptProcessorNode=d.context.createScriptProcessor(512,2,2),this.scriptProcessorNode.onaudioprocess=this.handleScriptProcessor.bind(this),this.scriptProcessorNode.connect(d.context.destination),this.finalPrmsHandlers=null,this.recorderWorker=fo(this.encoderUrl,this.memInitUrl),this.recorderWorker.onmessage=this.handleWorkerMessage.bind(this),this.recorderWorker.postMessage({command:"init",opts:{config:{sampleRate:44100,numChannels:Bs}}})}initAnalyserNode(){Fe("initAnalyserNode"),this.analyserNode=d.context.createAnalyser(),this.analyserNode.fftSize=2048,this.analyserNodeSampleBuf=new Float32Array(this.analyserNode.fftSize),this.microphone.connect(this.analyserNode)}getAverageInputPower(){if(!this.analyserNode)return-100;this.analyserNode.getFloatTimeDomainData(this.analyserNodeSampleBuf);let e=0;for(let i=0;i<this.analyserNodeSampleBuf.length;i++)e+=po(this.analyserNodeSampleBuf[i],2);return 10*Math.log10(e/this.analyserNodeSampleBuf.length)}getElapsedTime(){return this.startRecordingTime?(performance.now()-this.startRecordingTime)/1e3:0}handleScriptProcessor(e){const t=[];for(let i=0;i<Bs;i++)t[i]=e.inputBuffer.getChannelData(i);this.recorderWorker.postMessage({command:"record",buffer:t})}handleWorkerMessage(e){return qt(this,null,function*(){if(Fe("handleWorkerMessage"),!(!e||!e.data)){if(e.data.command==="complete")this.encodedBlob=e.data.blob,this.encodedArrayBuffer=yield Se.convertBlobToArrayBuffer(this.encodedBlob),this.finalPrmsHandlers&&this.finalPrmsHandlers.resolve&&this.finalPrmsHandlers.resolve(this.encodedBlob);else if(e.data.command==="error")throw this.finalPrmsHandlers&&this.finalPrmsHandlers.resolve&&this.finalPrmsHandlers.reject(e.data.message),new Error(e.data.message)}})}handleWorkletMessage(e){Fe(`handleWorkletMessage, data.length: ${e.data.length}`)}startRecording(){return qt(this,null,function*(){if(Fe("startRecording()"),!d.context)throw Fe("undefined audio context"),new he;typeof d.context.resume!="undefined"&&(d.context.state==="running"&&d.context.suspend(),d.context.resume()),this.initScriptProcessorNode(),this.recordedChunks=[];const e={video:!1,audio:{echoCancellation:!1,sampleRate:d.context.sampleRate,noiseSupression:!1,mozNoiseSuppression:!1}};Fe("going to request user media");try{this.stream=yield navigator.mediaDevices.getUserMedia(e),Fe("got user media stream")}catch(t){console.log("ERROR",t)}this.microphone=d.context.createMediaStreamSource(this.stream),this.microphone.connect(this.scriptProcessorNode),this.initAnalyserNode(),this.recorderWorker.postMessage({command:"start"}),this.startRecordingTime=performance.now()})}stopRecording(){if(Fe("stopRecording"),!this.stream||!this.microphone)return Promise.reject();const e=new Promise((i,s)=>{this.finalPrmsHandlers={resolve:i,reject:s}});this.recorderWorker.postMessage({command:"finish"}),this.scriptProcessorNode.disconnect(),this.scriptProcessorNode.onaudioprocess=null,this.scriptProcessorNode=null;const t=this.stream.getAudioTracks();for(let i=0;i<t.length;i++)t[i].stop();return this.stream=null,this.microphone.disconnect(),this.selectedDevice=null,this.recorder=null,this.startRecordingTime=null,e}getArrayBuffer(){return this.encodedArrayBuffer}handleDataAvailable(e){e.data.size>0&&(this.recordedChunks.push(e.data),this.printChunk(e.data))}printChunk(e){console.log("new chunk",e.size)}reset(){this.encodedArrayBuffer=null,this.encodedBlob=null,this.finalPrmsHandlers=null}}const yo=go;N.AudioContexts=d,N.Error=It,N.Utils=ie,N.Values=Z,N.Config=ae,N.MIDIUtils=Te,N.Fraction=W,N.Quantizer=At,N.BufferWriter=jr,N.InstrumentManager=us,N.Generator=Ue,N.Oscillator=rs,N.SFBuffer=Ti,N.SFBuffer2=Jr,N.Sampler=Ni,N.SamplerV2=an,N.SamplerBridge=sn,N.Metronome=Pi,N.VoiceReader=fs,N.MeasureReader=xi,N.PartReader=ze,N.Reader=Ts,N.Tools=ns,N.initWorkerTimer=ut,N.WorkerTimer=$,N.Clock=jn,N.AlternativePlayer=$t,N.AlternativePlayerDefaultSync=Lt,N.CustomPlayer=Ds,N.YoutubePlayer=ws,N.SoundcloudPlayer=As,N.VimeoPlayer=Es,N.Transport=ks,N.MIDIProcessing=so,N.PostProcessor=Ri,N.MetaPart=Vs,N.MIDI=Fs,N.InputMIDI=$s,N.OutputMIDI=Ls,N.AudioRecorder=yo,N.RuntimeValues=A;const bo=/^(32811|6275|9655)$/.test(v.j)?null:N}}]);})();


//# debugId=0344d81d-bb50-5b9f-81be-84b1c01c8bec
